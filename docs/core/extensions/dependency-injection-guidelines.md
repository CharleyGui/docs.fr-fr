---
title: Recommandations relatives à l’injection de dépendances
description: Découvrez les différentes recommandations en matière d’injection de dépendances et les meilleures pratiques pour le développement d’applications .NET.
author: IEvangelist
ms.author: dapine
ms.date: 10/29/2020
ms.topic: guide
ms.openlocfilehash: 105536df873829dc79dcca1b86d080360e71303f
ms.sourcegitcommit: f2ab02d9a780819ca2e5310bbcf5cfe5b7993041
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 02/03/2021
ms.locfileid: "99505403"
---
# <a name="dependency-injection-guidelines"></a><span data-ttu-id="5dca3-103">Recommandations relatives à l’injection de dépendances</span><span class="sxs-lookup"><span data-stu-id="5dca3-103">Dependency injection guidelines</span></span>

<span data-ttu-id="5dca3-104">Cet article fournit des recommandations générales et les meilleures pratiques pour implémenter l’injection de dépendances dans les applications .NET.</span><span class="sxs-lookup"><span data-stu-id="5dca3-104">This article provides general guidelines and best practices for implementing dependency injection in .NET applications.</span></span>

## <a name="design-services-for-dependency-injection"></a><span data-ttu-id="5dca3-105">Conception de services pour l’injection de dépendances</span><span class="sxs-lookup"><span data-stu-id="5dca3-105">Design services for dependency injection</span></span>

<span data-ttu-id="5dca3-106">Lors de la conception de services pour l’injection de dépendances :</span><span class="sxs-lookup"><span data-stu-id="5dca3-106">When designing services for dependency injection:</span></span>

- <span data-ttu-id="5dca3-107">Évitez les classes et les membres avec état, static.</span><span class="sxs-lookup"><span data-stu-id="5dca3-107">Avoid stateful, static classes and members.</span></span> <span data-ttu-id="5dca3-108">Évitez de créer un état global en concevant des applications qui utilisent des services Singleton à la place.</span><span class="sxs-lookup"><span data-stu-id="5dca3-108">Avoid creating global state by designing apps to use singleton services instead.</span></span>
- <span data-ttu-id="5dca3-109">Éviter une instanciation directe de classes dépendantes au sein de services.</span><span class="sxs-lookup"><span data-stu-id="5dca3-109">Avoid direct instantiation of dependent classes within services.</span></span> <span data-ttu-id="5dca3-110">L’instanciation directe associe le code à une implémentation particulière.</span><span class="sxs-lookup"><span data-stu-id="5dca3-110">Direct instantiation couples the code to a particular implementation.</span></span>
- <span data-ttu-id="5dca3-111">Rendez les services petits, bien factorisés et faciles à tester.</span><span class="sxs-lookup"><span data-stu-id="5dca3-111">Make services small, well-factored, and easily tested.</span></span>

<span data-ttu-id="5dca3-112">Si une classe possède de nombreuses dépendances injectées, il peut s’agir d’un signe que la classe a trop de responsabilités et viole le [principe de responsabilité unique (SRP)](/dotnet/standard/modern-web-apps-azure-architecture/architectural-principles#single-responsibility).</span><span class="sxs-lookup"><span data-stu-id="5dca3-112">If a class has many injected dependencies, it might be a sign that the class has too many responsibilities and violates the [Single Responsibility Principle (SRP)](/dotnet/standard/modern-web-apps-azure-architecture/architectural-principles#single-responsibility).</span></span> <span data-ttu-id="5dca3-113">Essayez de refactoriser la classe en déplaçant certaines de ses responsabilités dans de nouvelles classes.</span><span class="sxs-lookup"><span data-stu-id="5dca3-113">Attempt to refactor the class by moving some of its responsibilities into new classes.</span></span>

### <a name="disposal-of-services"></a><span data-ttu-id="5dca3-114">Suppression des services</span><span class="sxs-lookup"><span data-stu-id="5dca3-114">Disposal of services</span></span>

<span data-ttu-id="5dca3-115">Le conteneur est responsable du nettoyage des types qu’il crée et appelle <xref:System.IDisposable.Dispose%2A> sur les <xref:System.IDisposable> instances.</span><span class="sxs-lookup"><span data-stu-id="5dca3-115">The container is responsible for cleanup of types it creates, and calls <xref:System.IDisposable.Dispose%2A> on <xref:System.IDisposable> instances.</span></span> <span data-ttu-id="5dca3-116">Les services résolus à partir du conteneur ne doivent jamais être supprimés par le développeur.</span><span class="sxs-lookup"><span data-stu-id="5dca3-116">Services resolved from the container should never be disposed by the developer.</span></span> <span data-ttu-id="5dca3-117">Si un type ou une fabrique est inscrit en tant que singleton, le conteneur supprime automatiquement le singleton.</span><span class="sxs-lookup"><span data-stu-id="5dca3-117">If a type or factory is registered as a singleton, the container disposes the singleton automatically.</span></span>

<span data-ttu-id="5dca3-118">Dans l’exemple suivant, les services sont créés par le conteneur de service et supprimés automatiquement :</span><span class="sxs-lookup"><span data-stu-id="5dca3-118">In the following example, the services are created by the service container and disposed automatically:</span></span>

:::code language="csharp" source="snippets/configuration/console-di-disposable/TransientDisposable.cs":::

<span data-ttu-id="5dca3-119">La jetable précédente est censée avoir une durée de vie transitoire.</span><span class="sxs-lookup"><span data-stu-id="5dca3-119">The preceding disposable is intended to have a transient lifetime.</span></span>

:::code language="csharp" source="snippets/configuration/console-di-disposable/ScopedDisposable.cs":::

<span data-ttu-id="5dca3-120">La jetable précédente est destinée à avoir une durée de vie limitée.</span><span class="sxs-lookup"><span data-stu-id="5dca3-120">The preceding disposable is intended to have a scoped lifetime.</span></span>

:::code language="csharp" source="snippets/configuration/console-di-disposable/SingletonDisposable.cs":::

<span data-ttu-id="5dca3-121">La jetable précédente est censée avoir une durée de vie Singleton.</span><span class="sxs-lookup"><span data-stu-id="5dca3-121">The preceding disposable is intended to have a singleton lifetime.</span></span>

:::code language="csharp" source="snippets/configuration/console-di-disposable/Program.cs" range="1-21,41-60" highlight="":::

<span data-ttu-id="5dca3-122">La console de débogage affiche l’exemple de sortie suivant après l’exécution de :</span><span class="sxs-lookup"><span data-stu-id="5dca3-122">The debug console shows the following sample output after running:</span></span>

```console
Scope 1...
ScopedDisposable.Dispose()
TransientDisposable.Dispose()

Scope 2...
ScopedDisposable.Dispose()
TransientDisposable.Dispose()

info: Microsoft.Hosting.Lifetime[0]
      Application started.Press Ctrl+C to shut down.
info: Microsoft.Hosting.Lifetime[0]
     Hosting environment: Production
info: Microsoft.Hosting.Lifetime[0]
     Content root path: .\configuration\console-di-disposable\bin\Debug\net5.0
info: Microsoft.Hosting.Lifetime[0]
     Application is shutting down...
SingletonDisposable.Dispose()
```

### <a name="services-not-created-by-the-service-container"></a><span data-ttu-id="5dca3-123">Services non créés par le conteneur de service</span><span class="sxs-lookup"><span data-stu-id="5dca3-123">Services not created by the service container</span></span>

<span data-ttu-id="5dca3-124">Considérez le code suivant :</span><span class="sxs-lookup"><span data-stu-id="5dca3-124">Consider the following code:</span></span>

```csharp
public void ConfigureServices(IServiceCollection services)
{
    services.AddSingleton(new ExampleService());

    // ...
}
```

<span data-ttu-id="5dca3-125">Dans le code précédent :</span><span class="sxs-lookup"><span data-stu-id="5dca3-125">In the preceding code:</span></span>

- <span data-ttu-id="5dca3-126">L' `ExampleService` instance n’est **pas** créée par le conteneur de service.</span><span class="sxs-lookup"><span data-stu-id="5dca3-126">The `ExampleService` instance is **not** created by the service container.</span></span>
- <span data-ttu-id="5dca3-127">L’infrastructure ne supprime **pas** automatiquement les services.</span><span class="sxs-lookup"><span data-stu-id="5dca3-127">The framework does **not** dispose of the services automatically.</span></span>
- <span data-ttu-id="5dca3-128">Le développeur est responsable de la suppression des services.</span><span class="sxs-lookup"><span data-stu-id="5dca3-128">The developer is responsible for disposing the services.</span></span>

### <a name="idisposable-guidance-for-transient-and-shared-instances"></a><span data-ttu-id="5dca3-129">Recommandations IDisposable pour les instances temporaires et partagées</span><span class="sxs-lookup"><span data-stu-id="5dca3-129">IDisposable guidance for Transient and shared instances</span></span>

#### <a name="transient-limited-lifetime"></a><span data-ttu-id="5dca3-130">Transitoire, durée de vie limitée</span><span class="sxs-lookup"><span data-stu-id="5dca3-130">Transient, limited lifetime</span></span>

<span data-ttu-id="5dca3-131">**Scénario**</span><span class="sxs-lookup"><span data-stu-id="5dca3-131">**Scenario**</span></span>

<span data-ttu-id="5dca3-132">L’application requiert une <xref:System.IDisposable> instance avec une durée de vie transitoire pour l’un des scénarios suivants :</span><span class="sxs-lookup"><span data-stu-id="5dca3-132">The app requires an <xref:System.IDisposable> instance with a transient lifetime for either of the following scenarios:</span></span>

- <span data-ttu-id="5dca3-133">L’instance est résolue dans l’étendue racine (conteneur racine).</span><span class="sxs-lookup"><span data-stu-id="5dca3-133">The instance is resolved in the root scope (root container).</span></span>
- <span data-ttu-id="5dca3-134">L’instance doit être supprimée avant la fin de l’étendue.</span><span class="sxs-lookup"><span data-stu-id="5dca3-134">The instance should be disposed before the scope ends.</span></span>

<span data-ttu-id="5dca3-135">**Solution**</span><span class="sxs-lookup"><span data-stu-id="5dca3-135">**Solution**</span></span>

<span data-ttu-id="5dca3-136">Utilisez le modèle de fabrique pour créer une instance en dehors de l’étendue parente.</span><span class="sxs-lookup"><span data-stu-id="5dca3-136">Use the factory pattern to create an instance outside of the parent scope.</span></span> <span data-ttu-id="5dca3-137">Dans ce cas, l’application a généralement une `Create` méthode qui appelle directement le constructeur du type final.</span><span class="sxs-lookup"><span data-stu-id="5dca3-137">In this situation, the app would generally have a `Create` method that calls the final type's constructor directly.</span></span> <span data-ttu-id="5dca3-138">Si le type final a d’autres dépendances, la fabrique peut :</span><span class="sxs-lookup"><span data-stu-id="5dca3-138">If the final type has other dependencies, the factory can:</span></span>

- <span data-ttu-id="5dca3-139">Recevoir un <xref:System.IServiceProvider> dans son constructeur.</span><span class="sxs-lookup"><span data-stu-id="5dca3-139">Receive an <xref:System.IServiceProvider> in its constructor.</span></span>
- <span data-ttu-id="5dca3-140">Utilisez <xref:Microsoft.Extensions.DependencyInjection.ActivatorUtilities.CreateInstance%2A?displayProperty=nameWithType> pour instancier l’instance en dehors du conteneur, tout en utilisant le conteneur pour ses dépendances.</span><span class="sxs-lookup"><span data-stu-id="5dca3-140">Use <xref:Microsoft.Extensions.DependencyInjection.ActivatorUtilities.CreateInstance%2A?displayProperty=nameWithType> to instantiate the instance outside of the container, while using the container for its dependencies.</span></span>

#### <a name="shared-instance-limited-lifetime"></a><span data-ttu-id="5dca3-141">Instance partagée, durée de vie limitée</span><span class="sxs-lookup"><span data-stu-id="5dca3-141">Shared instance, limited lifetime</span></span>

<span data-ttu-id="5dca3-142">**Scénario**</span><span class="sxs-lookup"><span data-stu-id="5dca3-142">**Scenario**</span></span>

<span data-ttu-id="5dca3-143">L’application requiert une <xref:System.IDisposable> instance partagée sur plusieurs services, mais l' <xref:System.IDisposable> instance doit avoir une durée de vie limitée.</span><span class="sxs-lookup"><span data-stu-id="5dca3-143">The app requires a shared <xref:System.IDisposable> instance across multiple services, but the <xref:System.IDisposable> instance should have a limited lifetime.</span></span>

<span data-ttu-id="5dca3-144">**Solution**</span><span class="sxs-lookup"><span data-stu-id="5dca3-144">**Solution**</span></span>

<span data-ttu-id="5dca3-145">Inscrivez l’instance avec une durée de vie limitée.</span><span class="sxs-lookup"><span data-stu-id="5dca3-145">Register the instance with a scoped lifetime.</span></span> <span data-ttu-id="5dca3-146">Utilisez <xref:Microsoft.Extensions.DependencyInjection.IServiceScopeFactory.CreateScope%2A?displayProperty=nameWithType> pour créer un <xref:Microsoft.Extensions.DependencyInjection.IServiceScope> .</span><span class="sxs-lookup"><span data-stu-id="5dca3-146">Use <xref:Microsoft.Extensions.DependencyInjection.IServiceScopeFactory.CreateScope%2A?displayProperty=nameWithType> to create a new <xref:Microsoft.Extensions.DependencyInjection.IServiceScope>.</span></span> <span data-ttu-id="5dca3-147">Utilisez les étendues <xref:System.IServiceProvider> pour accéder aux services requis.</span><span class="sxs-lookup"><span data-stu-id="5dca3-147">Use the scope's <xref:System.IServiceProvider> to get required services.</span></span> <span data-ttu-id="5dca3-148">Supprimez l’étendue lorsqu’elle n’est plus nécessaire.</span><span class="sxs-lookup"><span data-stu-id="5dca3-148">Dispose the scope when it's no longer needed.</span></span>

#### <a name="general-idisposable-guidelines"></a><span data-ttu-id="5dca3-149">`IDisposable`Recommandations générales</span><span class="sxs-lookup"><span data-stu-id="5dca3-149">General `IDisposable` guidelines</span></span>

- <span data-ttu-id="5dca3-150">N’inscrivez pas <xref:System.IDisposable> les instances avec une durée de vie transitoire.</span><span class="sxs-lookup"><span data-stu-id="5dca3-150">Don't register <xref:System.IDisposable> instances with a transient lifetime.</span></span> <span data-ttu-id="5dca3-151">Utilisez à la place le modèle de fabrique.</span><span class="sxs-lookup"><span data-stu-id="5dca3-151">Use the factory pattern instead.</span></span>
- <span data-ttu-id="5dca3-152">Ne résolvez pas <xref:System.IDisposable> les instances avec une durée de vie transitoire ou limitée dans l’étendue racine.</span><span class="sxs-lookup"><span data-stu-id="5dca3-152">Don't resolve <xref:System.IDisposable> instances with a transient or scoped lifetime in the root scope.</span></span> <span data-ttu-id="5dca3-153">La seule exception à cela est que l’application crée/recrée et supprime <xref:System.IServiceProvider> , mais ce n’est pas un modèle idéal.</span><span class="sxs-lookup"><span data-stu-id="5dca3-153">The only exception to this is if the app creates/recreates and disposes <xref:System.IServiceProvider>, but this isn't an ideal pattern.</span></span>
- <span data-ttu-id="5dca3-154">La réception d’une <xref:System.IDisposable> dépendance via l’injection de dépendances ne nécessite pas que le récepteur s’implémente <xref:System.IDisposable> lui-même.</span><span class="sxs-lookup"><span data-stu-id="5dca3-154">Receiving an <xref:System.IDisposable> dependency via DI doesn't require that the receiver implement <xref:System.IDisposable> itself.</span></span> <span data-ttu-id="5dca3-155">Le récepteur de la <xref:System.IDisposable> dépendance ne doit pas appeler <xref:System.IDisposable.Dispose%2A> sur cette dépendance.</span><span class="sxs-lookup"><span data-stu-id="5dca3-155">The receiver of the <xref:System.IDisposable> dependency shouldn't call <xref:System.IDisposable.Dispose%2A> on that dependency.</span></span>
- <span data-ttu-id="5dca3-156">Utilisez des étendues pour contrôler les durées de vie des services.</span><span class="sxs-lookup"><span data-stu-id="5dca3-156">Use scopes to control the lifetimes of services.</span></span> <span data-ttu-id="5dca3-157">Les étendues ne sont pas hiérarchiques, et il n’existe pas de connexion spéciale entre les étendues.</span><span class="sxs-lookup"><span data-stu-id="5dca3-157">Scopes aren't hierarchical, and there's no special connection among scopes.</span></span>

<span data-ttu-id="5dca3-158">Pour plus d’informations sur le nettoyage des ressources, consultez [implémenter une `Dispose` méthode](../../standard/garbage-collection/implementing-dispose.md)ou [implémenter une `DisposeAsync` méthode](../../standard/garbage-collection/implementing-disposeasync.md).</span><span class="sxs-lookup"><span data-stu-id="5dca3-158">For more information on resource cleanup, see [Implement a `Dispose` method](../../standard/garbage-collection/implementing-dispose.md), or [Implement a `DisposeAsync` method](../../standard/garbage-collection/implementing-disposeasync.md).</span></span> <span data-ttu-id="5dca3-159">En outre, considérez les [services transitoires jetables capturés par](#disposable-transient-services-captured-by-container) le scénario de conteneur en ce qui concerne le nettoyage des ressources.</span><span class="sxs-lookup"><span data-stu-id="5dca3-159">Additionally, consider the [Disposable transient services captured by container](#disposable-transient-services-captured-by-container) scenario as it relates to resource cleanup.</span></span>

## <a name="default-service-container-replacement"></a><span data-ttu-id="5dca3-160">Remplacement de conteneur de services par défaut</span><span class="sxs-lookup"><span data-stu-id="5dca3-160">Default service container replacement</span></span>

<span data-ttu-id="5dca3-161">Le conteneur de service intégré est conçu pour répondre aux besoins de l’infrastructure et de la plupart des applications grand public.</span><span class="sxs-lookup"><span data-stu-id="5dca3-161">The built-in service container is designed to serve the needs of the framework and most consumer apps.</span></span> <span data-ttu-id="5dca3-162">Nous vous recommandons d’utiliser le conteneur intégré, sauf si vous avez besoin d’une fonctionnalité spécifique qu’il ne prend pas en charge, par exemple :</span><span class="sxs-lookup"><span data-stu-id="5dca3-162">We recommend using the built-in container unless you need a specific feature that it doesn't support, such as:</span></span>

- <span data-ttu-id="5dca3-163">Injection de propriétés</span><span class="sxs-lookup"><span data-stu-id="5dca3-163">Property injection</span></span>
- <span data-ttu-id="5dca3-164">Injection en fonction du nom</span><span class="sxs-lookup"><span data-stu-id="5dca3-164">Injection based on name</span></span>
- <span data-ttu-id="5dca3-165">Conteneurs enfants</span><span class="sxs-lookup"><span data-stu-id="5dca3-165">Child containers</span></span>
- <span data-ttu-id="5dca3-166">Gestion personnalisée de la durée de vie</span><span class="sxs-lookup"><span data-stu-id="5dca3-166">Custom lifetime management</span></span>
- <span data-ttu-id="5dca3-167">`Func<T>` prend en charge l’initialisation tardive</span><span class="sxs-lookup"><span data-stu-id="5dca3-167">`Func<T>` support for lazy initialization</span></span>
- <span data-ttu-id="5dca3-168">Inscription basée sur une convention</span><span class="sxs-lookup"><span data-stu-id="5dca3-168">Convention-based registration</span></span>

<span data-ttu-id="5dca3-169">Les conteneurs tiers suivants peuvent être utilisés avec les applications ASP.NET Core :</span><span class="sxs-lookup"><span data-stu-id="5dca3-169">The following third-party containers can be used with ASP.NET Core apps:</span></span>

- [<span data-ttu-id="5dca3-170">Autofac</span><span class="sxs-lookup"><span data-stu-id="5dca3-170">Autofac</span></span>](https://autofac.readthedocs.io/en/latest/integration/aspnetcore.html)
- [<span data-ttu-id="5dca3-171">DryIoc</span><span class="sxs-lookup"><span data-stu-id="5dca3-171">DryIoc</span></span>](https://www.nuget.org/packages/DryIoc.Microsoft.DependencyInjection)
- [<span data-ttu-id="5dca3-172">Grace</span><span class="sxs-lookup"><span data-stu-id="5dca3-172">Grace</span></span>](https://www.nuget.org/packages/Grace.DependencyInjection.Extensions)
- [<span data-ttu-id="5dca3-173">LightInject</span><span class="sxs-lookup"><span data-stu-id="5dca3-173">LightInject</span></span>](https://github.com/seesharper/LightInject.Microsoft.DependencyInjection)
- [<span data-ttu-id="5dca3-174">Lamar</span><span class="sxs-lookup"><span data-stu-id="5dca3-174">Lamar</span></span>](https://jasperfx.github.io/lamar/)
- [<span data-ttu-id="5dca3-175">Stashbox</span><span class="sxs-lookup"><span data-stu-id="5dca3-175">Stashbox</span></span>](https://github.com/z4kn4fein/stashbox-extensions-dependencyinjection)
- [<span data-ttu-id="5dca3-176">Unity</span><span class="sxs-lookup"><span data-stu-id="5dca3-176">Unity</span></span>](https://www.nuget.org/packages/Unity.Microsoft.DependencyInjection)

## <a name="thread-safety"></a><span data-ttu-id="5dca3-177">Sécurité des threads</span><span class="sxs-lookup"><span data-stu-id="5dca3-177">Thread safety</span></span>

<span data-ttu-id="5dca3-178">Créez des services singleton thread-safe.</span><span class="sxs-lookup"><span data-stu-id="5dca3-178">Create thread-safe singleton services.</span></span> <span data-ttu-id="5dca3-179">Si un service Singleton a une dépendance vis-à-vis d’un service temporaire, le service temporaire peut également nécessiter la sécurité des threads en fonction de la façon dont il est utilisé par le singleton.</span><span class="sxs-lookup"><span data-stu-id="5dca3-179">If a singleton service has a dependency on a transient service, the transient service may also require thread safety depending on how it's used by the singleton.</span></span>

<span data-ttu-id="5dca3-180">La méthode de fabrique d’un service Singleton, telle que le deuxième argument de [AddSingleton \<TService> (IServiceCollection, Func \<IServiceProvider,TService> )](xref:Microsoft.Extensions.DependencyInjection.ServiceCollectionServiceExtensions.AddSingleton%2A), n’a pas besoin d’être thread-safe.</span><span class="sxs-lookup"><span data-stu-id="5dca3-180">The factory method of a singleton service, such as the second argument to [AddSingleton\<TService>(IServiceCollection, Func\<IServiceProvider,TService>)](xref:Microsoft.Extensions.DependencyInjection.ServiceCollectionServiceExtensions.AddSingleton%2A), doesn't need to be thread-safe.</span></span> <span data-ttu-id="5dca3-181">À l’instar d’un constructeur de type ( `static` ), il est garanti qu’il soit appelé une seule fois par un seul thread.</span><span class="sxs-lookup"><span data-stu-id="5dca3-181">Like a type (`static`) constructor, it's guaranteed to be called only once by a single thread.</span></span>

## <a name="recommendations"></a><span data-ttu-id="5dca3-182">Recommandations</span><span class="sxs-lookup"><span data-stu-id="5dca3-182">Recommendations</span></span>

- <span data-ttu-id="5dca3-183">`async/await` et la `Task` résolution de service basée sur n’est pas prise en charge.</span><span class="sxs-lookup"><span data-stu-id="5dca3-183">`async/await` and `Task` based service resolution isn't supported.</span></span> <span data-ttu-id="5dca3-184">Étant donné que C# ne prend pas en charge les constructeurs asynchrones, utilisez des méthodes asynchrones après la résolution synchrone du service.</span><span class="sxs-lookup"><span data-stu-id="5dca3-184">Because C# doesn't support asynchronous constructors, use asynchronous methods after synchronously resolving the service.</span></span>
- <span data-ttu-id="5dca3-185">Évitez de stocker des données et des configurations directement dans le conteneur de services.</span><span class="sxs-lookup"><span data-stu-id="5dca3-185">Avoid storing data and configuration directly in the service container.</span></span> <span data-ttu-id="5dca3-186">Par exemple, le panier d’achat d’un utilisateur ne doit en général pas être ajouté au conteneur de services.</span><span class="sxs-lookup"><span data-stu-id="5dca3-186">For example, a user's shopping cart shouldn't typically be added to the service container.</span></span> <span data-ttu-id="5dca3-187">La configuration doit utiliser le modèle d’options.</span><span class="sxs-lookup"><span data-stu-id="5dca3-187">Configuration should use the options pattern.</span></span> <span data-ttu-id="5dca3-188">De même, évitez les objets « garde-données » qui existent uniquement pour autoriser l’accès à un autre objet.</span><span class="sxs-lookup"><span data-stu-id="5dca3-188">Similarly, avoid "data holder" objects that only exist to allow access to another object.</span></span> <span data-ttu-id="5dca3-189">Il est préférable de demander l’élément réel par le biais de l’injection de dépendance.</span><span class="sxs-lookup"><span data-stu-id="5dca3-189">It's better to request the actual item via DI.</span></span>
- <span data-ttu-id="5dca3-190">Évitez l’accès statique aux services.</span><span class="sxs-lookup"><span data-stu-id="5dca3-190">Avoid static access to services.</span></span> <span data-ttu-id="5dca3-191">Par exemple, évitez de capturer [IApplicationBuilder. ApplicationServices](xref:Microsoft.AspNetCore.Builder.IApplicationBuilder.ApplicationServices) en tant que champ ou propriété statique à utiliser ailleurs.</span><span class="sxs-lookup"><span data-stu-id="5dca3-191">For example, avoid capturing [IApplicationBuilder.ApplicationServices](xref:Microsoft.AspNetCore.Builder.IApplicationBuilder.ApplicationServices) as a static field or property for use elsewhere.</span></span>
- <span data-ttu-id="5dca3-192">Conservez les [fabriques di](#async-di-factories-can-cause-deadlocks) en mode rapide et synchrone.</span><span class="sxs-lookup"><span data-stu-id="5dca3-192">Keep [DI factories](#async-di-factories-can-cause-deadlocks) fast and synchronous.</span></span>
- <span data-ttu-id="5dca3-193">Évitez d’utiliser le [*modèle de localisateur de service*](#scoped-service-as-singleton).</span><span class="sxs-lookup"><span data-stu-id="5dca3-193">Avoid using the [*service locator pattern*](#scoped-service-as-singleton).</span></span> <span data-ttu-id="5dca3-194">Par exemple, n’appelez pas <xref:System.IServiceProvider.GetService%2A> pour obtenir une instance de service lorsque vous pouvez utiliser l’injection de dépendance à la place.</span><span class="sxs-lookup"><span data-stu-id="5dca3-194">For example, don't invoke <xref:System.IServiceProvider.GetService%2A> to obtain a service instance when you can use DI instead.</span></span>
- <span data-ttu-id="5dca3-195">Une autre variante du localisateur de service à éviter est l’injection d’une fabrique qui résout les dépendances au moment de l’exécution.</span><span class="sxs-lookup"><span data-stu-id="5dca3-195">Another service locator variation to avoid is injecting a factory that resolves dependencies at runtime.</span></span> <span data-ttu-id="5dca3-196">Ces deux pratiques combinent des stratégies [Inversion de contrôle](/dotnet/standard/modern-web-apps-azure-architecture/architectural-principles#dependency-inversion).</span><span class="sxs-lookup"><span data-stu-id="5dca3-196">Both of these practices mix [Inversion of Control](/dotnet/standard/modern-web-apps-azure-architecture/architectural-principles#dependency-inversion) strategies.</span></span>
- <span data-ttu-id="5dca3-197">Évitez les appels à <xref:Microsoft.Extensions.DependencyInjection.ServiceCollectionContainerBuilderExtensions.BuildServiceProvider%2A> dans `ConfigureServices` .</span><span class="sxs-lookup"><span data-stu-id="5dca3-197">Avoid calls to <xref:Microsoft.Extensions.DependencyInjection.ServiceCollectionContainerBuilderExtensions.BuildServiceProvider%2A> in `ConfigureServices`.</span></span> <span data-ttu-id="5dca3-198">L’appel de `BuildServiceProvider` se produit généralement lorsque le développeur souhaite résoudre un service dans `ConfigureServices` .</span><span class="sxs-lookup"><span data-stu-id="5dca3-198">Calling `BuildServiceProvider` typically happens when the developer wants to resolve a service in `ConfigureServices`.</span></span>
- <span data-ttu-id="5dca3-199">Les [services transitoires jetables sont capturés](#disposable-transient-services-captured-by-container) par le conteneur pour la suppression.</span><span class="sxs-lookup"><span data-stu-id="5dca3-199">[Disposable transient services are captured](#disposable-transient-services-captured-by-container) by the container for disposal.</span></span> <span data-ttu-id="5dca3-200">Cela peut entraîner une fuite de mémoire si elle est résolue à partir du conteneur de niveau supérieur.</span><span class="sxs-lookup"><span data-stu-id="5dca3-200">This can turn into a memory leak if resolved from the top-level container.</span></span>
- <span data-ttu-id="5dca3-201">Activez la validation de l’étendue pour vous assurer que l’application n’a pas de singletons qui capturent les services délimités.</span><span class="sxs-lookup"><span data-stu-id="5dca3-201">Enable scope validation to make sure the app doesn't have singletons that capture scoped services.</span></span> <span data-ttu-id="5dca3-202">Pour plus d’informations, consultez [Validation de l’étendue](dependency-injection.md#scope-validation).</span><span class="sxs-lookup"><span data-stu-id="5dca3-202">For more information, see [Scope validation](dependency-injection.md#scope-validation).</span></span>

<span data-ttu-id="5dca3-203">Comme pour toutes les recommandations, vous pouvez vous trouver dans des situations où il est nécessaire d’ignorer une recommandation.</span><span class="sxs-lookup"><span data-stu-id="5dca3-203">Like all sets of recommendations, you may encounter situations where ignoring a recommendation is required.</span></span> <span data-ttu-id="5dca3-204">Les exceptions sont rares, principalement des cas spéciaux dans l’infrastructure elle-même.</span><span class="sxs-lookup"><span data-stu-id="5dca3-204">Exceptions are rare, mostly special cases within the framework itself.</span></span>

<span data-ttu-id="5dca3-205">L’injection de dépendance constitue une *alternative* aux modèles d’accès aux objets statiques/globaux.</span><span class="sxs-lookup"><span data-stu-id="5dca3-205">DI is an *alternative* to static/global object access patterns.</span></span> <span data-ttu-id="5dca3-206">Il est possible que vous ne bénéficiez pas des avantages de l’injection de dépendances si vous la combinez avec l’accès aux objets statiques.</span><span class="sxs-lookup"><span data-stu-id="5dca3-206">You may not be able to realize the benefits of DI if you mix it with static object access.</span></span>

## <a name="example-anti-patterns"></a><span data-ttu-id="5dca3-207">Exemples d’anti-modèles</span><span class="sxs-lookup"><span data-stu-id="5dca3-207">Example anti-patterns</span></span>

<span data-ttu-id="5dca3-208">Outre les instructions de cet article, il existe plusieurs anti-modèles à *éviter.*</span><span class="sxs-lookup"><span data-stu-id="5dca3-208">In addition to the guidelines in this article, there are several anti-patterns *you **should** avoid*.</span></span> <span data-ttu-id="5dca3-209">Certains de ces anti-modèles sont des apprentissages du développement des runtimes eux-mêmes.</span><span class="sxs-lookup"><span data-stu-id="5dca3-209">Some of these anti-patterns are learnings from developing the runtimes themselves.</span></span>

> [!WARNING]
> <span data-ttu-id="5dca3-210">Il s’agit d’un exemple de anti-modèles, de ne *pas* copier le code, de *ne pas* utiliser ces modèles et d’éviter ces modèles à tous les coûts.</span><span class="sxs-lookup"><span data-stu-id="5dca3-210">These are example anti-patterns, *do not* copy the code, *do not* use these patterns, and avoid these patterns at all costs.</span></span>

### <a name="disposable-transient-services-captured-by-container"></a><span data-ttu-id="5dca3-211">Services transitoires jetables capturés par conteneur</span><span class="sxs-lookup"><span data-stu-id="5dca3-211">Disposable transient services captured by container</span></span>

<span data-ttu-id="5dca3-212">Lorsque vous enregistrez des services *temporaires* qui implémentent <xref:System.IDisposable> , le conteneur d’injection de transactions contiendra par défaut ces références, et non <xref:System.IDisposable.Dispose> jusqu’à ce que le conteneur soit supprimé lorsque l’application s’arrêtera si elles étaient résolues à partir du conteneur, ou jusqu’à ce que l’étendue soit supprimée si elles ont été résolues à partir d’une étendue.</span><span class="sxs-lookup"><span data-stu-id="5dca3-212">When you register *Transient* services that implement <xref:System.IDisposable>, by default the DI container will hold onto these references, and not <xref:System.IDisposable.Dispose> of them until the container is disposed when application stops if they were resolved from the container, or until the scope is disposed if they were resolved from a scope.</span></span> <span data-ttu-id="5dca3-213">Cela peut entraîner une fuite de mémoire si elle est résolue à partir du niveau du conteneur.</span><span class="sxs-lookup"><span data-stu-id="5dca3-213">This can turn into a memory leak if resolved from container level.</span></span>

:::code language="csharp" source="snippets/configuration/di-anti-patterns/Program.cs" range="18-30":::

<span data-ttu-id="5dca3-214">Dans l’anti-modèle précédent, 1 000 `ExampleDisposable` objets sont instanciés et rootés.</span><span class="sxs-lookup"><span data-stu-id="5dca3-214">In the preceding anti-pattern, 1,000 `ExampleDisposable` objects are instantiated and rooted.</span></span> <span data-ttu-id="5dca3-215">Elles ne sont pas supprimées tant que l' `serviceProvider` instance n’est pas supprimée.</span><span class="sxs-lookup"><span data-stu-id="5dca3-215">They will not be disposed of until the `serviceProvider` instance is disposed.</span></span>

<span data-ttu-id="5dca3-216">Pour plus d’informations sur le débogage des fuites de mémoire, consultez [déboguer une fuite de mémoire dans .net](../diagnostics/debug-memory-leak.md).</span><span class="sxs-lookup"><span data-stu-id="5dca3-216">For more information on debugging memory leaks, see [Debug a memory leak in .NET](../diagnostics/debug-memory-leak.md).</span></span>

### <a name="async-di-factories-can-cause-deadlocks"></a><span data-ttu-id="5dca3-217">Les fabriques de structures asynchrones Async peuvent provoquer des blocages</span><span class="sxs-lookup"><span data-stu-id="5dca3-217">Async DI factories can cause deadlocks</span></span>

<span data-ttu-id="5dca3-218">Le terme « DI fabriques » fait référence aux méthodes de surcharge qui existent lors de l’appel de `Add{LIFETIME}` .</span><span class="sxs-lookup"><span data-stu-id="5dca3-218">The term "DI factories" refers to the overload methods that exist when calling `Add{LIFETIME}`.</span></span> <span data-ttu-id="5dca3-219">Il existe des surcharges qui acceptent un `Func<IServiceProvider, T>` où `T` est le service en cours d’inscription et le paramètre est nommé `implementationFactory` .</span><span class="sxs-lookup"><span data-stu-id="5dca3-219">There are overloads accepting a `Func<IServiceProvider, T>` where `T` is the service being registered, and the parameter is named `implementationFactory`.</span></span> <span data-ttu-id="5dca3-220">`implementationFactory`Peut être fourni en tant qu’expression lambda, fonction locale ou méthode.</span><span class="sxs-lookup"><span data-stu-id="5dca3-220">The `implementationFactory` can be provided as a lambda expression, local function, or method.</span></span> <span data-ttu-id="5dca3-221">Si la fabrique est asynchrone et que vous utilisez <xref:System.Threading.Tasks.Task%601.Result?displayProperty=nameWithType> , cela provoque un interblocage.</span><span class="sxs-lookup"><span data-stu-id="5dca3-221">If the factory is asynchronous, and you use <xref:System.Threading.Tasks.Task%601.Result?displayProperty=nameWithType>, this will cause a deadlock.</span></span>

:::code language="csharp" source="snippets/configuration/di-anti-patterns/Program.cs" range="32-45" highlight="4-8":::

<span data-ttu-id="5dca3-222">Dans le code précédent, `implementationFactory` reçoit une expression lambda dans laquelle le corps appelle <xref:System.Threading.Tasks.Task%601.Result?displayProperty=nameWithType> sur une `Task<Bar>` méthode de retour.</span><span class="sxs-lookup"><span data-stu-id="5dca3-222">In the preceding code, the `implementationFactory` is given a lambda expression where the body calls <xref:System.Threading.Tasks.Task%601.Result?displayProperty=nameWithType> on a `Task<Bar>` returning method.</span></span> <span data-ttu-id="5dca3-223">Cela ***provoque un interblocage***.</span><span class="sxs-lookup"><span data-stu-id="5dca3-223">This ***causes a deadlock***.</span></span> <span data-ttu-id="5dca3-224">La `GetBarAsync` méthode émule simplement une opération de travail asynchrone avec <xref:System.Threading.Tasks.Task.Delay%2A?displayProperty=nameWithType> , puis appelle <xref:Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService%60%601(System.IServiceProvider)> .</span><span class="sxs-lookup"><span data-stu-id="5dca3-224">The `GetBarAsync` method simply emulates an asynchronous work operation with <xref:System.Threading.Tasks.Task.Delay%2A?displayProperty=nameWithType>, and then calls <xref:Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService%60%601(System.IServiceProvider)>.</span></span>

:::code language="csharp" source="snippets/configuration/di-anti-patterns/Program.cs" range="47-53":::

<span data-ttu-id="5dca3-225">Pour plus d’informations sur l’aide asynchrone, consultez [programmation asynchrone : informations et conseils importants](../../csharp/async.md#important-info-and-advice).</span><span class="sxs-lookup"><span data-stu-id="5dca3-225">For more information on asynchronous guidance, see [Asynchronous programming: Important info and advice](../../csharp/async.md#important-info-and-advice).</span></span> <span data-ttu-id="5dca3-226">Pour plus d’informations sur le débogage des interblocages, consultez [Déboguer un blocage dans .net](../diagnostics/debug-deadlock.md).</span><span class="sxs-lookup"><span data-stu-id="5dca3-226">For more information debugging deadlocks, see [Debug a deadlock in .NET](../diagnostics/debug-deadlock.md).</span></span>

<span data-ttu-id="5dca3-227">Quand vous exécutez cet anti-modèle et que le blocage se produit, vous pouvez afficher les deux threads en attente de la fenêtre piles parallèles de Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="5dca3-227">When you're running this anti-pattern and the deadlock occurs, you can view the two threads waiting from Visual Studio's Parallel Stacks window.</span></span> <span data-ttu-id="5dca3-228">Pour plus d’informations, consultez [afficher les threads et les tâches dans la fenêtre piles parallèles](/visualstudio/debugger/using-the-parallel-stacks-window).</span><span class="sxs-lookup"><span data-stu-id="5dca3-228">For more information, see [View threads and tasks in the Parallel Stacks window](/visualstudio/debugger/using-the-parallel-stacks-window).</span></span>

### <a name="captive-dependency"></a><span data-ttu-id="5dca3-229">Dépendance captive</span><span class="sxs-lookup"><span data-stu-id="5dca3-229">Captive dependency</span></span>

<span data-ttu-id="5dca3-230">Le terme [« dépendance captive »](https://blog.ploeh.dk/2014/06/02/captive-dependency) a été inventé par [Mark Seeman](https://blog.ploeh.dk/about)et fait référence à une configuration insuffisante des durées de vie des services, où un service plus long contient un service plus éphémère.</span><span class="sxs-lookup"><span data-stu-id="5dca3-230">The term ["captive dependency"](https://blog.ploeh.dk/2014/06/02/captive-dependency) was coined by [Mark Seeman](https://blog.ploeh.dk/about), and refers to the misconfiguration of service lifetimes, where a longer-lived service holds a shorter-lived service captive.</span></span>

:::code language="csharp" source="snippets/configuration/di-anti-patterns/Program.cs" range="55-65":::

<span data-ttu-id="5dca3-231">Dans le code précédent, `Foo` est inscrit en tant que Singleton et `Bar` est étendu, ce qui, sur la surface, semble être valide.</span><span class="sxs-lookup"><span data-stu-id="5dca3-231">In the preceding code, `Foo` is registered as a singleton and `Bar` is scoped - which on the surface seems valid.</span></span> <span data-ttu-id="5dca3-232">Toutefois, tenez compte de l’implémentation de `Foo` .</span><span class="sxs-lookup"><span data-stu-id="5dca3-232">However, consider the implementation of `Foo`.</span></span>

:::code language="csharp" source="snippets/configuration/di-anti-patterns/Foo.cs" highlight="5":::

<span data-ttu-id="5dca3-233">L' `Foo` objet requiert un `Bar` objet, et étant donné que `Foo` est un singleton et `Bar` est étendu, il s’agit d’une configuration Inde.</span><span class="sxs-lookup"><span data-stu-id="5dca3-233">The `Foo` object requires a `Bar` object, and since `Foo` is a singleton, and `Bar` is scoped - this is a misconfiguration.</span></span> <span data-ttu-id="5dca3-234">Comme c’est le cas, ne `Foo` serait instanciée qu’une seule fois et elle contiendrait `Bar` pour sa durée de vie, ce qui est plus long que la durée de vie limitée prévue de `Bar` .</span><span class="sxs-lookup"><span data-stu-id="5dca3-234">As is, `Foo` would only be instantiated once, and it would hold onto `Bar` for its lifetime, which is longer than the intended scoped lifetime of `Bar`.</span></span> <span data-ttu-id="5dca3-235">Vous devez envisager de valider des portées en passant `validateScopes: true` à l' <xref:Microsoft.Extensions.DependencyInjection.ServiceCollectionContainerBuilderExtensions.BuildServiceProvider(Microsoft.Extensions.DependencyInjection.IServiceCollection,System.Boolean)> .</span><span class="sxs-lookup"><span data-stu-id="5dca3-235">You should consider validating scopes, by passing `validateScopes: true` to the <xref:Microsoft.Extensions.DependencyInjection.ServiceCollectionContainerBuilderExtensions.BuildServiceProvider(Microsoft.Extensions.DependencyInjection.IServiceCollection,System.Boolean)>.</span></span> <span data-ttu-id="5dca3-236">Lorsque vous validez les étendues, vous obtenez un <xref:System.InvalidOperationException> avec un message semblable à « impossible d’utiliser la barre du service d’étendue » à partir du singleton « foo ».».</span><span class="sxs-lookup"><span data-stu-id="5dca3-236">When you validate the scopes, you'd get an <xref:System.InvalidOperationException> with a message similar to "Cannot consume scoped service 'Bar' from singleton 'Foo'.".</span></span>

<span data-ttu-id="5dca3-237">Pour plus d’informations, consultez [Validation de l’étendue](dependency-injection.md#scope-validation).</span><span class="sxs-lookup"><span data-stu-id="5dca3-237">For more information, see [Scope validation](dependency-injection.md#scope-validation).</span></span>

### <a name="scoped-service-as-singleton"></a><span data-ttu-id="5dca3-238">Service étendu en tant que singleton</span><span class="sxs-lookup"><span data-stu-id="5dca3-238">Scoped service as singleton</span></span>

<span data-ttu-id="5dca3-239">Si vous utilisez des services délimités, si vous ne créez pas d’étendue ou au sein d’une étendue existante, le service devient un singleton.</span><span class="sxs-lookup"><span data-stu-id="5dca3-239">When using scoped services, if you're not creating a scope or within an existing scope - the service becomes a singleton.</span></span>

:::code language="csharp" source="snippets/configuration/di-anti-patterns/Program.cs" range="68-82" highlight="13-14":::

<span data-ttu-id="5dca3-240">Dans le code précédent, `Bar` est récupéré dans un <xref:Microsoft.Extensions.DependencyInjection.IServiceScope> , ce qui est correct.</span><span class="sxs-lookup"><span data-stu-id="5dca3-240">In the preceding code, `Bar` is retrieved within an <xref:Microsoft.Extensions.DependencyInjection.IServiceScope>, which is correct.</span></span> <span data-ttu-id="5dca3-241">L’anti-modèle est la récupération de l' `Bar` extérieur de la portée, et la variable est nommée `avoid` pour indiquer quel exemple de récupération est incorrect.</span><span class="sxs-lookup"><span data-stu-id="5dca3-241">The anti-pattern is the retrieval of `Bar` outside of the scope, and the variable is named `avoid` to show which example retrieval is incorrect.</span></span>

## <a name="see-also"></a><span data-ttu-id="5dca3-242">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="5dca3-242">See also</span></span>

- [<span data-ttu-id="5dca3-243">Injection de dépendances dans .NET</span><span class="sxs-lookup"><span data-stu-id="5dca3-243">Dependency injection in .NET</span></span>](dependency-injection.md)
- [<span data-ttu-id="5dca3-244">Didacticiel : utiliser l’injection de dépendances dans .NET</span><span class="sxs-lookup"><span data-stu-id="5dca3-244">Tutorial: Use dependency injection in .NET</span></span>](dependency-injection-usage.md)
