---
title: Migration C++de projets/CLI vers .net Core
description: En savoir plus sur C++le portage de projets/CLI vers .net core.
author: mjrousos
ms.date: 01/10/2020
ms.openlocfilehash: eb03f2a5ff42e8279fd3ebd6ee6fb6d955f6798d
ms.sourcegitcommit: c01c18755bb7b0f82c7232314ccf7955ea7834db
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/15/2020
ms.locfileid: "75964929"
---
# <a name="how-to-port-a-ccli-project-to-net-core"></a><span data-ttu-id="fd157-103">Guide pratique pour porter C++un projet/CLI vers .net Core</span><span class="sxs-lookup"><span data-stu-id="fd157-103">How to port a C++/CLI project to .NET Core</span></span>

<span data-ttu-id="fd157-104">À compter de .net Core 3,1 et de Visual Studio 2019 version 16,4, [ C++les projets/CLI](/cpp/dotnet/dotnet-programming-with-cpp-cli-visual-cpp) peuvent cibler .net core.</span><span class="sxs-lookup"><span data-stu-id="fd157-104">Beginning with .NET Core 3.1 and Visual Studio 2019 version 16.4, [C++/CLI projects](/cpp/dotnet/dotnet-programming-with-cpp-cli-visual-cpp) can target .NET Core.</span></span> <span data-ttu-id="fd157-105">Cette prise en charge permet de porter les applications de bureau C++Windows avec des couches Interop/CLI vers .net core.</span><span class="sxs-lookup"><span data-stu-id="fd157-105">This support makes it possible to port Windows desktop applications with C++/CLI interop layers to .NET Core.</span></span> <span data-ttu-id="fd157-106">Cet article explique comment déplacer C++des projets/cli de .NET Framework vers .net Core 3,1.</span><span class="sxs-lookup"><span data-stu-id="fd157-106">This article describes how to port C++/CLI projects from .NET Framework to .NET Core 3.1.</span></span>

## <a name="ccli-net-core-limitations"></a><span data-ttu-id="fd157-107">C++Limitations de .NET Core/CLI</span><span class="sxs-lookup"><span data-stu-id="fd157-107">C++/CLI .NET Core limitations</span></span>

<span data-ttu-id="fd157-108">Il existe quelques limitations importantes pour le portage C++de projets/CLI vers .net Core par rapport à d’autres langages :</span><span class="sxs-lookup"><span data-stu-id="fd157-108">There are some important limitations to porting C++/CLI projects to .NET Core compared to other languages:</span></span>

* <span data-ttu-id="fd157-109">C++La prise en charge de .NET Core/CLI est Windows uniquement.</span><span class="sxs-lookup"><span data-stu-id="fd157-109">C++/CLI support for .NET Core is Windows only.</span></span>
* <span data-ttu-id="fd157-110">C++Les projets/CLI ne peuvent pas cibler .NET Standard, mais uniquement .NET Core (ou .NET Framework).</span><span class="sxs-lookup"><span data-stu-id="fd157-110">C++/CLI projects can't target .NET Standard, only .NET Core (or .NET Framework).</span></span>
* <span data-ttu-id="fd157-111">C++Les projets/CLI ne prennent pas en charge le nouveau format de fichier de projet de type SDK.</span><span class="sxs-lookup"><span data-stu-id="fd157-111">C++/CLI projects don't support the new SDK-style project file format.</span></span> <span data-ttu-id="fd157-112">Au lieu de cela, même quand vous C++ciblez .net Core, les projets/CLI utilisent le format de fichier vcxproj existant.</span><span class="sxs-lookup"><span data-stu-id="fd157-112">Instead, even when targeting .NET Core, C++/CLI projects use the existing vcxproj file format.</span></span>
* <span data-ttu-id="fd157-113">C++Les projets/CLI ne peuvent pas multicibler plusieurs plateformes .NET.</span><span class="sxs-lookup"><span data-stu-id="fd157-113">C++/CLI projects can't multitarget multiple .NET platforms.</span></span> <span data-ttu-id="fd157-114">Si vous avez besoin de générer C++un projet/cli pour .NET Framework et .net Core, utilisez des fichiers de projet distincts.</span><span class="sxs-lookup"><span data-stu-id="fd157-114">If you need to build a C++/CLI project for both .NET Framework and .NET Core, use separate project files.</span></span>
* <span data-ttu-id="fd157-115">.NET Core ne prend pas en charge la compilation `-clr:pure` ou `-clr:safe`, mais uniquement la nouvelle option `-clr:netcore` (qui est équivalente à `-clr` pour .NET Framework).</span><span class="sxs-lookup"><span data-stu-id="fd157-115">.NET Core doesn't support `-clr:pure` or `-clr:safe` compilation, only the new `-clr:netcore` option (which is equivalent to `-clr` for .NET Framework).</span></span>

## <a name="port-a-ccli-project"></a><span data-ttu-id="fd157-116">Porter un C++projet/CLI</span><span class="sxs-lookup"><span data-stu-id="fd157-116">Port a C++/CLI project</span></span>

<span data-ttu-id="fd157-117">Pour porter un C++projet/CLI vers .net Core, apportez les modifications suivantes au fichier vcxproj.</span><span class="sxs-lookup"><span data-stu-id="fd157-117">To port a C++/CLI project to .NET Core, make the following changes to the vcxproj file.</span></span> <span data-ttu-id="fd157-118">Ces étapes de migration diffèrent des étapes requises pour les autres types C++de projets, car les projets/CLI n’utilisent pas de fichiers projet de type SDK.</span><span class="sxs-lookup"><span data-stu-id="fd157-118">These migration steps differ from the steps needed for other project types because C++/CLI projects don't use SDK-style project files.</span></span>

1. <span data-ttu-id="fd157-119">Remplacez `<CLRSupport>true</CLRSupport>` propriétés par `<CLRSupport>NetCore</CLRSupport>`.</span><span class="sxs-lookup"><span data-stu-id="fd157-119">Replace `<CLRSupport>true</CLRSupport>` properties with `<CLRSupport>NetCore</CLRSupport>`.</span></span> <span data-ttu-id="fd157-120">Cette propriété est souvent dans des groupes de propriétés spécifiques à la configuration. vous devrez donc peut-être la remplacer à plusieurs emplacements.</span><span class="sxs-lookup"><span data-stu-id="fd157-120">This property is often in configuration-specific property groups, so you may need to replace it in multiple places.</span></span>
2. <span data-ttu-id="fd157-121">Remplacez `<TargetFrameworkVersion>` propriétés par `<TargetFramework>netcoreapp3.1</TargetFramework>`.</span><span class="sxs-lookup"><span data-stu-id="fd157-121">Replace `<TargetFrameworkVersion>` properties with `<TargetFramework>netcoreapp3.1</TargetFramework>`.</span></span>
3. <span data-ttu-id="fd157-122">Supprimez toutes les références .NET Framework (par exemple `<Reference Include="System" />`).</span><span class="sxs-lookup"><span data-stu-id="fd157-122">Remove any .NET Framework references (like `<Reference Include="System" />`).</span></span> <span data-ttu-id="fd157-123">Les assemblys kit SDK .NET Core sont automatiquement référencés lors de l’utilisation de `<CLRSupport>NetCore</CLRSupport>`.</span><span class="sxs-lookup"><span data-stu-id="fd157-123">.NET Core SDK assemblies are automatically referenced when using `<CLRSupport>NetCore</CLRSupport>`.</span></span>
4. <span data-ttu-id="fd157-124">Mettez à jour l’utilisation des API dans les fichiers CPP, si nécessaire, pour supprimer les API non disponibles pour .NET Core.</span><span class="sxs-lookup"><span data-stu-id="fd157-124">Update API usage in cpp files, as necessary, to remove APIs unavailable to .NET Core.</span></span> <span data-ttu-id="fd157-125">Étant C++donné que les projets/CLI ont tendance à être des couches d’interopérabilité assez étroites, il n’y a souvent pas beaucoup de modifications nécessaires.</span><span class="sxs-lookup"><span data-stu-id="fd157-125">Because C++/CLI projects tend to be fairly thin interop layers, there are often not many changes needed.</span></span> <span data-ttu-id="fd157-126">L' [Analyseur de portabilité .net](../../standard/analyzers/portability-analyzer.md) peut être utilisé pour identifier les API .net non prises en C++charge utilisées par les fichiers binaires/CLI, tout comme avec les fichiers binaires purement managés.</span><span class="sxs-lookup"><span data-stu-id="fd157-126">The [.NET Portability Analyzer](../../standard/analyzers/portability-analyzer.md) can be used to identify unsupported .NET APIs used by C++/CLI binaries just as with purely managed binaries.</span></span> <span data-ttu-id="fd157-127">Les instructions relatives à la détermination de la portabilité du code et à la mise à jour des projets à utiliser avec les API .NET Core sont disponibles dans le [Guide de portage des bibliothèques](./libraries.md#determine-portability).</span><span class="sxs-lookup"><span data-stu-id="fd157-127">Guidelines for determining code portability and updating projects to work with .NET Core APIs are available in the [library porting guidance](./libraries.md#determine-portability).</span></span>

### <a name="wpf-and-windows-forms-usage"></a><span data-ttu-id="fd157-128">Utilisation de WPF et de Windows Forms</span><span class="sxs-lookup"><span data-stu-id="fd157-128">WPF and Windows Forms usage</span></span>

<span data-ttu-id="fd157-129">Les projets C++.net Core/CLI peuvent utiliser des API Windows Forms et WPF.</span><span class="sxs-lookup"><span data-stu-id="fd157-129">.NET Core C++/CLI projects can use Windows Forms and WPF APIs.</span></span> <span data-ttu-id="fd157-130">Pour utiliser ces API de bureau Windows, vous devez ajouter des références d’infrastructure explicites aux bibliothèques de l’interface utilisateur.</span><span class="sxs-lookup"><span data-stu-id="fd157-130">To use these Windows desktop APIs, you need to add explicit framework references to the UI libraries.</span></span> <span data-ttu-id="fd157-131">Les projets de type SDK qui utilisent les API de bureau Windows référencent automatiquement les bibliothèques d’infrastructure nécessaires à l’aide du kit de développement logiciel (SDK) `Microsoft.NET.Sdk.WindowsDesktop`.</span><span class="sxs-lookup"><span data-stu-id="fd157-131">SDK-style projects that use Windows desktop APIs reference the necessary framework libraries automatically by using the `Microsoft.NET.Sdk.WindowsDesktop` SDK.</span></span> <span data-ttu-id="fd157-132">Étant C++donné que les projets/CLI n’utilisent pas le format de projet de type SDK, ils doivent ajouter des références d’infrastructure explicites lors du ciblage de .net core.</span><span class="sxs-lookup"><span data-stu-id="fd157-132">Because C++/CLI projects don't use the SDK-style project format, they need to add explicit framework references when targeting .NET Core.</span></span>

<span data-ttu-id="fd157-133">Pour utiliser des API Windows Forms, ajoutez cette référence au fichier vcxproj :</span><span class="sxs-lookup"><span data-stu-id="fd157-133">To use Windows Forms APIs, add this reference to the vcxproj file:</span></span>

```xml
<!-- Reference all of Windows Forms -->
<FrameworkReference Include="Microsoft.WindowsDesktop.App.WindowsForms" />
```

<span data-ttu-id="fd157-134">Pour utiliser les API WPF, ajoutez cette référence au fichier vcxproj :</span><span class="sxs-lookup"><span data-stu-id="fd157-134">To use WPF APIs, add this reference to the vcxproj file:</span></span>

```xml
<!-- Reference all of WPF -->
<FrameworkReference Include="Microsoft.WindowsDesktop.App.WPF" />
```

<span data-ttu-id="fd157-135">Pour utiliser les Windows Forms et les API WPF, ajoutez cette référence au fichier vcxproj :</span><span class="sxs-lookup"><span data-stu-id="fd157-135">To use both Windows Forms and WPF APIs, add this reference to the vcxproj file:</span></span>

```xml
<!-- Reference the entirety of the Windows desktop framework:
     Windows Forms, WPF, and the types that provide integration between them -->
<FrameworkReference Include="Microsoft.WindowsDesktop.App" />
```

<span data-ttu-id="fd157-136">Actuellement, il n’est pas possible d’ajouter ces références à l’aide du gestionnaire de références de Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="fd157-136">Currently, it's not possible to add these references using Visual Studio's reference manager.</span></span> <span data-ttu-id="fd157-137">À la place, mettez à jour le fichier projet manuellement.</span><span class="sxs-lookup"><span data-stu-id="fd157-137">Instead, update the project file manually.</span></span> <span data-ttu-id="fd157-138">Cette mise à jour peut être effectuée dans Visual Studio en déchargeant le projet, puis en modifiant le fichier projet.</span><span class="sxs-lookup"><span data-stu-id="fd157-138">This update can be done in Visual Studio by unloading the project and then editing the project file.</span></span> <span data-ttu-id="fd157-139">Vous pouvez également utiliser un autre éditeur comme VS Code.</span><span class="sxs-lookup"><span data-stu-id="fd157-139">You can also use another editor like VS Code.</span></span>

## <a name="build-without-msbuild"></a><span data-ttu-id="fd157-140">Générer sans MSBuild</span><span class="sxs-lookup"><span data-stu-id="fd157-140">Build without MSBuild</span></span>

<span data-ttu-id="fd157-141">Il est également possible de générer C++des projets/CLI sans utiliser MSBuild.</span><span class="sxs-lookup"><span data-stu-id="fd157-141">It's also possible to build C++/CLI projects without using MSBuild.</span></span> <span data-ttu-id="fd157-142">Procédez comme suit pour générer C++un projet/CLI pour .net Core directement avec *CL. exe* et *Link. exe*:</span><span class="sxs-lookup"><span data-stu-id="fd157-142">Follow these steps to build a C++/CLI project for .NET Core directly with *cl.exe* and *link.exe*:</span></span>

1. <span data-ttu-id="fd157-143">Lors de la compilation, passer `-clr:netcore` à *CL. exe*.</span><span class="sxs-lookup"><span data-stu-id="fd157-143">When compiling, pass `-clr:netcore` to *cl.exe*.</span></span>
2. <span data-ttu-id="fd157-144">Référencez les assemblys de référence .NET Core nécessaires.</span><span class="sxs-lookup"><span data-stu-id="fd157-144">Reference necessary .NET Core reference assemblies.</span></span>
3. <span data-ttu-id="fd157-145">Lors de la liaison, fournissez le répertoire hôte de l’application .NET Core en tant que `LibPath` (afin que *ijwhost. lib* puisse être trouvé).</span><span class="sxs-lookup"><span data-stu-id="fd157-145">When linking, provide the .NET Core app host directory as a `LibPath` (so that *ijwhost.lib* can be found).</span></span>
4. <span data-ttu-id="fd157-146">Copiez *ijwhost. dll* (à partir du répertoire hôte de l’application .net Core) dans le répertoire de sortie du projet.</span><span class="sxs-lookup"><span data-stu-id="fd157-146">Copy *ijwhost.dll* (from the .NET Core app host directory) to the project's output directory.</span></span>
5. <span data-ttu-id="fd157-147">Assurez-vous qu’il existe un fichier [runtimeconfig. JSON](https://github.com/dotnet/cli/blob/master/Documentation/specs/runtime-configuration-file.md) pour le premier composant de l’application qui exécutera le code managé.</span><span class="sxs-lookup"><span data-stu-id="fd157-147">Make sure a [runtimeconfig.json](https://github.com/dotnet/cli/blob/master/Documentation/specs/runtime-configuration-file.md) file exists for the first component of the application that will run managed code.</span></span> <span data-ttu-id="fd157-148">Si l’application a un point d’entrée géré, un fichier de `runtime.config` est créé et copié automatiquement.</span><span class="sxs-lookup"><span data-stu-id="fd157-148">If the application has a managed entry point, a `runtime.config` file will be created and copied automatically.</span></span> <span data-ttu-id="fd157-149">Toutefois, si l’application a un point d’entrée natif, vous devez créer un fichier `runtimeconfig.json` pour la première C++bibliothèque/CLI afin d’utiliser le Runtime .net core.</span><span class="sxs-lookup"><span data-stu-id="fd157-149">If the application has a native entry point, though, you need to create a `runtimeconfig.json` file for the first C++/CLI library to use the .NET Core runtime.</span></span>

## <a name="known-issues"></a><span data-ttu-id="fd157-150">Problèmes connus</span><span class="sxs-lookup"><span data-stu-id="fd157-150">Known issues</span></span>

<span data-ttu-id="fd157-151">Il existe quelques problèmes connus à prendre en compte lors de l’utilisation C++de projets/CLI ciblant .net core.</span><span class="sxs-lookup"><span data-stu-id="fd157-151">There are a couple known issues to look out for when working with C++/CLI projects targeting .NET Core.</span></span>

* <span data-ttu-id="fd157-152">Une référence d’infrastructure WPF dans les C++projets .net Core/CLI provoque actuellement des avertissements superflus concernant l’impossibilité d’importer des symboles.</span><span class="sxs-lookup"><span data-stu-id="fd157-152">A WPF framework reference in .NET Core C++/CLI projects currently causes some extraneous warnings about being unable to import symbols.</span></span> <span data-ttu-id="fd157-153">Ces avertissements peuvent être ignorés sans risque et doivent être corrigés prochainement.</span><span class="sxs-lookup"><span data-stu-id="fd157-153">These warnings can be safely ignored and should be fixed soon.</span></span>
* <span data-ttu-id="fd157-154">Si l’application dispose d’un point d’entrée natif C++, la bibliothèque/CLI qui exécute en premier le code managé a besoin d’un fichier [runtimeconfig. JSON](https://github.com/dotnet/cli/blob/master/Documentation/specs/runtime-configuration-file.md) .</span><span class="sxs-lookup"><span data-stu-id="fd157-154">If the application has a native entry point, the C++/CLI library that first executes managed code needs a [runtimeconfig.json](https://github.com/dotnet/cli/blob/master/Documentation/specs/runtime-configuration-file.md) file.</span></span> <span data-ttu-id="fd157-155">Ce fichier de configuration est utilisé lors du démarrage du Runtime .NET Core.</span><span class="sxs-lookup"><span data-stu-id="fd157-155">This config file is used when the .NET Core runtime starts.</span></span> <span data-ttu-id="fd157-156">C++Les projets/CLI ne créent pas encore `runtimeconfig.json` fichiers automatiquement au moment de la génération, le fichier doit donc être généré manuellement.</span><span class="sxs-lookup"><span data-stu-id="fd157-156">C++/CLI projects don't create `runtimeconfig.json` files automatically at build time yet, so the file must be generated manually.</span></span> <span data-ttu-id="fd157-157">Si une C++bibliothèque/CLI est appelée à partir d’un point d’entrée managé C++, la bibliothèque/CLI n’a pas besoin d’un fichier `runtimeconfig.json` (car l’assembly de point d’entrée en aura un qui est utilisé lors du démarrage du Runtime).</span><span class="sxs-lookup"><span data-stu-id="fd157-157">If a C++/CLI library is called from a managed entry point, then the C++/CLI library doesn't need a `runtimeconfig.json` file (since the entry point assembly will have one that is used when starting the runtime).</span></span> <span data-ttu-id="fd157-158">Un exemple simple de `runtimeconfig.json` fichier est présenté ci-dessous.</span><span class="sxs-lookup"><span data-stu-id="fd157-158">A simple sample `runtimeconfig.json` file is shown below.</span></span> <span data-ttu-id="fd157-159">Pour plus d’informations, consultez la [spécification sur GitHub](https://github.com/dotnet/cli/blob/master/Documentation/specs/runtime-configuration-file.md).</span><span class="sxs-lookup"><span data-stu-id="fd157-159">For more information, see the [spec on GitHub](https://github.com/dotnet/cli/blob/master/Documentation/specs/runtime-configuration-file.md).</span></span>

    ```json
    {
          "runtimeOptions": {
             "tfm": "netcoreapp3.1",
             "framework": {
                "name": "Microsoft.NETCore.App",
                "version": "3.1.0"
             }
          }
    }
    ```
