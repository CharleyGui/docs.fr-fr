---
title: Écrivez et appelez des fonctions définies par l’utilisateur dans .NET pour Apache Spark environnements interactifs.
description: Découvrez comment écrire et appeler des fonctions définies par l’utilisateur dans .NET pour Apache Spark des shells interactifs.
ms.date: 10/09/2020
ms.topic: conceptual
ms.custom: mvc,how-to
ms.openlocfilehash: d02ce7ec92ac1758b490b66d241d4957082eb20e
ms.sourcegitcommit: eb7e87496f42361b1da98562dd75b516c9d58bbc
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 10/09/2020
ms.locfileid: "91877929"
---
# <a name="write-and-call-udfs-in-net-for-apache-spark-interactive-environments"></a><span data-ttu-id="c9d2d-103">Écrire et appeler des fonctions définies par l’utilisateur dans .NET pour Apache Spark environnements interactifs</span><span class="sxs-lookup"><span data-stu-id="c9d2d-103">Write and call UDFs in .NET for Apache Spark interactive environments</span></span>

<span data-ttu-id="c9d2d-104">Dans cet article, vous allez apprendre à utiliser des fonctions définies par l’utilisateur (UDF) dans .NET pour Apache Spark environnement interactif.</span><span class="sxs-lookup"><span data-stu-id="c9d2d-104">In this article you will learn how to use User Defined Functions (UDFs) in a .NET for Apache Spark interactive environment.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="c9d2d-105">Prérequis</span><span class="sxs-lookup"><span data-stu-id="c9d2d-105">Prerequisites</span></span>

1. <span data-ttu-id="c9d2d-106">Installer [.net interactive](https://github.com/dotnet/interactive)</span><span class="sxs-lookup"><span data-stu-id="c9d2d-106">Install [.NET Interactive](https://github.com/dotnet/interactive)</span></span>
2. <span data-ttu-id="c9d2d-107">Installer [Jupyter Lab](https://jupyter.org/)</span><span class="sxs-lookup"><span data-stu-id="c9d2d-107">Install [Jupyter lab](https://jupyter.org/)</span></span>

## <a name="net-for-apach-spark-interactive-experience"></a><span data-ttu-id="c9d2d-108">.NET pour l’expérience interactive Apach Spark</span><span class="sxs-lookup"><span data-stu-id="c9d2d-108">.NET for Apach Spark Interactive experience</span></span>

<span data-ttu-id="c9d2d-109">[.Net pour Apache Spark](https://github.com/dotnet/spark) utilise [.net interactive](https://devblogs.microsoft.com/dotnet/net-interactive-is-here-net-notebooks-preview-2/) pour assurer la prise en charge par .net de l’expérience interactive dans Spark.</span><span class="sxs-lookup"><span data-stu-id="c9d2d-109">[.NET for Apache Spark](https://github.com/dotnet/spark) uses [.NET Interactive](https://devblogs.microsoft.com/dotnet/net-interactive-is-here-net-notebooks-preview-2/) to provide .NET support for interactive experience inside Spark.</span></span> <span data-ttu-id="c9d2d-110">Pour comprendre comment configurer l’environnement pour essayer .NET interactive avec des blocs-notes Jupyter, consultez le [référentiel interactif .net](https://github.com/dotnet/interactive).</span><span class="sxs-lookup"><span data-stu-id="c9d2d-110">To understand how to setup the environment to try .NET Interactive with Jupyter notebooks, see the [.NET Interactive repository](https://github.com/dotnet/interactive).</span></span>

<span data-ttu-id="c9d2d-111">En outre, il est recommandé de parcourir [cet article sur la SÉRIALISATION UDF dans .net pour Apache Spark](udf-guide.md) pour comprendre quelles sont les fonctions définies par l’utilisateur et comment elles sont sérialisées dans .net pour Apache Spark.</span><span class="sxs-lookup"><span data-stu-id="c9d2d-111">Also, it is recommended to go through [this article about UDF serialization in .NET for Apache Spark](udf-guide.md) to understand what UDFs are and how they are serialized in .NET for Apache Spark.</span></span>
<span data-ttu-id="c9d2d-112">Ce guide utilise les blocs-notes Jupyter pour illustrer l’utilisation des fonctions définies par l’utilisateur dans une expérience interactive.</span><span class="sxs-lookup"><span data-stu-id="c9d2d-112">This guide uses Jupyter Notebooks to illustrate how to use UDFs in an interactive experience.</span></span>

## <a name="define-a-udf-in-net-interactive"></a><span data-ttu-id="c9d2d-113">Définir une FDU dans .NET interactive</span><span class="sxs-lookup"><span data-stu-id="c9d2d-113">Define a UDF in .NET Interactive</span></span>

<span data-ttu-id="c9d2d-114">Dans l’expérience interactive, une cellule peut être considérée comme l’extrait de code qui est soumis dans le cadre d’une itération de la [REPL](https://en.wikipedia.org/wiki/Read%E2%80%93eval%E2%80%93print_loop).</span><span class="sxs-lookup"><span data-stu-id="c9d2d-114">In the interactive experience, a cell can be thought of as the code snippet being submitted as part of one iteration of the [REPL](https://en.wikipedia.org/wiki/Read%E2%80%93eval%E2%80%93print_loop).</span></span> <span data-ttu-id="c9d2d-115">Par exemple, jetez un coup d’œil au bloc-notes suivant pour comprendre ce que cela signifie :</span><span class="sxs-lookup"><span data-stu-id="c9d2d-115">For example, take a look at the following notebook to understand what that means:</span></span>

![Cellules Jupyter Notebook](./media/dotnet-interactive/dotnet-interactive-cells.png)

<span data-ttu-id="c9d2d-117">Chacun de ces blocs marqués par la flèche rouge est une cellule, ou une soumission de code à Spark.</span><span class="sxs-lookup"><span data-stu-id="c9d2d-117">Each of those blocks marked by the red arrow is one cell, or one submission of code to Spark.</span></span> <span data-ttu-id="c9d2d-118">Désormais, lors de la définition d’une fonction définie par l’utilisateur qui fait référence à un objet personnalisé défini par l’utilisateur, il est nécessaire que la fonction définie par l’utilisateur soit définie dans la même cellule que l’objet auquel elle fait référence.</span><span class="sxs-lookup"><span data-stu-id="c9d2d-118">Now when defining a UDF that references a custom user-defined object, it is required that the UDF be defined in the same cell where the object it references is defined.</span></span> <span data-ttu-id="c9d2d-119">Examinons ce qui ressemble à un exemple :</span><span class="sxs-lookup"><span data-stu-id="c9d2d-119">Let's look at what that looks like as an example:</span></span>

![Travail UDF](./media/dotnet-interactive/working-udf.png)

## <a name="call-a-udf-on-a-dataframe"></a><span data-ttu-id="c9d2d-121">Appeler une FDU sur un tableau</span><span class="sxs-lookup"><span data-stu-id="c9d2d-121">Call a UDF on a DataFrame</span></span>

<span data-ttu-id="c9d2d-122">Lors de l’appel d’une FDU définie précédemment sur un `DataFrame` , il est important de s’assurer que la FDU est définie dans une cellule précédemment soumise, avant de l’appeler, comme illustré dans l’exemple précédent.</span><span class="sxs-lookup"><span data-stu-id="c9d2d-122">When calling a previously defined UDF on a `DataFrame` it is important to make sure the UDF is defined in a previously submitted cell, before calling it, as can be seen in the previous example.</span></span>

<span data-ttu-id="c9d2d-123">Voyons maintenant ce qui se passe si nous appelons la fonction UDF dans la même cellule où elle est définie.</span><span class="sxs-lookup"><span data-stu-id="c9d2d-123">Now let's see what happens if we call the UDF in the same cell where it is defined.</span></span>

![échec de l’appel UDF](./media/dotnet-interactive/udf_fails.png)

<span data-ttu-id="c9d2d-125">L’erreur en surbrillance ci-dessus est due au fait que les assemblys UDF doivent d’abord être compilés et expédiés aux Workers avant de pouvoir être appelés sur un tableau.</span><span class="sxs-lookup"><span data-stu-id="c9d2d-125">The above highlighted error is because the UDF assemblies need to first be compiled and shipped to the workers before it can be called on a DataFrame.</span></span>

<span data-ttu-id="c9d2d-126">Voici quelques points importants à prendre en compte lors de l’implémentation de fonctions définies par l’utilisateur dans .NET pour Apache Spark une expérience interactive (comme les [Notebooks Azure Synapse](https://docs.microsoft.com/azure/synapse-analytics/spark/apache-spark-development-using-notebooks)).</span><span class="sxs-lookup"><span data-stu-id="c9d2d-126">These are a few important things to keep in mind while implementing UDFs in .NET for Apache Spark interactive experience (such as [Azure Synapse Notebooks](https://docs.microsoft.com/azure/synapse-analytics/spark/apache-spark-development-using-notebooks)).</span></span>

## <a name="faqs"></a><span data-ttu-id="c9d2d-127">FAQ</span><span class="sxs-lookup"><span data-stu-id="c9d2d-127">FAQs</span></span>

1. <span data-ttu-id="c9d2d-128">**Pourquoi mon UDF référençant un objet personnalisé défini par l’utilisateur génère-t-il l’erreur `Type Submission#_ is not marked as serializable` ?**</span><span class="sxs-lookup"><span data-stu-id="c9d2d-128">**Why does my UDF referencing a custom user-defined object throws the error `Type Submission#_ is not marked as serializable`?**</span></span>  
    <span data-ttu-id="c9d2d-129">.NET interactive enveloppe chacune de ces cellules avec une classe wrapper du numéro d’envoi de cellule pour identifier de manière unique chaque cellule en cours d’envoi.</span><span class="sxs-lookup"><span data-stu-id="c9d2d-129">.NET Interactive wraps each of these cells with a wrapper class of the cell submission number, to uniquely identify each cell being submitted.</span></span> <span data-ttu-id="c9d2d-130">Comme expliqué en détail dans [ce guide](udf-guide.md), lorsqu’une fonction UDF qui référence un objet personnalisé est sérialisée, sa cible est également sélectionnée pour la sérialisation, ce qui, dans le cas de .net interactive, est encapsulé par la classe wrapper de la cellule où l’objet personnalisé est défini.</span><span class="sxs-lookup"><span data-stu-id="c9d2d-130">Now as explained in detail in [this guide](udf-guide.md), when a UDF that references a custom object is being serialized its target is also picked up for serialization, which in the case of .NET Interactive gets wrapped by the wrapper class of the cell where the custom object is defined.</span></span>
   <span data-ttu-id="c9d2d-131">Voyons maintenant comment cela affecte la définition de la FDU dans le bloc-notes :</span><span class="sxs-lookup"><span data-stu-id="c9d2d-131">Now let's see how that affects our UDF definition in the notebook:</span></span>

    ![Erreur de sérialisation UDF](./media/dotnet-interactive/udf-serialization-error.png)

    <span data-ttu-id="c9d2d-133">Comme vous pouvez le voir dans le cas de `udf2_fails` , nous voyons le message d’erreur qui indique que le type `Submission#7` n’est pas marqué comme sérialisable. cela est dû au fait qu’il encapsule chaque objet défini dans une cellule avec sa `Submission#` classe qui est générée à la volée et qui, par conséquent, n’est pas marquée comme `Serializable` , par conséquent l’erreur.</span><span class="sxs-lookup"><span data-stu-id="c9d2d-133">As can be seen in the case of `udf2_fails`, we see the error message which says Type `Submission#7` is not marked as serializable, this is because how .NET Interactive works is it wraps every object defined in a cell with its `Submission#` class which is generated on the fly and hence is not marked as `Serializable`, hence the error.</span></span>
    <span data-ttu-id="c9d2d-134">Pour cette raison, il est **nécessaire qu’une FDU référençant un objet personnalisé dans celui-ci soit définie dans la même cellule que cet objet**.</span><span class="sxs-lookup"><span data-stu-id="c9d2d-134">For this reason, it is **required that a UDF referencing a custom object in it, is defined in the same cell as that object**.</span></span>

2. <span data-ttu-id="c9d2d-135">**Pourquoi les variables de diffusion ne fonctionnent-elles pas avec .NET interactive ?**</span><span class="sxs-lookup"><span data-stu-id="c9d2d-135">**Why Broadcast Variables don't work with .NET Interactive?**</span></span>  
    <span data-ttu-id="c9d2d-136">Pour les raisons expliquées ci-dessus, les variables de diffusion ne fonctionnent pas avec .NET interactive.</span><span class="sxs-lookup"><span data-stu-id="c9d2d-136">For the reasons explained above, broadcast variables don't work with .NET Interactive.</span></span> <span data-ttu-id="c9d2d-137">Il est judicieux de parcourir [ce guide sur les variables de diffusion](broadcast-guide.md) pour mieux comprendre quelles sont les variables de diffusion et comment les utiliser.</span><span class="sxs-lookup"><span data-stu-id="c9d2d-137">It is a good idea to go through [this guide on broadcast variables](broadcast-guide.md) to get a deeper understanding of what broadcast variables are and how to use them.</span></span> <span data-ttu-id="c9d2d-138">La raison pour laquelle les variables de diffusion ne fonctionnent pas avec des scénarios interactifs est due à la conception de l’ajout par .NET interactive de chaque objet défini dans une cellule avec sa classe d’envoi de cellules, car n’est pas marqué comme sérialisable, échoue avec la même exception que celle qui est indiquée précédemment.</span><span class="sxs-lookup"><span data-stu-id="c9d2d-138">The reason broadcast variables don't work with interactive scenarios is because of .NET interactive's design of appending each object defined in a cell with it's cell submission class, which since is not marked serializable, fails with the same exception as shown previously.</span></span>
   <span data-ttu-id="c9d2d-139">Examinons un peu plus en détail l’exemple suivant :</span><span class="sxs-lookup"><span data-stu-id="c9d2d-139">Let's dive a little deeper with the following example:</span></span>

    ![Échec des variables de diffusion](./media/dotnet-interactive/broadcast-fails.png)

    <span data-ttu-id="c9d2d-141">Comme nous l’avons recommandé dans les sections précédentes, nous définissons à la fois l’UDF et l’objet auquel il fait référence (variable de diffusion dans ce cas) dans la même cellule, mais nous voyons toujours l' `SerializationException` erreur indiquant `Microsoft.Spark.Sql.Session` qu’il n’est pas marqué comme sérialisable.</span><span class="sxs-lookup"><span data-stu-id="c9d2d-141">As recommended in the previous sections, we define both the UDF and the object it is referencing (broadcast variable in this case) in the same cell, but we still see the `SerializationException` error complaining about `Microsoft.Spark.Sql.Session` not being marked as serializable.</span></span> <span data-ttu-id="c9d2d-142">Cela est dû au fait que lorsque le compilateur tente de sérialiser l’objet de variable de diffusion `bv` , il trouve son nom à ajouter à l' [`SparkSession`](https://github.com/dotnet/spark/blob/master/src/csharp/Microsoft.Spark/Sql/SparkSession.cs#L20) objet, `spark` dont il a besoin pour être marqué comme sérialisable.</span><span class="sxs-lookup"><span data-stu-id="c9d2d-142">This is because when the compiler tries to serialize the broadcast variable object `bv`, it finds its name to be appended with [`SparkSession`](https://github.com/dotnet/spark/blob/master/src/csharp/Microsoft.Spark/Sql/SparkSession.cs#L20) object `spark` which it requires to be marked as serializable.</span></span> <span data-ttu-id="c9d2d-143">Cela peut être démontré plus facilement en examinant l’assembly décompilé de cette soumission de cellule :</span><span class="sxs-lookup"><span data-stu-id="c9d2d-143">This can be demonstrated with more ease by taking a peek at the decompiled assembly of this cell submission:</span></span>

    ![Code assembleur décompilé](./media/dotnet-interactive/decompiledAssembly.png)

    <span data-ttu-id="c9d2d-145">Si nous markons la [`SparkSession`](https://github.com/dotnet/spark/blob/master/src/csharp/Microsoft.Spark/Sql/SparkSession.cs#L20) classe en tant que `[Serializable]` , nous pouvons faire fonctionner, mais ce n’est pas une solution idéale, car nous ne souhaitons pas donner à l’utilisateur la possibilité de sérialiser un objet SparkSession, car cela pourrait entraîner un comportement indésirable très étrange.</span><span class="sxs-lookup"><span data-stu-id="c9d2d-145">If we mark the [`SparkSession`](https://github.com/dotnet/spark/blob/master/src/csharp/Microsoft.Spark/Sql/SparkSession.cs#L20) class as `[Serializable]`, we can get this to work, but this is not an ideal solution as we don't want to give the user the ability to serialize a SparkSession object, as that could lead to some very weird undesirable behavior.</span></span> <span data-ttu-id="c9d2d-146">Il s’agit d’un problème connu que vous pouvez suivre [ici](https://github.com/dotnet/spark/issues/619) et qui sera résolu dans les futures versions.</span><span class="sxs-lookup"><span data-stu-id="c9d2d-146">This is a known issue and being tracked [here](https://github.com/dotnet/spark/issues/619) and will be resolved in future versions.</span></span>
