---
title: Programmation asynchrone en C#
description: Vue d’ensemble de la prise en charge du langage C# pour la programmation asynchrone avec Async, Await, Task et Task<T>
ms.date: 06/04/2020
ms.openlocfilehash: 853019c39880b1f4ef6536aed5841ecab53d7304
ms.sourcegitcommit: b1f4756120deaecb8b554477bb040620f69a4209
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 09/03/2020
ms.locfileid: "89414979"
---
# <a name="asynchronous-programming-with-async-and-await"></a><span data-ttu-id="04766-103">Programmation asynchrone avec Async et Await</span><span class="sxs-lookup"><span data-stu-id="04766-103">Asynchronous programming with async and await</span></span>

<span data-ttu-id="04766-104">Le [modèle de programmation asynchrone de tâche (TAP)](task-asynchronous-programming-model.md) fournit une abstraction sur le code asynchrone.</span><span class="sxs-lookup"><span data-stu-id="04766-104">The [Task asynchronous programming model (TAP)](task-asynchronous-programming-model.md) provides an abstraction over asynchronous code.</span></span> <span data-ttu-id="04766-105">Pour cela, vous écrivez votre code comme d’habitude, sous la forme d’une suite d’instructions.</span><span class="sxs-lookup"><span data-stu-id="04766-105">You write code as a sequence of statements, just like always.</span></span> <span data-ttu-id="04766-106">Vous pouvez lire ce code comme si chaque instruction se terminait avant que la suivante ne commence.</span><span class="sxs-lookup"><span data-stu-id="04766-106">You can read that code as though each statement completes before the next begins.</span></span> <span data-ttu-id="04766-107">Le compilateur effectue un certain nombre de transformations, car certaines de ces instructions peuvent commencer le travail et retourner un <xref:System.Threading.Tasks.Task> qui représente le travail en cours.</span><span class="sxs-lookup"><span data-stu-id="04766-107">The compiler performs a number of transformations because some of those statements may start work and return a <xref:System.Threading.Tasks.Task> that represents the ongoing work.</span></span>

<span data-ttu-id="04766-108">C’est en fait l’objectif de cette syntaxe : permettre au code d’être lu comme une suite d’instructions, mais d’être exécuté dans un ordre beaucoup plus complexe, en fonction de l’allocation des ressources externes et du moment auquel se terminent les tâches.</span><span class="sxs-lookup"><span data-stu-id="04766-108">That's the goal of this syntax: enable code that reads like a sequence of statements, but executes in a much more complicated order based on external resource allocation and when tasks complete.</span></span> <span data-ttu-id="04766-109">Cela revient à donner des instructions pour des processus qui comprennent des tâches asynchrones.</span><span class="sxs-lookup"><span data-stu-id="04766-109">It's analogous to how people give instructions for processes that include asynchronous tasks.</span></span> <span data-ttu-id="04766-110">Tout au long de cet article, vous allez utiliser un exemple d’instructions pour créer un petit-déjeuner afin de voir comment les mots clés et facilitent la création de `async` `await` code, qui comprend une série d’instructions asynchrones.</span><span class="sxs-lookup"><span data-stu-id="04766-110">Throughout this article, you'll use an example of instructions for making a breakfast to see how the `async` and `await` keywords make it easier to reason about code, that includes a series of asynchronous instructions.</span></span> <span data-ttu-id="04766-111">Pour expliquer comment préparer un petit-déjeuner, vous pourriez écrire des instructions telles que les suivantes :</span><span class="sxs-lookup"><span data-stu-id="04766-111">You'd write the instructions something like the following list to explain how to make a breakfast:</span></span>

1. <span data-ttu-id="04766-112">Verser le café dans une tasse.</span><span class="sxs-lookup"><span data-stu-id="04766-112">Pour a cup of coffee.</span></span>
1. <span data-ttu-id="04766-113">Faire chauffer la poêle, puis faire cuire deux œufs au plat.</span><span class="sxs-lookup"><span data-stu-id="04766-113">Heat up a pan, then fry two eggs.</span></span>
1. <span data-ttu-id="04766-114">Faire frire trois tranches de bacon.</span><span class="sxs-lookup"><span data-stu-id="04766-114">Fry three slices of bacon.</span></span>
1. <span data-ttu-id="04766-115">Faire toaster deux tranches de pain.</span><span class="sxs-lookup"><span data-stu-id="04766-115">Toast two pieces of bread.</span></span>
1. <span data-ttu-id="04766-116">Étaler le beurre et la confiture sur les toasts.</span><span class="sxs-lookup"><span data-stu-id="04766-116">Add butter and jam to the toast.</span></span>
1. <span data-ttu-id="04766-117">Verser du jus d’orange dans un verre.</span><span class="sxs-lookup"><span data-stu-id="04766-117">Pour a glass of orange juice.</span></span>

<span data-ttu-id="04766-118">Si vous avez l’habitude de cuisiner, vous savez que ces instructions doivent être exécutées de manière **asynchrone**.</span><span class="sxs-lookup"><span data-stu-id="04766-118">If you have experience with cooking, you'd execute those instructions **asynchronously**.</span></span> <span data-ttu-id="04766-119">En effet, vous commencez par faire chauffer la poêle pour les œufs, mais vous faites d’abord frire le bacon.</span><span class="sxs-lookup"><span data-stu-id="04766-119">You'd start warming the pan for eggs, then start the bacon.</span></span> <span data-ttu-id="04766-120">Ensuite, vous mettez les tranches de pain dans le grille-pain, puis vous cassez les œufs dans la poêle.</span><span class="sxs-lookup"><span data-stu-id="04766-120">You'd put the bread in the toaster, then start the eggs.</span></span> <span data-ttu-id="04766-121">À chaque étape du processus, vous démarrez une tâche, puis déplacez votre attention vers les tâches qui sont prêtes à être réalisées.</span><span class="sxs-lookup"><span data-stu-id="04766-121">At each step of the process, you'd start a task, then turn your attention to tasks that are ready for your attention.</span></span>

<span data-ttu-id="04766-122">La préparation du petit-déjeuner est un bon exemple de travail asynchrone mais non parallèle.</span><span class="sxs-lookup"><span data-stu-id="04766-122">Cooking breakfast is a good example of asynchronous work that isn't parallel.</span></span> <span data-ttu-id="04766-123">Une personne (ou un thread) peut gérer toutes ces tâches.</span><span class="sxs-lookup"><span data-stu-id="04766-123">One person (or thread) can handle all these tasks.</span></span> <span data-ttu-id="04766-124">Pour poursuivre l’analogie avec le petit-déjeuner, une personne peut préparer le petit-déjeuner de façon asynchrone en démarrant une tâche avant que la précédente ne soit terminée.</span><span class="sxs-lookup"><span data-stu-id="04766-124">Continuing the breakfast analogy, one person can make breakfast asynchronously by starting the next task before the first completes.</span></span> <span data-ttu-id="04766-125">En outre, la cuisson se poursuit, que vous la surveilliez ou non.</span><span class="sxs-lookup"><span data-stu-id="04766-125">The cooking progresses whether or not someone is watching it.</span></span> <span data-ttu-id="04766-126">Dès que vous commencez à faire chauffer la poêle pour les œufs, vous pouvez mettre le bacon à frire.</span><span class="sxs-lookup"><span data-stu-id="04766-126">As soon as you start warming the pan for the eggs, you can begin frying the bacon.</span></span> <span data-ttu-id="04766-127">Quand le bacon est en train de frire, vous pouvez mettre les tranches de pain dans le grille-pain.</span><span class="sxs-lookup"><span data-stu-id="04766-127">Once the bacon starts, you can put the bread into the toaster.</span></span>

<span data-ttu-id="04766-128">Pour un algorithme parallèle, vous auriez besoin de plusieurs cuisiniers (ou threads).</span><span class="sxs-lookup"><span data-stu-id="04766-128">For a parallel algorithm, you'd need multiple cooks (or threads).</span></span> <span data-ttu-id="04766-129">L’un d’eux s’occuperait des œufs, un autre du bacon, etc.</span><span class="sxs-lookup"><span data-stu-id="04766-129">One would make the eggs, one the bacon, and so on.</span></span> <span data-ttu-id="04766-130">Chacun d’eux serait concentré sur une seule tâche.</span><span class="sxs-lookup"><span data-stu-id="04766-130">Each one would be focused on just that one task.</span></span> <span data-ttu-id="04766-131">Chaque cuisinier (ou thread) serait bloqué de façon synchrone, car il devrait attendre que le bacon soit prêt à être retourné ou que le pain soit grillé.</span><span class="sxs-lookup"><span data-stu-id="04766-131">Each cook (or thread) would be blocked synchronously waiting for bacon to be ready to flip, or the toast to pop.</span></span>

<span data-ttu-id="04766-132">Écrivons maintenant ces instructions sous la forme d’instructions C# :</span><span class="sxs-lookup"><span data-stu-id="04766-132">Now, consider those same instructions written as C# statements:</span></span>

:::code language="csharp" source="snippets/index/AsyncBreakfast-starter/Program.cs" highlight="8-27":::

:::image type="content" source="media/synchronous-breakfast.png" alt-text="petit-déjeuner synchrone":::

<span data-ttu-id="04766-134">Le petit déjeuner préparé de façon synchrone a duré environ 30 minutes, car le total est la somme de chaque tâche individuelle.</span><span class="sxs-lookup"><span data-stu-id="04766-134">The synchronously prepared breakfast, took roughly 30 minutes because the total is the sum of each individual task.</span></span>

> [!NOTE]
> <span data-ttu-id="04766-135">Les `Coffee` classes,,, `Egg` `Bacon` `Toast` et `Juice` sont vides.</span><span class="sxs-lookup"><span data-stu-id="04766-135">The `Coffee`, `Egg`, `Bacon`, `Toast`, and `Juice` classes are empty.</span></span> <span data-ttu-id="04766-136">Il s’agit simplement de classes de marqueurs à des fins de démonstration, ne contiennent aucune propriété et n’a aucune autre fonction.</span><span class="sxs-lookup"><span data-stu-id="04766-136">They are simply marker classes for the purpose of demonstration, contain no properties, and serve no other purpose.</span></span>

<span data-ttu-id="04766-137">Les ordinateurs n’interprètent pas ces instructions de la même façon que les humains.</span><span class="sxs-lookup"><span data-stu-id="04766-137">Computers don't interpret those instructions the same way people do.</span></span> <span data-ttu-id="04766-138">L’ordinateur se bloque à chaque instruction jusqu’à ce que le travail soit terminé, avant de passer à l’instruction suivante.</span><span class="sxs-lookup"><span data-stu-id="04766-138">The computer will block on each statement until the work is complete before moving on to the next statement.</span></span> <span data-ttu-id="04766-139">Avec une telle manière de procéder, notre petit-déjeuner risque de ne pas être très satisfaisant.</span><span class="sxs-lookup"><span data-stu-id="04766-139">That creates an unsatisfying breakfast.</span></span> <span data-ttu-id="04766-140">En effet, chacune des tâches ne pourrait être démarrée qu’une fois la précédente terminée.</span><span class="sxs-lookup"><span data-stu-id="04766-140">The later tasks wouldn't be started until the earlier tasks had completed.</span></span> <span data-ttu-id="04766-141">De cette façon, la préparation du petit-déjeuner prendrait beaucoup plus de temps, et certains aliments refroidiraient avant d’être servis.</span><span class="sxs-lookup"><span data-stu-id="04766-141">It would take much longer to create the breakfast, and some items would have gotten cold before being served.</span></span>

<span data-ttu-id="04766-142">Si vous souhaitez que l’ordinateur exécute les instructions ci-dessus de façon asynchrone, vous devez écrire du code asynchrone.</span><span class="sxs-lookup"><span data-stu-id="04766-142">If you want the computer to execute the above instructions asynchronously, you must write asynchronous code.</span></span>

<span data-ttu-id="04766-143">De nos jours, ces remarques sont très importantes pour l’écriture de programmes.</span><span class="sxs-lookup"><span data-stu-id="04766-143">These concerns are important for the programs you write today.</span></span> <span data-ttu-id="04766-144">Lorsque vous écrivez des programmes clients, l’interface utilisateur doit être réactive aux entrées utilisateur.</span><span class="sxs-lookup"><span data-stu-id="04766-144">When you write client programs, you want the UI to be responsive to user input.</span></span> <span data-ttu-id="04766-145">Votre application ne doit pas donner l’impression que votre smartphone se bloque pour télécharger des données à partir du web.</span><span class="sxs-lookup"><span data-stu-id="04766-145">Your application shouldn't make a phone appear frozen while it's downloading data from the web.</span></span> <span data-ttu-id="04766-146">Lorsque vous écrivez des programmes de serveur, vous ne devez pas bloquer les threads.</span><span class="sxs-lookup"><span data-stu-id="04766-146">When you write server programs, you don't want threads blocked.</span></span> <span data-ttu-id="04766-147">En effet, ces threads peuvent servir à d’autres requêtes.</span><span class="sxs-lookup"><span data-stu-id="04766-147">Those threads could be serving other requests.</span></span> <span data-ttu-id="04766-148">Lorsque d’autres alternatives sont possibles, il est dommage d’utiliser du code synchrone, car celui-ci ne vous permet pas de réduire les frais des scale-out.</span><span class="sxs-lookup"><span data-stu-id="04766-148">Using synchronous code when asynchronous alternatives exist hurts your ability to scale out less expensively.</span></span> <span data-ttu-id="04766-149">Les threads bloqués ont un prix.</span><span class="sxs-lookup"><span data-stu-id="04766-149">You pay for those blocked threads.</span></span>

<span data-ttu-id="04766-150">Une application moderne efficace a besoin de code asynchrone.</span><span class="sxs-lookup"><span data-stu-id="04766-150">Successful modern applications require asynchronous code.</span></span> <span data-ttu-id="04766-151">Avant la prise en charge du langage, l’écriture de code asynchrone nécessitait des rappels, des événements de complétion ou d’autres méthodes qui masquaient l’objectif premier du code.</span><span class="sxs-lookup"><span data-stu-id="04766-151">Without language support, writing asynchronous code required callbacks, completion events, or other means that obscured the original intent of the code.</span></span> <span data-ttu-id="04766-152">L’avantage du code synchrone est qu’il s’agit d’actions pas à pas qui facilitent l’analyse et la compréhension.</span><span class="sxs-lookup"><span data-stu-id="04766-152">The advantage of the synchronous code is that it's step-by-step actions make it easy to scan and understand.</span></span> <span data-ttu-id="04766-153">Les modèles asynchrones traditionnels vous obligeaient à vous concentrer sur la nature asynchrone du code, et non sur ses actions fondamentales.</span><span class="sxs-lookup"><span data-stu-id="04766-153">Traditional asynchronous models forced you to focus on the asynchronous nature of the code, not on the fundamental actions of the code.</span></span>

## <a name="dont-block-await-instead"></a><span data-ttu-id="04766-154">Éviter les blocages avec Await</span><span class="sxs-lookup"><span data-stu-id="04766-154">Don't block, await instead</span></span>

<span data-ttu-id="04766-155">Le code précédent montre une pratique déconseillée : écrire du code synchrone pour effectuer des opérations asynchrones.</span><span class="sxs-lookup"><span data-stu-id="04766-155">The preceding code demonstrates a bad practice: constructing synchronous code to perform asynchronous operations.</span></span> <span data-ttu-id="04766-156">Comme nous l’avons vu, ce code bloque le thread, qui ne peut pas exécuter d’autres tâches.</span><span class="sxs-lookup"><span data-stu-id="04766-156">As written, this code blocks the thread executing it from doing any other work.</span></span> <span data-ttu-id="04766-157">Il ne sera pas interrompu tant que l’une des tâches est en cours d’exécution.</span><span class="sxs-lookup"><span data-stu-id="04766-157">It won't be interrupted while any of the tasks are in progress.</span></span> <span data-ttu-id="04766-158">Ce serait comme rester les yeux fixés sur le grille-pain après avoir mis le pain dedans.</span><span class="sxs-lookup"><span data-stu-id="04766-158">It would be as though you stared at the toaster after putting the bread in.</span></span> <span data-ttu-id="04766-159">Vous n’écouteriez personne tant que le pain ne serait pas ressorti du grille-pain.</span><span class="sxs-lookup"><span data-stu-id="04766-159">You'd ignore anyone talking to you until the toast popped.</span></span>

<span data-ttu-id="04766-160">Commençons par mettre à jour ce code pour que le thread ne se bloque pas pendant l’exécution des tâches.</span><span class="sxs-lookup"><span data-stu-id="04766-160">Let's start by updating this code so that the thread doesn't block while tasks are running.</span></span> <span data-ttu-id="04766-161">Le mot clé `await` permet de démarrer une tâche sans bloquer le thread, puis de poursuivre l’exécution une fois cette tâche terminée.</span><span class="sxs-lookup"><span data-stu-id="04766-161">The `await` keyword provides a non-blocking way to start a task, then continue execution when that task completes.</span></span> <span data-ttu-id="04766-162">La version asynchrone du code de préparation du petit-déjeuner ressemblerait à l’extrait de code suivant :</span><span class="sxs-lookup"><span data-stu-id="04766-162">A simple asynchronous version of the make a breakfast code would look like the following snippet:</span></span>

:::code language="csharp" source="snippets/index/AsyncBreakfast-V2/Program.cs" id="SnippetMain":::

> [!IMPORTANT]
> <span data-ttu-id="04766-163">Le temps total écoulé est à peu près identique à la version initiale de Synchonous.</span><span class="sxs-lookup"><span data-stu-id="04766-163">The total elapsed time is roughly the same as the initial synchonous version.</span></span> <span data-ttu-id="04766-164">Le code n’a pas encore pu tirer parti de certaines des fonctionnalités clés de la programmation asynchrone.</span><span class="sxs-lookup"><span data-stu-id="04766-164">The code has yet to take advantage of some of the key features of asynchronous programming.</span></span>

> [!TIP]
> <span data-ttu-id="04766-165">Les corps de méthode des `FryEggsAsync` , `FryBaconAsync` et `ToastBreadAsync` ont tous été mis à jour pour retourner `Task<Egg>` , `Task<Bacon>` et `Task<Toast>` respectivement.</span><span class="sxs-lookup"><span data-stu-id="04766-165">The method bodies of the `FryEggsAsync`, `FryBaconAsync`, and `ToastBreadAsync` have all been updated to return `Task<Egg>`, `Task<Bacon>`, and `Task<Toast>` respectively.</span></span> <span data-ttu-id="04766-166">Les méthodes sont renommées à partir de leur version d’origine pour inclure le suffixe « Async ».</span><span class="sxs-lookup"><span data-stu-id="04766-166">The methods are renamed from their original version to include the "Async" suffix.</span></span> <span data-ttu-id="04766-167">Leurs implémentations sont indiquées dans le cadre de la [version finale](#final-version) plus loin dans cet article.</span><span class="sxs-lookup"><span data-stu-id="04766-167">Their implementations are shown as part of the [final version](#final-version) later in this article.</span></span>

<span data-ttu-id="04766-168">Ce code ne se bloque pas pendant la cuisson des œufs ou du bacon.</span><span class="sxs-lookup"><span data-stu-id="04766-168">This code doesn't block while the eggs or the bacon are cooking.</span></span> <span data-ttu-id="04766-169">Cependant, il ne démarre pas d’autres tâches.</span><span class="sxs-lookup"><span data-stu-id="04766-169">This code won't start any other tasks though.</span></span> <span data-ttu-id="04766-170">Cela reviendrait, une nouvelle fois, à rester les yeux fixés sur le grille-pain en attendant que le pain ressorte.</span><span class="sxs-lookup"><span data-stu-id="04766-170">You'd still put the toast in the toaster and stare at it until it pops.</span></span> <span data-ttu-id="04766-171">Mais au moins, vous seriez en mesure de répondre à quelqu’un qui aurait besoin de votre attention.</span><span class="sxs-lookup"><span data-stu-id="04766-171">But at least, you'd respond to anyone that wanted your attention.</span></span> <span data-ttu-id="04766-172">Dans un restaurant qui doit gérer plusieurs commandes en même temps, le chef peut commencer un petit-déjeuner pendant qu’un autre est en cours de préparation.</span><span class="sxs-lookup"><span data-stu-id="04766-172">In a restaurant where multiple orders are placed, the cook could start another breakfast while the first is cooking.</span></span>

<span data-ttu-id="04766-173">Ici, le thread qui prépare le petit-déjeuner n’est pas bloqué en attendant qu’une tâche démarrée se termine.</span><span class="sxs-lookup"><span data-stu-id="04766-173">Now, the thread working on the breakfast isn't blocked while awaiting any started task that hasn't yet finished.</span></span> <span data-ttu-id="04766-174">Pour certaines applications, cette modification est la seule nécessaire.</span><span class="sxs-lookup"><span data-stu-id="04766-174">For some applications, this change is all that's needed.</span></span> <span data-ttu-id="04766-175">Ce simple changement permet à une application GUI de continuer à répondre à l’utilisateur.</span><span class="sxs-lookup"><span data-stu-id="04766-175">A GUI application still responds to the user with just this change.</span></span> <span data-ttu-id="04766-176">Toutefois, pour ce scénario, d’autres modifications sont nécessaires.</span><span class="sxs-lookup"><span data-stu-id="04766-176">However, for this scenario, you want more.</span></span> <span data-ttu-id="04766-177">Il n’est pas souhaitable que chaque tâche de composant soit exécutée de manière séquentielle.</span><span class="sxs-lookup"><span data-stu-id="04766-177">You don't want each of the component tasks to be executed sequentially.</span></span> <span data-ttu-id="04766-178">Il est préférable de démarrer chacune des tâches de composant avant d’attendre l’achèvement de la tâche précédente.</span><span class="sxs-lookup"><span data-stu-id="04766-178">It's better to start each of the component tasks before awaiting the previous task's completion.</span></span>

## <a name="start-tasks-concurrently"></a><span data-ttu-id="04766-179">Démarrer plusieurs tâches simultanément</span><span class="sxs-lookup"><span data-stu-id="04766-179">Start tasks concurrently</span></span>

<span data-ttu-id="04766-180">Dans de nombreux scénarios, il est nécessaire de démarrer plusieurs tâches immédiatement.</span><span class="sxs-lookup"><span data-stu-id="04766-180">In many scenarios, you want to start several independent tasks immediately.</span></span> <span data-ttu-id="04766-181">Ensuite, à la fin de chaque tâche, vous pouvez passer aux autres tâches qui sont prêtes.</span><span class="sxs-lookup"><span data-stu-id="04766-181">Then, as each task finishes, you can continue other work that's ready.</span></span> <span data-ttu-id="04766-182">C’est de cette façon que nous pouvons accélérer la préparation de notre petit-déjeuner.</span><span class="sxs-lookup"><span data-stu-id="04766-182">In the breakfast analogy, that's how you get breakfast done more quickly.</span></span> <span data-ttu-id="04766-183">Cela permet également de tout terminer en même temps, ou presque.</span><span class="sxs-lookup"><span data-stu-id="04766-183">You also get everything done close to the same time.</span></span> <span data-ttu-id="04766-184">Cette façon de procéder vous garantit que vous mangerez votre petit-déjeuner bien chaud.</span><span class="sxs-lookup"><span data-stu-id="04766-184">You'll get a hot breakfast.</span></span>

<span data-ttu-id="04766-185"><xref:System.Threading.Tasks.Task?displayProperty=nameWithType> et les types associés sont des classes que vous pouvez utiliser pour organiser les tâches en cours.</span><span class="sxs-lookup"><span data-stu-id="04766-185">The <xref:System.Threading.Tasks.Task?displayProperty=nameWithType> and related types are classes you can use to reason about tasks that are in progress.</span></span> <span data-ttu-id="04766-186">Cela vous permet d’écrire du code qui se rapproche davantage de la façon dont vous devez préparer un petit-déjeuner,</span><span class="sxs-lookup"><span data-stu-id="04766-186">That enables you to write code that more closely resembles the way you'd actually create breakfast.</span></span> <span data-ttu-id="04766-187">puisque vous commencez à faire cuire les œufs, à faire frire le bacon et à faire griller le pain simultanément.</span><span class="sxs-lookup"><span data-stu-id="04766-187">You'd start cooking the eggs, bacon, and toast at the same time.</span></span> <span data-ttu-id="04766-188">Puisque toutes ces tâches nécessitent une action, vous devez porter votre attention sur une tâche, démarrer l’action suivante, puis attendre qu’une autre tâche nécessite votre attention.</span><span class="sxs-lookup"><span data-stu-id="04766-188">As each requires action, you'd turn your attention to that task, take care of the next action, then await for something else that requires your attention.</span></span>

<span data-ttu-id="04766-189">Vous démarrez une tâche puis vous gardez l’objet <xref:System.Threading.Tasks.Task> qui représente le travail.</span><span class="sxs-lookup"><span data-stu-id="04766-189">You start a task and hold on to the <xref:System.Threading.Tasks.Task> object that represents the work.</span></span> <span data-ttu-id="04766-190">Vous devez attendre (`await`) chaque tâche avant d’utiliser ses résultats.</span><span class="sxs-lookup"><span data-stu-id="04766-190">You'll `await` each task before working with its result.</span></span>

<span data-ttu-id="04766-191">À présent, apportons ces modifications au code de notre petit-déjeuner.</span><span class="sxs-lookup"><span data-stu-id="04766-191">Let's make these changes to the breakfast code.</span></span> <span data-ttu-id="04766-192">La première étape consiste à stocker les tâches des opérations dès leur démarrage, plutôt que d’attendre la fin de leur exécution :</span><span class="sxs-lookup"><span data-stu-id="04766-192">The first step is to store the tasks for operations when they start, rather than awaiting them:</span></span>

```csharp
Coffee cup = PourCoffee();
Console.WriteLine("coffee is ready");

Task<Egg> eggsTask = FryEggsAsync(2);
Egg eggs = await eggsTask;
Console.WriteLine("eggs are ready");

Task<Bacon> baconTask = FryBaconAsync(3);
Bacon bacon = await baconTask;
Console.WriteLine("bacon is ready");

Task<Toast> toastTask = ToastBreadAsync(2);
Toast toast = await toastTask;
ApplyButter(toast);
ApplyJam(toast);
Console.WriteLine("toast is ready");

Juice oj = PourOJ();
Console.WriteLine("oj is ready");
Console.WriteLine("Breakfast is ready!");
```

<span data-ttu-id="04766-193">Ensuite, vous pouvez déplacer les instructions `await` pour le bacon et les œufs à la fin de la méthode, avant de servir le petit-déjeuner :</span><span class="sxs-lookup"><span data-stu-id="04766-193">Next, you can move the `await` statements for the bacon and eggs to the end of the method, before serving breakfast:</span></span>

```csharp
Coffee cup = PourCoffee();
Console.WriteLine("coffee is ready");

Task<Egg> eggsTask = FryEggsAsync(2);
Task<Bacon> baconTask = FryBaconAsync(3);
Task<Toast> toastTask = ToastBreadAsync(2);

Toast toast = await toastTask;
ApplyButter(toast);
ApplyJam(toast);
Console.WriteLine("toast is ready");
Juice oj = PourOJ();
Console.WriteLine("oj is ready");

Egg eggs = await eggsTask;
Console.WriteLine("eggs are ready");
Bacon bacon = await baconTask;
Console.WriteLine("bacon is ready");

Console.WriteLine("Breakfast is ready!");
```

:::image type="content" source="media/asynchronous-breakfast.png" alt-text="petit-déjeuner asynchrone":::

<span data-ttu-id="04766-195">Le petit déjeuner préparé de façon asynchrone a duré environ 20 minutes, car certaines tâches pouvaient s’exécuter simultanément.</span><span class="sxs-lookup"><span data-stu-id="04766-195">The asynchronously prepared breakfast took roughly 20 minutes, this is because some tasks were able to run concurrently.</span></span>

<span data-ttu-id="04766-196">Le code précédent est plus efficace.</span><span class="sxs-lookup"><span data-stu-id="04766-196">The preceding code works better.</span></span> <span data-ttu-id="04766-197">Vous y démarrez toutes les tâches asynchrones en même temps.</span><span class="sxs-lookup"><span data-stu-id="04766-197">You start all the asynchronous tasks at once.</span></span> <span data-ttu-id="04766-198">Vous n’attendez la fin d’une tâche que si vous avez besoin des résultats.</span><span class="sxs-lookup"><span data-stu-id="04766-198">You await each task only when you need the results.</span></span> <span data-ttu-id="04766-199">Le code précédent est semblable au code des applications web qui envoient des requêtes à différents microservices, puis qui combinent les résultats au sein d’une même page.</span><span class="sxs-lookup"><span data-stu-id="04766-199">The preceding code may be similar to code in a web application that makes requests of different microservices, then combines the results into a single page.</span></span> <span data-ttu-id="04766-200">Vous allez exécuter toutes les requêtes en même temps, puis vous allez attendre (`await`) toutes ces tâches pour composer la page web.</span><span class="sxs-lookup"><span data-stu-id="04766-200">You'll make all the requests immediately, then `await` all those tasks and compose the web page.</span></span>

## <a name="composition-with-tasks"></a><span data-ttu-id="04766-201">Composition de tâches</span><span class="sxs-lookup"><span data-stu-id="04766-201">Composition with tasks</span></span>

 <span data-ttu-id="04766-202">Tout est prêt en même temps pour votre petit-déjeuner, sauf les toasts.</span><span class="sxs-lookup"><span data-stu-id="04766-202">You have everything ready for breakfast at the same time except the toast.</span></span> <span data-ttu-id="04766-203">La préparation des toasts correspond à la composition d’une opération asynchrone (faire griller le pain) et d’opérations synchrones (ajouter du beurre et de la confiture).</span><span class="sxs-lookup"><span data-stu-id="04766-203">Making the toast is the composition of an asynchronous operation (toasting the bread), and synchronous operations (adding the butter and the jam).</span></span> <span data-ttu-id="04766-204">Le code ci-dessous illustre un concept important :</span><span class="sxs-lookup"><span data-stu-id="04766-204">Updating this code illustrates an important concept:</span></span>

> [!IMPORTANT]
> <span data-ttu-id="04766-205">La composition d’une opération asynchrone et d’une tâche synchrone constitue une opération asynchrone.</span><span class="sxs-lookup"><span data-stu-id="04766-205">The composition of an asynchronous operation followed by synchronous work is an asynchronous operation.</span></span> <span data-ttu-id="04766-206">Autrement dit, si une partie d’une opération est asynchrone, cela rend asynchrone l’intégralité de l’opération.</span><span class="sxs-lookup"><span data-stu-id="04766-206">Stated another way, if any portion of an operation is asynchronous, the entire operation is asynchronous.</span></span>

<span data-ttu-id="04766-207">Le code précédent montre que vous pouvez utiliser les objets <xref:System.Threading.Tasks.Task> ou <xref:System.Threading.Tasks.Task%601> pour attendre les tâches en cours d’exécution.</span><span class="sxs-lookup"><span data-stu-id="04766-207">The preceding code showed you that you can use <xref:System.Threading.Tasks.Task> or <xref:System.Threading.Tasks.Task%601> objects to hold running tasks.</span></span> <span data-ttu-id="04766-208">Vous attendez (`await`) la fin de chaque tâche avant d’utiliser ses résultats.</span><span class="sxs-lookup"><span data-stu-id="04766-208">You `await` each task before using its result.</span></span> <span data-ttu-id="04766-209">L’étape suivante consiste à créer des méthodes qui représentent la combinaison d’autres tâches.</span><span class="sxs-lookup"><span data-stu-id="04766-209">The next step is to create methods that represent the combination of other work.</span></span> <span data-ttu-id="04766-210">Avant de servir le petit-déjeuner, vous devez attendre la fin de la tâche qui correspond à l’action de faire griller le pain, avant d’ajouter le beurre et la confiture.</span><span class="sxs-lookup"><span data-stu-id="04766-210">Before serving breakfast, you want to await the task that represents toasting the bread before adding butter and jam.</span></span> <span data-ttu-id="04766-211">Vous pouvez représenter cette tâche à l’aide du code suivant :</span><span class="sxs-lookup"><span data-stu-id="04766-211">You can represent that work with the following code:</span></span>

:::code language="csharp" source="snippets/index/AsyncBreakfast-V3/Program.cs" id="SnippetComposeToastTask":::

<span data-ttu-id="04766-212">La signature de la méthode précédente comprend le modificateur `async`.</span><span class="sxs-lookup"><span data-stu-id="04766-212">The preceding method has the `async` modifier in its signature.</span></span> <span data-ttu-id="04766-213">Cela signale au compilateur que cette méthode contient une instruction `await`. Elle contient des opérations asynchrones.</span><span class="sxs-lookup"><span data-stu-id="04766-213">That signals to the compiler that this method contains an `await` statement; it contains asynchronous operations.</span></span> <span data-ttu-id="04766-214">Cette méthode représente la tâche qui consiste à faire griller le pain, puis à ajouter le beurre et la confiture.</span><span class="sxs-lookup"><span data-stu-id="04766-214">This method represents the task that toasts the bread, then adds butter and jam.</span></span> <span data-ttu-id="04766-215">Cette méthode retourne un <xref:System.Threading.Tasks.Task%601> qui représente la composition de ces trois opérations.</span><span class="sxs-lookup"><span data-stu-id="04766-215">This method returns a <xref:System.Threading.Tasks.Task%601> that represents the composition of those three operations.</span></span> <span data-ttu-id="04766-216">Le bloc de code principal devient alors :</span><span class="sxs-lookup"><span data-stu-id="04766-216">The main block of code now becomes:</span></span>

:::code language="csharp" source="snippets/index/AsyncBreakfast-V3/Program.cs" id="SnippetMain":::

<span data-ttu-id="04766-217">La modification précédente montre une technique importante pour l’utilisation du code asynchrone.</span><span class="sxs-lookup"><span data-stu-id="04766-217">The previous change illustrated an important technique for working with asynchronous code.</span></span> <span data-ttu-id="04766-218">Pour composer des tâches, vous devez séparer les opérations dans une nouvelle méthode qui retourne une tâche.</span><span class="sxs-lookup"><span data-stu-id="04766-218">You compose tasks by separating the operations into a new method that returns a task.</span></span> <span data-ttu-id="04766-219">Vous pouvez choisir dans quels cas attendre les tâches.</span><span class="sxs-lookup"><span data-stu-id="04766-219">You can choose when to await that task.</span></span> <span data-ttu-id="04766-220">Vous pouvez démarrer d’autres tâches simultanément.</span><span class="sxs-lookup"><span data-stu-id="04766-220">You can start other tasks concurrently.</span></span>

## <a name="await-tasks-efficiently"></a><span data-ttu-id="04766-221">Attendre efficacement la fin des tâches</span><span class="sxs-lookup"><span data-stu-id="04766-221">Await tasks efficiently</span></span>

<span data-ttu-id="04766-222">La série d’instructions `await` à la fin du code précédent peut être améliorée à l’aide des méthodes de la classe `Task`.</span><span class="sxs-lookup"><span data-stu-id="04766-222">The series of `await` statements at the end of the preceding code can be improved by using methods of the `Task` class.</span></span> <span data-ttu-id="04766-223">L’une de ces API est <xref:System.Threading.Tasks.Task.WhenAll%2A>, qui retourne un <xref:System.Threading.Tasks.Task> se terminant lorsque toutes les tâches de sa liste d’arguments sont terminées, comme indiqué dans le code suivant :</span><span class="sxs-lookup"><span data-stu-id="04766-223">One of those APIs is <xref:System.Threading.Tasks.Task.WhenAll%2A>, which returns a <xref:System.Threading.Tasks.Task> that completes when all the tasks in its argument list have completed, as shown in the following code:</span></span>

```csharp
await Task.WhenAll(eggsTask, baconTask, toastTask);
Console.WriteLine("eggs are ready");
Console.WriteLine("bacon is ready");
Console.WriteLine("toast is ready");
Console.WriteLine("Breakfast is ready!");
```

<span data-ttu-id="04766-224">Une autre option consiste à utiliser <xref:System.Threading.Tasks.Task.WhenAny%2A>, qui retourne un `Task<Task>` se terminant lorsque l’un de ses arguments se termine.</span><span class="sxs-lookup"><span data-stu-id="04766-224">Another option is to use <xref:System.Threading.Tasks.Task.WhenAny%2A>, which returns a `Task<Task>` that completes when any of its arguments completes.</span></span> <span data-ttu-id="04766-225">Vous pouvez attendre la tâche retournée, tout en sachant qu’elle est déjà terminée.</span><span class="sxs-lookup"><span data-stu-id="04766-225">You can await the returned task, knowing that it has already finished.</span></span> <span data-ttu-id="04766-226">Le code suivant montre comment utiliser <xref:System.Threading.Tasks.Task.WhenAny%2A> pour attendre la fin de la première tâche, puis traiter ses résultats.</span><span class="sxs-lookup"><span data-stu-id="04766-226">The following code shows how you could use <xref:System.Threading.Tasks.Task.WhenAny%2A> to await the first task to finish and then process its result.</span></span> <span data-ttu-id="04766-227">Après avoir traité les résultats de la tâche terminée, vous pouvez la supprimer de la liste des tâches passée à `WhenAny`.</span><span class="sxs-lookup"><span data-stu-id="04766-227">After processing the result from the completed task, you remove that completed task from the list of tasks passed to `WhenAny`.</span></span>

```csharp
var breakfastTasks = new List<Task> { eggsTask, baconTask, toastTask };
while (breakfastTasks.Count > 0)
{
    Task finishedTask = await Task.WhenAny(breakfastTasks);
    if (finishedTask == eggsTask)
    {
        Console.WriteLine("eggs are ready");
    }
    else if (finishedTask == baconTask)
    {
        Console.WriteLine("bacon is ready");
    }
    else if (finishedTask == toastTask)
    {
        Console.WriteLine("toast is ready");
    }
    breakfastTasks.Remove(finishedTask);
}
```

<span data-ttu-id="04766-228">Après toutes ces modifications, la version finale du code ressemble à ceci : <a id="final-version"></a></span><span class="sxs-lookup"><span data-stu-id="04766-228">After all those changes, the final version of the code looks like this: <a id="final-version"></a></span></span>
:::code language="csharp" source="snippets/index/AsyncBreakfast-final/Program.cs" highlight="9-40":::

:::image type="content" source="media/whenany-async-breakfast.png" alt-text="quand tout petit déjeuner asynchrone":::

<span data-ttu-id="04766-230">La version finale du petit-déjeuner préparé de façon asynchrone a duré environ 15 minutes. cela est dû au fait que certaines tâches pouvaient s’exécuter simultanément et que le code était en mesure de surveiller plusieurs tâches à la fois et d’agir uniquement lorsque cela était nécessaire.</span><span class="sxs-lookup"><span data-stu-id="04766-230">The final version of the asynchronously prepared breakfast took roughly 15 minutes, this is because some tasks were able to run concurrently, and the code was able to monitor multiple tasks at once and only take action when it was needed.</span></span>

<span data-ttu-id="04766-231">Le code final est asynchrone.</span><span class="sxs-lookup"><span data-stu-id="04766-231">This final code is asynchronous.</span></span> <span data-ttu-id="04766-232">Il reflète plus précisément la façon dont nous préparons habituellement le petit-déjeuner.</span><span class="sxs-lookup"><span data-stu-id="04766-232">It more accurately reflects how a person would cook a breakfast.</span></span> <span data-ttu-id="04766-233">Comparez le code précédent au premier exemple de code de cet article.</span><span class="sxs-lookup"><span data-stu-id="04766-233">Compare the preceding code with the first code sample in this article.</span></span> <span data-ttu-id="04766-234">Les actions de base sont toujours claires lorsque nous lisons le code.</span><span class="sxs-lookup"><span data-stu-id="04766-234">The core actions are still clear from reading the code.</span></span> <span data-ttu-id="04766-235">Ce code est tout aussi lisible que les instructions de préparation du petit-déjeuner au début de cet article.</span><span class="sxs-lookup"><span data-stu-id="04766-235">You can read this code the same way you'd read those instructions for making a breakfast at the beginning of this article.</span></span> <span data-ttu-id="04766-236">Les fonctionnalités de langage pour `async` et `await` traduisent ce que chaque personne fait lorsqu’elle suit des instructions : démarrer les tâches dès que possible et ne pas attendre qu’une tâche soit terminée avant de passer à la suivante.</span><span class="sxs-lookup"><span data-stu-id="04766-236">The language features for `async` and `await` provide the translation every person makes to follow those written instructions: start tasks as you can and don't block waiting for tasks to complete.</span></span>

## <a name="next-steps"></a><span data-ttu-id="04766-237">Étapes suivantes</span><span class="sxs-lookup"><span data-stu-id="04766-237">Next steps</span></span>

> [!div class="nextstepaction"]
> [<span data-ttu-id="04766-238">En savoir plus sur le modèle de programmation asynchrone de tâche</span><span class="sxs-lookup"><span data-stu-id="04766-238">Learn about the task asynchronous programming model</span></span>](task-asynchronous-programming-model.md)
