---
title: Accès asynchrone aux fichiers (C#)
description: Découvrez comment utiliser la fonctionnalité Async pour accéder aux fichiers en C#. Vous pouvez appeler des méthodes asynchrones sans utiliser de rappels ni fractionner votre code entre les méthodes.
ms.date: 08/19/2020
ms.assetid: bb018fea-5313-4c80-ab3f-7c24b2145bd9
ms.openlocfilehash: 9a8db6004e8fff2cb39f0c350b403b56ea619e54
ms.sourcegitcommit: 9c45035b781caebc63ec8ecf912dc83fb6723b1f
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/25/2020
ms.locfileid: "88812040"
---
# <a name="asynchronous-file-access-c"></a><span data-ttu-id="29efb-104">Accès asynchrone aux fichiers (C#)</span><span class="sxs-lookup"><span data-stu-id="29efb-104">Asynchronous file access (C#)</span></span>

<span data-ttu-id="29efb-105">Vous pouvez utiliser la fonctionnalité Async pour accéder à des fichiers.</span><span class="sxs-lookup"><span data-stu-id="29efb-105">You can use the async feature to access files.</span></span> <span data-ttu-id="29efb-106">La fonctionnalité async vous permet d’appeler des méthodes asynchrones sans utiliser de rappels ni fractionner votre code entre plusieurs méthodes ou expressions lambda.</span><span class="sxs-lookup"><span data-stu-id="29efb-106">By using the async feature, you can call into asynchronous methods without using callbacks or splitting your code across multiple methods or lambda expressions.</span></span> <span data-ttu-id="29efb-107">Pour rendre le code synchrone asynchrone, il vous suffit d’appeler une méthode asynchrone au lieu d’une méthode synchrone, puis d’ajouter quelques mots clés au code.</span><span class="sxs-lookup"><span data-stu-id="29efb-107">To make synchronous code asynchronous, you just call an asynchronous method instead of a synchronous method and add a few keywords to the code.</span></span>

<span data-ttu-id="29efb-108">Vous pouvez considérer les raisons suivantes pour ajouter de l'asynchrone aux appels d'accès aux fichiers :</span><span class="sxs-lookup"><span data-stu-id="29efb-108">You might consider the following reasons for adding asynchrony to file access calls:</span></span>

> [!div class="checklist"]
>
> - <span data-ttu-id="29efb-109">L'asynchronisme rend les applications d'interface utilisateur plus réactives parce que le thread d'interface utilisateur qui lance l'exécution peut effectuer d'autres tâches.</span><span class="sxs-lookup"><span data-stu-id="29efb-109">Asynchrony makes UI applications more responsive because the UI thread that launches the operation can perform other work.</span></span> <span data-ttu-id="29efb-110">Si le thread d’interface utilisateur doit exécuter du code qui prend du temps (par exemple, plus de 50 millisecondes), l’interface utilisateur peut figer jusqu’à ce que l’E/S soit terminée et que le thread d’interface utilisateur puisse traiter à nouveau des entrées au clavier et à la souris et d’autres événements.</span><span class="sxs-lookup"><span data-stu-id="29efb-110">If the UI thread must execute code that takes a long time (for example, more than 50 milliseconds), the UI may freeze until the I/O is complete and the UI thread can again process keyboard and mouse input and other events.</span></span>
> - <span data-ttu-id="29efb-111">L'asynchronisme améliore l'extensibilité d'ASP.NET et d'autres applications serveur en réduisant le besoin de threads.</span><span class="sxs-lookup"><span data-stu-id="29efb-111">Asynchrony improves the scalability of ASP.NET and other server-based applications by reducing the need for threads.</span></span> <span data-ttu-id="29efb-112">Si l'application utilise un thread dédié par réponse et que mille demandes sont traitées simultanément, mille threads sont nécessaires.</span><span class="sxs-lookup"><span data-stu-id="29efb-112">If the application uses a dedicated thread per response and a thousand requests are being handled simultaneously, a thousand threads are needed.</span></span> <span data-ttu-id="29efb-113">Les opérations asynchrones n’ont souvent pas besoin d’utiliser un thread pendant l’attente.</span><span class="sxs-lookup"><span data-stu-id="29efb-113">Asynchronous operations often don't need to use a thread during the wait.</span></span> <span data-ttu-id="29efb-114">Elles utilisent le thread de terminaison d’E/S existant brièvement à la fin.</span><span class="sxs-lookup"><span data-stu-id="29efb-114">They use the existing I/O completion thread briefly at the end.</span></span>
> - <span data-ttu-id="29efb-115">La latence d'une opération d'accès à un fichier peut être très basse sous les conditions actuelles, mais la latence peut considérablement augmenter à l'avenir.</span><span class="sxs-lookup"><span data-stu-id="29efb-115">The latency of a file access operation might be very low under current conditions, but the latency may greatly increase in the future.</span></span> <span data-ttu-id="29efb-116">Par exemple, un fichier peut être déplacé vers un serveur qui se trouve à travers le monde.</span><span class="sxs-lookup"><span data-stu-id="29efb-116">For example, a file may be moved to a server that's across the world.</span></span>
> - <span data-ttu-id="29efb-117">La charge mémoire supplémentaire pour l'utilisation de la fonctionnalité Async est faible.</span><span class="sxs-lookup"><span data-stu-id="29efb-117">The added overhead of using the Async feature is small.</span></span>
> - <span data-ttu-id="29efb-118">Les tâches asynchrones peuvent facilement être exécutées en parallèle.</span><span class="sxs-lookup"><span data-stu-id="29efb-118">Asynchronous tasks can easily be run in parallel.</span></span>

## <a name="use-appropriate-classes"></a><span data-ttu-id="29efb-119">Utiliser les classes appropriées</span><span class="sxs-lookup"><span data-stu-id="29efb-119">Use appropriate classes</span></span>

<span data-ttu-id="29efb-120">Les exemples simples de cette rubrique illustrent <xref:System.IO.File.WriteAllTextAsync%2A?displayProperty=nameWithType> et <xref:System.IO.File.ReadAllTextAsync%2A?displayProperty=nameWithType> .</span><span class="sxs-lookup"><span data-stu-id="29efb-120">The simple examples in this topic demonstrate <xref:System.IO.File.WriteAllTextAsync%2A?displayProperty=nameWithType> and <xref:System.IO.File.ReadAllTextAsync%2A?displayProperty=nameWithType>.</span></span> <span data-ttu-id="29efb-121">Pour un contrôle fini sur les opérations d’e/s de fichier, utilisez la <xref:System.IO.FileStream> classe, qui a une option qui provoque l’exécution d’e/s asynchrones au niveau du système d’exploitation.</span><span class="sxs-lookup"><span data-stu-id="29efb-121">For finite control over the file I/O operations, use the <xref:System.IO.FileStream> class, which has an option that causes asynchronous I/O to occur at the operating system level.</span></span> <span data-ttu-id="29efb-122">En utilisant cette option, vous pouvez éviter de bloquer un thread de pool de threads dans de nombreux cas.</span><span class="sxs-lookup"><span data-stu-id="29efb-122">By using this option, you can avoid blocking a thread pool thread in many cases.</span></span> <span data-ttu-id="29efb-123">Pour l’activer, spécifiez l’argument `useAsync=true` ou `options=FileOptions.Asynchronous` dans l’appel de constructeur.</span><span class="sxs-lookup"><span data-stu-id="29efb-123">To enable this option, you specify the `useAsync=true` or `options=FileOptions.Asynchronous` argument in the constructor call.</span></span>

<span data-ttu-id="29efb-124">Vous ne pouvez pas utiliser cette option avec <xref:System.IO.StreamReader> et <xref:System.IO.StreamWriter> si vous les ouvrez directement en spécifiant un chemin d’accès de fichier.</span><span class="sxs-lookup"><span data-stu-id="29efb-124">You can't use this option with <xref:System.IO.StreamReader> and <xref:System.IO.StreamWriter> if you open them directly by specifying a file path.</span></span> <span data-ttu-id="29efb-125">Toutefois, vous pouvez utiliser cette option si vous leur fournissez un <xref:System.IO.Stream> ouvert par la classe <xref:System.IO.FileStream>.</span><span class="sxs-lookup"><span data-stu-id="29efb-125">However, you can use this option if you provide them a <xref:System.IO.Stream> that the <xref:System.IO.FileStream> class opened.</span></span> <span data-ttu-id="29efb-126">Les appels asynchrones sont plus rapides dans les applications d’interface utilisateur même si un thread de pool de threads est bloqué, car le thread d’interface utilisateur n’est pas bloqué pendant l’attente.</span><span class="sxs-lookup"><span data-stu-id="29efb-126">Asynchronous calls are faster in UI apps even if a thread pool thread is blocked, because the UI thread isn't blocked during the wait.</span></span>

## <a name="write-text"></a><span data-ttu-id="29efb-127">Écrire du texte</span><span class="sxs-lookup"><span data-stu-id="29efb-127">Write text</span></span>

<span data-ttu-id="29efb-128">Les exemples suivants écrivent du texte dans un fichier.</span><span class="sxs-lookup"><span data-stu-id="29efb-128">The following examples write text to a file.</span></span> <span data-ttu-id="29efb-129">À chaque instruction await, la méthode s'arrête immédiatement.</span><span class="sxs-lookup"><span data-stu-id="29efb-129">At each await statement, the method immediately exits.</span></span> <span data-ttu-id="29efb-130">Quand l’E/S de fichier est terminée, la méthode reprend à l’instruction qui suit l’instruction await.</span><span class="sxs-lookup"><span data-stu-id="29efb-130">When the file I/O is complete, the method resumes at the statement that follows the await statement.</span></span> <span data-ttu-id="29efb-131">Le modificateur Async est dans la définition des méthodes qui utilisent l’instruction await.</span><span class="sxs-lookup"><span data-stu-id="29efb-131">The async modifier is in the definition of methods that use the await statement.</span></span>

### <a name="simple-example"></a><span data-ttu-id="29efb-132">Exemple simple</span><span class="sxs-lookup"><span data-stu-id="29efb-132">Simple example</span></span>

:::code language="csharp" source="snippets/file-access/Program.cs" id="SimpleWrite":::

### <a name="finite-control-example"></a><span data-ttu-id="29efb-133">Exemple de contrôle fini</span><span class="sxs-lookup"><span data-stu-id="29efb-133">Finite control example</span></span>

:::code language="csharp" source="snippets/file-access/Program.cs" id="WriteText":::

<span data-ttu-id="29efb-134">L’exemple d’origine comprend l’instruction `await sourceStream.WriteAsync(encodedText, 0, encodedText.Length);`, qui est une contraction des deux instructions suivantes :</span><span class="sxs-lookup"><span data-stu-id="29efb-134">The original example has the statement `await sourceStream.WriteAsync(encodedText, 0, encodedText.Length);`, which is a contraction of the following two statements:</span></span>

```csharp
Task theTask = sourceStream.WriteAsync(encodedText, 0, encodedText.Length);
await theTask;
```

<span data-ttu-id="29efb-135">La première instruction retourne une tâche et provoque le début du traitement du fichier.</span><span class="sxs-lookup"><span data-stu-id="29efb-135">The first statement returns a task and causes file processing to start.</span></span> <span data-ttu-id="29efb-136">La deuxième instruction avec await provoque la fin immédiate de la méthode et retourne une tâche différente.</span><span class="sxs-lookup"><span data-stu-id="29efb-136">The second statement with the await causes the method to immediately exit and return a different task.</span></span> <span data-ttu-id="29efb-137">Quand le traitement du fichier se termine plus loin, l’exécution retourne à l’instruction qui suit l’attente.</span><span class="sxs-lookup"><span data-stu-id="29efb-137">When the file processing later completes, execution returns to the statement that follows the await.</span></span>

## <a name="read-text"></a><span data-ttu-id="29efb-138">Lire le texte</span><span class="sxs-lookup"><span data-stu-id="29efb-138">Read text</span></span>

<span data-ttu-id="29efb-139">Les exemples suivants lisent du texte à partir d’un fichier.</span><span class="sxs-lookup"><span data-stu-id="29efb-139">The following examples read text from a file.</span></span>

### <a name="simple-example"></a><span data-ttu-id="29efb-140">Exemple simple</span><span class="sxs-lookup"><span data-stu-id="29efb-140">Simple example</span></span>

:::code language="csharp" source="snippets/file-access/Program.cs" id="SimpleRead":::

### <a name="finite-control-example"></a><span data-ttu-id="29efb-141">Exemple de contrôle fini</span><span class="sxs-lookup"><span data-stu-id="29efb-141">Finite control example</span></span>

<span data-ttu-id="29efb-142">Le texte est mis en mémoire tampon et, dans cet exemple, est placé dans un <xref:System.Text.StringBuilder>.</span><span class="sxs-lookup"><span data-stu-id="29efb-142">The text is buffered and, in this case, placed into a <xref:System.Text.StringBuilder>.</span></span> <span data-ttu-id="29efb-143">Contrairement à l’exemple précédent, l’évaluation de l’instruction await génère une valeur.</span><span class="sxs-lookup"><span data-stu-id="29efb-143">Unlike in the previous example, the evaluation of the await produces a value.</span></span> <span data-ttu-id="29efb-144">La <xref:System.IO.Stream.ReadAsync%2A> méthode retourne un <xref:System.Threading.Tasks.Task> \<<xref:System.Int32>>, donc l’évaluation de l’expression await produit une `Int32` valeur `numRead` une fois l’opération terminée.</span><span class="sxs-lookup"><span data-stu-id="29efb-144">The <xref:System.IO.Stream.ReadAsync%2A> method returns a <xref:System.Threading.Tasks.Task>\<<xref:System.Int32>>, so the evaluation of the await produces an `Int32` value `numRead` after the operation completes.</span></span> <span data-ttu-id="29efb-145">Pour plus d’informations, consultez [Types de retour Async (C#)](async-return-types.md).</span><span class="sxs-lookup"><span data-stu-id="29efb-145">For more information, see [Async Return Types (C#)](async-return-types.md).</span></span>

:::code language="csharp" source="snippets/file-access/Program.cs" id="ReadText":::

## <a name="parallel-asynchronous-io"></a><span data-ttu-id="29efb-146">E/s asynchrones parallèles</span><span class="sxs-lookup"><span data-stu-id="29efb-146">Parallel asynchronous I/O</span></span>

<span data-ttu-id="29efb-147">Les exemples suivants illustrent le traitement en parallèle en écrivant 10 fichiers texte.</span><span class="sxs-lookup"><span data-stu-id="29efb-147">The following examples demonstrate parallel processing by writing 10 text files.</span></span>

### <a name="simple-example"></a><span data-ttu-id="29efb-148">Exemple simple</span><span class="sxs-lookup"><span data-stu-id="29efb-148">Simple example</span></span>

:::code language="csharp" source="snippets/file-access/Program.cs" id="SimpleParallelWrite":::

### <a name="finite-control-example"></a><span data-ttu-id="29efb-149">Exemple de contrôle fini</span><span class="sxs-lookup"><span data-stu-id="29efb-149">Finite control example</span></span>

<span data-ttu-id="29efb-150">Pour chaque fichier, la méthode <xref:System.IO.Stream.WriteAsync%2A> retourne une tâche qui est ensuite ajoutée à une liste des tâches.</span><span class="sxs-lookup"><span data-stu-id="29efb-150">For each file, the <xref:System.IO.Stream.WriteAsync%2A> method returns a task that is then added to a list of tasks.</span></span> <span data-ttu-id="29efb-151">L’instruction `await Task.WhenAll(tasks);` quitte la méthode et reprend dans cette dernière quand le traitement du fichier est terminé pour toutes les tâches.</span><span class="sxs-lookup"><span data-stu-id="29efb-151">The `await Task.WhenAll(tasks);` statement exits the method and resumes within the method when file processing is complete for all of the tasks.</span></span>

<span data-ttu-id="29efb-152">L’exemple ferme toutes les instances de <xref:System.IO.FileStream> dans un bloc `finally` une fois les tâches effectuées.</span><span class="sxs-lookup"><span data-stu-id="29efb-152">The example closes all <xref:System.IO.FileStream> instances in a `finally` block after the tasks are complete.</span></span> <span data-ttu-id="29efb-153">Si chaque `FileStream` était plutôt créé dans une instruction `using`, `FileStream` pourrait être libéré avant que la tâche ne soit terminée.</span><span class="sxs-lookup"><span data-stu-id="29efb-153">If each `FileStream` was instead created in a `using` statement, the `FileStream` might be disposed of before the task was complete.</span></span>

<span data-ttu-id="29efb-154">Toute amélioration des performances est presque entièrement issue du traitement parallèle et non du traitement asynchrone.</span><span class="sxs-lookup"><span data-stu-id="29efb-154">Any performance boost is almost entirely from the parallel processing and not the asynchronous processing.</span></span> <span data-ttu-id="29efb-155">L’asynchronie présente l’avantage de ne pas bloquer plusieurs threads et de ne pas bloquer le thread d’interface utilisateur.</span><span class="sxs-lookup"><span data-stu-id="29efb-155">The advantages of asynchrony are that it doesn't tie up multiple threads, and that it doesn't tie up the user interface thread.</span></span>

:::code language="csharp" source="snippets/file-access/Program.cs" id="ParallelWriteText":::

<span data-ttu-id="29efb-156">Quand vous utilisez les méthodes <xref:System.IO.Stream.WriteAsync%2A> et <xref:System.IO.Stream.ReadAsync%2A>, vous pouvez spécifier un <xref:System.Threading.CancellationToken>, qui vous permet d’annuler l’opération en cours de route.</span><span class="sxs-lookup"><span data-stu-id="29efb-156">When using the <xref:System.IO.Stream.WriteAsync%2A> and <xref:System.IO.Stream.ReadAsync%2A> methods, you can specify a <xref:System.Threading.CancellationToken>, which you can use to cancel the operation mid-stream.</span></span> <span data-ttu-id="29efb-157">Pour plus d’informations, consultez [Annulation dans les threads managés](../../../../standard/threading/cancellation-in-managed-threads.md).</span><span class="sxs-lookup"><span data-stu-id="29efb-157">For more information, see [Cancellation in managed threads](../../../../standard/threading/cancellation-in-managed-threads.md).</span></span>

## <a name="see-also"></a><span data-ttu-id="29efb-158">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="29efb-158">See also</span></span>

- [<span data-ttu-id="29efb-159">Programmation asynchrone avec Async et await (C#)</span><span class="sxs-lookup"><span data-stu-id="29efb-159">Asynchronous programming with async and await (C#)</span></span>](index.md)
- [<span data-ttu-id="29efb-160">Types de retour Async (C#)</span><span class="sxs-lookup"><span data-stu-id="29efb-160">Async return types (C#)</span></span>](async-return-types.md)
