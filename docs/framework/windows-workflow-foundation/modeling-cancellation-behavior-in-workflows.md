---
title: Modélisation du comportement d'annulation dans les workflows
ms.date: 03/30/2017
ms.assetid: d48f6cf3-cdde-4dd3-8265-a665acf32a03
ms.openlocfilehash: ec0cf810693e2eda01a4c489b6eb938538719228
ms.sourcegitcommit: 68653db98c5ea7744fd438710248935f70020dfb
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/22/2019
ms.locfileid: "69965936"
---
# <a name="modeling-cancellation-behavior-in-workflows"></a><span data-ttu-id="3533c-102">Modélisation du comportement d'annulation dans les workflows</span><span class="sxs-lookup"><span data-stu-id="3533c-102">Modeling Cancellation Behavior in Workflows</span></span>
<span data-ttu-id="3533c-103">Les activités peuvent être annulées à l’intérieur d’un workflow, par exemple par une activité <xref:System.Activities.Statements.Parallel> qui annule des branches incomplètes lorsque son <xref:System.Activities.Statements.Parallel.CompletionCondition%2A> a la valeur `true`, ou à l’extérieur du workflow, si l’hôte appelle <xref:System.Activities.WorkflowApplication.Cancel%2A>.</span><span class="sxs-lookup"><span data-stu-id="3533c-103">Activities can be canceled inside a workflow, for example by a <xref:System.Activities.Statements.Parallel> activity canceling incomplete branches when its <xref:System.Activities.Statements.Parallel.CompletionCondition%2A> evaluates to `true`, or from outside the workflow, if the host calls <xref:System.Activities.WorkflowApplication.Cancel%2A>.</span></span> <span data-ttu-id="3533c-104">Pour fournir la gestion des annulations, les auteurs de workflow peuvent utiliser l'activité <xref:System.Activities.Statements.CancellationScope>, l'activité <xref:System.Activities.Statements.CompensableActivity> ou créer des activités personnalisées qui fournissent la logique d'annulation.</span><span class="sxs-lookup"><span data-stu-id="3533c-104">To provide cancellation handling, workflow authors can use the <xref:System.Activities.Statements.CancellationScope> activity, the <xref:System.Activities.Statements.CompensableActivity> activity, or create custom activities that provide cancellation logic.</span></span> <span data-ttu-id="3533c-105">Cette rubrique fournit une vue d'ensemble de l'annulation dans les workflows.</span><span class="sxs-lookup"><span data-stu-id="3533c-105">This topic provides an overview of cancellation in workflows.</span></span>  
  
## <a name="cancellation-compensation-and-transactions"></a><span data-ttu-id="3533c-106">Annulation, compensation et transactions</span><span class="sxs-lookup"><span data-stu-id="3533c-106">Cancellation, Compensation, and Transactions</span></span>  
 <span data-ttu-id="3533c-107">Les transactions permettent à votre application d'annuler (restaurer) toute modification exécutée dans une transaction en cas d'erreur au cours du processus de transaction.</span><span class="sxs-lookup"><span data-stu-id="3533c-107">Transactions give your application the ability to abort (roll back) all changes executed within the transaction if any errors occur during any part of the transaction process.</span></span> <span data-ttu-id="3533c-108">Toutefois, le travail qui peut devoir être annulé n’est pas dans sa totalité approprié pour les transactions, tel que le travail de longue durée ou le travail qui n’implique pas de ressources transactionnelles.</span><span class="sxs-lookup"><span data-stu-id="3533c-108">However, not all work that may need to be canceled or undone is appropriate for transactions, such as long-running work or work that does not involve transactional resources.</span></span> <span data-ttu-id="3533c-109">La compensation fournit un modèle pour l'annulation de travail non transactionnel précédemment effectué en cas d'échec ultérieur dans le workflow.</span><span class="sxs-lookup"><span data-stu-id="3533c-109">Compensation provides a model for undoing previously completed non-transactional work if there is a subsequent failure in the workflow.</span></span> <span data-ttu-id="3533c-110">L’annulation fournit un modèle pour les auteurs de workflow et d’activité pour gérer le travail non transactionnel qui n’a pas été effectué.</span><span class="sxs-lookup"><span data-stu-id="3533c-110">Cancellation provides a model for workflow and activity authors to handle non-transactional work that was not completed.</span></span> <span data-ttu-id="3533c-111">Si une activité n'a pas terminé son exécution et est annulée, sa logique d'annulation sera appelée si elle est disponible.</span><span class="sxs-lookup"><span data-stu-id="3533c-111">If an activity has not completed its execution and it is canceled, its cancellation logic will be invoked if it is available.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="3533c-112">Pour plus d’informations sur les transactions et la compensation, consultez [transactions](workflow-transactions.md) et [compensation](compensation.md).</span><span class="sxs-lookup"><span data-stu-id="3533c-112">For more information about transactions and compensation, see [Transactions](workflow-transactions.md) and [Compensation](compensation.md).</span></span>  
  
## <a name="using-cancellationscope"></a><span data-ttu-id="3533c-113">Utilisation de CancellationScope</span><span class="sxs-lookup"><span data-stu-id="3533c-113">Using CancellationScope</span></span>  
 <span data-ttu-id="3533c-114">L'activité <xref:System.Activities.Statements.CancellationScope> a deux sections qui peuvent contenir des activités enfants : <xref:System.Activities.Statements.CancellationScope.Body%2A> et <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A>.</span><span class="sxs-lookup"><span data-stu-id="3533c-114">The <xref:System.Activities.Statements.CancellationScope> activity has two sections that can contain child activities: <xref:System.Activities.Statements.CancellationScope.Body%2A> and <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A>.</span></span> <span data-ttu-id="3533c-115">Le <xref:System.Activities.Statements.CancellationScope.Body%2A> est l'endroit où les activités qui composent la logique de l'activité sont placées et le <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> est l'endroit où les activités qui fournissent la logique d'annulation pour l'activité sont placées.</span><span class="sxs-lookup"><span data-stu-id="3533c-115">The <xref:System.Activities.Statements.CancellationScope.Body%2A> is where the activities that make up the logic of the activity are placed, and the <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> is where the activities that provide cancellation logic for the activity are placed.</span></span> <span data-ttu-id="3533c-116">Une activité peut être annulée uniquement si elle n'est pas terminée.</span><span class="sxs-lookup"><span data-stu-id="3533c-116">An activity can be canceled only if it has not completed.</span></span> <span data-ttu-id="3533c-117">Dans le cas de l'activité <xref:System.Activities.Statements.CancellationScope>, l'achèvement fait référence à l'achèvement des activités dans le <xref:System.Activities.Statements.CancellationScope.Body%2A>.</span><span class="sxs-lookup"><span data-stu-id="3533c-117">In the case of the <xref:System.Activities.Statements.CancellationScope> activity, completion refers to the completion of the activities in the <xref:System.Activities.Statements.CancellationScope.Body%2A>.</span></span> <span data-ttu-id="3533c-118">Si une demande d'annulation est planifiée et que les activités dans le <xref:System.Activities.Statements.CancellationScope.Body%2A> ne sont pas terminées, le <xref:System.Activities.Statements.CancellationScope> sera marqué comme <xref:System.Activities.ActivityInstanceState.Canceled> et les activités <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> seront exécutées.</span><span class="sxs-lookup"><span data-stu-id="3533c-118">If a cancellation request is scheduled and the activities in the <xref:System.Activities.Statements.CancellationScope.Body%2A> have not completed, then the <xref:System.Activities.Statements.CancellationScope> will be marked as <xref:System.Activities.ActivityInstanceState.Canceled> and the <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> activities will be executed.</span></span>  
  
### <a name="canceling-a-workflow-from-the-host"></a><span data-ttu-id="3533c-119">Annulation d'un workflow à partir de l'hôte</span><span class="sxs-lookup"><span data-stu-id="3533c-119">Canceling a Workflow from the Host</span></span>  
 <span data-ttu-id="3533c-120">Un hôte peut annuler un workflow en appelant la méthode <xref:System.Activities.WorkflowApplication.Cancel%2A> de l'instance <xref:System.Activities.WorkflowApplication> qui héberge le workflow.</span><span class="sxs-lookup"><span data-stu-id="3533c-120">A host can cancel a workflow by calling the <xref:System.Activities.WorkflowApplication.Cancel%2A> method of the <xref:System.Activities.WorkflowApplication> instance that is hosting the workflow.</span></span> <span data-ttu-id="3533c-121">Dans l'exemple suivant, un workflow avec un <xref:System.Activities.Statements.CancellationScope> est créé.</span><span class="sxs-lookup"><span data-stu-id="3533c-121">In the following example a workflow is created that has a <xref:System.Activities.Statements.CancellationScope>.</span></span> <span data-ttu-id="3533c-122">Le workflow est appelé, puis l'hôte passe un appel au <xref:System.Activities.WorkflowApplication.Cancel%2A>.</span><span class="sxs-lookup"><span data-stu-id="3533c-122">The workflow is invoked, and then the host makes a call to <xref:System.Activities.WorkflowApplication.Cancel%2A>.</span></span> <span data-ttu-id="3533c-123">L'exécution principale du workflow est arrêtée, le <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> du <xref:System.Activities.Statements.CancellationScope> est appelé, puis le workflow se termine avec l'état <xref:System.Activities.ActivityInstanceState.Canceled>.</span><span class="sxs-lookup"><span data-stu-id="3533c-123">The main execution of the workflow is stopped, the <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> of the <xref:System.Activities.Statements.CancellationScope> is invoked, and then the workflow completes with a status of <xref:System.Activities.ActivityInstanceState.Canceled>.</span></span>  
  
 [!code-csharp[CFX_WorkflowApplicationExample#35](~/samples/snippets/csharp/VS_Snippets_CFX/cfx_workflowapplicationexample/cs/program.cs#35)]  
  
 <span data-ttu-id="3533c-124">Lorsque ce workflow est appelé, la sortie suivante s'affiche sur la console.</span><span class="sxs-lookup"><span data-stu-id="3533c-124">When this workflow is invoked, the following output is displayed to the console.</span></span>  
  
 <span data-ttu-id="3533c-125">**Démarrage du flux de travail.**</span><span class="sxs-lookup"><span data-stu-id="3533c-125">**Starting the workflow.**</span></span>  
<span data-ttu-id="3533c-126">**CancellationHandler appelé.**  </span><span class="sxs-lookup"><span data-stu-id="3533c-126">**CancellationHandler invoked.** </span></span>  
<span data-ttu-id="3533c-127">**B30ebb30-df46-4d90-A211-e31c38d8db3c de workflow annulée.**</span><span class="sxs-lookup"><span data-stu-id="3533c-127">**Workflow b30ebb30-df46-4d90-a211-e31c38d8db3c Canceled.**</span></span>    
> [!NOTE]
> <span data-ttu-id="3533c-128">Lorsqu'une activité <xref:System.Activities.Statements.CancellationScope> est annulée et que le <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> est appelé, il incombe à l'auteur de workflow de déterminer la progression effectuée par l'activité avant son annulation afin de fournir la logique d'annulation appropriée.</span><span class="sxs-lookup"><span data-stu-id="3533c-128">When a <xref:System.Activities.Statements.CancellationScope> activity is canceled and the <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> invoked, it is the responsibility of the workflow author to determine the progress that the canceled activity made before it was canceled in order to provide the appropriate cancellation logic.</span></span> <span data-ttu-id="3533c-129">Le <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> ne fournit aucune information sur la progression de l'activité annulée.</span><span class="sxs-lookup"><span data-stu-id="3533c-129">The <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> does not provide any information about the progress of the canceled activity.</span></span>  
  
 <span data-ttu-id="3533c-130">Un workflow peut également être annulé à partir de l'hôte si une exception non gérée est propagée au-delà de la racine du workflow et que le gestionnaire <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A> retourne <xref:System.Activities.UnhandledExceptionAction.Cancel>.</span><span class="sxs-lookup"><span data-stu-id="3533c-130">A workflow can also be canceled from the host if an unhandled exception bubbles up past the root of the workflow and the <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A> handler returns <xref:System.Activities.UnhandledExceptionAction.Cancel>.</span></span> <span data-ttu-id="3533c-131">Dans cet exemple, le workflow démarre, puis lève un <xref:System.ApplicationException>.</span><span class="sxs-lookup"><span data-stu-id="3533c-131">In this example the workflow starts and then throws an <xref:System.ApplicationException>.</span></span> <span data-ttu-id="3533c-132">Cette exception n'étant pas prise en charge par le workflow, le gestionnaire <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A> est appelé.</span><span class="sxs-lookup"><span data-stu-id="3533c-132">This exception is unhandled by the workflow and so the <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A> handler is invoked.</span></span> <span data-ttu-id="3533c-133">Le gestionnaire indique à l'exécution d'annuler le workflow et le <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> de l'activité <xref:System.Activities.Statements.CancellationScope> actuellement en cours d'exécution est appelé.</span><span class="sxs-lookup"><span data-stu-id="3533c-133">The handler instructs the runtime to cancel the workflow, and the <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> of the currently executing <xref:System.Activities.Statements.CancellationScope> activity is invoked.</span></span>  
  
 [!code-csharp[CFX_WorkflowApplicationExample#36](~/samples/snippets/csharp/VS_Snippets_CFX/cfx_workflowapplicationexample/cs/program.cs#36)]  
  
 <span data-ttu-id="3533c-134">Lorsque ce workflow est appelé, la sortie suivante s'affiche sur la console.</span><span class="sxs-lookup"><span data-stu-id="3533c-134">When this workflow is invoked, the following output is displayed to the console.</span></span>  
  
 <span data-ttu-id="3533c-135">**Démarrage du flux de travail.**</span><span class="sxs-lookup"><span data-stu-id="3533c-135">**Starting the workflow.**</span></span>  
<span data-ttu-id="3533c-136">**OnUnhandledException dans le 6bb2d5d6-F49a-4C6D-A988-478afb86dbe9 de workflow** </span><span class="sxs-lookup"><span data-stu-id="3533c-136">**OnUnhandledException in Workflow 6bb2d5d6-f49a-4c6d-a988-478afb86dbe9** </span></span>  
<span data-ttu-id="3533c-137">**Une ApplicationException a été levée.**  </span><span class="sxs-lookup"><span data-stu-id="3533c-137">**An ApplicationException was thrown.** </span></span>  
<span data-ttu-id="3533c-138">**CancellationHandler appelé.**  </span><span class="sxs-lookup"><span data-stu-id="3533c-138">**CancellationHandler invoked.** </span></span>  
<span data-ttu-id="3533c-139">**6bb2d5d6-F49a-4C6D-A988-478afb86dbe9 de workflow annulée.**</span><span class="sxs-lookup"><span data-stu-id="3533c-139">**Workflow 6bb2d5d6-f49a-4c6d-a988-478afb86dbe9 Canceled.**</span></span>    
### <a name="canceling-an-activity-from-inside-a-workflow"></a><span data-ttu-id="3533c-140">Annulation d'une activité à l'intérieur d'un workflow</span><span class="sxs-lookup"><span data-stu-id="3533c-140">Canceling an Activity from Inside a Workflow</span></span>  
 <span data-ttu-id="3533c-141">Une activité peut également être annulée par son parent.</span><span class="sxs-lookup"><span data-stu-id="3533c-141">An activity can also be canceled by its parent.</span></span> <span data-ttu-id="3533c-142">Par exemple, si une activité <xref:System.Activities.Statements.Parallel> a plusieurs branches en cours d’exécution et que son <xref:System.Activities.Statements.Parallel.CompletionCondition%2A> a la valeur `true`, ses branches incomplètes seront annulées.</span><span class="sxs-lookup"><span data-stu-id="3533c-142">For example, if a <xref:System.Activities.Statements.Parallel> activity has multiple executing branches and its <xref:System.Activities.Statements.Parallel.CompletionCondition%2A> evaluates to `true` then its incomplete branches will be canceled.</span></span> <span data-ttu-id="3533c-143">Dans cet exemple, une activité <xref:System.Activities.Statements.Parallel> avec deux branches est créée.</span><span class="sxs-lookup"><span data-stu-id="3533c-143">In this example a <xref:System.Activities.Statements.Parallel> activity is created that has two branches.</span></span> <span data-ttu-id="3533c-144">Son <xref:System.Activities.Statements.Parallel.CompletionCondition%2A> ayant la valeur `true`, le <xref:System.Activities.Statements.Parallel> est effectué dès que l’une de ses branches est terminée.</span><span class="sxs-lookup"><span data-stu-id="3533c-144">Its <xref:System.Activities.Statements.Parallel.CompletionCondition%2A> is set to `true` so the <xref:System.Activities.Statements.Parallel> completes as soon as any one of its branches is completed.</span></span> <span data-ttu-id="3533c-145">Dans cet exemple, la branche 2 étant terminée, la branche 1 est annulée.</span><span class="sxs-lookup"><span data-stu-id="3533c-145">In this example branch 2 completes, and so branch 1 is canceled.</span></span>  
  
 [!code-csharp[CFX_WorkflowApplicationExample#37](~/samples/snippets/csharp/VS_Snippets_CFX/cfx_workflowapplicationexample/cs/program.cs#37)]  
  
 <span data-ttu-id="3533c-146">Lorsque ce workflow est appelé, la sortie suivante s'affiche sur la console.</span><span class="sxs-lookup"><span data-stu-id="3533c-146">When this workflow is invoked, the following output is displayed to the console.</span></span>  
  
 <span data-ttu-id="3533c-147">**Démarrage de la branche 1.**</span><span class="sxs-lookup"><span data-stu-id="3533c-147">**Branch 1 starting.**</span></span>  
<span data-ttu-id="3533c-148">**Branche 2 terminée.**  </span><span class="sxs-lookup"><span data-stu-id="3533c-148">**Branch 2 complete.** </span></span>  
<span data-ttu-id="3533c-149">**Branche 1 annulée.**  </span><span class="sxs-lookup"><span data-stu-id="3533c-149">**Branch 1 canceled.** </span></span>  
<span data-ttu-id="3533c-150">**E0685e24-18ef-4A47-ACF3-5c638732f3be de workflow terminé.**</span><span class="sxs-lookup"><span data-stu-id="3533c-150">**Workflow e0685e24-18ef-4a47-acf3-5c638732f3be Completed.**</span></span>  <span data-ttu-id="3533c-151">Les activités sont également annulées si une exception est propagée au-delà de la racine de l'activité, mais est gérée à un niveau supérieur dans le workflow.</span><span class="sxs-lookup"><span data-stu-id="3533c-151">Activities are also canceled if an exception bubbles up past the root of the activity but is handled at a higher level in the workflow.</span></span> <span data-ttu-id="3533c-152">Dans cet exemple, la logique principale du workflow se compose d'une activité <xref:System.Activities.Statements.Sequence>.</span><span class="sxs-lookup"><span data-stu-id="3533c-152">In this example, the main logic of the workflow consists of a <xref:System.Activities.Statements.Sequence> activity.</span></span> <span data-ttu-id="3533c-153">Le <xref:System.Activities.Statements.Sequence> est spécifié comme <xref:System.Activities.Statements.CancellationScope.Body%2A> d'une activité <xref:System.Activities.Statements.CancellationScope> contenue dans une activité <xref:System.Activities.Statements.TryCatch>.</span><span class="sxs-lookup"><span data-stu-id="3533c-153">The <xref:System.Activities.Statements.Sequence> is specified as the <xref:System.Activities.Statements.CancellationScope.Body%2A> of a <xref:System.Activities.Statements.CancellationScope> activity which is contained by a <xref:System.Activities.Statements.TryCatch> activity.</span></span> <span data-ttu-id="3533c-154">Une exception est levée à partir du corps du <xref:System.Activities.Statements.Sequence>, est gérée par l'activité <xref:System.Activities.Statements.TryCatch> parente et le <xref:System.Activities.Statements.Sequence> est annulé.</span><span class="sxs-lookup"><span data-stu-id="3533c-154">An exception is thrown from the body of the <xref:System.Activities.Statements.Sequence>, is handled by the parent <xref:System.Activities.Statements.TryCatch> activity, and the <xref:System.Activities.Statements.Sequence> is canceled.</span></span>  
  
 [!code-csharp[CFX_WorkflowApplicationExample#39](~/samples/snippets/csharp/VS_Snippets_CFX/cfx_workflowapplicationexample/cs/program.cs#39)]  
  
 <span data-ttu-id="3533c-155">Lorsque ce workflow est appelé, la sortie suivante s'affiche sur la console.</span><span class="sxs-lookup"><span data-stu-id="3533c-155">When this workflow is invoked, the following output is displayed to the console.</span></span>  
  
 <span data-ttu-id="3533c-156">**Début de la séquence.**</span><span class="sxs-lookup"><span data-stu-id="3533c-156">**Sequence starting.**</span></span>  
<span data-ttu-id="3533c-157">**Séquence annulée.**  </span><span class="sxs-lookup"><span data-stu-id="3533c-157">**Sequence canceled.** </span></span>  
<span data-ttu-id="3533c-158">**Exception interceptée.**  </span><span class="sxs-lookup"><span data-stu-id="3533c-158">**Exception caught.** </span></span>  
<span data-ttu-id="3533c-159">**E3c18939-121e-4C43-AF1C-ba1ce977ce55 de workflow terminé.**</span><span class="sxs-lookup"><span data-stu-id="3533c-159">**Workflow e3c18939-121e-4c43-af1c-ba1ce977ce55 Completed.**</span></span>   
### <a name="throwing-exceptions-from-a-cancellationhandler"></a><span data-ttu-id="3533c-160">Levée d'exceptions à partir d'un CancellationHandler</span><span class="sxs-lookup"><span data-stu-id="3533c-160">Throwing Exceptions from a CancellationHandler</span></span>  
 <span data-ttu-id="3533c-161">Toutes les exceptions levées à partir du <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> d'un <xref:System.Activities.Statements.CancellationScope> sont irrécupérables pour le workflow.</span><span class="sxs-lookup"><span data-stu-id="3533c-161">Any exceptions thrown from the <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> of a <xref:System.Activities.Statements.CancellationScope> are fatal to the workflow.</span></span> <span data-ttu-id="3533c-162">S'il existe une possibilité pour les exceptions d'échapper à un <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A>, utilisez un <xref:System.Activities.Statements.TryCatch> dans le <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> pour intercepter et gérer ces exceptions.</span><span class="sxs-lookup"><span data-stu-id="3533c-162">If there is a possibility of exceptions escaping from a <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A>, use a <xref:System.Activities.Statements.TryCatch> in the <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> to catch and handle these exceptions.</span></span>  
  
### <a name="cancellation-using-compensableactivity"></a><span data-ttu-id="3533c-163">Annulation à l'aide de CompensableActivity</span><span class="sxs-lookup"><span data-stu-id="3533c-163">Cancellation using CompensableActivity</span></span>  
 <span data-ttu-id="3533c-164">Comme l'activité <xref:System.Activities.Statements.CancellationScope>, le <xref:System.Activities.Statements.CompensableActivity> a un <xref:System.Activities.Statements.CompensableActivity.CancellationHandler%2A>.</span><span class="sxs-lookup"><span data-stu-id="3533c-164">Like the <xref:System.Activities.Statements.CancellationScope> activity, the <xref:System.Activities.Statements.CompensableActivity> has a <xref:System.Activities.Statements.CompensableActivity.CancellationHandler%2A>.</span></span> <span data-ttu-id="3533c-165">Si un <xref:System.Activities.Statements.CompensableActivity> est annulé, toutes les activités dans son <xref:System.Activities.Statements.CompensableActivity.CancellationHandler%2A> sont appelées.</span><span class="sxs-lookup"><span data-stu-id="3533c-165">If a <xref:System.Activities.Statements.CompensableActivity> is canceled, any activities in its <xref:System.Activities.Statements.CompensableActivity.CancellationHandler%2A> are invoked.</span></span> <span data-ttu-id="3533c-166">Cela peut être utile pour l'annulation de travail compensable partiellement effectué.</span><span class="sxs-lookup"><span data-stu-id="3533c-166">This can be useful for undoing partially completed compensable work.</span></span> <span data-ttu-id="3533c-167">Pour plus d’informations sur l' <xref:System.Activities.Statements.CompensableActivity> utilisation de pour la compensation et l’annulation, consultez [compensation](compensation.md).</span><span class="sxs-lookup"><span data-stu-id="3533c-167">For information about how to use <xref:System.Activities.Statements.CompensableActivity> for compensation and cancellation, see [Compensation](compensation.md).</span></span>  
  
## <a name="cancellation-using-custom-activities"></a><span data-ttu-id="3533c-168">Annulation à l'aide d'activités personnalisées</span><span class="sxs-lookup"><span data-stu-id="3533c-168">Cancellation using Custom Activities</span></span>  
 <span data-ttu-id="3533c-169">Les auteurs d'activités personnalisés peuvent implémenter une logique d'annulation dans leurs activités personnalisées de plusieurs façons différentes.</span><span class="sxs-lookup"><span data-stu-id="3533c-169">Custom activity authors can implement cancellation logic into their custom activities in several different ways.</span></span> <span data-ttu-id="3533c-170">Les activités personnalisées qui dérivent de <xref:System.Activities.Activity> peuvent implémenter la logique d'annulation en plaçant <xref:System.Activities.Statements.CancellationScope> ou une autre activité personnalisée qui contient la logique d'annulation dans le corps de l'activité.</span><span class="sxs-lookup"><span data-stu-id="3533c-170">Custom activities that derive from <xref:System.Activities.Activity> can implement cancellation logic by placing a <xref:System.Activities.Statements.CancellationScope> or other custom activity that contains cancellation logic in the body of the activity.</span></span> <span data-ttu-id="3533c-171">Les activités dérivées <xref:System.Activities.AsyncCodeActivity> et <xref:System.Activities.NativeActivity> peuvent remplacer leur méthode correspondante <xref:System.Activities.NativeActivity.Cancel%2A> et fournir la logique d'annulation à cet endroit.</span><span class="sxs-lookup"><span data-stu-id="3533c-171"><xref:System.Activities.AsyncCodeActivity> and <xref:System.Activities.NativeActivity> derived activities can override their respective <xref:System.Activities.NativeActivity.Cancel%2A> method and provide cancellation logic there.</span></span> <span data-ttu-id="3533c-172">Les activités dérivées <xref:System.Activities.CodeActivity> ne fournissent aucune configuration pour l'annulation parce que tout leur travail est effectué dans une rafale unique d'exécution lorsque l'exécution appelle la méthode <xref:System.Activities.CodeActivity.Execute%2A>.</span><span class="sxs-lookup"><span data-stu-id="3533c-172"><xref:System.Activities.CodeActivity> derived activities do not provide any provision for cancellation because all their work is performed in a single burst of execution when the runtime calls the <xref:System.Activities.CodeActivity.Execute%2A> method.</span></span> <span data-ttu-id="3533c-173">Si la méthode d'exécution n'a pas encore été appelée et qu'une activité basée sur <xref:System.Activities.CodeActivity> est annulée, l'activité est fermée avec l'état <xref:System.Activities.ActivityInstanceState.Canceled> et la méthode <xref:System.Activities.CodeActivity.Execute%2A> n'est pas appelée.</span><span class="sxs-lookup"><span data-stu-id="3533c-173">If the execute method has not yet been called and a <xref:System.Activities.CodeActivity> based activity is canceled, the activity closes with a status of <xref:System.Activities.ActivityInstanceState.Canceled> and the <xref:System.Activities.CodeActivity.Execute%2A> method is not called.</span></span>  
  
### <a name="cancellation-using-nativeactivity"></a><span data-ttu-id="3533c-174">Annulation à l'aide de NativeActivity</span><span class="sxs-lookup"><span data-stu-id="3533c-174">Cancellation using NativeActivity</span></span>  
 <span data-ttu-id="3533c-175">Les activités dérivées <xref:System.Activities.NativeActivity> peuvent substituer la méthode <xref:System.Activities.NativeActivity.Cancel%2A> pour fournir une logique d'annulation personnalisée.</span><span class="sxs-lookup"><span data-stu-id="3533c-175"><xref:System.Activities.NativeActivity> derived activities can override the <xref:System.Activities.NativeActivity.Cancel%2A> method to provide custom cancellation logic.</span></span> <span data-ttu-id="3533c-176">Si cette méthode n'est pas substituée, la logique d'annulation du workflow par défaut est appliquée.</span><span class="sxs-lookup"><span data-stu-id="3533c-176">If this method is not overridden, then the default workflow cancellation logic is applied.</span></span> <span data-ttu-id="3533c-177">L’annulation par défaut est le processus qui se <xref:System.Activities.NativeActivity> produit pour un qui ne substitue pas la <xref:System.Activities.NativeActivity.Cancel%2A> <xref:System.Activities.NativeActivity.Cancel%2A> méthode ou dont la <xref:System.Activities.NativeActivity> méthode appelle la méthode de base <xref:System.Activities.NativeActivity.Cancel%2A> .</span><span class="sxs-lookup"><span data-stu-id="3533c-177">Default cancellation is the process that occurs for a <xref:System.Activities.NativeActivity> that does not override the <xref:System.Activities.NativeActivity.Cancel%2A> method or whose <xref:System.Activities.NativeActivity.Cancel%2A> method calls the base <xref:System.Activities.NativeActivity> <xref:System.Activities.NativeActivity.Cancel%2A> method.</span></span> <span data-ttu-id="3533c-178">Lorsqu'une activité est annulée, l'exécution signale l'activité pour annulation et gère automatiquement un certain nettoyage.</span><span class="sxs-lookup"><span data-stu-id="3533c-178">When an activity is canceled, the runtime flags the activity for cancellation and automatically handles certain cleanup.</span></span> <span data-ttu-id="3533c-179">Si l'activité a seulement des signets en attente, les signets seront supprimés et l'activité sera marquée comme <xref:System.Activities.ActivityInstanceState.Canceled>.</span><span class="sxs-lookup"><span data-stu-id="3533c-179">If the activity only has outstanding bookmarks, the bookmarks will be removed and the activity will be marked as <xref:System.Activities.ActivityInstanceState.Canceled>.</span></span> <span data-ttu-id="3533c-180">Toutes les activités enfants en attente de l'activité annulée seront à leur tour annulées.</span><span class="sxs-lookup"><span data-stu-id="3533c-180">Any outstanding child activities of the canceled activity will in turn be canceled.</span></span> <span data-ttu-id="3533c-181">Toute tentative de planifier des activités enfants supplémentaires aura pour conséquence que la tentative sera ignorée et l'activité sera marquée comme <xref:System.Activities.ActivityInstanceState.Canceled>.</span><span class="sxs-lookup"><span data-stu-id="3533c-181">Any attempt to schedule additional child activities will result in the attempt being ignored and the activity will be marked as <xref:System.Activities.ActivityInstanceState.Canceled>.</span></span> <span data-ttu-id="3533c-182">Si une activité enfant en attente se termine dans l'état <xref:System.Activities.ActivityInstanceState.Canceled> ou <xref:System.Activities.ActivityInstanceState.Faulted>, l'activité sera marquée comme <xref:System.Activities.ActivityInstanceState.Canceled>.</span><span class="sxs-lookup"><span data-stu-id="3533c-182">If any outstanding child activity completes in the <xref:System.Activities.ActivityInstanceState.Canceled> or <xref:System.Activities.ActivityInstanceState.Faulted> state, then the activity will be marked as <xref:System.Activities.ActivityInstanceState.Canceled>.</span></span> <span data-ttu-id="3533c-183">Notez qu'une demande d'annulation peut être ignorée.</span><span class="sxs-lookup"><span data-stu-id="3533c-183">Note that a cancellation request can be ignored.</span></span> <span data-ttu-id="3533c-184">Si une activité n'a pas de signets en attente ou d'activités enfants en cours d'exécution et ne planifie pas d'éléments de travail supplémentaires après avoir été signalée pour annulation, son exécution sera réussie.</span><span class="sxs-lookup"><span data-stu-id="3533c-184">If an activity does not have any outstanding bookmarks or executing child activities and does not schedule any additional work items after being flagged for cancellation, it will complete successfully.</span></span> <span data-ttu-id="3533c-185">Cette annulation par défaut suffit pour de nombreux scénarios mais, si une logique d'annulation supplémentaire est nécessaire, les activités d'annulation intégrées ou activités personnalisées peuvent être utilisées.</span><span class="sxs-lookup"><span data-stu-id="3533c-185">This default cancellation suffices for many scenarios, but if additional cancellation logic is needed, then the built-in cancellation activities or custom activities can be used.</span></span>  
  
 <span data-ttu-id="3533c-186">Dans l'exemple suivant, la substitution <xref:System.Activities.NativeActivity.Cancel%2A> d'une activité <xref:System.Activities.NativeActivity> personnalisée basée sur `ParallelForEach` est définie.</span><span class="sxs-lookup"><span data-stu-id="3533c-186">In the following example, the <xref:System.Activities.NativeActivity.Cancel%2A> override of a <xref:System.Activities.NativeActivity> based custom `ParallelForEach` activity is defined.</span></span> <span data-ttu-id="3533c-187">Lorsque l'activité est annulée, cette substitution gère la logique d'annulation pour l'activité.</span><span class="sxs-lookup"><span data-stu-id="3533c-187">When the activity is canceled, this override handles the cancellation logic for the activity.</span></span> <span data-ttu-id="3533c-188">Cet exemple fait partie de l’exemple [ParallelForEach non générique](./samples/non-generic-parallelforeach.md) .</span><span class="sxs-lookup"><span data-stu-id="3533c-188">This example is part of the [Non-Generic ParallelForEach](./samples/non-generic-parallelforeach.md) sample.</span></span>  
  
```csharp  
protected override void Cancel(NativeActivityContext context)  
{  
    // If we do not have a completion condition then we can just  
    // use default logic.  
    if (this.CompletionCondition == null)  
    {  
        base.Cancel(context);  
    }  
    else  
    {  
        context.CancelChildren();  
    }  
}  
```  
  
 <span data-ttu-id="3533c-189">Les activités dérivées <xref:System.Activities.NativeActivity> peuvent déterminer si l'annulation a été demandée en inspectant la propriété <xref:System.Activities.NativeActivityContext.IsCancellationRequested%2A>, puis se marquer comme annulées en appelant la méthode <xref:System.Activities.NativeActivityContext.MarkCanceled%2A>.</span><span class="sxs-lookup"><span data-stu-id="3533c-189"><xref:System.Activities.NativeActivity> derived activities can determine if cancellation has been requested by inspecting the <xref:System.Activities.NativeActivityContext.IsCancellationRequested%2A> property, and mark themselves as canceled by calling the <xref:System.Activities.NativeActivityContext.MarkCanceled%2A> method.</span></span> <span data-ttu-id="3533c-190">L'appel de <xref:System.Activities.NativeActivityContext.MarkCanceled%2A> ne met pas immédiatement fin à l'activité.</span><span class="sxs-lookup"><span data-stu-id="3533c-190">Calling <xref:System.Activities.NativeActivityContext.MarkCanceled%2A> does not immediately complete the activity.</span></span> <span data-ttu-id="3533c-191">Comme habituellement, l'exécution termine l'activité lorsque plus aucun travail n'est en attente, mais si <xref:System.Activities.NativeActivityContext.MarkCanceled%2A> est appelé, l'état définitif sera <xref:System.Activities.ActivityInstanceState.Canceled> au lieu de <xref:System.Activities.ActivityInstanceState.Closed>.</span><span class="sxs-lookup"><span data-stu-id="3533c-191">As usual, the runtime will complete the activity when it has no more outstanding work, but if <xref:System.Activities.NativeActivityContext.MarkCanceled%2A> is called the final state will be <xref:System.Activities.ActivityInstanceState.Canceled> instead of <xref:System.Activities.ActivityInstanceState.Closed>.</span></span>  
  
### <a name="cancellation-using-asynccodeactivity"></a><span data-ttu-id="3533c-192">Annulation à l'aide d'AsyncCodeActivity</span><span class="sxs-lookup"><span data-stu-id="3533c-192">Cancellation using AsyncCodeActivity</span></span>  
 <span data-ttu-id="3533c-193">Les activités basées sur <xref:System.Activities.AsyncCodeActivity> peuvent également fournir une logique d'annulation personnalisée en substituant la méthode <xref:System.Activities.AsyncCodeActivity.Cancel%2A>.</span><span class="sxs-lookup"><span data-stu-id="3533c-193"><xref:System.Activities.AsyncCodeActivity> based activities can also provide custom cancellation logic by overriding the <xref:System.Activities.AsyncCodeActivity.Cancel%2A> method.</span></span> <span data-ttu-id="3533c-194">Si cette méthode n'est pas substituée, aucune gestion des annulations n'est effectuée si l'activité est annulée.</span><span class="sxs-lookup"><span data-stu-id="3533c-194">If this method is not overridden, then no cancellation handling is performed if the activity is canceled.</span></span> <span data-ttu-id="3533c-195">Dans l'exemple suivant, la substitution <xref:System.Activities.AsyncCodeActivity.Cancel%2A> d'une activité <xref:System.Activities.AsyncCodeActivity> personnalisée basée sur `ExecutePowerShell` est définie.</span><span class="sxs-lookup"><span data-stu-id="3533c-195">In the following example, the <xref:System.Activities.AsyncCodeActivity.Cancel%2A> override of an <xref:System.Activities.AsyncCodeActivity> based custom `ExecutePowerShell` activity is defined.</span></span> <span data-ttu-id="3533c-196">Lorsque l'activité est annulée, elle exécute le comportement d'annulation voulu.</span><span class="sxs-lookup"><span data-stu-id="3533c-196">When the activity is canceled, it performs the desired cancellation behavior.</span></span>
  
 [!code-csharp[CFX_WorkflowApplicationExample#1020](~/samples/snippets/csharp/VS_Snippets_CFX/cfx_workflowapplicationexample/cs/program.cs#1020)]  
  
 <span data-ttu-id="3533c-197">Les activités dérivées <xref:System.Activities.AsyncCodeActivity> peuvent déterminer si l'annulation a été demandée en inspectant la propriété <xref:System.Activities.AsyncCodeActivityContext.IsCancellationRequested%2A>, puis se marquer comme annulées en appelant la méthode <xref:System.Activities.AsyncCodeActivityContext.MarkCanceled%2A>.</span><span class="sxs-lookup"><span data-stu-id="3533c-197"><xref:System.Activities.AsyncCodeActivity> derived activities can determine if cancellation has been requested by inspecting the <xref:System.Activities.AsyncCodeActivityContext.IsCancellationRequested%2A> property, and mark themselves as canceled by calling the <xref:System.Activities.AsyncCodeActivityContext.MarkCanceled%2A> method.</span></span>
