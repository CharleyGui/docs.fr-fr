---
title: Interopérabilité WPF et Direct3D9
titleSuffix: ''
ms.date: 03/30/2017
dev_langs:
- cpp
helpviewer_keywords:
- WPF [WPF], creating Direct3D9 content
- Direct3D9 [WPF interoperability], creating Direct3D9 content
ms.assetid: 1b14b823-69c4-4e8d-99e4-f6dade58f89a
ms.openlocfilehash: 9ec83c48052e1ef29bb91a6b40b7c76f671bb99f
ms.sourcegitcommit: de17a7a0a37042f0d4406f5ae5393531caeb25ba
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/24/2020
ms.locfileid: "76735182"
---
# <a name="wpf-and-direct3d9-interoperation"></a><span data-ttu-id="50e52-102">Interopérabilité WPF et Direct3D9</span><span class="sxs-lookup"><span data-stu-id="50e52-102">WPF and Direct3D9 Interoperation</span></span>
<span data-ttu-id="50e52-103">Vous pouvez inclure du contenu Direct3D9 dans une application Windows Presentation Foundation (WPF).</span><span class="sxs-lookup"><span data-stu-id="50e52-103">You can include Direct3D9 content in a Windows Presentation Foundation (WPF) application.</span></span> <span data-ttu-id="50e52-104">Cette rubrique explique comment créer du contenu Direct3D9 afin qu’il interagisse efficacement avec WPF.</span><span class="sxs-lookup"><span data-stu-id="50e52-104">This topic describes how to create Direct3D9 content so that it efficiently interoperates with WPF.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="50e52-105">Quand vous utilisez du contenu Direct3D9 dans WPF, vous devez également réfléchir aux performances.</span><span class="sxs-lookup"><span data-stu-id="50e52-105">When using Direct3D9 content in WPF, you also need to think about performance.</span></span> <span data-ttu-id="50e52-106">Pour plus d’informations sur la façon d’optimiser les performances, consultez [Considérations sur les performances de l’interopérabilité entre Direct3D9 et WPF](performance-considerations-for-direct3d9-and-wpf-interoperability.md).</span><span class="sxs-lookup"><span data-stu-id="50e52-106">For more information about how to optimize for performance, see [Performance Considerations for Direct3D9 and WPF Interoperability](performance-considerations-for-direct3d9-and-wpf-interoperability.md).</span></span>  
  
## <a name="display-buffers"></a><span data-ttu-id="50e52-107">Mémoires tampons d’affichage</span><span class="sxs-lookup"><span data-stu-id="50e52-107">Display Buffers</span></span>  
 <span data-ttu-id="50e52-108">La classe <xref:System.Windows.Interop.D3DImage> gère deux mémoires tampons d’affichage, appelées *mémoire tampon d’arrière* - *plan et mémoire tampon*d’arrière-plan.</span><span class="sxs-lookup"><span data-stu-id="50e52-108">The <xref:System.Windows.Interop.D3DImage> class manages two display buffers, which are called the *back buffer* and the *front buffer*.</span></span> <span data-ttu-id="50e52-109">La mémoire tampon d’arrière-plan est votre surface Direct3D9.</span><span class="sxs-lookup"><span data-stu-id="50e52-109">The back buffer is your Direct3D9 surface.</span></span> <span data-ttu-id="50e52-110">Les modifications apportées à la mémoire tampon d’arrière-plan sont copiées par progression vers la mémoire tampon d’avance lorsque vous appelez la méthode <xref:System.Windows.Interop.D3DImage.Unlock%2A>.</span><span class="sxs-lookup"><span data-stu-id="50e52-110">Changes to the back buffer are copied forward to the front buffer when you call the <xref:System.Windows.Interop.D3DImage.Unlock%2A> method.</span></span>  
  
 <span data-ttu-id="50e52-111">L’illustration suivante montre la relation entre la mémoire tampon d’arrière-plan et la mémoire tampon d’arrière-plan.</span><span class="sxs-lookup"><span data-stu-id="50e52-111">The following illustration shows the relationship between the back buffer and the front buffer.</span></span>  
  
 <span data-ttu-id="50e52-112">![Mémoires tampons d’affichage D3DImage](./media/d3dimage-buffers.png "D3DImage_buffers")</span><span class="sxs-lookup"><span data-stu-id="50e52-112">![D3DImage display buffers](./media/d3dimage-buffers.png "D3DImage_buffers")</span></span>  
  
## <a name="direct3d9-device-creation"></a><span data-ttu-id="50e52-113">Création d’appareils Direct3D9</span><span class="sxs-lookup"><span data-stu-id="50e52-113">Direct3D9 Device Creation</span></span>  
 <span data-ttu-id="50e52-114">Pour afficher le contenu Direct3D9, vous devez créer un appareil Direct3D9.</span><span class="sxs-lookup"><span data-stu-id="50e52-114">To render Direct3D9 content, you must create a Direct3D9 device.</span></span> <span data-ttu-id="50e52-115">Il existe deux objets Direct3D9 que vous pouvez utiliser pour créer un appareil, `IDirect3D9` et `IDirect3D9Ex`.</span><span class="sxs-lookup"><span data-stu-id="50e52-115">There are two Direct3D9 objects that you can use to create a device, `IDirect3D9` and `IDirect3D9Ex`.</span></span> <span data-ttu-id="50e52-116">Utilisez ces objets pour créer des `IDirect3DDevice9` et des appareils `IDirect3DDevice9Ex`, respectivement.</span><span class="sxs-lookup"><span data-stu-id="50e52-116">Use these objects to create `IDirect3DDevice9` and `IDirect3DDevice9Ex` devices, respectively.</span></span>  
  
 <span data-ttu-id="50e52-117">Créez un appareil en appelant l’une des méthodes suivantes.</span><span class="sxs-lookup"><span data-stu-id="50e52-117">Create a device by calling one of the following methods.</span></span>  
  
- `IDirect3D9 * Direct3DCreate9(UINT SDKVersion);`  
  
- `HRESULT Direct3DCreate9Ex(UINT SDKVersion, IDirect3D9Ex **ppD3D);`  
  
 <span data-ttu-id="50e52-118">Sur Windows Vista ou un système d’exploitation ultérieur, utilisez la méthode `Direct3DCreate9Ex` avec un affichage configuré pour utiliser le modèle WDDM (Windows Display Driver Model).</span><span class="sxs-lookup"><span data-stu-id="50e52-118">On Windows Vista or later operating system, use the `Direct3DCreate9Ex` method with a display that is configured to use the Windows Display Driver Model (WDDM).</span></span> <span data-ttu-id="50e52-119">Utilisez la méthode `Direct3DCreate9` sur toute autre plateforme.</span><span class="sxs-lookup"><span data-stu-id="50e52-119">Use the `Direct3DCreate9` method on any other platform.</span></span>  
  
### <a name="availability-of-the-direct3dcreate9ex-method"></a><span data-ttu-id="50e52-120">Disponibilité de la méthode Direct3DCreate9Ex</span><span class="sxs-lookup"><span data-stu-id="50e52-120">Availability of the Direct3DCreate9Ex method</span></span>  
 <span data-ttu-id="50e52-121">D3d9. dll a la méthode `Direct3DCreate9Ex` uniquement sur Windows Vista ou un système d’exploitation ultérieur.</span><span class="sxs-lookup"><span data-stu-id="50e52-121">The d3d9.dll has the `Direct3DCreate9Ex` method only on Windows Vista or later operating system.</span></span> <span data-ttu-id="50e52-122">Si vous liez directement la fonction sur Windows XP, votre application ne se charge pas.</span><span class="sxs-lookup"><span data-stu-id="50e52-122">If you directly link the function on Windows XP, your application fails to load.</span></span> <span data-ttu-id="50e52-123">Pour déterminer si la méthode `Direct3DCreate9Ex` est prise en charge, chargez la DLL et recherchez l’adresse proc.</span><span class="sxs-lookup"><span data-stu-id="50e52-123">To determine whether the `Direct3DCreate9Ex` method is supported, load the DLL and look for the proc address.</span></span> <span data-ttu-id="50e52-124">Le code suivant montre comment tester la méthode `Direct3DCreate9Ex`.</span><span class="sxs-lookup"><span data-stu-id="50e52-124">The following code shows how to test for the `Direct3DCreate9Ex` method.</span></span> <span data-ttu-id="50e52-125">Pour obtenir un exemple de code complet, consultez [procédure pas à pas : création de contenu Direct3D9 pour l’hébergement dans WPF](walkthrough-creating-direct3d9-content-for-hosting-in-wpf.md).</span><span class="sxs-lookup"><span data-stu-id="50e52-125">For a full code example, see [Walkthrough: Creating Direct3D9 Content for Hosting in WPF](walkthrough-creating-direct3d9-content-for-hosting-in-wpf.md).</span></span>  
  
 [!code-cpp[System.Windows.Interop.D3DImage#RendererManager_EnsureD3DObjects](~/samples/snippets/cpp/VS_Snippets_Wpf/System.Windows.Interop.D3DImage/cpp/renderermanager.cpp#renderermanager_ensured3dobjects)]  
  
### <a name="hwnd-creation"></a><span data-ttu-id="50e52-126">Création HWND</span><span class="sxs-lookup"><span data-stu-id="50e52-126">HWND Creation</span></span>  
 <span data-ttu-id="50e52-127">La création d’un appareil requiert un HWND.</span><span class="sxs-lookup"><span data-stu-id="50e52-127">Creating a device requires an HWND.</span></span> <span data-ttu-id="50e52-128">En général, vous créez un HWND factice à utiliser par Direct3D9.</span><span class="sxs-lookup"><span data-stu-id="50e52-128">In general, you create a dummy HWND for Direct3D9 to use.</span></span> <span data-ttu-id="50e52-129">L’exemple de code suivant montre comment créer un HWND factice.</span><span class="sxs-lookup"><span data-stu-id="50e52-129">The following code example shows how to create a dummy HWND.</span></span>  
  
 [!code-cpp[System.Windows.Interop.D3DImage#RendererManager_EnsureHWND](~/samples/snippets/cpp/VS_Snippets_Wpf/System.Windows.Interop.D3DImage/cpp/renderermanager.cpp#renderermanager_ensurehwnd)]  
  
### <a name="present-parameters"></a><span data-ttu-id="50e52-130">Paramètres présents</span><span class="sxs-lookup"><span data-stu-id="50e52-130">Present Parameters</span></span>  
 <span data-ttu-id="50e52-131">La création d’un appareil nécessite également un struct `D3DPRESENT_PARAMETERS`, mais seuls quelques paramètres sont importants.</span><span class="sxs-lookup"><span data-stu-id="50e52-131">Creating a device also requires a `D3DPRESENT_PARAMETERS` struct, but only a few parameters are important.</span></span> <span data-ttu-id="50e52-132">Ces paramètres sont choisis pour réduire l’encombrement mémoire.</span><span class="sxs-lookup"><span data-stu-id="50e52-132">These parameters are chosen to minimize the memory footprint.</span></span>  
  
 <span data-ttu-id="50e52-133">Définissez les champs `BackBufferHeight` et `BackBufferWidth` sur 1.</span><span class="sxs-lookup"><span data-stu-id="50e52-133">Set the `BackBufferHeight` and `BackBufferWidth` fields to 1.</span></span> <span data-ttu-id="50e52-134">Si vous leur attribuez la valeur 0, elles sont définies sur les dimensions du HWND.</span><span class="sxs-lookup"><span data-stu-id="50e52-134">Setting them to 0 causes them to be set to the dimensions of the HWND.</span></span>  
  
 <span data-ttu-id="50e52-135">Définissez toujours les indicateurs `D3DCREATE_MULTITHREADED` et `D3DCREATE_FPU_PRESERVE` pour empêcher l’endommagement de la mémoire utilisée par Direct3D9 et empêcher Direct3D9 de modifier les paramètres FPU.</span><span class="sxs-lookup"><span data-stu-id="50e52-135">Always set the `D3DCREATE_MULTITHREADED` and `D3DCREATE_FPU_PRESERVE` flags to prevent corrupting memory used by Direct3D9 and to prevent Direct3D9 from changing FPU settings.</span></span>  
  
 <span data-ttu-id="50e52-136">Le code suivant montre comment initialiser le struct `D3DPRESENT_PARAMETERS`.</span><span class="sxs-lookup"><span data-stu-id="50e52-136">The following code shows how to initialize the `D3DPRESENT_PARAMETERS` struct.</span></span>  
  
 [!code-cpp[System.Windows.Interop.D3DImage#Renderer_Init](~/samples/snippets/cpp/VS_Snippets_Wpf/System.Windows.Interop.D3DImage/cpp/renderer.cpp#renderer_init)]  
  
## <a name="creating-the-back-buffer-render-target"></a><span data-ttu-id="50e52-137">Création de la cible de rendu de la mémoire tampon d’arrière-plan</span><span class="sxs-lookup"><span data-stu-id="50e52-137">Creating the Back Buffer Render Target</span></span>  
 <span data-ttu-id="50e52-138">Pour afficher le contenu Direct3D9 dans un <xref:System.Windows.Interop.D3DImage>, vous créez une surface Direct3D9 et l’attribuez en appelant la méthode <xref:System.Windows.Interop.D3DImage.SetBackBuffer%2A>.</span><span class="sxs-lookup"><span data-stu-id="50e52-138">To display Direct3D9 content in a <xref:System.Windows.Interop.D3DImage>, you create a Direct3D9 surface and assign it by calling the <xref:System.Windows.Interop.D3DImage.SetBackBuffer%2A> method.</span></span>  
  
### <a name="verifying-adapter-support"></a><span data-ttu-id="50e52-139">Vérification de la prise en charge des adaptateurs</span><span class="sxs-lookup"><span data-stu-id="50e52-139">Verifying Adapter Support</span></span>  
 <span data-ttu-id="50e52-140">Avant de créer une surface, vérifiez que tous les adaptateurs prennent en charge les propriétés de surface dont vous avez besoin.</span><span class="sxs-lookup"><span data-stu-id="50e52-140">Before creating a surface, verify that all adapters support the surface properties you require.</span></span> <span data-ttu-id="50e52-141">Même si vous affichez un seul adaptateur, la fenêtre WPF peut s’afficher sur n’importe quel adaptateur du système.</span><span class="sxs-lookup"><span data-stu-id="50e52-141">Even if you render to only one adapter, the WPF window may be displayed on any adapter in the system.</span></span> <span data-ttu-id="50e52-142">Vous devez toujours écrire du code Direct3D9 qui gère les configurations à plusieurs adaptateurs, et vous devez vérifier tous les adaptateurs pour la prise en charge, car WPF peut déplacer l’aire entre les adaptateurs disponibles.</span><span class="sxs-lookup"><span data-stu-id="50e52-142">You should always write Direct3D9 code that handles multi-adapter configurations, and you should check all adapters for support, because WPF might move the surface among the available adapters.</span></span>  
  
 <span data-ttu-id="50e52-143">L’exemple de code suivant montre comment vérifier tous les adaptateurs du système pour la prise en charge de Direct3D9.</span><span class="sxs-lookup"><span data-stu-id="50e52-143">The following code example shows how to check all adapters on the system for Direct3D9 support.</span></span>  
  
 [!code-cpp[System.Windows.Interop.D3DImage#RendererManager_TestSurfaceSettings](~/samples/snippets/cpp/VS_Snippets_Wpf/System.Windows.Interop.D3DImage/cpp/renderermanager.cpp#renderermanager_testsurfacesettings)]  
  
### <a name="creating-the-surface"></a><span data-ttu-id="50e52-144">Création de la surface</span><span class="sxs-lookup"><span data-stu-id="50e52-144">Creating the Surface</span></span>  
 <span data-ttu-id="50e52-145">Avant de créer une surface, vérifiez que les fonctionnalités de l’appareil prennent en charge de bonnes performances sur le système d’exploitation cible.</span><span class="sxs-lookup"><span data-stu-id="50e52-145">Before creating a surface, verify that the device capabilities support good performance on the target operating system.</span></span> <span data-ttu-id="50e52-146">Pour plus d’informations, consultez [Considérations sur les performances pour l’interopérabilité entre Direct3D9 et WPF](performance-considerations-for-direct3d9-and-wpf-interoperability.md).</span><span class="sxs-lookup"><span data-stu-id="50e52-146">For more information, see [Performance Considerations for Direct3D9 and WPF Interoperability](performance-considerations-for-direct3d9-and-wpf-interoperability.md).</span></span>  
  
 <span data-ttu-id="50e52-147">Une fois que vous avez vérifié les fonctionnalités de l’appareil, vous pouvez créer l’aire.</span><span class="sxs-lookup"><span data-stu-id="50e52-147">When you have verified device capabilities, you can create the surface.</span></span> <span data-ttu-id="50e52-148">L’exemple de code suivant montre comment créer la cible de rendu.</span><span class="sxs-lookup"><span data-stu-id="50e52-148">The following code example shows how to create the render target.</span></span>  
  
 [!code-cpp[System.Windows.Interop.D3DImage#Renderer_CreateSurface](~/samples/snippets/cpp/VS_Snippets_Wpf/System.Windows.Interop.D3DImage/cpp/renderer.cpp#renderer_createsurface)]  
  
### <a name="wddm"></a><span data-ttu-id="50e52-149">WDDM</span><span class="sxs-lookup"><span data-stu-id="50e52-149">WDDM</span></span>  
 <span data-ttu-id="50e52-150">Sur les systèmes d’exploitation Windows Vista et versions ultérieures, qui sont configurés pour utiliser le WDDM, vous pouvez créer une texture de cible de rendu et passer la surface de niveau 0 à la méthode <xref:System.Windows.Interop.D3DImage.SetBackBuffer%2A>.</span><span class="sxs-lookup"><span data-stu-id="50e52-150">On Windows Vista and later operating systems, which are configured to use the WDDM, you can create a render target texture and pass the level 0 surface to the <xref:System.Windows.Interop.D3DImage.SetBackBuffer%2A> method.</span></span> <span data-ttu-id="50e52-151">Cette approche n’est pas recommandée sur Windows XP, car vous ne pouvez pas créer une texture de cible de rendu verrouillable et les performances seront réduites.</span><span class="sxs-lookup"><span data-stu-id="50e52-151">This approach is not recommended on Windows XP, because you cannot create a lockable render target texture and performance will be reduced.</span></span>  
  
## <a name="handling-device-state"></a><span data-ttu-id="50e52-152">Gestion de l’état de l’appareil</span><span class="sxs-lookup"><span data-stu-id="50e52-152">Handling Device State</span></span>  
 <span data-ttu-id="50e52-153">La classe <xref:System.Windows.Interop.D3DImage> gère deux mémoires tampons d’affichage, appelées *mémoire tampon d’arrière* - *plan et mémoire tampon*d’arrière-plan.</span><span class="sxs-lookup"><span data-stu-id="50e52-153">The <xref:System.Windows.Interop.D3DImage> class manages two display buffers, which are called the *back buffer* and the *front buffer*.</span></span> <span data-ttu-id="50e52-154">La mémoire tampon d’arrière-plan est votre surface Direct3D.</span><span class="sxs-lookup"><span data-stu-id="50e52-154">The back buffer is your Direct3D surface.</span></span>  <span data-ttu-id="50e52-155">Les modifications apportées à la mémoire tampon d’arrière-plan sont copiées par progression vers la mémoire tampon d’origine lorsque vous appelez la méthode <xref:System.Windows.Interop.D3DImage.Unlock%2A>, où elle est affichée sur le matériel.</span><span class="sxs-lookup"><span data-stu-id="50e52-155">Changes to the back buffer are copied forward to the front buffer when you call the <xref:System.Windows.Interop.D3DImage.Unlock%2A> method, where it is displayed on the hardware.</span></span> <span data-ttu-id="50e52-156">Parfois, le tampon d’avant devient indisponible.</span><span class="sxs-lookup"><span data-stu-id="50e52-156">Occasionally, the front buffer becomes unavailable.</span></span> <span data-ttu-id="50e52-157">Ce manque de disponibilité peut être dû à un verrouillage d’écran, à des applications Direct3D exclusives en plein écran, à une commutation utilisateur ou à d’autres activités système.</span><span class="sxs-lookup"><span data-stu-id="50e52-157">This lack of availability can be caused by screen locking, full-screen exclusive Direct3D applications, user-switching, or other system activities.</span></span> <span data-ttu-id="50e52-158">Lorsque cela se produit, votre application WPF est notifiée en gérant l’événement <xref:System.Windows.Interop.D3DImage.IsFrontBufferAvailableChanged>.</span><span class="sxs-lookup"><span data-stu-id="50e52-158">When this occurs, your WPF application is notified by handling the <xref:System.Windows.Interop.D3DImage.IsFrontBufferAvailableChanged> event.</span></span>  <span data-ttu-id="50e52-159">La façon dont votre application répond à la mémoire tampon d’arrière-plan devient indisponible varie selon que WPF est activé pour revenir au rendu logiciel.</span><span class="sxs-lookup"><span data-stu-id="50e52-159">How your application responds to the front buffer becoming unavailable depends on whether WPF is enabled to fall back to software rendering.</span></span> <span data-ttu-id="50e52-160">La méthode <xref:System.Windows.Interop.D3DImage.SetBackBuffer%2A> a une surcharge qui prend un paramètre qui spécifie si WPF revient au rendu logiciel.</span><span class="sxs-lookup"><span data-stu-id="50e52-160">The <xref:System.Windows.Interop.D3DImage.SetBackBuffer%2A> method has an overload that takes a parameter that specifies whether WPF falls back to software rendering.</span></span>  
  
 <span data-ttu-id="50e52-161">Quand vous appelez la surcharge <xref:System.Windows.Interop.D3DImage.SetBackBuffer%28System.Windows.Interop.D3DResourceType%2CSystem.IntPtr%29> ou que vous appelez la surcharge de <xref:System.Windows.Interop.D3DImage.SetBackBuffer%28System.Windows.Interop.D3DResourceType%2CSystem.IntPtr%2CSystem.Boolean%29> avec le paramètre `enableSoftwareFallback` défini sur `false`, le système de rendu libère sa référence à la mémoire tampon d’arrière-plan lorsque la mémoire tampon d’arrière-plan devient indisponible et rien ne s’affiche.</span><span class="sxs-lookup"><span data-stu-id="50e52-161">When you call the <xref:System.Windows.Interop.D3DImage.SetBackBuffer%28System.Windows.Interop.D3DResourceType%2CSystem.IntPtr%29> overload or call the <xref:System.Windows.Interop.D3DImage.SetBackBuffer%28System.Windows.Interop.D3DResourceType%2CSystem.IntPtr%2CSystem.Boolean%29> overload with the `enableSoftwareFallback` parameter set to `false`, the rendering system releases its reference to the back buffer when the front buffer becomes unavailable and nothing is displayed.</span></span> <span data-ttu-id="50e52-162">Lorsque le tampon d’avant est à nouveau disponible, le système de rendu déclenche l’événement <xref:System.Windows.Interop.D3DImage.IsFrontBufferAvailableChanged> pour notifier votre application WPF.</span><span class="sxs-lookup"><span data-stu-id="50e52-162">When the front buffer is available again, the rendering system raises the <xref:System.Windows.Interop.D3DImage.IsFrontBufferAvailableChanged> event to notify your WPF application.</span></span>  <span data-ttu-id="50e52-163">Vous pouvez créer un gestionnaire d’événements pour l’événement <xref:System.Windows.Interop.D3DImage.IsFrontBufferAvailableChanged> pour redémarrer le rendu avec une surface Direct3D valide.</span><span class="sxs-lookup"><span data-stu-id="50e52-163">You can create an event handler for the <xref:System.Windows.Interop.D3DImage.IsFrontBufferAvailableChanged> event to restart rendering again with a valid Direct3D surface.</span></span> <span data-ttu-id="50e52-164">Pour redémarrer le rendu, vous devez appeler <xref:System.Windows.Interop.D3DImage.SetBackBuffer%2A>.</span><span class="sxs-lookup"><span data-stu-id="50e52-164">To restart rendering, you must call <xref:System.Windows.Interop.D3DImage.SetBackBuffer%2A>.</span></span>  
  
 <span data-ttu-id="50e52-165">Quand vous appelez la surcharge <xref:System.Windows.Interop.D3DImage.SetBackBuffer%28System.Windows.Interop.D3DResourceType%2CSystem.IntPtr%2CSystem.Boolean%29> avec le paramètre `enableSoftwareFallback` défini sur `true`, le système de rendu conserve sa référence à la mémoire tampon d’arrière-plan lorsque la mémoire tampon d’arrière-plan devient indisponible. il n’est donc pas nécessaire d’appeler <xref:System.Windows.Interop.D3DImage.SetBackBuffer%2A> lorsque le tampon d’avant est à nouveau disponible.</span><span class="sxs-lookup"><span data-stu-id="50e52-165">When you call the <xref:System.Windows.Interop.D3DImage.SetBackBuffer%28System.Windows.Interop.D3DResourceType%2CSystem.IntPtr%2CSystem.Boolean%29> overload with the `enableSoftwareFallback` parameter set to `true`, the rendering system retains its reference to the back buffer when the front buffer becomes unavailable, so there is no need to call <xref:System.Windows.Interop.D3DImage.SetBackBuffer%2A> when the front buffer is available again.</span></span>  
  
 <span data-ttu-id="50e52-166">Lorsque le rendu logiciel est activé, il peut y avoir des situations où l’appareil de l’utilisateur devient indisponible, mais le système de rendu conserve une référence à la surface Direct3D.</span><span class="sxs-lookup"><span data-stu-id="50e52-166">When software rendering is enabled, there may be situations where the user’s device becomes unavailable, but the rendering system retains a reference to the Direct3D surface.</span></span> <span data-ttu-id="50e52-167">Pour vérifier si un appareil Direct3D9 n’est pas disponible, appelez la méthode `TestCooperativeLevel`.</span><span class="sxs-lookup"><span data-stu-id="50e52-167">To check whether a Direct3D9 device is unavailable, call the `TestCooperativeLevel` method.</span></span> <span data-ttu-id="50e52-168">Pour vérifier qu’un appareil Direct3D9Ex appelle la méthode `CheckDeviceState`, parce que la méthode `TestCooperativeLevel` est déconseillée et retourne toujours Success.</span><span class="sxs-lookup"><span data-stu-id="50e52-168">To check a Direct3D9Ex devices call the `CheckDeviceState` method, because the `TestCooperativeLevel` method is deprecated and always returns success.</span></span> <span data-ttu-id="50e52-169">Si l’appareil de l’utilisateur n’est plus disponible, appelez <xref:System.Windows.Interop.D3DImage.SetBackBuffer%2A> pour libérer la référence du WPF à la mémoire tampon d’arrière-plan.</span><span class="sxs-lookup"><span data-stu-id="50e52-169">If the user device has become unavailable, call <xref:System.Windows.Interop.D3DImage.SetBackBuffer%2A> to release WPF’s reference to the back buffer.</span></span>  <span data-ttu-id="50e52-170">Si vous devez réinitialiser votre appareil, appelez <xref:System.Windows.Interop.D3DImage.SetBackBuffer%2A> avec le paramètre `backBuffer` défini sur `null`, puis appelez à nouveau <xref:System.Windows.Interop.D3DImage.SetBackBuffer%2A> avec `backBuffer` défini sur une surface Direct3D valide.</span><span class="sxs-lookup"><span data-stu-id="50e52-170">If you need to reset your device, call <xref:System.Windows.Interop.D3DImage.SetBackBuffer%2A> with the `backBuffer` parameter set to `null`, and then call <xref:System.Windows.Interop.D3DImage.SetBackBuffer%2A> again with `backBuffer` set to a valid Direct3D surface.</span></span>  
  
 <span data-ttu-id="50e52-171">Appelez la méthode `Reset` pour récupérer à partir d’un appareil non valide uniquement si vous implémentez la prise en charge de plusieurs adaptateurs.</span><span class="sxs-lookup"><span data-stu-id="50e52-171">Call the `Reset` method to recover from an invalid device only if you implement multi-adapter support.</span></span> <span data-ttu-id="50e52-172">Dans le cas contraire, libérez toutes les interfaces Direct3D9, puis recréez-les entièrement.</span><span class="sxs-lookup"><span data-stu-id="50e52-172">Otherwise, release all Direct3D9 interfaces and re-create them completely.</span></span> <span data-ttu-id="50e52-173">Si la disposition de l’adaptateur a changé, les objets Direct3D9 créés avant la modification ne sont pas mis à jour.</span><span class="sxs-lookup"><span data-stu-id="50e52-173">If the adapter layout has changed, Direct3D9 objects created before the change are not updated.</span></span>  
  
## <a name="handling-resizing"></a><span data-ttu-id="50e52-174">Gérer le redimensionnement</span><span class="sxs-lookup"><span data-stu-id="50e52-174">Handling Resizing</span></span>  
 <span data-ttu-id="50e52-175">Si un <xref:System.Windows.Interop.D3DImage> est affiché dans une résolution autre que sa taille native, il est mis à l’échelle en fonction du <xref:System.Windows.Media.RenderOptions.BitmapScalingMode%2A>actuel, sauf que <xref:System.Windows.Media.Effects.SamplingMode.Bilinear> remplace <xref:System.Windows.Media.BitmapScalingMode.Fant>.</span><span class="sxs-lookup"><span data-stu-id="50e52-175">If a <xref:System.Windows.Interop.D3DImage> is displayed at a resolution other than its native size, it is scaled according to the current <xref:System.Windows.Media.RenderOptions.BitmapScalingMode%2A>, except that <xref:System.Windows.Media.Effects.SamplingMode.Bilinear> is substituted for <xref:System.Windows.Media.BitmapScalingMode.Fant>.</span></span>  
  
 <span data-ttu-id="50e52-176">Si vous avez besoin d’une meilleure fidélité, vous devez créer une nouvelle surface lorsque le conteneur du <xref:System.Windows.Interop.D3DImage> change de taille.</span><span class="sxs-lookup"><span data-stu-id="50e52-176">If you require higher fidelity, you must create a new surface when the container of the <xref:System.Windows.Interop.D3DImage> changes size.</span></span>  
  
 <span data-ttu-id="50e52-177">Il existe trois approches possibles pour gérer le redimensionnement.</span><span class="sxs-lookup"><span data-stu-id="50e52-177">There are three possible approaches to handle resizing.</span></span>  
  
- <span data-ttu-id="50e52-178">Participez au système de disposition et créez une nouvelle surface lorsque la taille change.</span><span class="sxs-lookup"><span data-stu-id="50e52-178">Participate in the layout system and create a new surface when the size changes.</span></span> <span data-ttu-id="50e52-179">Ne créez pas trop de surfaces, car vous risquez d’épuiser ou de fragmenter la mémoire vidéo.</span><span class="sxs-lookup"><span data-stu-id="50e52-179">Do not create too many surfaces, because you may exhaust or fragment video memory.</span></span>  
  
- <span data-ttu-id="50e52-180">Attendez qu’un événement de redimensionnement n’ait pas eu lieu pendant une période fixe pour créer la nouvelle surface.</span><span class="sxs-lookup"><span data-stu-id="50e52-180">Wait until a resize event has not occurred for a fixed period of time to create the new surface.</span></span>  
  
- <span data-ttu-id="50e52-181">Créez un <xref:System.Windows.Threading.DispatcherTimer> qui vérifie les dimensions de conteneur plusieurs fois par seconde.</span><span class="sxs-lookup"><span data-stu-id="50e52-181">Create a <xref:System.Windows.Threading.DispatcherTimer> that checks the container dimensions several times per second.</span></span>  
  
## <a name="multi-monitor-optimization"></a><span data-ttu-id="50e52-182">Optimisation de plusieurs moniteurs</span><span class="sxs-lookup"><span data-stu-id="50e52-182">Multi-monitor Optimization</span></span>  
 <span data-ttu-id="50e52-183">Une baisse significative des performances peut se produire lorsque le système de rendu déplace un <xref:System.Windows.Interop.D3DImage> vers un autre moniteur.</span><span class="sxs-lookup"><span data-stu-id="50e52-183">Significantly reduced performance can result when the rendering system moves a <xref:System.Windows.Interop.D3DImage> to another monitor.</span></span>  
  
 <span data-ttu-id="50e52-184">Sur WDDM, à condition que les moniteurs se trouvent sur la même carte vidéo et que vous utilisiez `Direct3DCreate9Ex`, les performances ne sont pas réduites.</span><span class="sxs-lookup"><span data-stu-id="50e52-184">On WDDM, as long as the monitors are on the same video card and you use `Direct3DCreate9Ex`, there is no reduction in performance.</span></span> <span data-ttu-id="50e52-185">Si les moniteurs se trouvent sur des cartes vidéo distinctes, les performances sont réduites.</span><span class="sxs-lookup"><span data-stu-id="50e52-185">If the monitors are on separate video cards, performance is reduced.</span></span> <span data-ttu-id="50e52-186">Sur Windows XP, les performances sont toujours réduites.</span><span class="sxs-lookup"><span data-stu-id="50e52-186">On Windows XP, performance is always reduced.</span></span>  
  
 <span data-ttu-id="50e52-187">Lorsque le <xref:System.Windows.Interop.D3DImage> passe à un autre moniteur, vous pouvez créer une nouvelle surface sur l’adaptateur correspondant pour restaurer de bonnes performances.</span><span class="sxs-lookup"><span data-stu-id="50e52-187">When the <xref:System.Windows.Interop.D3DImage> moves to another monitor, you can create a new surface on the corresponding adapter to restore good performance.</span></span>  
  
 <span data-ttu-id="50e52-188">Pour éviter la perte de performances, écrivez du code spécifiquement pour le cas de plusieurs écrans.</span><span class="sxs-lookup"><span data-stu-id="50e52-188">To avoid the performance penalty, write code specifically for the multi-monitor case.</span></span> <span data-ttu-id="50e52-189">La liste suivante illustre une façon d’écrire du code à plusieurs écrans.</span><span class="sxs-lookup"><span data-stu-id="50e52-189">The following list shows one way to write multi-monitor code.</span></span>  
  
1. <span data-ttu-id="50e52-190">Recherchez un point de la <xref:System.Windows.Interop.D3DImage> dans l’espace à l’écran avec la méthode `Visual.ProjectToScreen`.</span><span class="sxs-lookup"><span data-stu-id="50e52-190">Find a point of the <xref:System.Windows.Interop.D3DImage> in screen space with the `Visual.ProjectToScreen` method.</span></span>  
  
2. <span data-ttu-id="50e52-191">Utilisez la méthode GDI `MonitorFromPoint` pour rechercher le moniteur qui affiche le point.</span><span class="sxs-lookup"><span data-stu-id="50e52-191">Use the `MonitorFromPoint` GDI method to find the monitor that is displaying the point.</span></span>  
  
3. <span data-ttu-id="50e52-192">Utilisez la méthode `IDirect3D9::GetAdapterMonitor` pour Rechercher l’adaptateur Direct3D9 sur lequel l’analyse est activée.</span><span class="sxs-lookup"><span data-stu-id="50e52-192">Use the `IDirect3D9::GetAdapterMonitor` method to find which Direct3D9 adapter the monitor is on.</span></span>  
  
4. <span data-ttu-id="50e52-193">Si l’adaptateur n’est pas le même que l’adaptateur avec la mémoire tampon d’arrière-plan, créez une nouvelle mémoire tampon d’arrière-plan sur le nouvel écran et affectez-la au <xref:System.Windows.Interop.D3DImage> mémoire tampon d’arrière-plan.</span><span class="sxs-lookup"><span data-stu-id="50e52-193">If the adapter is not the same as the adapter with the back buffer, create a new back buffer on the new monitor and assign it to the <xref:System.Windows.Interop.D3DImage> back buffer.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="50e52-194">Si le <xref:System.Windows.Interop.D3DImage> passe sur les moniteurs, les performances sont lentes, sauf dans le cas de WDDM et `IDirect3D9Ex` sur le même adaptateur.</span><span class="sxs-lookup"><span data-stu-id="50e52-194">If the <xref:System.Windows.Interop.D3DImage> straddles monitors, performance will be slow, except in the case of WDDM and `IDirect3D9Ex` on the same adapter.</span></span> <span data-ttu-id="50e52-195">Il n’existe aucun moyen d’améliorer les performances dans cette situation.</span><span class="sxs-lookup"><span data-stu-id="50e52-195">There is no way to improve performance in this situation.</span></span>  
  
 <span data-ttu-id="50e52-196">L’exemple de code suivant montre comment rechercher le moniteur en cours.</span><span class="sxs-lookup"><span data-stu-id="50e52-196">The following code example shows how to find the current monitor.</span></span>  
  
 [!code-cpp[System.Windows.Interop.D3DImage#RendererManager_SetAdapter](~/samples/snippets/cpp/VS_Snippets_Wpf/System.Windows.Interop.D3DImage/cpp/renderermanager.cpp#renderermanager_setadapter)]  
  
 <span data-ttu-id="50e52-197">Mettez à jour le moniteur lorsque la taille ou la position du conteneur <xref:System.Windows.Interop.D3DImage> change, ou mettez à jour le moniteur à l’aide d’un `DispatcherTimer` qui se met à jour plusieurs fois par seconde.</span><span class="sxs-lookup"><span data-stu-id="50e52-197">Update the monitor when the <xref:System.Windows.Interop.D3DImage> container's size or position changes, or update the monitor by using a `DispatcherTimer` that updates a few times per second.</span></span>  
  
## <a name="wpf-software-rendering"></a><span data-ttu-id="50e52-198">Rendu logiciel WPF</span><span class="sxs-lookup"><span data-stu-id="50e52-198">WPF Software Rendering</span></span>  
 <span data-ttu-id="50e52-199">WPF est rendu de façon synchrone sur le thread d’interface utilisateur dans les logiciels dans les cas suivants.</span><span class="sxs-lookup"><span data-stu-id="50e52-199">WPF renders synchronously on the UI thread in software in the following situations.</span></span>  
  
- <span data-ttu-id="50e52-200">Impression</span><span class="sxs-lookup"><span data-stu-id="50e52-200">Printing</span></span>  
  
- <xref:System.Windows.Media.Effects.BitmapEffect>  
  
- <xref:System.Windows.Media.Imaging.RenderTargetBitmap>  
  
 <span data-ttu-id="50e52-201">Lorsque l’une de ces situations se produit, le système de rendu appelle la méthode <xref:System.Windows.Interop.D3DImage.CopyBackBuffer%2A> pour copier la mémoire tampon matérielle sur le logiciel.</span><span class="sxs-lookup"><span data-stu-id="50e52-201">When one of these situations occurs, the rendering system calls the <xref:System.Windows.Interop.D3DImage.CopyBackBuffer%2A> method to copy the hardware buffer to software.</span></span> <span data-ttu-id="50e52-202">L’implémentation par défaut appelle la méthode `GetRenderTargetData` avec votre surface.</span><span class="sxs-lookup"><span data-stu-id="50e52-202">The default implementation calls the `GetRenderTargetData` method with your surface.</span></span> <span data-ttu-id="50e52-203">Dans la mesure où cet appel se produit en dehors du modèle de verrouillage/déverrouillage, il peut échouer.</span><span class="sxs-lookup"><span data-stu-id="50e52-203">Because this call occurs outside of the Lock/Unlock pattern, it may fail.</span></span> <span data-ttu-id="50e52-204">Dans ce cas, la méthode `CopyBackBuffer` retourne `null` et aucune image n’est affichée.</span><span class="sxs-lookup"><span data-stu-id="50e52-204">In this case, the `CopyBackBuffer` method returns `null` and no image is displayed.</span></span>  
  
 <span data-ttu-id="50e52-205">Vous pouvez substituer la méthode <xref:System.Windows.Interop.D3DImage.CopyBackBuffer%2A>, appeler l’implémentation de base et, si elle retourne `null`, vous pouvez retourner un espace réservé <xref:System.Windows.Media.Imaging.BitmapSource>.</span><span class="sxs-lookup"><span data-stu-id="50e52-205">You can override the <xref:System.Windows.Interop.D3DImage.CopyBackBuffer%2A> method, call the base implementation, and if it returns `null`, you can return a placeholder <xref:System.Windows.Media.Imaging.BitmapSource>.</span></span>  
  
 <span data-ttu-id="50e52-206">Vous pouvez également implémenter votre propre rendu logiciel au lieu d’appeler l’implémentation de base.</span><span class="sxs-lookup"><span data-stu-id="50e52-206">You can also implement your own software rendering instead of calling the base implementation.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="50e52-207">Si WPF effectue un rendu complet dans le logiciel, <xref:System.Windows.Interop.D3DImage> n’est pas affiché, car WPF n’a pas de mémoire tampon d’avant.</span><span class="sxs-lookup"><span data-stu-id="50e52-207">If WPF is rendering completely in software, <xref:System.Windows.Interop.D3DImage> is not shown because WPF does not have a front buffer.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="50e52-208">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="50e52-208">See also</span></span>

- <xref:System.Windows.Interop.D3DImage>
- [<span data-ttu-id="50e52-209">Considérations sur les performances de l'interopérabilité entre Direct3D9 et WPF</span><span class="sxs-lookup"><span data-stu-id="50e52-209">Performance Considerations for Direct3D9 and WPF Interoperability</span></span>](performance-considerations-for-direct3d9-and-wpf-interoperability.md)
- [<span data-ttu-id="50e52-210">Procédure pas à pas : création de contenu Direct3D9 à héberger dans WPF</span><span class="sxs-lookup"><span data-stu-id="50e52-210">Walkthrough: Creating Direct3D9 Content for Hosting in WPF</span></span>](walkthrough-creating-direct3d9-content-for-hosting-in-wpf.md)
- [<span data-ttu-id="50e52-211">Procédure pas à pas : hébergement de contenu Direct3D9 dans WPF</span><span class="sxs-lookup"><span data-stu-id="50e52-211">Walkthrough: Hosting Direct3D9 Content in WPF</span></span>](walkthrough-hosting-direct3d9-content-in-wpf.md)
