---
title: 'Procédure : créer un jeton personnalisé'
description: Découvrez comment créer un jeton de sécurité personnalisé dans WCF à l’aide de la classe SecurityToken et comment l’intégrer à un fournisseur de jetons de sécurité et à un authentificateur.
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- SecurityTokenParameters class
- security [WCF], creating custom tokens
- WSSecurityTokenSerializer class
- SecurityToken class
ms.assetid: 6d892973-1558-4115-a9e1-696777776125
ms.openlocfilehash: e0d80fe2433d894ef1f9e110e9090701dc305d8e
ms.sourcegitcommit: bc293b14af795e0e999e3304dd40c0222cf2ffe4
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 11/26/2020
ms.locfileid: "96266751"
---
# <a name="how-to-create-a-custom-token"></a><span data-ttu-id="1e539-103">Procédure : créer un jeton personnalisé</span><span class="sxs-lookup"><span data-stu-id="1e539-103">How to: Create a Custom Token</span></span>

<span data-ttu-id="1e539-104">Cette rubrique contient des instructions permettant de créer un jeton de sécurité personnalisé à l'aide de la classe <xref:System.IdentityModel.Tokens.SecurityToken> et de l'intégrer à un fournisseur et authentificateur de jetons de sécurité personnalisés.</span><span class="sxs-lookup"><span data-stu-id="1e539-104">This topic shows how to create a custom security token using the <xref:System.IdentityModel.Tokens.SecurityToken> class, and how to integrate it with a custom security token provider and authenticator.</span></span> <span data-ttu-id="1e539-105">Pour obtenir un exemple de code complet, consultez l’exemple de [jeton personnalisé](../samples/custom-token.md) .</span><span class="sxs-lookup"><span data-stu-id="1e539-105">For a complete code example see the [Custom Token](../samples/custom-token.md) sample.</span></span>  
  
 <span data-ttu-id="1e539-106">Un *jeton de sécurité* est essentiellement un élément XML utilisé par l’infrastructure de sécurité Windows Communication Foundation (WCF) pour représenter les revendications relatives à un expéditeur à l’intérieur du message SOAP.</span><span class="sxs-lookup"><span data-stu-id="1e539-106">A *security token* is essentially an XML element that is used by the Windows Communication Foundation (WCF) security framework to represent claims about a sender inside the SOAP message.</span></span> <span data-ttu-id="1e539-107">La sécurité WCF fournit différents jetons pour les modes d’authentification fournis par le système.</span><span class="sxs-lookup"><span data-stu-id="1e539-107">WCF security provides various tokens for system-provided authentication modes.</span></span> <span data-ttu-id="1e539-108">Les exemples comprennent un jeton de sécurité de certificat X.509 représenté par la classe <xref:System.IdentityModel.Tokens.X509SecurityToken> ou un jeton de sécurité de nom d'utilisateur représenté par la classe <xref:System.IdentityModel.Tokens.UserNameSecurityToken>.</span><span class="sxs-lookup"><span data-stu-id="1e539-108">Examples include an X.509 certificate security token represented by the <xref:System.IdentityModel.Tokens.X509SecurityToken> class or a Username security token represented by the <xref:System.IdentityModel.Tokens.UserNameSecurityToken> class.</span></span>  
  
 <span data-ttu-id="1e539-109">Il peut arriver qu'un mode d'authentification ou que des informations d'identification ne soient pas prises en charge par les types fournis.</span><span class="sxs-lookup"><span data-stu-id="1e539-109">Sometimes an authentication mode or credential is not supported by the provided types.</span></span> <span data-ttu-id="1e539-110">Dans un tel cas, il est nécessaire de créer un jeton de sécurité personnalisé permettant de fournir une représentation XML des informations d'identification personnalisées dans les messages SOAP.</span><span class="sxs-lookup"><span data-stu-id="1e539-110">In that case, it is necessary to create a custom security token to provide an XML representation of the custom credential inside the SOAP message.</span></span>  
  
 <span data-ttu-id="1e539-111">Les procédures suivantes montrent comment créer un jeton de sécurité personnalisé et comment l’intégrer à l’infrastructure de sécurité WCF.</span><span class="sxs-lookup"><span data-stu-id="1e539-111">The following procedures show how to create a custom security token and how to integrate it with the WCF security infrastructure.</span></span> <span data-ttu-id="1e539-112">Cette rubrique contient des instructions permettant de créer un jeton de carte de crédit utilisé pour passer des informations relatives à la carte de crédit du client au serveur.</span><span class="sxs-lookup"><span data-stu-id="1e539-112">This topic creates a credit card token that is used to pass information about the client's credit card to the server.</span></span>  
  
 <span data-ttu-id="1e539-113">Pour plus d’informations sur les informations d’identification personnalisées et le gestionnaire de jetons de sécurité, consultez [procédure pas à pas : création d’informations d’identification de service et de client personnalisées](walkthrough-creating-custom-client-and-service-credentials.md).</span><span class="sxs-lookup"><span data-stu-id="1e539-113">For more information about custom credentials and security token manager, see [Walkthrough: Creating Custom Client and Service Credentials](walkthrough-creating-custom-client-and-service-credentials.md).</span></span>  
  
 <span data-ttu-id="1e539-114">Consultez l'espace de noms <xref:System.IdentityModel.Tokens> pour obtenir davantage de classes représentant des jetons de sécurité.</span><span class="sxs-lookup"><span data-stu-id="1e539-114">See the <xref:System.IdentityModel.Tokens> namespace for more classes that represent security tokens.</span></span>  
  
## <a name="procedures"></a><span data-ttu-id="1e539-115">Procédures</span><span class="sxs-lookup"><span data-stu-id="1e539-115">Procedures</span></span>  

 <span data-ttu-id="1e539-116">Une application cliente doit être créée de manière à permettre la spécification d'informations de carte de crédit pour l'infrastructure de sécurité.</span><span class="sxs-lookup"><span data-stu-id="1e539-116">A client application must be provided with a way to specify credit card information for the security infrastructure.</span></span> <span data-ttu-id="1e539-117">Une classe d'informations d'identification client personnalisées permet à l'application d'accéder à ces informations.</span><span class="sxs-lookup"><span data-stu-id="1e539-117">This information is made available to the application by a custom client credentials class.</span></span> <span data-ttu-id="1e539-118">La première étape consiste à créer une classe qui représente les informations de carte de crédit au sein des informations d'identification client personnalisées.</span><span class="sxs-lookup"><span data-stu-id="1e539-118">The first step is to create a class to represent the credit card information for custom client credentials.</span></span>  
  
#### <a name="to-create-a-class-that-represents-credit-card-information-inside-client-credentials"></a><span data-ttu-id="1e539-119">Pour créer une classe qui représente les informations de carte de crédit au sein des informations d'identification client.</span><span class="sxs-lookup"><span data-stu-id="1e539-119">To create a class that represents credit card information inside client credentials</span></span>  
  
1. <span data-ttu-id="1e539-120">Définissez une nouvelle classe qui représente les informations de carte de crédit pour l'application.</span><span class="sxs-lookup"><span data-stu-id="1e539-120">Define a new class that represents the credit card information for the application.</span></span> <span data-ttu-id="1e539-121">L'exemple suivant nomme la classe `CreditCardInfo`.</span><span class="sxs-lookup"><span data-stu-id="1e539-121">The following example names the class `CreditCardInfo`.</span></span>  
  
2. <span data-ttu-id="1e539-122">Ajoutez les propriétés adéquates à cette classe pour permettre à une application de définir les informations requises pour le jeton personnalisé.</span><span class="sxs-lookup"><span data-stu-id="1e539-122">Add appropriate properties to the class to allow an application set the necessary information required for the custom token.</span></span> <span data-ttu-id="1e539-123">Dans notre exemple, cette classe dispose de trois propriétés : `CardNumber`, `CardIssuer` et `ExpirationDate`.</span><span class="sxs-lookup"><span data-stu-id="1e539-123">In this example, the class has three properties: `CardNumber`, `CardIssuer`, and `ExpirationDate`.</span></span>  
  
     [!code-csharp[c_CustomToken#4](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#4)]
     [!code-vb[c_CustomToken#4](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#4)]  
  
 <span data-ttu-id="1e539-124">Vous devez ensuite créer une classe qui représente le jeton de sécurité personnalisé.</span><span class="sxs-lookup"><span data-stu-id="1e539-124">Next, a class that represents the custom security token must be created.</span></span> <span data-ttu-id="1e539-125">Cette classe est utilisée par le fournisseur de jetons de sécurité, l’authentificateur et les classes de sérialiseur pour transmettre des informations sur le jeton de sécurité depuis et vers l’infrastructure de sécurité WCF.</span><span class="sxs-lookup"><span data-stu-id="1e539-125">This class is used by the security token provider, authenticator, and serializer classes to pass information about the security token to and from the WCF security infrastructure.</span></span>  
  
#### <a name="to-create-a-custom-security-token-class"></a><span data-ttu-id="1e539-126">Pour créer une classe de jeton de sécurité personnalisé</span><span class="sxs-lookup"><span data-stu-id="1e539-126">To create a custom security token class</span></span>  
  
1. <span data-ttu-id="1e539-127">Définissez une nouvelle classe dérivée de la classe <xref:System.IdentityModel.Tokens.SecurityToken>.</span><span class="sxs-lookup"><span data-stu-id="1e539-127">Define a new class derived from the <xref:System.IdentityModel.Tokens.SecurityToken> class.</span></span> <span data-ttu-id="1e539-128">Cet exemple crée une classe nommée `CreditCardToken`.</span><span class="sxs-lookup"><span data-stu-id="1e539-128">This example creates a class named `CreditCardToken`.</span></span>  
  
2. <span data-ttu-id="1e539-129">Remplacez la propriété <xref:System.IdentityModel.Tokens.SecurityToken.Id%2A>.</span><span class="sxs-lookup"><span data-stu-id="1e539-129">Override the <xref:System.IdentityModel.Tokens.SecurityToken.Id%2A> property.</span></span> <span data-ttu-id="1e539-130">Cette propriété est utilisée pour obtenir l'identificateur local du jeton de sécurité qui permet de renvoyer à la représentation XML de ce dernier à partir des autres éléments figurant dans les messages SOAP.</span><span class="sxs-lookup"><span data-stu-id="1e539-130">This property is used to get the local identifier of the security token that is used to point to the security token XML representation from other elements inside the SOAP message.</span></span> <span data-ttu-id="1e539-131">Dans cet exemple, l'identificateur de jeton peut être passé à cette propriété comme paramètre de constructeur ou un nouvel identificateur aléatoire est généré à chaque fois qu'une instance de jeton de sécurité est créée.</span><span class="sxs-lookup"><span data-stu-id="1e539-131">In this example, a token identifier can be either passed to it as a constructor parameter or a new random one is generated every time a security token instance is created.</span></span>  
  
3. <span data-ttu-id="1e539-132">Implémentez la propriété <xref:System.IdentityModel.Tokens.SecurityToken.SecurityKeys%2A>.</span><span class="sxs-lookup"><span data-stu-id="1e539-132">Implement the <xref:System.IdentityModel.Tokens.SecurityToken.SecurityKeys%2A> property.</span></span> <span data-ttu-id="1e539-133">Cette propriété retourne une collection de clés de sécurité représentée par l'instance de jeton de sécurité.</span><span class="sxs-lookup"><span data-stu-id="1e539-133">This property returns a collection of security keys that the security token instance represents.</span></span> <span data-ttu-id="1e539-134">Ces clés peuvent être utilisées par WCF pour signer ou chiffrer des parties du message SOAP.</span><span class="sxs-lookup"><span data-stu-id="1e539-134">Such keys can be used by WCF to sign or encrypt parts of the SOAP message.</span></span> <span data-ttu-id="1e539-135">Dans cet exemple, le jeton de sécurité de carte de crédit ne peut pas contenir n'importe quelle clé de sécurité, c'est pourquoi l'implémentation retourne toujours une collection vide.</span><span class="sxs-lookup"><span data-stu-id="1e539-135">In this example, the credit card security token cannot contain any security keys; therefore, the implementation always returns an empty collection.</span></span>  
  
4. <span data-ttu-id="1e539-136">Remplacez les propriétés <xref:System.IdentityModel.Tokens.SecurityToken.ValidFrom%2A> et <xref:System.IdentityModel.Tokens.SecurityToken.ValidTo%2A>.</span><span class="sxs-lookup"><span data-stu-id="1e539-136">Override the <xref:System.IdentityModel.Tokens.SecurityToken.ValidFrom%2A> and <xref:System.IdentityModel.Tokens.SecurityToken.ValidTo%2A> properties.</span></span> <span data-ttu-id="1e539-137">Ces propriétés sont utilisées par WCF pour déterminer la validité de l’instance du jeton de sécurité.</span><span class="sxs-lookup"><span data-stu-id="1e539-137">These properties are used by WCF to determine the validity of the security token instance.</span></span> <span data-ttu-id="1e539-138">Dans cet exemple, seule une date d'expiration est définie pour le jeton de carte de crédit, par conséquent la propriété `ValidFrom` retourne la valeur <xref:System.DateTime>, laquelle représente l'heure et la date de création de l'instance.</span><span class="sxs-lookup"><span data-stu-id="1e539-138">In this example, the credit card security token has only an expiration date, so the `ValidFrom` property returns a <xref:System.DateTime> that represents the date and time of the instance creation.</span></span>  
  
     [!code-csharp[c_CustomToken#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#1)]
     [!code-vb[c_CustomToken#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#1)]  
  
 <span data-ttu-id="1e539-139">Lorsqu'un nouveau jeton de sécurité est créé, la classe <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters> doit à nouveau être implémentée.</span><span class="sxs-lookup"><span data-stu-id="1e539-139">When a new security token type is created, it requires an implementation of the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters> class.</span></span> <span data-ttu-id="1e539-140">L’implémentation est utilisée dans la configuration de l’élément de liaison de sécurité afin de représenter un nouveau type de jeton.</span><span class="sxs-lookup"><span data-stu-id="1e539-140">The implementation is used in the security binding element configuration to represent the new token type.</span></span> <span data-ttu-id="1e539-141">La classe des paramètres de jeton de sécurité sert de modèle, lequel permet de mettre en correspondance la véritable instance de jeton de sécurité lorsqu'un message est traité.</span><span class="sxs-lookup"><span data-stu-id="1e539-141">The security token parameters class serves as a template that is used to match the actual security token instance to when a message is processed.</span></span> <span data-ttu-id="1e539-142">Ce modèle contient des propriétés supplémentaires qu'une application peut utiliser afin de spécifier les critères que le jeton de sécurité doit respecter pour pouvoir être utilisé ou authentifié.</span><span class="sxs-lookup"><span data-stu-id="1e539-142">The template provides additional properties that an application can use to specify criteria that the security token must match to be used or authenticated.</span></span> <span data-ttu-id="1e539-143">L’exemple suivant n’ajoute pas de propriétés supplémentaires. par conséquent, seul le type de jeton de sécurité est mis en correspondance lorsque l’infrastructure WCF recherche une instance de jeton de sécurité à utiliser ou à valider.</span><span class="sxs-lookup"><span data-stu-id="1e539-143">The following example does not add any additional properties, so only the security token type is matched when the WCF infrastructure searches for a security token instance to use or to validate.</span></span>  
  
#### <a name="to-create-a-custom-security-token-parameters-class"></a><span data-ttu-id="1e539-144">Pour créer une classe de paramètres de jeton de sécurité personnalisé</span><span class="sxs-lookup"><span data-stu-id="1e539-144">To create a custom security token parameters class</span></span>  
  
1. <span data-ttu-id="1e539-145">Définissez une nouvelle classe dérivée de la classe <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters>.</span><span class="sxs-lookup"><span data-stu-id="1e539-145">Define a new class derived from the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters> class.</span></span>  
  
2. <span data-ttu-id="1e539-146">Implémentez la méthode <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.CloneCore%2A>.</span><span class="sxs-lookup"><span data-stu-id="1e539-146">Implement the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.CloneCore%2A> method.</span></span> <span data-ttu-id="1e539-147">Copiez tous les champs internes définis dans votre classe, le cas échéant.</span><span class="sxs-lookup"><span data-stu-id="1e539-147">Copy all internal fields defined in your class, if any.</span></span> <span data-ttu-id="1e539-148">Cet exemple ne définit aucun champ supplémentaire.</span><span class="sxs-lookup"><span data-stu-id="1e539-148">This example does not define any additional fields.</span></span>  
  
3. <span data-ttu-id="1e539-149">Implémentez la propriété en lecture seule <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.SupportsClientAuthentication%2A>.</span><span class="sxs-lookup"><span data-stu-id="1e539-149">Implement the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.SupportsClientAuthentication%2A> read-only property.</span></span> <span data-ttu-id="1e539-150">Cette propriété retourne `true` si le type de jeton de sécurité représenté par cette classe peut être utilisé pour authentifier un client auprès d'un service.</span><span class="sxs-lookup"><span data-stu-id="1e539-150">This property returns `true` if the security token type represented by this class can be used to authenticate a client to a service.</span></span> <span data-ttu-id="1e539-151">Dans cet exemple, le jeton de sécurité de carte de crédit peut être utilisé pour authentifier un client auprès d'un service.</span><span class="sxs-lookup"><span data-stu-id="1e539-151">In this example, the credit card security token can be used to authenticate a client to a service.</span></span>  
  
4. <span data-ttu-id="1e539-152">Implémentez la propriété en lecture seule <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.SupportsServerAuthentication%2A>.</span><span class="sxs-lookup"><span data-stu-id="1e539-152">Implement the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.SupportsServerAuthentication%2A> read-only property.</span></span> <span data-ttu-id="1e539-153">Cette propriété retourne `true` si le type de jeton de sécurité représenté par cette classe peut être utilisé pour authentifier un service auprès d'un client.</span><span class="sxs-lookup"><span data-stu-id="1e539-153">This property returns `true` if the security token type represented by this class can be used to authenticate a service to a client.</span></span> <span data-ttu-id="1e539-154">Dans cet exemple, le jeton de sécurité de carte de crédit ne peut pas être utilisé pour authentifier un service auprès d'un client.</span><span class="sxs-lookup"><span data-stu-id="1e539-154">In this example, the credit card security token cannot be used to authenticate a service to a client.</span></span>  
  
5. <span data-ttu-id="1e539-155">Implémentez la propriété en lecture seule <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.SupportsClientWindowsIdentity%2A>.</span><span class="sxs-lookup"><span data-stu-id="1e539-155">Implement the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.SupportsClientWindowsIdentity%2A> read-only property.</span></span> <span data-ttu-id="1e539-156">Cette propriété retourne `true` si le type de jeton de sécurité représenté par cette classe peut être mappé à un compte Windows.</span><span class="sxs-lookup"><span data-stu-id="1e539-156">This property returns `true` if the security token type represented by this class can be mapped to a Windows account.</span></span> <span data-ttu-id="1e539-157">Si c'est le cas, le résultat de l'authentification est représenté par une instance de la classe <xref:System.Security.Principal.WindowsIdentity>.</span><span class="sxs-lookup"><span data-stu-id="1e539-157">If so, the authentication result is represented by a <xref:System.Security.Principal.WindowsIdentity> class instance.</span></span> <span data-ttu-id="1e539-158">Dans cet exemple, le jeton ne peut pas être mappé à un compte Windows.</span><span class="sxs-lookup"><span data-stu-id="1e539-158">In this example, the token cannot be mapped to a Windows account.</span></span>  
  
6. <span data-ttu-id="1e539-159">Implémentez la méthode <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.CreateKeyIdentifierClause%28System.IdentityModel.Tokens.SecurityToken%2CSystem.ServiceModel.Security.Tokens.SecurityTokenReferenceStyle%29>.</span><span class="sxs-lookup"><span data-stu-id="1e539-159">Implement the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.CreateKeyIdentifierClause%28System.IdentityModel.Tokens.SecurityToken%2CSystem.ServiceModel.Security.Tokens.SecurityTokenReferenceStyle%29> method.</span></span> <span data-ttu-id="1e539-160">Cette méthode est appelée par l’infrastructure de sécurité WCF lorsqu’elle requiert une référence à l’instance de jeton de sécurité représentée par cette classe de paramètres de jeton de sécurité.</span><span class="sxs-lookup"><span data-stu-id="1e539-160">This method is called by WCF security framework when it requires a reference to the security token instance represented by this security token parameters class.</span></span> <span data-ttu-id="1e539-161">La véritable instance de jeton de sécurité et le type <xref:System.ServiceModel.Security.Tokens.SecurityTokenReferenceStyle> qui spécifie le type de la référence demandée sont tous les deux passés à cette méthode sous forme d’arguments.</span><span class="sxs-lookup"><span data-stu-id="1e539-161">Both the actual security token instance and <xref:System.ServiceModel.Security.Tokens.SecurityTokenReferenceStyle> that specifies the type of the reference that is being requested are passed to this method as arguments.</span></span> <span data-ttu-id="1e539-162">Dans cet exemple, seules les références internes sont prises en charge par le jeton de sécurité de carte de crédit.</span><span class="sxs-lookup"><span data-stu-id="1e539-162">In this example, only internal references are supported by the credit card security token.</span></span> <span data-ttu-id="1e539-163">La classe <xref:System.IdentityModel.Tokens.SecurityToken> dispose d'une fonctionnalité permettant de créer des références internes ; l'implémentation ne nécessite donc pas de code supplémentaire.</span><span class="sxs-lookup"><span data-stu-id="1e539-163">The <xref:System.IdentityModel.Tokens.SecurityToken> class has functionality to create internal references; therefore, the implementation does not require additional code.</span></span>  
  
7. <span data-ttu-id="1e539-164">Implémentez la méthode <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.InitializeSecurityTokenRequirement%28System.IdentityModel.Selectors.SecurityTokenRequirement%29>.</span><span class="sxs-lookup"><span data-stu-id="1e539-164">Implement the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.InitializeSecurityTokenRequirement%28System.IdentityModel.Selectors.SecurityTokenRequirement%29> method.</span></span> <span data-ttu-id="1e539-165">Cette méthode est appelée par WCF pour convertir l’instance de la classe de paramètres de jeton de sécurité en une instance de la <xref:System.IdentityModel.Selectors.SecurityTokenRequirement> classe.</span><span class="sxs-lookup"><span data-stu-id="1e539-165">This method is called by WCF to convert the security token parameters class instance into an instance of the <xref:System.IdentityModel.Selectors.SecurityTokenRequirement> class.</span></span> <span data-ttu-id="1e539-166">Le résultat est utilisé par les fournisseurs de jeton de sécurité pour créer l'instance de jeton de sécurité adéquate.</span><span class="sxs-lookup"><span data-stu-id="1e539-166">The result is used by security token providers to create the appropriate security token instance.</span></span>  
  
     [!code-csharp[c_CustomToken#2](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#2)]
     [!code-vb[c_CustomToken#2](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#2)]  
  
 <span data-ttu-id="1e539-167">Les jetons de sécurité sont transmis dans les messages SOAP. Cette opération nécessite un mécanisme de traduction entre la représentation de jeton de sécurité en mémoire et la représentation en transmission.</span><span class="sxs-lookup"><span data-stu-id="1e539-167">Security tokens are transmitted inside SOAP messages, which requires a translation mechanism between the in-memory security token representation and the on-the-wire representation.</span></span> <span data-ttu-id="1e539-168">WCF utilise un sérialiseur de jeton de sécurité pour accomplir cette tâche.</span><span class="sxs-lookup"><span data-stu-id="1e539-168">WCF uses a security token serializer to accomplish this task.</span></span> <span data-ttu-id="1e539-169">Chaque jeton personnalisé doit être accompagné par un sérialiseur de jeton de sécurité personnalisé pouvant le sérialiser et le désérialiser à partir des messages SOAP.</span><span class="sxs-lookup"><span data-stu-id="1e539-169">Every custom token must be accompanied by a custom security token serializer that can serialize and deserialize the custom security token from the SOAP message.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="1e539-170">Les clés dérivées sont activées par défaut.</span><span class="sxs-lookup"><span data-stu-id="1e539-170">Derived keys are enabled by default.</span></span> <span data-ttu-id="1e539-171">Si vous créez un jeton de sécurité personnalisé et que vous l’utilisez comme jeton principal, WCF en déduit une clé.</span><span class="sxs-lookup"><span data-stu-id="1e539-171">If you create a custom security token and use it as the primary token, WCF derives a key from it.</span></span> <span data-ttu-id="1e539-172">Ce faisant, il appelle le sérialiseur de jeton de sécurité personnalisé afin d'écrire <xref:System.IdentityModel.Tokens.SecurityKeyIdentifierClause> pour le jeton de sécurité personnalisé pendant la sérialisation du `DerivedKeyToken` sur le câble.</span><span class="sxs-lookup"><span data-stu-id="1e539-172">While doing so, it calls the custom security token serializer to write the <xref:System.IdentityModel.Tokens.SecurityKeyIdentifierClause> for the custom security token while serializing the `DerivedKeyToken` to the wire.</span></span> <span data-ttu-id="1e539-173">À l'extrémité de réception, lors de la désérialisation du jeton du câble, le sérialiseur `DerivedKeyToken` attend un élément `SecurityTokenReference` en tant qu'enfant de niveau supérieur au-dessous de lui.</span><span class="sxs-lookup"><span data-stu-id="1e539-173">On the receiving end, when deserializing the token off the wire, the `DerivedKeyToken` serializer expects a `SecurityTokenReference` element as the top-level child under itself.</span></span> <span data-ttu-id="1e539-174">Si le sérialiseur de jeton de sécurité personnalisé n'a pas ajouté d'élément `SecurityTokenReference` pendant la sérialisation de son type de clause, une exception est levée.</span><span class="sxs-lookup"><span data-stu-id="1e539-174">If the custom security token serializer did not add a `SecurityTokenReference` element while serializing its clause type, an exception is thrown.</span></span>  
  
#### <a name="to-create-a-custom-security-token-serializer"></a><span data-ttu-id="1e539-175">Pour créer un sérialiseur de jeton de sécurité personnalisé</span><span class="sxs-lookup"><span data-stu-id="1e539-175">To create a custom security token serializer</span></span>  
  
1. <span data-ttu-id="1e539-176">Définissez une nouvelle classe dérivée de la classe <xref:System.ServiceModel.Security.WSSecurityTokenSerializer>.</span><span class="sxs-lookup"><span data-stu-id="1e539-176">Define a new class derived from the <xref:System.ServiceModel.Security.WSSecurityTokenSerializer> class.</span></span>  
  
2. <span data-ttu-id="1e539-177">Remplacez la méthode <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.CanReadTokenCore%28System.Xml.XmlReader%29>. Elle utilise un <xref:System.Xml.XmlReader> pour lire le flux XML.</span><span class="sxs-lookup"><span data-stu-id="1e539-177">Override the <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.CanReadTokenCore%28System.Xml.XmlReader%29> method, which relies on an <xref:System.Xml.XmlReader> to read the XML stream.</span></span> <span data-ttu-id="1e539-178">Cette méthode retourne `true` si l'implémentation du sérialiseur peut désérialiser le jeton de sécurité en fonction de l'élément en cours.</span><span class="sxs-lookup"><span data-stu-id="1e539-178">The method returns `true` if the serializer implementation can deserialize the security token based given its current element.</span></span> <span data-ttu-id="1e539-179">Dans cet exemple, cette méthode vérifie si le nom et l'espace de noms de l'élément XML en cours du lecteur XML sont corrects.</span><span class="sxs-lookup"><span data-stu-id="1e539-179">In this example, this method checks whether the XML reader's current XML element has the correct element name and namespace.</span></span> <span data-ttu-id="1e539-180">Dans le cas contraire, elle appelle l'implémentation de classe de base de cette méthode pour gérer l'élément XML.</span><span class="sxs-lookup"><span data-stu-id="1e539-180">If it does not, it calls the base class implementation of this method to handle the XML element.</span></span>  
  
3. <span data-ttu-id="1e539-181">Remplacez la méthode <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.ReadTokenCore%28System.Xml.XmlReader%2CSystem.IdentityModel.Selectors.SecurityTokenResolver%29> .</span><span class="sxs-lookup"><span data-stu-id="1e539-181">Override the <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.ReadTokenCore%28System.Xml.XmlReader%2CSystem.IdentityModel.Selectors.SecurityTokenResolver%29> method.</span></span> <span data-ttu-id="1e539-182">Cette méthode lit le contenu XML de jeton de sécurité et construit la représentation en mémoire adéquate lui correspondant.</span><span class="sxs-lookup"><span data-stu-id="1e539-182">This method reads the XML content of the security token and constructs the appropriate in-memory representation for it.</span></span> <span data-ttu-id="1e539-183">Si elle ne reconnaît pas l'élément XML du lecteur XML passé, elle appelle l'implémentation de base pour traiter les types de jeton fournis par le système.</span><span class="sxs-lookup"><span data-stu-id="1e539-183">If it does not recognize the XML element on which the passed-in XML reader is standing, it calls the base class implementation to process the system-provided token types.</span></span>  
  
4. <span data-ttu-id="1e539-184">Remplacez la méthode <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.CanWriteTokenCore%28System.IdentityModel.Tokens.SecurityToken%29> .</span><span class="sxs-lookup"><span data-stu-id="1e539-184">Override the <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.CanWriteTokenCore%28System.IdentityModel.Tokens.SecurityToken%29> method.</span></span> <span data-ttu-id="1e539-185">Cette méthode retourne `true` si elle peut convertir la représentation en mémoire du jeton (passée sous forme d'argument) en représentation XML.</span><span class="sxs-lookup"><span data-stu-id="1e539-185">This method returns `true` if it can convert the in-memory token representation (passed in as an argument) to the XML representation.</span></span> <span data-ttu-id="1e539-186">Dans le cas contraire, elle appelle l'implémentation de la classe de base.</span><span class="sxs-lookup"><span data-stu-id="1e539-186">If it cannot convert, it calls the base class implementation.</span></span>  
  
5. <span data-ttu-id="1e539-187">Remplacez la méthode <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.WriteTokenCore%28System.Xml.XmlWriter%2CSystem.IdentityModel.Tokens.SecurityToken%29> .</span><span class="sxs-lookup"><span data-stu-id="1e539-187">Override the <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.WriteTokenCore%28System.Xml.XmlWriter%2CSystem.IdentityModel.Tokens.SecurityToken%29> method.</span></span> <span data-ttu-id="1e539-188">Cette méthode convertit la représentation en mémoire du jeton de sécurité en représentation XML.</span><span class="sxs-lookup"><span data-stu-id="1e539-188">This method converts an in-memory security token representation into an XML representation.</span></span> <span data-ttu-id="1e539-189">Si elle ne peut pas effectuer la conversion, elle appelle l'implémentation de la classe de base.</span><span class="sxs-lookup"><span data-stu-id="1e539-189">If the method cannot convert, it calls the base class implementation.</span></span>  
  
     [!code-csharp[c_CustomToken#3](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#3)]
     [!code-vb[c_CustomToken#3](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#3)]  
  
 <span data-ttu-id="1e539-190">Les quatre procédures ci-dessus effectuées, intégrez le jeton de sécurité personnalisé au fournisseur, authentificateur et gestionnaire de jetons de sécurité ainsi qu'aux informations d'identification client et service.</span><span class="sxs-lookup"><span data-stu-id="1e539-190">After completing the four previous procedures, integrate the custom security token with the security token provider, authenticator, manager, and client and service credentials.</span></span>  
  
#### <a name="to-integrate-the-custom-security-token-with-a-security-token-provider"></a><span data-ttu-id="1e539-191">Pour intégrer le jeton de sécurité personnalisé à un fournisseur de jetons de sécurité</span><span class="sxs-lookup"><span data-stu-id="1e539-191">To integrate the custom security token with a security token provider</span></span>  
  
1. <span data-ttu-id="1e539-192">Le fournisseur de jeton de sécurité crée, modifie (si nécessaire) et retourne une instance du jeton.</span><span class="sxs-lookup"><span data-stu-id="1e539-192">The security token provider creates, modifies (if necessary), and returns an instance of the token.</span></span> <span data-ttu-id="1e539-193">Pour créer un fournisseur de jetons de sécurité pour le jeton de sécurité personnalisé, créez une classe qui hérite de la classe <xref:System.IdentityModel.Selectors.SecurityTokenProvider>.</span><span class="sxs-lookup"><span data-stu-id="1e539-193">To create a custom provider for the custom security token, create a class that inherits from the <xref:System.IdentityModel.Selectors.SecurityTokenProvider> class.</span></span> <span data-ttu-id="1e539-194">L'exemple suivant remplace la méthode <xref:System.IdentityModel.Selectors.SecurityTokenProvider.GetTokenCore%2A> pour retourner une instance de `CreditCardToken`.</span><span class="sxs-lookup"><span data-stu-id="1e539-194">The following example overrides the <xref:System.IdentityModel.Selectors.SecurityTokenProvider.GetTokenCore%2A> method to return an instance of the `CreditCardToken`.</span></span> <span data-ttu-id="1e539-195">Pour plus d’informations sur les fournisseurs de jetons de sécurité personnalisés, consultez [Comment : créer un fournisseur de jetons de sécurité personnalisé](how-to-create-a-custom-security-token-provider.md).</span><span class="sxs-lookup"><span data-stu-id="1e539-195">For more information about custom security token providers, see [How to: Create a Custom Security Token Provider](how-to-create-a-custom-security-token-provider.md).</span></span>  
  
     [!code-csharp[c_CustomToken#6](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#6)]
     [!code-vb[c_CustomToken#6](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#6)]  
  
#### <a name="to-integrate-the-custom-security-token-with-a-security-token-authenticator"></a><span data-ttu-id="1e539-196">Pour intégrer le jeton de sécurité personnalisé à un authentificateur de jetons de sécurité</span><span class="sxs-lookup"><span data-stu-id="1e539-196">To integrate the custom security token with a security token authenticator</span></span>  
  
1. <span data-ttu-id="1e539-197">L'authentificateur de jetons de sécurité valide le contenu du jeton de sécurité lorsque ce dernier est extrait du message.</span><span class="sxs-lookup"><span data-stu-id="1e539-197">The security token authenticator validates the content of the security token when it is extracted from the message.</span></span> <span data-ttu-id="1e539-198">Pour créer un authentificateur personnalisé pour le jeton de sécurité personnalisé, créez une classe qui hérite de la classe <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator>.</span><span class="sxs-lookup"><span data-stu-id="1e539-198">To create a custom authenticator for the custom security token, create a class that inherits from the <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator> class.</span></span> <span data-ttu-id="1e539-199">L'exemple suivant substitue la méthode <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator.ValidateTokenCore%2A>.</span><span class="sxs-lookup"><span data-stu-id="1e539-199">The following example overrides the <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator.ValidateTokenCore%2A> method.</span></span> <span data-ttu-id="1e539-200">Pour plus d’informations sur les authentificateurs de jetons de sécurité personnalisés, consultez [Comment : créer un authentificateur de jetons de sécurité personnalisé](how-to-create-a-custom-security-token-authenticator.md).</span><span class="sxs-lookup"><span data-stu-id="1e539-200">For more information about custom security token authenticators, see [How to: Create a Custom Security Token Authenticator](how-to-create-a-custom-security-token-authenticator.md).</span></span>  
  
     [!code-csharp[c_CustomToken#7](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#7)]
     [!code-vb[c_CustomToken#7](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#7)]  
  
     [!code-csharp[c_CustomToken#12](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#12)]
     [!code-vb[c_CustomToken#12](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#12)]  
  
#### <a name="to-integrate-the-custom-security-token-with-a-security-token-manager"></a><span data-ttu-id="1e539-201">Pour intégrer le jeton de sécurité personnalisé à un gestionnaire de jetons de sécurité</span><span class="sxs-lookup"><span data-stu-id="1e539-201">To integrate the custom security token with a security token manager</span></span>  
  
1. <span data-ttu-id="1e539-202">Le gestionnaire de jetons de sécurité crée les instances de fournisseur, d'authentificateur et de sérialiseur de jetons de sécurité appropriées.</span><span class="sxs-lookup"><span data-stu-id="1e539-202">The security token manager creates the appropriate token provider, security authenticator, and token serializer instances.</span></span> <span data-ttu-id="1e539-203">Pour créer un gestionnaire de jetons de sécurité personnalisé, créez une classe qui hérite de la classe <xref:System.ServiceModel.ClientCredentialsSecurityTokenManager>.</span><span class="sxs-lookup"><span data-stu-id="1e539-203">To create a custom token manager, create a class that inherits from the <xref:System.ServiceModel.ClientCredentialsSecurityTokenManager> class.</span></span> <span data-ttu-id="1e539-204">Les principales méthodes de la classe utilisent une spécification <xref:System.IdentityModel.Selectors.SecurityTokenRequirement> pour créer le fournisseur approprié ainsi que les informations d'identification client ou service requises.</span><span class="sxs-lookup"><span data-stu-id="1e539-204">The primary methods of the class use a <xref:System.IdentityModel.Selectors.SecurityTokenRequirement> to create the appropriate provider and client or service credentials.</span></span> <span data-ttu-id="1e539-205">Pour plus d’informations sur les gestionnaires de jetons de sécurité personnalisés, consultez [procédure pas à pas : création d’informations d’identification de client et de service personnalisées](walkthrough-creating-custom-client-and-service-credentials.md).</span><span class="sxs-lookup"><span data-stu-id="1e539-205">For more information about custom security token managers, see [Walkthrough: Creating Custom Client and Service Credentials](walkthrough-creating-custom-client-and-service-credentials.md).</span></span>  
  
     [!code-csharp[c_CustomToken#8](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#8)]
     [!code-vb[c_CustomToken#8](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#8)]  
  
     [!code-csharp[c_CustomToken#9](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#9)]
     [!code-vb[c_CustomToken#9](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#9)]  
  
#### <a name="to-integrate-the-custom-security-token-with-custom-client-and-service-credentials"></a><span data-ttu-id="1e539-206">Pour intégrer le jeton de sécurité personnalisé aux informations d'identification client et service personnalisées</span><span class="sxs-lookup"><span data-stu-id="1e539-206">To integrate the custom security token with custom client and service credentials</span></span>  
  
1. <span data-ttu-id="1e539-207">Les informations d'identification client et service doivent être ajoutées afin de générer une API pour l'application. Cette API permet de spécifier les informations du jeton de sécurité personnalisé qui seront utilisées par l'infrastructure de ce dernier créée précédemment afin de générer son contenu et de l'authentifier.</span><span class="sxs-lookup"><span data-stu-id="1e539-207">The custom client and service credentials must be added to provide an API for the application to allow specifying custom token information that is used by the custom security token infrastructure created previously to provide and authenticate the custom security token content.</span></span> <span data-ttu-id="1e539-208">Les exemples suivants montrent comment procéder.</span><span class="sxs-lookup"><span data-stu-id="1e539-208">The following samples show how this can be done.</span></span> <span data-ttu-id="1e539-209">Pour plus d’informations sur les informations d’identification de client et de service personnalisées, consultez [procédure pas à pas : création d’informations d’identification de client et de service personnalisées](walkthrough-creating-custom-client-and-service-credentials.md).</span><span class="sxs-lookup"><span data-stu-id="1e539-209">For more information about custom client and service credentials, see [Walkthrough: Creating Custom Client and Service Credentials](walkthrough-creating-custom-client-and-service-credentials.md).</span></span>  
  
     [!code-csharp[c_CustomToken#10](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#10)]
     [!code-vb[c_CustomToken#10](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#10)]  
  
     [!code-csharp[c_customToken#11](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#11)]
     [!code-vb[c_customToken#11](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#11)]  
  
 <span data-ttu-id="1e539-210">La classe de paramètres de jeton de sécurité personnalisée créée précédemment est utilisée pour indiquer à l’infrastructure de sécurité WCF qu’un jeton de sécurité personnalisé doit être utilisé lors de la communication avec un service.</span><span class="sxs-lookup"><span data-stu-id="1e539-210">The custom security token parameters class created previously is used to tell the WCF security framework that a custom security token must be used when communicating with a service.</span></span> <span data-ttu-id="1e539-211">La procédure suivante indique comment effectuer cette opération.</span><span class="sxs-lookup"><span data-stu-id="1e539-211">The following procedure shows how this can be done.</span></span>  
  
#### <a name="to-integrate-the-custom-security-token-with-the-binding"></a><span data-ttu-id="1e539-212">Pour intégrer le jeton de sécurité personnalisé à la liaison</span><span class="sxs-lookup"><span data-stu-id="1e539-212">To integrate the custom security token with the binding</span></span>  
  
1. <span data-ttu-id="1e539-213">La classe de paramètres de jeton de sécurité personnalisé doit être spécifiée dans l'une des collections de paramètres de jeton exposées sur la classe <xref:System.ServiceModel.Channels.SecurityBindingElement>.</span><span class="sxs-lookup"><span data-stu-id="1e539-213">The custom security token parameters class must be specified in one of the token parameters collections that are exposed on the <xref:System.ServiceModel.Channels.SecurityBindingElement> class.</span></span> <span data-ttu-id="1e539-214">Dans l'exemple suivant, la collection retournée par `SignedEncrypted` est utilisée.</span><span class="sxs-lookup"><span data-stu-id="1e539-214">The following example uses the collection returned by `SignedEncrypted`.</span></span> <span data-ttu-id="1e539-215">Le code ajoute un jeton personnalisé de carte de crédit à tous les messages envoyés depuis le client au service, le contenu de ce jeton étant automatiquement signé et chiffré.</span><span class="sxs-lookup"><span data-stu-id="1e539-215">The code adds the credit card custom token to every message sent from the client to the service with its content automatically signed and encrypted.</span></span>  
  
     [!code-csharp[c_CustomToken#13](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#13)]
     [!code-vb[c_CustomToken#13](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#13)]  
  
 <span data-ttu-id="1e539-216">Cette rubrique décrit les différents éléments de code nécessaires à l'implémentation et l'utilisation d'un jeton personnalisé.</span><span class="sxs-lookup"><span data-stu-id="1e539-216">This topic shows the various pieces of code necessary to implement and use a custom token.</span></span> <span data-ttu-id="1e539-217">Pour voir un exemple complet de la façon dont tous ces éléments de code s’ajustent ensemble, consultez [jeton personnalisé](../samples/custom-token.md).</span><span class="sxs-lookup"><span data-stu-id="1e539-217">To see a complete example of how all these pieces of code fit together see, [Custom Token](../samples/custom-token.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="1e539-218">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="1e539-218">See also</span></span>

- <xref:System.IdentityModel.Tokens.SecurityToken>
- <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters>
- <xref:System.ServiceModel.Security.WSSecurityTokenSerializer>
- <xref:System.IdentityModel.Selectors.SecurityTokenProvider>
- <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator>
- <xref:System.IdentityModel.Policy.IAuthorizationPolicy>
- <xref:System.IdentityModel.Selectors.SecurityTokenRequirement>
- <xref:System.IdentityModel.Selectors.SecurityTokenManager>
- <xref:System.ServiceModel.Description.ClientCredentials>
- <xref:System.ServiceModel.Description.ServiceCredentials>
- <xref:System.ServiceModel.Channels.SecurityBindingElement>
- [<span data-ttu-id="1e539-219">Procédure pas à pas : création d’informations d’identification de client et de service personnalisées</span><span class="sxs-lookup"><span data-stu-id="1e539-219">Walkthrough: Creating Custom Client and Service Credentials</span></span>](walkthrough-creating-custom-client-and-service-credentials.md)
- [<span data-ttu-id="1e539-220">Procédure : créer un authentificateur de jetons de sécurité personnalisé</span><span class="sxs-lookup"><span data-stu-id="1e539-220">How to: Create a Custom Security Token Authenticator</span></span>](how-to-create-a-custom-security-token-authenticator.md)
- [<span data-ttu-id="1e539-221">Procédure : créer un fournisseur de jetons de sécurité personnalisé</span><span class="sxs-lookup"><span data-stu-id="1e539-221">How to: Create a Custom Security Token Provider</span></span>](how-to-create-a-custom-security-token-provider.md)
