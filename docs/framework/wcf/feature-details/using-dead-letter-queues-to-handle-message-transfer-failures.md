---
title: Utilisation de files d'attente de lettres mortes pour gérer des défaillances de transfert de messages
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: 9e891c6a-d960-45ea-904f-1a00e202d61a
ms.openlocfilehash: f07397b4c10ffec4902dbde37b622978d00f5b63
ms.sourcegitcommit: cdb295dd1db589ce5169ac9ff096f01fd0c2da9d
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 06/09/2020
ms.locfileid: "84594983"
---
# <a name="using-dead-letter-queues-to-handle-message-transfer-failures"></a><span data-ttu-id="ce87a-102">Utilisation de files d'attente de lettres mortes pour gérer des défaillances de transfert de messages</span><span class="sxs-lookup"><span data-stu-id="ce87a-102">Using Dead-Letter Queues to Handle Message Transfer Failures</span></span>
<span data-ttu-id="ce87a-103">La remise de messages en file d'attente peut échouer.</span><span class="sxs-lookup"><span data-stu-id="ce87a-103">Queued messages can fail delivery.</span></span> <span data-ttu-id="ce87a-104">Les messages qui ont échoué sont enregistrés dans une file d'attente de lettres mortes.</span><span class="sxs-lookup"><span data-stu-id="ce87a-104">These failed messages are recorded in a dead-letter queue.</span></span> <span data-ttu-id="ce87a-105">L'échec de la remise peut être dû à des défaillances du réseau, une file d'attente supprimée, une file d'attente saturée, un échec d'authentification ou un retard de remise.</span><span class="sxs-lookup"><span data-stu-id="ce87a-105">The failed delivery can be caused by reasons such as network failures, a deleted queue, a full queue, authentication failure, or a failure to deliver on time.</span></span>  
  
 <span data-ttu-id="ce87a-106">Les messages en file d'attente peuvent rester longtemps dans la file d'attente si l'application de réception ne les lit pas en temps voulu.</span><span class="sxs-lookup"><span data-stu-id="ce87a-106">Queued messages can remain in the queue for a long time if the receiving application does not read them from the queue in a timely fashion.</span></span> <span data-ttu-id="ce87a-107">Ce comportement peut s'avérer inapproprié pour des messages dépendants de l'heure.</span><span class="sxs-lookup"><span data-stu-id="ce87a-107">This behavior may not be appropriate for time-sensitive messages.</span></span> <span data-ttu-id="ce87a-108">Les messages dépendants de l'heure ont une propriété de durée de vie définie dans la liaison en file d'attente, qui indique combien de temps les messages peuvent demeurer dans la file d'attente avant d'expirer.</span><span class="sxs-lookup"><span data-stu-id="ce87a-108">Time-sensitive messages have a Time to Live (TTL) property set in the queued binding, which indicates how long the messages can be in the queue before they must expire.</span></span> <span data-ttu-id="ce87a-109">Les messages ayant expiré sont envoyés dans une file d'attente spéciale appelée file d'attente de lettres mortes.</span><span class="sxs-lookup"><span data-stu-id="ce87a-109">Expired messages are sent to a special queue called the dead-letter queue.</span></span> <span data-ttu-id="ce87a-110">Les messages peuvent également être placés dans une file d'attente de lettres mortes pour d'autres raisons, telles que le dépassement d'un quota de file d'attente ou un échec d'authentification.</span><span class="sxs-lookup"><span data-stu-id="ce87a-110">Messages can also be put in a dead-letter queue for other reasons, such as exceeding a queue quota or because of authentication failure.</span></span>  
  
 <span data-ttu-id="ce87a-111">En général, les applications écrivent une logique de compensation pour lire les messages de la file d'attente de lettres mortes et les raisons de l'échec.</span><span class="sxs-lookup"><span data-stu-id="ce87a-111">Generally, applications write compensation logic to read messages from the dead-letter queue and failure reasons.</span></span> <span data-ttu-id="ce87a-112">La logique de compensation dépend de la cause de la défaillance.</span><span class="sxs-lookup"><span data-stu-id="ce87a-112">The compensation logic depends on the cause of the failure.</span></span> <span data-ttu-id="ce87a-113">Par exemple, dans le cas d'un échec d'authentification, vous pouvez corriger le certificat joint au message et renvoyer le message.</span><span class="sxs-lookup"><span data-stu-id="ce87a-113">For example, in the case of authentication failure, you can correct the certificate attached with the message and resend the message.</span></span> <span data-ttu-id="ce87a-114">Si la remise a échoué parce que le quota de la file d'attente cible a été atteint, vous pouvez tenter de nouveau la remise dans l'espoir que le problème de quota a été résolu.</span><span class="sxs-lookup"><span data-stu-id="ce87a-114">If delivery failed because the target queue quota was reached, you can reattempt delivery in the hope that the quota problem was resolved.</span></span>  
  
 <span data-ttu-id="ce87a-115">La plupart des systèmes de mise en file d'attente possèdent une file d'attente de lettres mortes à l'échelle du système qui stocke tous les messages ayant échoué issus de ce système.</span><span class="sxs-lookup"><span data-stu-id="ce87a-115">Most queuing systems have a system-wide dead-letter queue where all failed messages from that system are stored.</span></span> <span data-ttu-id="ce87a-116">Message Queuing (MSMQ) fournit deux files d’attente de lettres mortes à l’échelle du système : une file d’attente de lettres mortes transactionnelle à l’échelle du système, qui stocke les messages dont la remise dans la file d’attente transactionnelle a échoué et une file d’attente de lettres mortes non transactionnelle à l’échelle du système, qui stocke les messages dont la remise dans la file d’attente non transactionnelle a échoué.</span><span class="sxs-lookup"><span data-stu-id="ce87a-116">Message Queuing (MSMQ) provides two system-wide dead-letter queues: a transactional system-wide dead-letter queue that stores messages that failed delivery to the transactional queue and a non-transactional system-wide dead-letter queue that stores messages that failed delivery to the non-transactional queue.</span></span> <span data-ttu-id="ce87a-117">Si deux clients envoient des messages à deux services différents et que, par conséquent, différentes files d’attente dans WCF partagent le même service MSMQ à envoyer, il est possible d’avoir une combinaison de messages dans la file d’attente de lettres mortes du système.</span><span class="sxs-lookup"><span data-stu-id="ce87a-117">If two clients are sending messages to two different services, and therefore different queues in WCF are sharing the same MSMQ service to send, then it is possible to have a mix of messages in the system dead-letter queue.</span></span> <span data-ttu-id="ce87a-118">Cela n'est pas toujours optimal.</span><span class="sxs-lookup"><span data-stu-id="ce87a-118">This is not always optimal.</span></span> <span data-ttu-id="ce87a-119">Dans certains cas (pour des raisons de sécurité, par exemple), vous ne souhaiterez pas qu'un client lise les messages d'un autre client à partir d'une file d'attente de lettres mortes.</span><span class="sxs-lookup"><span data-stu-id="ce87a-119">In several cases (security, for example), you may not want one client to read another client's messages from a dead-letter queue.</span></span> <span data-ttu-id="ce87a-120">Dans une file d'attente de lettres mortes partagée, les clients doivent parcourir la file d'attente pour rechercher un message qu'ils ont envoyé, ce qui peut représenter un coût prohibitif en fonction du nombre de messages dans la file d'attente de lettres mortes.</span><span class="sxs-lookup"><span data-stu-id="ce87a-120">A shared dead-letter queue also requires clients to browse through the queue to find a message that they sent, which can be prohibitively expensive based on the number of messages in the dead-letter queue.</span></span> <span data-ttu-id="ce87a-121">Par conséquent, dans WCF `NetMsmqBinding` , `MsmqIntegrationBinding,` et MSMQ sur Windows Vista fournissent une file d’attente de lettres mortes personnalisée (parfois appelée file d’attente de lettres mortes propre à l’application).</span><span class="sxs-lookup"><span data-stu-id="ce87a-121">Therefore, in WCF`NetMsmqBinding`, `MsmqIntegrationBinding,` and MSMQ on Windows Vista provide a custom dead-letter queue (sometimes referred to as an application-specific dead-letter queue).</span></span>  
  
 <span data-ttu-id="ce87a-122">La file d'attente de lettres mortes personnalisée assure l'isolement entre les clients qui partagent le même service MSMQ pour envoyer des messages.</span><span class="sxs-lookup"><span data-stu-id="ce87a-122">The custom dead-letter queue provides isolation between clients that share the same MSMQ service to send messages.</span></span>  
  
 <span data-ttu-id="ce87a-123">Sur Windows Server 2003 et Windows XP, Windows Communication Foundation (WCF) fournit une file d’attente de lettres mortes à l’ensemble du système pour toutes les applications clientes mises en file d’attente.</span><span class="sxs-lookup"><span data-stu-id="ce87a-123">On Windows Server 2003 and Windows XP, Windows Communication Foundation (WCF) provides a system-wide dead-letter queue for all queued client applications.</span></span> <span data-ttu-id="ce87a-124">Sur Windows Vista, WCF fournit une file d’attente de lettres mortes pour chaque application cliente en file d’attente.</span><span class="sxs-lookup"><span data-stu-id="ce87a-124">On Windows Vista, WCF provides a dead-letter queue for each queued client application.</span></span>  
  
## <a name="specifying-use-of-the-dead-letter-queue"></a><span data-ttu-id="ce87a-125">Spécification de l'utilisation de la file d'attente de lettres mortes</span><span class="sxs-lookup"><span data-stu-id="ce87a-125">Specifying Use of the Dead-Letter Queue</span></span>  
 <span data-ttu-id="ce87a-126">Une file d'attente de lettres mortes est dans le gestionnaire de files d'attente de l'application émettrice.</span><span class="sxs-lookup"><span data-stu-id="ce87a-126">A dead-letter queue is in the queue manager of the sending application.</span></span> <span data-ttu-id="ce87a-127">Elle stocke les messages qui ont expiré ou dont la remise ou le transfert a échoué.</span><span class="sxs-lookup"><span data-stu-id="ce87a-127">It stores messages that have expired or that have failed transfer or delivery.</span></span>  
  
 <span data-ttu-id="ce87a-128">La liaison a les propriétés de file d’attente de lettres mortes suivantes :</span><span class="sxs-lookup"><span data-stu-id="ce87a-128">The binding has the following dead-letter queue properties:</span></span>  
  
- <xref:System.ServiceModel.MsmqBindingBase.DeadLetterQueue%2A>  
  
- <xref:System.ServiceModel.MsmqBindingBase.CustomDeadLetterQueue%2A>  
  
## <a name="reading-messages-from-the-dead-letter-queue"></a><span data-ttu-id="ce87a-129">Lecture des messages stockés dans la file d'attente de lettres mortes</span><span class="sxs-lookup"><span data-stu-id="ce87a-129">Reading Messages from the Dead-Letter Queue</span></span>  
 <span data-ttu-id="ce87a-130">Une application qui lit les messages dans une file d’attente de lettres mortes est similaire à un service WCF qui lit à partir d’une file d’attente d’application, à l’exception des différences mineures suivantes :</span><span class="sxs-lookup"><span data-stu-id="ce87a-130">An application that reads messages out of a dead-letter queue is similar to a WCF service that reads from an application queue, except for the following minor differences:</span></span>  
  
- <span data-ttu-id="ce87a-131">Pour lire des messages à partir d’une file d’attente de lettres mortes transactionnelle système, l’URI (Uniform Resource Identifier) doit être de la forme : net.msmq://localhost/system$;DeadXact.</span><span class="sxs-lookup"><span data-stu-id="ce87a-131">To read messages from a system transactional dead-letter queue, the Uniform Resource Identifier (URI) must be of the form: net.msmq://localhost/system$;DeadXact.</span></span>  
  
- <span data-ttu-id="ce87a-132">Pour lire des messages à partir d'une file d'attente de lettres mortes non transactionnelle système, l'URI doit être de la forme : net.msmq://localhost/system$;DeadLetter.</span><span class="sxs-lookup"><span data-stu-id="ce87a-132">To read messages from a system non-transactional dead-letter queue, the URI must be of the form: net.msmq://localhost/system$;DeadLetter.</span></span>  
  
- <span data-ttu-id="ce87a-133">Pour lire des messages à partir d’une file d’attente de lettres mortes personnalisée, l’URI doit être de la forme : net. msmq://localhost/private/ \<*custom-dlq-name*> où *Custom-lettres mortes-Name* est le nom de la file d’attente de lettres mortes personnalisée.</span><span class="sxs-lookup"><span data-stu-id="ce87a-133">To read messages from a custom dead-letter queue, the URI must be of the form:net.msmq://localhost/private/\<*custom-dlq-name*> where *custom-dlq-name* is the name of the custom dead-letter queue.</span></span>  
  
 <span data-ttu-id="ce87a-134">Pour plus d’informations sur la façon d’adresser des files d’attente, consultez [points de terminaison de service et adressage de file d’attente](service-endpoints-and-queue-addressing.md).</span><span class="sxs-lookup"><span data-stu-id="ce87a-134">For more information about how to address queues, see [Service Endpoints and Queue Addressing](service-endpoints-and-queue-addressing.md).</span></span>  
  
 <span data-ttu-id="ce87a-135">La pile WCF sur le récepteur correspond aux adresses sur lesquelles le service est à l’écoute avec l’adresse du message.</span><span class="sxs-lookup"><span data-stu-id="ce87a-135">The WCF stack on the receiver matches addresses that the service is listening on with the address on the message.</span></span> <span data-ttu-id="ce87a-136">Si les adresses correspondent, le message est distribué ; dans le cas contraire, le message n'est pas distribué.</span><span class="sxs-lookup"><span data-stu-id="ce87a-136">If the addresses match, the message is dispatched; if not, the message is not dispatched.</span></span> <span data-ttu-id="ce87a-137">Cela peut provoquer des problèmes lors de la lecture à partir de la file d'attente de lettres mortes, parce que les messages dans la file d'attente de lettres mortes sont adressés en général au service et pas le service de file d'attente de lettres mortes.</span><span class="sxs-lookup"><span data-stu-id="ce87a-137">This can cause problems when reading from the dead-letter queue, because messages in the dead-letter queue are typically addressed to the service and not the dead-letter queue service.</span></span> <span data-ttu-id="ce87a-138">Par conséquent, le service qui lit à partir de la file d'attente de lettres mortes doit installer un filtre d'adresse `ServiceBehavior` qui indique à la pile de mettre en correspondance tous les messages de la file d'attente indépendamment du destinataire.</span><span class="sxs-lookup"><span data-stu-id="ce87a-138">Therefore, the service reading from the dead-letter queue must install an address filter `ServiceBehavior` that instructs the stack to match all messages in the queue independently of the addressee.</span></span> <span data-ttu-id="ce87a-139">En particulier, vous devez ajouter un filtre `ServiceBehavior` avec le paramètre <xref:System.ServiceModel.AddressFilterMode.Any> au service qui lit des messages à partir de la file d'attente de lettres mortes.</span><span class="sxs-lookup"><span data-stu-id="ce87a-139">Specifically, you must add a `ServiceBehavior` with the <xref:System.ServiceModel.AddressFilterMode.Any> parameter to the service reading messages from the dead-letter queue.</span></span>  
  
## <a name="poison-message-handling-from-the-dead-letter-queue"></a><span data-ttu-id="ce87a-140">Gestion des messages incohérents à partir de la file d'attente de lettres mortes</span><span class="sxs-lookup"><span data-stu-id="ce87a-140">Poison Message Handling from the Dead-Letter Queue</span></span>  
 <span data-ttu-id="ce87a-141">La gestion des messages incohérents est disponible sur les files d'attente de lettres mortes, mais présente certaines conditions.</span><span class="sxs-lookup"><span data-stu-id="ce87a-141">Poison message handling is available on dead-letter queues, with some conditions.</span></span> <span data-ttu-id="ce87a-142">Comme vous ne pouvez pas créer de sous-files d'attente à partir des files d'attente système, lorsque vous lisez à partir de la file d'attente de lettres mortes système, il n'est pas possible d'affecter à `ReceiveErrorHandling` la valeur `Move`.</span><span class="sxs-lookup"><span data-stu-id="ce87a-142">Because you cannot create sub-queues from system queues, when reading from the system dead-letter queue, the `ReceiveErrorHandling` cannot be set to `Move`.</span></span> <span data-ttu-id="ce87a-143">Notez que si vous lisez à partir d'une file d'attente de lettres mortes personnalisée, vous pouvez avoir des sous-files d'attente et, par conséquent, `Move` est une disposition valide pour le message incohérent.</span><span class="sxs-lookup"><span data-stu-id="ce87a-143">Note that if you are reading from a custom dead-letter queue, you can have sub-queues and, therefore, `Move` is a valid disposition for the poison message.</span></span>  
  
 <span data-ttu-id="ce87a-144">Lorsque `ReceiveErrorHandling` a la valeur `Reject`, lors de la lecture à partir de la file d'attente de lettres mortes personnalisée, le message incohérent est placé dans la file d'attente de lettres mortes système.</span><span class="sxs-lookup"><span data-stu-id="ce87a-144">When `ReceiveErrorHandling` is set to `Reject`, when reading from the custom dead letter queue, the poison message is put in the system dead-letter queue.</span></span> <span data-ttu-id="ce87a-145">Lors de la lecture à partir de la file d'attente de lettres mortes système, le message est déposé (purgé).</span><span class="sxs-lookup"><span data-stu-id="ce87a-145">If reading from the system dead-letter queue, the message is dropped (purged).</span></span> <span data-ttu-id="ce87a-146">Le rejet d’une file d’attente de lettres mortes système dans MSMQ dépose (purge) le message.</span><span class="sxs-lookup"><span data-stu-id="ce87a-146">A reject from a system dead-letter queue in MSMQ drops (purges) the message.</span></span>  
  
## <a name="example"></a><span data-ttu-id="ce87a-147">Exemple</span><span class="sxs-lookup"><span data-stu-id="ce87a-147">Example</span></span>  
 <span data-ttu-id="ce87a-148">L'exemple ci-dessous montre comment créer une file d'attente de lettres mortes et comment l'utiliser pour traiter les messages ayant expiré.</span><span class="sxs-lookup"><span data-stu-id="ce87a-148">The following example shows how to create a dead-letter queue and how to use it to process expired messages.</span></span> <span data-ttu-id="ce87a-149">L’exemple est basé sur l’exemple de la rubrique [Comment : échanger des messages en file d’attente avec des points de terminaison WCF](how-to-exchange-queued-messages-with-wcf-endpoints.md).</span><span class="sxs-lookup"><span data-stu-id="ce87a-149">The example is based on the example in [How to: Exchange Queued Messages with WCF Endpoints](how-to-exchange-queued-messages-with-wcf-endpoints.md).</span></span> <span data-ttu-id="ce87a-150">L'exemple ci-dessous montre comment écrire le code client pour le service de traitement des commandes qui utilise une file d'attente de lettres mortes pour chaque application.</span><span class="sxs-lookup"><span data-stu-id="ce87a-150">The following example shows how to write the client code to the order processing service that uses a dead-letter queue for each application.</span></span> <span data-ttu-id="ce87a-151">Cet exemple montre également comment traiter les messages stockés dans la file d'attente de lettres mortes.</span><span class="sxs-lookup"><span data-stu-id="ce87a-151">The example also shows how to process messages from the dead-letter queue.</span></span>  
  
 <span data-ttu-id="ce87a-152">Le code ci-dessous correspond à un client qui spécifie une file d'attente de lettres mortes pour chaque application.</span><span class="sxs-lookup"><span data-stu-id="ce87a-152">The following is code for a client that specifies a dead-letter queue for each application.</span></span>  
  
 [!code-csharp[S_DeadLetter#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/s_deadletter/cs/client.cs#1)]
 [!code-vb[S_DeadLetter#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/s_deadletter/vb/client.vb#1)]  
  
 <span data-ttu-id="ce87a-153">Le code ci-dessous est destiné au fichier de configuration client.</span><span class="sxs-lookup"><span data-stu-id="ce87a-153">The following is code for the client configuration file.</span></span>  

 <span data-ttu-id="ce87a-154">Le code ci-dessous est destiné à un service qui traite les messages stockés dans une file d'attente de lettres mortes.</span><span class="sxs-lookup"><span data-stu-id="ce87a-154">The following is code for a service processing messages from a dead-letter queue.</span></span>  
  
 [!code-csharp[S_DeadLetter#3](../../../../samples/snippets/csharp/VS_Snippets_CFX/s_deadletter/cs/dlservice.cs#3)]
 [!code-vb[S_DeadLetter#3](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/s_deadletter/vb/dlservice.vb#3)]  
  
 <span data-ttu-id="ce87a-155">Le code ci-dessous est destiné au fichier de configuration du service de file d'attente de lettres mortes.</span><span class="sxs-lookup"><span data-stu-id="ce87a-155">The following is code for the dead-letter queue service configuration file.</span></span>  

## <a name="see-also"></a><span data-ttu-id="ce87a-156">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="ce87a-156">See also</span></span>

- [<span data-ttu-id="ce87a-157">Vue d'ensemble des files d'attente</span><span class="sxs-lookup"><span data-stu-id="ce87a-157">Queues Overview</span></span>](queues-overview.md)
- [<span data-ttu-id="ce87a-158">Comment : échanger des messages en file d'attente avec des points de terminaison WCF</span><span class="sxs-lookup"><span data-stu-id="ce87a-158">How to: Exchange Queued Messages with WCF Endpoints</span></span>](how-to-exchange-queued-messages-with-wcf-endpoints.md)
- [<span data-ttu-id="ce87a-159">Gestion des messages incohérents</span><span class="sxs-lookup"><span data-stu-id="ce87a-159">Poison Message Handling</span></span>](poison-message-handling.md)
