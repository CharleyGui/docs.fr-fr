---
title: Débogage d'erreurs d'authentification Windows
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- WCF, authentication
- WCF, Windows authentication
ms.assetid: 181be4bd-79b1-4a66-aee2-931887a6d7cc
ms.openlocfilehash: 20ca8f049298f75412da4c8a7e58975954f67741
ms.sourcegitcommit: 68653db98c5ea7744fd438710248935f70020dfb
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/22/2019
ms.locfileid: "69968860"
---
# <a name="debugging-windows-authentication-errors"></a><span data-ttu-id="df3a8-102">Débogage d'erreurs d'authentification Windows</span><span class="sxs-lookup"><span data-stu-id="df3a8-102">Debugging Windows Authentication Errors</span></span>
<span data-ttu-id="df3a8-103">Lorsque vous utilisez l'authentification Windows comme un mécanisme de sécurité, l'interface SSPI (Security Support Provider Interface) gère les processus de sécurité.</span><span class="sxs-lookup"><span data-stu-id="df3a8-103">When using Windows authentication as a security mechanism, the Security Support Provider Interface (SSPI) handles security processes.</span></span> <span data-ttu-id="df3a8-104">Lorsque des erreurs de sécurité se produisent au niveau de la couche SSPI, elles sont signalées par Windows Communication Foundation (WCF).</span><span class="sxs-lookup"><span data-stu-id="df3a8-104">When security errors occur at the SSPI layer, they are surfaced by Windows Communication Foundation (WCF).</span></span> <span data-ttu-id="df3a8-105">Cette rubrique fournit une infrastructure et un ensemble de questions permettant de diagnostiquer les erreurs.</span><span class="sxs-lookup"><span data-stu-id="df3a8-105">This topic provides a framework and set of questions to help diagnose the errors.</span></span>  
  
 <span data-ttu-id="df3a8-106">Pour obtenir une vue d’ensemble du protocole Kerberos, consultez [explication de Kerberos](https://go.microsoft.com/fwlink/?LinkID=86946). pour obtenir une vue d’ensemble de SSPI, consultez [SSPI](https://go.microsoft.com/fwlink/?LinkId=88941).</span><span class="sxs-lookup"><span data-stu-id="df3a8-106">For an overview of the Kerberos protocol, see [Kerberos Explained](https://go.microsoft.com/fwlink/?LinkID=86946); for an overview of SSPI, see [SSPI](https://go.microsoft.com/fwlink/?LinkId=88941).</span></span>  
  
 <span data-ttu-id="df3a8-107">Pour l’authentification Windows, WCF utilise généralement le fournisseur SSP (Security Support Provider) *Negotiate* , qui effectue une authentification mutuelle Kerberos entre le client et le service.</span><span class="sxs-lookup"><span data-stu-id="df3a8-107">For Windows authentication, WCF typically uses the *Negotiate* Security Support Provider (SSP), which performs Kerberos mutual authentication between the client and service.</span></span> <span data-ttu-id="df3a8-108">Si le protocole Kerberos n’est pas disponible, WCF revient par défaut à NT LAN Manager (NTLM).</span><span class="sxs-lookup"><span data-stu-id="df3a8-108">If the Kerberos protocol is not available, by default WCF falls back to NT LAN Manager (NTLM).</span></span> <span data-ttu-id="df3a8-109">Toutefois, vous pouvez configurer WCF pour utiliser uniquement le protocole Kerberos (et pour lever une exception si Kerberos n’est pas disponible).</span><span class="sxs-lookup"><span data-stu-id="df3a8-109">However, you can configure WCF to use only the Kerberos protocol (and to throw an exception if Kerberos is not available).</span></span> <span data-ttu-id="df3a8-110">Vous pouvez également configurer WCF pour utiliser des formes restreintes du protocole Kerberos.</span><span class="sxs-lookup"><span data-stu-id="df3a8-110">You can also configure WCF to use restricted forms of the Kerberos protocol.</span></span>  
  
## <a name="debugging-methodology"></a><span data-ttu-id="df3a8-111">Méthodologie de débogage</span><span class="sxs-lookup"><span data-stu-id="df3a8-111">Debugging Methodology</span></span>  
 <span data-ttu-id="df3a8-112">La méthode de base est la suivante :</span><span class="sxs-lookup"><span data-stu-id="df3a8-112">The basic method is as follows:</span></span>  
  
1. <span data-ttu-id="df3a8-113">Déterminez si vous utilisez l'authentification Windows.</span><span class="sxs-lookup"><span data-stu-id="df3a8-113">Determine whether you are using Windows authentication.</span></span> <span data-ttu-id="df3a8-114">Si vous utilisez un autre schéma, cette rubrique ne s'applique pas.</span><span class="sxs-lookup"><span data-stu-id="df3a8-114">If you are using any other scheme, this topic does not apply.</span></span>  
  
2. <span data-ttu-id="df3a8-115">Si vous êtes sûr d’utiliser l’authentification Windows, déterminez si votre configuration WCF utilise Kerberos direct ou Negotiate.</span><span class="sxs-lookup"><span data-stu-id="df3a8-115">If you are sure you are using Windows authentication, determine whether your WCF configuration uses Kerberos direct or Negotiate.</span></span>  
  
3. <span data-ttu-id="df3a8-116">Une fois que vous avez déterminé si votre configuration utilise le protocole Kerberos ou NTLM, vous pouvez comprendre les messages d'erreur dans le contexte correct.</span><span class="sxs-lookup"><span data-stu-id="df3a8-116">Once you have determined whether your configuration is using the Kerberos protocol or NTLM, you can understand error messages in the correct context.</span></span>  
  
### <a name="availability-of-the-kerberos-protocol-and-ntlm"></a><span data-ttu-id="df3a8-117">Disponibilité du protocole Kerberos et de NTLM</span><span class="sxs-lookup"><span data-stu-id="df3a8-117">Availability of the Kerberos Protocol and NTLM</span></span>  
 <span data-ttu-id="df3a8-118">Le fournisseur SSP Kerberos requiert qu'un contrôleur de domaine se comporte comme un centre de distribution de clés (KDC, Key Distribution Center).</span><span class="sxs-lookup"><span data-stu-id="df3a8-118">The Kerberos SSP requires a domain controller to act as the Kerberos Key Distribution Center (KDC).</span></span> <span data-ttu-id="df3a8-119">Le protocole Kerberos est disponible uniquement lorsque le client et le service utilisent des identités de domaine.</span><span class="sxs-lookup"><span data-stu-id="df3a8-119">The Kerberos protocol is available only when both the client and service are using domain identities.</span></span> <span data-ttu-id="df3a8-120">NTLM est utilisé dans d'autres combinaisons de comptes, tel qu'indiqué dans le tableau suivant.</span><span class="sxs-lookup"><span data-stu-id="df3a8-120">In other account combinations, NTLM is used, as summarized in the following table.</span></span>  
  
 <span data-ttu-id="df3a8-121">Les en-têtes du tableau présentent les types de compte possibles utilisés par le serveur.</span><span class="sxs-lookup"><span data-stu-id="df3a8-121">The table headers show possible account types used by the server.</span></span> <span data-ttu-id="df3a8-122">La colonne de gauche présente les types de compte possibles utilisés par le client.</span><span class="sxs-lookup"><span data-stu-id="df3a8-122">The left column shows possible account types used by the client.</span></span>  
  
||<span data-ttu-id="df3a8-123">Utilisateur local</span><span class="sxs-lookup"><span data-stu-id="df3a8-123">Local User</span></span>|<span data-ttu-id="df3a8-124">Système local</span><span class="sxs-lookup"><span data-stu-id="df3a8-124">Local System</span></span>|<span data-ttu-id="df3a8-125">Utilisateur de domaine</span><span class="sxs-lookup"><span data-stu-id="df3a8-125">Domain User</span></span>|<span data-ttu-id="df3a8-126">Ordinateur de domaine</span><span class="sxs-lookup"><span data-stu-id="df3a8-126">Domain Machine</span></span>|  
|-|----------------|------------------|-----------------|--------------------|  
|<span data-ttu-id="df3a8-127">Utilisateur local</span><span class="sxs-lookup"><span data-stu-id="df3a8-127">Local User</span></span>|<span data-ttu-id="df3a8-128">NTLM</span><span class="sxs-lookup"><span data-stu-id="df3a8-128">NTLM</span></span>|<span data-ttu-id="df3a8-129">NTLM</span><span class="sxs-lookup"><span data-stu-id="df3a8-129">NTLM</span></span>|<span data-ttu-id="df3a8-130">NTLM</span><span class="sxs-lookup"><span data-stu-id="df3a8-130">NTLM</span></span>|<span data-ttu-id="df3a8-131">NTLM</span><span class="sxs-lookup"><span data-stu-id="df3a8-131">NTLM</span></span>|  
|<span data-ttu-id="df3a8-132">Système local</span><span class="sxs-lookup"><span data-stu-id="df3a8-132">Local System</span></span>|<span data-ttu-id="df3a8-133">NTLM anonyme</span><span class="sxs-lookup"><span data-stu-id="df3a8-133">Anonymous NTLM</span></span>|<span data-ttu-id="df3a8-134">NTLM anonyme</span><span class="sxs-lookup"><span data-stu-id="df3a8-134">Anonymous NTLM</span></span>|<span data-ttu-id="df3a8-135">NTLM anonyme</span><span class="sxs-lookup"><span data-stu-id="df3a8-135">Anonymous NTLM</span></span>|<span data-ttu-id="df3a8-136">NTLM anonyme</span><span class="sxs-lookup"><span data-stu-id="df3a8-136">Anonymous NTLM</span></span>|  
|<span data-ttu-id="df3a8-137">Utilisateur de domaine</span><span class="sxs-lookup"><span data-stu-id="df3a8-137">Domain User</span></span>|<span data-ttu-id="df3a8-138">NTLM</span><span class="sxs-lookup"><span data-stu-id="df3a8-138">NTLM</span></span>|<span data-ttu-id="df3a8-139">NTLM</span><span class="sxs-lookup"><span data-stu-id="df3a8-139">NTLM</span></span>|<span data-ttu-id="df3a8-140">Kerberos</span><span class="sxs-lookup"><span data-stu-id="df3a8-140">Kerberos</span></span>|<span data-ttu-id="df3a8-141">Kerberos</span><span class="sxs-lookup"><span data-stu-id="df3a8-141">Kerberos</span></span>|  
|<span data-ttu-id="df3a8-142">Ordinateur de domaine</span><span class="sxs-lookup"><span data-stu-id="df3a8-142">Domain Machine</span></span>|<span data-ttu-id="df3a8-143">NTLM</span><span class="sxs-lookup"><span data-stu-id="df3a8-143">NTLM</span></span>|<span data-ttu-id="df3a8-144">NTLM</span><span class="sxs-lookup"><span data-stu-id="df3a8-144">NTLM</span></span>|<span data-ttu-id="df3a8-145">Kerberos</span><span class="sxs-lookup"><span data-stu-id="df3a8-145">Kerberos</span></span>|<span data-ttu-id="df3a8-146">Kerberos</span><span class="sxs-lookup"><span data-stu-id="df3a8-146">Kerberos</span></span>|  
  
 <span data-ttu-id="df3a8-147">Plus précisément, les quatre types de comptes incluent :</span><span class="sxs-lookup"><span data-stu-id="df3a8-147">Specifically, the four account types include:</span></span>  
  
- <span data-ttu-id="df3a8-148">Utilisateur local: Profil utilisateur machine uniquement.</span><span class="sxs-lookup"><span data-stu-id="df3a8-148">Local User: Machine-only user profile.</span></span> <span data-ttu-id="df3a8-149">Par exemple : `MachineName\Administrator` ou `MachineName\ProfileName`.</span><span class="sxs-lookup"><span data-stu-id="df3a8-149">For example: `MachineName\Administrator` or `MachineName\ProfileName`.</span></span>  
  
- <span data-ttu-id="df3a8-150">Système local: SYSTÈME de compte intégré sur un ordinateur qui n’est pas joint à un domaine.</span><span class="sxs-lookup"><span data-stu-id="df3a8-150">Local System: The built-in account SYSTEM on a machine that is not joined to a domain.</span></span>  
  
- <span data-ttu-id="df3a8-151">Utilisateur de domaine: Un compte d’utilisateur sur un domaine Windows.</span><span class="sxs-lookup"><span data-stu-id="df3a8-151">Domain User: A user account on a Windows domain.</span></span> <span data-ttu-id="df3a8-152">Par exemple : `DomainName\ProfileName`.</span><span class="sxs-lookup"><span data-stu-id="df3a8-152">For example: `DomainName\ProfileName`.</span></span>  
  
- <span data-ttu-id="df3a8-153">Ordinateur de domaine: Processus avec l’identité de l’ordinateur en cours d’exécution sur un ordinateur joint à un domaine Windows.</span><span class="sxs-lookup"><span data-stu-id="df3a8-153">Domain Machine: A process with machine identity running on a machine joined to a Windows domain.</span></span> <span data-ttu-id="df3a8-154">Par exemple : `MachineName\Network Service`.</span><span class="sxs-lookup"><span data-stu-id="df3a8-154">For example: `MachineName\Network Service`.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="df3a8-155">Les informations d'identification du service sont capturées lorsque la méthode <xref:System.ServiceModel.ICommunicationObject.Open%2A> de la classe <xref:System.ServiceModel.ServiceHost> est appelée.</span><span class="sxs-lookup"><span data-stu-id="df3a8-155">The service credential is captured when the <xref:System.ServiceModel.ICommunicationObject.Open%2A> method of the <xref:System.ServiceModel.ServiceHost> class is called.</span></span> <span data-ttu-id="df3a8-156">Les informations d'identification du client sont lues chaque fois que le client envoie un message.</span><span class="sxs-lookup"><span data-stu-id="df3a8-156">The client credential is read whenever the client sends a message.</span></span>  
  
## <a name="common-windows-authentication-problems"></a><span data-ttu-id="df3a8-157">Problèmes courants d'authentification Windows</span><span class="sxs-lookup"><span data-stu-id="df3a8-157">Common Windows Authentication Problems</span></span>  
 <span data-ttu-id="df3a8-158">Cette section présente certains problèmes d'authentification Windows courants et les solutions possibles.</span><span class="sxs-lookup"><span data-stu-id="df3a8-158">This section discusses some common Windows authentication problems and possible remedies.</span></span>  
  
### <a name="kerberos-protocol"></a><span data-ttu-id="df3a8-159">Protocole Kerberos</span><span class="sxs-lookup"><span data-stu-id="df3a8-159">Kerberos Protocol</span></span>  
  
#### <a name="spnupn-problems-with-the-kerberos-protocol"></a><span data-ttu-id="df3a8-160">Problèmes de SPN/UPN rencontrés avec le protocole Kerberos</span><span class="sxs-lookup"><span data-stu-id="df3a8-160">SPN/UPN Problems with the Kerberos Protocol</span></span>  
 <span data-ttu-id="df3a8-161">Si vous utilisez l'authentification Windows, et que le protocole Kerberos est utilisé ou négocié par SSPI, l'URL utilisée par le point de terminaison client doit inclure le nom de domaine complet de l'hôte du service dans l'URL de service.</span><span class="sxs-lookup"><span data-stu-id="df3a8-161">When using Windows authentication, and the Kerberos protocol is used or negotiated by SSPI, the URL the client endpoint uses must include the fully qualified domain name of the service's host inside the service URL.</span></span> <span data-ttu-id="df3a8-162">Cela suppose que le compte sous lequel le service s’exécute a accès à la clé du nom de principal du service (SPN) de l’ordinateur (par défaut) qui est créée lorsque l’ordinateur est ajouté au domaine Active Directory, ce qui est le plus souvent effectué en exécutant le service sous le Compte de service réseau.</span><span class="sxs-lookup"><span data-stu-id="df3a8-162">This assumes that the account under which the service is running has access to the machine (default) service principal name (SPN) key that is created when the computer is added to the Active Directory domain, which is most commonly done by running the service under the Network Service account.</span></span> <span data-ttu-id="df3a8-163">Si le service n'a pas accès à la clé SPN de l'ordinateur, vous devez fournir le SPN correct ou un nom d'utilisateur principal (UPN, User Principal Name) du compte sous lequel le service s'exécute dans l'identité de point de terminaison du client.</span><span class="sxs-lookup"><span data-stu-id="df3a8-163">If the service does not have access to the machine SPN key, you must supply the correct SPN or user principal name (UPN) of the account under which the service is running in the client's endpoint identity.</span></span> <span data-ttu-id="df3a8-164">Pour plus d’informations sur le fonctionnement de WCF avec SPN et UPN, consultez [identité du service et authentification](../../../../docs/framework/wcf/feature-details/service-identity-and-authentication.md).</span><span class="sxs-lookup"><span data-stu-id="df3a8-164">For more information about how WCF works with SPN and UPN, see [Service Identity and Authentication](../../../../docs/framework/wcf/feature-details/service-identity-and-authentication.md).</span></span>  
  
 <span data-ttu-id="df3a8-165">Dans les scénarios d'équilibrage de charge, tels que les batteries de serveurs Web ou les jardins Web, une pratique courante consiste à définir un compte unique pour chaque application, assigner un SPN à ce compte et veiller à ce que tous les services de l'application s'exécutent sous ce compte.</span><span class="sxs-lookup"><span data-stu-id="df3a8-165">In load-balancing scenarios, such as Web farms or Web gardens, a common practice is to define a unique account for each application, assign an SPN to that account, and ensure that all of the application's services run in that account.</span></span>  
  
 <span data-ttu-id="df3a8-166">Pour obtenir un SPN pour le compte de votre service, vous devez être administrateur de domaine Active Directory.</span><span class="sxs-lookup"><span data-stu-id="df3a8-166">To obtain an SPN for your service's account, you need to be an Active Directory domain administrator.</span></span> <span data-ttu-id="df3a8-167">Pour plus d’informations, consultez [supplément technique Kerberos pour Windows](https://go.microsoft.com/fwlink/?LinkID=88330).</span><span class="sxs-lookup"><span data-stu-id="df3a8-167">For more information, see [Kerberos Technical Supplement for Windows](https://go.microsoft.com/fwlink/?LinkID=88330).</span></span>  
  
#### <a name="kerberos-protocol-direct-requires-the-service-to-run-under-a-domain-machine-account"></a><span data-ttu-id="df3a8-168">Le protocole Kerberos direct requiert l'exécution du service sous un compte d'ordinateur de domaine</span><span class="sxs-lookup"><span data-stu-id="df3a8-168">Kerberos Protocol Direct Requires the Service to Run Under a Domain Machine Account</span></span>  
 <span data-ttu-id="df3a8-169">Cela se produit lorsque la propriété `ClientCredentialType` a la valeur `Windows` et que la propriété <xref:System.ServiceModel.MessageSecurityOverHttp.NegotiateServiceCredential%2A> a la valeur `false`, tel qu'indiqué dans le code suivant.</span><span class="sxs-lookup"><span data-stu-id="df3a8-169">This occurs when the `ClientCredentialType` property is set to `Windows` and the <xref:System.ServiceModel.MessageSecurityOverHttp.NegotiateServiceCredential%2A> property is set to `false`, as shown in the following code.</span></span>  
  
 [!code-csharp[C_DebuggingWindowsAuth#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_debuggingwindowsauth/cs/source.cs#1)]
 [!code-vb[C_DebuggingWindowsAuth#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_debuggingwindowsauth/vb/source.vb#1)]  
  
 <span data-ttu-id="df3a8-170">Pour y remédier, exécutez le service à l'aide d'un compte d'ordinateur de domaine, tel que Service réseau, sur un ordinateur joint au domaine.</span><span class="sxs-lookup"><span data-stu-id="df3a8-170">To remedy, run the service using a Domain Machine account, such as Network Service, on a domain joined machine.</span></span>  
  
### <a name="delegation-requires-credential-negotiation"></a><span data-ttu-id="df3a8-171">La délégation nécessite la négociation des informations d'identification</span><span class="sxs-lookup"><span data-stu-id="df3a8-171">Delegation Requires Credential Negotiation</span></span>  
 <span data-ttu-id="df3a8-172">Pour utiliser le protocole d'authentification Kerberos avec délégation, vous devez implémenter le protocole Kerberos avec la négociation d'informations d'identification (parfois appelé Kerberos « multi-leg » ou Kerberos « multi-step »).</span><span class="sxs-lookup"><span data-stu-id="df3a8-172">To use the Kerberos authentication protocol with delegation, you must implement the Kerberos protocol with credential negotiation (sometimes called "multi-leg" or "multi-step" Kerberos).</span></span> <span data-ttu-id="df3a8-173">Si vous implémentez l'authentification Kerberos sans négociation d'informations d'identification (parfois appelée Kerberos « one-shot » ou Kerberos « single-leg »), une exception sera levée.</span><span class="sxs-lookup"><span data-stu-id="df3a8-173">If you implement Kerberos authentication without credential negotiation (sometimes called "one-shot" or "single-leg" Kerberos), an exception will be thrown.</span></span>  
  
 <span data-ttu-id="df3a8-174">Pour implémenter Kerberos avec la négociation d'information d'identification, procédez comme suit :</span><span class="sxs-lookup"><span data-stu-id="df3a8-174">To implement Kerberos with credential negotiation, do the following steps:</span></span>  
  
1. <span data-ttu-id="df3a8-175">Implémentez la délégation en affectant <xref:System.ServiceModel.Security.WindowsClientCredential.AllowedImpersonationLevel%2A> à <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>.</span><span class="sxs-lookup"><span data-stu-id="df3a8-175">Implement delegation by setting <xref:System.ServiceModel.Security.WindowsClientCredential.AllowedImpersonationLevel%2A> to <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>.</span></span>  
  
2. <span data-ttu-id="df3a8-176">Requérez la négociation SSPI :</span><span class="sxs-lookup"><span data-stu-id="df3a8-176">Require SSPI negotiation:</span></span>  
  
    1. <span data-ttu-id="df3a8-177">Si vous utilisez des liaisons standard, affectez `NegotiateServiceCredential` à la propriété `true`.</span><span class="sxs-lookup"><span data-stu-id="df3a8-177">If you are using standard bindings, set the `NegotiateServiceCredential` property to `true`.</span></span>  
  
    2. <span data-ttu-id="df3a8-178">Si vous utilisez des liaisons personnalisées, affectez `AuthenticationMode` à l’attribut `Security` de l’élément `SspiNegotiated`.</span><span class="sxs-lookup"><span data-stu-id="df3a8-178">If you are using custom bindings, set the `AuthenticationMode` attribute of the `Security` element to `SspiNegotiated`.</span></span>  
  
3. <span data-ttu-id="df3a8-179">Requérez que la négociation SSPI utilise Kerberos en interdisant l'utilisation de NTLM :</span><span class="sxs-lookup"><span data-stu-id="df3a8-179">Require the SSPI negotiation to use Kerberos by disallowing the use of NTLM:</span></span>  
  
    1. <span data-ttu-id="df3a8-180">Effectuez cette opération dans le code, à l'aide de l'instruction suivante : `ChannelFactory.Credentials.Windows.AllowNtlm = false`</span><span class="sxs-lookup"><span data-stu-id="df3a8-180">Do this in code, with the following statement: `ChannelFactory.Credentials.Windows.AllowNtlm = false`</span></span>  
  
    2. <span data-ttu-id="df3a8-181">Vous pouvez également effectuer cette opération dans le fichier de configuration en affectant `allowNtlm` à l'attribut `false`.</span><span class="sxs-lookup"><span data-stu-id="df3a8-181">Or you can do this in the configuration file by setting the `allowNtlm` attribute to `false`.</span></span> <span data-ttu-id="df3a8-182">Cet attribut est contenu dans le [ \<> Windows](../../../../docs/framework/configure-apps/file-schema/wcf/windows-of-clientcredentials-element.md).</span><span class="sxs-lookup"><span data-stu-id="df3a8-182">This attribute is contained in the [\<windows>](../../../../docs/framework/configure-apps/file-schema/wcf/windows-of-clientcredentials-element.md).</span></span>  
  
### <a name="ntlm-protocol"></a><span data-ttu-id="df3a8-183">Protocole NTLM</span><span class="sxs-lookup"><span data-stu-id="df3a8-183">NTLM Protocol</span></span>  
  
#### <a name="negotiate-ssp-falls-back-to-ntlm-but-ntlm-is-disabled"></a><span data-ttu-id="df3a8-184">Négociation du retour de SSP à NTLM, mais NTLM est désactivé</span><span class="sxs-lookup"><span data-stu-id="df3a8-184">Negotiate SSP Falls Back to NTLM, but NTLM Is Disabled</span></span>  
 <span data-ttu-id="df3a8-185">La <xref:System.ServiceModel.Security.WindowsClientCredential.AllowNtlm%2A> propriété a la `false`valeur, ce qui amène Windows Communication Foundation (WCF) à lever un meilleur effort pour lever une exception si NTLM est utilisé.</span><span class="sxs-lookup"><span data-stu-id="df3a8-185">The <xref:System.ServiceModel.Security.WindowsClientCredential.AllowNtlm%2A> property is set to `false`, which causes Windows Communication Foundation (WCF) to make a best-effort to throw an exception if NTLM is used.</span></span> <span data-ttu-id="df3a8-186">Notez que l'affectation de la valeur `false` à cette propriété peut ne pas empêcher la transmission des informations d'identification NTLM.</span><span class="sxs-lookup"><span data-stu-id="df3a8-186">Note that setting this property to `false` may not prevent NTLM credentials from being sent over the wire.</span></span>  
  
 <span data-ttu-id="df3a8-187">La section suivante indique comment désactiver le retour à NTLM.</span><span class="sxs-lookup"><span data-stu-id="df3a8-187">The following shows how to disable fallback to NTLM.</span></span>  
  
 [!code-csharp[C_DebuggingWindowsAuth#4](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_debuggingwindowsauth/cs/source.cs#4)]
 [!code-vb[C_DebuggingWindowsAuth#4](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_debuggingwindowsauth/vb/source.vb#4)]  
  
#### <a name="ntlm-logon-fails"></a><span data-ttu-id="df3a8-188">Échec d'ouverture de session NTLM</span><span class="sxs-lookup"><span data-stu-id="df3a8-188">NTLM Logon Fails</span></span>  
 <span data-ttu-id="df3a8-189">Les informations d'identification du client ne sont pas valides sur le service.</span><span class="sxs-lookup"><span data-stu-id="df3a8-189">The client credentials are not valid on the service.</span></span> <span data-ttu-id="df3a8-190">Vérifiez que le nom d'utilisateur et le mot de passe sont correctement définis et correspondent à un compte connu sur l'ordinateur sur lequel le service s'exécute.</span><span class="sxs-lookup"><span data-stu-id="df3a8-190">Check that the user name and password are correctly set and correspond to an account that is known to the computer where the service is running.</span></span> <span data-ttu-id="df3a8-191">NTLM utilise les informations d'identification spécifiées pour se connecter à l'ordinateur du service.</span><span class="sxs-lookup"><span data-stu-id="df3a8-191">NTLM uses the specified credentials to log on to the service's computer.</span></span> <span data-ttu-id="df3a8-192">Même si les informations d'identification sont valides sur l'ordinateur sur lequel le client s'exécute, cette ouverture de session échouera si elles ne sont pas valides sur l'ordinateur du service.</span><span class="sxs-lookup"><span data-stu-id="df3a8-192">While the credentials may be valid on the computer where the client is running, this logon will fail if the credentials are not valid on the service's computer.</span></span>  
  
#### <a name="anonymous-ntlm-logon-occurs-but-anonymous-logons-are-disabled-by-default"></a><span data-ttu-id="df3a8-193">Une ouverture de session NTLM anonyme se produit, mais les ouvertures de session anonymes sont désactivées par défaut</span><span class="sxs-lookup"><span data-stu-id="df3a8-193">Anonymous NTLM Logon Occurs, but Anonymous Logons Are Disabled by Default</span></span>  
 <span data-ttu-id="df3a8-194">Lors de la création d'un client, la propriété <xref:System.ServiceModel.Security.WindowsClientCredential.AllowedImpersonationLevel%2A> a la valeur <xref:System.Security.Principal.TokenImpersonationLevel.Anonymous>, tel qu'indiqué dans l'exemple suivant, mais par défaut, le serveur interdit les ouvertures de session anonymes.</span><span class="sxs-lookup"><span data-stu-id="df3a8-194">When creating a client, the <xref:System.ServiceModel.Security.WindowsClientCredential.AllowedImpersonationLevel%2A> property is set to <xref:System.Security.Principal.TokenImpersonationLevel.Anonymous>, as shown in the following example, but by default the server disallows anonymous logons.</span></span> <span data-ttu-id="df3a8-195">En effet, la valeur par défaut de la propriété <xref:System.ServiceModel.Security.WindowsServiceCredential.AllowAnonymousLogons%2A> de la classe <xref:System.ServiceModel.Security.WindowsServiceCredential> est `false`.</span><span class="sxs-lookup"><span data-stu-id="df3a8-195">This occurs because the default value of the <xref:System.ServiceModel.Security.WindowsServiceCredential.AllowAnonymousLogons%2A> property of the <xref:System.ServiceModel.Security.WindowsServiceCredential> class is `false`.</span></span>  
  
 <span data-ttu-id="df3a8-196">Le code client suivant tente d'activer des ouvertures de session anonymes (notez que la propriété par défaut est `Identification`).</span><span class="sxs-lookup"><span data-stu-id="df3a8-196">The following client code attempts to enable anonymous logons (note that the default property is `Identification`).</span></span>  
  
 [!code-csharp[C_DebuggingWindowsAuth#5](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_debuggingwindowsauth/cs/source.cs#5)]
 [!code-vb[C_DebuggingWindowsAuth#5](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_debuggingwindowsauth/vb/source.vb#5)]  
  
 <span data-ttu-id="df3a8-197">Le code de service suivant modifie la valeur par défaut afin d'activer des ouvertures de session anonymes par le serveur.</span><span class="sxs-lookup"><span data-stu-id="df3a8-197">The following service code changes the default to enable anonymous logons by the server.</span></span>  
  
 [!code-csharp[C_DebuggingWindowsAuth#6](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_debuggingwindowsauth/cs/source.cs#6)]
 [!code-vb[C_DebuggingWindowsAuth#6](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_debuggingwindowsauth/vb/source.vb#6)]  
  
 <span data-ttu-id="df3a8-198">Pour plus d’informations sur l’emprunt d’identité, consultez [délégation et emprunt d’identité](../../../../docs/framework/wcf/feature-details/delegation-and-impersonation-with-wcf.md).</span><span class="sxs-lookup"><span data-stu-id="df3a8-198">For more information about impersonation, see [Delegation and Impersonation](../../../../docs/framework/wcf/feature-details/delegation-and-impersonation-with-wcf.md).</span></span>  
  
 <span data-ttu-id="df3a8-199">Le client s'exécute également en tant que service Windows, à l'aide du compte intégré SYSTEM.</span><span class="sxs-lookup"><span data-stu-id="df3a8-199">Alternatively, the client is running as a Windows service, using the built-in account SYSTEM.</span></span>  
  
### <a name="other-problems"></a><span data-ttu-id="df3a8-200">Autres problèmes</span><span class="sxs-lookup"><span data-stu-id="df3a8-200">Other Problems</span></span>  
  
#### <a name="client-credentials-are-not-set-correctly"></a><span data-ttu-id="df3a8-201">Les informations d'identification du client ne sont pas correctement définies</span><span class="sxs-lookup"><span data-stu-id="df3a8-201">Client Credentials Are Not Set Correctly</span></span>  
 <span data-ttu-id="df3a8-202">L'authentification Windows utilise l'instance <xref:System.ServiceModel.Security.WindowsClientCredential> retournée par la propriété <xref:System.ServiceModel.ClientBase%601.ClientCredentials%2A> de la classe <xref:System.ServiceModel.ClientBase%601>, et non pas <xref:System.ServiceModel.Security.UserNamePasswordClientCredential>.</span><span class="sxs-lookup"><span data-stu-id="df3a8-202">Windows authentication uses the <xref:System.ServiceModel.Security.WindowsClientCredential> instance returned by the <xref:System.ServiceModel.ClientBase%601.ClientCredentials%2A> property of the <xref:System.ServiceModel.ClientBase%601> class, not the <xref:System.ServiceModel.Security.UserNamePasswordClientCredential>.</span></span> <span data-ttu-id="df3a8-203">Le code suivant présente un exemple incorrect.</span><span class="sxs-lookup"><span data-stu-id="df3a8-203">The following shows an incorrect example.</span></span>  
  
 [!code-csharp[C_DebuggingWindowsAuth#2](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_debuggingwindowsauth/cs/source.cs#2)]
 [!code-vb[C_DebuggingWindowsAuth#2](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_debuggingwindowsauth/vb/source.vb#2)]  
  
 <span data-ttu-id="df3a8-204">Le code suivant présente l'exemple correct.</span><span class="sxs-lookup"><span data-stu-id="df3a8-204">The following shows the correct example.</span></span>  
  
 [!code-csharp[C_DebuggingWindowsAuth#3](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_debuggingwindowsauth/cs/source.cs#3)]
 [!code-vb[C_DebuggingWindowsAuth#3](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_debuggingwindowsauth/vb/source.vb#3)]  
  
#### <a name="sspi-is-not-available"></a><span data-ttu-id="df3a8-205">SSPI n'est pas disponible</span><span class="sxs-lookup"><span data-stu-id="df3a8-205">SSPI Is Not Available</span></span>  
 <span data-ttu-id="df3a8-206">Les systèmes d’exploitation suivants ne prennent pas en charge l’authentification Windows lorsqu’ils sont utilisés en tant que serveur: [!INCLUDE[wxp](../../../../includes/wxp-md.md)]Édition personnelle, [!INCLUDE[wxp](../../../../includes/wxp-md.md)] Édition Media Center et [!INCLUDE[wv](../../../../includes/wv-md.md)]Éditions familiales.</span><span class="sxs-lookup"><span data-stu-id="df3a8-206">The following operating systems do not support Windows authentication when used as a server: [!INCLUDE[wxp](../../../../includes/wxp-md.md)] Home Edition, [!INCLUDE[wxp](../../../../includes/wxp-md.md)] Media Center Edition, and [!INCLUDE[wv](../../../../includes/wv-md.md)]Home editions.</span></span>  
  
#### <a name="developing-and-deploying-with-different-identities"></a><span data-ttu-id="df3a8-207">Développement et déploiement avec des identités différentes</span><span class="sxs-lookup"><span data-stu-id="df3a8-207">Developing and Deploying with Different Identities</span></span>  
 <span data-ttu-id="df3a8-208">Si vous développez votre application sur un ordinateur, la déployez sur un autre et utilisez différents types de compte pour vous authentifier sur chaque ordinateur, vous pouvez observer un comportement différent.</span><span class="sxs-lookup"><span data-stu-id="df3a8-208">If you develop your application on one machine, and deploy on another, and use different account types to authenticate on each machine, you may experience different behavior.</span></span> <span data-ttu-id="df3a8-209">Par exemple, supposons que vous développiez votre application sur un ordinateur Windows XP Professionnel à l’aide du mode d’authentification `SSPI Negotiated`.</span><span class="sxs-lookup"><span data-stu-id="df3a8-209">For example, suppose you develop your application on a Windows XP Pro machine using the `SSPI Negotiated` authentication mode.</span></span> <span data-ttu-id="df3a8-210">Si vous utilisez un compte d'utilisateur local pour vous authentifier, le protocole NTLM sera alors utilisé.</span><span class="sxs-lookup"><span data-stu-id="df3a8-210">If you use a local user account to authenticate with, then NTLM protocol will be used.</span></span> <span data-ttu-id="df3a8-211">Une fois que l'application est développée, vous déployez le service sur un ordinateur Windows Server 2003 où il s'exécute sous un compte de domaine.</span><span class="sxs-lookup"><span data-stu-id="df3a8-211">Once the application is developed, you deploy the service to a Windows Server 2003 machine where it runs under a domain account.</span></span> <span data-ttu-id="df3a8-212">À ce stade, le client ne sera pas en mesure d'authentifier le service car il utilisera Kerberos et un contrôleur de domaine.</span><span class="sxs-lookup"><span data-stu-id="df3a8-212">At this point the client will not be able to authenticate the service because it will be using Kerberos and a domain controller.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="df3a8-213">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="df3a8-213">See also</span></span>

- <xref:System.ServiceModel.Security.WindowsClientCredential>
- <xref:System.ServiceModel.Security.WindowsServiceCredential>
- <xref:System.ServiceModel.Security.WindowsClientCredential>
- <xref:System.ServiceModel.ClientBase%601>
- [<span data-ttu-id="df3a8-214">Délégation et emprunt d’identité</span><span class="sxs-lookup"><span data-stu-id="df3a8-214">Delegation and Impersonation</span></span>](../../../../docs/framework/wcf/feature-details/delegation-and-impersonation-with-wcf.md)
- [<span data-ttu-id="df3a8-215">Scénarios non pris en charge</span><span class="sxs-lookup"><span data-stu-id="df3a8-215">Unsupported Scenarios</span></span>](../../../../docs/framework/wcf/feature-details/unsupported-scenarios.md)
