---
title: Délégation et emprunt d'identité avec WCF
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- impersonation [WCF]
- delegation [WCF]
ms.assetid: 110e60f7-5b03-4b69-b667-31721b8e3152
ms.openlocfilehash: 6e79346a448012255020cc28b6534e734980b1db
ms.sourcegitcommit: 68653db98c5ea7744fd438710248935f70020dfb
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/22/2019
ms.locfileid: "69968849"
---
# <a name="delegation-and-impersonation-with-wcf"></a><span data-ttu-id="0fac5-102">Délégation et emprunt d'identité avec WCF</span><span class="sxs-lookup"><span data-stu-id="0fac5-102">Delegation and Impersonation with WCF</span></span>
<span data-ttu-id="0fac5-103">L'*emprunt d'identité* est une technique courante utilisée par les services pour restreindre l'accès du client aux ressources d'un domaine de service.</span><span class="sxs-lookup"><span data-stu-id="0fac5-103">*Impersonation* is a common technique that services use to restrict client access to a service domain's resources.</span></span> <span data-ttu-id="0fac5-104">Les ressources de domaine de service peuvent être des ressources d'ordinateur, telles que des fichiers locaux (emprunt d'identité), ou une ressource sur un autre ordinateur, tel qu'un partage de fichiers (délégation).</span><span class="sxs-lookup"><span data-stu-id="0fac5-104">Service domain resources can either be machine resources, such as local files (impersonation), or a resource on another machine, such as a file share (delegation).</span></span> <span data-ttu-id="0fac5-105">Pour obtenir un exemple d'application, consultez [Impersonating the Client](../../../../docs/framework/wcf/samples/impersonating-the-client.md).</span><span class="sxs-lookup"><span data-stu-id="0fac5-105">For a sample application, see [Impersonating the Client](../../../../docs/framework/wcf/samples/impersonating-the-client.md).</span></span> <span data-ttu-id="0fac5-106">Pour obtenir un exemple d’utilisation de l’emprunt d’identité, [consultez Procédure: Emprunter l’identité d’un client sur un](../../../../docs/framework/wcf/how-to-impersonate-a-client-on-a-service.md)service.</span><span class="sxs-lookup"><span data-stu-id="0fac5-106">For an example of how to use impersonation, see [How to: Impersonate a Client on a Service](../../../../docs/framework/wcf/how-to-impersonate-a-client-on-a-service.md).</span></span>  
  
> [!IMPORTANT]
> <span data-ttu-id="0fac5-107">Sachez que lors de l'emprunt d'identité d'un client sur un service, le service s'exécute avec les informations d'identification du client, qui peut avoir des privilèges plus élevés que le processus serveur.</span><span class="sxs-lookup"><span data-stu-id="0fac5-107">Be aware that when impersonating a client on a service, the service runs with the client's credentials, which may have higher privileges than the server process.</span></span>  
  
## <a name="overview"></a><span data-ttu-id="0fac5-108">Vue d'ensemble</span><span class="sxs-lookup"><span data-stu-id="0fac5-108">Overview</span></span>  
 <span data-ttu-id="0fac5-109">Généralement, les clients appellent un client pour que celui-ci effectue une action au nom du client.</span><span class="sxs-lookup"><span data-stu-id="0fac5-109">Typically, clients call a service to have the service perform some action on the client’s behalf.</span></span> <span data-ttu-id="0fac5-110">L'emprunt d'identité permet au service d'agir comme le client lors de l'exécution de l'action.</span><span class="sxs-lookup"><span data-stu-id="0fac5-110">Impersonation allows the service to act as the client while performing the action.</span></span> <span data-ttu-id="0fac5-111">La délégation permet à un service frontal de transmettre la demande du client à un service principal d'une manière qui permet au service principal d'emprunter l'identité du client.</span><span class="sxs-lookup"><span data-stu-id="0fac5-111">Delegation allows a front-end service to forward the client’s request to a back-end service in such a way that the back-end service can also impersonate the client.</span></span> <span data-ttu-id="0fac5-112">L'emprunt d'identité est une méthode couramment utilisée pour vérifier si un client est autorisé à effectuer une action donnée. La délégation est une méthode permettant de transmettre les fonctions d'emprunt d'identité avec l'identité du client à un service principal.</span><span class="sxs-lookup"><span data-stu-id="0fac5-112">Impersonation is most commonly used as a way of checking whether a client is authorized to perform a particular action, while delegation is a way of flowing impersonation capabilities, along with the client’s identity, to a back-end service.</span></span> <span data-ttu-id="0fac5-113">La délégation est une fonctionnalité du domaine Windows qui peut être utilisée dans le cadre de l'authentification Kerberos.</span><span class="sxs-lookup"><span data-stu-id="0fac5-113">Delegation is a Windows domain feature that can be used when Kerberos-based authentication is performed.</span></span> <span data-ttu-id="0fac5-114">La délégation n'est pas la même chose que le flux d'identité et comme la délégation transfère la possibilité d'emprunter l'identité du client sans connaître son mot de passe, elle représente une opération d'un niveau de privilège supérieur au flux d'identité.</span><span class="sxs-lookup"><span data-stu-id="0fac5-114">Delegation is distinct from identity flow and, because delegation transfers the ability to impersonate the client without possession of the client’s password, it is a much higher privileged operation than identity flow.</span></span>  
  
 <span data-ttu-id="0fac5-115">L'emprunt d'identité et la délégation nécessitent que le client possède une identité Windows.</span><span class="sxs-lookup"><span data-stu-id="0fac5-115">Both impersonation and delegation require that the client have a Windows identity.</span></span> <span data-ttu-id="0fac5-116">Si ce n'est pas le cas, la seule option consiste à transmettre l'identité du client au second service.</span><span class="sxs-lookup"><span data-stu-id="0fac5-116">If a client does not possess a Windows identity, then the only option available is to flow the client’s identity to the second service.</span></span>  
  
## <a name="impersonation-basics"></a><span data-ttu-id="0fac5-117">Principes de base de l'emprunt d'identité</span><span class="sxs-lookup"><span data-stu-id="0fac5-117">Impersonation Basics</span></span>  
 <span data-ttu-id="0fac5-118">Windows Communication Foundation (WCF) prend en charge l’emprunt d’identité pour diverses informations d’identification du client.</span><span class="sxs-lookup"><span data-stu-id="0fac5-118">Windows Communication Foundation (WCF) supports impersonation for a variety of client credentials.</span></span> <span data-ttu-id="0fac5-119">Cette rubrique décrit la prise en charge de modèle de service permettant d'emprunter l'identité de l'appelant pendant l'implémentation d'une méthode de service.</span><span class="sxs-lookup"><span data-stu-id="0fac5-119">This topic describes service model support for impersonating the caller during the implementation of a service method.</span></span> <span data-ttu-id="0fac5-120">Les scénarios de déploiement courants impliquant l’emprunt d’identité et la sécurité SOAP et les options WCF dans ces scénarios sont également abordés.</span><span class="sxs-lookup"><span data-stu-id="0fac5-120">Also discussed are common deployment scenarios involving impersonation and SOAP security and WCF options in these scenarios.</span></span>  
  
 <span data-ttu-id="0fac5-121">Cette rubrique se concentre sur l’emprunt d’identité et la délégation dans WCF lors de l’utilisation de la sécurité SOAP.</span><span class="sxs-lookup"><span data-stu-id="0fac5-121">This topic focuses on impersonation and delegation in WCF when using SOAP security.</span></span> <span data-ttu-id="0fac5-122">Vous pouvez également utiliser l’emprunt d’identité et la délégation avec WCF lors de l’utilisation de la sécurité de transport, comme décrit dans [utilisation de l’emprunt d’identité avec la sécurité de transport](../../../../docs/framework/wcf/feature-details/using-impersonation-with-transport-security.md).</span><span class="sxs-lookup"><span data-stu-id="0fac5-122">You can also use impersonation and delegation with WCF when using transport security, as described in [Using Impersonation with Transport Security](../../../../docs/framework/wcf/feature-details/using-impersonation-with-transport-security.md).</span></span>  
  
## <a name="two-methods"></a><span data-ttu-id="0fac5-123">Deux méthodes</span><span class="sxs-lookup"><span data-stu-id="0fac5-123">Two Methods</span></span>  
 <span data-ttu-id="0fac5-124">La sécurité SOAP WCF a deux méthodes distinctes pour effectuer l’emprunt d’identité.</span><span class="sxs-lookup"><span data-stu-id="0fac5-124">WCF SOAP security has two distinct methods for performing impersonation.</span></span> <span data-ttu-id="0fac5-125">La méthode utilisée dépend de la liaison.</span><span class="sxs-lookup"><span data-stu-id="0fac5-125">The method used depends on the binding.</span></span> <span data-ttu-id="0fac5-126">L'une concerne l'emprunt d'identité à partir d'un jeton Windows fourni par l'authentification SSPI (Security Support Provider Interface) ou Kerberos, qui est ensuite mis en cache sur le service.</span><span class="sxs-lookup"><span data-stu-id="0fac5-126">One is impersonation from a Windows token obtained from the Security Support Provider Interface (SSPI) or Kerberos authentication, which is then cached on the service.</span></span> <span data-ttu-id="0fac5-127">La deuxième concerne l'emprunt d'identité à partir d'un jeton Windows fourni par les extensions Kerberos, collectivement appelées *S4U* (Service-for-User).</span><span class="sxs-lookup"><span data-stu-id="0fac5-127">The second is impersonation from a Windows token obtained from the Kerberos extensions, collectively called *Service-for-User* (S4U).</span></span>  
  
### <a name="cached-token-impersonation"></a><span data-ttu-id="0fac5-128">Emprunt d'identité avec jeton mis en cache</span><span class="sxs-lookup"><span data-stu-id="0fac5-128">Cached Token Impersonation</span></span>  
 <span data-ttu-id="0fac5-129">Vous pouvez effectuer l'emprunt d'identité avec jeton mis en cache à l'aide des éléments suivants :</span><span class="sxs-lookup"><span data-stu-id="0fac5-129">You can perform cached-token impersonation with the following:</span></span>  
  
- <span data-ttu-id="0fac5-130"><xref:System.ServiceModel.WSHttpBinding>, <xref:System.ServiceModel.WSDualHttpBinding>et <xref:System.ServiceModel.NetTcpBinding> avec une information d'identification de client Windows.</span><span class="sxs-lookup"><span data-stu-id="0fac5-130"><xref:System.ServiceModel.WSHttpBinding>, <xref:System.ServiceModel.WSDualHttpBinding>, and <xref:System.ServiceModel.NetTcpBinding> with a Windows client credential.</span></span>  
  
- <span data-ttu-id="0fac5-131"><xref:System.ServiceModel.BasicHttpBinding> avec <xref:System.ServiceModel.BasicHttpSecurityMode> défini à l'information d'identification <xref:System.ServiceModel.BasicHttpSecurityMode.TransportWithMessageCredential> , ou toute autre liaison standard dans laquelle le client présente une information d'identification de nom d'utilisateur que le service peut mapper à un compte Windows valide.</span><span class="sxs-lookup"><span data-stu-id="0fac5-131"><xref:System.ServiceModel.BasicHttpBinding> with a <xref:System.ServiceModel.BasicHttpSecurityMode> set to the <xref:System.ServiceModel.BasicHttpSecurityMode.TransportWithMessageCredential> credential, or any other standard binding where the client presents a user name credential that the service can map to a valid Windows account.</span></span>  
  
- <span data-ttu-id="0fac5-132">Tout <xref:System.ServiceModel.Channels.CustomBinding> qui utilise une information d'identification de client Windows avec `requireCancellation` défini à `true`.</span><span class="sxs-lookup"><span data-stu-id="0fac5-132">Any <xref:System.ServiceModel.Channels.CustomBinding> that uses a Windows client credential with the `requireCancellation` set to `true`.</span></span> <span data-ttu-id="0fac5-133">(La propriété est disponible sur les classes suivantes : <xref:System.ServiceModel.Security.Tokens.SecureConversationSecurityTokenParameters>, <xref:System.ServiceModel.Security.Tokens.SslSecurityTokenParameters> et <xref:System.ServiceModel.Security.Tokens.SspiSecurityTokenParameters>.) Si une conversation sécurisée est utilisée sur la liaison, sa propriété `requireCancellation` doit également avoir la valeur `true`.</span><span class="sxs-lookup"><span data-stu-id="0fac5-133">(The property is available on the following classes: <xref:System.ServiceModel.Security.Tokens.SecureConversationSecurityTokenParameters>, <xref:System.ServiceModel.Security.Tokens.SslSecurityTokenParameters>, and <xref:System.ServiceModel.Security.Tokens.SspiSecurityTokenParameters>.) If a secure conversation is used on the binding, it must also have the `requireCancellation` property set to `true`.</span></span>  
  
- <span data-ttu-id="0fac5-134">Tout <xref:System.ServiceModel.Channels.CustomBinding> où le client présente une information d'identification de nom d'utilisateur.</span><span class="sxs-lookup"><span data-stu-id="0fac5-134">Any <xref:System.ServiceModel.Channels.CustomBinding> where the client presents a user name credential.</span></span> <span data-ttu-id="0fac5-135">Si une conversation sécurisée est utilisée sur la liaison, sa propriété `requireCancellation` doit également avoir la valeur `true`.</span><span class="sxs-lookup"><span data-stu-id="0fac5-135">If secure conversation is used on the binding, it must also have the `requireCancellation` property set to `true`.</span></span>  
  
### <a name="s4u-based-impersonation"></a><span data-ttu-id="0fac5-136">Emprunt d'identité basé sur S4U</span><span class="sxs-lookup"><span data-stu-id="0fac5-136">S4U-Based Impersonation</span></span>  
 <span data-ttu-id="0fac5-137">Vous pouvez effectuer l'emprunt d'identité basé sur S4U à l'aide des éléments suivants :</span><span class="sxs-lookup"><span data-stu-id="0fac5-137">You can perform S4U-based impersonation with the following:</span></span>  
  
- <span data-ttu-id="0fac5-138"><xref:System.ServiceModel.WSHttpBinding>, <xref:System.ServiceModel.WSDualHttpBinding>et <xref:System.ServiceModel.NetTcpBinding> avec une information d'identification de client de certificat que le service peut mapper à un compte Windows valide.</span><span class="sxs-lookup"><span data-stu-id="0fac5-138"><xref:System.ServiceModel.WSHttpBinding>, <xref:System.ServiceModel.WSDualHttpBinding>, and <xref:System.ServiceModel.NetTcpBinding> with a certificate client credential that the service can map to a valid Windows account.</span></span>  
  
- <span data-ttu-id="0fac5-139">Tout <xref:System.ServiceModel.Channels.CustomBinding> qui utilise une information d'identification de client Windows avec la propriété `requireCancellation` définie à `false`.</span><span class="sxs-lookup"><span data-stu-id="0fac5-139">Any <xref:System.ServiceModel.Channels.CustomBinding> that uses a Windows client credential with the `requireCancellation` property set to `false`.</span></span>  
  
- <span data-ttu-id="0fac5-140">Tout <xref:System.ServiceModel.Channels.CustomBinding> qui utilise un nom d'utilisateur ou une information d'identification de client Windows et une conversation sécurisée avec la propriété `requireCancellation` définie à `false`.</span><span class="sxs-lookup"><span data-stu-id="0fac5-140">Any <xref:System.ServiceModel.Channels.CustomBinding> that uses a user name or Windows client credential and secure conversation with the `requireCancellation` property set to `false`.</span></span>  
  
 <span data-ttu-id="0fac5-141">L'étendue à laquelle le service peut emprunter l'identité du client dépend des privilèges dont le compte de service dispose lorsqu'il tente l'emprunt d'identité, du type d'emprunt d'identité utilisé, et éventuellement de l'étendue d'emprunt d'identité autorisée par le client.</span><span class="sxs-lookup"><span data-stu-id="0fac5-141">The extent to which the service can impersonate the client depends on the privileges the service account holds when it attempts impersonation, the type of impersonation used, and possibly the extent of impersonation the client permits.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="0fac5-142">Lorsque le client et le service s'exécutent sur le même ordinateur et que le client s'exécute sous un compte système (par exemple, `Local System` ou `Network Service`), il n'est pas possible d'emprunter l'identité du client lorsqu'une session sécurisée est établie avec les jetons de contexte de sécurité avec état.</span><span class="sxs-lookup"><span data-stu-id="0fac5-142">When the client and service are running on the same computer and the client is running under a system account (for example, `Local System` or `Network Service`), the client cannot be impersonated when a secure session is established with stateful Security Context tokens.</span></span> <span data-ttu-id="0fac5-143">Une application Windows Forms ou console s'exécute en général sous le compte actuellement connecté, afin que l'emprunt d'identité du compte puisse être effectué par défaut.</span><span class="sxs-lookup"><span data-stu-id="0fac5-143">A Windows Form or console application typically runs under the currently logged-in account, so that account can be impersonated by default.</span></span> <span data-ttu-id="0fac5-144">Toutefois, lorsque le client est une page ASP.net et que la page est hébergée dans IIS 6,0 ou IIS 7,0, le client s’exécute sous `Network Service` le compte par défaut.</span><span class="sxs-lookup"><span data-stu-id="0fac5-144">However, when the client is an ASP.NET page and that page is hosted in IIS 6.0 or IIS 7.0, then the client does run under the `Network Service` account by default.</span></span> <span data-ttu-id="0fac5-145">Toutes les liaisons fournies par le système qui prennent en charge des sessions sécurisées utilisent par défaut un jeton de contexte de sécurité sans état.</span><span class="sxs-lookup"><span data-stu-id="0fac5-145">All of the system-provided bindings that support secure sessions use a stateless security context token (SCT) by default.</span></span> <span data-ttu-id="0fac5-146">Toutefois, si le client est une page ASP.NET, et que des sessions sécurisées avec SCT avec état sont utilisées, le client ne peut pas faire l’emprunt d’identité.</span><span class="sxs-lookup"><span data-stu-id="0fac5-146">However, if the client is an ASP.NET page, and secure sessions with stateful SCTs are used, the client cannot be impersonated.</span></span> <span data-ttu-id="0fac5-147">Pour plus d’informations sur l’utilisation de SCT avec état dans une session [sécurisée, consultez Procédure: Créez un jeton de contexte de sécurité pour une](../../../../docs/framework/wcf/feature-details/how-to-create-a-security-context-token-for-a-secure-session.md)session sécurisée.</span><span class="sxs-lookup"><span data-stu-id="0fac5-147">For more information about using stateful SCTs in a secure session, see [How to: Create a Security Context Token for a Secure Session](../../../../docs/framework/wcf/feature-details/how-to-create-a-security-context-token-for-a-secure-session.md).</span></span>  
  
## <a name="impersonation-in-a-service-method-declarative-model"></a><span data-ttu-id="0fac5-148">Emprunt d’identité dans une méthode de service: Modèle déclaratif</span><span class="sxs-lookup"><span data-stu-id="0fac5-148">Impersonation in a Service Method: Declarative Model</span></span>  
 <span data-ttu-id="0fac5-149">La plupart des scénarios d'emprunt d'identité impliquent l'exécution de la méthode de service dans le contexte de l'appelant.</span><span class="sxs-lookup"><span data-stu-id="0fac5-149">Most impersonation scenarios involve executing the service method in the caller context.</span></span> <span data-ttu-id="0fac5-150">WCF fournit une fonctionnalité d’emprunt d’identité qui facilite cette opération en permettant à l’utilisateur de spécifier l’exigence d’emprunt d’identité dans <xref:System.ServiceModel.OperationBehaviorAttribute> l’attribut.</span><span class="sxs-lookup"><span data-stu-id="0fac5-150">WCF provides an impersonation feature that makes this easy to do by allowing the user to specify the impersonation requirement in the <xref:System.ServiceModel.OperationBehaviorAttribute> attribute.</span></span> <span data-ttu-id="0fac5-151">Par exemple, dans le code suivant, l’infrastructure WCF emprunte l’identité de l’appelant avant `Hello` d’exécuter la méthode.</span><span class="sxs-lookup"><span data-stu-id="0fac5-151">For example, in the following code, the WCF infrastructure impersonates the caller before executing the `Hello` method.</span></span> <span data-ttu-id="0fac5-152">Toute tentative d'accès aux ressources natives à l'intérieur de la méthode `Hello` réussit uniquement si la liste de contrôle d'accès (ACL, Access Control List) de la ressource autorise les privilèges d'accès de l'appelant.</span><span class="sxs-lookup"><span data-stu-id="0fac5-152">Any attempt to access native resources inside the `Hello` method succeed only if the access control list (ACL) of the resource allows the caller access privileges.</span></span> <span data-ttu-id="0fac5-153">Pour activer l'emprunt d'identité, affectez l'une des valeurs d'énumération <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A> ( <xref:System.ServiceModel.ImpersonationOption> ou <xref:System.ServiceModel.ImpersonationOption.Required?displayProperty=nameWithType> ) à la propriété <xref:System.ServiceModel.ImpersonationOption.Allowed?displayProperty=nameWithType>, tel qu'indiqué dans l'exemple suivant.</span><span class="sxs-lookup"><span data-stu-id="0fac5-153">To enable impersonation, set the <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A> property to one of the <xref:System.ServiceModel.ImpersonationOption> enumeration values, either <xref:System.ServiceModel.ImpersonationOption.Required?displayProperty=nameWithType> or <xref:System.ServiceModel.ImpersonationOption.Allowed?displayProperty=nameWithType>, as shown in the following example.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="0fac5-154">Lorsqu'un service a des informations d'identification plus élevées que le client distant, celles-ci sont utilisées si la propriété <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A> a la valeur <xref:System.ServiceModel.ImpersonationOption.Allowed>.</span><span class="sxs-lookup"><span data-stu-id="0fac5-154">When a service has higher credentials than the remote client, the credentials of the service are used if the <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A> property is set to <xref:System.ServiceModel.ImpersonationOption.Allowed>.</span></span> <span data-ttu-id="0fac5-155">En d'autres termes, si un utilisateur à privilèges faibles fournit ses informations d'identification, un service à privilèges plus élevés exécute la méthode avec les informations d'identification du service, et peut utiliser des ressources que l'utilisateur à privilèges faibles n'aurait pas pu utiliser sinon.</span><span class="sxs-lookup"><span data-stu-id="0fac5-155">That is, if a low-privileged user provides its credentials, a higher-privileged service executes the method with the credentials of the service, and can use resources that the low-privileged user would otherwise not be able to use.</span></span>  
  
 [!code-csharp[c_ImpersonationAndDelegation#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_impersonationanddelegation/cs/source.cs#1)]
 [!code-vb[c_ImpersonationAndDelegation#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_impersonationanddelegation/vb/source.vb#1)]  
  
 <span data-ttu-id="0fac5-156">L’infrastructure WCF peut emprunter l’identité de l’appelant uniquement si l’appelant est authentifié avec des informations d’identification qui peuvent être mappées à un compte d’utilisateur Windows.</span><span class="sxs-lookup"><span data-stu-id="0fac5-156">The WCF infrastructure can impersonate the caller only if the caller is authenticated with credentials that can be mapped to a Windows user account.</span></span> <span data-ttu-id="0fac5-157">Si le service est configuré pour authentifier l'utilisation d'une information d'identification qui ne peut pas être mappée à un compte Windows, la méthode de service n'est pas exécutée.</span><span class="sxs-lookup"><span data-stu-id="0fac5-157">If the service is configured to authenticate using a credential that cannot be mapped to a Windows account, the service method is not executed.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="0fac5-158">Sur [!INCLUDE[wxp](../../../../includes/wxp-md.md)], l'emprunt d'identité échoue si un jeton de contexte de sécurité avec état est créé, ce qui génère un <xref:System.InvalidOperationException>.</span><span class="sxs-lookup"><span data-stu-id="0fac5-158">On [!INCLUDE[wxp](../../../../includes/wxp-md.md)], impersonation fails if a stateful SCT is created, resulting in an <xref:System.InvalidOperationException>.</span></span> <span data-ttu-id="0fac5-159">Pour plus d’informations, consultez [scénarios non pris en charge](../../../../docs/framework/wcf/feature-details/unsupported-scenarios.md).</span><span class="sxs-lookup"><span data-stu-id="0fac5-159">For more information, see [Unsupported Scenarios](../../../../docs/framework/wcf/feature-details/unsupported-scenarios.md).</span></span>  
  
## <a name="impersonation-in-a-service-method-imperative-model"></a><span data-ttu-id="0fac5-160">Emprunt d’identité dans une méthode de service: Modèle impératif</span><span class="sxs-lookup"><span data-stu-id="0fac5-160">Impersonation in a Service Method: Imperative Model</span></span>  
 <span data-ttu-id="0fac5-161">Un appelant n'a parfois pas besoin d'emprunter l'identité de l'ensemble de la méthode de service pour fonctionner, mais uniquement une partie de celle-ci.</span><span class="sxs-lookup"><span data-stu-id="0fac5-161">Sometimes a caller does not need to impersonate the entire service method to function, but for only a portion of it.</span></span> <span data-ttu-id="0fac5-162">Dans ce cas, obtenez l'identité Windows de l'appelant à l'intérieur de la méthode de service et exécutez l'emprunt d'identité de manière impérative.</span><span class="sxs-lookup"><span data-stu-id="0fac5-162">In this case, obtain the Windows identity of the caller inside the service method and imperatively perform the impersonation.</span></span> <span data-ttu-id="0fac5-163">Pour ce faire, utilisez la propriété <xref:System.ServiceModel.ServiceSecurityContext.WindowsIdentity%2A> de <xref:System.ServiceModel.ServiceSecurityContext> pour retourner une instance de la classe <xref:System.Security.Principal.WindowsIdentity> , et appelez la méthode <xref:System.Security.Principal.WindowsIdentity.Impersonate%2A> avant d'utiliser l'instance.</span><span class="sxs-lookup"><span data-stu-id="0fac5-163">Do this by using the <xref:System.ServiceModel.ServiceSecurityContext.WindowsIdentity%2A> property of the <xref:System.ServiceModel.ServiceSecurityContext> to return an instance of the <xref:System.Security.Principal.WindowsIdentity> class and calling the <xref:System.Security.Principal.WindowsIdentity.Impersonate%2A> method before using the instance.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="0fac5-164">Veillez à utiliser l’instruction`Using` Visual Basic ou l' C# `using` instruction pour rétablir automatiquement l’action d’emprunt d’identité.</span><span class="sxs-lookup"><span data-stu-id="0fac5-164">Be sure to use the Visual Basic`Using` statement or the C# `using` statement to automatically revert the impersonation action.</span></span> <span data-ttu-id="0fac5-165">Si vous n’utilisez pas l’instruction ou si vous utilisez un langage de programmation autre que Visual Basic ou C#, assurez-vous de rétablir le niveau d’emprunt d’identité.</span><span class="sxs-lookup"><span data-stu-id="0fac5-165">If you do not use the statement, or if you use a programming language other than Visual Basic or C#, be sure to revert the impersonation level.</span></span> <span data-ttu-id="0fac5-166">Si vous ne le faites pas, vous risquez de vous exposer à des attaques par déni de service et d'élévation de privilège.</span><span class="sxs-lookup"><span data-stu-id="0fac5-166">Failure to do this can form the basis for denial of service and elevation of privilege attacks.</span></span>  
  
 [!code-csharp[c_ImpersonationAndDelegation#2](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_impersonationanddelegation/cs/source.cs#2)]
 [!code-vb[c_ImpersonationAndDelegation#2](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_impersonationanddelegation/vb/source.vb#2)]  
  
## <a name="impersonation-for-all-service-methods"></a><span data-ttu-id="0fac5-167">Emprunt d'identité pour toutes les méthodes de service</span><span class="sxs-lookup"><span data-stu-id="0fac5-167">Impersonation for All Service Methods</span></span>  
 <span data-ttu-id="0fac5-168">Dans certains cas, vous devez exécuter toutes les méthodes d'un service dans le contexte de l'appelant.</span><span class="sxs-lookup"><span data-stu-id="0fac5-168">In some cases, you must perform all the methods of a service in the caller’s context.</span></span> <span data-ttu-id="0fac5-169">Au lieu d'activer explicitement cette fonction par méthode, utilisez <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior>.</span><span class="sxs-lookup"><span data-stu-id="0fac5-169">Instead of explicitly enabling this feature on a per-method basis, use the <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior>.</span></span> <span data-ttu-id="0fac5-170">Comme indiqué dans le code suivant, affectez <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior.ImpersonateCallerForAllOperations%2A> à la propriété `true`.</span><span class="sxs-lookup"><span data-stu-id="0fac5-170">As shown in the following code, set the <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior.ImpersonateCallerForAllOperations%2A> property to `true`.</span></span> <span data-ttu-id="0fac5-171"><xref:System.ServiceModel.Description.ServiceAuthorizationBehavior> est récupéré des collections de comportements de la classe <xref:System.ServiceModel.ServiceHost> .</span><span class="sxs-lookup"><span data-stu-id="0fac5-171">The <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior> is retrieved from the collections of behaviors of the <xref:System.ServiceModel.ServiceHost> class.</span></span> <span data-ttu-id="0fac5-172">Notez également que la propriété `Impersonation` de <xref:System.ServiceModel.OperationBehaviorAttribute> appliquée à chaque méthode doit également avoir la valeur <xref:System.ServiceModel.ImpersonationOption.Allowed> ou <xref:System.ServiceModel.ImpersonationOption.Required>.</span><span class="sxs-lookup"><span data-stu-id="0fac5-172">Also note that the `Impersonation` property of the <xref:System.ServiceModel.OperationBehaviorAttribute> applied to each method must also be set to either <xref:System.ServiceModel.ImpersonationOption.Allowed> or <xref:System.ServiceModel.ImpersonationOption.Required>.</span></span>  
  
 [!code-csharp[c_ImpersonationAndDelegation#3](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_impersonationanddelegation/cs/source.cs#3)]
 [!code-vb[c_ImpersonationAndDelegation#3](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_impersonationanddelegation/vb/source.vb#3)]  
  
 <span data-ttu-id="0fac5-173">Le tableau suivant décrit le comportement WCF pour toutes les combinaisons `ImpersonationOption` possibles `ImpersonateCallerForAllServiceOperations`de et.</span><span class="sxs-lookup"><span data-stu-id="0fac5-173">The following table describes WCF behavior for all possible combinations of `ImpersonationOption` and `ImpersonateCallerForAllServiceOperations`.</span></span>  
  
|`ImpersonationOption`|`ImpersonateCallerForAllServiceOperations`|<span data-ttu-id="0fac5-174">Comportement</span><span class="sxs-lookup"><span data-stu-id="0fac5-174">Behavior</span></span>|  
|---------------------------|------------------------------------------------|--------------|  
|<span data-ttu-id="0fac5-175">Obligatoire</span><span class="sxs-lookup"><span data-stu-id="0fac5-175">Required</span></span>|<span data-ttu-id="0fac5-176">N/A</span><span class="sxs-lookup"><span data-stu-id="0fac5-176">n/a</span></span>|<span data-ttu-id="0fac5-177">WCF emprunte l’identité de l’appelant</span><span class="sxs-lookup"><span data-stu-id="0fac5-177">WCF impersonates the caller</span></span>|  
|<span data-ttu-id="0fac5-178">Allowed</span><span class="sxs-lookup"><span data-stu-id="0fac5-178">Allowed</span></span>|<span data-ttu-id="0fac5-179">False</span><span class="sxs-lookup"><span data-stu-id="0fac5-179">false</span></span>|<span data-ttu-id="0fac5-180">WCF n’emprunte pas l’identité de l’appelant</span><span class="sxs-lookup"><span data-stu-id="0fac5-180">WCF does not impersonate the caller</span></span>|  
|<span data-ttu-id="0fac5-181">Allowed</span><span class="sxs-lookup"><span data-stu-id="0fac5-181">Allowed</span></span>|<span data-ttu-id="0fac5-182">true</span><span class="sxs-lookup"><span data-stu-id="0fac5-182">true</span></span>|<span data-ttu-id="0fac5-183">WCF emprunte l’identité de l’appelant</span><span class="sxs-lookup"><span data-stu-id="0fac5-183">WCF impersonates the caller</span></span>|  
|<span data-ttu-id="0fac5-184">NotAllowed</span><span class="sxs-lookup"><span data-stu-id="0fac5-184">NotAllowed</span></span>|<span data-ttu-id="0fac5-185">False</span><span class="sxs-lookup"><span data-stu-id="0fac5-185">false</span></span>|<span data-ttu-id="0fac5-186">WCF n’emprunte pas l’identité de l’appelant</span><span class="sxs-lookup"><span data-stu-id="0fac5-186">WCF does not impersonate the caller</span></span>|  
|<span data-ttu-id="0fac5-187">NotAllowed</span><span class="sxs-lookup"><span data-stu-id="0fac5-187">NotAllowed</span></span>|<span data-ttu-id="0fac5-188">true</span><span class="sxs-lookup"><span data-stu-id="0fac5-188">true</span></span>|<span data-ttu-id="0fac5-189">Non autorisé.</span><span class="sxs-lookup"><span data-stu-id="0fac5-189">Disallowed.</span></span> <span data-ttu-id="0fac5-190">(Une exception <xref:System.InvalidOperationException> est levée.)</span><span class="sxs-lookup"><span data-stu-id="0fac5-190">(An <xref:System.InvalidOperationException> is thrown.)</span></span>|  
  
## <a name="impersonation-level-obtained-from-windows-credentials-and-cached-token-impersonation"></a><span data-ttu-id="0fac5-191">Niveau d'emprunt d'identité obtenu à partir des informations d'identification Windows et emprunt d'identité avec jeton mis en cache</span><span class="sxs-lookup"><span data-stu-id="0fac5-191">Impersonation Level Obtained from Windows Credentials and Cached Token Impersonation</span></span>  
 <span data-ttu-id="0fac5-192">Dans certains scénarios, le client contrôle en partie le niveau d'emprunt d'identité que le service effectue lorsqu'une information d'identification de client Windows est utilisée.</span><span class="sxs-lookup"><span data-stu-id="0fac5-192">In some scenarios the client has partial control over the level of impersonation the service performs when a Windows client credential is used.</span></span> <span data-ttu-id="0fac5-193">L'un de ces scénarios se produit lorsque le client spécifie un niveau d'emprunt d'identité à Anonymous.</span><span class="sxs-lookup"><span data-stu-id="0fac5-193">One scenario occurs when the client specifies an Anonymous impersonation level.</span></span> <span data-ttu-id="0fac5-194">L'autre se produit lors de l'exécution de l'emprunt d'identité avec un jeton mis en cache.</span><span class="sxs-lookup"><span data-stu-id="0fac5-194">The other occurs when performing impersonation with a cached token.</span></span> <span data-ttu-id="0fac5-195">Pour ce faire, définissez la propriété <xref:System.ServiceModel.Security.WindowsClientCredential.AllowedImpersonationLevel%2A> de la classe <xref:System.ServiceModel.Security.WindowsClientCredential> , qui est accessible en tant que propriété de la classe <xref:System.ServiceModel.ChannelFactory%601> générique.</span><span class="sxs-lookup"><span data-stu-id="0fac5-195">This is done by setting the <xref:System.ServiceModel.Security.WindowsClientCredential.AllowedImpersonationLevel%2A> property of the <xref:System.ServiceModel.Security.WindowsClientCredential> class, which is accessed as a property of the generic <xref:System.ServiceModel.ChannelFactory%601> class.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="0fac5-196">Si vous spécifiez un niveau d'emprunt d'identité à Anonymous, le client ouvre une session sur le service de façon anonyme.</span><span class="sxs-lookup"><span data-stu-id="0fac5-196">Specifying an impersonation level of Anonymous causes the client to log on to the service anonymously.</span></span> <span data-ttu-id="0fac5-197">Le service doit donc autoriser des ouvertures de session anonymes, indépendamment de l'exécution de l'emprunt d'identité.</span><span class="sxs-lookup"><span data-stu-id="0fac5-197">The service must therefore allow anonymous logons, regardless of whether impersonation is performed.</span></span>  
  
 <span data-ttu-id="0fac5-198">Le client peut spécifier le niveau d'emprunt d'identité à <xref:System.Security.Principal.TokenImpersonationLevel.Anonymous>, <xref:System.Security.Principal.TokenImpersonationLevel.Identification>, <xref:System.Security.Principal.TokenImpersonationLevel.Impersonation>ou <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>.</span><span class="sxs-lookup"><span data-stu-id="0fac5-198">The client can specify the impersonation level as <xref:System.Security.Principal.TokenImpersonationLevel.Anonymous>, <xref:System.Security.Principal.TokenImpersonationLevel.Identification>, <xref:System.Security.Principal.TokenImpersonationLevel.Impersonation>, or <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>.</span></span> <span data-ttu-id="0fac5-199">Un jeton est uniquement généré au niveau spécifié, tel qu'indiqué dans le code suivant.</span><span class="sxs-lookup"><span data-stu-id="0fac5-199">Only a token at the specified level is produced, as shown in the following code.</span></span>  
  
 [!code-csharp[c_ImpersonationAndDelegation#4](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_impersonationanddelegation/cs/source.cs#4)]
 [!code-vb[c_ImpersonationAndDelegation#4](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_impersonationanddelegation/vb/source.vb#4)]  
  
 <span data-ttu-id="0fac5-200">Le tableau suivant spécifie le niveau d'emprunt d'identité que le service obtient lors de l'emprunt d'identité à partir d'un jeton mis en cache.</span><span class="sxs-lookup"><span data-stu-id="0fac5-200">The following table specifies the impersonation level the service obtains when impersonating from a cached token.</span></span>  
  
|<span data-ttu-id="0fac5-201">Valeur`AllowedImpersonationLevel`</span><span class="sxs-lookup"><span data-stu-id="0fac5-201">`AllowedImpersonationLevel` value</span></span>|<span data-ttu-id="0fac5-202">Le Service a `SeImpersonatePrivilege`</span><span class="sxs-lookup"><span data-stu-id="0fac5-202">Service has `SeImpersonatePrivilege`</span></span>|<span data-ttu-id="0fac5-203">Le Service et le client sont capables de délégation</span><span class="sxs-lookup"><span data-stu-id="0fac5-203">Service and client are capable of delegation</span></span>|<span data-ttu-id="0fac5-204">Jeton `ImpersonationLevel`mis en cache</span><span class="sxs-lookup"><span data-stu-id="0fac5-204">Cached token `ImpersonationLevel`</span></span>|  
|---------------------------------------|------------------------------------------|--------------------------------------------------|---------------------------------------|  
|<span data-ttu-id="0fac5-205">Anonymous</span><span class="sxs-lookup"><span data-stu-id="0fac5-205">Anonymous</span></span>|<span data-ttu-id="0fac5-206">Oui</span><span class="sxs-lookup"><span data-stu-id="0fac5-206">Yes</span></span>|<span data-ttu-id="0fac5-207">N/A</span><span class="sxs-lookup"><span data-stu-id="0fac5-207">n/a</span></span>|<span data-ttu-id="0fac5-208">Emprunt d'identité</span><span class="sxs-lookup"><span data-stu-id="0fac5-208">Impersonation</span></span>|  
|<span data-ttu-id="0fac5-209">Anonymous</span><span class="sxs-lookup"><span data-stu-id="0fac5-209">Anonymous</span></span>|<span data-ttu-id="0fac5-210">Aucune</span><span class="sxs-lookup"><span data-stu-id="0fac5-210">No</span></span>|<span data-ttu-id="0fac5-211">N/A</span><span class="sxs-lookup"><span data-stu-id="0fac5-211">n/a</span></span>|<span data-ttu-id="0fac5-212">Identification</span><span class="sxs-lookup"><span data-stu-id="0fac5-212">Identification</span></span>|  
|<span data-ttu-id="0fac5-213">Identification</span><span class="sxs-lookup"><span data-stu-id="0fac5-213">Identification</span></span>|<span data-ttu-id="0fac5-214">N/A</span><span class="sxs-lookup"><span data-stu-id="0fac5-214">n/a</span></span>|<span data-ttu-id="0fac5-215">N/A</span><span class="sxs-lookup"><span data-stu-id="0fac5-215">n/a</span></span>|<span data-ttu-id="0fac5-216">Identification</span><span class="sxs-lookup"><span data-stu-id="0fac5-216">Identification</span></span>|  
|<span data-ttu-id="0fac5-217">Emprunt d'identité</span><span class="sxs-lookup"><span data-stu-id="0fac5-217">Impersonation</span></span>|<span data-ttu-id="0fac5-218">Oui</span><span class="sxs-lookup"><span data-stu-id="0fac5-218">Yes</span></span>|<span data-ttu-id="0fac5-219">N/A</span><span class="sxs-lookup"><span data-stu-id="0fac5-219">n/a</span></span>|<span data-ttu-id="0fac5-220">Emprunt d'identité</span><span class="sxs-lookup"><span data-stu-id="0fac5-220">Impersonation</span></span>|  
|<span data-ttu-id="0fac5-221">Emprunt d'identité</span><span class="sxs-lookup"><span data-stu-id="0fac5-221">Impersonation</span></span>|<span data-ttu-id="0fac5-222">Aucune</span><span class="sxs-lookup"><span data-stu-id="0fac5-222">No</span></span>|<span data-ttu-id="0fac5-223">N/A</span><span class="sxs-lookup"><span data-stu-id="0fac5-223">n/a</span></span>|<span data-ttu-id="0fac5-224">Identification</span><span class="sxs-lookup"><span data-stu-id="0fac5-224">Identification</span></span>|  
|<span data-ttu-id="0fac5-225">Delegation</span><span class="sxs-lookup"><span data-stu-id="0fac5-225">Delegation</span></span>|<span data-ttu-id="0fac5-226">Oui</span><span class="sxs-lookup"><span data-stu-id="0fac5-226">Yes</span></span>|<span data-ttu-id="0fac5-227">Oui</span><span class="sxs-lookup"><span data-stu-id="0fac5-227">Yes</span></span>|<span data-ttu-id="0fac5-228">Delegation</span><span class="sxs-lookup"><span data-stu-id="0fac5-228">Delegation</span></span>|  
|<span data-ttu-id="0fac5-229">Delegation</span><span class="sxs-lookup"><span data-stu-id="0fac5-229">Delegation</span></span>|<span data-ttu-id="0fac5-230">Oui</span><span class="sxs-lookup"><span data-stu-id="0fac5-230">Yes</span></span>|<span data-ttu-id="0fac5-231">Aucune</span><span class="sxs-lookup"><span data-stu-id="0fac5-231">No</span></span>|<span data-ttu-id="0fac5-232">emprunt d'identité</span><span class="sxs-lookup"><span data-stu-id="0fac5-232">Impersonation</span></span>|  
|<span data-ttu-id="0fac5-233">Delegation</span><span class="sxs-lookup"><span data-stu-id="0fac5-233">Delegation</span></span>|<span data-ttu-id="0fac5-234">Aucune</span><span class="sxs-lookup"><span data-stu-id="0fac5-234">No</span></span>|<span data-ttu-id="0fac5-235">N/A</span><span class="sxs-lookup"><span data-stu-id="0fac5-235">n/a</span></span>|<span data-ttu-id="0fac5-236">Identification</span><span class="sxs-lookup"><span data-stu-id="0fac5-236">Identification</span></span>|  
  
## <a name="impersonation-level-obtained-from-user-name-credentials-and-cached-token-impersonation"></a><span data-ttu-id="0fac5-237">Niveau d'emprunt d'identité obtenu à partir des informations d'identification de nom d'utilisateur et emprunt d'identité avec jeton mis en cache</span><span class="sxs-lookup"><span data-stu-id="0fac5-237">Impersonation Level Obtained from User Name Credentials and Cached Token Impersonation</span></span>  
 <span data-ttu-id="0fac5-238">En passant le service à son nom d’utilisateur et son mot de passe, un client permet à WCF de se connecter en tant qu’utilisateur `AllowedImpersonationLevel` , ce <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>qui équivaut à affecter à la propriété la valeur.</span><span class="sxs-lookup"><span data-stu-id="0fac5-238">By passing the service its user name and password, a client enables WCF to log on as that user, which is equivalent to setting the `AllowedImpersonationLevel` property to <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>.</span></span> <span data-ttu-id="0fac5-239">(`AllowedImpersonationLevel` est disponible sur les classes <xref:System.ServiceModel.Security.WindowsClientCredential> et <xref:System.ServiceModel.Security.HttpDigestClientCredential>.) Le tableau suivant indique le niveau d'emprunt d'identité obtenu lorsque le service reçoit des informations d'identification de nom d'utilisateur.</span><span class="sxs-lookup"><span data-stu-id="0fac5-239">(The `AllowedImpersonationLevel` is available on the <xref:System.ServiceModel.Security.WindowsClientCredential> and <xref:System.ServiceModel.Security.HttpDigestClientCredential> classes.) The following table provides the impersonation level obtained when the service receives user name credentials.</span></span>  
  
|`AllowedImpersonationLevel`|<span data-ttu-id="0fac5-240">Le Service a `SeImpersonatePrivilege`</span><span class="sxs-lookup"><span data-stu-id="0fac5-240">Service has `SeImpersonatePrivilege`</span></span>|<span data-ttu-id="0fac5-241">Le Service et le client sont capables de délégation</span><span class="sxs-lookup"><span data-stu-id="0fac5-241">Service and client are capable of delegation</span></span>|<span data-ttu-id="0fac5-242">Jeton `ImpersonationLevel`mis en cache</span><span class="sxs-lookup"><span data-stu-id="0fac5-242">Cached token `ImpersonationLevel`</span></span>|  
|---------------------------------|------------------------------------------|--------------------------------------------------|---------------------------------------|  
|<span data-ttu-id="0fac5-243">N/A</span><span class="sxs-lookup"><span data-stu-id="0fac5-243">n/a</span></span>|<span data-ttu-id="0fac5-244">Oui</span><span class="sxs-lookup"><span data-stu-id="0fac5-244">Yes</span></span>|<span data-ttu-id="0fac5-245">Oui</span><span class="sxs-lookup"><span data-stu-id="0fac5-245">Yes</span></span>|<span data-ttu-id="0fac5-246">Delegation</span><span class="sxs-lookup"><span data-stu-id="0fac5-246">Delegation</span></span>|  
|<span data-ttu-id="0fac5-247">N/A</span><span class="sxs-lookup"><span data-stu-id="0fac5-247">n/a</span></span>|<span data-ttu-id="0fac5-248">Oui</span><span class="sxs-lookup"><span data-stu-id="0fac5-248">Yes</span></span>|<span data-ttu-id="0fac5-249">Aucune</span><span class="sxs-lookup"><span data-stu-id="0fac5-249">No</span></span>|<span data-ttu-id="0fac5-250">Emprunt d'identité</span><span class="sxs-lookup"><span data-stu-id="0fac5-250">Impersonation</span></span>|  
|<span data-ttu-id="0fac5-251">N/A</span><span class="sxs-lookup"><span data-stu-id="0fac5-251">n/a</span></span>|<span data-ttu-id="0fac5-252">Aucune</span><span class="sxs-lookup"><span data-stu-id="0fac5-252">No</span></span>|<span data-ttu-id="0fac5-253">N/A</span><span class="sxs-lookup"><span data-stu-id="0fac5-253">n/a</span></span>|<span data-ttu-id="0fac5-254">Identification</span><span class="sxs-lookup"><span data-stu-id="0fac5-254">Identification</span></span>|  
  
## <a name="impersonation-level-obtained-from-s4u-based-impersonation"></a><span data-ttu-id="0fac5-255">Niveau d'emprunt d'identité obtenu à partir de l'emprunt d'identité basé sur S4U</span><span class="sxs-lookup"><span data-stu-id="0fac5-255">Impersonation Level Obtained from S4U-Based Impersonation</span></span>  
  
|<span data-ttu-id="0fac5-256">Le Service a `SeTcbPrivilege`</span><span class="sxs-lookup"><span data-stu-id="0fac5-256">Service has `SeTcbPrivilege`</span></span>|<span data-ttu-id="0fac5-257">Le Service a `SeImpersonatePrivilege`</span><span class="sxs-lookup"><span data-stu-id="0fac5-257">Service has `SeImpersonatePrivilege`</span></span>|<span data-ttu-id="0fac5-258">Le Service et le client sont capables de délégation</span><span class="sxs-lookup"><span data-stu-id="0fac5-258">Service and client are capable of delegation</span></span>|<span data-ttu-id="0fac5-259">Jeton `ImpersonationLevel`mis en cache</span><span class="sxs-lookup"><span data-stu-id="0fac5-259">Cached token `ImpersonationLevel`</span></span>|  
|----------------------------------|------------------------------------------|--------------------------------------------------|---------------------------------------|  
|<span data-ttu-id="0fac5-260">Oui</span><span class="sxs-lookup"><span data-stu-id="0fac5-260">Yes</span></span>|<span data-ttu-id="0fac5-261">Oui</span><span class="sxs-lookup"><span data-stu-id="0fac5-261">Yes</span></span>|<span data-ttu-id="0fac5-262">N/A</span><span class="sxs-lookup"><span data-stu-id="0fac5-262">n/a</span></span>|<span data-ttu-id="0fac5-263">Emprunt d'identité</span><span class="sxs-lookup"><span data-stu-id="0fac5-263">Impersonation</span></span>|  
|<span data-ttu-id="0fac5-264">Oui</span><span class="sxs-lookup"><span data-stu-id="0fac5-264">Yes</span></span>|<span data-ttu-id="0fac5-265">Aucune</span><span class="sxs-lookup"><span data-stu-id="0fac5-265">No</span></span>|<span data-ttu-id="0fac5-266">N/A</span><span class="sxs-lookup"><span data-stu-id="0fac5-266">n/a</span></span>|<span data-ttu-id="0fac5-267">Identification</span><span class="sxs-lookup"><span data-stu-id="0fac5-267">Identification</span></span>|  
|<span data-ttu-id="0fac5-268">Aucune</span><span class="sxs-lookup"><span data-stu-id="0fac5-268">No</span></span>|<span data-ttu-id="0fac5-269">N/A</span><span class="sxs-lookup"><span data-stu-id="0fac5-269">n/a</span></span>|<span data-ttu-id="0fac5-270">N/A</span><span class="sxs-lookup"><span data-stu-id="0fac5-270">n/a</span></span>|<span data-ttu-id="0fac5-271">Identification</span><span class="sxs-lookup"><span data-stu-id="0fac5-271">Identification</span></span>|  
  
## <a name="mapping-a-client-certificate-to-a-windows-account"></a><span data-ttu-id="0fac5-272">Mappage d'un certificat client à un compte Windows</span><span class="sxs-lookup"><span data-stu-id="0fac5-272">Mapping a Client Certificate to a Windows Account</span></span>  
 <span data-ttu-id="0fac5-273">Il est possible pour un client de s'authentifier auprès d'un service à l'aide d'un certificat et que le service mappe le client à un compte existant par le biais d'Active Directory.</span><span class="sxs-lookup"><span data-stu-id="0fac5-273">It is possible for a client to authenticate itself to a service using a certificate, and to have the service map the client to an existing account through Active Directory.</span></span> <span data-ttu-id="0fac5-274">Le code XML suivant indique comment configurer le service pour mapper le certificat.</span><span class="sxs-lookup"><span data-stu-id="0fac5-274">The following XML shows how to configure the service to map the certificate.</span></span>  
  
```xml  
<behaviors>  
  <serviceBehaviors>  
    <behavior name="MapToWindowsAccount">  
      <serviceCredentials>  
        <clientCertificate>  
          <authentication mapClientCertificateToWindowsAccount="true" />  
        </clientCertificate>  
      </serviceCredentials>  
    </behavior>  
  </serviceBehaviors>  
</behaviors>  
```  
  
 <span data-ttu-id="0fac5-275">Le code suivant indique comment configurer le service.</span><span class="sxs-lookup"><span data-stu-id="0fac5-275">The following code shows how to configure the service.</span></span>  
  
```  
// Create a binding that sets a certificate as the client credential type.  
WSHttpBinding b = new WSHttpBinding();  
b.Security.Message.ClientCredentialType = MessageCredentialType.Certificate;  
  
// Create a service host that maps the certificate to a Windows account.  
Uri httpUri = new Uri("http://localhost/Calculator");  
ServiceHost sh = new ServiceHost(typeof(HelloService), httpUri);  
sh.Credentials.ClientCertificate.Authentication.MapClientCertificateToWindowsAccount = true;  
```  
  
## <a name="delegation"></a><span data-ttu-id="0fac5-276">Delegation</span><span class="sxs-lookup"><span data-stu-id="0fac5-276">Delegation</span></span>  
 <span data-ttu-id="0fac5-277">Pour déléguer à un service principal, un service doit effectuer une authentification Kerberos multi-leg (SSPI sans NTLM) ou une authentification directe Kerberos au service principal à l'aide de l'identité Windows du client.</span><span class="sxs-lookup"><span data-stu-id="0fac5-277">To delegate to a back-end service, a service must perform Kerberos multi-leg (SSPI without NTLM fallback) or Kerberos direct authentication to the back-end service using the client’s Windows identity.</span></span> <span data-ttu-id="0fac5-278">Pour déléguer à un service principal, créez un <xref:System.ServiceModel.ChannelFactory%601> et un canal, puis communiquez par le biais du canal lors de l'emprunt d'identité du client.</span><span class="sxs-lookup"><span data-stu-id="0fac5-278">To delegate to a back-end service, create a <xref:System.ServiceModel.ChannelFactory%601> and a channel, and then communicate through the channel while impersonating the client.</span></span> <span data-ttu-id="0fac5-279">Avec cette forme de délégation, la distance entre l'emplacement du service principal et le service frontal dépend du niveau d'emprunt d'identité atteint par le service frontal.</span><span class="sxs-lookup"><span data-stu-id="0fac5-279">With this form of delegation, the distance at which the back-end service can be located from the front-end service depends on the impersonation level achieved by the front-end service.</span></span> <span data-ttu-id="0fac5-280">Lorsque le niveau d'emprunt d'identité est <xref:System.Security.Principal.TokenImpersonationLevel.Impersonation>, les services frontaux et principaux doivent s'exécuter sur le même ordinateur.</span><span class="sxs-lookup"><span data-stu-id="0fac5-280">When the impersonation level is <xref:System.Security.Principal.TokenImpersonationLevel.Impersonation>, the front-end and back-end services must be running on the same machine.</span></span> <span data-ttu-id="0fac5-281">Lorsque le niveau d'emprunt d'identité est <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>, les services frontaux et principaux peuvent être présents sur des ordinateurs séparés ou sur le même ordinateur.</span><span class="sxs-lookup"><span data-stu-id="0fac5-281">When the impersonation level is <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>, the front-end and back-end services can be on separate machines or on the same machine.</span></span> <span data-ttu-id="0fac5-282">L'activation de l'emprunt d'identité au niveau délégation nécessite que la stratégie du domaine Windows soit configurée pour permettre la délégation.</span><span class="sxs-lookup"><span data-stu-id="0fac5-282">Enabling delegation-level impersonation requires that Windows domain policy be configured to permit delegation.</span></span> <span data-ttu-id="0fac5-283">Pour plus d’informations sur la configuration d’Active Directory pour la prise en charge de la délégation, consultez [Enabling Delegated Authentication](https://go.microsoft.com/fwlink/?LinkId=99690)(Activation de l’authentification déléguée).</span><span class="sxs-lookup"><span data-stu-id="0fac5-283">For more information about configuring Active Directory for delegation support, see [Enabling Delegated Authentication](https://go.microsoft.com/fwlink/?LinkId=99690).</span></span>  
  
> [!NOTE]
> <span data-ttu-id="0fac5-284">Lorsqu'un client s'authentifie auprès du service frontal à l'aide d'un nom d'utilisateur et d'un mot de passe qui correspondent à un compte Windows, le service frontal peut s'authentifier auprès du service principal en réutilisant le nom et le mot de passe du client.</span><span class="sxs-lookup"><span data-stu-id="0fac5-284">When a client authenticates to the front-end service using a user name and password that correspond to a Windows account on the back-end service, the front-end service can authenticate to the back-end service by reusing the client’s user name and password.</span></span> <span data-ttu-id="0fac5-285">Il s'agit d'une forme très puissante de flux d'identité, car la transmission d'un nom d'utilisateur et d'un mot de passe au service principal permet à ce service d'effectuer l'emprunt d'identité, mais elle ne constitue pas une délégation en l'absence de l'utilisation de Kerberos.</span><span class="sxs-lookup"><span data-stu-id="0fac5-285">This is a particularly powerful form of identity flow, because passing user name and password to the back-end service enables the back-end service to perform impersonation, but it does not constitute delegation because Kerberos is not used.</span></span> <span data-ttu-id="0fac5-286">Les contrôles Active Directory sur la délégation ne s'appliquent pas à l'authentification par nom d'utilisateur et par mot de passe.</span><span class="sxs-lookup"><span data-stu-id="0fac5-286">Active Directory controls on delegation do not apply to user name and password authentication.</span></span>  
  
### <a name="delegation-ability-as-a-function-of-impersonation-level"></a><span data-ttu-id="0fac5-287">La délégation comme fonction du niveau d'emprunt d'identité</span><span class="sxs-lookup"><span data-stu-id="0fac5-287">Delegation Ability as a Function of Impersonation Level</span></span>  
  
|<span data-ttu-id="0fac5-288">Niveau d'emprunt d'identité</span><span class="sxs-lookup"><span data-stu-id="0fac5-288">Impersonation level</span></span>|<span data-ttu-id="0fac5-289">Le service peut effectuer une délégation interprocessus</span><span class="sxs-lookup"><span data-stu-id="0fac5-289">Service can perform cross-process delegation</span></span>|<span data-ttu-id="0fac5-290">Le service peut effectuer une délégation sur plusieurs ordinateurs</span><span class="sxs-lookup"><span data-stu-id="0fac5-290">Service can perform cross-machine delegation</span></span>|  
|-------------------------|---------------------------------------------------|---------------------------------------------------|  
|<xref:System.Security.Principal.TokenImpersonationLevel.Identification>|<span data-ttu-id="0fac5-291">Aucune</span><span class="sxs-lookup"><span data-stu-id="0fac5-291">No</span></span>|<span data-ttu-id="0fac5-292">Non</span><span class="sxs-lookup"><span data-stu-id="0fac5-292">No</span></span>|  
|<xref:System.Security.Principal.TokenImpersonationLevel.Impersonation>|<span data-ttu-id="0fac5-293">Oui</span><span class="sxs-lookup"><span data-stu-id="0fac5-293">Yes</span></span>|<span data-ttu-id="0fac5-294">Non</span><span class="sxs-lookup"><span data-stu-id="0fac5-294">No</span></span>|  
|<xref:System.Security.Principal.TokenImpersonationLevel.Delegation>|<span data-ttu-id="0fac5-295">Oui</span><span class="sxs-lookup"><span data-stu-id="0fac5-295">Yes</span></span>|<span data-ttu-id="0fac5-296">Oui</span><span class="sxs-lookup"><span data-stu-id="0fac5-296">Yes</span></span>|  
  
 <span data-ttu-id="0fac5-297">L'exemple de code suivant montre comment utiliser la délégation.</span><span class="sxs-lookup"><span data-stu-id="0fac5-297">The following code example demonstrates how to use delegation.</span></span>  
  
 [!code-csharp[c_delegation#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_delegation/cs/source.cs#1)]
 [!code-vb[c_delegation#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_delegation/vb/source.vb#1)]  
  
### <a name="how-to-configure-an-application-to-use-constrained-delegation"></a><span data-ttu-id="0fac5-298">Comment configurer une Application pour utiliser la délégation contrainte</span><span class="sxs-lookup"><span data-stu-id="0fac5-298">How to Configure an Application to Use Constrained Delegation</span></span>  
 <span data-ttu-id="0fac5-299">Avant de pouvoir utiliser la délégation contrainte, l'expéditeur, le destinataire et le contrôleur de domaine doivent être configurés en conséquence.</span><span class="sxs-lookup"><span data-stu-id="0fac5-299">Before you can use constrained delegation, the sender, receiver, and the domain controller must be configured to do so.</span></span> <span data-ttu-id="0fac5-300">La procédure suivante répertorie les étapes qui permettent d'activer la délégation contrainte.</span><span class="sxs-lookup"><span data-stu-id="0fac5-300">The following procedure lists the steps that enable constrained delegation.</span></span> <span data-ttu-id="0fac5-301">Pour des informations sur les différences entre la délégation et la délégation contrainte, consultez la section [Windows Server 2003 Kerberos Extensions](https://go.microsoft.com/fwlink/?LinkId=100194) (Kerberos dans Windows Server 2003) qui traite de la délégation contrainte.</span><span class="sxs-lookup"><span data-stu-id="0fac5-301">For details about the differences between delegation and constrained delegation, see the portion of [Windows Server 2003 Kerberos Extensions](https://go.microsoft.com/fwlink/?LinkId=100194) that discusses constrained discussion.</span></span>  
  
1. <span data-ttu-id="0fac5-302">Dans le contrôleur de domaine, désactivez la case à cocher **Le compte est sensible et ne peut pas être délégué** pour le compte sous lequel s'exécute l'application cliente.</span><span class="sxs-lookup"><span data-stu-id="0fac5-302">On the domain controller, clear the **Account is sensitive and cannot be delegated** check box for the account under which the client application is running.</span></span>  
  
2. <span data-ttu-id="0fac5-303">Dans le contrôleur de domaine, activez la case à cocher **Le compte est approuvé pour la délégation** pour le compte sous lequel s'exécute l'application cliente.</span><span class="sxs-lookup"><span data-stu-id="0fac5-303">On the domain controller, select the **Account is trusted for delegation** check box for the account under which the client application is running.</span></span>  
  
3. <span data-ttu-id="0fac5-304">Dans le contrôleur de domaine, configurez l'ordinateur intermédiaire pour qu'il soit approuvé pour la délégation en cliquant sur l'option **Approuver l'ordinateur pour la délégation** .</span><span class="sxs-lookup"><span data-stu-id="0fac5-304">On the domain controller, configure the middle tier computer so that it is trusted for delegation, by clicking the **Trust computer for delegation** option.</span></span>  
  
4. <span data-ttu-id="0fac5-305">Dans le contrôleur de domaine, configurez l'ordinateur intermédiaire pour utiliser la délégation contrainte en cliquant sur l'option **N'approuver cet ordinateur que pour la délégation aux services spécifiés** .</span><span class="sxs-lookup"><span data-stu-id="0fac5-305">On the domain controller, configure the middle tier computer to use constrained delegation, by clicking the **Trust this computer for delegation to specified services only** option.</span></span>  
  
 <span data-ttu-id="0fac5-306">Pour des instructions plus détaillées sur la configuration de la délégation contrainte, consultez les rubriques suivantes sur MSDN :</span><span class="sxs-lookup"><span data-stu-id="0fac5-306">For more detailed instructions about configuring constrained delegation, see the following topics on MSDN:</span></span>  
  
- [<span data-ttu-id="0fac5-307">L’authentification Kerberos et la résolution des problèmes de délégation</span><span class="sxs-lookup"><span data-stu-id="0fac5-307">Troubleshooting Kerberos Delegation</span></span>](https://go.microsoft.com/fwlink/?LinkId=36724)  
  
- [<span data-ttu-id="0fac5-308">Kerberos Protocol Transition and Constrained Delegation (Transition du protocole Kerberos et délégation contrainte)</span><span class="sxs-lookup"><span data-stu-id="0fac5-308">Kerberos Protocol Transition and Constrained Delegation</span></span>](https://go.microsoft.com/fwlink/?LinkId=36725)  
  
## <a name="see-also"></a><span data-ttu-id="0fac5-309">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="0fac5-309">See also</span></span>

- <xref:System.ServiceModel.OperationBehaviorAttribute>
- <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A>
- <xref:System.ServiceModel.ImpersonationOption>
- <xref:System.ServiceModel.ServiceSecurityContext.WindowsIdentity%2A>
- <xref:System.ServiceModel.ServiceSecurityContext>
- <xref:System.Security.Principal.WindowsIdentity>
- <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior>
- <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior.ImpersonateCallerForAllOperations%2A>
- <xref:System.ServiceModel.ServiceHost>
- <xref:System.ServiceModel.Security.WindowsClientCredential.AllowedImpersonationLevel%2A>
- <xref:System.ServiceModel.Security.WindowsClientCredential>
- <xref:System.ServiceModel.ChannelFactory%601>
- <xref:System.Security.Principal.TokenImpersonationLevel.Identification>
- [<span data-ttu-id="0fac5-310">Utilisation de l’emprunt d’identité avec la sécurité de transport</span><span class="sxs-lookup"><span data-stu-id="0fac5-310">Using Impersonation with Transport Security</span></span>](../../../../docs/framework/wcf/feature-details/using-impersonation-with-transport-security.md)
- [<span data-ttu-id="0fac5-311">Emprunt de l’identité du client</span><span class="sxs-lookup"><span data-stu-id="0fac5-311">Impersonating the Client</span></span>](../../../../docs/framework/wcf/samples/impersonating-the-client.md)
- [<span data-ttu-id="0fac5-312">Guide pratique pour Emprunter l’identité d’un client sur un service</span><span class="sxs-lookup"><span data-stu-id="0fac5-312">How to: Impersonate a Client on a Service</span></span>](../../../../docs/framework/wcf/how-to-impersonate-a-client-on-a-service.md)
- [<span data-ttu-id="0fac5-313">Outil ServiceModel Metadata Utility (Svcutil.exe)</span><span class="sxs-lookup"><span data-stu-id="0fac5-313">ServiceModel Metadata Utility Tool (Svcutil.exe)</span></span>](../../../../docs/framework/wcf/servicemodel-metadata-utility-tool-svcutil-exe.md)
