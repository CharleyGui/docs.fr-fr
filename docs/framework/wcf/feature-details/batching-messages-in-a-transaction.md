---
title: Traitement par lots des messages dans une transaction
ms.date: 03/30/2017
helpviewer_keywords:
- batching messages [WCF]
ms.assetid: 53305392-e82e-4e89-aedc-3efb6ebcd28c
ms.openlocfilehash: c18d5a36f4263a93589b75129517d66df80ce463
ms.sourcegitcommit: bc293b14af795e0e999e3304dd40c0222cf2ffe4
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 11/26/2020
ms.locfileid: "96247458"
---
# <a name="batching-messages-in-a-transaction"></a><span data-ttu-id="4ebc5-102">Traitement par lots des messages dans une transaction</span><span class="sxs-lookup"><span data-stu-id="4ebc5-102">Batching Messages in a Transaction</span></span>

<span data-ttu-id="4ebc5-103">Les applications en file d’attente utilisent des transactions pour garantir l’exactitude et la remise fiable des messages.</span><span class="sxs-lookup"><span data-stu-id="4ebc5-103">Queued applications use transactions to ensure correctness and reliable delivery of messages.</span></span> <span data-ttu-id="4ebc5-104">Toutefois, les transactions sont des opérations coûteuses et peuvent réduire considérablement le débit de message.</span><span class="sxs-lookup"><span data-stu-id="4ebc5-104">Transactions, however, are expensive operations and can dramatically reduce message throughput.</span></span> <span data-ttu-id="4ebc5-105">L’une des méthodes utilisées pour améliorer le débit de message est de disposer d’une application capable de lire et de traiter plusieurs messages dans une transaction unique.</span><span class="sxs-lookup"><span data-stu-id="4ebc5-105">One way to improve message throughput is to have an application read and process multiple messages within a single transaction.</span></span> <span data-ttu-id="4ebc5-106">Le compromis réside entre la performance et la récupération : à mesure que le nombre de messages dans un lot augmente, la quantité de travail de récupération nécessaire en cas de restauration des transactions augmente également.</span><span class="sxs-lookup"><span data-stu-id="4ebc5-106">The trade-off is between performance and recovery: as the number of messages in a batch increases, so does the amount of recovery work that required if transactions are rolled back.</span></span> <span data-ttu-id="4ebc5-107">Il est important de noter la différence entre le traitement par lot des messages dans une transaction et dans des sessions.</span><span class="sxs-lookup"><span data-stu-id="4ebc5-107">It is important to note the difference between batching messages in a transaction and sessions.</span></span> <span data-ttu-id="4ebc5-108">Une *session* est un regroupement de messages connexes qui sont traités par une application unique et validés en tant qu’unité unique.</span><span class="sxs-lookup"><span data-stu-id="4ebc5-108">A *session* is a grouping of related messages that are processed by a single application and committed as a single unit.</span></span> <span data-ttu-id="4ebc5-109">Les sessions sont en général utilisées lorsqu'un groupe de messages du même type doivent être traités ensemble.</span><span class="sxs-lookup"><span data-stu-id="4ebc5-109">Sessions are generally used when a group of related messages must be processed together.</span></span> <span data-ttu-id="4ebc5-110">Un site Web d'achat en ligne en est un exemple.</span><span class="sxs-lookup"><span data-stu-id="4ebc5-110">An example of this is an online shopping Web site.</span></span> <span data-ttu-id="4ebc5-111">Les *lots* sont utilisés pour traiter plusieurs messages non liés d’une façon qui augmente le débit des messages.</span><span class="sxs-lookup"><span data-stu-id="4ebc5-111">*Batches* are used to process multiple, unrelated messages in a way that increases message throughput.</span></span> <span data-ttu-id="4ebc5-112">Pour plus d’informations sur les sessions, consultez [regroupement des messages mis en file d’attente dans une session](grouping-queued-messages-in-a-session.md).</span><span class="sxs-lookup"><span data-stu-id="4ebc5-112">For more information about sessions, see [Grouping Queued Messages in a Session](grouping-queued-messages-in-a-session.md).</span></span> <span data-ttu-id="4ebc5-113">Les messages d’un lot sont également traités par une application unique et sont validés en tant qu’unité unique, mais il peut n’y avoir aucune relation entre eux.</span><span class="sxs-lookup"><span data-stu-id="4ebc5-113">Messages in a batch are also processed by a single application and committed as a single unit, but there may be no relationship between the messages in the batch.</span></span> <span data-ttu-id="4ebc5-114">Le traitement par lot des messages dans une transaction est une optimisation qui ne modifie pas la manière dont l’application s’exécute.</span><span class="sxs-lookup"><span data-stu-id="4ebc5-114">Batching messages in a transaction is an optimization that does not change how the application runs.</span></span>  
  
## <a name="entering-batching-mode"></a><span data-ttu-id="4ebc5-115">Passage en mode de traitement par lot</span><span class="sxs-lookup"><span data-stu-id="4ebc5-115">Entering Batching Mode</span></span>  

 <span data-ttu-id="4ebc5-116">Le comportement de point de terminaison <xref:System.ServiceModel.Description.TransactedBatchingBehavior> contrôle le traitement par lot.</span><span class="sxs-lookup"><span data-stu-id="4ebc5-116">The <xref:System.ServiceModel.Description.TransactedBatchingBehavior> endpoint behavior controls batching.</span></span> <span data-ttu-id="4ebc5-117">L’ajout de ce comportement de point de terminaison à un point de terminaison de service indique Windows Communication Foundation (WCF) de traiter par lots les messages dans une transaction.</span><span class="sxs-lookup"><span data-stu-id="4ebc5-117">Adding this endpoint behavior to a service endpoint tells Windows Communication Foundation (WCF) to batch messages in a transaction.</span></span> <span data-ttu-id="4ebc5-118">Tous les messages n’ont pas besoin d’une transaction ; par conséquent, seuls les messages qui requièrent une transaction sont placés dans un lot, et seuls les messages envoyés à partir d’opérations marquées avec `TransactionScopeRequired`  =  `true` et `TransactionAutoComplete`  =  `true` sont pris en compte pour un lot.</span><span class="sxs-lookup"><span data-stu-id="4ebc5-118">Not all messages require a transaction, so only messages that require a transaction are placed in a batch, and only messages sent from operations marked with `TransactionScopeRequired` = `true` and `TransactionAutoComplete` = `true` are considered for a batch.</span></span> <span data-ttu-id="4ebc5-119">Si toutes les opérations sur le contrat de service sont marquées avec `TransactionScopeRequired`  =  `false` et `TransactionAutoComplete`  =  `false` , le mode de traitement par lot n’est jamais entré.</span><span class="sxs-lookup"><span data-stu-id="4ebc5-119">If all operations on the service contract are marked with `TransactionScopeRequired` = `false` and `TransactionAutoComplete` = `false`, then batching mode is never entered.</span></span>  
  
## <a name="committing-a-transaction"></a><span data-ttu-id="4ebc5-120">Validation d'une transaction</span><span class="sxs-lookup"><span data-stu-id="4ebc5-120">Committing a Transaction</span></span>  

 <span data-ttu-id="4ebc5-121">Une transaction par lot est validée selon les éléments suivants :</span><span class="sxs-lookup"><span data-stu-id="4ebc5-121">A batched transaction is committed based on the following:</span></span>  
  
- <span data-ttu-id="4ebc5-122">`MaxBatchSize`.</span><span class="sxs-lookup"><span data-stu-id="4ebc5-122">`MaxBatchSize`.</span></span> <span data-ttu-id="4ebc5-123">Propriété du comportement <xref:System.ServiceModel.Description.TransactedBatchingBehavior>.</span><span class="sxs-lookup"><span data-stu-id="4ebc5-123">A property of the <xref:System.ServiceModel.Description.TransactedBatchingBehavior> behavior.</span></span> <span data-ttu-id="4ebc5-124">Cette propriété détermine le nombre maximal de messages placés dans un lot.</span><span class="sxs-lookup"><span data-stu-id="4ebc5-124">This property determines the maximum number of messages that are placed into a batch.</span></span> <span data-ttu-id="4ebc5-125">Lorsque ce nombre est atteint, le lot est validé.</span><span class="sxs-lookup"><span data-stu-id="4ebc5-125">When this number is reached, the batch is committed.</span></span> <span data-ttu-id="4ebc5-126">Cette valeur n’est pas une limite stricte et il est possible de valider un lot avant d’avoir reçu ce nombre de messages.</span><span class="sxs-lookup"><span data-stu-id="4ebc5-126">This is value is not a strict limit, it is possible to commit a batch before receiving this number of messages.</span></span>  
  
- <span data-ttu-id="4ebc5-127">`Transaction Timeout`.</span><span class="sxs-lookup"><span data-stu-id="4ebc5-127">`Transaction Timeout`.</span></span> <span data-ttu-id="4ebc5-128">Lorsque 80 pourcent du délai d’expiration de la transaction est écoulé, le lot est validé et un nouveau lot est créé.</span><span class="sxs-lookup"><span data-stu-id="4ebc5-128">After 80 percent of the transaction's time-out has elapsed, the batch is committed and a new batch is created.</span></span> <span data-ttu-id="4ebc5-129">Cela signifie que s'il reste 20 pourcent ou moins du temps accordé à une transaction pour se terminer, le lot est validé.</span><span class="sxs-lookup"><span data-stu-id="4ebc5-129">This means that if 20 percent or less of the time given for a transaction to complete remains, the batch is committed.</span></span>  
  
- <span data-ttu-id="4ebc5-130">`TransactionScopeRequired`.</span><span class="sxs-lookup"><span data-stu-id="4ebc5-130">`TransactionScopeRequired`.</span></span> <span data-ttu-id="4ebc5-131">Lors du traitement d’un lot de messages, si WCF en trouve un qui a `TransactionScopeRequired`  =  `false` , il valide le lot et ouvre à nouveau un nouveau lot à la réception du premier message avec `TransactionScopeRequired`  =  `true` et `TransactionAutoComplete`  =  `true` .</span><span class="sxs-lookup"><span data-stu-id="4ebc5-131">When processing a batch of messages, if WCF finds one that has `TransactionScopeRequired` = `false`, it commits the batch and reopens a new batch on receipt of the first message with `TransactionScopeRequired` = `true` and `TransactionAutoComplete` = `true`.</span></span>  
  
- <span data-ttu-id="4ebc5-132">S’il n’y a plus de message dans la file d’attente, le lot actuel est validé, même si `MaxBatchSize` n’a pas été atteint ou que 80 pourcent du délai d’expiration de la transaction ne se sont pas écoulés.</span><span class="sxs-lookup"><span data-stu-id="4ebc5-132">If no more messages exist in the queue, then the current batch is committed, even if the `MaxBatchSize` has not been reached or 80 percent of the transaction's time-out has not elapsed.</span></span>  
  
## <a name="leaving-batching-mode"></a><span data-ttu-id="4ebc5-133">Conservation du mode de traitement par lot</span><span class="sxs-lookup"><span data-stu-id="4ebc5-133">Leaving Batching Mode</span></span>  

 <span data-ttu-id="4ebc5-134">Si un message dans un lot provoque l’abandon de la transaction, les étapes suivantes se produisent :</span><span class="sxs-lookup"><span data-stu-id="4ebc5-134">If a message in a batch causes the transaction to abort, the following steps occur:</span></span>  
  
1. <span data-ttu-id="4ebc5-135">L'ensemble du lot de messages est restauré.</span><span class="sxs-lookup"><span data-stu-id="4ebc5-135">The entire batch of messages is rolled back.</span></span>  
  
2. <span data-ttu-id="4ebc5-136">Les messages sont lus un par un jusqu'à ce que le nombre de messages lus dépasse le double de la taille de lot maximale.</span><span class="sxs-lookup"><span data-stu-id="4ebc5-136">Messages are read one at a time until the number of messages read exceeds twice the maximum batch size.</span></span>  
  
3. <span data-ttu-id="4ebc5-137">Le mode de traitement par lot est réactivé.</span><span class="sxs-lookup"><span data-stu-id="4ebc5-137">Batch mode is re-entered.</span></span>  
  
## <a name="choosing-the-batch-size"></a><span data-ttu-id="4ebc5-138">Sélection de la taille de lot</span><span class="sxs-lookup"><span data-stu-id="4ebc5-138">Choosing the Batch Size</span></span>  

 <span data-ttu-id="4ebc5-139">La taille d'un lot varie en fonction de l'application.</span><span class="sxs-lookup"><span data-stu-id="4ebc5-139">The size of a batch is application-dependent.</span></span> <span data-ttu-id="4ebc5-140">La méthode empirique s'avère être la meilleure pour arriver à une taille de lot optimale pour l'application.</span><span class="sxs-lookup"><span data-stu-id="4ebc5-140">The empirical method is the best way to arrive at an optimal batch size for the application.</span></span> <span data-ttu-id="4ebc5-141">Sélectionnez la taille de lot en fonction du modèle de déploiement réel de votre application.</span><span class="sxs-lookup"><span data-stu-id="4ebc5-141">It is important to remember when choosing a batch size to choose the size according to your application's actual deployment model.</span></span> <span data-ttu-id="4ebc5-142">Par exemple, lors du déploiement de l’application, si un serveur SQL doit être installé sur un ordinateur distant et qu’une transaction doit couvrir la file d’attente et le serveur SQL, la taille de lot sera déterminée de manière optimale en exécutant cette configuration exacte.</span><span class="sxs-lookup"><span data-stu-id="4ebc5-142">For example, when deploying the application, if you need an SQL server on a remote machine and a transaction that spans the queue and the SQL server, then the batch size is best determined by running this exact configuration.</span></span>  
  
## <a name="concurrency-and-batching"></a><span data-ttu-id="4ebc5-143">Traitement par lot simultané</span><span class="sxs-lookup"><span data-stu-id="4ebc5-143">Concurrency and Batching</span></span>  

 <span data-ttu-id="4ebc5-144">Pour augmenter le débit, vous pouvez également exécuter un grand nombre de lots simultanément.</span><span class="sxs-lookup"><span data-stu-id="4ebc5-144">To increase throughput, you can also have many batches run concurrently.</span></span> <span data-ttu-id="4ebc5-145">Pour activer le traitement par lot simultané, définissez `ConcurrencyMode.Multiple` dans `ServiceBehaviorAttribute`.</span><span class="sxs-lookup"><span data-stu-id="4ebc5-145">By setting `ConcurrencyMode.Multiple` in `ServiceBehaviorAttribute`, you enable concurrent batching.</span></span>  
  
 <span data-ttu-id="4ebc5-146">La *limitation de service* est un comportement de service qui est utilisé pour indiquer le nombre maximal d’appels simultanés pouvant être effectués sur le service.</span><span class="sxs-lookup"><span data-stu-id="4ebc5-146">*Service throttling* is a service behavior that is used to indicate how many maximum concurrent calls can be made on the service.</span></span> <span data-ttu-id="4ebc5-147">Lorsqu'il est utilisé en combinaison avec le traitement par lot, il permet d'indiquer le nombre de lots simultanés qui peuvent être exécutés.</span><span class="sxs-lookup"><span data-stu-id="4ebc5-147">When used with batching, this is interpreted as how many concurrent batches can be run.</span></span> <span data-ttu-id="4ebc5-148">Si la limitation de service n’est pas définie, WCF définit par défaut le nombre maximal d’appels simultanés à 16.</span><span class="sxs-lookup"><span data-stu-id="4ebc5-148">If the service throttling is not set, WCF defaults the maximum concurrent calls to 16.</span></span> <span data-ttu-id="4ebc5-149">Par conséquent, si le comportement de traitement par lot a été ajouté par défaut, 16 lots au maximum peuvent être simultanément actifs.</span><span class="sxs-lookup"><span data-stu-id="4ebc5-149">Thus, if batching behavior were added by default, a maximum of 16 batches can be active at the same time.</span></span> <span data-ttu-id="4ebc5-150">Il est préférable d'ajuster la limitation de service et le traitement par lot en fonction de votre capacité.</span><span class="sxs-lookup"><span data-stu-id="4ebc5-150">It is best to tune the service throttling and batching based on your capacity.</span></span> <span data-ttu-id="4ebc5-151">Par exemple, si la file d’attente contient 100 messages et qu’un lot de 20 est souhaité, un nombre maximal d’appels simultanés à 16 n’est pas utile car, selon débit, 16 transactions pourraient être actives, ce qui revient au même que de ne pas avoir de traitement par lot activé.</span><span class="sxs-lookup"><span data-stu-id="4ebc5-151">For example, if the queue has 100 messages and a batch of 20 is desired, having the maximum concurrent calls set to 16 is not useful because, depending on throughput, 16 transactions could be active, similar to not having batching turned on.</span></span> <span data-ttu-id="4ebc5-152">Par conséquent, lors de l'optimisation des performances, n'activez pas le traitement par lot simultané ou définissez également une taille de limitation de service correcte.</span><span class="sxs-lookup"><span data-stu-id="4ebc5-152">Therefore, when fine-tuning for performance, either do not have concurrent batching or have concurrent batching with the correct service throttle size.</span></span>  
  
## <a name="batching-and-multiple-endpoints"></a><span data-ttu-id="4ebc5-153">Traitement par lot et points de terminaison multiples</span><span class="sxs-lookup"><span data-stu-id="4ebc5-153">Batching and Multiple Endpoints</span></span>  

 <span data-ttu-id="4ebc5-154">Un point de terminaison est composé d'une adresse et d'un contrat.</span><span class="sxs-lookup"><span data-stu-id="4ebc5-154">An endpoint is composed of an address and a contract.</span></span> <span data-ttu-id="4ebc5-155">Plusieurs points de terminaison peuvent partager la même liaison.</span><span class="sxs-lookup"><span data-stu-id="4ebc5-155">There may be multiple endpoints that share the same binding.</span></span> <span data-ttu-id="4ebc5-156">Deux points de terminaison peuvent partager la même liaison et écouter un URI (Uniform Resource Identifier) ou une adresse de file d’attente.</span><span class="sxs-lookup"><span data-stu-id="4ebc5-156">It is possible for two endpoints to share the same binding and listen Uniform Resource Identifier (URI), or queue address.</span></span> <span data-ttu-id="4ebc5-157">Si deux points de terminaison lisent à partir de la même file d'attente, et que le comportement de traitement par lot avec transaction est ajouté à ces deux points de terminaison, un conflit dans les tailles de lot spécifiées peut se produire.</span><span class="sxs-lookup"><span data-stu-id="4ebc5-157">If two endpoints are reading from the same queue, and transacted batching behavior is added to both endpoints, a conflict in the batch sizes specified could arise.</span></span> <span data-ttu-id="4ebc5-158">Il est résolu en implémentant le traitement par lot à l'aide de la taille de lot minimale spécifiée entre les deux comportements de traitement par lot avec transaction.</span><span class="sxs-lookup"><span data-stu-id="4ebc5-158">This is resolved by implementing batching using the minimal batch size specified between the two transacted batching behaviors.</span></span> <span data-ttu-id="4ebc5-159">Dans ce scénario, si l'un des points de terminaison ne spécifie pas de traitement par lot avec transaction, les deux points de terminaison ne l'utiliseront pas.</span><span class="sxs-lookup"><span data-stu-id="4ebc5-159">In this scenario, if one of the endpoints does not specify transacted batching, then both endpoints would not use batching.</span></span>  
  
## <a name="example"></a><span data-ttu-id="4ebc5-160"> Exemple</span><span class="sxs-lookup"><span data-stu-id="4ebc5-160">Example</span></span>  

 <span data-ttu-id="4ebc5-161">L'exemple suivant indique comment spécifier `TransactedBatchingBehavior` dans un fichier de configuration.</span><span class="sxs-lookup"><span data-stu-id="4ebc5-161">The following example shows how to specify the `TransactedBatchingBehavior` in a configuration file.</span></span>  
  
```xml  
<behaviors>
  <endpointBehaviors>
    <behavior name="TransactedBatchingBehavior"
              maxBatchSize="100" />
  </endpointBehaviors>
</behaviors>
```  
  
 <span data-ttu-id="4ebc5-162">L'exemple suivant indique comment spécifier <xref:System.ServiceModel.Description.TransactedBatchingBehavior> dans le code.</span><span class="sxs-lookup"><span data-stu-id="4ebc5-162">The following example shows how to specify the <xref:System.ServiceModel.Description.TransactedBatchingBehavior> in code.</span></span>  
  
```csharp
using (ServiceHost serviceHost = new ServiceHost(typeof(OrderProcessorService)))
{
     ServiceEndpoint sep = ServiceHost.AddServiceEndpoint(typeof(IOrderProcessor), new NetMsmqBinding(), "net.msmq://localhost/private/ServiceModelSamplesTransacted");
     sep.Behaviors.Add(new TransactedBatchingBehavior(100));

     // Open the ServiceHost to create listeners and start listening for messages.
    serviceHost.Open();
  
    // The service can now be accessed.
    Console.WriteLine("The service is ready.");
    Console.WriteLine("Press <ENTER> to terminate service.");
    Console.WriteLine();
    Console.ReadLine();
  
    // Close the ServiceHostB to shut down the service.
    serviceHost.Close();
}  
```  
  
## <a name="see-also"></a><span data-ttu-id="4ebc5-163">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="4ebc5-163">See also</span></span>

- [<span data-ttu-id="4ebc5-164">Vue d'ensemble des files d'attente</span><span class="sxs-lookup"><span data-stu-id="4ebc5-164">Queues Overview</span></span>](queues-overview.md)
- [<span data-ttu-id="4ebc5-165">Mise en file d'attente dans WCF</span><span class="sxs-lookup"><span data-stu-id="4ebc5-165">Queuing in WCF</span></span>](queuing-in-wcf.md)
