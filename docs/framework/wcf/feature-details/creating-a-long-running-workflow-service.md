---
title: Création d'un service de workflow de longue durée
ms.date: 03/30/2017
ms.assetid: 4c39bd04-5b8a-4562-a343-2c63c2821345
ms.openlocfilehash: dae33cfcd5a2ef7b5269ebb040cf53b4c0e0b039
ms.sourcegitcommit: 68653db98c5ea7744fd438710248935f70020dfb
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/22/2019
ms.locfileid: "69945593"
---
# <a name="creating-a-long-running-workflow-service"></a><span data-ttu-id="ac951-102">Création d'un service de workflow de longue durée</span><span class="sxs-lookup"><span data-stu-id="ac951-102">Creating a Long-running Workflow Service</span></span>
<span data-ttu-id="ac951-103">Cette rubrique décrit comment créer un service de workflow de longue durée.</span><span class="sxs-lookup"><span data-stu-id="ac951-103">This topic describes how to create a long-running workflow service.</span></span> <span data-ttu-id="ac951-104">Les services de workflow de longue durée peuvent s'exécuter sur de longues périodes.</span><span class="sxs-lookup"><span data-stu-id="ac951-104">Long running workflow services may run for long periods of time.</span></span> <span data-ttu-id="ac951-105">À un certain stade, le workflow peut devenir inactif en attendant des informations supplémentaires.</span><span class="sxs-lookup"><span data-stu-id="ac951-105">At some point the workflow may go idle waiting for some additional information.</span></span> <span data-ttu-id="ac951-106">Lorsque cela se produit, le workflow est rendu persistant dans une base de données SQL et supprimé de la mémoire.</span><span class="sxs-lookup"><span data-stu-id="ac951-106">When this occurs the workflow is persisted to a SQL database and is removed from memory.</span></span> <span data-ttu-id="ac951-107">Une fois que les informations supplémentaires sont disponibles, l'instance de workflow est à nouveau chargée dans la mémoire et continue de s'exécuter.</span><span class="sxs-lookup"><span data-stu-id="ac951-107">When the additional information becomes available the workflow instance is loaded back into memory and continues executing.</span></span>  <span data-ttu-id="ac951-108">Dans ce scénario, vous implémentez un système de commande très simplifié.</span><span class="sxs-lookup"><span data-stu-id="ac951-108">In this scenario you are implementing a very simplified ordering system.</span></span>  <span data-ttu-id="ac951-109">Le client envoie un message initial au service de workflow pour commencer la commande.</span><span class="sxs-lookup"><span data-stu-id="ac951-109">The client sends an initial message to the workflow service to start the order.</span></span> <span data-ttu-id="ac951-110">Un ID de commande est retourné au client.</span><span class="sxs-lookup"><span data-stu-id="ac951-110">It returns an order ID to the client.</span></span> <span data-ttu-id="ac951-111">À ce stade, le service de workflow attend un autre message du client, passe à l'état inactif et est rendu persistant dans une base de données SQL Server.</span><span class="sxs-lookup"><span data-stu-id="ac951-111">At this point the workflow service is waiting for another message from the client and goes into the idle state and is persisted to a SQL Server database.</span></span>  <span data-ttu-id="ac951-112">Lorsque le client envoie le message suivant pour commander un article, le service de workflow est à nouveau chargé dans la mémoire et termine le traitement de la commande.</span><span class="sxs-lookup"><span data-stu-id="ac951-112">When the client sends the next message to order an item, the workflow service is loaded back into memory and finishes processing the order.</span></span> <span data-ttu-id="ac951-113">Dans l'exemple de code, il retourne une chaîne indiquant que l'article a été ajouté à la commande.</span><span class="sxs-lookup"><span data-stu-id="ac951-113">In the code sample it returns a string stating the item has been added to the order.</span></span> <span data-ttu-id="ac951-114">L'exemple de code n'est pas censé refléter une application réelle de la technologie mais plutôt un exemple simple illustrant des services de workflow de longue durée.</span><span class="sxs-lookup"><span data-stu-id="ac951-114">The code sample is not meant to be a real world application of the technology, but rather a simple sample that illustrates long running workflow services.</span></span> <span data-ttu-id="ac951-115">Cette rubrique suppose que vous savez comment créer des projets et des solutions Visual Studio 2012.</span><span class="sxs-lookup"><span data-stu-id="ac951-115">This topic assumes you know how to create Visual Studio 2012 projects and solutions.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="ac951-116">Prérequis</span><span class="sxs-lookup"><span data-stu-id="ac951-116">Prerequisites</span></span>
 <span data-ttu-id="ac951-117">Les logiciels suivants doivent être installés pour suivre cette procédure pas à pas :</span><span class="sxs-lookup"><span data-stu-id="ac951-117">You must have the following software installed to use this walkthrough:</span></span>

1. <span data-ttu-id="ac951-118">Microsoft SQL Server 2008</span><span class="sxs-lookup"><span data-stu-id="ac951-118">Microsoft SQL Server 2008</span></span>

2. <span data-ttu-id="ac951-119">Visual Studio 2012</span><span class="sxs-lookup"><span data-stu-id="ac951-119">Visual Studio 2012</span></span>

3. <span data-ttu-id="ac951-120">Microsoft [!INCLUDE[netfx_current_long](../../../../includes/netfx-current-long-md.md)]</span><span class="sxs-lookup"><span data-stu-id="ac951-120">Microsoft  [!INCLUDE[netfx_current_long](../../../../includes/netfx-current-long-md.md)]</span></span>

4. <span data-ttu-id="ac951-121">Vous êtes familiarisé avec WCF et Visual Studio 2012 et vous savez comment créer des projets/solutions.</span><span class="sxs-lookup"><span data-stu-id="ac951-121">You are familiar with WCF and Visual Studio 2012 and know how to create projects/solutions.</span></span>

### <a name="to-setup-the-sql-database"></a><span data-ttu-id="ac951-122">Pour configurer la base de données SQL</span><span class="sxs-lookup"><span data-stu-id="ac951-122">To Setup the SQL Database</span></span>

1. <span data-ttu-id="ac951-123">Pour que les instances du service de workflow soient persistantes, Microsoft SQL Server doit être installé et vous devez configurer une base de données pour stocker les instances de workflow persistantes.</span><span class="sxs-lookup"><span data-stu-id="ac951-123">In order for workflow service instances to be persisted you must have Microsoft SQL Server installed and you must configure a database to store the persisted workflow instances.</span></span> <span data-ttu-id="ac951-124">Exécutez Microsoft SQL Management Studio en cliquant sur le bouton **Démarrer** , en sélectionnant **tous les programmes**, **Microsoft SQL Server 2008**et **Microsoft SQL Management Studio**.</span><span class="sxs-lookup"><span data-stu-id="ac951-124">Run Microsoft SQL Management Studio by clicking the **Start** button, selecting **All Programs**, **Microsoft SQL Server 2008**, and **Microsoft SQL Management Studio**.</span></span>

2. <span data-ttu-id="ac951-125">Cliquez sur le bouton **se connecter** pour vous connecter à l’instance SQL Server</span><span class="sxs-lookup"><span data-stu-id="ac951-125">Click the **Connect** button to log on to the SQL Server instance</span></span>

3. <span data-ttu-id="ac951-126">Cliquez avec le bouton droit sur **bases de données** dans l’arborescence et sélectionnez **nouvelle base de données.**</span><span class="sxs-lookup"><span data-stu-id="ac951-126">Right click **Databases** in the tree view and select **New Database..**</span></span> <span data-ttu-id="ac951-127">pour créer une nouvelle base de `SQLPersistenceStore`données appelée.</span><span class="sxs-lookup"><span data-stu-id="ac951-127">to create a new database called `SQLPersistenceStore`.</span></span>

4. <span data-ttu-id="ac951-128">Exécutez le fichier de script SqlWorkflowInstanceStoreSchema.sql situé dans le répertoire C:\Windows\Microsoft.NET\Framework\v4.0\SQL\en dans la base de données SQLPersistenceStore pour configurer les schémas de base de données requis.</span><span class="sxs-lookup"><span data-stu-id="ac951-128">Run the SqlWorkflowInstanceStoreSchema.sql script file located in the C:\Windows\Microsoft.NET\Framework\v4.0\SQL\en directory on the SQLPersistenceStore database to set up the needed database schemas.</span></span>

5. <span data-ttu-id="ac951-129">Exécutez le fichier de script SqlWorkflowInstanceStoreLogic.sql situé dans le répertoire C:\Windows\Microsoft.NET\Framework\v4.0\SQL\en dans la base de données SQLPersistenceStore pour configurer la logique de base de données requise.</span><span class="sxs-lookup"><span data-stu-id="ac951-129">Run the SqlWorkflowInstanceStoreLogic.sql script file located in the C:\Windows\Microsoft.NET\Framework\v4.0\SQL\en directory on the SQLPersistenceStore database to set up the needed database logic.</span></span>

### <a name="to-create-the-web-hosted-workflow-service"></a><span data-ttu-id="ac951-130">Pour créer le service de workflow hébergé sur le Web</span><span class="sxs-lookup"><span data-stu-id="ac951-130">To Create the Web Hosted Workflow Service</span></span>

1. <span data-ttu-id="ac951-131">Créez une solution Visual Studio 2012 vide, nommez `OrderProcessing`-la.</span><span class="sxs-lookup"><span data-stu-id="ac951-131">Create an empty Visual Studio 2012 solution, name it `OrderProcessing`.</span></span>

2. <span data-ttu-id="ac951-132">Ajoutez à la solution un nouveau projet d'application de service de workflow WCF appelée `OrderService`.</span><span class="sxs-lookup"><span data-stu-id="ac951-132">Add a new WCF Workflow Service Application project called `OrderService` to the solution.</span></span>

3. <span data-ttu-id="ac951-133">Dans la boîte de dialogue Propriétés du projet, sélectionnez l’onglet **Web** .</span><span class="sxs-lookup"><span data-stu-id="ac951-133">In the project properties dialog, select the **Web** tab.</span></span>

    1. <span data-ttu-id="ac951-134">Sous **action de démarrage** , sélectionnez une **page spécifique** et spécifiez `Service1.xamlx`.</span><span class="sxs-lookup"><span data-stu-id="ac951-134">Under **Start Action** select **Specific Page** and specify `Service1.xamlx`.</span></span>

         <span data-ttu-id="ac951-135">![Propriétés Web du projet de service de workflow](./media/creating-a-long-running-workflow-service/start-action-specific-page-option.png "Créer l’option de page spécifique au service de flux de travail hébergé sur le Web")</span><span class="sxs-lookup"><span data-stu-id="ac951-135">![Workflow Service Project Web Properties](./media/creating-a-long-running-workflow-service/start-action-specific-page-option.png "Create the web hosted workflow service - Specific Page option")</span></span>

    2. <span data-ttu-id="ac951-136">Sous **serveurs** , sélectionnez **utiliser le serveur Web IIS local**.</span><span class="sxs-lookup"><span data-stu-id="ac951-136">Under **Servers** select **Use Local IIS Web server**.</span></span>

         <span data-ttu-id="ac951-137">![Paramètres du serveur Web local](./media/creating-a-long-running-workflow-service/use-local-web-server.png "Créer le service de flux de travail hébergé sur le Web-utiliser l’option de serveur Web IIS local")</span><span class="sxs-lookup"><span data-stu-id="ac951-137">![Local Web Server Settings](./media/creating-a-long-running-workflow-service/use-local-web-server.png "Create the web hosted workflow service - Use Local IIS Web Server option")</span></span>

        > [!WARNING]
        >  <span data-ttu-id="ac951-138">Vous devez exécuter Visual Studio 2012 en mode administrateur pour définir ce paramètre.</span><span class="sxs-lookup"><span data-stu-id="ac951-138">You must run Visual Studio 2012 in administrator mode to make this setting.</span></span>

         <span data-ttu-id="ac951-139">Ces deux étapes configurent le projet du service de workflow pour qu'il soit hébergé par IIS.</span><span class="sxs-lookup"><span data-stu-id="ac951-139">These two steps configure the workflow service project to be hosted by IIS.</span></span>

4. <span data-ttu-id="ac951-140">Ouvrez `Service1.xamlx` s’il n’est pas déjà ouvert et supprimez les activités **ReceiveRequest** et **SendResponse** existantes.</span><span class="sxs-lookup"><span data-stu-id="ac951-140">Open `Service1.xamlx` if it is not open already and delete the existing **ReceiveRequest** and **SendResponse** activities.</span></span>

5. <span data-ttu-id="ac951-141">Sélectionnez l’activité de **service séquentielle** , puis cliquez sur le lien **variables** et ajoutez les variables affichées dans l’illustration suivante.</span><span class="sxs-lookup"><span data-stu-id="ac951-141">Select the **Sequential Service** activity and click the **Variables** link and add the variables shown in the following illustration.</span></span> <span data-ttu-id="ac951-142">Cette action permet d'ajouter des variables qui seront utilisées ultérieurement dans le service de workflow.</span><span class="sxs-lookup"><span data-stu-id="ac951-142">Doing this adds some variables that will be used later on in the workflow service.</span></span>

    > [!NOTE]
    > <span data-ttu-id="ac951-143">Si CorrelationHandle n’est pas dans la liste déroulante type de variable, sélectionnez **Parcourir les types** dans la liste déroulante.</span><span class="sxs-lookup"><span data-stu-id="ac951-143">If CorrelationHandle is not in the Variable Type drop-down, select **Browse for types** from the drop-down.</span></span> <span data-ttu-id="ac951-144">Tapez CorrelationHandle dans la zone **nom de type** , sélectionnez CorrelationHandle dans la zone de liste, puis cliquez sur **OK**.</span><span class="sxs-lookup"><span data-stu-id="ac951-144">Type CorrelationHandle in the **Type name** box, select CorrelationHandle from the listbox and click **OK**.</span></span>

     <span data-ttu-id="ac951-145">![Ajouter des variables](./media/creating-a-long-running-workflow-service/add-variables-sequential-service-activity.gif "Ajoutez des variables à l’activité de service séquentielle.")</span><span class="sxs-lookup"><span data-stu-id="ac951-145">![Add Variables](./media/creating-a-long-running-workflow-service/add-variables-sequential-service-activity.gif "Add variables to the Sequential Service activity.")</span></span>

6. <span data-ttu-id="ac951-146">Faites glisser et déposez un modèle d’activité **ReceiveAndSendReply** dans l’activité de **service séquentielle** .</span><span class="sxs-lookup"><span data-stu-id="ac951-146">Drag and drop a **ReceiveAndSendReply** activity template into the **Sequential Service** activity.</span></span> <span data-ttu-id="ac951-147">Cet ensemble d'activités recevra un message d'un client et enverra une réponse en retour.</span><span class="sxs-lookup"><span data-stu-id="ac951-147">This set of activities will receive a message from a client and send a reply back.</span></span>

    1. <span data-ttu-id="ac951-148">Sélectionnez l’activité **Receive** et définissez les propriétés mises en surbrillance dans l’illustration suivante.</span><span class="sxs-lookup"><span data-stu-id="ac951-148">Select the **Receive** activity and set the properties highlighted in the following illustration.</span></span>

         <span data-ttu-id="ac951-149">![Définir les propriétés d’une activité Receive](./media/creating-a-long-running-workflow-service/set-receive-activity-properties.png "Définissez les propriétés de l’activité Receive.")</span><span class="sxs-lookup"><span data-stu-id="ac951-149">![Set Receive Activity Properties](./media/creating-a-long-running-workflow-service/set-receive-activity-properties.png "Set the Receive activity properties.")</span></span>

         <span data-ttu-id="ac951-150">La propriété DisplayName définit le nom affiché pour l'activité Receive dans le concepteur.</span><span class="sxs-lookup"><span data-stu-id="ac951-150">The DisplayName property sets the name displayed for the Receive activity in the designer.</span></span> <span data-ttu-id="ac951-151">Les propriétés ServiceContractName et OperationName spécifient le nom du contrat de service et de l'opération implémentés par l'activité Receive.</span><span class="sxs-lookup"><span data-stu-id="ac951-151">The ServiceContractName and OperationName properties specify the name of the service contract and operation that are implemented by the Receive activity.</span></span> <span data-ttu-id="ac951-152">Pour plus d’informations sur l’utilisation des contrats dans les services de workflow, consultez [utilisation de contrats dans le workflow](../../../../docs/framework/wcf/feature-details/using-contracts-in-workflow.md).</span><span class="sxs-lookup"><span data-stu-id="ac951-152">For more information about how contracts are used in Workflow services see [Using Contracts in Workflow](../../../../docs/framework/wcf/feature-details/using-contracts-in-workflow.md).</span></span>

    2. <span data-ttu-id="ac951-153">Cliquez sur le lien **définir...** dans l’activité **ReceiveStartOrder** et définissez les propriétés affichées dans l’illustration suivante.</span><span class="sxs-lookup"><span data-stu-id="ac951-153">Click the **Define...** link in the **ReceiveStartOrder** activity and set the properties shown in the following illustration.</span></span>  <span data-ttu-id="ac951-154">Notez que la case d’option **paramètres** est sélectionnée. un paramètre `p_customerName` nommé est lié à `customerName` la variable.</span><span class="sxs-lookup"><span data-stu-id="ac951-154">Notice that the **Parameters** radio button is selected, a parameter named `p_customerName` is bound to the `customerName` variable.</span></span> <span data-ttu-id="ac951-155">Cela configure l’activité **Receive** pour recevoir des données et les lier à des variables locales.</span><span class="sxs-lookup"><span data-stu-id="ac951-155">This configures the **Receive** activity to receive some data and bind that data to local variables.</span></span>

         <span data-ttu-id="ac951-156">![Définition des données reçues par l’activité Receive](./media/creating-a-long-running-workflow-service/set-properties-for-receive-content.png "Définissez les propriétés des données reçues par l’activité Receive.")</span><span class="sxs-lookup"><span data-stu-id="ac951-156">![Setting the data received by the Receive activity](./media/creating-a-long-running-workflow-service/set-properties-for-receive-content.png "Set the properties for data received by the Receive activity.")</span></span>

    3. <span data-ttu-id="ac951-157">Sélectionnez l’activité **SendReplyToReceive** et définissez la propriété mise en surbrillance indiquée dans l’illustration suivante.</span><span class="sxs-lookup"><span data-stu-id="ac951-157">Select The **SendReplyToReceive** activity and set the highlighted property shown in the following illustration.</span></span>

         <span data-ttu-id="ac951-158">![Définition des propriétés de l’activité SendReply](./media/creating-a-long-running-workflow-service/set-properties-for-reply-activities.png "SetReplyProperties")</span><span class="sxs-lookup"><span data-stu-id="ac951-158">![Setting the properties of the SendReply activity](./media/creating-a-long-running-workflow-service/set-properties-for-reply-activities.png "SetReplyProperties")</span></span>

    4. <span data-ttu-id="ac951-159">Cliquez sur le lien **définir...** dans l’activité **SendReplyToStartOrder** et définissez les propriétés affichées dans l’illustration suivante.</span><span class="sxs-lookup"><span data-stu-id="ac951-159">Click the **Define...** link in the **SendReplyToStartOrder** activity and set the properties shown in the following illustration.</span></span> <span data-ttu-id="ac951-160">Notez que la case d’option **paramètres** est sélectionnée. un paramètre nommé `p_orderId` est lié à la `orderId` variable.</span><span class="sxs-lookup"><span data-stu-id="ac951-160">Notice that the **Parameters** radio button is selected; a parameter named `p_orderId` is bound to the `orderId` variable.</span></span> <span data-ttu-id="ac951-161">Ce paramètre spécifie que l'activité SendReplyToStartOrder retournera une valeur de type String à l'appelant.</span><span class="sxs-lookup"><span data-stu-id="ac951-161">This setting specifies that the SendReplyToStartOrder activity will return a value of type string to the caller.</span></span>

         <span data-ttu-id="ac951-162">![Configuration des données de contenu de l’activité SendReply] Configurez le (./media/creating-a-long-running-workflow-service/setreplycontent-for-sendreplytostartorder-activity.png "paramètre de l’activité SetReplyToStartOrder.")</span><span class="sxs-lookup"><span data-stu-id="ac951-162">![Configuring the SendReply activity content data](./media/creating-a-long-running-workflow-service/setreplycontent-for-sendreplytostartorder-activity.png "Configure setting for SetReplyToStartOrder activity.")</span></span>

    5. <span data-ttu-id="ac951-163">Faites glisser et déposez une activité Assign entre les activités **Receive** et **SendReply** et définissez les propriétés comme indiqué dans l’illustration suivante:</span><span class="sxs-lookup"><span data-stu-id="ac951-163">Drag and drop an Assign activity in between the **Receive** and **SendReply** activities and set the properties as shown in the following illustration:</span></span>

         <span data-ttu-id="ac951-164">![Ajout d’une activité Assign](./media/creating-a-long-running-workflow-service/add-an-assign-activity.png "Ajoutez une activité Assign.")</span><span class="sxs-lookup"><span data-stu-id="ac951-164">![Adding an assign activity](./media/creating-a-long-running-workflow-service/add-an-assign-activity.png "Add an assign activity.")</span></span>

         <span data-ttu-id="ac951-165">Cette action permet de créer un nouvel ID de commande et de placer la valeur dans la variable orderId.</span><span class="sxs-lookup"><span data-stu-id="ac951-165">This creates a new order ID and places the value in the orderId variable.</span></span>

    6. <span data-ttu-id="ac951-166">Sélectionnez l’activité **ReplyToStartOrder** .</span><span class="sxs-lookup"><span data-stu-id="ac951-166">Select the **ReplyToStartOrder** activity.</span></span> <span data-ttu-id="ac951-167">Dans la fenêtre Propriétés, cliquez sur le bouton de sélection pour **CorrelationInitializers**.</span><span class="sxs-lookup"><span data-stu-id="ac951-167">In the properties window click the ellipsis button for **CorrelationInitializers**.</span></span> <span data-ttu-id="ac951-168">Sélectionnez le lien **Ajouter** un initialiseur, `orderIdHandle` entrez dans la zone de texte initialiseur, sélectionnez l’initialiseur de corrélation de requête pour le type de corrélation et sélectionnez p_orderId sous la zone de liste déroulante requêtes XPath.</span><span class="sxs-lookup"><span data-stu-id="ac951-168">Select the **Add initializer** link, enter `orderIdHandle` in the Initializer text box, select Query correlation initializer for the Correlation type, and select p_orderId under the XPATH Queries dropdown box.</span></span> <span data-ttu-id="ac951-169">Ces paramètres sont indiqués dans l'illustration suivante.</span><span class="sxs-lookup"><span data-stu-id="ac951-169">These settings are shown in the following illustration.</span></span> <span data-ttu-id="ac951-170">Cliquez sur **OK**.</span><span class="sxs-lookup"><span data-stu-id="ac951-170">Click **OK**.</span></span>  <span data-ttu-id="ac951-171">Cette action permet d'initialiser une corrélation entre le client et cette instance du service de workflow.</span><span class="sxs-lookup"><span data-stu-id="ac951-171">This initializes a correlation between the client and this instance of the workflow service.</span></span> <span data-ttu-id="ac951-172">Lorsqu'un message contenant cet ID de commande est reçu, il est routé vers cette instance du service de workflow.</span><span class="sxs-lookup"><span data-stu-id="ac951-172">When a message containing this order ID is received it is routed to this instance of the workflow service.</span></span>

         <span data-ttu-id="ac951-173">![Ajout d’un initialiseur de corrélation](./media/creating-a-long-running-workflow-service/add-correlationinitializers.png "Ajoutez un initialiseur de corrélation.")</span><span class="sxs-lookup"><span data-stu-id="ac951-173">![Adding a correlation initializer](./media/creating-a-long-running-workflow-service/add-correlationinitializers.png "Add a correlation initializer.")</span></span>

7. <span data-ttu-id="ac951-174">Faites glisser et déposez une autre activité **ReceiveAndSendReply** à la fin du workflow (en dehors de la **séquence** contenant les premières activités **Receive** et **SendReply** ).</span><span class="sxs-lookup"><span data-stu-id="ac951-174">Drag and drop another **ReceiveAndSendReply** activity to the end of the workflow (outside the **Sequence** containing the first **Receive** and **SendReply** activities).</span></span> <span data-ttu-id="ac951-175">Le second message envoyé par le client sera alors reçu et une réponse sera renvoyée.</span><span class="sxs-lookup"><span data-stu-id="ac951-175">This will receive the second message sent by the client and respond to it.</span></span>

    1. <span data-ttu-id="ac951-176">Sélectionnez la **séquence** qui contient les activités **Receive** et **SendReply** nouvellement ajoutées, puis cliquez sur le bouton **variables** .</span><span class="sxs-lookup"><span data-stu-id="ac951-176">Select the **Sequence** that contains the newly added **Receive** and **SendReply** activities and click the **Variables** button.</span></span> <span data-ttu-id="ac951-177">Ajoutez la variable mise en surbrillance dans l'illustration suivante :</span><span class="sxs-lookup"><span data-stu-id="ac951-177">Add the variable highlighted in the following illustration:</span></span>

         <span data-ttu-id="ac951-178">![Ajout de nouvelles variables](./media/creating-a-long-running-workflow-service/add-the-itemid-variable.png "Ajoutez la variable ItemId.")</span><span class="sxs-lookup"><span data-stu-id="ac951-178">![Adding new variables](./media/creating-a-long-running-workflow-service/add-the-itemid-variable.png "Add the ItemId variable.")</span></span>
         
         <span data-ttu-id="ac951-179">Ajoutez `orderResult` également As **String** dans l' `Sequence` étendue.</span><span class="sxs-lookup"><span data-stu-id="ac951-179">Also add `orderResult` as **String** in the `Sequence` scope.</span></span>

    2. <span data-ttu-id="ac951-180">Sélectionnez l’activité **Receive** et définissez les propriétés affichées dans l’illustration suivante:</span><span class="sxs-lookup"><span data-stu-id="ac951-180">Select the **Receive** activity and set the properties shown in the following illustration:</span></span>

         <span data-ttu-id="ac951-181">![Définir les propriétés de l’activité Receive](./media/creating-a-long-running-workflow-service/set-receive-activities-properties.png "Définissez les propriétés de l’activité Receive.")</span><span class="sxs-lookup"><span data-stu-id="ac951-181">![Set the Receive activity properties](./media/creating-a-long-running-workflow-service/set-receive-activities-properties.png "Set the Receive activities properties.")</span></span>
         
         > [!NOTE]
         >  <span data-ttu-id="ac951-182">N’oubliez pas de modifier le champ `../IAddItem`ServiceContractName avec.</span><span class="sxs-lookup"><span data-stu-id="ac951-182">Don't forget to change **ServiceContractName** field with `../IAddItem`.</span></span>

    3. <span data-ttu-id="ac951-183">Cliquez sur le lien **définir...** dans l’activité **ReceiveAddItem** et ajoutez les paramètres indiqués dans l’illustration suivante: Cela configure l’activité Receive pour accepter deux paramètres, l’ID de commande et l’ID de l’élément en cours de tri.</span><span class="sxs-lookup"><span data-stu-id="ac951-183">Click the **Define...** link in the **ReceiveAddItem** activity and add the parameters shown in the following illustration:This configures the receive activity to accept two parameters, the order ID and the ID of the item being ordered.</span></span>

         <span data-ttu-id="ac951-184">![Spécification des paramètres pour la seconde réception](./media/creating-a-long-running-workflow-service/add-receive-two-parameters.png "Configurez l’activité Receive pour recevoir deux paramètres.")</span><span class="sxs-lookup"><span data-stu-id="ac951-184">![Specifying parameters for the second receive](./media/creating-a-long-running-workflow-service/add-receive-two-parameters.png "Configure the receive activity to receive two parameters.")</span></span>

    4. <span data-ttu-id="ac951-185">Cliquez sur le bouton de sélection CorrelateOn `orderIdHandle`et entrez.</span><span class="sxs-lookup"><span data-stu-id="ac951-185">Click the **CorrelateOn** ellipsis button and enter `orderIdHandle`.</span></span> <span data-ttu-id="ac951-186">Sous **requêtes XPath**, cliquez sur la flèche déroulante `p_orderId`et sélectionnez.</span><span class="sxs-lookup"><span data-stu-id="ac951-186">Under **XPath Queries**, click the drop down arrow and select `p_orderId`.</span></span> <span data-ttu-id="ac951-187">Cela permet de configurer la corrélation sur la deuxième activité Receive.</span><span class="sxs-lookup"><span data-stu-id="ac951-187">This configures the correlation on the second receive activity.</span></span> <span data-ttu-id="ac951-188">Pour plus d’informations sur la corrélation, consultez [corrélation](../../../../docs/framework/wcf/feature-details/correlation.md).</span><span class="sxs-lookup"><span data-stu-id="ac951-188">For more information about correlation see [Correlation](../../../../docs/framework/wcf/feature-details/correlation.md).</span></span>

         <span data-ttu-id="ac951-189">![Définition de la propriété CorrelatesOn](./media/creating-a-long-running-workflow-service/correlateson-setting.png "Définissez la propriété CorrelatesOn.")</span><span class="sxs-lookup"><span data-stu-id="ac951-189">![Setting the CorrelatesOn property](./media/creating-a-long-running-workflow-service/correlateson-setting.png "Set the CorrelatesOn property.")</span></span>

    5. <span data-ttu-id="ac951-190">Faites glisser et déposez une activité **If** immédiatement après l’activité **ReceiveAddItem** .</span><span class="sxs-lookup"><span data-stu-id="ac951-190">Drag and drop an **If** activity immediately after the **ReceiveAddItem** activity.</span></span> <span data-ttu-id="ac951-191">Cette activité agit de la même façon qu'une instruction if.</span><span class="sxs-lookup"><span data-stu-id="ac951-191">This activity acts just like an if statement.</span></span>

        1. <span data-ttu-id="ac951-192">Affectez à la propriété **condition** la valeur`itemId=="Zune HD" (itemId="Zune HD" for Visual Basic)`</span><span class="sxs-lookup"><span data-stu-id="ac951-192">Set the **Condition** property to `itemId=="Zune HD" (itemId="Zune HD" for Visual Basic)`</span></span>

        2. <span data-ttu-id="ac951-193">Faites glisser une activité **Assign** dans la section **Then** et une autre dans la section **else** , puis définissez les propriétés des activités **Assign** comme indiqué dans l’illustration suivante.</span><span class="sxs-lookup"><span data-stu-id="ac951-193">Drag and drop an **Assign** activity in to the **Then** section and another into the **Else** section set the properties of the **Assign** activities as shown in the following illustration.</span></span>

             <span data-ttu-id="ac951-194">![Assignation du résultat de l’appel de service](./media/creating-a-long-running-workflow-service/assign-result-of-service-call.png "Assignez le résultat de l’appel de service.")</span><span class="sxs-lookup"><span data-stu-id="ac951-194">![Assigning the result of the service call](./media/creating-a-long-running-workflow-service/assign-result-of-service-call.png "Assign the result of the service call.")</span></span>

             <span data-ttu-id="ac951-195">Si la condition est `true` , la section **Then** est exécutée.</span><span class="sxs-lookup"><span data-stu-id="ac951-195">If the condition is `true` the **Then** section will be executed.</span></span> <span data-ttu-id="ac951-196">Si la condition est `false` , la section **else** est exécutée.</span><span class="sxs-lookup"><span data-stu-id="ac951-196">If the condition is `false` the **Else** section is executed.</span></span>

        3. <span data-ttu-id="ac951-197">Sélectionnez l’activité **SendReplyToReceive** et définissez la propriété **DisplayName** indiquée dans l’illustration suivante.</span><span class="sxs-lookup"><span data-stu-id="ac951-197">Select the **SendReplyToReceive** activity and set the **DisplayName** property shown in the following illustration.</span></span>

             <span data-ttu-id="ac951-198">![Définition des propriétés de l’activité SendReply](./media/creating-a-long-running-workflow-service/send-reply-activity-property.png "Définissez la propriété de l’activité SendReply.")</span><span class="sxs-lookup"><span data-stu-id="ac951-198">![Setting the SendReply activity properties](./media/creating-a-long-running-workflow-service/send-reply-activity-property.png "Set the SendReply activity property.")</span></span>

        4. <span data-ttu-id="ac951-199">Cliquez sur le lien **définir...** dans l’activité **SetReplyToAddItem** et configurez-le comme indiqué dans l’illustration suivante.</span><span class="sxs-lookup"><span data-stu-id="ac951-199">Click the **Define ...** link in the **SetReplyToAddItem** activity and configure it as shown in the following illustration.</span></span> <span data-ttu-id="ac951-200">Cela configure l’activité **SendReplyToAddItem** pour retourner la valeur dans la `orderResult` variable.</span><span class="sxs-lookup"><span data-stu-id="ac951-200">This configures the **SendReplyToAddItem** activity to return the value in the `orderResult` variable.</span></span>

             <span data-ttu-id="ac951-201">![Définition de la liaison de données pour l’activité SendReply](./media/creating-a-long-running-workflow-service/set-property-for-sendreplytoadditem.gif "Définissez la propriété pour l’activité SendReplyToAddItem.")</span><span class="sxs-lookup"><span data-stu-id="ac951-201">![Setting the data binding for the SendReply activity](./media/creating-a-long-running-workflow-service/set-property-for-sendreplytoadditem.gif "Set property for SendReplyToAddItem activity.")</span></span>

8. <span data-ttu-id="ac951-202">Ouvrez le fichier Web. config et ajoutez les éléments suivants dans la \<section comportement > pour activer la persistance du flux de travail.</span><span class="sxs-lookup"><span data-stu-id="ac951-202">Open the web.config file and add the following elements in the \<behavior> section to enable workflow persistence.</span></span>

    ```xml
    <sqlWorkflowInstanceStore connectionString="Data Source=your-machine\SQLExpress;Initial Catalog=SQLPersistenceStore;Integrated Security=True;Asynchronous Processing=True" instanceEncodingOption="None" instanceCompletionAction="DeleteAll" instanceLockedExceptionAction="BasicRetry" hostLockRenewalPeriod="00:00:30" runnableInstancesDetectionPeriod="00:00:02" />
              <workflowIdle timeToUnload="0"/>
    ```

    > [!WARNING]
    >  <span data-ttu-id="ac951-203">Assurez-vous de remplacer le nom de l'hôte et de l'instance SQL Server dans l'extrait de code précédent.</span><span class="sxs-lookup"><span data-stu-id="ac951-203">Make sure to replace your host and SQL server instance name in the previous code snippet.</span></span>

9. <span data-ttu-id="ac951-204">Générez la solution.</span><span class="sxs-lookup"><span data-stu-id="ac951-204">Build the solution.</span></span>

### <a name="to-create-a-client-application-to-call-the-workflow-service"></a><span data-ttu-id="ac951-205">Pour créer une application cliente pour appeler le service de workflow</span><span class="sxs-lookup"><span data-stu-id="ac951-205">To Create a Client Application to Call the Workflow Service</span></span>

1. <span data-ttu-id="ac951-206">Ajoutez à la solution un nouveau projet d'application console nommé `OrderClient`.</span><span class="sxs-lookup"><span data-stu-id="ac951-206">Add a new Console application project called `OrderClient` to the solution.</span></span>

2. <span data-ttu-id="ac951-207">Ajoutez les références aux assemblys suivantes au projet `OrderClient` :</span><span class="sxs-lookup"><span data-stu-id="ac951-207">Add references to the following assemblies to the `OrderClient` project</span></span>

    1. <span data-ttu-id="ac951-208">System.ServiceModel.dll</span><span class="sxs-lookup"><span data-stu-id="ac951-208">System.ServiceModel.dll</span></span>

    2. <span data-ttu-id="ac951-209">System.ServiceModel.Activities.dll</span><span class="sxs-lookup"><span data-stu-id="ac951-209">System.ServiceModel.Activities.dll</span></span>

3. <span data-ttu-id="ac951-210">Ajoutez une référence de service au service de workflow et spécifiez `OrderService` comme espace de noms.</span><span class="sxs-lookup"><span data-stu-id="ac951-210">Add a service reference to the workflow service and specify `OrderService` as the namespace.</span></span>

4. <span data-ttu-id="ac951-211">Dans la méthode `Main()` du projet client, ajoutez le code suivant :</span><span class="sxs-lookup"><span data-stu-id="ac951-211">In the `Main()` method of the client project add the following code:</span></span>

    ```
    static void Main(string[] args)
    {
       // Send initial message to start the workflow service
       Console.WriteLine("Sending start message");
       StartOrderClient startProxy = new StartOrderClient();
       string orderId = startProxy.StartOrder("Kim Abercrombie");

       // The workflow service is now waiting for the second message to be sent
       Console.WriteLine("Workflow service is idle...");
       Console.WriteLine("Press [ENTER] to send an add item message to reactivate the workflow service...");
       Console.ReadLine();

       // Send the second message
       Console.WriteLine("Sending add item message");
       AddItemClient addProxy = new AddItemClient();
       AddItem item = new AddItem();
       item.p_itemId = "Zune HD";
       item.p_orderId = orderId;

       string orderResult = addProxy.AddItem(item);
       Console.WriteLine("Service returned: " + orderResult);
    }
    ```

5. <span data-ttu-id="ac951-212">Générez la solution et exécutez l'application `OrderClient`.</span><span class="sxs-lookup"><span data-stu-id="ac951-212">Build the solution and run the `OrderClient` application.</span></span> <span data-ttu-id="ac951-213">Le client affiche le texte suivant :</span><span class="sxs-lookup"><span data-stu-id="ac951-213">The client will display the following text:</span></span>

    ```Output
    Sending start messageWorkflow service is idle...Press [ENTER] to send an add item message to reactivate the workflow service...
    ```

6. <span data-ttu-id="ac951-214">Pour vérifier que le service de workflow a été conservé, démarrez le SQL Server Management Studio en accédant au menu **Démarrer** , en sélectionnant **tous les programmes**, **Microsoft SQL Server 2008** **SQL Server Management Studio**.</span><span class="sxs-lookup"><span data-stu-id="ac951-214">To verify that the workflow service has been persisted, start the SQL Server Management Studio by going to the **Start** menu, Selecting **All Programs**, **Microsoft SQL Server 2008**, **SQL Server Management Studio**.</span></span>

    1. <span data-ttu-id="ac951-215">Dans le volet gauche, développez **bases de données**, **SQLPersistenceStore**, **vues** , puis cliquez avec le bouton droit sur **System. Activities. DurableInstancing. instances** et sélectionnez **Sélectionner les 1000 premières lignes**.</span><span class="sxs-lookup"><span data-stu-id="ac951-215">In the left hand pane expand, **Databases**, **SQLPersistenceStore**, **Views** and right click **System.Activities.DurableInstancing.Instances** and select **Select Top 1000 Rows**.</span></span> <span data-ttu-id="ac951-216">Dans le volet de **résultats** , vérifiez qu’au moins une instance est indiquée.</span><span class="sxs-lookup"><span data-stu-id="ac951-216">In the **Results** pane verify you see at least one instance listed.</span></span> <span data-ttu-id="ac951-217">D'autres instances d'exécutions précédentes peuvent également être présentes si une exception s'est produite pendant l'exécution.</span><span class="sxs-lookup"><span data-stu-id="ac951-217">There may be other instances from prior runs if an exception occurred while running.</span></span> <span data-ttu-id="ac951-218">Vous pouvez supprimer des lignes existantes en cliquant avec le bouton droit sur **System. Activities. DurableInstancing. instances** et en sélectionnant **modifier les 200 lignes du haut**, en appuyant sur le bouton **exécuter** , en sélectionnant toutes les lignes dans le volet des résultats et en sélectionnant **supprimer**.</span><span class="sxs-lookup"><span data-stu-id="ac951-218">You can delete existing rows by right clicking **System.Activities.DurableInstancing.Instances** and selecting **Edit Top 200 rows**, pressing the **Execute** button, selecting all rows in the results pane and selecting **delete**.</span></span>  <span data-ttu-id="ac951-219">Pour vous assurer que l'instance affichée dans la base de données est bien l'instance créée par votre application, vérifiez que la vue Instances est vide avant d'exécuter le client.</span><span class="sxs-lookup"><span data-stu-id="ac951-219">To verify the instance displayed in the database is the instance your application created, verify the instances view is empty prior to running the client.</span></span> <span data-ttu-id="ac951-220">Une fois que le client est en cours d'exécution, réexécutez la requête (Sélectionner les 1000 lignes du haut) et assurez-vous qu'une nouvelle instance a été ajoutée.</span><span class="sxs-lookup"><span data-stu-id="ac951-220">Once the client is running re-run the query (Select Top 1000 Rows) and verify a new instance has been added.</span></span>

7. <span data-ttu-id="ac951-221">Appuyez sur Entrée pour envoyer le message d'ajout d'élément au service de workflow.</span><span class="sxs-lookup"><span data-stu-id="ac951-221">Press enter to send the add item message to the workflow service.</span></span> <span data-ttu-id="ac951-222">Le client affiche le texte suivant :</span><span class="sxs-lookup"><span data-stu-id="ac951-222">The client will display the following text:</span></span>

    ```Output
    Sending add item messageService returned: Item added to orderPress any key to continue . . .
    ```

## <a name="see-also"></a><span data-ttu-id="ac951-223">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="ac951-223">See also</span></span>

- [<span data-ttu-id="ac951-224">Services de workflow</span><span class="sxs-lookup"><span data-stu-id="ac951-224">Workflow Services</span></span>](../../../../docs/framework/wcf/feature-details/workflow-services.md)
