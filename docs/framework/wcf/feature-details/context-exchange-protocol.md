---
title: Protocole d'échange de contexte
ms.date: 03/30/2017
ms.assetid: 3dfd38e0-ae52-491c-94f4-7a862b9843d4
ms.openlocfilehash: 00adb68d96f77ce0953811d13b5377ec4ed1e0ea
ms.sourcegitcommit: 7588136e355e10cbc2582f389c90c127363c02a5
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 03/12/2020
ms.locfileid: "79185262"
---
# <a name="context-exchange-protocol"></a><span data-ttu-id="6b398-102">Protocole d'échange de contexte</span><span class="sxs-lookup"><span data-stu-id="6b398-102">Context Exchange Protocol</span></span>
<span data-ttu-id="6b398-103">Cette section décrit le protocole d’échange de contexte introduit dans la version .NET Framework version 3.5 de la Windows Communication Foundation (WCF).</span><span class="sxs-lookup"><span data-stu-id="6b398-103">This section describes the context exchange protocol introduced in Windows Communication Foundation (WCF) release .NET Framework version 3.5.</span></span> <span data-ttu-id="6b398-104">Ce protocole permet au canal client d'accepter un contexte fourni par un service et de l'appliquer à toutes les demandes ultérieures à ce service envoyées sur la même instance de canal client.</span><span class="sxs-lookup"><span data-stu-id="6b398-104">This protocol allows the client channel to accept a context supplied by a service and apply it to all subsequent requests to that service sent over the same client channel instance.</span></span> <span data-ttu-id="6b398-105">L'implémentation du protocole d'échange de contexte peut utiliser l'un des deux mécanismes suivants pour propager le contexte entre le serveur et le client : les cookies HTTP ou un en-tête SOAP.</span><span class="sxs-lookup"><span data-stu-id="6b398-105">The implementation of the context exchange protocol can use one of the following two mechanisms to propagate the context between the server and the client: HTTP cookies or a SOAP header.</span></span>  
  
 <span data-ttu-id="6b398-106">Le protocole d'échange de contexte est implémenté dans une couche de canal personnalisée.</span><span class="sxs-lookup"><span data-stu-id="6b398-106">The context exchange protocol is implemented in a custom channel layer.</span></span> <span data-ttu-id="6b398-107">Le canal communique le contexte depuis et vers la couche d'application à l'aide d'une propriété <xref:System.ServiceModel.Channels.ContextMessageProperty>.</span><span class="sxs-lookup"><span data-stu-id="6b398-107">The channel communicates the context to and from the application layer using a <xref:System.ServiceModel.Channels.ContextMessageProperty> property.</span></span> <span data-ttu-id="6b398-108">Pour la transmission entre des points de terminaison, la valeur du contexte est soit sérialisée comme un en-tête SOAP à la couche du canal, soit convertie depuis ou vers des propriétés de message qui représentent une réponse et une demande HTTP.</span><span class="sxs-lookup"><span data-stu-id="6b398-108">For transmission between endpoints, the value of the context is either serialized as a SOAP header at the channel layer, or converted to or from the message properties that represent a HTTP request and response.</span></span> <span data-ttu-id="6b398-109">Dans le dernier cas, l'une des couches du canal sous-jacents convertie les propriétés de message de réponse et de demande HTTP vers et depuis des cookies HTTP, respectivement.</span><span class="sxs-lookup"><span data-stu-id="6b398-109">In the latter case, it is expected that one of the underlying channel layers converts the HTTP request and response message properties to and from HTTP cookies, respectively.</span></span> <span data-ttu-id="6b398-110">Le choix du mécanisme utilisé pour échanger le contexte s'effectue à l'aide de la propriété <xref:System.ServiceModel.Channels.ContextExchangeMechanism> sur le <xref:System.ServiceModel.Channels.ContextBindingElement>.</span><span class="sxs-lookup"><span data-stu-id="6b398-110">The choice of the mechanism used to exchange the context is done using the <xref:System.ServiceModel.Channels.ContextExchangeMechanism> property on the <xref:System.ServiceModel.Channels.ContextBindingElement>.</span></span> <span data-ttu-id="6b398-111">Les valeurs valides sont `HttpCookie` ou `SoapHeader`.</span><span class="sxs-lookup"><span data-stu-id="6b398-111">Valid values are `HttpCookie` or `SoapHeader`.</span></span>  
  
 <span data-ttu-id="6b398-112">Sur le client, une instance d'un canal peut fonctionner selon deux modes basés sur les paramètres de la propriété de canal, <xref:System.ServiceModel.Channels.IContextManager.Enabled%2A>.</span><span class="sxs-lookup"><span data-stu-id="6b398-112">On the client, an instance of a channel can operate in two modes based on the settings on the channel property, <xref:System.ServiceModel.Channels.IContextManager.Enabled%2A>.</span></span>  
  
## <a name="mode-1-channel-context-management"></a><span data-ttu-id="6b398-113">Mode 1 : gestion du contexte de canal</span><span class="sxs-lookup"><span data-stu-id="6b398-113">Mode 1: Channel Context Management</span></span>  
 <span data-ttu-id="6b398-114">Il s'agit du mode par défaut lorsque <xref:System.ServiceModel.Channels.IContextManager.Enabled%2A> a la valeur `true`.</span><span class="sxs-lookup"><span data-stu-id="6b398-114">This is the default mode where <xref:System.ServiceModel.Channels.IContextManager.Enabled%2A> is set to `true`.</span></span> <span data-ttu-id="6b398-115">Dans ce mode, le canal de contexte gère le contexte et met en cache celui-ci pendant sa durée de vie.</span><span class="sxs-lookup"><span data-stu-id="6b398-115">In this mode the context channel manages the context and caches the context during its lifetime.</span></span> <span data-ttu-id="6b398-116">Le contexte peut être récupéré à partir du canal par le biais de la propriété de canal `IContextManager` en appelant la méthode `GetContext`.</span><span class="sxs-lookup"><span data-stu-id="6b398-116">Context can be retrieved from the channel through channel property `IContextManager` by calling the `GetContext` method.</span></span> <span data-ttu-id="6b398-117">Le canal peut également être pré-initialisé avec un contexte spécifique avant d'être ouvert en appelant la méthode `SetContext` sur la propriété de canal.</span><span class="sxs-lookup"><span data-stu-id="6b398-117">The channel can also be pre-initialized with specific context before being opened by calling the `SetContext` method on the channel property.</span></span> <span data-ttu-id="6b398-118">Une fois le canal initialisé avec le contexte, celui-ci ne peut pas être réinitialisé.</span><span class="sxs-lookup"><span data-stu-id="6b398-118">Once the channel is initialized with context it cannot be reset.</span></span>  
  
 <span data-ttu-id="6b398-119">Les éléments suivants sont une liste d'invariants dans ce mode :</span><span class="sxs-lookup"><span data-stu-id="6b398-119">The following is a list of invariants in this mode:</span></span>  
  
- <span data-ttu-id="6b398-120">Toute tentative de réinitialisation du contexte à l'aide de `SetContext` après l'ouverture du canal lève une <xref:System.InvalidOperationException>.</span><span class="sxs-lookup"><span data-stu-id="6b398-120">Any attempt to reset the context using `SetContext` after the channel has been opened throws an <xref:System.InvalidOperationException>.</span></span>  
  
- <span data-ttu-id="6b398-121">Toute tentative d'envoi du contexte à l'aide du <xref:System.ServiceModel.Channels.ContextMessageProperty> dans un message sortant lève une <xref:System.InvalidOperationException>.</span><span class="sxs-lookup"><span data-stu-id="6b398-121">Any attempt to send context by using the <xref:System.ServiceModel.Channels.ContextMessageProperty> in an outgoing message throws an <xref:System.InvalidOperationException>.</span></span>  
  
- <span data-ttu-id="6b398-122">Si un message est reçu du serveur avec un contexte spécifique, lorsque le canal a déjà été initialisé avec un contexte spécifique, cela lève une <xref:System.ServiceModel.ProtocolException>.</span><span class="sxs-lookup"><span data-stu-id="6b398-122">If a message is received from server with a specific context, when the channel has already been initialized with a specific context, this results in a <xref:System.ServiceModel.ProtocolException>.</span></span>  
  
    > [!NOTE]
    > <span data-ttu-id="6b398-123">Il est recommandé de recevoir du serveur un contexte initial uniquement si le canal est ouvert sans qu'un contexte soit défini explicitement.</span><span class="sxs-lookup"><span data-stu-id="6b398-123">It is appropriate to receive an initial context from the server only if the channel is opened without any context set explicitly.</span></span>  
  
- <span data-ttu-id="6b398-124">Le <xref:System.ServiceModel.Channels.ContextMessageProperty> sur le message entrant est toujours null.</span><span class="sxs-lookup"><span data-stu-id="6b398-124">The <xref:System.ServiceModel.Channels.ContextMessageProperty> on incoming message is always null.</span></span>  
  
## <a name="mode-2-application-context-management"></a><span data-ttu-id="6b398-125">Mode 2 : gestion du contexte d'application</span><span class="sxs-lookup"><span data-stu-id="6b398-125">Mode 2: Application Context Management</span></span>  
 <span data-ttu-id="6b398-126">Il s'agit du mode dans lequel <xref:System.ServiceModel.Channels.IContextManager.Enabled%2A> a la valeur `false`.</span><span class="sxs-lookup"><span data-stu-id="6b398-126">This is the mode when <xref:System.ServiceModel.Channels.IContextManager.Enabled%2A> is set to `false`.</span></span> <span data-ttu-id="6b398-127">Dans ce mode, le canal de contexte ne gère pas de contexte.</span><span class="sxs-lookup"><span data-stu-id="6b398-127">In this mode the context channel does not manage context.</span></span> <span data-ttu-id="6b398-128">C'est la responsabilité de l'application de récupérer, de gérer et d'appliquer le contexte à l'aide de <xref:System.ServiceModel.Channels.ContextMessageProperty>.</span><span class="sxs-lookup"><span data-stu-id="6b398-128">It is the application's responsibility to retrieve, manage and apply context by using the <xref:System.ServiceModel.Channels.ContextMessageProperty>.</span></span> <span data-ttu-id="6b398-129">Toute tentative d'appel de `GetContext` ou de `SetContext` lève une <xref:System.InvalidOperationException>.</span><span class="sxs-lookup"><span data-stu-id="6b398-129">Any attempt to call `GetContext` or `SetContext` results in an <xref:System.InvalidOperationException>.</span></span>  
  
 <span data-ttu-id="6b398-130">Quel que soit le mode choisi, la fabrication de canal du client prend en charge les modèles d'échange de messages <xref:System.ServiceModel.Channels.IRequestChannel>, <xref:System.ServiceModel.Channels.IRequestSessionChannel> et <xref:System.ServiceModel.Channels.IDuplexSessionChannel>.</span><span class="sxs-lookup"><span data-stu-id="6b398-130">No matter which mode is chosen the client channel factory supports <xref:System.ServiceModel.Channels.IRequestChannel>, <xref:System.ServiceModel.Channels.IRequestSessionChannel>, and <xref:System.ServiceModel.Channels.IDuplexSessionChannel> message exchange patterns.</span></span>  
  
 <span data-ttu-id="6b398-131">Sur le service, une instance du canal est chargée de convertir le contexte fourni par le client sur les messages entrants en <xref:System.ServiceModel.Channels.ContextMessageProperty>.</span><span class="sxs-lookup"><span data-stu-id="6b398-131">On the service, an instance of the channel is responsible for converting the context supplied by the client on incoming messages to the <xref:System.ServiceModel.Channels.ContextMessageProperty>.</span></span> <span data-ttu-id="6b398-132">Puis la propriété de message peut être accédée par la couche d'application ou d'autres canaux plus loin dans la pile d'appel.</span><span class="sxs-lookup"><span data-stu-id="6b398-132">The message property can then be accessed by the application layer or other channels further up in the call stack.</span></span> <span data-ttu-id="6b398-133">Les canaux de service permettent aussi à la couche d'application de spécifier une nouvelle valeur de contexte à propager en retour au client en joignant un <xref:System.ServiceModel.Channels.ContextMessageProperty> au message de réponse.</span><span class="sxs-lookup"><span data-stu-id="6b398-133">The service channels also allow the application layer to specify a new context value to be propagated back to the client by attaching a <xref:System.ServiceModel.Channels.ContextMessageProperty> to the response message.</span></span> <span data-ttu-id="6b398-134">Cette propriété est convertie en en-tête SOAP ou cookie HTTP qui contient le contexte, ce qui dépend de la configuration de la liaison.</span><span class="sxs-lookup"><span data-stu-id="6b398-134">This property is converted to the SOAP header or HTTP cookie that contains the context, which depends on the configuration of the binding.</span></span> <span data-ttu-id="6b398-135">L'écouteur de canal de service prend en charge <xref:System.ServiceModel.Channels.IReplyChannel>, <xref:System.ServiceModel.Channels.IReplySessionChannel> et les modèles d'échange de messages <xref:System.ServiceModel.Channels.IReplySessionChannel>.</span><span class="sxs-lookup"><span data-stu-id="6b398-135">The service channel listener supports <xref:System.ServiceModel.Channels.IReplyChannel>, <xref:System.ServiceModel.Channels.IReplySessionChannel>, and <xref:System.ServiceModel.Channels.IReplySessionChannel> message exchange patterns.</span></span>  
  
 <span data-ttu-id="6b398-136">Le protocole d'échange de contexte introduit un nouvel en-tête SOAP `wsc:Context` pour représenter les informations de contexte lorsque les cookies HTTP ne sont pas utilisés pour propager le contexte.</span><span class="sxs-lookup"><span data-stu-id="6b398-136">The context exchange protocol introduces a new `wsc:Context` SOAP header to represent the context information when HTTP cookies are not used to propagate the context.</span></span> <span data-ttu-id="6b398-137">Le schéma d'en-tête de contexte permet un nombre illimité d'éléments enfants, chacun avec une clé de chaîne et un contenu de chaîne.</span><span class="sxs-lookup"><span data-stu-id="6b398-137">The context header schema allows for any number of child elements, each with a string key and string content.</span></span> <span data-ttu-id="6b398-138">Les éléments suivants sont un exemple d'un en-tête de contexte.</span><span class="sxs-lookup"><span data-stu-id="6b398-138">The following is an example of a context header.</span></span>  
  
 `<Context xmlns="http://schemas.microsoft.com/ws/2006/05/context">`  
  
 `<property name="myContext">context-2</property>`  
  
 `</Context>`  
  
 <span data-ttu-id="6b398-139">En mode `HttpCookie`, les cookies sont définis à l'aide de l'en-tête `SetCookie`.</span><span class="sxs-lookup"><span data-stu-id="6b398-139">When in `HttpCookie` mode, cookies are set using the `SetCookie` header.</span></span> <span data-ttu-id="6b398-140">Le nom du cookie est `WscContext`.</span><span class="sxs-lookup"><span data-stu-id="6b398-140">The cookie name is `WscContext`.</span></span> <span data-ttu-id="6b398-141">La valeur du cookie est l'encodage Base64 de l'en-tête `wsc:Context`.</span><span class="sxs-lookup"><span data-stu-id="6b398-141">The value of the cookie is the Base64 encoding of the `wsc:Context` header.</span></span> <span data-ttu-id="6b398-142">Cette valeur est mise entre guillemets.</span><span class="sxs-lookup"><span data-stu-id="6b398-142">This value is enclosed in quotes.</span></span>  
  
 <span data-ttu-id="6b398-143">La valeur du contexte doit être protégée des changements au cours du transit pour les mêmes raisons  que les en-têtes WS-Addressing sont protégés. L'en-tête est utilisé pour déterminer vers où distribuer la demande sur le service.</span><span class="sxs-lookup"><span data-stu-id="6b398-143">The value of the context must be protected from modification while in transit for the same reason WS-Addressing headers are protected – the header is used to determine where to dispatch the request to on the service.</span></span> <span data-ttu-id="6b398-144">L’en-tête `wsc:Context` est requis par conséquent pour être signé numériquement ou signé et chiffré au niveau du transport ou de SOAP lorsque la liaison offre une fonction de protection des messages.</span><span class="sxs-lookup"><span data-stu-id="6b398-144">The `wsc:Context` header is therefore required to be digitally signed or signed and encrypted at either the SOAP or transport level when the binding offers message protection capability.</span></span> <span data-ttu-id="6b398-145">Lorsque les cookies HTTP sont utilisés pour propager le contexte, ils doivent être protégés à l'aide de la sécurité de transport.</span><span class="sxs-lookup"><span data-stu-id="6b398-145">When HTTP cookies are used to propagate context, they should be protected using transport security.</span></span>  
  
 <span data-ttu-id="6b398-146">Les points de terminaison de service qui requièrent la prise en charge du protocole de l'échange de contexte peuvent l'indiquer explicitement dans la stratégie publiée.</span><span class="sxs-lookup"><span data-stu-id="6b398-146">Service endpoints that require support for the context exchange protocol can make it explicit in the published policy.</span></span> <span data-ttu-id="6b398-147">Deux nouvelles assertions de stratégie ont été introduites pour représenter la spécification de la prise en charge du protocole d'échange de contexte par le client au niveau de SOAP ou pour activer la prise en charge des cookies HTTP.</span><span class="sxs-lookup"><span data-stu-id="6b398-147">Two new policy assertions have been introduced to represent the requirement for the client to support the context exchange protocol at the SOAP level or to enable HTTP cookie support.</span></span> <span data-ttu-id="6b398-148">La génération de ces assertions dans la stratégie sur le service est contrôlée par la valeur de la propriété <xref:System.ServiceModel.Channels.ContextBindingElement.ContextExchangeMechanism%2A> de la façon suivante :</span><span class="sxs-lookup"><span data-stu-id="6b398-148">Generation of these assertions into the policy on the service is controlled by the value of the <xref:System.ServiceModel.Channels.ContextBindingElement.ContextExchangeMechanism%2A> property as follows:</span></span>  
  
- <span data-ttu-id="6b398-149">Pour <xref:System.ServiceModel.Channels.ContextExchangeMechanism.ContextSoapHeader>, l'assertion suivante est générée :</span><span class="sxs-lookup"><span data-stu-id="6b398-149">For <xref:System.ServiceModel.Channels.ContextExchangeMechanism.ContextSoapHeader>, the following assertion is generated:</span></span>  
  
    ```xml  
    <IncludeContext
    xmlns="http://schemas.microsoft.com/ws/2006/05/context"  
    protectionLevel="Sign" />  
    ```  
  
- <span data-ttu-id="6b398-150">Pour <xref:System.ServiceModel.Channels.ContextExchangeMechanism.HttpCookie>, l'assertion suivante est générée :</span><span class="sxs-lookup"><span data-stu-id="6b398-150">For <xref:System.ServiceModel.Channels.ContextExchangeMechanism.HttpCookie>, the following assertion is generated:</span></span>  
  
    ```xml  
    <HttpUseCookie xmlns="http://schemas.xmlsoap.org/soap/http"/>  
    ```  
  
## <a name="see-also"></a><span data-ttu-id="6b398-151">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="6b398-151">See also</span></span>

- [<span data-ttu-id="6b398-152">Guide de l'interopérabilité des protocoles de services Web</span><span class="sxs-lookup"><span data-stu-id="6b398-152">Web Services Protocols Interoperability Guide</span></span>](../../../../docs/framework/wcf/feature-details/web-services-protocols-interoperability-guide.md)
