---
title: Changements apportés à l’authentification NTLM pour HttpWebRequest dans la version 3.5 SP1
ms.date: 03/30/2017
ms.assetid: 8bf0b428-5a21-4299-8d6e-bf8251fd978a
ms.openlocfilehash: 388e6dc648e1fd68e24a852cb08de107f09f9c9f
ms.sourcegitcommit: 2701302a99cafbe0d86d53d540eb0fa7e9b46b36
ms.translationtype: HT
ms.contentlocale: fr-FR
ms.lasthandoff: 04/28/2019
ms.locfileid: "64754879"
---
# <a name="changes-to-ntlm-authentication-for-httpwebrequest-in-version-35-sp1"></a><span data-ttu-id="782e1-102">Changements apportés à l’authentification NTLM pour HttpWebRequest dans la version 3.5 SP1</span><span class="sxs-lookup"><span data-stu-id="782e1-102">Changes to NTLM authentication for HttpWebRequest in Version 3.5 SP1</span></span>

<span data-ttu-id="782e1-103">Des changements de sécurité apportés au .NET Framework version 3.5 SP1 et ultérieures affectent la manière dont l’intégration de l’authentification Windows est gérée par <xref:System.Net.HttpWebRequest>, <xref:System.Net.HttpListener>, <xref:System.Net.Security.NegotiateStream> et les classes associées dans l’espace de noms System.Net.</span><span class="sxs-lookup"><span data-stu-id="782e1-103">Security changes were made in .NET Framework version 3.5 SP1 and later that affect how integrated Windows authentication is handled by the <xref:System.Net.HttpWebRequest>, <xref:System.Net.HttpListener>, <xref:System.Net.Security.NegotiateStream>, and related classes in the System.Net namespace.</span></span> <span data-ttu-id="782e1-104">Ces changements peuvent affecter les applications qui utilisent ces classes pour effectuer des requêtes web et recevoir des réponses dans lesquelles l’authentification Windows intégrée en fonction de NTLM est utilisée.</span><span class="sxs-lookup"><span data-stu-id="782e1-104">These changes can affect applications that use these classes to make web requests and receive responses where integrated Windows authentication based on NTLM is used.</span></span> <span data-ttu-id="782e1-105">Ce changement peut avoir un impact sur les serveurs web et les applications clientes configurés pour utiliser l’authentification Windows intégrée.</span><span class="sxs-lookup"><span data-stu-id="782e1-105">This change can impact web servers and client applications that are configured to use integrated Windows authentication.</span></span>

## <a name="overview"></a><span data-ttu-id="782e1-106">Vue d'ensemble</span><span class="sxs-lookup"><span data-stu-id="782e1-106">Overview</span></span>

<span data-ttu-id="782e1-107">La conception de l’authentification Windows intégrée permet à certaines réponses d’informations d’identification d’être universelles, ce qui signifie qu’elles peuvent être réutilisées ou transférées.</span><span class="sxs-lookup"><span data-stu-id="782e1-107">The design of integrated Windows authentication allows for some credential responses to be universal, meaning they can be re-used or forwarded.</span></span> <span data-ttu-id="782e1-108">Si cette fonctionnalité de conception n’est pas nécessaire, les protocoles d’authentification doivent comporter des informations propres à la cible et au canal.</span><span class="sxs-lookup"><span data-stu-id="782e1-108">If this particular design feature is not needed, then the authentication protocols should carry target specific information as well as channel specific information.</span></span> <span data-ttu-id="782e1-109">Les services peuvent ensuite fournir une protection étendue pour garantir que les réponses d’informations d’identification contiennent des informations propres aux services, telles qu’un nom de principal du service (SPN).</span><span class="sxs-lookup"><span data-stu-id="782e1-109">Services can then provide extended protection to ensure that credential responses contain service specific information such as a Service Principal Name (SPN).</span></span> <span data-ttu-id="782e1-110">Avec ces informations dans les échanges d’informations d’identification, les services peuvent offrir une meilleure protection contre toute utilisation malveillante des réponses d’informations d’identification qui pourraient avoir été obtenues de manière incorrecte.</span><span class="sxs-lookup"><span data-stu-id="782e1-110">With this information in the credential exchanges, services are able to better protect against malicious use of credential responses that might have been improperly obtained.</span></span>

<span data-ttu-id="782e1-111">Plusieurs composants des espaces de noms <xref:System.Net> et <xref:System.Net.Security> effectuent l’authentification Windows intégrée pour le compte d’une application appelante.</span><span class="sxs-lookup"><span data-stu-id="782e1-111">Multiple components in the <xref:System.Net> and <xref:System.Net.Security> namespaces perform integrated Windows authentication on behalf of a calling application.</span></span> <span data-ttu-id="782e1-112">Cette section décrit les modifications apportées aux composants System.Net pour ajouter une protection étendue lors de l’utilisation de l’authentification Windows intégrée.</span><span class="sxs-lookup"><span data-stu-id="782e1-112">This section describes changes to System.Net components to add extended protection in their use of integrated Windows authentication.</span></span>

## <a name="changes"></a><span data-ttu-id="782e1-113">Modifications</span><span class="sxs-lookup"><span data-stu-id="782e1-113">Changes</span></span>

<span data-ttu-id="782e1-114">Le processus d’authentification NTLM utilisé avec l’authentification Windows intégrée inclut une stimulation émise par l’ordinateur de destination et renvoyée à l’ordinateur client.</span><span class="sxs-lookup"><span data-stu-id="782e1-114">The NTLM authentication process used with integrated Windows authentication includes a challenge issued by the destination computer and sent back to the client computer.</span></span> <span data-ttu-id="782e1-115">Quand un ordinateur reçoit une stimulation qu’il a lui-même généré, l’authentification échoue, sauf si la connexion est une connexion de retour de boucle (adresse IPv4 127.0.0.1, par exemple).</span><span class="sxs-lookup"><span data-stu-id="782e1-115">When a computer receives a challenge it generated itself, the authentication will fail unless the connection is a loop back connection (IPv4 address 127.0.0.1, for example).</span></span>

<span data-ttu-id="782e1-116">Quand vous accédez à un service en cours d’exécution sur un serveur web interne, il est courant d’accéder au service à l’aide d’une URL semblable à `http://contoso/service` ou `https://contoso/service`.</span><span class="sxs-lookup"><span data-stu-id="782e1-116">When accessing a service running on an internal Web server, it is common to access the service using a URL similar to `http://contoso/service` or `https://contoso/service`.</span></span> <span data-ttu-id="782e1-117">Le nom « contoso » est rarement le nom de l’ordinateur sur lequel le service est déployé.</span><span class="sxs-lookup"><span data-stu-id="782e1-117">The name "contoso" is often not the computer name of the computer on which the service is deployed.</span></span> <span data-ttu-id="782e1-118"><xref:System.Net> et les espaces de noms associés prennent en charge l’utilisation d’Active Directory, de DNS, de NetBIOS, du fichier hosts de l’ordinateur local (généralement WINDOWS\system32\drivers\etc\hosts) ou du fichier lmhosts de l’ordinateur local (généralement WINDOWS\system32\drivers\etc\lmhosts) pour résoudre les noms en adresses.</span><span class="sxs-lookup"><span data-stu-id="782e1-118">The <xref:System.Net> and related namespaces support using Active Directory, DNS, NetBIOS, the local computer's hosts file (typically WINDOWS\system32\drivers\etc\hosts, for example), or the local computer's lmhosts file (typically WINDOWS\system32\drivers\etc\lmhosts, for example) to resolve names to addresses.</span></span> <span data-ttu-id="782e1-119">Le nom « contoso » est résolu pour que les demandes envoyées à « contoso » soient envoyées à l’ordinateur serveur approprié.</span><span class="sxs-lookup"><span data-stu-id="782e1-119">The name "contoso" is resolved so that requests sent to "contoso" are sent to the appropriate server computer.</span></span>

<span data-ttu-id="782e1-120">En cas de configuration pour des déploiements à grande échelle, il est également courant d’attribuer un nom de serveur virtuel unique au déploiement, sans que les noms d’ordinateurs sous-jacents ne soient jamais utilisés par les applications clientes et les utilisateurs finaux.</span><span class="sxs-lookup"><span data-stu-id="782e1-120">When configured for large deployments, it is also common for a single virtual server name to be given to the deployment with the underlying machine names never used by client applications and end users.</span></span> <span data-ttu-id="782e1-121">Par exemple, vous pourriez appeler le serveur `www.contoso.com`, mais utiliser simplement « contoso » sur un réseau interne.</span><span class="sxs-lookup"><span data-stu-id="782e1-121">For example, you might call the server `www.contoso.com`, but on an internal network simply use "contoso".</span></span> <span data-ttu-id="782e1-122">Ce nom porte le nom d’en-tête d’hôte dans la requête web du client.</span><span class="sxs-lookup"><span data-stu-id="782e1-122">This name is called the Host header in the client web request.</span></span> <span data-ttu-id="782e1-123">Comme spécifié par le protocole HTTP, le champ d’en-tête de requête d’hôte spécifie le numéro de port et l’hôte Internet de la ressource demandée.</span><span class="sxs-lookup"><span data-stu-id="782e1-123">As specified by the HTTP protocol, the Host request-header field specifies the Internet host and port number of the resource being requested.</span></span> <span data-ttu-id="782e1-124">Ces informations sont obtenues à partir de l’URI d’origine donné par l’utilisateur ou la ressource de référence (généralement une URL HTTP).</span><span class="sxs-lookup"><span data-stu-id="782e1-124">This information is obtained from the original URI given by the user or referring resource (generally an HTTP URL).</span></span> <span data-ttu-id="782e1-125">Dans le .NET Framework version 4, ces informations peuvent aussi être définies par le client à l’aide de la nouvelle propriété <xref:System.Net.HttpWebRequest.Host%2A>.</span><span class="sxs-lookup"><span data-stu-id="782e1-125">On .NET Framework version 4, this information can also be set by the client using the new <xref:System.Net.HttpWebRequest.Host%2A> property.</span></span>

<span data-ttu-id="782e1-126">La classe <xref:System.Net.AuthenticationManager> contrôle les composants d’authentification gérés (« modules ») qui sont utilisés par les classes dérivés <xref:System.Net.WebRequest> et la classe <xref:System.Net.WebClient>.</span><span class="sxs-lookup"><span data-stu-id="782e1-126">The <xref:System.Net.AuthenticationManager> class controls the managed authentication components ("modules") that are used by <xref:System.Net.WebRequest> derivative classes and the <xref:System.Net.WebClient> class.</span></span> <span data-ttu-id="782e1-127">La classe <xref:System.Net.AuthenticationManager> fournit une propriété qui expose un objet <xref:System.Net.AuthenticationManager.CustomTargetNameDictionary%2A?displayProperty=nameWithType>, indexé par chaîne d’URI, pour que les applications puissent fournir une chaîne de nom de principal du service personnalisée à utiliser lors de l’authentification.</span><span class="sxs-lookup"><span data-stu-id="782e1-127">The <xref:System.Net.AuthenticationManager> class provides a property that exposes a <xref:System.Net.AuthenticationManager.CustomTargetNameDictionary%2A?displayProperty=nameWithType> object, indexed by URI string, for applications to supply a custom SPN string to be used during authentication.</span></span>

<span data-ttu-id="782e1-128">La version 3.5 SP1 spécifie désormais par défaut le nom d’hôte utilisé dans l’URL de requête dans le SPN lors de l’échange d’authentification NTLM (NT LAN Manager) quand la propriété <xref:System.Net.AuthenticationManager.CustomTargetNameDictionary%2A> n’est pas définie.</span><span class="sxs-lookup"><span data-stu-id="782e1-128">Version 3.5 SP1 now defaults to specifying the host name used in the request URL in the SPN in the NTLM (NT LAN Manager) authentication exchange when the <xref:System.Net.AuthenticationManager.CustomTargetNameDictionary%2A> property is not set.</span></span> <span data-ttu-id="782e1-129">Le nom d’hôte utilisé dans l’URL de requête peut être différent de l’en-tête d’hôte spécifié dans <xref:System.Net.HttpRequestHeader?displayProperty=nameWithType> dans la requête du client.</span><span class="sxs-lookup"><span data-stu-id="782e1-129">The host name used in the request URL may be different from the Host header specified in the <xref:System.Net.HttpRequestHeader?displayProperty=nameWithType> in the client request.</span></span> <span data-ttu-id="782e1-130">Le nom d’hôte utilisé dans l’URL de requête peut être différent du nom d’hôte réel du serveur, du nom d’ordinateur du serveur, de l’adresse IP de l’ordinateur ou de l’adresse de bouclage.</span><span class="sxs-lookup"><span data-stu-id="782e1-130">The host name used in the request URL may be different from the actual host name of the server, the machine name of the server, the computer's IP address, or the loopback address.</span></span> <span data-ttu-id="782e1-131">Dans ce cas, Windows fait échouer la requête d’authentification.</span><span class="sxs-lookup"><span data-stu-id="782e1-131">In these cases, Windows will fail the authentication request.</span></span> <span data-ttu-id="782e1-132">Pour résoudre ce problème, nous devons signaler à Windows que le nom d’hôte utilisé dans l’URL de requête dans la requête du client (par exemple « contoso ») est en fait un autre nom pour l’ordinateur local.</span><span class="sxs-lookup"><span data-stu-id="782e1-132">To address the issue, we need to notify Windows that the host name used in the request URL in the client request ("contoso", for example) is actually an alternate name for the local computer.</span></span>

<span data-ttu-id="782e1-133">Il existe plusieurs manières pour une application serveur de contourner cette modification.</span><span class="sxs-lookup"><span data-stu-id="782e1-133">There are several possible methods for a server application to work around this change.</span></span> <span data-ttu-id="782e1-134">L’approche recommandée consiste à mapper le nom d’hôte utilisé dans l’URL de requête à la clé `BackConnectionHostNames` dans le Registre sur le serveur.</span><span class="sxs-lookup"><span data-stu-id="782e1-134">The recommended approach is to map the host name used in the request URL to the `BackConnectionHostNames` key in the registry on the server.</span></span> <span data-ttu-id="782e1-135">La clé de Registre `BackConnectionHostNames` sert normalement à mapper un nom d’hôte à une adresse de bouclage.</span><span class="sxs-lookup"><span data-stu-id="782e1-135">The `BackConnectionHostNames` registry key is normally used to map a host name to a loopback address.</span></span> <span data-ttu-id="782e1-136">Les étapes sont listées ci-dessous.</span><span class="sxs-lookup"><span data-stu-id="782e1-136">The steps are listed below.</span></span>

<span data-ttu-id="782e1-137">Pour spécifier les noms d’hôtes qui sont mappés à l’adresse de bouclage et qui peuvent se connecter à des sites web sur un ordinateur local, effectuez les étapes suivantes :</span><span class="sxs-lookup"><span data-stu-id="782e1-137">To specify the host names that are mapped to the loopback address and can connect to Web sites on a local computer, follow these steps:</span></span>

1. <span data-ttu-id="782e1-138">Cliquez sur Démarrer, sur Exécuter, tapez regedit, puis cliquez sur OK.</span><span class="sxs-lookup"><span data-stu-id="782e1-138">Click Start, click Run, type regedit, and then click OK.</span></span>

2. <span data-ttu-id="782e1-139">Dans l’Éditeur du Registre, recherchez la clé de Registre suivante et cliquez dessus :</span><span class="sxs-lookup"><span data-stu-id="782e1-139">In Registry Editor, locate and then click the following registry key:</span></span>

    `HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa\MSV1_0`

3. <span data-ttu-id="782e1-140">Cliquez avec le bouton droit sur MSV1_0, pointez sur Nouveau, puis cliquez sur Valeur de chaînes multiples.</span><span class="sxs-lookup"><span data-stu-id="782e1-140">Right-click MSV1_0, point to New, and then click Multi-String Value.</span></span>

4. <span data-ttu-id="782e1-141">Tapez `BackConnectionHostNames`, puis appuyez sur Entrée.</span><span class="sxs-lookup"><span data-stu-id="782e1-141">Type `BackConnectionHostNames`, and then press ENTER.</span></span>

5. <span data-ttu-id="782e1-142">Cliquez avec le bouton droit sur `BackConnectionHostNames`, puis cliquez sur Modifier.</span><span class="sxs-lookup"><span data-stu-id="782e1-142">Right-click `BackConnectionHostNames`, and then click Modify.</span></span>

6. <span data-ttu-id="782e1-143">Dans la zone Données de la valeur, tapez les noms d’hôtes pour les sites (ceux utilisés dans l’URL de requête) qui sont sur l’ordinateur local, puis cliquez sur OK.</span><span class="sxs-lookup"><span data-stu-id="782e1-143">In the Value data box, type the host name or the host names for the sites (the host name used in the request URL) that are on the local computer, and then click OK.</span></span>

7. <span data-ttu-id="782e1-144">Quittez l’Éditeur du Registre, puis redémarrez le service IISAdmin et exécutez IISReset.</span><span class="sxs-lookup"><span data-stu-id="782e1-144">Quit Registry Editor, and then restart the IISAdmin service and run IISReset.</span></span>

<span data-ttu-id="782e1-145">Une solution de contournement moins sécurisée consiste à désactiver le contrôle de retour de boucle, comme décrit dans <https://support.microsoft.com/kb/896861>.</span><span class="sxs-lookup"><span data-stu-id="782e1-145">A less secure work around is to disable the loop back check, as described in <https://support.microsoft.com/kb/896861>.</span></span> <span data-ttu-id="782e1-146">Cette opération désactive la protection contre les attaques par réflexion.</span><span class="sxs-lookup"><span data-stu-id="782e1-146">This disables the protection against reflection attacks.</span></span> <span data-ttu-id="782e1-147">Il est donc préférable de limiter l’ensemble des autres noms aux seuls noms qui seront utilisés par l’ordinateur.</span><span class="sxs-lookup"><span data-stu-id="782e1-147">So it is better to constrain the set of alternate names to only those you expect the machine to actually use.</span></span>

## <a name="see-also"></a><span data-ttu-id="782e1-148">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="782e1-148">See also</span></span>

- <xref:System.Net.AuthenticationManager.CustomTargetNameDictionary%2A?displayProperty=nameWithType>
- <xref:System.Net.HttpRequestHeader?displayProperty=nameWithType>
- <xref:System.Net.HttpWebRequest.Host%2A?displayProperty=nameWithType>
