---
title: 'Procédure pas à pas : émission de code dans des scénarios de confiance partielle'
description: Consultez Comment émettre du code dans des scénarios de confiance partielle. L’émission de réflexion utilise les mêmes API, mais certaines fonctionnalités nécessitent des autorisations spéciales dans du code de confiance partielle.
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- reflection emit, anonymously hosted dynamic methods
- partial trust, reflection
- partial trust, emitting dynamic methods
- reflection emit, partial trust scenarios
- anonymously hosted dynamic methods [.NET Framework]
- emitting dynamic assemblies,partial trust scenarios
- reflection emit, dynamic methods
- dynamic methods
ms.assetid: c45be261-2a9d-4c4e-9bd6-27f0931b7d25
ms.openlocfilehash: 70adb3ce67b45459b18741948092a912f6173731
ms.sourcegitcommit: 3d84eac0818099c9949035feb96bbe0346358504
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 07/21/2020
ms.locfileid: "86865188"
---
# <a name="walkthrough-emitting-code-in-partial-trust-scenarios"></a><span data-ttu-id="7d998-104">Procédure pas à pas : émission de code dans des scénarios de confiance partielle</span><span class="sxs-lookup"><span data-stu-id="7d998-104">Walkthrough: Emitting Code in Partial Trust Scenarios</span></span>

<span data-ttu-id="7d998-105">L’émission de réflexion utilise le même ensemble d’API en confiance totale ou partielle, mais certaines fonctionnalités nécessitent des autorisations spéciales dans le code avec confiance partielle.</span><span class="sxs-lookup"><span data-stu-id="7d998-105">Reflection emit uses the same API set in full or partial trust, but some features require special permissions in partially trusted code.</span></span> <span data-ttu-id="7d998-106">En outre, l’émission de réflexion a une fonctionnalité, des méthodes dynamiques hébergées anonymement, qui est conçue pour être utilisée avec une confiance partielle et par les assemblys transparents de sécurité.</span><span class="sxs-lookup"><span data-stu-id="7d998-106">In addition, reflection emit has a feature, anonymously hosted dynamic methods, that is designed to be used with partial trust and by security-transparent assemblies.</span></span>

> [!NOTE]
> <span data-ttu-id="7d998-107">Avant .NET Framework 3.5, l’émission de code nécessitait <xref:System.Security.Permissions.ReflectionPermission> avec l’indicateur <xref:System.Security.Permissions.ReflectionPermissionFlag.ReflectionEmit?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="7d998-107">Before .NET Framework 3.5, emitting code required <xref:System.Security.Permissions.ReflectionPermission> with the <xref:System.Security.Permissions.ReflectionPermissionFlag.ReflectionEmit?displayProperty=nameWithType> flag.</span></span> <span data-ttu-id="7d998-108">Par défaut, cette autorisation est comprise dans les jeux d’autorisations nommés `FullTrust` et `Intranet`, mais pas dans le jeu d’autorisations `Internet`.</span><span class="sxs-lookup"><span data-stu-id="7d998-108">This permission is included by default in the `FullTrust` and `Intranet` named permission sets, but not in the `Internet` permission set.</span></span> <span data-ttu-id="7d998-109">Par conséquent, une bibliothèque pourrait être utilisée avec une confiance partielle seulement si elle avait l’attribut <xref:System.Security.SecurityCriticalAttribute> et exécutait aussi une méthode <xref:System.Security.PermissionSet.Assert%2A> pour <xref:System.Security.Permissions.ReflectionPermissionFlag.ReflectionEmit>.</span><span class="sxs-lookup"><span data-stu-id="7d998-109">Therefore, a library could be used from partial trust only if it had the <xref:System.Security.SecurityCriticalAttribute> attribute and also executed an <xref:System.Security.PermissionSet.Assert%2A> method for <xref:System.Security.Permissions.ReflectionPermissionFlag.ReflectionEmit>.</span></span> <span data-ttu-id="7d998-110">Ces bibliothèques nécessitent une revue minutieuse de la sécurité, car les erreurs de codage peuvent entraîner des failles de sécurité.</span><span class="sxs-lookup"><span data-stu-id="7d998-110">Such libraries require careful security review because coding errors could result in security holes.</span></span> <span data-ttu-id="7d998-111">.NET Framework 3.5 permet au code d’être émis dans des scénarios de confiance partielle sans émettre de demandes de sécurité, car la génération de code n’est pas fondamentalement une opération nécessitant des privilèges.</span><span class="sxs-lookup"><span data-stu-id="7d998-111">The .NET Framework 3.5 allows code to be emitted in partial trust scenarios without issuing any security demands, because generating code is not inherently a privileged operation.</span></span> <span data-ttu-id="7d998-112">Autrement dit, le code généré n'a pas plus d'autorisations que l'assembly qui l'émet.</span><span class="sxs-lookup"><span data-stu-id="7d998-112">That is, the generated code has no more permissions than the assembly that emits it.</span></span> <span data-ttu-id="7d998-113">Ainsi, les bibliothèques qui émettent du code sont transparentes de sécurité et il devient inutile de déclarer <xref:System.Security.Permissions.ReflectionPermissionFlag.ReflectionEmit> puisque l’écriture d’une bibliothèque sécurisée ne nécessite pas une révision aussi approfondie de la sécurité.</span><span class="sxs-lookup"><span data-stu-id="7d998-113">This enables libraries that emit code to be security-transparent and removes the need to assert <xref:System.Security.Permissions.ReflectionPermissionFlag.ReflectionEmit>, so that writing a secure library does not require such a thorough security review.</span></span>

<span data-ttu-id="7d998-114">Cette procédure pas à pas décrit les tâches suivantes :</span><span class="sxs-lookup"><span data-stu-id="7d998-114">This walkthrough illustrates the following tasks:</span></span>

- <span data-ttu-id="7d998-115">[Configuration d’un bac à sable (sandbox) simple pour le test de code partiellement fiable](#Setting_up).</span><span class="sxs-lookup"><span data-stu-id="7d998-115">[Setting up a simple sandbox for testing partially trusted code](#Setting_up).</span></span>

  > [!IMPORTANT]
  > <span data-ttu-id="7d998-116">Il s’agit d’un moyen simple de faire des essais avec du code partiellement fiable.</span><span class="sxs-lookup"><span data-stu-id="7d998-116">This is a simple way to experiment with code in partial trust.</span></span> <span data-ttu-id="7d998-117">Pour exécuter du code qui provient d’emplacements non approuvés, consultez [Guide pratique pour exécuter du code d’un niveau de confiance partiel dans un bac à sable (sandbox)](../misc/how-to-run-partially-trusted-code-in-a-sandbox.md).</span><span class="sxs-lookup"><span data-stu-id="7d998-117">To run code that actually comes from untrusted locations, see [How to: Run Partially Trusted Code in a Sandbox](../misc/how-to-run-partially-trusted-code-in-a-sandbox.md).</span></span>

- <span data-ttu-id="7d998-118">[Exécution de code dans des domaines d’application partiellement fiables](#Running_code).</span><span class="sxs-lookup"><span data-stu-id="7d998-118">[Running code in partially trusted application domains](#Running_code).</span></span>

- <span data-ttu-id="7d998-119">[Utilisation de méthodes dynamiques hébergées anonymement pour émettre et exécuter du code en confiance partielle](#Using_methods).</span><span class="sxs-lookup"><span data-stu-id="7d998-119">[Using anonymously hosted dynamic methods to emit and execute code in partial trust](#Using_methods).</span></span>

<span data-ttu-id="7d998-120">Pour plus d’informations sur l’émission de code dans des scénarios de confiance partielle, consultez [Problèmes de sécurité dans l’émission de réflexion](security-issues-in-reflection-emit.md).</span><span class="sxs-lookup"><span data-stu-id="7d998-120">For more information about emitting code in partial trust scenarios, see [Security Issues in Reflection Emit](security-issues-in-reflection-emit.md).</span></span>

<span data-ttu-id="7d998-121">Pour obtenir une liste complète du code utilisé dans ces procédures, consultez la [section Exemple](#Example) à la fin de cette procédure pas à pas.</span><span class="sxs-lookup"><span data-stu-id="7d998-121">For a complete listing of the code shown in these procedures, see the [Example section](#Example) at the end of this walkthrough.</span></span>

<a name="Setting_up"></a>

## <a name="setting-up-partially-trusted-locations"></a><span data-ttu-id="7d998-122">Configuration des emplacements partiellement fiables</span><span class="sxs-lookup"><span data-stu-id="7d998-122">Setting up Partially Trusted Locations</span></span>

<span data-ttu-id="7d998-123">Les deux procédures suivantes montrent comment configurer des emplacements à partir desquels vous pouvez tester du code avec une confiance partielle.</span><span class="sxs-lookup"><span data-stu-id="7d998-123">The following two procedures show how to set up locations from which you can test code with partial trust.</span></span>

- <span data-ttu-id="7d998-124">La première procédure montre comment créer un domaine d’application sandbox dans lequel le code a des autorisations Internet.</span><span class="sxs-lookup"><span data-stu-id="7d998-124">The first procedure shows how to create a sandboxed application domain in which code is granted Internet permissions.</span></span>

- <span data-ttu-id="7d998-125">La seconde procédure montre comment ajouter <xref:System.Security.Permissions.ReflectionPermission> avec l’indicateur <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> à un domaine d’application partiellement fiable pour activer l’accès aux données privées dans des assemblys d’une confiance inférieure ou égale.</span><span class="sxs-lookup"><span data-stu-id="7d998-125">The second procedure shows how to add <xref:System.Security.Permissions.ReflectionPermission> with the <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> flag to a partially trusted application domain, to enable access to private data in assemblies of equal or lesser trust.</span></span>

### <a name="creating-sandboxed-application-domains"></a><span data-ttu-id="7d998-126">Création de domaines d’application sandbox</span><span class="sxs-lookup"><span data-stu-id="7d998-126">Creating Sandboxed Application Domains</span></span>

<span data-ttu-id="7d998-127">Pour créer un domaine d’application dans lequel vos assemblys s’exécutent avec une confiance partielle, vous devez spécifier le jeu d’autorisations à accorder aux assemblys en utilisant la surcharge de la méthode <xref:System.AppDomain.CreateDomain%28System.String%2CSystem.Security.Policy.Evidence%2CSystem.AppDomainSetup%2CSystem.Security.PermissionSet%2CSystem.Security.Policy.StrongName%5B%5D%29?displayProperty=nameWithType> pour créer le domaine d’application.</span><span class="sxs-lookup"><span data-stu-id="7d998-127">To create an application domain in which your assemblies run with partial trust, you must specify the set of permissions to be granted to the assemblies by using the <xref:System.AppDomain.CreateDomain%28System.String%2CSystem.Security.Policy.Evidence%2CSystem.AppDomainSetup%2CSystem.Security.PermissionSet%2CSystem.Security.Policy.StrongName%5B%5D%29?displayProperty=nameWithType> method overload to create the application domain.</span></span> <span data-ttu-id="7d998-128">Pour spécifier le jeu d’autorisations, le plus simple est de récupérer un jeu d’autorisations nommé auprès de la stratégie de sécurité.</span><span class="sxs-lookup"><span data-stu-id="7d998-128">The easiest way to specify the grant set is to retrieve a named permission set from security policy.</span></span>

<span data-ttu-id="7d998-129">La procédure suivante crée un domaine d’application sandbox qui exécute votre code avec une confiance partielle pour tester des scénarios dans lesquels le code émis peut accéder seulement à des membres publics de types public.</span><span class="sxs-lookup"><span data-stu-id="7d998-129">The following procedure creates a sandboxed application domain that runs your code with partial trust, to test scenarios in which emitted code can access only public members of public types.</span></span> <span data-ttu-id="7d998-130">La procédure qui vient après montre comment ajouter <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess> pour tester des scénarios dans lesquels le code émis peut accéder aux types et aux membres non publics dans les assemblys bénéficiant d’autorisations inférieures ou égales.</span><span class="sxs-lookup"><span data-stu-id="7d998-130">A subsequent procedure shows how to add <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess>, to test scenarios in which emitted code can access nonpublic types and members in assemblies that are granted equal or lesser permissions.</span></span>

#### <a name="to-create-an-application-domain-with-partial-trust"></a><span data-ttu-id="7d998-131">Pour créer un domaine d’application avec une confiance partielle</span><span class="sxs-lookup"><span data-stu-id="7d998-131">To create an application domain with partial trust</span></span>

1. <span data-ttu-id="7d998-132">Créez un jeu d’autorisations à accorder aux assemblys dans le domaine d’application sandbox.</span><span class="sxs-lookup"><span data-stu-id="7d998-132">Create a permission set to grant to the assemblies in the sandboxed application domain.</span></span> <span data-ttu-id="7d998-133">Dans ce cas, le jeu d’autorisations de la zone Internet est utilisé.</span><span class="sxs-lookup"><span data-stu-id="7d998-133">In this case, the permission set of the Internet zone is used.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#2](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#2)]
    [!code-vb[HowToEmitCodeInPartialTrust#2](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#2)]

2. <span data-ttu-id="7d998-134">Créez un objet <xref:System.AppDomainSetup> pour initialiser le domaine d’application avec un chemin d’application.</span><span class="sxs-lookup"><span data-stu-id="7d998-134">Create an <xref:System.AppDomainSetup> object to initialize the application domain with an application path.</span></span>

    > [!IMPORTANT]
    > <span data-ttu-id="7d998-135">Pour simplifier, cet exemple de code utilise le dossier actif.</span><span class="sxs-lookup"><span data-stu-id="7d998-135">For simplicity, this code example uses the current folder.</span></span> <span data-ttu-id="7d998-136">Pour exécuter du code qui provient d’Internet, utilisez un dossier distinct pour le code non fiable, comme décrit dans [Guide pratique pour exécuter du code d’un niveau de confiance partiel dans un bac à sable (sandbox)](../misc/how-to-run-partially-trusted-code-in-a-sandbox.md).</span><span class="sxs-lookup"><span data-stu-id="7d998-136">To run code that actually comes from the Internet, use a separate folder for the untrusted code, as described in [How to: Run Partially Trusted Code in a Sandbox](../misc/how-to-run-partially-trusted-code-in-a-sandbox.md).</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#3](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#3)]
    [!code-vb[HowToEmitCodeInPartialTrust#3](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#3)]

3. <span data-ttu-id="7d998-137">Créez le domaine d’application en spécifiant les informations de configuration du domaine d’application et le jeu d’autorisations accordé pour tous les assemblys qui s’exécutent dans le domaine d’application.</span><span class="sxs-lookup"><span data-stu-id="7d998-137">Create the application domain, specifying the application domain setup information and the grant set for all assemblies that execute in the application domain.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#5](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#5)]
    [!code-vb[HowToEmitCodeInPartialTrust#5](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#5)]

    <span data-ttu-id="7d998-138">Le dernier paramètre de la surcharge de la méthode <xref:System.AppDomain.CreateDomain%28System.String%2CSystem.Security.Policy.Evidence%2CSystem.AppDomainSetup%2CSystem.Security.PermissionSet%2CSystem.Security.Policy.StrongName%5B%5D%29?displayProperty=nameWithType> vous permet de spécifier un ensemble d’assemblys auxquels une confiance totale est accordée, à la place du jeu d’autorisations du domaine d’application.</span><span class="sxs-lookup"><span data-stu-id="7d998-138">The last parameter of the <xref:System.AppDomain.CreateDomain%28System.String%2CSystem.Security.Policy.Evidence%2CSystem.AppDomainSetup%2CSystem.Security.PermissionSet%2CSystem.Security.Policy.StrongName%5B%5D%29?displayProperty=nameWithType> method overload enables you to specify a set of assemblies that are to be granted full trust, instead of the grant set of the application domain.</span></span> <span data-ttu-id="7d998-139">Il n’est pas nécessaire de spécifier les assemblys .NET Framework utilisés par votre application, car ces assemblys se trouvent dans le Global Assembly Cache.</span><span class="sxs-lookup"><span data-stu-id="7d998-139">You do not have to specify the .NET Framework assemblies that your application uses, because those assemblies are in the global assembly cache.</span></span> <span data-ttu-id="7d998-140">Les assemblys présents dans le Global Assembly Cache sont toujours totalement fiables.</span><span class="sxs-lookup"><span data-stu-id="7d998-140">Assemblies in the global assembly cache are always fully trusted.</span></span> <span data-ttu-id="7d998-141">Vous pouvez utiliser ce paramètre pour spécifier des assemblys avec nom fort qui ne sont pas dans le Global Assembly Cache.</span><span class="sxs-lookup"><span data-stu-id="7d998-141">You can use this parameter to specify strong-named assemblies that are not in the global assembly cache.</span></span>

### <a name="adding-restrictedmemberaccess-to-sandboxed-domains"></a><span data-ttu-id="7d998-142">Ajout de RestrictedMemberAccess à des domaines sandbox</span><span class="sxs-lookup"><span data-stu-id="7d998-142">Adding RestrictedMemberAccess to Sandboxed Domains</span></span>

<span data-ttu-id="7d998-143">Les applications hôtes peuvent autoriser les méthodes dynamiques hébergées anonymement à accéder aux données privées dans les assemblys qui ont des niveaux de confiance inférieurs ou égaux au niveau de confiance de l’assembly qui émet le code.</span><span class="sxs-lookup"><span data-stu-id="7d998-143">Host applications can allow anonymously hosted dynamic methods to have access to private data in assemblies that have trust levels equal to or less than the trust level of the assembly that emits the code.</span></span> <span data-ttu-id="7d998-144">Pour permettre cette possibilité limitée d’ignorer les contrôles de visibilité juste-à-temps (JIT), l’application hôte ajoute un objet <xref:System.Security.Permissions.ReflectionPermission> avec l’indicateur <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> (RMA) au jeu d’autorisations.</span><span class="sxs-lookup"><span data-stu-id="7d998-144">To enable this restricted ability to skip just-in-time (JIT) visibility checks, the host application adds a <xref:System.Security.Permissions.ReflectionPermission> object with the <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> (RMA) flag to the grant set.</span></span>

<span data-ttu-id="7d998-145">Par exemple, un hôte peut accorder des autorisations Internet plus RMA à des applications Internet, pour qu’une application Internet puisse émettre du code qui accède aux données privées dans ses propres assemblys.</span><span class="sxs-lookup"><span data-stu-id="7d998-145">For example, a host might grant Internet applications Internet permissions plus RMA, so that an Internet application can emit code that accesses private data in its own assemblies.</span></span> <span data-ttu-id="7d998-146">Étant donné que l’accès est limité aux assemblys de confiance inférieure ou égale, une application Internet ne peut pas accéder aux membres des assemblys entièrement fiables, comme les assemblys .NET Framework.</span><span class="sxs-lookup"><span data-stu-id="7d998-146">Because the access is limited to assemblies of equal or lesser trust, an Internet application cannot access members of fully trusted assemblies such as .NET Framework assemblies.</span></span>

> [!NOTE]
> <span data-ttu-id="7d998-147">Pour empêcher une élévation de privilèges, les informations de pile de l’assembly émetteur sont incluses lors de la construction des méthodes dynamiques hébergées anonymement.</span><span class="sxs-lookup"><span data-stu-id="7d998-147">To prevent elevation of privilege, stack information for the emitting assembly is included when anonymously hosted dynamic methods are constructed.</span></span> <span data-ttu-id="7d998-148">Quand la méthode est appelée, les informations de pile sont vérifiées.</span><span class="sxs-lookup"><span data-stu-id="7d998-148">When the method is invoked, the stack information is checked.</span></span> <span data-ttu-id="7d998-149">Par conséquent, une méthode dynamique hébergée anonymement qui est appelée à partir d’un code totalement fiable est toujours limitée au niveau de confiance de l’assembly émetteur.</span><span class="sxs-lookup"><span data-stu-id="7d998-149">Thus, an anonymously hosted dynamic method that is invoked from fully trusted code is still limited to the trust level of the emitting assembly.</span></span>

#### <a name="to-create-an-application-domain-with-partial-trust-plus-rma"></a><span data-ttu-id="7d998-150">Pour créer un domaine d’application avec une confiance partielle plus RMA</span><span class="sxs-lookup"><span data-stu-id="7d998-150">To create an application domain with partial trust plus RMA</span></span>

1. <span data-ttu-id="7d998-151">Créez un objet <xref:System.Security.Permissions.ReflectionPermission> avec l’indicateur <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess> (RMA) et utilisez la méthode <xref:System.Security.PermissionSet.SetPermission%2A?displayProperty=nameWithType> pour ajouter l’autorisation au jeu d’autorisations.</span><span class="sxs-lookup"><span data-stu-id="7d998-151">Create a new <xref:System.Security.Permissions.ReflectionPermission> object with the <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess> (RMA) flag, and use the <xref:System.Security.PermissionSet.SetPermission%2A?displayProperty=nameWithType> method to add the permission to the grant set.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#7](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#7)]
    [!code-vb[HowToEmitCodeInPartialTrust#7](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#7)]

    <span data-ttu-id="7d998-152">La méthode <xref:System.Security.PermissionSet.AddPermission%2A> ajoute l’autorisation au jeu d’autorisations si elle n’y est pas déjà.</span><span class="sxs-lookup"><span data-stu-id="7d998-152">The <xref:System.Security.PermissionSet.AddPermission%2A> method adds the permission to the grant set if it is not already included.</span></span> <span data-ttu-id="7d998-153">Si l’autorisation est déjà dans le jeu d’autorisations, les indicateurs spécifiés sont ajoutés à l’autorisation existante.</span><span class="sxs-lookup"><span data-stu-id="7d998-153">If the permission is already included in the grant set, the specified flags are added to the existing permission.</span></span>

    > [!NOTE]
    > <span data-ttu-id="7d998-154">RMA est une fonctionnalité des méthodes dynamiques hébergées anonymement.</span><span class="sxs-lookup"><span data-stu-id="7d998-154">RMA is a feature of anonymously hosted dynamic methods.</span></span> <span data-ttu-id="7d998-155">Quand des méthodes dynamiques ordinaires ignorent les contrôles de visibilité JIT, le code émis nécessite une confiance totale.</span><span class="sxs-lookup"><span data-stu-id="7d998-155">When ordinary dynamic methods skip JIT visibility checks, the emitted code requires full trust.</span></span>

2. <span data-ttu-id="7d998-156">Créez le domaine d’application en spécifiant les informations de configuration du domaine d’application et le jeu d’autorisations.</span><span class="sxs-lookup"><span data-stu-id="7d998-156">Create the application domain, specifying the application domain setup information and the grant set.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#8](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#8)]
    [!code-vb[HowToEmitCodeInPartialTrust#8](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#8)]

<a name="Running_code"></a>

## <a name="running-code-in-sandboxed-application-domains"></a><span data-ttu-id="7d998-157">Exécution de code dans des domaines d’application sandbox</span><span class="sxs-lookup"><span data-stu-id="7d998-157">Running Code in Sandboxed Application Domains</span></span>

<span data-ttu-id="7d998-158">La procédure suivante explique comment définir une classe en utilisant des méthodes qui peuvent être exécutées dans un domaine d’application, comment créer une instance de la classe dans le domaine et comment exécuter ses méthodes.</span><span class="sxs-lookup"><span data-stu-id="7d998-158">The following procedure explains how to define a class by using methods that can be executed in an application domain, how to create an instance of the class in the domain, and how to execute its methods.</span></span>

#### <a name="to-define-and-execute-a-method-in-an-application-domain"></a><span data-ttu-id="7d998-159">Pour définir et exécuter une méthode dans un domaine d’application</span><span class="sxs-lookup"><span data-stu-id="7d998-159">To define and execute a method in an application domain</span></span>

1. <span data-ttu-id="7d998-160">Définissez une classe qui dérive de <xref:System.MarshalByRefObject>.</span><span class="sxs-lookup"><span data-stu-id="7d998-160">Define a class that derives from <xref:System.MarshalByRefObject>.</span></span> <span data-ttu-id="7d998-161">Cette opération vous permet de créer des instances de la classe dans d’autres domaines d’application et d’effectuer des appels de méthode à travers les limites du domaine d’application.</span><span class="sxs-lookup"><span data-stu-id="7d998-161">This enables you to create instances of the class in other application domains and to make method calls across application domain boundaries.</span></span> <span data-ttu-id="7d998-162">Dans cet exemple, la classe est nommée `Worker`.</span><span class="sxs-lookup"><span data-stu-id="7d998-162">The class in this example is named `Worker`.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#10](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#10)]
    [!code-vb[HowToEmitCodeInPartialTrust#10](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#10)]

2. <span data-ttu-id="7d998-163">Définissez une méthode publique qui contient le code que vous voulez exécuter.</span><span class="sxs-lookup"><span data-stu-id="7d998-163">Define a public method that contains the code you want to execute.</span></span> <span data-ttu-id="7d998-164">Dans cet exemple, le code émet une méthode dynamique simple, crée un délégué pour exécuter la méthode et appelle le délégué.</span><span class="sxs-lookup"><span data-stu-id="7d998-164">In this example, the code emits a simple dynamic method, creates a delegate to execute the method, and invokes the delegate.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#11](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#11)]
    [!code-vb[HowToEmitCodeInPartialTrust#11](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#11)]

3. <span data-ttu-id="7d998-165">Dans votre programme principal, obtenez le nom d’affichage de votre assembly.</span><span class="sxs-lookup"><span data-stu-id="7d998-165">In your main program, get the display name of your assembly.</span></span> <span data-ttu-id="7d998-166">Ce nom est utilisé quand vous créez des instances de la classe `Worker` dans le domaine d’application sandbox.</span><span class="sxs-lookup"><span data-stu-id="7d998-166">This name is used when you create instances of the `Worker` class in the sandboxed application domain.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#14](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#14)]
    [!code-vb[HowToEmitCodeInPartialTrust#14](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#14)]

4. <span data-ttu-id="7d998-167">Dans votre programme principal, créez un domaine d’application sandbox, comme décrit dans [la première procédure](#Setting_up) de cet article.</span><span class="sxs-lookup"><span data-stu-id="7d998-167">In your main program, create a sandboxed application domain, as described in [the first procedure](#Setting_up) in this walkthrough.</span></span> <span data-ttu-id="7d998-168">Vous ne devez pas ajouter des autorisations au jeu d’autorisations `Internet`, car la méthode `SimpleEmitDemo` utilise uniquement des méthodes publiques.</span><span class="sxs-lookup"><span data-stu-id="7d998-168">You do not have to add any permissions to the `Internet` permission set, because the `SimpleEmitDemo` method uses only public methods.</span></span>

5. <span data-ttu-id="7d998-169">Dans votre programme principal, créez une instance de la classe `Worker` dans le domaine d’application sandbox.</span><span class="sxs-lookup"><span data-stu-id="7d998-169">In your main program, create an instance of the `Worker` class in the sandboxed application domain.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#12](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#12)]
    [!code-vb[HowToEmitCodeInPartialTrust#12](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#12)]

    <span data-ttu-id="7d998-170">La méthode <xref:System.AppDomain.CreateInstanceAndUnwrap%2A> crée l’objet dans le domaine d’application cible et retourne un proxy qui peut être utilisé pour appeler les propriétés et les méthodes de l’objet.</span><span class="sxs-lookup"><span data-stu-id="7d998-170">The <xref:System.AppDomain.CreateInstanceAndUnwrap%2A> method creates the object in the target application domain and returns a proxy that can be used to call the properties and methods of the object.</span></span>

    > [!NOTE]
    > <span data-ttu-id="7d998-171">Si vous utilisez ce code dans Visual Studio, vous devez changer le nom de la classe pour y inclure l’espace de noms.</span><span class="sxs-lookup"><span data-stu-id="7d998-171">If you use this code in Visual Studio, you must change the name of the class to include the namespace.</span></span> <span data-ttu-id="7d998-172">Par défaut, l’espace de noms est le nom du projet.</span><span class="sxs-lookup"><span data-stu-id="7d998-172">By default, the namespace is the name of the project.</span></span> <span data-ttu-id="7d998-173">Par exemple, si le projet est « PartialTrust », le nom de la classe doit être « PartialTrust.Worker ».</span><span class="sxs-lookup"><span data-stu-id="7d998-173">For example, if the project is "PartialTrust", the class name must be "PartialTrust.Worker".</span></span>

6. <span data-ttu-id="7d998-174">Ajoutez le code pour appeler la méthode `SimpleEmitDemo`.</span><span class="sxs-lookup"><span data-stu-id="7d998-174">Add code to call the `SimpleEmitDemo` method.</span></span> <span data-ttu-id="7d998-175">L’appel est marshalé à travers la limite du domaine d’application et le code est exécuté dans le domaine d’application sandbox.</span><span class="sxs-lookup"><span data-stu-id="7d998-175">The call is marshaled across the application domain boundary, and the code is executed in the sandboxed application domain.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#13](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#13)]
    [!code-vb[HowToEmitCodeInPartialTrust#13](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#13)]

<a name="Using_methods"></a>

## <a name="using-anonymously-hosted-dynamic-methods"></a><span data-ttu-id="7d998-176">Utilisation de méthodes dynamiques hébergées anonymement</span><span class="sxs-lookup"><span data-stu-id="7d998-176">Using Anonymously Hosted Dynamic Methods</span></span>

<span data-ttu-id="7d998-177">Les méthodes dynamiques hébergées anonymement sont associées à un assembly transparent fourni par le système.</span><span class="sxs-lookup"><span data-stu-id="7d998-177">Anonymously hosted dynamic methods are associated with a transparent assembly that is provided by the system.</span></span> <span data-ttu-id="7d998-178">Par conséquent, le code qu’elles contiennent est transparent.</span><span class="sxs-lookup"><span data-stu-id="7d998-178">Therefore, the code they contain is transparent.</span></span> <span data-ttu-id="7d998-179">Les méthodes dynamiques ordinaires doivent quant à elles être associées à un module existant (qu’il soit spécifié directement ou inféré depuis un type associé) et prendre leur niveau de sécurité de ce module.</span><span class="sxs-lookup"><span data-stu-id="7d998-179">Ordinary dynamic methods, on the other hand, must be associated with an existing module (whether directly specified or inferred from an associated type), and take their security level from that module.</span></span>

> [!NOTE]
> <span data-ttu-id="7d998-180">La seule façon d’associer une méthode dynamique à l’assembly qui fournit l’hébergement anonyme est d’utiliser les constructeurs qui sont décrits dans la procédure suivante.</span><span class="sxs-lookup"><span data-stu-id="7d998-180">The only way to associate a dynamic method with the assembly that provides anonymous hosting is to use the constructors that are described in the following procedure.</span></span> <span data-ttu-id="7d998-181">Vous ne pouvez pas spécifier explicitement un module dans l’assembly hébergeur anonyme.</span><span class="sxs-lookup"><span data-stu-id="7d998-181">You cannot explicitly specify a module in the anonymous hosting assembly.</span></span>

<span data-ttu-id="7d998-182">Les méthodes dynamiques ordinaires ont accès aux membres internes du module auquel elles sont associées ou aux membres privés du type auquel elles sont associées.</span><span class="sxs-lookup"><span data-stu-id="7d998-182">Ordinary dynamic methods have access to the internal members of the module they are associated with, or to the private members of the type they are associated with.</span></span> <span data-ttu-id="7d998-183">Comme les méthodes dynamiques hébergées anonymement sont isolées du reste du code, elles n’ont pas accès aux données privées.</span><span class="sxs-lookup"><span data-stu-id="7d998-183">Because anonymously hosted dynamic methods are isolated from other code, they do not have access to private data.</span></span> <span data-ttu-id="7d998-184">Toutefois, elles ont une possibilité limitée d’ignorer les contrôles de visibilité JIT pour accéder aux données privées.</span><span class="sxs-lookup"><span data-stu-id="7d998-184">However, they do have a restricted ability to skip JIT visibility checks to gain access to private data.</span></span> <span data-ttu-id="7d998-185">Cette possibilité est limitée aux assemblys qui ont des niveaux de confiance inférieurs ou égaux au niveau de confiance de l’assembly qui émet le code.</span><span class="sxs-lookup"><span data-stu-id="7d998-185">This ability is limited to assemblies that have trust levels equal to or less than the trust level of the assembly that emits the code.</span></span>

<span data-ttu-id="7d998-186">Pour empêcher une élévation de privilèges, les informations de pile de l’assembly émetteur sont incluses lors de la construction des méthodes dynamiques hébergées anonymement.</span><span class="sxs-lookup"><span data-stu-id="7d998-186">To prevent elevation of privilege, stack information for the emitting assembly is included when anonymously hosted dynamic methods are constructed.</span></span> <span data-ttu-id="7d998-187">Quand la méthode est appelée, les informations de pile sont vérifiées.</span><span class="sxs-lookup"><span data-stu-id="7d998-187">When the method is invoked, the stack information is checked.</span></span> <span data-ttu-id="7d998-188">Une méthode dynamique hébergée anonymement qui est appelée à partir d’un code totalement fiable est toujours limitée au niveau de confiance de l’assembly émetteur.</span><span class="sxs-lookup"><span data-stu-id="7d998-188">An anonymously hosted dynamic method that is invoked from fully trusted code is still limited to the trust level of the assembly that emitted it.</span></span>

#### <a name="to-use-anonymously-hosted-dynamic-methods"></a><span data-ttu-id="7d998-189">Pour utiliser des méthodes dynamiques hébergées anonymement</span><span class="sxs-lookup"><span data-stu-id="7d998-189">To use anonymously hosted dynamic methods</span></span>

- <span data-ttu-id="7d998-190">Créez une méthode dynamique hébergée anonymement en utilisant un constructeur qui ne spécifie pas un module ou un type associé.</span><span class="sxs-lookup"><span data-stu-id="7d998-190">Create an anonymously hosted dynamic method by using a constructor that does not specify an associated module or type.</span></span>

  [!code-csharp[HowToEmitCodeInPartialTrust#15](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#15)]
  [!code-vb[HowToEmitCodeInPartialTrust#15](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#15)]

  <span data-ttu-id="7d998-191">Si une méthode dynamique hébergée anonymement utilise seulement des méthodes et des types publics, elle ne nécessite pas un accès restreint aux membres et n’a pas à ignorer les contrôles de visibilité JIT.</span><span class="sxs-lookup"><span data-stu-id="7d998-191">If an anonymously hosted dynamic method uses only public types and methods, it does not require restricted member access and does not have to skip JIT visibility checks.</span></span>

  <span data-ttu-id="7d998-192">Aucune autorisation spéciale n’est nécessaire pour émettre une méthode dynamique, mais le code émis nécessite les autorisations demandées par les types et les méthodes qu’il utilise.</span><span class="sxs-lookup"><span data-stu-id="7d998-192">No special permissions are required to emit a dynamic method, but the emitted code requires the permissions that are demanded by the types and methods it uses.</span></span> <span data-ttu-id="7d998-193">Par exemple, si le code émis appelle une méthode qui accède à un fichier, il nécessite <xref:System.Security.Permissions.FileIOPermission>.</span><span class="sxs-lookup"><span data-stu-id="7d998-193">For example, if the emitted code calls a method that accesses a file, it requires <xref:System.Security.Permissions.FileIOPermission>.</span></span> <span data-ttu-id="7d998-194">Si le niveau de confiance n’inclut pas cette autorisation, une exception de sécurité est levée quand le code émis est exécuté.</span><span class="sxs-lookup"><span data-stu-id="7d998-194">If the trust level does not include that permission, a security exception is thrown when the emitted code is executed.</span></span> <span data-ttu-id="7d998-195">Le code montré ici émet une méthode dynamique qui utilise seulement la méthode <xref:System.Console.WriteLine%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="7d998-195">The code shown here emits a dynamic method that uses only the <xref:System.Console.WriteLine%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="7d998-196">Par conséquent, le code peut être exécuté à partir d’emplacements partiellement fiables.</span><span class="sxs-lookup"><span data-stu-id="7d998-196">Therefore, the code can be executed from partially trusted locations.</span></span>

- <span data-ttu-id="7d998-197">Vous pouvez aussi créer une méthode dynamique hébergée anonymement avec une possibilité limitée d’ignorer les contrôles de visibilité JIT, en utilisant le constructeur <xref:System.Reflection.Emit.DynamicMethod.%23ctor%28System.String%2CSystem.Type%2CSystem.Type%5B%5D%2CSystem.Boolean%29> et en spécifiant `true` pour le paramètre `restrictedSkipVisibility`.</span><span class="sxs-lookup"><span data-stu-id="7d998-197">Alternatively, create an anonymously hosted dynamic method with restricted ability to skip JIT visibility checks, by using the <xref:System.Reflection.Emit.DynamicMethod.%23ctor%28System.String%2CSystem.Type%2CSystem.Type%5B%5D%2CSystem.Boolean%29> constructor and specifying `true` for the `restrictedSkipVisibility` parameter.</span></span>

  [!code-csharp[HowToEmitCodeInPartialTrust#16](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#16)]
  [!code-vb[HowToEmitCodeInPartialTrust#16](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#16)]

  <span data-ttu-id="7d998-198">La restriction est que la méthode dynamique hébergée anonymement peut accéder aux données privées seulement dans les assemblys avec des niveaux de confiance inférieurs ou égaux à celui de l’assembly émetteur.</span><span class="sxs-lookup"><span data-stu-id="7d998-198">The restriction is that the anonymously hosted dynamic method can access private data only in assemblies with trust levels equal to or less than the trust level of the emitting assembly.</span></span> <span data-ttu-id="7d998-199">Par exemple, si la méthode dynamique s’exécute avec une confiance Internet, elle peut accéder aux données privées d’autres assemblys qui s’exécutent aussi avec la confiance Internet, mais elle ne peut pas accéder aux données privées des assemblys .NET Framework.</span><span class="sxs-lookup"><span data-stu-id="7d998-199">For example, if the dynamic method is executing with Internet trust, it can access private data in other assemblies that are also executing with Internet trust, but it cannot access private data of .NET Framework assemblies.</span></span> <span data-ttu-id="7d998-200">Les assemblys .NET Framework sont installés dans le Global Assembly Cache et sont toujours entièrement fiables.</span><span class="sxs-lookup"><span data-stu-id="7d998-200">.NET Framework assemblies are installed in the global assembly cache and are always fully trusted.</span></span>

  <span data-ttu-id="7d998-201">Les méthodes dynamiques hébergées anonymement peuvent utiliser cette possibilité limitée d’ignorer les contrôles de visibilité JIT seulement si l’application hôte accorde <xref:System.Security.Permissions.ReflectionPermission> avec l’indicateur <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="7d998-201">Anonymously hosted dynamic methods can use this restricted ability to skip JIT visibility checks only if the host application grants <xref:System.Security.Permissions.ReflectionPermission> with the <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> flag.</span></span> <span data-ttu-id="7d998-202">La demande de cette autorisation est effectuée quand la méthode est appelée.</span><span class="sxs-lookup"><span data-stu-id="7d998-202">The demand for this permission is made when the method is invoked.</span></span>

  > [!NOTE]
  > <span data-ttu-id="7d998-203">Les informations de la pile des appels de l’assembly émetteur sont incluses lors de la construction de la méthode dynamique.</span><span class="sxs-lookup"><span data-stu-id="7d998-203">Call stack information for the emitting assembly is included when the dynamic method is constructed.</span></span> <span data-ttu-id="7d998-204">Par conséquent, la demande porte sur les autorisations de l’assembly émetteur au lieu de l’assembly qui appelle la méthode.</span><span class="sxs-lookup"><span data-stu-id="7d998-204">Therefore, the demand is made against the permissions of the emitting assembly instead of the assembly that invokes the method.</span></span> <span data-ttu-id="7d998-205">Ceci empêche l’exécution du code émis avec des autorisations élevées.</span><span class="sxs-lookup"><span data-stu-id="7d998-205">This prevents the emitted code from being executed with elevated permissions.</span></span>

  <span data-ttu-id="7d998-206">L’[exemple de code complet](#Example) à la fin de cette procédure pas à pas montre l’utilisation et les limitations de l’accès restreint aux membres.</span><span class="sxs-lookup"><span data-stu-id="7d998-206">The [complete code example](#Example) at the end of this walkthrough demonstrates the use and limitations of restricted member access.</span></span> <span data-ttu-id="7d998-207">Sa classe `Worker` comprend une méthode qui peut créer des méthodes dynamiques hébergées anonymement avec ou sans la possibilité limitée d’ignorer les contrôles de visibilité. L’exemple montre le résultat de l’exécution de cette méthode dans des domaines d’application qui ont des niveaux de confiance différents.</span><span class="sxs-lookup"><span data-stu-id="7d998-207">Its `Worker` class includes a method that can create anonymously hosted dynamic methods with or without the restricted ability to skip visibility checks, and the example shows the result of executing this method in application domains that have different trust levels.</span></span>

  > [!NOTE]
  > <span data-ttu-id="7d998-208">La possibilité limitée d’ignorer les contrôles de visibilité est une fonctionnalité des méthodes dynamiques hébergées anonymement.</span><span class="sxs-lookup"><span data-stu-id="7d998-208">The restricted ability to skip visibility checks is a feature of anonymously hosted dynamic methods.</span></span> <span data-ttu-id="7d998-209">Quand des méthodes dynamiques ordinaires ignorent les contrôles de visibilité JIT, une confiance totale leur est accordée.</span><span class="sxs-lookup"><span data-stu-id="7d998-209">When ordinary dynamic methods skip JIT visibility checks, they must be granted full trust.</span></span>

<a name="Example"></a>

## <a name="example"></a><span data-ttu-id="7d998-210">Exemple</span><span class="sxs-lookup"><span data-stu-id="7d998-210">Example</span></span>

### <a name="description"></a><span data-ttu-id="7d998-211">Description</span><span class="sxs-lookup"><span data-stu-id="7d998-211">Description</span></span>

<span data-ttu-id="7d998-212">L’exemple de code suivant montre l’utilisation de l’indicateur <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess> pour permettre aux méthodes dynamiques hébergées anonymement d’ignorer les contrôles de visibilité JIT, mais seulement quand le membre cible est à un niveau de confiance inférieur ou égal à celui de l’assembly qui émet le code.</span><span class="sxs-lookup"><span data-stu-id="7d998-212">The following code example demonstrates the use of the <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess> flag to allow anonymously hosted dynamic methods to skip JIT visibility checks, but only when the target member is at an equal or lower level of trust than the assembly that emits the code.</span></span>

<span data-ttu-id="7d998-213">L’exemple définit une classe `Worker` qui peut être marshalée à travers les limites du domaine d’application.</span><span class="sxs-lookup"><span data-stu-id="7d998-213">The example defines a `Worker` class that can be marshaled across application domain boundaries.</span></span> <span data-ttu-id="7d998-214">La classe a deux surcharges de la méthode `AccessPrivateMethod`, qui émettent et exécutent des méthodes dynamiques.</span><span class="sxs-lookup"><span data-stu-id="7d998-214">The class has two `AccessPrivateMethod` method overloads that emit and execute dynamic methods.</span></span> <span data-ttu-id="7d998-215">La première surcharge émet une méthode dynamique qui appelle la méthode `PrivateMethod` privée de la classe `Worker`, et peut émettre la méthode dynamique avec ou sans contrôles de visibilité JIT.</span><span class="sxs-lookup"><span data-stu-id="7d998-215">The first overload emits a dynamic method that calls the private `PrivateMethod` method of the `Worker` class, and it can emit the dynamic method with or without JIT visibility checks.</span></span> <span data-ttu-id="7d998-216">La deuxième surcharge émet une méthode dynamique qui accède à une propriété `internal` (la propriété `Friend` en Visual Basic) de la classe <xref:System.String>.</span><span class="sxs-lookup"><span data-stu-id="7d998-216">The second overload emits a dynamic method that accesses an `internal` property (`Friend` property in Visual Basic) of the <xref:System.String> class.</span></span>

<span data-ttu-id="7d998-217">L’exemple utilise une méthode d’assistance pour créer un jeu d’autorisations limité aux autorisations `Internet`, puis crée un domaine d’application en utilisant la surcharge de la méthode <xref:System.AppDomain.CreateDomain%28System.String%2CSystem.Security.Policy.Evidence%2CSystem.AppDomainSetup%2CSystem.Security.PermissionSet%2CSystem.Security.Policy.StrongName%5B%5D%29?displayProperty=nameWithType> pour spécifier que tout le code qui s’exécute dans le domaine utilise ce jeu d’autorisations.</span><span class="sxs-lookup"><span data-stu-id="7d998-217">The example uses a helper method to create a grant set limited to `Internet` permissions, and then creates an application domain, using the <xref:System.AppDomain.CreateDomain%28System.String%2CSystem.Security.Policy.Evidence%2CSystem.AppDomainSetup%2CSystem.Security.PermissionSet%2CSystem.Security.Policy.StrongName%5B%5D%29?displayProperty=nameWithType> method overload to specify that all code that executes in the domain uses this grant set.</span></span> <span data-ttu-id="7d998-218">L’exemple crée une instance de la classe `Worker` dans le domaine d’application et exécute deux fois la méthode `AccessPrivateMethod`.</span><span class="sxs-lookup"><span data-stu-id="7d998-218">The example creates an instance of the `Worker` class in the application domain, and executes the `AccessPrivateMethod` method two times.</span></span>

- <span data-ttu-id="7d998-219">La première fois que la méthode `AccessPrivateMethod` est exécutée, les contrôles de visibilité JIT sont appliqués.</span><span class="sxs-lookup"><span data-stu-id="7d998-219">The first time the `AccessPrivateMethod` method is executed, JIT visibility checks are enforced.</span></span> <span data-ttu-id="7d998-220">La méthode dynamique échoue quand elle est appelée, car les contrôles de visibilité JIT l’empêchent d’accéder à la méthode privée.</span><span class="sxs-lookup"><span data-stu-id="7d998-220">The dynamic method fails when it is invoked, because JIT visibility checks prevent it from accessing the private method.</span></span>

- <span data-ttu-id="7d998-221">La seconde fois que la méthode `AccessPrivateMethod` est exécutée, les contrôles de visibilité JIT sont ignorés.</span><span class="sxs-lookup"><span data-stu-id="7d998-221">The second time the `AccessPrivateMethod` method is executed, JIT visibility checks are skipped.</span></span> <span data-ttu-id="7d998-222">La méthode dynamique échoue lors de la compilation, car le jeu d’autorisations `Internet` n’accorde pas d’autorisations suffisantes pour ignorer les contrôles de visibilité.</span><span class="sxs-lookup"><span data-stu-id="7d998-222">The dynamic method fails when it is compiled, because the `Internet` grant set does not grant sufficient permissions to skip visibility checks.</span></span>

<span data-ttu-id="7d998-223">L’exemple ajoute <xref:System.Security.Permissions.ReflectionPermission> avec <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> au jeu d’autorisations.</span><span class="sxs-lookup"><span data-stu-id="7d998-223">The example adds <xref:System.Security.Permissions.ReflectionPermission> with <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> to the grant set.</span></span> <span data-ttu-id="7d998-224">L’exemple crée ensuite un second domaine en spécifiant que tout le code qui s’exécute dans le domaine reçoit les autorisations du jeu d’autorisations.</span><span class="sxs-lookup"><span data-stu-id="7d998-224">The example then creates a second domain, specifying that all code that executes in the domain is granted the permissions in the new grant set.</span></span> <span data-ttu-id="7d998-225">L’exemple crée une instance de la classe `Worker` dans le nouveau domaine d’application et exécute les deux surcharges de la méthode `AccessPrivateMethod`.</span><span class="sxs-lookup"><span data-stu-id="7d998-225">The example creates an instance of the `Worker` class in the new application domain, and executes both overloads of the `AccessPrivateMethod` method.</span></span>

- <span data-ttu-id="7d998-226">La première surcharge de la méthode `AccessPrivateMethod` est exécutée et les contrôles de visibilité JIT sont ignorés.</span><span class="sxs-lookup"><span data-stu-id="7d998-226">The first overload of the `AccessPrivateMethod` method is executed, and JIT visibility checks are skipped.</span></span> <span data-ttu-id="7d998-227">La méthode dynamique se compile et s’exécute correctement, car l’assembly qui émet le code est le même que l’assembly qui contient la méthode privée.</span><span class="sxs-lookup"><span data-stu-id="7d998-227">The dynamic method compiles and executes successfully, because the assembly that emits the code is the same as the assembly that contains the private method.</span></span> <span data-ttu-id="7d998-228">Par conséquent, les niveaux de confiance sont égaux.</span><span class="sxs-lookup"><span data-stu-id="7d998-228">Therefore, the trust levels are equal.</span></span> <span data-ttu-id="7d998-229">Si l’application qui contient la classe `Worker` avait plusieurs assemblys, le même processus réussirait pour chacun de ces assemblys, car ils seraient tous au même niveau de confiance.</span><span class="sxs-lookup"><span data-stu-id="7d998-229">If the application that contains the `Worker` class had several assemblies, the same process would succeed for any one of those assemblies, because they would all be at the same trust level.</span></span>

- <span data-ttu-id="7d998-230">La seconde surcharge de la méthode `AccessPrivateMethod` est exécutée et les contrôles de visibilité JIT sont à nouveau ignorés.</span><span class="sxs-lookup"><span data-stu-id="7d998-230">The second overload of the `AccessPrivateMethod` method is executed, and again JIT visibility checks are skipped.</span></span> <span data-ttu-id="7d998-231">Cette fois, la méthode dynamique échoue lorsqu’elle est compilée, car elle tente d’accéder à la `internal` `FirstChar` propriété de la <xref:System.String> classe.</span><span class="sxs-lookup"><span data-stu-id="7d998-231">This time the dynamic method fails when it is compiled, because it tries to access the `internal` `FirstChar` property of the <xref:System.String> class.</span></span> <span data-ttu-id="7d998-232">L’assembly qui contient la classe <xref:System.String> est totalement fiable.</span><span class="sxs-lookup"><span data-stu-id="7d998-232">The assembly that contains the <xref:System.String> class is fully trusted.</span></span> <span data-ttu-id="7d998-233">Par conséquent, il est à un niveau de confiance plus élevé que l’assembly qui émet le code.</span><span class="sxs-lookup"><span data-stu-id="7d998-233">Therefore, it is at a higher level of trust than the assembly that emits the code.</span></span>

<span data-ttu-id="7d998-234">Cette comparaison montre comment <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> permet à du code partiellement fiable d’ignorer les contrôles de visibilité pour un autre code partiellement fiable sans compromettre la sécurité du code de confiance.</span><span class="sxs-lookup"><span data-stu-id="7d998-234">This comparison shows how <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> enables partially trusted code to skip visibility checks for other partially trusted code without compromising the security of trusted code.</span></span>

### <a name="code"></a><span data-ttu-id="7d998-235">Code</span><span class="sxs-lookup"><span data-stu-id="7d998-235">Code</span></span>

[!code-csharp[HowToEmitCodeInPartialTrust#1](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#1)]
[!code-vb[HowToEmitCodeInPartialTrust#1](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#1)]

## <a name="compiling-the-code"></a><span data-ttu-id="7d998-236">Compilation du code</span><span class="sxs-lookup"><span data-stu-id="7d998-236">Compiling the Code</span></span>

- <span data-ttu-id="7d998-237">Si vous générez cet exemple de code dans Visual Studio, vous devez changer le nom de la classe pour inclure l’espace de noms quand vous le passez à la méthode <xref:System.AppDomain.CreateInstanceAndUnwrap%2A>.</span><span class="sxs-lookup"><span data-stu-id="7d998-237">If you build this code example in Visual Studio, you must change the name of the class to include the namespace when you pass it to the <xref:System.AppDomain.CreateInstanceAndUnwrap%2A> method.</span></span> <span data-ttu-id="7d998-238">Par défaut, l’espace de noms est le nom du projet.</span><span class="sxs-lookup"><span data-stu-id="7d998-238">By default, the namespace is the name of the project.</span></span> <span data-ttu-id="7d998-239">Par exemple, si le projet est « PartialTrust », le nom de la classe doit être « PartialTrust.Worker ».</span><span class="sxs-lookup"><span data-stu-id="7d998-239">For example, if the project is "PartialTrust", the class name must be "PartialTrust.Worker".</span></span>

## <a name="see-also"></a><span data-ttu-id="7d998-240">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="7d998-240">See also</span></span>

- [<span data-ttu-id="7d998-241">Problèmes de sécurité dans l'émission de réflexion</span><span class="sxs-lookup"><span data-stu-id="7d998-241">Security Issues in Reflection Emit</span></span>](security-issues-in-reflection-emit.md)
- [<span data-ttu-id="7d998-242">Guide pratique pour exécuter du code d’un niveau de confiance partiel dans un bac à sable (sandbox)</span><span class="sxs-lookup"><span data-stu-id="7d998-242">How to: Run Partially Trusted Code in a Sandbox</span></span>](../misc/how-to-run-partially-trusted-code-in-a-sandbox.md)
