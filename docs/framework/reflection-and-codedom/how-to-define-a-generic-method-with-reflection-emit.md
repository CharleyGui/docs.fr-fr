---
title: Guide pratique pour définir une méthode générique avec l’émission de réflexion
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- generics [.NET Framework], reflection emit
- reflection emit, generic methods
- generics [.NET Framework], dynamic types
ms.assetid: 93892fa4-90b3-4ec4-b147-4bec9880de2b
ms.openlocfilehash: d16f6728b01583fe3ffb8d892522f3892444c537
ms.sourcegitcommit: 559fcfbe4871636494870a8b716bf7325df34ac5
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 10/30/2019
ms.locfileid: "73130177"
---
# <a name="how-to-define-a-generic-method-with-reflection-emit"></a><span data-ttu-id="042d1-102">Guide pratique pour définir une méthode générique avec l’émission de réflexion</span><span class="sxs-lookup"><span data-stu-id="042d1-102">How to: Define a Generic Method with Reflection Emit</span></span>

<span data-ttu-id="042d1-103">La première procédure montre comment créer une méthode générique simple avec deux paramètres de type et comment appliquer des contraintes de classe, des contraintes d’interface et des contraintes spéciales aux paramètres de type.</span><span class="sxs-lookup"><span data-stu-id="042d1-103">The first procedure shows how to create a simple generic method with two type parameters, and how to apply class constraints, interface constraints, and special constraints to the type parameters.</span></span>

<span data-ttu-id="042d1-104">La deuxième procédure montre comment émettre le corps de la méthode et comment utiliser les paramètres de type de la méthode générique pour créer des instances des types génériques et appeler leurs méthodes.</span><span class="sxs-lookup"><span data-stu-id="042d1-104">The second procedure shows how to emit the method body, and how to use the type parameters of the generic method to create instances of generic types and to call their methods.</span></span>

<span data-ttu-id="042d1-105">La troisième procédure montre comment appeler la méthode générique.</span><span class="sxs-lookup"><span data-stu-id="042d1-105">The third procedure shows how to invoke the generic method.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="042d1-106">Une méthode n’est pas générique simplement car elle appartient à un type générique et utilise les paramètres de type de ce type.</span><span class="sxs-lookup"><span data-stu-id="042d1-106">A method is not generic just because it belongs to a generic type and uses the type parameters of that type.</span></span> <span data-ttu-id="042d1-107">Une méthode est générique uniquement si elle a sa propre liste de paramètres de type.</span><span class="sxs-lookup"><span data-stu-id="042d1-107">A method is generic only if it has its own type parameter list.</span></span> <span data-ttu-id="042d1-108">Une méthode générique peut apparaître sur un type non générique, comme dans cet exemple.</span><span class="sxs-lookup"><span data-stu-id="042d1-108">A generic method can appear on a nongeneric type, as in this example.</span></span> <span data-ttu-id="042d1-109">Pour obtenir un exemple de méthode non générique sur un type générique, consultez [Guide pratique pour définir un type générique avec l’émission de réflexion](how-to-define-a-generic-type-with-reflection-emit.md).</span><span class="sxs-lookup"><span data-stu-id="042d1-109">For an example of a nongeneric method on a generic type, see [How to: Define a Generic Type with Reflection Emit](how-to-define-a-generic-type-with-reflection-emit.md).</span></span>

### <a name="to-define-a-generic-method"></a><span data-ttu-id="042d1-110">Pour définir une méthode générique</span><span class="sxs-lookup"><span data-stu-id="042d1-110">To define a generic method</span></span>

1. <span data-ttu-id="042d1-111">Avant de commencer, il est utile d’observer à quoi ressemble la méthode générique quand elle est écrite à l’aide d’un langage de haut niveau.</span><span class="sxs-lookup"><span data-stu-id="042d1-111">Before beginning, it is useful to look at how the generic method appears when written using a high-level language.</span></span> <span data-ttu-id="042d1-112">Le code suivant est inclus dans l’exemple de code de cette rubrique, en plus du code pour appeler la méthode générique.</span><span class="sxs-lookup"><span data-stu-id="042d1-112">The following code is included in the example code for this topic, along with code to call the generic method.</span></span> <span data-ttu-id="042d1-113">La méthode a deux paramètres de type, `TInput` et `TOutput`, dont le second doit être un type référence (`class`), doit avoir un constructeur sans paramètre (`new`) et doit implémenter `ICollection(Of TInput)` (`ICollection<TInput>` en C#).</span><span class="sxs-lookup"><span data-stu-id="042d1-113">The method has two type parameters, `TInput` and `TOutput`, the second of which must be a reference type (`class`), must have a parameterless constructor (`new`), and must implement `ICollection(Of TInput)` (`ICollection<TInput>` in C#).</span></span> <span data-ttu-id="042d1-114">Cette contrainte d’interface garantit que la méthode <xref:System.Collections.Generic.ICollection%601.Add%2A?displayProperty=nameWithType> peut être utilisée pour ajouter des éléments à la collection `TOutput` créée par la méthode.</span><span class="sxs-lookup"><span data-stu-id="042d1-114">This interface constraint ensures that the <xref:System.Collections.Generic.ICollection%601.Add%2A?displayProperty=nameWithType> method can be used to add elements to the `TOutput` collection that the method creates.</span></span> <span data-ttu-id="042d1-115">La méthode a un paramètre formel, `input`, qui est un tableau de `TInput`.</span><span class="sxs-lookup"><span data-stu-id="042d1-115">The method has one formal parameter, `input`, which is an array of `TInput`.</span></span> <span data-ttu-id="042d1-116">La méthode crée une collection de type `TOutput` et copie les éléments de `input` dans la collection.</span><span class="sxs-lookup"><span data-stu-id="042d1-116">The method creates a collection of type `TOutput` and copies the elements of `input` to the collection.</span></span>

    [!code-csharp[GenericMethodHowTo#20](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#20)]
    [!code-vb[GenericMethodHowTo#20](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#20)]

2. <span data-ttu-id="042d1-117">Définissez un assembly dynamique et un module dynamique pour contenir le type auquel la méthode générique appartient.</span><span class="sxs-lookup"><span data-stu-id="042d1-117">Define a dynamic assembly and a dynamic module to contain the type the generic method belongs to.</span></span> <span data-ttu-id="042d1-118">Dans ce cas, l’assembly n’a qu’un seul module, nommé `DemoMethodBuilder1`, et le nom du module est identique au nom de l’assembly plus une extension.</span><span class="sxs-lookup"><span data-stu-id="042d1-118">In this case, the assembly has only one module, named `DemoMethodBuilder1`, and the module name is the same as the assembly name plus an extension.</span></span> <span data-ttu-id="042d1-119">Dans cet exemple, l’assembly est enregistré sur le disque et exécuté. <xref:System.Reflection.Emit.AssemblyBuilderAccess.RunAndSave?displayProperty=nameWithType> est donc spécifié.</span><span class="sxs-lookup"><span data-stu-id="042d1-119">In this example, the assembly is saved to disk and also executed, so <xref:System.Reflection.Emit.AssemblyBuilderAccess.RunAndSave?displayProperty=nameWithType> is specified.</span></span> <span data-ttu-id="042d1-120">Vous pouvez utiliser le [désassembleur IL (Ildasm.exe)](../tools/ildasm-exe-il-disassembler.md) pour examiner DemoMethodBuilder1.dll et la comparer au code MSIL (Microsoft Intermediate language) de la méthode illustrée à l’étape 1.</span><span class="sxs-lookup"><span data-stu-id="042d1-120">You can use the [Ildasm.exe (IL Disassembler)](../tools/ildasm-exe-il-disassembler.md) to examine DemoMethodBuilder1.dll and to compare it to the Microsoft intermediate language (MSIL) for the method shown in step 1.</span></span>

    [!code-csharp[GenericMethodHowTo#2](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#2)]
    [!code-vb[GenericMethodHowTo#2](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#2)]

3. <span data-ttu-id="042d1-121">Définissez le type auquel appartient la méthode générique.</span><span class="sxs-lookup"><span data-stu-id="042d1-121">Define the type the generic method belongs to.</span></span> <span data-ttu-id="042d1-122">Il n’est pas obligatoire que le type soit générique.</span><span class="sxs-lookup"><span data-stu-id="042d1-122">The type does not have to be generic.</span></span> <span data-ttu-id="042d1-123">Une méthode générique peut appartenir à un type générique ou non générique.</span><span class="sxs-lookup"><span data-stu-id="042d1-123">A generic method can belong to either a generic or nongeneric type.</span></span> <span data-ttu-id="042d1-124">Dans cet exemple, le type est une classe, n’est pas générique et se nomme `DemoType`.</span><span class="sxs-lookup"><span data-stu-id="042d1-124">In this example, the type is a class, is not generic, and is named `DemoType`.</span></span>

    [!code-csharp[GenericMethodHowTo#3](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#3)]
    [!code-vb[GenericMethodHowTo#3](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#3)]

4. <span data-ttu-id="042d1-125">Définissez la méthode générique.</span><span class="sxs-lookup"><span data-stu-id="042d1-125">Define the generic method.</span></span> <span data-ttu-id="042d1-126">Si les types des paramètres formels d’une méthode générique sont spécifiés par les paramètres de type générique de la méthode générique, utilisez la surcharge de méthode <xref:System.Reflection.Emit.TypeBuilder.DefineMethod%28System.String%2CSystem.Reflection.MethodAttributes%29> pour définir la méthode.</span><span class="sxs-lookup"><span data-stu-id="042d1-126">If the types of a generic method's formal parameters are specified by generic type parameters of the generic method, use the <xref:System.Reflection.Emit.TypeBuilder.DefineMethod%28System.String%2CSystem.Reflection.MethodAttributes%29> method overload to define the method.</span></span> <span data-ttu-id="042d1-127">Les paramètres de type générique de la méthode n’étant pas encore définis, vous ne pouvez pas spécifier les types des paramètres formels de la méthode dans l’appel à <xref:System.Reflection.Emit.TypeBuilder.DefineMethod%2A>.</span><span class="sxs-lookup"><span data-stu-id="042d1-127">The generic type parameters of the method are not yet defined, so you cannot specify the types of the method's formal parameters in the call to <xref:System.Reflection.Emit.TypeBuilder.DefineMethod%2A>.</span></span> <span data-ttu-id="042d1-128">Dans cet exemple, la méthode se nomme `Factory`.</span><span class="sxs-lookup"><span data-stu-id="042d1-128">In this example, the method is named `Factory`.</span></span> <span data-ttu-id="042d1-129">La méthode est publique et `static` (`Shared` en Visual Basic).</span><span class="sxs-lookup"><span data-stu-id="042d1-129">The method is public and `static` (`Shared` in Visual Basic).</span></span>

    [!code-csharp[GenericMethodHowTo#4](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#4)]
    [!code-vb[GenericMethodHowTo#4](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#4)]

5. <span data-ttu-id="042d1-130">Définissez les paramètres de type générique de `DemoMethod` en passant un tableau de chaînes contenant les noms des paramètres à la méthode <xref:System.Reflection.Emit.MethodBuilder.DefineGenericParameters%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="042d1-130">Define the generic type parameters of `DemoMethod` by passing an array of strings containing the names of the parameters to the <xref:System.Reflection.Emit.MethodBuilder.DefineGenericParameters%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="042d1-131">Cela rend la méthode générique.</span><span class="sxs-lookup"><span data-stu-id="042d1-131">This makes the method a generic method.</span></span> <span data-ttu-id="042d1-132">Le code suivant fait de `Factory` une méthode générique avec les paramètres de type `TInput` et `TOutput`.</span><span class="sxs-lookup"><span data-stu-id="042d1-132">The following code makes `Factory` a generic method with type parameters `TInput` and `TOutput`.</span></span> <span data-ttu-id="042d1-133">Pour faciliter la lecture du code, des variables avec ces noms sont créées pour stocker les objets <xref:System.Reflection.Emit.GenericTypeParameterBuilder> représentant les deux paramètres de type.</span><span class="sxs-lookup"><span data-stu-id="042d1-133">To make the code easier to read, variables with these names are created to hold the <xref:System.Reflection.Emit.GenericTypeParameterBuilder> objects representing the two type parameters.</span></span>

    [!code-csharp[GenericMethodHowTo#5](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#5)]
    [!code-vb[GenericMethodHowTo#5](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#5)]

6. <span data-ttu-id="042d1-134">Ajoutez éventuellement des contraintes spéciales aux paramètres de type.</span><span class="sxs-lookup"><span data-stu-id="042d1-134">Optionally add special constraints to the type parameters.</span></span> <span data-ttu-id="042d1-135">Les contraintes spéciales sont ajoutées à l’aide de la méthode <xref:System.Reflection.Emit.GenericTypeParameterBuilder.SetGenericParameterAttributes%2A>.</span><span class="sxs-lookup"><span data-stu-id="042d1-135">Special constraints are added using the <xref:System.Reflection.Emit.GenericTypeParameterBuilder.SetGenericParameterAttributes%2A> method.</span></span> <span data-ttu-id="042d1-136">Dans cet exemple, `TOutput` doit être un type référence et avoir un constructeur sans paramètre.</span><span class="sxs-lookup"><span data-stu-id="042d1-136">In this example, `TOutput` is constrained to be a reference type and to have a parameterless constructor.</span></span>

    [!code-csharp[GenericMethodHowTo#6](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#6)]
    [!code-vb[GenericMethodHowTo#6](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#6)]

7. <span data-ttu-id="042d1-137">Ajoutez éventuellement des contraintes de classe et d’interface aux paramètres de type.</span><span class="sxs-lookup"><span data-stu-id="042d1-137">Optionally add class and interface constraints to the type parameters.</span></span> <span data-ttu-id="042d1-138">Dans cet exemple, le paramètre de type `TOutput` est limité aux types qui implémentent l’interface `ICollection(Of TInput)` (`ICollection<TInput>` en C#).</span><span class="sxs-lookup"><span data-stu-id="042d1-138">In this example, type parameter `TOutput` is constrained to types that implement the `ICollection(Of TInput)` (`ICollection<TInput>` in C#) interface.</span></span> <span data-ttu-id="042d1-139">Cela garantit que la méthode <xref:System.Collections.Generic.ICollection%601.Add%2A> peut être utilisée pour ajouter des éléments.</span><span class="sxs-lookup"><span data-stu-id="042d1-139">This ensures that the <xref:System.Collections.Generic.ICollection%601.Add%2A> method can be used to add elements.</span></span>

    [!code-csharp[GenericMethodHowTo#7](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#7)]
    [!code-vb[GenericMethodHowTo#7](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#7)]

8. <span data-ttu-id="042d1-140">Définissez les paramètres formels de la méthode, à l’aide de la méthode <xref:System.Reflection.Emit.MethodBuilder.SetParameters%2A>.</span><span class="sxs-lookup"><span data-stu-id="042d1-140">Define the formal parameters of the method, using the <xref:System.Reflection.Emit.MethodBuilder.SetParameters%2A> method.</span></span> <span data-ttu-id="042d1-141">Dans cet exemple, la méthode `Factory` a un paramètre, un tableau de `TInput`.</span><span class="sxs-lookup"><span data-stu-id="042d1-141">In this example, the `Factory` method has one parameter, an array of `TInput`.</span></span> <span data-ttu-id="042d1-142">Ce type est créé en appelant la méthode <xref:System.Type.MakeArrayType%2A> sur le <xref:System.Reflection.Emit.GenericTypeParameterBuilder> qui représente `TInput`.</span><span class="sxs-lookup"><span data-stu-id="042d1-142">This type is created by calling the <xref:System.Type.MakeArrayType%2A> method on the <xref:System.Reflection.Emit.GenericTypeParameterBuilder> that represents `TInput`.</span></span> <span data-ttu-id="042d1-143">L’argument de <xref:System.Reflection.Emit.MethodBuilder.SetParameters%2A> est un tableau d’objets <xref:System.Type>.</span><span class="sxs-lookup"><span data-stu-id="042d1-143">The argument of <xref:System.Reflection.Emit.MethodBuilder.SetParameters%2A> is an array of <xref:System.Type> objects.</span></span>

    [!code-csharp[GenericMethodHowTo#8](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#8)]
    [!code-vb[GenericMethodHowTo#8](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#8)]

9. <span data-ttu-id="042d1-144">Définissez le type de retour de la méthode, à l’aide de la méthode <xref:System.Reflection.Emit.MethodBuilder.SetReturnType%2A>.</span><span class="sxs-lookup"><span data-stu-id="042d1-144">Define the return type for the method, using the <xref:System.Reflection.Emit.MethodBuilder.SetReturnType%2A> method.</span></span> <span data-ttu-id="042d1-145">Dans cet exemple, une instance de `TOutput` est retournée.</span><span class="sxs-lookup"><span data-stu-id="042d1-145">In this example, an instance of `TOutput` is returned.</span></span>

    [!code-csharp[GenericMethodHowTo#9](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#9)]
    [!code-vb[GenericMethodHowTo#9](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#9)]

10. <span data-ttu-id="042d1-146">Émettez le corps de méthode à l’aide de <xref:System.Reflection.Emit.ILGenerator>.</span><span class="sxs-lookup"><span data-stu-id="042d1-146">Emit the method body, using <xref:System.Reflection.Emit.ILGenerator>.</span></span> <span data-ttu-id="042d1-147">Pour plus d’informations, consultez la procédure d’émission du corps de méthode.</span><span class="sxs-lookup"><span data-stu-id="042d1-147">For details, see the accompanying procedure for emitting the method body.</span></span>

    > [!IMPORTANT]
    > <span data-ttu-id="042d1-148">Quand vous émettez des appels à des méthodes de types génériques et que les arguments de type de ces types sont des paramètres de type de la méthode générique, vous devez utiliser les surcharges de méthode `static` <xref:System.Reflection.Emit.TypeBuilder.GetConstructor%28System.Type%2CSystem.Reflection.ConstructorInfo%29>, <xref:System.Reflection.Emit.TypeBuilder.GetMethod%28System.Type%2CSystem.Reflection.MethodInfo%29> et <xref:System.Reflection.Emit.TypeBuilder.GetField%28System.Type%2CSystem.Reflection.FieldInfo%29> de la classe <xref:System.Reflection.Emit.TypeBuilder> pour obtenir des formes construites des méthodes.</span><span class="sxs-lookup"><span data-stu-id="042d1-148">When you emit calls to methods of generic types, and the type arguments of those types are type parameters of the generic method, you must use the `static`<xref:System.Reflection.Emit.TypeBuilder.GetConstructor%28System.Type%2CSystem.Reflection.ConstructorInfo%29>, <xref:System.Reflection.Emit.TypeBuilder.GetMethod%28System.Type%2CSystem.Reflection.MethodInfo%29>, and <xref:System.Reflection.Emit.TypeBuilder.GetField%28System.Type%2CSystem.Reflection.FieldInfo%29> method overloads of the <xref:System.Reflection.Emit.TypeBuilder> class to obtain constructed forms of the methods.</span></span> <span data-ttu-id="042d1-149">Ceci est illustré dans la procédure d’émission du corps de méthode.</span><span class="sxs-lookup"><span data-stu-id="042d1-149">The accompanying procedure for emitting the method body demonstrates this.</span></span>

11. <span data-ttu-id="042d1-150">Terminez le type qui contient la méthode et enregistrez l’assembly.</span><span class="sxs-lookup"><span data-stu-id="042d1-150">Complete the type that contains the method and save the assembly.</span></span> <span data-ttu-id="042d1-151">La procédure d’appel de la méthode générique montre deux façons d’appeler la méthode achevée.</span><span class="sxs-lookup"><span data-stu-id="042d1-151">The accompanying procedure for invoking the generic method shows two ways to invoke the completed method.</span></span>

    [!code-csharp[GenericMethodHowTo#14](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#14)]
    [!code-vb[GenericMethodHowTo#14](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#14)]

<a name="procedureSection1"></a>

### <a name="to-emit-the-method-body"></a><span data-ttu-id="042d1-152">Pour émettre le corps de méthode</span><span class="sxs-lookup"><span data-stu-id="042d1-152">To emit the method body</span></span>

1. <span data-ttu-id="042d1-153">Obtenez un générateur de code et déclarez des étiquettes et des variables locales.</span><span class="sxs-lookup"><span data-stu-id="042d1-153">Get a code generator and declare local variables and labels.</span></span> <span data-ttu-id="042d1-154">La méthode <xref:System.Reflection.Emit.ILGenerator.DeclareLocal%2A> est utilisée pour déclarer des variables locales.</span><span class="sxs-lookup"><span data-stu-id="042d1-154">The <xref:System.Reflection.Emit.ILGenerator.DeclareLocal%2A> method is used to declare local variables.</span></span> <span data-ttu-id="042d1-155">La méthode `Factory` a quatre variables locales : `retVal` pour stocker le nouveau `TOutput` retourné par la méthode, `ic` pour contenir le `TOutput` quand il est converti en `ICollection(Of TInput)` (`ICollection<TInput>` en C#), `input` pour contenir le tableau d’entrée d’objets `TInput`, et `index` pour itérer le tableau.</span><span class="sxs-lookup"><span data-stu-id="042d1-155">The `Factory` method has four local variables: `retVal` to hold the new `TOutput` that is returned by the method, `ic` to hold the `TOutput` when it is cast to `ICollection(Of TInput)` (`ICollection<TInput>` in C#), `input` to hold the input array of `TInput` objects, and `index` to iterate through the array.</span></span> <span data-ttu-id="042d1-156">La méthode a également deux étiquettes, une pour entrer dans la boucle (`enterLoop`) et une pour le début de la boucle (`loopAgain`), définies à l’aide de la méthode <xref:System.Reflection.Emit.ILGenerator.DefineLabel%2A>.</span><span class="sxs-lookup"><span data-stu-id="042d1-156">The method also has two labels, one to enter the loop (`enterLoop`) and one for the top of the loop (`loopAgain`), defined using the <xref:System.Reflection.Emit.ILGenerator.DefineLabel%2A> method.</span></span>

    <span data-ttu-id="042d1-157">La première chose que fait la méthode est de charger son argument à l’aide de l’opcode <xref:System.Reflection.Emit.OpCodes.Ldarg_0> et de le stocker dans la variable locale `input` à l’aide de l’opcode <xref:System.Reflection.Emit.OpCodes.Stloc_S>.</span><span class="sxs-lookup"><span data-stu-id="042d1-157">The first thing the method does is to load its argument using <xref:System.Reflection.Emit.OpCodes.Ldarg_0> opcode and to store it in the local variable `input` using <xref:System.Reflection.Emit.OpCodes.Stloc_S> opcode.</span></span>

    [!code-csharp[GenericMethodHowTo#10](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#10)]
    [!code-vb[GenericMethodHowTo#10](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#10)]

2. <span data-ttu-id="042d1-158">Émettez le code pour créer une instance de `TOutput`, à l’aide de la surcharge de méthode générique de la méthode <xref:System.Activator.CreateInstance%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="042d1-158">Emit code to create an instance of `TOutput`, using the generic method overload of the <xref:System.Activator.CreateInstance%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="042d1-159">L’utilisation de cette surcharge impose que le type spécifié ait un constructeur sans paramètre, ce qui explique pourquoi cette contrainte a été ajoutée à `TOutput`.</span><span class="sxs-lookup"><span data-stu-id="042d1-159">Using this overload requires the specified type to have a parameterless constructor, which is the reason for adding that constraint to `TOutput`.</span></span> <span data-ttu-id="042d1-160">Créez la méthode générique construite en passant `TOutput` à <xref:System.Reflection.MethodInfo.MakeGenericMethod%2A>.</span><span class="sxs-lookup"><span data-stu-id="042d1-160">Create the constructed generic method by passing `TOutput` to <xref:System.Reflection.MethodInfo.MakeGenericMethod%2A>.</span></span> <span data-ttu-id="042d1-161">Après avoir émis le code pour appeler la méthode, émettez du code pour la stocker dans la variable locale `retVal` à l’aide de <xref:System.Reflection.Emit.OpCodes.Stloc_S></span><span class="sxs-lookup"><span data-stu-id="042d1-161">After emitting code to call the method, emit code to store it in the local variable `retVal` using <xref:System.Reflection.Emit.OpCodes.Stloc_S></span></span>

    [!code-csharp[GenericMethodHowTo#11](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#11)]
    [!code-vb[GenericMethodHowTo#11](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#11)]

3. <span data-ttu-id="042d1-162">Émettez du code pour effectuer un cast du nouvel objet `TOutput` en `ICollection(Of TInput)` et le stocker dans la variable locale `ic`.</span><span class="sxs-lookup"><span data-stu-id="042d1-162">Emit code to cast the new `TOutput` object to `ICollection(Of TInput)` and store it in the local variable `ic`.</span></span>

    [!code-csharp[GenericMethodHowTo#31](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#31)]
    [!code-vb[GenericMethodHowTo#31](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#31)]

4. <span data-ttu-id="042d1-163">Obtenez un <xref:System.Reflection.MethodInfo> représentant la méthode <xref:System.Collections.Generic.ICollection%601.Add%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="042d1-163">Get a <xref:System.Reflection.MethodInfo> representing the <xref:System.Collections.Generic.ICollection%601.Add%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="042d1-164">Dans la mesure où la méthode agit sur `ICollection(Of TInput)` (`ICollection<TInput>` en C#), il est nécessaire d’obtenir la méthode `Add` propre à ce type construit.</span><span class="sxs-lookup"><span data-stu-id="042d1-164">The method is acting on an `ICollection(Of TInput)` (`ICollection<TInput>` in C#), so it is necessary to get the `Add` method specific to that constructed type.</span></span> <span data-ttu-id="042d1-165">Vous ne pouvez pas utiliser la méthode <xref:System.Type.GetMethod%2A> pour obtenir ce <xref:System.Reflection.MethodInfo> directement à partir de `icollOfTInput`, car <xref:System.Type.GetMethod%2A> n’est pas pris en charge sur un type construit avec un <xref:System.Reflection.Emit.GenericTypeParameterBuilder>.</span><span class="sxs-lookup"><span data-stu-id="042d1-165">You cannot use the <xref:System.Type.GetMethod%2A> method to get this <xref:System.Reflection.MethodInfo> directly from `icollOfTInput`, because <xref:System.Type.GetMethod%2A> is not supported on a type that has been constructed with a <xref:System.Reflection.Emit.GenericTypeParameterBuilder>.</span></span> <span data-ttu-id="042d1-166">Au lieu de cela, appelez <xref:System.Type.GetMethod%2A> sur `icoll`, qui contient la définition de type générique pour l’interface générique <xref:System.Collections.Generic.ICollection%601>.</span><span class="sxs-lookup"><span data-stu-id="042d1-166">Instead, call <xref:System.Type.GetMethod%2A> on `icoll`, which contains the generic type definition for the <xref:System.Collections.Generic.ICollection%601> generic interface.</span></span> <span data-ttu-id="042d1-167">Utilisez ensuite la méthode <xref:System.Reflection.Emit.TypeBuilder.GetMethod%28System.Type%2CSystem.Reflection.MethodInfo%29>`static` pour produire le <xref:System.Reflection.MethodInfo> pour le type construit.</span><span class="sxs-lookup"><span data-stu-id="042d1-167">Then use the <xref:System.Reflection.Emit.TypeBuilder.GetMethod%28System.Type%2CSystem.Reflection.MethodInfo%29>`static` method to produce the <xref:System.Reflection.MethodInfo> for the constructed type.</span></span> <span data-ttu-id="042d1-168">Le code suivant illustre cette méthode.</span><span class="sxs-lookup"><span data-stu-id="042d1-168">The following code demonstrates this.</span></span>

    [!code-csharp[GenericMethodHowTo#12](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#12)]
    [!code-vb[GenericMethodHowTo#12](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#12)]

5. <span data-ttu-id="042d1-169">Émettez le code pour initialiser la variable `index`, en chargeant un entier 0 32 bits et en le stockant dans la variable.</span><span class="sxs-lookup"><span data-stu-id="042d1-169">Emit code to initialize the `index` variable, by loading a 32-bit integer 0 and storing it in the variable.</span></span> <span data-ttu-id="042d1-170">Émettez du code pour créer une branche vers l’étiquette `enterLoop`.</span><span class="sxs-lookup"><span data-stu-id="042d1-170">Emit code to branch to the label `enterLoop`.</span></span> <span data-ttu-id="042d1-171">Cette étiquette n’a pas encore été marquée, car elle est à l’intérieur de la boucle.</span><span class="sxs-lookup"><span data-stu-id="042d1-171">This label has not yet been marked, because it is inside the loop.</span></span> <span data-ttu-id="042d1-172">Le code de la boucle est émis à l’étape suivante.</span><span class="sxs-lookup"><span data-stu-id="042d1-172">Code for the loop is emitted in the next step.</span></span>

    [!code-csharp[GenericMethodHowTo#32](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#32)]
    [!code-vb[GenericMethodHowTo#32](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#32)]

6. <span data-ttu-id="042d1-173">Émettez le code de la boucle.</span><span class="sxs-lookup"><span data-stu-id="042d1-173">Emit code for the loop.</span></span> <span data-ttu-id="042d1-174">La première étape consiste à marquer le début de la boucle, en appelant <xref:System.Reflection.Emit.ILGenerator.MarkLabel%2A> avec l’étiquette `loopAgain`.</span><span class="sxs-lookup"><span data-stu-id="042d1-174">The first step is to mark the top of the loop, by calling <xref:System.Reflection.Emit.ILGenerator.MarkLabel%2A> with the `loopAgain` label.</span></span> <span data-ttu-id="042d1-175">Les instructions de branche qui utilisent l’étiquette créent désormais une branche vers ce point du code.</span><span class="sxs-lookup"><span data-stu-id="042d1-175">Branch statements that use the label will now branch to this point in the code.</span></span> <span data-ttu-id="042d1-176">L’étape suivante consiste à effectuer un push de l’objet `TOutput`, casté en `ICollection(Of TInput)`, dans la pile.</span><span class="sxs-lookup"><span data-stu-id="042d1-176">The next step is to push the `TOutput` object, cast to `ICollection(Of TInput)`, onto the stack.</span></span> <span data-ttu-id="042d1-177">Il n’est pas nécessaire immédiatement, mais doit être en position d’appeler la méthode `Add`.</span><span class="sxs-lookup"><span data-stu-id="042d1-177">It is not needed immediately, but needs to be in position for calling the `Add` method.</span></span> <span data-ttu-id="042d1-178">Ensuite, le tableau d’entrée fait l’objet d’un push dans la pile, puis c’est au tour de la variable `index` qui contient l’index actuel dans le tableau.</span><span class="sxs-lookup"><span data-stu-id="042d1-178">Next the input array is pushed onto the stack, then the `index` variable containing the current index into the array.</span></span> <span data-ttu-id="042d1-179">L’opcode <xref:System.Reflection.Emit.OpCodes.Ldelem> dépile l’index et le tableau et effectue un push de l’élément de tableau indexé dans la pile.</span><span class="sxs-lookup"><span data-stu-id="042d1-179">The <xref:System.Reflection.Emit.OpCodes.Ldelem> opcode pops the index and the array off the stack and pushes the indexed array element onto the stack.</span></span> <span data-ttu-id="042d1-180">La pile est maintenant prête pour l’appel à la méthode <xref:System.Collections.Generic.ICollection%601.Add%2A?displayProperty=nameWithType>, qui dépile la collection et le nouvel élément et ajoute l’élément à la collection.</span><span class="sxs-lookup"><span data-stu-id="042d1-180">The stack is now ready for the call to the <xref:System.Collections.Generic.ICollection%601.Add%2A?displayProperty=nameWithType> method, which pops the collection and the new element off the stack and adds the element to the collection.</span></span>

    <span data-ttu-id="042d1-181">Le reste du code dans la boucle incrémente l’index et vérifie si la boucle est finie : l’index et un entier 1 32 bits font l’objet d’un push dans la pile et sont additionnés, en laissant la somme dans la pile. La somme est stockée dans `index`.</span><span class="sxs-lookup"><span data-stu-id="042d1-181">The rest of the code in the loop increments the index and tests to see whether the loop is finished: The index and a 32-bit integer 1 are pushed onto the stack and added, leaving the sum on the stack; the sum is stored in `index`.</span></span> <span data-ttu-id="042d1-182"><xref:System.Reflection.Emit.ILGenerator.MarkLabel%2A> est appelé pour définir ce point comme point d’entrée pour la boucle.</span><span class="sxs-lookup"><span data-stu-id="042d1-182"><xref:System.Reflection.Emit.ILGenerator.MarkLabel%2A> is called to set this point as the entry point for the loop.</span></span> <span data-ttu-id="042d1-183">L’index est de nouveau chargé.</span><span class="sxs-lookup"><span data-stu-id="042d1-183">The index is loaded again.</span></span> <span data-ttu-id="042d1-184">Le tableau d’entrée fait l’objet d’un push dans la pile et <xref:System.Reflection.Emit.OpCodes.Ldlen> est émis pour obtenir sa longueur.</span><span class="sxs-lookup"><span data-stu-id="042d1-184">The input array is pushed on the stack, and <xref:System.Reflection.Emit.OpCodes.Ldlen> is emitted to get its length.</span></span> <span data-ttu-id="042d1-185">L’index et la longueur sont à présent dans la pile, et <xref:System.Reflection.Emit.OpCodes.Clt> est émis pour les comparer.</span><span class="sxs-lookup"><span data-stu-id="042d1-185">The index and the length are now on the stack, and <xref:System.Reflection.Emit.OpCodes.Clt> is emitted to compare them.</span></span> <span data-ttu-id="042d1-186">Si l’index est inférieur à la longueur, <xref:System.Reflection.Emit.OpCodes.Brtrue_S> crée une nouvelle branche vers le début de la boucle.</span><span class="sxs-lookup"><span data-stu-id="042d1-186">If the index is less than the length, <xref:System.Reflection.Emit.OpCodes.Brtrue_S> branches back to the beginning of the loop.</span></span>

    [!code-csharp[GenericMethodHowTo#13](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#13)]
    [!code-vb[GenericMethodHowTo#13](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#13)]

7. <span data-ttu-id="042d1-187">Émettez du code pour effectuer un push de l’objet `TOutput` dans la pile et obtenir un retour de la méthode.</span><span class="sxs-lookup"><span data-stu-id="042d1-187">Emit code to push the `TOutput` object onto the stack and return from the method.</span></span> <span data-ttu-id="042d1-188">Les variables locales `retVal` et `ic` contiennent toutes deux des références au nouveau `TOutput` ; `ic` est utilisé uniquement pour accéder à la méthode <xref:System.Collections.Generic.ICollection%601.Add%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="042d1-188">The local variables `retVal` and `ic` both contain references to the new `TOutput`; `ic` is used only to access the <xref:System.Collections.Generic.ICollection%601.Add%2A?displayProperty=nameWithType> method.</span></span>

    [!code-csharp[GenericMethodHowTo#33](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#33)]
    [!code-vb[GenericMethodHowTo#33](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#33)]

<a name="procedureSection2"></a>

### <a name="to-invoke-the-generic-method"></a><span data-ttu-id="042d1-189">Pour appeler la méthode générique</span><span class="sxs-lookup"><span data-stu-id="042d1-189">To invoke the generic method</span></span>

1. <span data-ttu-id="042d1-190">`Factory` est une définition de méthode générique.</span><span class="sxs-lookup"><span data-stu-id="042d1-190">`Factory` is a generic method definition.</span></span> <span data-ttu-id="042d1-191">Pour l’appeler, vous devez attribuer des types à ses paramètres de type générique.</span><span class="sxs-lookup"><span data-stu-id="042d1-191">In order to invoke it, you must assign types to its generic type parameters.</span></span> <span data-ttu-id="042d1-192">Pour ce faire, utilisez la méthode <xref:System.Reflection.MethodInfo.MakeGenericMethod%2A>.</span><span class="sxs-lookup"><span data-stu-id="042d1-192">Use the <xref:System.Reflection.MethodInfo.MakeGenericMethod%2A> method to do this.</span></span> <span data-ttu-id="042d1-193">Le code suivant crée une méthode générique construite, en spécifiant <xref:System.String> pour `TInput` et `List(Of String)` (`List<string>` en C#) pour `TOutput`, et il affiche une représentation sous forme de chaîne de la méthode.</span><span class="sxs-lookup"><span data-stu-id="042d1-193">The following code creates a constructed generic method, specifying <xref:System.String> for `TInput` and `List(Of String)` (`List<string>` in C#) for `TOutput`, and displays a string representation of the method.</span></span>

    [!code-csharp[GenericMethodHowTo#21](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#21)]
    [!code-vb[GenericMethodHowTo#21](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#21)]

2. <span data-ttu-id="042d1-194">Pour appeler la méthode avec liaison tardive, utilisez la méthode <xref:System.Reflection.MethodBase.Invoke%2A>.</span><span class="sxs-lookup"><span data-stu-id="042d1-194">To invoke the method late-bound, use the <xref:System.Reflection.MethodBase.Invoke%2A> method.</span></span> <span data-ttu-id="042d1-195">Le code suivant crée un tableau de <xref:System.Object> contenant pour seul élément un tableau de chaînes, et le passe en tant que liste d’arguments de la méthode générique.</span><span class="sxs-lookup"><span data-stu-id="042d1-195">The following code creates an array of <xref:System.Object>, containing as its only element an array of strings, and passes it as the argument list for the generic method.</span></span> <span data-ttu-id="042d1-196">Le premier paramètre de <xref:System.Reflection.MethodBase.Invoke%2A> est une référence null car la méthode est `static`.</span><span class="sxs-lookup"><span data-stu-id="042d1-196">The first parameter of <xref:System.Reflection.MethodBase.Invoke%2A> is a null reference because the method is `static`.</span></span> <span data-ttu-id="042d1-197">La valeur de retour est castée en `List(Of String)` et son premier élément est affiché.</span><span class="sxs-lookup"><span data-stu-id="042d1-197">The return value is cast to `List(Of String)`, and its first element is displayed.</span></span>

    [!code-csharp[GenericMethodHowTo#22](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#22)]
    [!code-vb[GenericMethodHowTo#22](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#22)]

3. <span data-ttu-id="042d1-198">Pour appeler la méthode à l’aide d’un délégué, vous devez avoir un délégué qui correspond à la signature de la méthode générique construite.</span><span class="sxs-lookup"><span data-stu-id="042d1-198">To invoke the method using a delegate, you must have a delegate that matches the signature of the constructed generic method.</span></span> <span data-ttu-id="042d1-199">Pour cela, une solution simple consiste à créer un délégué générique.</span><span class="sxs-lookup"><span data-stu-id="042d1-199">An easy way to do this is to create a generic delegate.</span></span> <span data-ttu-id="042d1-200">Le code suivant crée une instance du délégué générique `D` défini dans l’exemple de code, à l’aide de la surcharge de méthode <xref:System.Delegate.CreateDelegate%28System.Type%2CSystem.Reflection.MethodInfo%29?displayProperty=nameWithType>, et appelle le délégué.</span><span class="sxs-lookup"><span data-stu-id="042d1-200">The following code creates an instance of the generic delegate `D` defined in the example code, using the <xref:System.Delegate.CreateDelegate%28System.Type%2CSystem.Reflection.MethodInfo%29?displayProperty=nameWithType> method overload, and invokes the delegate.</span></span> <span data-ttu-id="042d1-201">Les délégués sont plus performants que les appels à liaison tardive.</span><span class="sxs-lookup"><span data-stu-id="042d1-201">Delegates perform better than late-bound calls.</span></span>

    [!code-csharp[GenericMethodHowTo#23](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#23)]
    [!code-vb[GenericMethodHowTo#23](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#23)]

4. <span data-ttu-id="042d1-202">La méthode émise peut également être appelée à partir d’un programme qui fait référence à l’assembly enregistré.</span><span class="sxs-lookup"><span data-stu-id="042d1-202">The emitted method can also be called from a program that refers to the saved assembly.</span></span>

## <a name="example"></a><span data-ttu-id="042d1-203">Exemple</span><span class="sxs-lookup"><span data-stu-id="042d1-203">Example</span></span>

<span data-ttu-id="042d1-204">L’exemple de code suivant crée un type non générique, `DemoType`, avec une méthode générique, `Factory`.</span><span class="sxs-lookup"><span data-stu-id="042d1-204">The following code example creates a nongeneric type, `DemoType`, with a generic method, `Factory`.</span></span> <span data-ttu-id="042d1-205">Cette méthode a deux paramètres de type générique, `TInput` pour spécifier un type d’entrée et `TOutput` pour spécifier un type de sortie.</span><span class="sxs-lookup"><span data-stu-id="042d1-205">This method has two generic type parameters, `TInput` to specify an input type and `TOutput` to specify an output type.</span></span> <span data-ttu-id="042d1-206">Pour implémenter `ICollection<TInput>` (`ICollection(Of TInput)` en Visual Basic), le paramètre de type `TOutput` a deux contraintes : être un type référence et avoir un constructeur sans paramètre.</span><span class="sxs-lookup"><span data-stu-id="042d1-206">The `TOutput` type parameter is constrained to implement `ICollection<TInput>` (`ICollection(Of TInput)` in Visual Basic), to be a reference type, and to have a parameterless constructor.</span></span>

<span data-ttu-id="042d1-207">La méthode a un paramètre formel, qui est un tableau de `TInput`.</span><span class="sxs-lookup"><span data-stu-id="042d1-207">The method has one formal parameter, which is an array of `TInput`.</span></span> <span data-ttu-id="042d1-208">La méthode retourne une instance de `TOutput` qui contient tous les éléments du tableau d’entrée.</span><span class="sxs-lookup"><span data-stu-id="042d1-208">The method returns an instance of `TOutput` that contains all the elements of the input array.</span></span> <span data-ttu-id="042d1-209">`TOutput` peut être n’importe quel type de collection générique qui implémente l’interface générique <xref:System.Collections.Generic.ICollection%601>.</span><span class="sxs-lookup"><span data-stu-id="042d1-209">`TOutput` can be any generic collection type that implements the <xref:System.Collections.Generic.ICollection%601> generic interface.</span></span>

<span data-ttu-id="042d1-210">Quand le code est exécuté, l’assembly dynamique est enregistré en tant que DemoGenericMethod1.dll, et peut être examiné à l’aide de [Ildasm.exe (désassembleur IL)](../tools/ildasm-exe-il-disassembler.md).</span><span class="sxs-lookup"><span data-stu-id="042d1-210">When the code is executed, the dynamic assembly is saved as DemoGenericMethod1.dll, and can be examined using the [Ildasm.exe (IL Disassembler)](../tools/ildasm-exe-il-disassembler.md).</span></span>

> [!NOTE]
> <span data-ttu-id="042d1-211">Pour apprendre comment émettre du code, une méthode efficace consiste à écrire un programme Visual Basic, C# ou Visual C++ qui effectue la tâche que vous tentez d’émettre, et à utiliser le désassembleur pour examiner le code MSIL produit par le compilateur.</span><span class="sxs-lookup"><span data-stu-id="042d1-211">A good way to learn how to emit code is to write a Visual Basic, C#, or Visual C++ program that performs the task you are trying to emit, and use the disassembler to examine the MSIL produced by the compiler.</span></span>

<span data-ttu-id="042d1-212">L’exemple de code inclut du code source équivalent à la méthode émise.</span><span class="sxs-lookup"><span data-stu-id="042d1-212">The code example includes source code that is equivalent to the emitted method.</span></span> <span data-ttu-id="042d1-213">La méthode émise est appelée avec liaison tardive, et également à l’aide d’un délégué générique déclaré dans l’exemple de code.</span><span class="sxs-lookup"><span data-stu-id="042d1-213">The emitted method is invoked late-bound and also by using a generic delegate declared in the code example.</span></span>

[!code-csharp[GenericMethodHowTo#1](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#1)]
[!code-vb[GenericMethodHowTo#1](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#1)]

## <a name="see-also"></a><span data-ttu-id="042d1-214">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="042d1-214">See also</span></span>

- <xref:System.Reflection.Emit.MethodBuilder>
- [<span data-ttu-id="042d1-215">Guide pratique pour définir un type générique avec l'émission de réflexion</span><span class="sxs-lookup"><span data-stu-id="042d1-215">How to: Define a Generic Type with Reflection Emit</span></span>](how-to-define-a-generic-type-with-reflection-emit.md)
