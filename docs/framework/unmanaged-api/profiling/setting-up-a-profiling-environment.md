---
title: Configuration d'un environnement de profilage
ms.date: 03/30/2017
helpviewer_keywords:
- environment variables, profiling API
- profiling API [.NET Framework], setting up environment
- COR_PROFILER environment variable
- Windows Service applications, profiling
- profiling API [.NET Framework], Windows Service applications
- COR_ENABLE_PROFILING environment variable
- profiling API [.NET Framework], enabling
ms.assetid: fefca07f-7555-4e77-be86-3c542e928312
ms.openlocfilehash: 9c712c5efe8d6d79454b70d0bf4f3ca2fa83b637
ms.sourcegitcommit: d8020797a6657d0fbbdff362b80300815f682f94
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 11/24/2020
ms.locfileid: "95722477"
---
# <a name="setting-up-a-profiling-environment"></a><span data-ttu-id="852d8-102">Configuration d'un environnement de profilage</span><span class="sxs-lookup"><span data-stu-id="852d8-102">Setting Up a Profiling Environment</span></span>

> [!NOTE]
> <span data-ttu-id="852d8-103">Des modifications substantielles ont été apportées au profilage dans le .NET Framework 4.</span><span class="sxs-lookup"><span data-stu-id="852d8-103">There have been substantial changes to profiling in the .NET Framework 4.</span></span>  
  
 <span data-ttu-id="852d8-104">Quand un processus managé (application ou service) démarre, il charge le Common Language Runtime (CLR).</span><span class="sxs-lookup"><span data-stu-id="852d8-104">When a managed process (application or service) starts, it loads the common language runtime (CLR).</span></span> <span data-ttu-id="852d8-105">Quand le CLR est initialisé, il évalue les deux variables environnementales suivantes afin de déterminer si le processus doit se connecter à un profileur :</span><span class="sxs-lookup"><span data-stu-id="852d8-105">When the CLR is initialized, it evaluates the following two environmental variables to decide whether the process should connect to a profiler:</span></span>  
  
- <span data-ttu-id="852d8-106">COR_ENABLE_PROFILING : le CLR se connecte à un profileur uniquement si cette variable d'environnement existe et que sa valeur est 1.</span><span class="sxs-lookup"><span data-stu-id="852d8-106">COR_ENABLE_PROFILING: The CLR connects to a profiler only if this environment variable exists and is set to 1.</span></span>  
  
- <span data-ttu-id="852d8-107">COR_PROFILER : si la vérification COR_ENABLE_PROFILING réussit, le CLR se connecte au profileur qui a ce CLSID ou ProgID, lequel doit avoir été stocké précédemment dans le Registre.</span><span class="sxs-lookup"><span data-stu-id="852d8-107">COR_PROFILER: If the COR_ENABLE_PROFILING check passes, the CLR connects to the profiler that has this CLSID or ProgID, which must have been stored previously in the registry.</span></span> <span data-ttu-id="852d8-108">La variable d'environnement COR_PROFILER est définie en tant que chaîne, comme indiqué dans les deux exemples suivants.</span><span class="sxs-lookup"><span data-stu-id="852d8-108">The COR_PROFILER environment variable is defined as a string, as shown in the following two examples.</span></span>  
  
    ```cpp  
    set COR_PROFILER={32E2F4DA-1BEA-47ea-88F9-C5DAF691C94A}  
    set COR_PROFILER="MyProfiler"  
    ```  
  
 <span data-ttu-id="852d8-109">Pour profiler une application CLR, vous devez définir les variables d'environnement COR_ENABLE_PROFILING et COR_PROFILER avant d'exécuter l'application.</span><span class="sxs-lookup"><span data-stu-id="852d8-109">To profile a CLR application, you must set the COR_ENABLE_PROFILING and COR_PROFILER environment variables before you run the application.</span></span> <span data-ttu-id="852d8-110">Vous devez également vous assurer que la DLL du profileur est enregistrée.</span><span class="sxs-lookup"><span data-stu-id="852d8-110">You must also make sure that the profiler DLL is registered.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="852d8-111">À partir du .NET Framework 4, il n’est pas nécessaire d’inscrire les profileurs.</span><span class="sxs-lookup"><span data-stu-id="852d8-111">Starting with the .NET Framework 4, profilers do not have to be registered.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="852d8-112">Pour utiliser .NET Framework les versions 2,0, 3,0 et 3,5 des profileurs dans le .NET Framework 4 et versions ultérieures, vous devez définir la variable d’environnement COMPLUS_ProfAPI_ProfilerCompatibilitySetting.</span><span class="sxs-lookup"><span data-stu-id="852d8-112">To use .NET Framework versions 2.0, 3.0, and 3.5 profilers in the .NET Framework 4 and later versions, you must set the COMPLUS_ProfAPI_ProfilerCompatibilitySetting environment variable.</span></span>  
  
## <a name="environment-variable-scope"></a><span data-ttu-id="852d8-113">Étendue de la variable d'environnement</span><span class="sxs-lookup"><span data-stu-id="852d8-113">Environment Variable Scope</span></span>  

 <span data-ttu-id="852d8-114">La manière dont vous définissez les variables d'environnement COR_ENABLE_PROFILING et COR_PROFILER déterminent leur champ d'influence.</span><span class="sxs-lookup"><span data-stu-id="852d8-114">How you set the COR_ENABLE_PROFILING and COR_PROFILER environment variables will determine their scope of influence.</span></span> <span data-ttu-id="852d8-115">Vous pouvez définir ces variables de l'une des manières suivantes :</span><span class="sxs-lookup"><span data-stu-id="852d8-115">You can set these variables in one of the following ways:</span></span>  
  
- <span data-ttu-id="852d8-116">Si vous définissez les variables dans un appel [ICorDebug :: CreateProcess](../debugging/icordebug-createprocess-method.md) , elles s’appliquent uniquement à l’application que vous exécutez à ce moment-là.</span><span class="sxs-lookup"><span data-stu-id="852d8-116">If you set the variables in an [ICorDebug::CreateProcess](../debugging/icordebug-createprocess-method.md) call, they will apply only to the application that you are running at the time.</span></span> <span data-ttu-id="852d8-117">(Elles s'appliquent également aux autres applications démarrées par l'application qui héritent de l'environnement.)</span><span class="sxs-lookup"><span data-stu-id="852d8-117">(They will also apply to other applications started by that application that inherit the environment.)</span></span>  
  
- <span data-ttu-id="852d8-118">Si vous définissez les variables dans une fenêtre d'invite de commandes, elles s'appliquent à toutes les applications démarrées à partir de cette fenêtre.</span><span class="sxs-lookup"><span data-stu-id="852d8-118">If you set the variables in a Command Prompt window, they will apply to all applications that are started from that window.</span></span>  
  
- <span data-ttu-id="852d8-119">Si vous définissez les variables au niveau de l'utilisateur, elles s'appliquent à toutes les applications que vous démarrez avec l'Explorateur de fichiers.</span><span class="sxs-lookup"><span data-stu-id="852d8-119">If you set the variables at the user level, they will apply to all applications that you start with File Explorer.</span></span> <span data-ttu-id="852d8-120">Une fenêtre d'invite de commandes que vous ouvrez après avoir défini les variables présente ces paramètres d'environnement à l'instar de toute application que vous démarrez à partir de cette fenêtre.</span><span class="sxs-lookup"><span data-stu-id="852d8-120">A Command Prompt window that you open after you set the variables will have these environment settings, and so will any application that you start from that window.</span></span> <span data-ttu-id="852d8-121">Pour définir des variables d’environnement au niveau de l’utilisateur, cliquez avec le bouton droit sur **poste de travail**, cliquez sur **Propriétés**, cliquez sur l’onglet **avancé** , cliquez sur **variables d’environnement**, puis ajoutez les variables à la liste **variables utilisateur** .</span><span class="sxs-lookup"><span data-stu-id="852d8-121">To set environment variables at the user level, right-click **My Computer**, click **Properties**, click the **Advanced** tab, click **Environment Variables**, and add the variables to the **User variables** list.</span></span>  
  
- <span data-ttu-id="852d8-122">Si vous définissez les variables au niveau de l'ordinateur, elles s'appliquent à toutes les applications démarrées sur cet ordinateur.</span><span class="sxs-lookup"><span data-stu-id="852d8-122">If you set the variables at the computer level, they will apply to all applications that are started on that computer.</span></span> <span data-ttu-id="852d8-123">Une fenêtre d'invite de commandes que vous ouvrez sur cet ordinateur présente ces paramètres d'environnement à l'instar de toute application que vous démarrez à partir de cette fenêtre.</span><span class="sxs-lookup"><span data-stu-id="852d8-123">A Command Prompt window that you open on that computer will have these environment settings, and so will any application that you start from that window.</span></span> <span data-ttu-id="852d8-124">Cela signifie que chaque processus managé sur cet ordinateur démarre avec votre profileur.</span><span class="sxs-lookup"><span data-stu-id="852d8-124">This means that every managed process on that computer will start with your profiler.</span></span> <span data-ttu-id="852d8-125">Pour définir des variables d’environnement au niveau de l’ordinateur, cliquez avec le bouton droit sur **poste de travail**, cliquez sur **Propriétés**, cliquez sur l’onglet **avancé** , cliquez sur **variables d’environnement**, ajoutez les variables à la liste **variables système** , puis redémarrez votre ordinateur.</span><span class="sxs-lookup"><span data-stu-id="852d8-125">To set environment variables at the computer level, right-click **My Computer**, click **Properties**, click the **Advanced** tab, click **Environment Variables**, add the variables to the **System variables** list, and then restart your computer.</span></span> <span data-ttu-id="852d8-126">Après le redémarrage, les variables sont disponibles à l'échelle du système.</span><span class="sxs-lookup"><span data-stu-id="852d8-126">After restarting, the variables will be available system-wide.</span></span>  
  
 <span data-ttu-id="852d8-127">Si vous profilez un service Windows, vous devez redémarrer votre ordinateur après avoir défini les variables d'environnement et inscrit la DLL du profileur.</span><span class="sxs-lookup"><span data-stu-id="852d8-127">If you are profiling a Windows Service, you must restart your computer after you set the environment variables and register the profiler DLL.</span></span> <span data-ttu-id="852d8-128">Pour plus d’informations sur ces considérations, consultez la section [profilage d’un service Windows](#windows_service).</span><span class="sxs-lookup"><span data-stu-id="852d8-128">For more information about these considerations, see the section [Profiling a Windows Service](#windows_service).</span></span>  
  
## <a name="additional-considerations"></a><span data-ttu-id="852d8-129">Considérations supplémentaires</span><span class="sxs-lookup"><span data-stu-id="852d8-129">Additional Considerations</span></span>  
  
- <span data-ttu-id="852d8-130">La classe de profileur implémente les interfaces [ICorProfilerCallback](icorprofilercallback-interface.md) et [ICorProfilerCallback2](icorprofilercallback2-interface.md) .</span><span class="sxs-lookup"><span data-stu-id="852d8-130">The profiler class implements the [ICorProfilerCallback](icorprofilercallback-interface.md) and [ICorProfilerCallback2](icorprofilercallback2-interface.md) interfaces.</span></span> <span data-ttu-id="852d8-131">Dans le .NET Framework version 2.0, un profileur doit implémenter `ICorProfilerCallback2`.</span><span class="sxs-lookup"><span data-stu-id="852d8-131">In the .NET Framework version 2.0, a profiler must implement `ICorProfilerCallback2`.</span></span> <span data-ttu-id="852d8-132">Dans ce cas, `ICorProfilerCallback2` ne sera pas chargé.</span><span class="sxs-lookup"><span data-stu-id="852d8-132">If it does not, `ICorProfilerCallback2` will not be loaded.</span></span>  
  
- <span data-ttu-id="852d8-133">Un seul profileur peut profiler un processus à la fois dans un environnement donné.</span><span class="sxs-lookup"><span data-stu-id="852d8-133">Only one profiler can profile a process at one time in a given environment.</span></span> <span data-ttu-id="852d8-134">Vous pouvez inscrire deux profileurs différents dans des environnements différents, mais chacun doit profiler des processus distincts.</span><span class="sxs-lookup"><span data-stu-id="852d8-134">You can register two different profilers in different environments, but each must profile separate processes.</span></span> <span data-ttu-id="852d8-135">Le profileur doit être implémenté en tant que DLL de serveur COM in-process, mappée dans le même espace d'adressage que le processus en cours de profilage.</span><span class="sxs-lookup"><span data-stu-id="852d8-135">The profiler must be implemented as an in-process COM server DLL, which is mapped into the same address space as the process that is being profiled.</span></span> <span data-ttu-id="852d8-136">Cela signifie que le profileur s'exécute in-process.</span><span class="sxs-lookup"><span data-stu-id="852d8-136">This means that the profiler runs in-process.</span></span> <span data-ttu-id="852d8-137">Le .NET Framework ne prend pas en charge un autre type de serveur COM.</span><span class="sxs-lookup"><span data-stu-id="852d8-137">The .NET Framework does not support any other type of COM server.</span></span> <span data-ttu-id="852d8-138">Par exemple, si un profileur souhaite surveiller des applications à partir d'un ordinateur distant, il doit implémenter des agents collecteurs sur chaque ordinateur.</span><span class="sxs-lookup"><span data-stu-id="852d8-138">For example, if a profiler wants to monitor applications from a remote computer, it must implement collector agents on each computer.</span></span> <span data-ttu-id="852d8-139">Ces agents traitent les résultats par lots et les communiquent à l’ordinateur de collection de données central.</span><span class="sxs-lookup"><span data-stu-id="852d8-139">These agents will batch results and communicate them to the central data collection computer.</span></span>  
  
- <span data-ttu-id="852d8-140">Étant donné que le profileur est un objet COM instancié in-process, chaque application profilée possède sa propre copie du profileur.</span><span class="sxs-lookup"><span data-stu-id="852d8-140">Because the profiler is a COM object that is instantiated in-process, each profiled application will have its own copy of the profiler.</span></span> <span data-ttu-id="852d8-141">Par conséquent, une instance de profileur particulière n'a pas à gérer les données de plusieurs applications.</span><span class="sxs-lookup"><span data-stu-id="852d8-141">Therefore, a single profiler instance does not have to handle data from multiple applications.</span></span> <span data-ttu-id="852d8-142">Toutefois, vous devrez ajouter une logique au code de journalisation du profileur pour éviter le remplacement du fichier journal d'autres applications profilées.</span><span class="sxs-lookup"><span data-stu-id="852d8-142">However, you will have to add logic to the profiler's logging code to prevent log file overwrites from other profiled applications.</span></span>  
  
## <a name="initializing-the-profiler"></a><span data-ttu-id="852d8-143">Initialisation du profileur</span><span class="sxs-lookup"><span data-stu-id="852d8-143">Initializing the Profiler</span></span>  

 <span data-ttu-id="852d8-144">Quand les deux vérifications de variables d'environnement réussissent, le CLR crée une instance du profileur d'une manière similaire à la fonction `CoCreateInstance` COM.</span><span class="sxs-lookup"><span data-stu-id="852d8-144">When both environment variable checks pass, the CLR creates an instance of the profiler in a similar manner to the COM `CoCreateInstance` function.</span></span> <span data-ttu-id="852d8-145">Le profileur n'est pas chargé via un appel direct à `CoCreateInstance`.</span><span class="sxs-lookup"><span data-stu-id="852d8-145">The profiler is not loaded through a direct call to `CoCreateInstance`.</span></span> <span data-ttu-id="852d8-146">Par conséquent, un appel à `CoInitialize`, qui requiert la définition du modèle de thread, est évité.</span><span class="sxs-lookup"><span data-stu-id="852d8-146">Therefore, a call to `CoInitialize`, which requires setting the threading model, is avoided.</span></span> <span data-ttu-id="852d8-147">Le CLR appelle ensuite la méthode [ICorProfilerCallback :: Initialize](icorprofilercallback-initialize-method.md) dans le profileur.</span><span class="sxs-lookup"><span data-stu-id="852d8-147">The CLR then calls the [ICorProfilerCallback::Initialize](icorprofilercallback-initialize-method.md) method in the profiler.</span></span> <span data-ttu-id="852d8-148">La signature de cette méthode est la suivante.</span><span class="sxs-lookup"><span data-stu-id="852d8-148">The signature of this method is as follows.</span></span>  
  
```cpp  
HRESULT Initialize(IUnknown *pICorProfilerInfoUnk)  
```  
  
 <span data-ttu-id="852d8-149">Le profileur doit interroger `pICorProfilerInfoUnk` un pointeur d’interface [ICorProfilerInfo](icorprofilerinfo-interface.md) ou [ICorProfilerInfo2](icorprofilerinfo2-interface.md) et l’enregistrer afin qu’il puisse demander plus d’informations ultérieurement au cours du profilage.</span><span class="sxs-lookup"><span data-stu-id="852d8-149">The profiler must query `pICorProfilerInfoUnk` for an [ICorProfilerInfo](icorprofilerinfo-interface.md) or [ICorProfilerInfo2](icorprofilerinfo2-interface.md) interface pointer and save it so that it can request more information later during profiling.</span></span>  
  
## <a name="setting-event-notifications"></a><span data-ttu-id="852d8-150">Définition de notifications d'événements</span><span class="sxs-lookup"><span data-stu-id="852d8-150">Setting Event Notifications</span></span>  

 <span data-ttu-id="852d8-151">Le profileur appelle ensuite la méthode [ICorProfilerInfo :: SetEventMask](icorprofilerinfo-seteventmask-method.md) pour spécifier les catégories de notifications qui l’intéressent.</span><span class="sxs-lookup"><span data-stu-id="852d8-151">The profiler then calls the [ICorProfilerInfo::SetEventMask](icorprofilerinfo-seteventmask-method.md) method to specify which categories of notifications it is interested in.</span></span> <span data-ttu-id="852d8-152">Par exemple, si le profileur s’intéresse uniquement aux notifications d’entrée et de sortie de fonction, ainsi qu’aux notifications de garbage collection, il spécifie ce qui suit.</span><span class="sxs-lookup"><span data-stu-id="852d8-152">For example, if the profiler is interested only in function enter and leave notifications and garbage collection notifications, it specifies the following.</span></span>  
  
```cpp  
ICorProfilerInfo* pInfo;  
pICorProfilerInfoUnk->QueryInterface(IID_ICorProfilerInfo, (void**)&pInfo);  
pInfo->SetEventMask(COR_PRF_MONITOR_ENTERLEAVE | COR_PRF_MONITOR_GC)  
```  
  
 <span data-ttu-id="852d8-153">En définissant le masque des notifications de cette manière, le profileur peut limiter les notifications qu'il reçoit.</span><span class="sxs-lookup"><span data-stu-id="852d8-153">By setting the notifications mask in this manner, the profiler can limit which notifications it receives.</span></span> <span data-ttu-id="852d8-154">Cette approche permet à l'utilisateur de générer un profileur simple ou à but spécifique.</span><span class="sxs-lookup"><span data-stu-id="852d8-154">This approach helps the user build a simple or special-purpose profiler.</span></span> <span data-ttu-id="852d8-155">Elle réduit également le temps processeur qui serait gaspillé en envoyant des notifications qui ne seraient qu'ignorées par le profileur.</span><span class="sxs-lookup"><span data-stu-id="852d8-155">It also reduces CPU time that would be wasted sending notifications that the profiler would just ignore.</span></span>  
  
 <span data-ttu-id="852d8-156">Certains événements de profileur sont immuables.</span><span class="sxs-lookup"><span data-stu-id="852d8-156">Certain profiler events are immutable.</span></span> <span data-ttu-id="852d8-157">Cela signifie que, dès que ces événements sont définis dans le rappel `ICorProfilerCallback::Initialize`, ils ne peuvent pas être désactivés et aucun nouvel événement ne peut être activé.</span><span class="sxs-lookup"><span data-stu-id="852d8-157">This means that as soon as these events are set in the `ICorProfilerCallback::Initialize` callback, they cannot be turned off and new events cannot be turned on.</span></span> <span data-ttu-id="852d8-158">Toute tentative de modification d'un événement immuable entraîne le retour d'un HRESULT d'échec par `ICorProfilerInfo::SetEventMask`.</span><span class="sxs-lookup"><span data-stu-id="852d8-158">Attempts to change an immutable event will result in `ICorProfilerInfo::SetEventMask` returning a failed HRESULT.</span></span>  
  
<a name="windows_service"></a>

## <a name="profiling-a-windows-service"></a><span data-ttu-id="852d8-159">Profilage d'un service Windows</span><span class="sxs-lookup"><span data-stu-id="852d8-159">Profiling a Windows Service</span></span>  

 <span data-ttu-id="852d8-160">Le profilage d'un service Windows s'apparente au profilage d'une application du Common Language Runtime.</span><span class="sxs-lookup"><span data-stu-id="852d8-160">Profiling a Windows Service is like profiling a common language runtime application.</span></span> <span data-ttu-id="852d8-161">Les deux opérations de profilage sont activées via des variables d'environnement.</span><span class="sxs-lookup"><span data-stu-id="852d8-161">Both profiling operations are enabled through environment variables.</span></span> <span data-ttu-id="852d8-162">Étant donné qu'un service Windows démarre au démarrage du système d'exploitation, les variables d'environnement décrites précédemment dans cette rubrique doivent déjà être présentes et définies sur les valeurs requises avant le démarrage du système.</span><span class="sxs-lookup"><span data-stu-id="852d8-162">Because a Windows Service is started when the operating system starts, the environment variables discussed previously in this topic must already be present and set to the required values before the system starts.</span></span> <span data-ttu-id="852d8-163">En outre, la DLL de profilage doit déjà être enregistrée sur le système.</span><span class="sxs-lookup"><span data-stu-id="852d8-163">In addition, the profiling DLL must already be registered on the system.</span></span>  
  
 <span data-ttu-id="852d8-164">Après avoir défini les variables d'environnement COR_ENABLE_PROFILING et COR_PROFILER, puis inscrit la DLL du profileur, vous devez redémarrer l'ordinateur cible pour que le service Windows puisse détecter ces modifications.</span><span class="sxs-lookup"><span data-stu-id="852d8-164">After you set the COR_ENABLE_PROFILING and COR_PROFILER environment variables and register the profiler DLL, you should restart the target computer so that the Windows Service can detect those changes.</span></span>  
  
 <span data-ttu-id="852d8-165">Notez que ces modifications activent le profilage à l'échelle du système.</span><span class="sxs-lookup"><span data-stu-id="852d8-165">Note that these changes will enable profiling on a system-wide basis.</span></span> <span data-ttu-id="852d8-166">Pour empêcher le profilage de chaque application managée qui s'exécute par la suite, vous devez supprimer les variables d'environnement système après le redémarrage de l'ordinateur cible.</span><span class="sxs-lookup"><span data-stu-id="852d8-166">To prevent every managed application that subsequently runs from being profiled, you should delete the system environment variables after you restart the target computer.</span></span>  
  
 <span data-ttu-id="852d8-167">Cette technique entraîne également le profilage de chaque processus CLR.</span><span class="sxs-lookup"><span data-stu-id="852d8-167">This technique also leads to every CLR process getting profiled.</span></span> <span data-ttu-id="852d8-168">Le profileur doit ajouter la logique à son rappel [ICorProfilerCallback :: Initialize](icorprofilercallback-initialize-method.md) pour détecter si le processus actuel présente un intérêt.</span><span class="sxs-lookup"><span data-stu-id="852d8-168">The profiler should add logic to its [ICorProfilerCallback::Initialize](icorprofilercallback-initialize-method.md) callback to detect whether the current process is of interest.</span></span> <span data-ttu-id="852d8-169">Si ce n'est pas le cas, le profileur peut faire échouer le rappel sans exécuter l'initialisation.</span><span class="sxs-lookup"><span data-stu-id="852d8-169">If it is not, the profiler can fail the callback without performing the initialization.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="852d8-170">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="852d8-170">See also</span></span>

- [<span data-ttu-id="852d8-171">Vue d’ensemble du profilage</span><span class="sxs-lookup"><span data-stu-id="852d8-171">Profiling Overview</span></span>](profiling-overview.md)
