---
title: Assistant Débogage managé loaderLock
description: Passez en revue l’Assistant Débogage managé (MDA) loaderLock dans .NET, qui détecte les tentatives d’exécution du code managé sur un thread détenant le verrou du chargeur du système d’exploitation Windows.
ms.date: 03/30/2017
helpviewer_keywords:
- deadlocks [.NET Framework]
- LoaderLock MDA
- MDAs (managed debugging assistants), loader locks
- managed debugging assistants (MDAs), loader locks
- operating system loader locks
- loader locks
- locks, threads
ms.assetid: 8c10fa02-1b9c-4be5-ab03-451d943ac1ee
ms.openlocfilehash: 055b07a805c5f0b613519d6019950a9b249a4b38
ms.sourcegitcommit: 0edbeb66d71b8df10fcb374cfca4d731b58ccdb2
ms.contentlocale: fr-FR
ms.lasthandoff: 07/07/2020
ms.locfileid: "86051620"
---
# <a name="loaderlock-mda"></a><span data-ttu-id="93b19-103">Assistant Débogage managé loaderLock</span><span class="sxs-lookup"><span data-stu-id="93b19-103">loaderLock MDA</span></span>
<span data-ttu-id="93b19-104">L’Assistant Débogage managé `loaderLock` détecte les tentatives d’exécution de code managé sur un thread qui détient le verrou du chargeur du système d’exploitation Microsoft Windows.</span><span class="sxs-lookup"><span data-stu-id="93b19-104">The `loaderLock` managed debugging assistant (MDA) detects attempts to execute managed code on a thread that holds the Microsoft Windows operating system loader lock.</span></span>  <span data-ttu-id="93b19-105">Toute exécution de ce type est interdite, car elle peut entraîner des interblocages et l’utilisation de DLL avant leur initialisation par le chargeur du système d’exploitation.</span><span class="sxs-lookup"><span data-stu-id="93b19-105">Any such execution is illegal because it can lead to deadlocks and to use of DLLs before they have been initialized by the operating system's loader.</span></span>  
  
## <a name="symptoms"></a><span data-ttu-id="93b19-106">Symptômes</span><span class="sxs-lookup"><span data-stu-id="93b19-106">Symptoms</span></span>  
 <span data-ttu-id="93b19-107">L’échec le plus courant lors de l’exécution de code à l’intérieur du verrou du chargeur du système d’exploitation est l’interblocage des threads quand vous tentez d’appeler d’autres fonctions Win32 qui nécessitent également le verrou du chargeur.</span><span class="sxs-lookup"><span data-stu-id="93b19-107">The most common failure when executing code inside the operating system's loader lock is that threads will deadlock when attempting to call other Win32 functions that also require the loader lock.</span></span>  <span data-ttu-id="93b19-108">`LoadLibrary`, `GetProcAddress`, `FreeLibrary` et `GetModuleHandle` sont des exemples de ces fonctions.</span><span class="sxs-lookup"><span data-stu-id="93b19-108">Examples of such functions are `LoadLibrary`, `GetProcAddress`, `FreeLibrary`, and `GetModuleHandle`.</span></span>  <span data-ttu-id="93b19-109">L’application ne devrait pas appeler directement ces fonctions ; le common language runtime devrait appeler ces fonctions à la suite d’un appel de niveau supérieur, comme <xref:System.Reflection.Assembly.Load%2A>, ou comme premier appel à une méthode d’appel de code non managé.</span><span class="sxs-lookup"><span data-stu-id="93b19-109">The application might not directly call these functions; the common language runtime (CLR) might call these functions as the result of a higher level call like <xref:System.Reflection.Assembly.Load%2A> or the first call to a platform invoke method.</span></span>  
  
 <span data-ttu-id="93b19-110">Des interblocages peuvent également se produire si un thread attend le début ou la fin d’un autre thread.</span><span class="sxs-lookup"><span data-stu-id="93b19-110">Deadlocks can also occur if a thread is waiting for another thread to start or finish.</span></span>  <span data-ttu-id="93b19-111">Quand l’exécution d’un thread démarre ou se termine, celui-ci doit acquérir le verrou du chargeur du système d’exploitation pour délivrer des événements aux DLL concernées.</span><span class="sxs-lookup"><span data-stu-id="93b19-111">When a thread starts or finishes executing, it must acquire the operating system's loader lock to deliver events to affected DLLs.</span></span>  
  
 <span data-ttu-id="93b19-112">Enfin, il existe des cas où les appels dans des DLL peuvent se produire avant que ces DLL aient été correctement initialisées par le chargeur du système d’exploitation.</span><span class="sxs-lookup"><span data-stu-id="93b19-112">Finally, there are cases where calls into DLLs can occur before those DLLs have been properly initialized by the operating system's loader.</span></span>  <span data-ttu-id="93b19-113">Contrairement aux échecs d’interblocage, qui peuvent être diagnostiqués en examinant les piles de tous les threads impliqués dans l’interblocage, il est très difficile de diagnostiquer l’utilisation de DLL non initialisées sans utiliser cet Assistant Débogage managé.</span><span class="sxs-lookup"><span data-stu-id="93b19-113">Unlike the deadlock failures, which can be diagnosed by examining the stacks of all the threads involved in the deadlock, it is very difficult to diagnose the use of uninitialized DLLs without using this MDA.</span></span>  
  
## <a name="cause"></a><span data-ttu-id="93b19-114">Cause</span><span class="sxs-lookup"><span data-stu-id="93b19-114">Cause</span></span>  
 <span data-ttu-id="93b19-115">Les assemblys C++ mixtes managés/non managés conçus pour le .NET Framework 1.0 ou 1.1 tentent généralement d’exécuter le code au sein du verrou du chargeur, sauf s’ils ont fait l’objet d’une attention particulière, par exemple dans le cas où les liaisons ont été effectuées avec **/NOENTRY**.</span><span class="sxs-lookup"><span data-stu-id="93b19-115">Mixed managed/unmanaged C++ assemblies built for .NET Framework versions 1.0 or 1.1 generally attempt to execute managed code inside the loader lock unless special care has been taken, for example, linking with **/NOENTRY**.</span></span>
  
 <span data-ttu-id="93b19-116">Les assemblys C++ mixtes managés/non managés conçus pour le .NET Framework version 2.0 sont moins sujets à ces problèmes, car ils ont le même niveau de risque limité que les applications utilisant des DLL non managées qui ne respectent pas les règles du système d’exploitation.</span><span class="sxs-lookup"><span data-stu-id="93b19-116">Mixed managed/unmanaged C++ assemblies built for .NET Framework version 2.0 are less susceptible to these problems, having the same reduced risk as applications using unmanaged DLLs that violate the operating system's rules.</span></span>  <span data-ttu-id="93b19-117">Par exemple, si un point d’entrée `DllMain` d’une DLL non managée appelle `CoCreateInstance` pour obtenir un objet managé qui a été exposé à COM, le résultat est une tentative d’exécution de code managé au sein du verrou du chargeur.</span><span class="sxs-lookup"><span data-stu-id="93b19-117">For example, if an unmanaged DLL's `DllMain` entry point calls `CoCreateInstance` to obtain a managed object that has been exposed to COM, the result is an attempt to execute managed code inside the loader lock.</span></span> <span data-ttu-id="93b19-118">Pour plus d’informations sur les problèmes de verrou du chargeur dans le .NET Framework 2.0 et ultérieur, consultez [Initialisation des assemblys mixtes](/cpp/dotnet/initialization-of-mixed-assemblies).</span><span class="sxs-lookup"><span data-stu-id="93b19-118">For more information about loader lock issues in the .NET Framework version 2.0 and later, see [Initialization of Mixed Assemblies](/cpp/dotnet/initialization-of-mixed-assemblies).</span></span>  
  
## <a name="resolution"></a><span data-ttu-id="93b19-119">Résolution</span><span class="sxs-lookup"><span data-stu-id="93b19-119">Resolution</span></span>  
 <span data-ttu-id="93b19-120">Dans Visual C++ .NET 2002 et Visual C++ .NET 2003, les DLL compilées avec l’option de compilateur `/clr` pouvaient faire l’objet d’un interblocage non déterministe lors du chargement. On parlait dans ce cas de « problème de chargement de DLL mixtes » ou de « problème de verrou du chargeur ».</span><span class="sxs-lookup"><span data-stu-id="93b19-120">In Visual C++ .NET 2002 and Visual C++ .NET 2003, DLLs compiled with the `/clr` compiler option could non-deterministically deadlock when loaded; this issue was called the mixed DLL loading or loader lock issue.</span></span> <span data-ttu-id="93b19-121">Dans Visual C++ 2005, le non-déterminisme a été pratiquement supprimé du processus de chargement des DLL mixtes.</span><span class="sxs-lookup"><span data-stu-id="93b19-121">In Visual C++ 2005 and later, almost all non-determinism has been removed from the mixed DLL loading process.</span></span> <span data-ttu-id="93b19-122">Toutefois, il reste quelques scénarios dans lesquels le verrouillage du chargeur peut se produire (de façon déterministe).</span><span class="sxs-lookup"><span data-stu-id="93b19-122">However, there are a few remaining scenarios for which loader lock can (deterministically) occur.</span></span> <span data-ttu-id="93b19-123">Pour une liste détaillée des causes résiduelles et des solutions des problèmes de verrou du chargeur, consultez [Initialisation des assemblys mixtes](/cpp/dotnet/initialization-of-mixed-assemblies).</span><span class="sxs-lookup"><span data-stu-id="93b19-123">For a detailed account of the causes and resolutions for the remaining loader lock issues, see [Initialization of Mixed Assemblies](/cpp/dotnet/initialization-of-mixed-assemblies).</span></span> <span data-ttu-id="93b19-124">Si cette rubrique ne référence pas votre problème de verrouillage du chargeur, vous devez examiner la pile du thread pour déterminer la raison pour laquelle le verrouillage du chargeur se produit et comment résoudre le problème.</span><span class="sxs-lookup"><span data-stu-id="93b19-124">If that topic does not identify your loader lock problem, you have to examine the thread's stack to determine why the loader lock is occurring and how to correct the problem.</span></span> <span data-ttu-id="93b19-125">Examinez l’arborescence des appels de procédure pour le thread qui a activé cet Assistant Débogage managé.</span><span class="sxs-lookup"><span data-stu-id="93b19-125">Look at the stack trace for the thread that has activated this MDA.</span></span>  <span data-ttu-id="93b19-126">Le thread tente d’effectuer des appels interdits dans du code managé tout en maintenant le verrou du chargeur du système d’exploitation.</span><span class="sxs-lookup"><span data-stu-id="93b19-126">The thread is attempting to illegally call into managed code while holding the operating system's loader lock.</span></span>  <span data-ttu-id="93b19-127">Vous verrez probablement `DllMain` ou un point d’entrée équivalent de la DLL dans la pile.</span><span class="sxs-lookup"><span data-stu-id="93b19-127">You will probably see a DLL's `DllMain` or equivalent entry point on the stack.</span></span>  <span data-ttu-id="93b19-128">Les règles du système d’exploitation quant ce que vous êtes autorisé à faire depuis l’intérieur d’un point d’entrée de ce type sont assez limitées.</span><span class="sxs-lookup"><span data-stu-id="93b19-128">The operating system's rules for what you can legally do from inside such an entry point are quite limited.</span></span>  <span data-ttu-id="93b19-129">Ces règles interdisent toute exécution managée.</span><span class="sxs-lookup"><span data-stu-id="93b19-129">These rules preclude any managed execution.</span></span>  
  
## <a name="effect-on-the-runtime"></a><span data-ttu-id="93b19-130">Effet sur le runtime</span><span class="sxs-lookup"><span data-stu-id="93b19-130">Effect on the Runtime</span></span>  
 <span data-ttu-id="93b19-131">En règle générale, plusieurs threads au sein du processus s’interbloquent.</span><span class="sxs-lookup"><span data-stu-id="93b19-131">Typically, several threads inside the process will deadlock.</span></span>  <span data-ttu-id="93b19-132">Un de ces threads est probablement un thread chargé d’effectuer une garbage collection : ce blocage peut donc avoir un impact considérable sur l’ensemble du processus.</span><span class="sxs-lookup"><span data-stu-id="93b19-132">One of those threads is likely to be a thread responsible for performing a garbage collection, so this deadlock can have a major impact on the entire process.</span></span>  <span data-ttu-id="93b19-133">De plus, il empêche toutes les autres opérations qui nécessitent le verrouillage du chargeur du système d’exploitation, comme le chargement et le déchargement d’assemblys ou de DLL, et le démarrage ou l’arrêt de threads.</span><span class="sxs-lookup"><span data-stu-id="93b19-133">Furthermore, it will prevent any additional operations that require the operating system's loader lock, like loading and unloading assemblies or DLLs and starting or stopping threads.</span></span>  
  
 <span data-ttu-id="93b19-134">Dans certains cas inhabituels, il est également possible que des violations d’accès ou des problèmes similaires soient déclenchés dans les DLL qui sont appelées avant d’avoir été initialisées.</span><span class="sxs-lookup"><span data-stu-id="93b19-134">In some unusual cases, it is also possible for access violations or similar problems to be triggered in DLLs which are called before they have been initialized.</span></span>  
  
## <a name="output"></a><span data-ttu-id="93b19-135">Sortie</span><span class="sxs-lookup"><span data-stu-id="93b19-135">Output</span></span>  
 <span data-ttu-id="93b19-136">Cet Assistant Débogage managé signale qu’une exécution managée interdite est tentée.</span><span class="sxs-lookup"><span data-stu-id="93b19-136">This MDA reports that an illegal managed execution is being attempted.</span></span>  <span data-ttu-id="93b19-137">Vous devez examiner la pile du thread pour déterminer la raison pour laquelle le verrouillage du chargeur se produit et comment résoudre le problème.</span><span class="sxs-lookup"><span data-stu-id="93b19-137">You need to examine the thread's stack to determine why the loader lock is occurring and how to correct the problem.</span></span>  
  
## <a name="configuration"></a><span data-ttu-id="93b19-138">Configuration</span><span class="sxs-lookup"><span data-stu-id="93b19-138">Configuration</span></span>  
  
```xml  
<mdaConfig>  
  <assistants>  
    <loaderLock/>  
  </assistants>  
</mdaConfig>  
```  
  
## <a name="see-also"></a><span data-ttu-id="93b19-139">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="93b19-139">See also</span></span>

- [<span data-ttu-id="93b19-140">Diagnostic d’erreurs avec les Assistants Débogage managé</span><span class="sxs-lookup"><span data-stu-id="93b19-140">Diagnosing Errors with Managed Debugging Assistants</span></span>](diagnosing-errors-with-managed-debugging-assistants.md)
