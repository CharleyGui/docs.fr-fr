---
title: SQL Server le regroupement de connexions
description: Découvrez comment ADO.NET réduit le coût de l’ouverture des connexions à l’aide de SQL Server le regroupement de connexions, ce qui réduit la surcharge des nouvelles connexions.
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: 7e51d44e-7c4e-4040-9332-f0190fe36f07
ms.openlocfilehash: 1a95aab9e09d69a3d26b3404d4cb2b70371a3fe8
ms.sourcegitcommit: 33deec3e814238fb18a49b2a7e89278e27888291
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 06/02/2020
ms.locfileid: "84286557"
---
# <a name="sql-server-connection-pooling-adonet"></a><span data-ttu-id="619f2-103">Regroupement de connexions SQL Server (ADO.NET)</span><span class="sxs-lookup"><span data-stu-id="619f2-103">SQL Server Connection Pooling (ADO.NET)</span></span>
<span data-ttu-id="619f2-104">La connexion à un serveur de base de données consiste généralement en plusieurs étapes de longue durée.</span><span class="sxs-lookup"><span data-stu-id="619f2-104">Connecting to a database server typically consists of several time-consuming steps.</span></span> <span data-ttu-id="619f2-105">Un canal physique tel qu’un socket ou un canal nommé doit être établi, le contrôle initial avec le serveur doit avoir lieu, les informations de chaîne de connexion doivent être analysées, la connexion doit être authentifiée par le serveur, des contrôles doivent être effectués pour l’inscription dans la transaction en cours, etc.</span><span class="sxs-lookup"><span data-stu-id="619f2-105">A physical channel such as a socket or a named pipe must be established, the initial handshake with the server must occur, the connection string information must be parsed, the connection must be authenticated by the server, checks must be run for enlisting in the current transaction, and so on.</span></span>  
  
 <span data-ttu-id="619f2-106">Dans la pratique, la plupart des applications utilisent une seule des quelques configurations pour les connexions.</span><span class="sxs-lookup"><span data-stu-id="619f2-106">In practice, most applications use only one or a few different configurations for connections.</span></span> <span data-ttu-id="619f2-107">Cela signifie que, durant l'exécution de l'application, de nombreuses connexions identiques seront ouvertes et fermées à plusieurs reprises.</span><span class="sxs-lookup"><span data-stu-id="619f2-107">This means that during application execution, many identical connections will be repeatedly opened and closed.</span></span> <span data-ttu-id="619f2-108">Pour réduire le coût de l’ouverture des connexions, ADO.NET utilise une technique d’optimisation appelée *regroupement de connexions*.</span><span class="sxs-lookup"><span data-stu-id="619f2-108">To minimize the cost of opening connections, ADO.NET uses an optimization technique called *connection pooling*.</span></span>  
  
 <span data-ttu-id="619f2-109">Le regroupement de connexions réduit le nombre de fois où il est nécessaire d'ouvrir de nouvelles connexions.</span><span class="sxs-lookup"><span data-stu-id="619f2-109">Connection pooling reduces the number of times that new connections must be opened.</span></span> <span data-ttu-id="619f2-110">Le *Pooler* gère la propriété de la connexion physique.</span><span class="sxs-lookup"><span data-stu-id="619f2-110">The *pooler* maintains ownership of the physical connection.</span></span> <span data-ttu-id="619f2-111">Elle gère les connexions en conservant en vie un ensemble de connexions actives pour chaque configuration de connexion donnée.</span><span class="sxs-lookup"><span data-stu-id="619f2-111">It manages connections by keeping alive a set of active connections for each given connection configuration.</span></span> <span data-ttu-id="619f2-112">Chaque fois qu'un utilisateur appelle `Open` sur une connexion, le dispositif de regroupement de connexions recherche une connexion disponible dans le pool.</span><span class="sxs-lookup"><span data-stu-id="619f2-112">Whenever a user calls `Open` on a connection, the pooler looks for an available connection in the pool.</span></span> <span data-ttu-id="619f2-113">Si une connexion regroupée est disponible, le dispositif de regroupement de connexions la retourne à l'appelant au lieu d'ouvrir une nouvelle connexion.</span><span class="sxs-lookup"><span data-stu-id="619f2-113">If a pooled connection is available, it returns it to the caller instead of opening a new connection.</span></span> <span data-ttu-id="619f2-114">Lorsque l'application appelle `Close` sur la connexion, le dispositif de regroupement de connexions la retourne à l'ensemble regroupé de connexions actives au lieu de la fermer.</span><span class="sxs-lookup"><span data-stu-id="619f2-114">When the application calls `Close` on the connection, the pooler returns it to the pooled set of active connections instead of closing it.</span></span> <span data-ttu-id="619f2-115">Une fois la connexion retournée au pool, elle est prête à être réutilisée sur l'appel de `Open` suivant.</span><span class="sxs-lookup"><span data-stu-id="619f2-115">Once the connection is returned to the pool, it is ready to be reused on the next `Open` call.</span></span>  
  
 <span data-ttu-id="619f2-116">Seules les connexions utilisant la même configuration peuvent être groupées par pools.</span><span class="sxs-lookup"><span data-stu-id="619f2-116">Only connections with the same configuration can be pooled.</span></span> <span data-ttu-id="619f2-117">ADO.NET conserve plusieurs pools en même temps, un pour chaque configuration.</span><span class="sxs-lookup"><span data-stu-id="619f2-117">ADO.NET keeps several pools at the same time, one for each configuration.</span></span> <span data-ttu-id="619f2-118">Les connexions sont séparées en pools par chaîne de connexion, ainsi que par identité Windows en cas d'utilisation de la sécurité intégrée.</span><span class="sxs-lookup"><span data-stu-id="619f2-118">Connections are separated into pools by connection string, and by Windows identity when integrated security is used.</span></span> <span data-ttu-id="619f2-119">Les connexions sont également regroupées selon si elles sont inscrites dans une transaction.</span><span class="sxs-lookup"><span data-stu-id="619f2-119">Connections are also pooled based on whether they are enlisted in a transaction.</span></span> <span data-ttu-id="619f2-120">Lorsque vous utilisez <xref:System.Data.SqlClient.SqlConnection.ChangePassword%2A>, l'instance <xref:System.Data.SqlClient.SqlCredential> affecte le pool de connexions.</span><span class="sxs-lookup"><span data-stu-id="619f2-120">When using <xref:System.Data.SqlClient.SqlConnection.ChangePassword%2A>, the <xref:System.Data.SqlClient.SqlCredential> instance affects the connection pool.</span></span> <span data-ttu-id="619f2-121">Les différentes instances de <xref:System.Data.SqlClient.SqlCredential> utilisent différents pool de connexions, même si l'ID d'utilisateur et le mot de passe sont identiques.</span><span class="sxs-lookup"><span data-stu-id="619f2-121">Different instances of <xref:System.Data.SqlClient.SqlCredential> will use different connection pools, even if the user ID and password are the same.</span></span>  
  
 <span data-ttu-id="619f2-122">Le regroupement de connexions peut considérablement améliorer les performances et l'évolutivité de votre application.</span><span class="sxs-lookup"><span data-stu-id="619f2-122">Pooling connections can significantly enhance the performance and scalability of your application.</span></span> <span data-ttu-id="619f2-123">Par défaut, le regroupement de connexions est activé dans ADO.NET.</span><span class="sxs-lookup"><span data-stu-id="619f2-123">By default, connection pooling is enabled in ADO.NET.</span></span> <span data-ttu-id="619f2-124">À moins que vous ne le désactiviez explicitement, le dispositif de regroupement de connexions optimise les connexions au fur et à mesure de leur ouverture et de leur fermeture dans votre application.</span><span class="sxs-lookup"><span data-stu-id="619f2-124">Unless you explicitly disable it, the pooler optimizes the connections as they are opened and closed in your application.</span></span> <span data-ttu-id="619f2-125">Vous pouvez également fournir plusieurs modificateurs de chaîne de connexion pour contrôler le comportement de regroupement de connexions.</span><span class="sxs-lookup"><span data-stu-id="619f2-125">You can also supply several connection string modifiers to control connection pooling behavior.</span></span> <span data-ttu-id="619f2-126">Pour plus d'informations, voir la section sur le contrôle des pools de connexions avec les mots clés des chaînes de connexion, plus loin dans cette rubrique.</span><span class="sxs-lookup"><span data-stu-id="619f2-126">For more information, see "Controlling Connection Pooling with Connection String Keywords" later in this topic.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="619f2-127">Lorsque le regroupement de connexions est activé, et si une erreur de délai d'attente ou toute autre erreur de connexion se produit, une exception est levée et les tentatives de connexion suivantes échouent pendant les cinq secondes suivantes, « la période de blocage ».</span><span class="sxs-lookup"><span data-stu-id="619f2-127">When connection pooling is enabled, and if a timeout error or other login error occurs, an exception will be thrown and subsequent connection attempts will fail for the next five seconds, the "blocking period".</span></span> <span data-ttu-id="619f2-128">Si l'application essaie de se connecter au cours de la période de blocage, la première exception sera levée de nouveau.</span><span class="sxs-lookup"><span data-stu-id="619f2-128">If the application attempts to connect within the blocking period, the first exception will be thrown again.</span></span> <span data-ttu-id="619f2-129">Les échecs suivants à l'issue d'une période de blocage entraînent de nouvelles périodes de blocage deux fois plus longues que la période de blocage précédente, d'une durée maximale d'une minute.</span><span class="sxs-lookup"><span data-stu-id="619f2-129">Subsequent failures after a blocking period ends will result in a new blocking periods that is twice as long as the previous blocking period, up to a maximum of one minute.</span></span>  
  
## <a name="pool-creation-and-assignment"></a><span data-ttu-id="619f2-130">Création et assignation d'un pool</span><span class="sxs-lookup"><span data-stu-id="619f2-130">Pool Creation and Assignment</span></span>  
 <span data-ttu-id="619f2-131">Lorsqu'une connexion est ouverte pour la première fois, un pool de connexions est créé sur la base d'un algorithme à correspondance exacte qui associe le pool à la chaîne de connexion dans la connexion.</span><span class="sxs-lookup"><span data-stu-id="619f2-131">When a connection is first opened, a connection pool is created based on an exact matching algorithm that associates the pool with the connection string in the connection.</span></span> <span data-ttu-id="619f2-132">Chaque pool de connexions est associé à une chaîne de connexion distincte.</span><span class="sxs-lookup"><span data-stu-id="619f2-132">Each connection pool is associated with a distinct connection string.</span></span> <span data-ttu-id="619f2-133">Lorsqu'une nouvelle connexion est ouverte, si la chaîne de connexion ne correspond pas exactement à un pool existant, un nouveau pool est créé.</span><span class="sxs-lookup"><span data-stu-id="619f2-133">When a new connection is opened, if the connection string is not an exact match to an existing pool, a new pool is created.</span></span> <span data-ttu-id="619f2-134">Les connexions sont regroupées par processus, par domaine d'application, par chaîne de connexion et, en cas d'utilisation de la sécurité intégrée, par identité Windows.</span><span class="sxs-lookup"><span data-stu-id="619f2-134">Connections are pooled per process, per application domain, per connection string and when integrated security is used, per Windows identity.</span></span> <span data-ttu-id="619f2-135">Les chaînes de connexion doivent également parfaitement correspondre ; les mots clés fournis dans un ordre différent pour la même connexion sont regroupés séparément.</span><span class="sxs-lookup"><span data-stu-id="619f2-135">Connection strings must also be an exact match; keywords supplied in a different order for the same connection will be pooled separately.</span></span>  
  
 <span data-ttu-id="619f2-136">Dans l'exemple C# suivant, trois nouveaux objets <xref:System.Data.SqlClient.SqlConnection> sont créés mais seuls deux pools sont nécessaires pour les gérer.</span><span class="sxs-lookup"><span data-stu-id="619f2-136">In the following C# example, three new <xref:System.Data.SqlClient.SqlConnection> objects are created, but only two connection pools are required to manage them.</span></span> <span data-ttu-id="619f2-137">Notez que les première et deuxième chaînes de connexion diffèrent par la valeur assignée pour `Initial Catalog`.</span><span class="sxs-lookup"><span data-stu-id="619f2-137">Note that the first and second connection strings differ by the value assigned for `Initial Catalog`.</span></span>  
  
```csharp
using (SqlConnection connection = new SqlConnection(  
  "Integrated Security=SSPI;Initial Catalog=Northwind"))  
    {  
        connection.Open();
        // Pool A is created.  
    }  
  
using (SqlConnection connection = new SqlConnection(  
  "Integrated Security=SSPI;Initial Catalog=pubs"))  
    {  
        connection.Open();
        // Pool B is created because the connection strings differ.  
    }  
  
using (SqlConnection connection = new SqlConnection(  
  "Integrated Security=SSPI;Initial Catalog=Northwind"))  
    {  
        connection.Open();
        // The connection string matches pool A.  
    }  
```  
  
 <span data-ttu-id="619f2-138">Si `MinPoolSize` n'est pas spécifié dans la chaîne de connexion ou est spécifié comme zéro, les connexions du pool sont fermées après une période d'inactivité.</span><span class="sxs-lookup"><span data-stu-id="619f2-138">If `MinPoolSize` is either not specified in the connection string or is specified as zero, the connections in the pool will be closed after a period of inactivity.</span></span> <span data-ttu-id="619f2-139">En revanche, si le `MinPoolSize` spécifié est supérieur à zéro, le pool de connexion n'est pas détruit tant que le `AppDomain` n'a pas été déchargé et que le processus ne s'est pas terminé.</span><span class="sxs-lookup"><span data-stu-id="619f2-139">However, if the specified `MinPoolSize` is greater than zero, the connection pool is not destroyed until the `AppDomain` is unloaded and the process ends.</span></span> <span data-ttu-id="619f2-140">La maintenance des pools inactifs ou vides implique une charge mémoire minimale du système.</span><span class="sxs-lookup"><span data-stu-id="619f2-140">Maintenance of inactive or empty pools involves minimal system overhead.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="619f2-141">Le pool est automatiquement effacé si une erreur irrécupérable survient, telle qu'un basculement.</span><span class="sxs-lookup"><span data-stu-id="619f2-141">The pool is automatically cleared when a fatal error occurs, such as a failover.</span></span>  
  
## <a name="adding-connections"></a><span data-ttu-id="619f2-142">Ajout de connexions</span><span class="sxs-lookup"><span data-stu-id="619f2-142">Adding Connections</span></span>  
 <span data-ttu-id="619f2-143">Un pool de connexions est créé pour chaque chaîne de connexion unique.</span><span class="sxs-lookup"><span data-stu-id="619f2-143">A connection pool is created for each unique connection string.</span></span> <span data-ttu-id="619f2-144">Lorsqu’un pool est créé, plusieurs objets de connexion sont créés et ajoutés au pool de sorte que l’exigence de taille minimale du pool soit remplie.</span><span class="sxs-lookup"><span data-stu-id="619f2-144">When a pool is created, multiple connection objects are created and added to the pool so that the minimum pool size requirement is satisfied.</span></span> <span data-ttu-id="619f2-145">Les connexions sont ajoutées au pool jusqu'à ce que sa taille maximale spécifiée soit atteinte (la valeur par défaut est 100).</span><span class="sxs-lookup"><span data-stu-id="619f2-145">Connections are added to the pool as needed, up to the maximum pool size specified (100 is the default).</span></span> <span data-ttu-id="619f2-146">Les connexions sont libérées et retournées au pool en cas de fermeture ou de suppression.</span><span class="sxs-lookup"><span data-stu-id="619f2-146">Connections are released back into the pool when they are closed or disposed.</span></span>  
  
 <span data-ttu-id="619f2-147">Quand un objet <xref:System.Data.SqlClient.SqlConnection> est demandé, il est obtenu du pool si une connexion utilisable est disponible.</span><span class="sxs-lookup"><span data-stu-id="619f2-147">When a <xref:System.Data.SqlClient.SqlConnection> object is requested, it is obtained from the pool if a usable connection is available.</span></span> <span data-ttu-id="619f2-148">Pour être utilisable, la connexion ne doit pas être en cours d’utilisation, doit avoir un contexte de transaction correspondant ou ne pas être associée à un contexte de transaction et doit avoir un lien valide vers le serveur.</span><span class="sxs-lookup"><span data-stu-id="619f2-148">To be usable, a connection must be unused, have a matching transaction context or be unassociated with any transaction context, and have a valid link to the server.</span></span>  
  
 <span data-ttu-id="619f2-149">Le dispositif de regroupement de connexions répond à ces requêtes de connexion en réallouant les connexions à mesure qu’elles se libèrent dans le pool.</span><span class="sxs-lookup"><span data-stu-id="619f2-149">The connection pooler satisfies requests for connections by reallocating connections as they are released back into the pool.</span></span> <span data-ttu-id="619f2-150">Si la taille maximale du pool est atteinte et qu'aucune connexion utilisable n'est disponible, la requête est mise en attente.</span><span class="sxs-lookup"><span data-stu-id="619f2-150">If the maximum pool size has been reached and no usable connection is available, the request is queued.</span></span> <span data-ttu-id="619f2-151">Le dispositif de regroupement de connexions tente ensuite de récupérer des connexions jusqu'à ce que le délai de temporisation ait expiré (la valeur par défaut est de 15 secondes).</span><span class="sxs-lookup"><span data-stu-id="619f2-151">The pooler then tries to reclaim any connections until the time-out is reached (the default is 15 seconds).</span></span> <span data-ttu-id="619f2-152">Si le dispositif de regroupement de connexions ne peut pas répondre à la requête avant que le délai de temporisation de la connexion ait expiré, une exception est levée.</span><span class="sxs-lookup"><span data-stu-id="619f2-152">If the pooler cannot satisfy the request before the connection times out, an exception is thrown.</span></span>  
  
> [!CAUTION]
> <span data-ttu-id="619f2-153">Il est vivement recommandé de toujours fermer la connexion lorsque vous avez terminé de l'utiliser, de sorte qu'elle soit retournée au pool.</span><span class="sxs-lookup"><span data-stu-id="619f2-153">We strongly recommend that you always close the connection when you are finished using it so that the connection will be returned to the pool.</span></span> <span data-ttu-id="619f2-154">Vous pouvez effectuer cette opération à l' `Close` aide `Dispose` des méthodes ou de l' `Connection` objet, ou en ouvrant toutes les connexions à l’intérieur d’une `using` instruction en C#, ou une `Using` instruction dans Visual Basic.</span><span class="sxs-lookup"><span data-stu-id="619f2-154">You can do this using either the `Close` or `Dispose` methods of the `Connection` object, or by opening all connections inside a `using` statement in C#, or a `Using` statement in Visual Basic.</span></span> <span data-ttu-id="619f2-155">Les connexions qui ne sont pas explicitement fermées risquent de ne pas être ajoutées ni retournées au pool.</span><span class="sxs-lookup"><span data-stu-id="619f2-155">Connections that are not explicitly closed might not be added or returned to the pool.</span></span> <span data-ttu-id="619f2-156">Pour plus d’informations, consultez [using, instruction](../../../csharp/language-reference/keywords/using-statement.md) ou [How to : dispose d’une ressource système](../../../visual-basic/programming-guide/language-features/control-flow/how-to-dispose-of-a-system-resource.md) pour Visual Basic.</span><span class="sxs-lookup"><span data-stu-id="619f2-156">For more information, see [using Statement](../../../csharp/language-reference/keywords/using-statement.md) or [How to: Dispose of a System Resource](../../../visual-basic/programming-guide/language-features/control-flow/how-to-dispose-of-a-system-resource.md) for Visual Basic.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="619f2-157">N'appelez pas une commande `Close` ou `Dispose` sur une `Connection`, un `DataReader` ou tout autre objet managé dans la méthode `Finalize` de votre classe.</span><span class="sxs-lookup"><span data-stu-id="619f2-157">Do not call `Close` or `Dispose` on a `Connection`, a `DataReader`, or any other managed object in the `Finalize` method of your class.</span></span> <span data-ttu-id="619f2-158">Dans un finaliseur, libérez seulement les ressources non managées que votre classe possède directement.</span><span class="sxs-lookup"><span data-stu-id="619f2-158">In a finalizer, only release unmanaged resources that your class owns directly.</span></span> <span data-ttu-id="619f2-159">Si votre classe ne possède pas de ressource non managée, n'incluez pas une méthode `Finalize` dans la définition de classe.</span><span class="sxs-lookup"><span data-stu-id="619f2-159">If your class does not own any unmanaged resources, do not include a `Finalize` method in your class definition.</span></span> <span data-ttu-id="619f2-160">Pour plus d’informations, consultez [garbage collection](../../../standard/garbage-collection/index.md).</span><span class="sxs-lookup"><span data-stu-id="619f2-160">For more information, see [Garbage Collection](../../../standard/garbage-collection/index.md).</span></span>  
  
<span data-ttu-id="619f2-161">Pour plus d’informations sur les événements associés à l’ouverture et à la fermeture des connexions, consultez classe [d’événements Audit login](/sql/relational-databases/event-classes/audit-login-event-class) et [classe d’événements Audit logout](/sql/relational-databases/event-classes/audit-logout-event-class) dans la documentation SQL Server.</span><span class="sxs-lookup"><span data-stu-id="619f2-161">For more info about the events associated with opening and closing connections, see [Audit Login Event Class](/sql/relational-databases/event-classes/audit-login-event-class) and [Audit Logout Event Class](/sql/relational-databases/event-classes/audit-logout-event-class) in the SQL Server documentation.</span></span>  
  
## <a name="removing-connections"></a><span data-ttu-id="619f2-162">Suppression de connexions</span><span class="sxs-lookup"><span data-stu-id="619f2-162">Removing Connections</span></span>  
 <span data-ttu-id="619f2-163">Le dispositif de regroupement de connexions supprime une connexion du pool restée inactive pendant environ 4 à 8 minutes ou s'il détecte que la connexion au serveur a été interrompue.</span><span class="sxs-lookup"><span data-stu-id="619f2-163">The connection pooler removes a connection from the pool after it has been idle for approximately 4-8 minutes, or if the pooler detects that the connection with the server has been severed.</span></span> <span data-ttu-id="619f2-164">Notez qu'une connexion interrompue ne peut être détectée qu'après une tentative de communication avec le serveur.</span><span class="sxs-lookup"><span data-stu-id="619f2-164">Note that a severed connection can be detected only after attempting to communicate with the server.</span></span> <span data-ttu-id="619f2-165">Si une connexion n'est plus reliée au serveur, elle est marquée comme étant non valide.</span><span class="sxs-lookup"><span data-stu-id="619f2-165">If a connection is found that is no longer connected to the server, it is marked as invalid.</span></span> <span data-ttu-id="619f2-166">Les connexions non valides ne sont supprimées du pool de connexions que lorsqu'elles sont fermées ou récupérées.</span><span class="sxs-lookup"><span data-stu-id="619f2-166">Invalid connections are removed from the connection pool only when they are closed or reclaimed.</span></span>  
  
 <span data-ttu-id="619f2-167">Si une connexion existante à un serveur a disparu, il est possible de la retirer du pool même si le dispositif de regroupement de connexions n'a pas détecté d'interruption de la connexion et ne l'a pas marquée comme non valide.</span><span class="sxs-lookup"><span data-stu-id="619f2-167">If a connection exists to a server that has disappeared, this connection can be drawn from the pool even if the connection pooler has not detected the severed connection and marked it as invalid.</span></span> <span data-ttu-id="619f2-168">C'est le cas parce que la charge de vérifier que la connexion est encore valide éliminerait les avantages liés au fait de disposer d'une fonction de regroupement de connexions en entraînant un aller-retour supplémentaire vers le serveur.</span><span class="sxs-lookup"><span data-stu-id="619f2-168">This is the case because the overhead of checking that the connection is still valid would eliminate the benefits of having a pooler by causing another round trip to the server to occur.</span></span> <span data-ttu-id="619f2-169">Lorsque cela se produit, la première tentative d'utilisation de la connexion détecte que la connexion a été interrompue et une exception est levée.</span><span class="sxs-lookup"><span data-stu-id="619f2-169">When this occurs, the first attempt to use the connection will detect that the connection has been severed, and an exception is thrown.</span></span>  
  
## <a name="clearing-the-pool"></a><span data-ttu-id="619f2-170">Effacement du pool</span><span class="sxs-lookup"><span data-stu-id="619f2-170">Clearing the Pool</span></span>  
 <span data-ttu-id="619f2-171">ADO.NET 2,0 a introduit deux nouvelles méthodes pour effacer le pool : <xref:System.Data.SqlClient.SqlConnection.ClearAllPools%2A> et <xref:System.Data.SqlClient.SqlConnection.ClearPool%2A> .</span><span class="sxs-lookup"><span data-stu-id="619f2-171">ADO.NET 2.0 introduced two new methods to clear the pool: <xref:System.Data.SqlClient.SqlConnection.ClearAllPools%2A> and <xref:System.Data.SqlClient.SqlConnection.ClearPool%2A>.</span></span> <span data-ttu-id="619f2-172">`ClearAllPools` efface les pools de connexions pour un fournisseur donné et `ClearPool` efface le pool de connexions associé à une connexion spécifique.</span><span class="sxs-lookup"><span data-stu-id="619f2-172">`ClearAllPools` clears the connection pools for a given provider, and `ClearPool` clears the connection pool that is associated with a specific connection.</span></span> <span data-ttu-id="619f2-173">Si des connexions sont utilisées au moment de l'appel, elles sont marquées de façon appropriée.</span><span class="sxs-lookup"><span data-stu-id="619f2-173">If there are connections being used at the time of the call, they are marked appropriately.</span></span> <span data-ttu-id="619f2-174">Lors de leur fermeture, elles sont écartées au lieu d'être retournées au pool.</span><span class="sxs-lookup"><span data-stu-id="619f2-174">When they are closed, they are discarded instead of being returned to the pool.</span></span>  
  
## <a name="transaction-support"></a><span data-ttu-id="619f2-175">Prise en charge des transactions</span><span class="sxs-lookup"><span data-stu-id="619f2-175">Transaction Support</span></span>  
 <span data-ttu-id="619f2-176">Les connexions sont retirées du pool et assignées en fonction du contexte de transaction.</span><span class="sxs-lookup"><span data-stu-id="619f2-176">Connections are drawn from the pool and assigned based on transaction context.</span></span> <span data-ttu-id="619f2-177">À moins que `Enlist=false` ne soit spécifié dans la chaîne de connexion, le pool de connexions s'assure que la connexion est inscrite dans le contexte <xref:System.Transactions.Transaction.Current%2A>.</span><span class="sxs-lookup"><span data-stu-id="619f2-177">Unless `Enlist=false` is specified in the connection string, the connection pool makes sure that the connection is enlisted in the <xref:System.Transactions.Transaction.Current%2A> context.</span></span> <span data-ttu-id="619f2-178">Lorsqu’une connexion est fermée et retournée au pool avec une transaction `System.Transactions` inscrite, elle est mise de côté de sorte que la demande suivante de ce pool de connexions avec la même transaction `System.Transactions` retourne la même connexion, si elle est disponible.</span><span class="sxs-lookup"><span data-stu-id="619f2-178">When a connection is closed and returned to the pool with an enlisted `System.Transactions` transaction, it is set aside in such a way that the next request for that connection pool with the same `System.Transactions` transaction will return the same connection if it is available.</span></span> <span data-ttu-id="619f2-179">Si une telle demande est émise et qu'aucune connexion regroupée n'est disponible, une connexion est retirée de la partie non traitée du pool et est inscrite.</span><span class="sxs-lookup"><span data-stu-id="619f2-179">If such a request is issued, and there are no pooled connections available, a connection is drawn from the non-transacted part of the pool and enlisted.</span></span> <span data-ttu-id="619f2-180">Si aucune connexion n'est disponible où que ce soit dans le pool, une nouvelle connexion est créée et inscrite.</span><span class="sxs-lookup"><span data-stu-id="619f2-180">If no connections are available in either area of the pool, a new connection is created and enlisted.</span></span>  
  
 <span data-ttu-id="619f2-181">Lorsqu'une connexion est fermée, elle est libérée à nouveau vers le pool et dans la sous-division appropriée en fonction de son contexte de transaction.</span><span class="sxs-lookup"><span data-stu-id="619f2-181">When a connection is closed, it is released back into the pool and into the appropriate subdivision based on its transaction context.</span></span> <span data-ttu-id="619f2-182">Par conséquent, vous pouvez fermer la connexion sans générer d'erreur, même si une transaction distribuée est toujours en attente.</span><span class="sxs-lookup"><span data-stu-id="619f2-182">Therefore, you can close the connection without generating an error, even though a distributed transaction is still pending.</span></span> <span data-ttu-id="619f2-183">Cela vous permet de valider ou d’abandonner ultérieurement la transaction distribuée.</span><span class="sxs-lookup"><span data-stu-id="619f2-183">This allows you to commit or abort the distributed transaction later.</span></span>  
  
## <a name="controlling-connection-pooling-with-connection-string-keywords"></a><span data-ttu-id="619f2-184">Contrôle des pools de connexions avec les mots clés des chaînes de connexion</span><span class="sxs-lookup"><span data-stu-id="619f2-184">Controlling Connection Pooling with Connection String Keywords</span></span>  
 <span data-ttu-id="619f2-185">La propriété `ConnectionString` de l'objet <xref:System.Data.SqlClient.SqlConnection> prend en charge les paires clé-valeur des chaînes de connexion qui peuvent être utilisées pour ajuster le comportement de la logique de regroupement des connexions.</span><span class="sxs-lookup"><span data-stu-id="619f2-185">The `ConnectionString` property of the <xref:System.Data.SqlClient.SqlConnection> object supports connection string key/value pairs that can be used to adjust the behavior of the connection pooling logic.</span></span> <span data-ttu-id="619f2-186">Pour plus d'informations, consultez <xref:System.Data.SqlClient.SqlConnection.ConnectionString%2A>.</span><span class="sxs-lookup"><span data-stu-id="619f2-186">For more information, see <xref:System.Data.SqlClient.SqlConnection.ConnectionString%2A>.</span></span>  
  
## <a name="pool-fragmentation"></a><span data-ttu-id="619f2-187">Fragmentation de pool</span><span class="sxs-lookup"><span data-stu-id="619f2-187">Pool Fragmentation</span></span>  
 <span data-ttu-id="619f2-188">La fragmentation de pool est un problème courant dans de nombreuses applications Web où l'application peut créer un grand nombre de pools qui ne sont pas libérés tant que le processus n'est pas terminé.</span><span class="sxs-lookup"><span data-stu-id="619f2-188">Pool fragmentation is a common problem in many Web applications where the application can create a large number of pools that are not freed until the process exits.</span></span> <span data-ttu-id="619f2-189">Cela laisse un grand nombre de connexions ouvertes qui consomment de la mémoire et altèrent les performances.</span><span class="sxs-lookup"><span data-stu-id="619f2-189">This leaves a large number of connections open and consuming memory, which results in poor performance.</span></span>  
  
### <a name="pool-fragmentation-due-to-integrated-security"></a><span data-ttu-id="619f2-190">Fragmentation de pool due à une sécurité intégrée</span><span class="sxs-lookup"><span data-stu-id="619f2-190">Pool Fragmentation Due to Integrated Security</span></span>  
 <span data-ttu-id="619f2-191">Les connexions sont regroupées en fonction de la chaîne de connexion et de l'identité de l'utilisateur.</span><span class="sxs-lookup"><span data-stu-id="619f2-191">Connections are pooled according to the connection string plus the user identity.</span></span> <span data-ttu-id="619f2-192">C’est pourquoi, si vous utilisez une authentification de base ou une authentification Windows sur le site web ainsi qu’une connexion sécurisée intégrée, vous obtenez un pool par utilisateur.</span><span class="sxs-lookup"><span data-stu-id="619f2-192">Therefore, if you use Basic authentication or Windows Authentication on the Web site and an integrated security login, you get one pool per user.</span></span> <span data-ttu-id="619f2-193">Bien que cela améliore les performances des requêtes de base de données suivantes pour un utilisateur donné, ce dernier ne peut pas tirer parti des connexions établies par d'autres utilisateurs.</span><span class="sxs-lookup"><span data-stu-id="619f2-193">Although this improves the performance of subsequent database requests for a single user, that user cannot take advantage of connections made by other users.</span></span> <span data-ttu-id="619f2-194">Cela génère également au moins une connexion au serveur de base de données par utilisateur.</span><span class="sxs-lookup"><span data-stu-id="619f2-194">It also results in at least one connection per user to the database server.</span></span> <span data-ttu-id="619f2-195">Il s’agit d’un effet secondaire d’une architecture d’application Web particulière que les développeurs doivent soupeser par rapport aux exigences de sécurité et d’audit.</span><span class="sxs-lookup"><span data-stu-id="619f2-195">This is a side effect of a particular Web application architecture that developers must weigh against security and auditing requirements.</span></span>  
  
### <a name="pool-fragmentation-due-to-many-databases"></a><span data-ttu-id="619f2-196">Fragmentation de pool due à un trop grand nombre de base de données</span><span class="sxs-lookup"><span data-stu-id="619f2-196">Pool Fragmentation Due to Many Databases</span></span>  
 <span data-ttu-id="619f2-197">De nombreux fournisseurs de services Internet hébergent plusieurs sites web sur un seul serveur.</span><span class="sxs-lookup"><span data-stu-id="619f2-197">Many Internet service providers host several Web sites on a single server.</span></span> <span data-ttu-id="619f2-198">Ils peuvent utiliser une seule base de données pour confirmer une connexion d'authentification Forms, puis ouvrir une connexion à une base de données spécifique pour cet utilisateur ou ce groupe d'utilisateurs.</span><span class="sxs-lookup"><span data-stu-id="619f2-198">They may use a single database to confirm a Forms authentication login and then open a connection to a specific database for that user or group of users.</span></span> <span data-ttu-id="619f2-199">La connexion à la base de données d'authentification est regroupée et utilisée par tout le monde.</span><span class="sxs-lookup"><span data-stu-id="619f2-199">The connection to the authentication database is pooled and used by everyone.</span></span> <span data-ttu-id="619f2-200">Toutefois, il existe un pool de connexions distinct à chaque base de données, ce qui augmente le nombre de connexions au serveur.</span><span class="sxs-lookup"><span data-stu-id="619f2-200">However, there is a separate pool of connections to each database, which increase the number of connections to the server.</span></span>  
  
 <span data-ttu-id="619f2-201">Cela est également un effet secondaire de la conception de l'application.</span><span class="sxs-lookup"><span data-stu-id="619f2-201">This is also a side-effect of the application design.</span></span> <span data-ttu-id="619f2-202">Il existe une méthode relativement simple pour éviter cet effet secondaire sans compromettre la sécurité lors de la connexion à SQL Server.</span><span class="sxs-lookup"><span data-stu-id="619f2-202">There is a relatively simple way to avoid this side effect without compromising security when you connect to SQL Server.</span></span> <span data-ttu-id="619f2-203">Au lieu d'établir une connexion à une base de données distincte pour chaque utilisateur ou groupe d'utilisateurs, établissez une connexion à la même base de données sur le serveur, puis exécutez l'instruction Transact-SQL USE pour accéder à la base de données souhaitée.</span><span class="sxs-lookup"><span data-stu-id="619f2-203">Instead of connecting to a separate database for each user or group, connect to the same database on the server and then execute the Transact-SQL USE statement to change to the desired database.</span></span> <span data-ttu-id="619f2-204">Le fragment de code suivant montre comment créer une connexion initiale à la base de données `master`, puis basculer vers la base de données souhaitée spécifiée dans la variable chaîne `databaseName`.</span><span class="sxs-lookup"><span data-stu-id="619f2-204">The following code fragment demonstrates creating an initial connection to the `master` database and then switching to the desired database specified in the `databaseName` string variable.</span></span>  
  
```vb  
' Assumes that command is a valid SqlCommand object and that  
' connectionString connects to master.  
    command.Text = "USE DatabaseName"  
Using connection As New SqlConnection(connectionString)  
    connection.Open()  
    command.ExecuteNonQuery()  
End Using  
```  
  
```csharp  
// Assumes that command is a SqlCommand object and that  
// connectionString connects to master.  
command.Text = "USE DatabaseName";  
using (SqlConnection connection = new SqlConnection(  
  connectionString))  
  {  
    connection.Open();  
    command.ExecuteNonQuery();  
  }  
```  
  
## <a name="application-roles-and-connection-pooling"></a><span data-ttu-id="619f2-205">Rôles d'application et regroupement de connexions</span><span class="sxs-lookup"><span data-stu-id="619f2-205">Application Roles and Connection Pooling</span></span>  
 <span data-ttu-id="619f2-206">Après qu'un rôle d'application SQL Server a été activé en appelant la procédure stockée système `sp_setapprole`, le contexte de sécurité de cette connexion ne peut pas être rétabli.</span><span class="sxs-lookup"><span data-stu-id="619f2-206">After a SQL Server application role has been activated by calling the `sp_setapprole` system stored procedure, the security context of that connection cannot be reset.</span></span> <span data-ttu-id="619f2-207">Toutefois, lorsque le regroupement est activé, la connexion est retournée au pool et une erreur se produit en cas de réutilisation de la connexion regroupée.</span><span class="sxs-lookup"><span data-stu-id="619f2-207">However, if pooling is enabled, the connection is returned to the pool, and an error occurs when the pooled connection is reused.</span></span> <span data-ttu-id="619f2-208">Pour plus d’informations, consultez l’article de la base de connaissances, «[Erreurs de rôle d’application SQL avec OLE DB regroupement de ressources](https://support.microsoft.com/default.aspx?scid=KB;EN-US;Q229564)».</span><span class="sxs-lookup"><span data-stu-id="619f2-208">For more information, see the Knowledge Base article, "[SQL application role errors with OLE DB resource pooling](https://support.microsoft.com/default.aspx?scid=KB;EN-US;Q229564)."</span></span>  
  
### <a name="application-role-alternatives"></a><span data-ttu-id="619f2-209">Alternatives aux rôles d'application</span><span class="sxs-lookup"><span data-stu-id="619f2-209">Application Role Alternatives</span></span>  
 <span data-ttu-id="619f2-210">Il est recommandé de tirer parti des mécanismes de sécurité qui peuvent être employés à la place des rôles d'application.</span><span class="sxs-lookup"><span data-stu-id="619f2-210">We recommend that you take advantage of security mechanisms that you can use instead of application roles.</span></span> <span data-ttu-id="619f2-211">Pour plus d’informations, consultez [création de rôles d’application dans SQL Server](./sql/creating-application-roles-in-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="619f2-211">For more information, see [Creating Application Roles in SQL Server](./sql/creating-application-roles-in-sql-server.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="619f2-212">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="619f2-212">See also</span></span>

- [<span data-ttu-id="619f2-213">Regroupement de connexions</span><span class="sxs-lookup"><span data-stu-id="619f2-213">Connection Pooling</span></span>](connection-pooling.md)
- [<span data-ttu-id="619f2-214">SQL Server et ADO.NET</span><span class="sxs-lookup"><span data-stu-id="619f2-214">SQL Server and ADO.NET</span></span>](./sql/index.md)
- [<span data-ttu-id="619f2-215">Compteurs de performances</span><span class="sxs-lookup"><span data-stu-id="619f2-215">Performance Counters</span></span>](performance-counters.md)
- [<span data-ttu-id="619f2-216">Vue d'ensemble d’ADO.NET</span><span class="sxs-lookup"><span data-stu-id="619f2-216">ADO.NET Overview</span></span>](ado-net-overview.md)
