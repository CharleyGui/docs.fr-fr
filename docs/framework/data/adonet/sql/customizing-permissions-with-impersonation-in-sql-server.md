---
title: Personnalisation des autorisations avec l'emprunt d'identité dans SQL Server
ms.date: 03/30/2017
ms.assetid: dc733d09-1d6d-4af0-9c4b-8d24504860f1
ms.openlocfilehash: 52e11bd983a8c9155d90659834df03dea6449a8e
ms.sourcegitcommit: 68653db98c5ea7744fd438710248935f70020dfb
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/22/2019
ms.locfileid: "69961103"
---
# <a name="customizing-permissions-with-impersonation-in-sql-server"></a><span data-ttu-id="55457-102">Personnalisation des autorisations avec l'emprunt d'identité dans SQL Server</span><span class="sxs-lookup"><span data-stu-id="55457-102">Customizing Permissions with Impersonation in SQL Server</span></span>
<span data-ttu-id="55457-103">De nombreuses applications utilisent des procédures stockées pour accéder aux données, en se basant sur le chaînage des propriétés de manière à limiter l'accès aux tables de base.</span><span class="sxs-lookup"><span data-stu-id="55457-103">Many applications use stored procedures to access data, relying on ownership chaining to restrict access to base tables.</span></span> <span data-ttu-id="55457-104">Vous pouvez accorder des autorisations EXECUTE sur les procédures stockées, en révoquant ou refusant des autorisations sur les tables de base.</span><span class="sxs-lookup"><span data-stu-id="55457-104">You can grant EXECUTE permissions on stored procedures, revoking or denying permissions on the base tables.</span></span> <span data-ttu-id="55457-105">SQL Server ne vérifie pas les autorisations de l'appelant si la procédure stockée et les tables ont le même propriétaire.</span><span class="sxs-lookup"><span data-stu-id="55457-105">SQL Server does not check the permissions of the caller if the stored procedure and tables have the same owner.</span></span> <span data-ttu-id="55457-106">Toutefois, le chaînage des propriétés ne fonctionne pas si les objets ont des propriétaires différents ou dans le cas d'instructions SQL dynamiques.</span><span class="sxs-lookup"><span data-stu-id="55457-106">However, ownership chaining doesn't work if objects have different owners or in the case of dynamic SQL.</span></span>  
  
 <span data-ttu-id="55457-107">Vous pouvez utiliser la clause EXECUTE AS dans une procédure stockée lorsque l'appelant ne possède pas d'autorisations sur les objets de base de données référencés.</span><span class="sxs-lookup"><span data-stu-id="55457-107">You can use the EXECUTE AS clause in a stored procedure when the caller doesn't have permissions on the referenced database objects.</span></span> <span data-ttu-id="55457-108">Avec la clause EXECUTE AS, le contexte d'exécution est basculé vers l'utilisateur proxy.</span><span class="sxs-lookup"><span data-stu-id="55457-108">The effect of the EXECUTE AS clause is that the execution context is switched to the proxy user.</span></span> <span data-ttu-id="55457-109">Tout le code, de même que les appels de procédures stockées ou de déclencheurs, s'exécute dans le contexte de sécurité de l'utilisateur proxy.</span><span class="sxs-lookup"><span data-stu-id="55457-109">All code, as well as any calls to nested stored procedures or triggers, executes under the security context of the proxy user.</span></span> <span data-ttu-id="55457-110">Le contexte d'exécution de l'appelant d'origine est rétabli uniquement après exécution de la procédure ou lorsqu'une instruction REVERT est émise.</span><span class="sxs-lookup"><span data-stu-id="55457-110">Execution context is reverted to the original caller only after execution of the procedure or when a REVERT statement is issued.</span></span>  
  
## <a name="context-switching-with-the-execute-as-statement"></a><span data-ttu-id="55457-111">Changement de contexte avec l'instruction EXECUTE AS</span><span class="sxs-lookup"><span data-stu-id="55457-111">Context Switching with the EXECUTE AS Statement</span></span>  
 <span data-ttu-id="55457-112">L'instruction  Transact-SQL EXECUTE AS vous permet de basculer le contexte d'exécution d'une instruction en empruntant l'identité d'un autre utilisateur de connexion ou de base de données.</span><span class="sxs-lookup"><span data-stu-id="55457-112">The Transact-SQL EXECUTE AS statement allows you to switch the execution context of a statement by impersonating another login or database user.</span></span> <span data-ttu-id="55457-113">Cette technique est utile pour tester des requêtes et des procédures en tant qu'un autre utilisateur.</span><span class="sxs-lookup"><span data-stu-id="55457-113">This is a useful technique for testing queries and procedures as another user.</span></span>  
  
```  
EXECUTE AS LOGIN = 'loginName';  
EXECUTE AS USER = 'userName';  
```  
  
 <span data-ttu-id="55457-114">Vous devez posséder des autorisations IMPERSONATE sur la connexion ou l'utilisateur dont vous empruntez l'identité.</span><span class="sxs-lookup"><span data-stu-id="55457-114">You must have IMPERSONATE permissions on the login or user you are impersonating.</span></span> <span data-ttu-id="55457-115">Cette autorisation est implicite pour `sysadmin` dans toutes les bases de données et pour les membres du rôle `db_owner` dans les bases de données qu'ils possèdent.</span><span class="sxs-lookup"><span data-stu-id="55457-115">This permission is implied for `sysadmin` for all databases, and `db_owner` role members in databases that they own.</span></span>  
  
## <a name="granting-permissions-with-the-execute-as-clause"></a><span data-ttu-id="55457-116">Octroi d'autorisations avec la clause EXECUTE AS</span><span class="sxs-lookup"><span data-stu-id="55457-116">Granting Permissions with the EXECUTE AS Clause</span></span>  
 <span data-ttu-id="55457-117">Vous pouvez utiliser la clause EXECUTE AS dans l'en-tête de définition d'une procédure stockée, d'un déclencheur ou d'une fonction définie par l'utilisateur (sauf pour les fonctions table inline).</span><span class="sxs-lookup"><span data-stu-id="55457-117">You can use the EXECUTE AS clause in the definition header of a stored procedure, trigger, or user-defined function (except for inline table-valued functions).</span></span> <span data-ttu-id="55457-118">La procédure est alors exécutée dans le contexte du nom d'utilisateur ou du mot clé spécifié dans la clause EXECUTE AS.</span><span class="sxs-lookup"><span data-stu-id="55457-118">This causes the procedure to execute in the context of the user name or keyword specified in the EXECUTE AS clause.</span></span> <span data-ttu-id="55457-119">Vous pouvez créer dans la base de données un utilisateur proxy qui n'est pas mappé à une connexion, en lui accordant uniquement les autorisations nécessaires sur les objets auxquels la procédure accède.</span><span class="sxs-lookup"><span data-stu-id="55457-119">You can create a proxy user in the database that is not mapped to a login, granting it only the necessary permissions on the objects accessed by the procedure.</span></span> <span data-ttu-id="55457-120">Seul l'utilisateur proxy spécifié dans la clause EXECUTE AS doit posséder des autorisations sur tous les objets auxquels le module accède.</span><span class="sxs-lookup"><span data-stu-id="55457-120">Only the proxy user specified in the EXECUTE AS clause must have permissions on all objects accessed by the module.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="55457-121">Pour certaines actions, comme TRUNCATE TABLE, aucune autorisation ne peut être accordée.</span><span class="sxs-lookup"><span data-stu-id="55457-121">Some actions, such as TRUNCATE TABLE, do not have grantable permissions.</span></span> <span data-ttu-id="55457-122">En incorporant l'instruction dans une procédure et en spécifiant un utilisateur proxy possédant des autorisations ALTER TABLE, vous pouvez étendre les autorisations de troncation de la table aux appelants possédant uniquement des autorisations EXECUTE sur la procédure.</span><span class="sxs-lookup"><span data-stu-id="55457-122">By incorporating the statement within a procedure and specifying a proxy user who has ALTER TABLE permissions, you can extend the permissions to truncate the table to callers who have only EXECUTE permissions on the procedure.</span></span>  
  
 <span data-ttu-id="55457-123">Le contexte spécifié dans la clause EXECUTE AS est valide pour la durée de la procédure, y compris les procédures et déclencheurs imbriqués.</span><span class="sxs-lookup"><span data-stu-id="55457-123">The context specified in the EXECUTE AS clause is valid for the duration of the procedure, including nested procedures and triggers.</span></span> <span data-ttu-id="55457-124">Le contexte de l'appelant est rétabli une fois l'exécution terminée ou lorsque l'instruction REVERT est émise.</span><span class="sxs-lookup"><span data-stu-id="55457-124">Context reverts to the caller when execution is complete or the REVERT statement is issued.</span></span>  
  
 <span data-ttu-id="55457-125">Pour utiliser la clause EXECUTE AS dans une procédure, les trois étapes suivantes sont nécessaires :</span><span class="sxs-lookup"><span data-stu-id="55457-125">There are three steps involved in using the EXECUTE AS clause in a procedure.</span></span>  
  
1. <span data-ttu-id="55457-126">Dans la base de données, créez un utilisateur proxy qui n'est pas mappé à une connexion.</span><span class="sxs-lookup"><span data-stu-id="55457-126">Create a proxy user in the database that is not mapped to a login.</span></span> <span data-ttu-id="55457-127">Cette étape n'est pas obligatoire, mais elle s'avère utile lors de la gestion des autorisations.</span><span class="sxs-lookup"><span data-stu-id="55457-127">This is not required, but it helps when managing permissions.</span></span>  
  
```  
CREATE USER proxyUser WITHOUT LOGIN  
```  
  
1. <span data-ttu-id="55457-128">Accordez les autorisations nécessaires à l'utilisateur proxy.</span><span class="sxs-lookup"><span data-stu-id="55457-128">Grant the proxy user the necessary permissions.</span></span>  
  
2. <span data-ttu-id="55457-129">Ajoutez la clause EXECUTE AS à la procédure stockée ou à la fonction définie par l'utilisateur.</span><span class="sxs-lookup"><span data-stu-id="55457-129">Add the EXECUTE AS clause to the stored procedure or user-defined function.</span></span>  
  
```  
CREATE PROCEDURE [procName] WITH EXECUTE AS 'proxyUser' AS ...  
```  
  
> [!NOTE]
> <span data-ttu-id="55457-130">Les applications qui nécessitent un audit peuvent s'arrêter car le contexte de sécurité d'origine de l'appelant n'est pas conservé.</span><span class="sxs-lookup"><span data-stu-id="55457-130">Applications that require auditing can break because the original security context of the caller is not retained.</span></span> <span data-ttu-id="55457-131">Les fonctions intégrées qui retournent l'identité de l'utilisateur actif, comme SESSION_USER, USER ou USER_NAME, retournent l'utilisateur associé à la clause EXECUTE AS, et non l'appelant d'origine.</span><span class="sxs-lookup"><span data-stu-id="55457-131">Built-in functions that return the identity of the current user, such as SESSION_USER, USER, or USER_NAME, return the user associated with the EXECUTE AS clause, not the original caller.</span></span>  
  
### <a name="using-execute-as-with-revert"></a><span data-ttu-id="55457-132">Utilisation de la clause EXECUTE AS avec l'instruction REVERT</span><span class="sxs-lookup"><span data-stu-id="55457-132">Using EXECUTE AS with REVERT</span></span>  
 <span data-ttu-id="55457-133">Vous pouvez utiliser l'instruction Transact-SQL REVERT pour rétablir le contexte d'exécution d'origine.</span><span class="sxs-lookup"><span data-stu-id="55457-133">You can use the Transact-SQL REVERT statement to revert to the original execution context.</span></span>  
  
 <span data-ttu-id="55457-134">La clause facultative, with No Revert cookie = @variableName, vous permet de rebasculer le contexte d’exécution vers l' @variableName appelant si la variable contient la valeur correcte.</span><span class="sxs-lookup"><span data-stu-id="55457-134">The optional clause, WITH NO REVERT COOKIE = @variableName, allows you switch the execution context back to the caller if the @variableName variable contains the correct value.</span></span> <span data-ttu-id="55457-135">Vous pouvez ainsi rétablir le contexte d'exécution de l'appelant dans les environnements utilisant le regroupement de connexions.</span><span class="sxs-lookup"><span data-stu-id="55457-135">This allows you to switch the execution context back to the caller in environments where connection pooling is used.</span></span> <span data-ttu-id="55457-136">Étant donné que la @variableName valeur de est connue uniquement de l’appelant de l’instruction EXECUTE AS, l’appelant peut garantir que le contexte d’exécution ne peut pas être modifié par l’utilisateur final qui appelle l’application.</span><span class="sxs-lookup"><span data-stu-id="55457-136">Because the value of @variableName is known only to the caller of the EXECUTE AS statement, the caller can guarantee that the execution context cannot be changed by the end user that invokes the application.</span></span> <span data-ttu-id="55457-137">Une fois fermée, la connexion retourne dans le regroupement de connexions.</span><span class="sxs-lookup"><span data-stu-id="55457-137">When the connection is closed, it is returned to the pool.</span></span> <span data-ttu-id="55457-138">Pour plus d’informations sur le regroupement de connexions dans ADO.NET, consultez [SQL Server le regroupement de connexions (ADO.net)](../../../../../docs/framework/data/adonet/sql-server-connection-pooling.md).</span><span class="sxs-lookup"><span data-stu-id="55457-138">For more information on connection pooling in ADO.NET, see [SQL Server Connection Pooling (ADO.NET)](../../../../../docs/framework/data/adonet/sql-server-connection-pooling.md).</span></span>  
  
### <a name="specifying-the-execution-context"></a><span data-ttu-id="55457-139">Spécification du contexte d'exécution</span><span class="sxs-lookup"><span data-stu-id="55457-139">Specifying the Execution Context</span></span>  
 <span data-ttu-id="55457-140">Parallèlement à la spécification d'un utilisateur, vous pouvez utiliser la clause EXECUTE AS avec chacun des mots clés suivants.</span><span class="sxs-lookup"><span data-stu-id="55457-140">In addition to specifying a user, you can also use EXECUTE AS with any of the following keywords.</span></span>  
  
- <span data-ttu-id="55457-141">CALLER.</span><span class="sxs-lookup"><span data-stu-id="55457-141">CALLER.</span></span> <span data-ttu-id="55457-142">L'exécution en tant que CALLER est la valeur par défaut. Si aucune autre option n'est spécifiée, la procédure s'exécute dans le contexte de sécurité de l'appelant.</span><span class="sxs-lookup"><span data-stu-id="55457-142">Executing as CALLER is the default; if no other option is specified, then the procedure executes in the security context of the caller.</span></span>  
  
- <span data-ttu-id="55457-143">OWNER.</span><span class="sxs-lookup"><span data-stu-id="55457-143">OWNER.</span></span> <span data-ttu-id="55457-144">L'exécution en tant que OWNER exécute la procédure dans le contexte de sécurité du propriétaire de la procédure.</span><span class="sxs-lookup"><span data-stu-id="55457-144">Executing as OWNER executes the procedure in the context of the procedure owner.</span></span> <span data-ttu-id="55457-145">Si la procédure est créée dans un schéma détenu par `dbo` ou le propriétaire de la base de données, la procédure s'exécutera avec des autorisations illimitées.</span><span class="sxs-lookup"><span data-stu-id="55457-145">If the procedure is created in a schema owned by `dbo` or the database owner, the procedure will execute with unrestricted permissions.</span></span>  
  
- <span data-ttu-id="55457-146">SELF.</span><span class="sxs-lookup"><span data-stu-id="55457-146">SELF.</span></span> <span data-ttu-id="55457-147">L'exécution en tant que SELF exécute la procédure dans le contexte de sécurité du créateur de la procédure stockée.</span><span class="sxs-lookup"><span data-stu-id="55457-147">Executing as SELF executes in the security context of the creator of the stored procedure.</span></span> <span data-ttu-id="55457-148">Cela revient à exécuter la procédure en tant qu'un utilisateur spécifié, ce dernier étant la personne qui crée ou modifie la procédure.</span><span class="sxs-lookup"><span data-stu-id="55457-148">This is equivalent to executing as a specified user, where the specified user is the person creating or altering the procedure.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="55457-149">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="55457-149">See also</span></span>

- [<span data-ttu-id="55457-150">Sécurisation des applications ADO.NET</span><span class="sxs-lookup"><span data-stu-id="55457-150">Securing ADO.NET Applications</span></span>](../../../../../docs/framework/data/adonet/securing-ado-net-applications.md)
- [<span data-ttu-id="55457-151">Vue d’ensemble de la sécurité SQL Server</span><span class="sxs-lookup"><span data-stu-id="55457-151">Overview of SQL Server Security</span></span>](../../../../../docs/framework/data/adonet/sql/overview-of-sql-server-security.md)
- [<span data-ttu-id="55457-152">Scénarios de sécurité des applications dans SQL Server</span><span class="sxs-lookup"><span data-stu-id="55457-152">Application Security Scenarios in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/application-security-scenarios-in-sql-server.md)
- [<span data-ttu-id="55457-153">Gestion des autorisations avec les procédures stockées dans SQL Server</span><span class="sxs-lookup"><span data-stu-id="55457-153">Managing Permissions with Stored Procedures in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/managing-permissions-with-stored-procedures-in-sql-server.md)
- [<span data-ttu-id="55457-154">Écriture de code SQL dynamique sécurisé dans SQL Server</span><span class="sxs-lookup"><span data-stu-id="55457-154">Writing Secure Dynamic SQL in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/writing-secure-dynamic-sql-in-sql-server.md)
- [<span data-ttu-id="55457-155">Signature de procédures stockées dans SQL Server</span><span class="sxs-lookup"><span data-stu-id="55457-155">Signing Stored Procedures in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/signing-stored-procedures-in-sql-server.md)
- [<span data-ttu-id="55457-156">Modification des données avec les procédures stockées</span><span class="sxs-lookup"><span data-stu-id="55457-156">Modifying Data with Stored Procedures</span></span>](../../../../../docs/framework/data/adonet/modifying-data-with-stored-procedures.md)
- [<span data-ttu-id="55457-157">Fournisseurs managés ADO.NET et centre de développement DataSet</span><span class="sxs-lookup"><span data-stu-id="55457-157">ADO.NET Managed Providers and DataSet Developer Center</span></span>](https://go.microsoft.com/fwlink/?LinkId=217917)
