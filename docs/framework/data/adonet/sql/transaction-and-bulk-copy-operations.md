---
title: Transaction et opérations de copie en bloc
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: f6f0cbc9-f7bf-4d6e-875f-ad1ba0b4aa62
ms.openlocfilehash: bf40d0963c29209d4e8f7e4850f0c99b6702a6bb
ms.sourcegitcommit: 155012a8a826ee8ab6aa49b1b3a3b532e7b7d9bd
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 06/04/2019
ms.locfileid: "66487624"
---
# <a name="transaction-and-bulk-copy-operations"></a><span data-ttu-id="5ccb4-102">Transaction et opérations de copie en bloc</span><span class="sxs-lookup"><span data-stu-id="5ccb4-102">Transaction and Bulk Copy Operations</span></span>
<span data-ttu-id="5ccb4-103">Les opérations de copie en bloc peuvent être réalisées sous forme d'opérations isolées ou en tant qu'étape d'une transaction en comptant plusieurs.</span><span class="sxs-lookup"><span data-stu-id="5ccb4-103">Bulk copy operations can be performed as isolated operations or as part of a multiple step transaction.</span></span> <span data-ttu-id="5ccb4-104">Cette dernière option vous permet d'effectuer plus d'une opération de copie en bloc dans la même transaction et d'effectuer d'autres opérations de base de données (telles que des insertions, des mises à jour et des suppressions) tout en vous laissant la possibilité de valider ou de restaurer toute la transaction.</span><span class="sxs-lookup"><span data-stu-id="5ccb4-104">This latter option enables you to perform more than one bulk copy operation within the same transaction, as well as perform other database operations (such as inserts, updates, and deletes) while still being able to commit or roll back the entire transaction.</span></span>  
  
 <span data-ttu-id="5ccb4-105">Par défaut, une opération de copie en bloc est exécutée sous forme d'opération isolée :</span><span class="sxs-lookup"><span data-stu-id="5ccb4-105">By default, a bulk copy operation is performed as an isolated operation.</span></span> <span data-ttu-id="5ccb4-106">elle se produit de manière non traitée, sans possibilité de restauration.</span><span class="sxs-lookup"><span data-stu-id="5ccb4-106">The bulk copy operation occurs in a non-transacted way, with no opportunity for rolling it back.</span></span> <span data-ttu-id="5ccb4-107">Si vous devez restaurer tout ou partie de la copie en bloc lorsqu’une erreur se produit, vous pouvez utiliser un <xref:System.Data.SqlClient.SqlBulkCopy>-managé transaction, effectuer l’opération de copie en bloc dans une transaction existante ou être inscrit dans un **System.Transactions** <xref:System.Transactions.Transaction>.</span><span class="sxs-lookup"><span data-stu-id="5ccb4-107">If you need to roll back all or part of the bulk copy when an error occurs, you can use a <xref:System.Data.SqlClient.SqlBulkCopy>-managed transaction, perform the bulk copy operation within an existing transaction, or be enlisted in a **System.Transactions**<xref:System.Transactions.Transaction>.</span></span>  
  
## <a name="performing-a-non-transacted-bulk-copy-operation"></a><span data-ttu-id="5ccb4-108">Exécution d'une opération de copie en bloc non traitée</span><span class="sxs-lookup"><span data-stu-id="5ccb4-108">Performing a Non-transacted Bulk Copy Operation</span></span>  
 <span data-ttu-id="5ccb4-109">L'application console suivante montre ce qui se passe lorsqu'une opération de copie en bloc non traitée rencontre une erreur dans l'opération.</span><span class="sxs-lookup"><span data-stu-id="5ccb4-109">The following Console application shows what happens when a non-transacted bulk copy operation encounters an error partway through the operation.</span></span>  
  
 <span data-ttu-id="5ccb4-110">Dans l’exemple, la table source et la table de destination comportent chacune un `Identity` colonne nommée **ProductID**.</span><span class="sxs-lookup"><span data-stu-id="5ccb4-110">In the example, the source table and destination table each include an `Identity` column named **ProductID**.</span></span> <span data-ttu-id="5ccb4-111">Le code commence par préparer la table de destination en supprimant toutes les lignes et puis en insérant une seule ligne dont **ProductID** est connues pour exister dans la table source.</span><span class="sxs-lookup"><span data-stu-id="5ccb4-111">The code first prepares the destination table by deleting all rows and then inserting a single row whose **ProductID** is known to exist in the source table.</span></span> <span data-ttu-id="5ccb4-112">Par défaut, une nouvelle valeur pour la colonne `Identity` est générée dans la table de destination pour chaque ligne ajoutée.</span><span class="sxs-lookup"><span data-stu-id="5ccb4-112">By default, a new value for the `Identity` column is generated in the destination table for each row added.</span></span> <span data-ttu-id="5ccb4-113">Dans cet exemple, une option est définie lorsque la connexion est ouverte qui oblige le processus de chargement en bloc à utiliser les valeurs `Identity` de la table source.</span><span class="sxs-lookup"><span data-stu-id="5ccb4-113">In this example, an option is set when the connection is opened that forces the bulk load process to use the `Identity` values from the source table instead.</span></span>  
  
 <span data-ttu-id="5ccb4-114">L'opération de copie en bloc est exécutée avec la propriété <xref:System.Data.SqlClient.SqlBulkCopy.BatchSize%2A> ayant la valeur 10.</span><span class="sxs-lookup"><span data-stu-id="5ccb4-114">The bulk copy operation is executed with the <xref:System.Data.SqlClient.SqlBulkCopy.BatchSize%2A> property set to 10.</span></span> <span data-ttu-id="5ccb4-115">Lorsque l'opération rencontre la ligne non valide, une exception est levée.</span><span class="sxs-lookup"><span data-stu-id="5ccb4-115">When the operation encounters the invalid row, an exception is thrown.</span></span> <span data-ttu-id="5ccb4-116">Dans ce premier exemple, l'opération de copie en bloc n'est pas traitée.</span><span class="sxs-lookup"><span data-stu-id="5ccb4-116">In this first example, the bulk copy operation is non-transacted.</span></span> <span data-ttu-id="5ccb4-117">Tous les lots copiés jusqu’au moment de l’erreur sont validés ; le lot contenant la clé dupliquée est annulé et l’opération de copie en bloc est suspendue avant la reprise du traitement des autres lots.</span><span class="sxs-lookup"><span data-stu-id="5ccb4-117">All batches copied up to the point of the error are committed; the batch containing the duplicate key is rolled back, and the bulk copy operation is halted before processing any other batches.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="5ccb4-118">Cet exemple ne s’exécutera pas, sauf si vous avez créé les tables de travail comme décrit dans [exemple de configuration de copie en bloc](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md).</span><span class="sxs-lookup"><span data-stu-id="5ccb4-118">This sample will not run unless you have created the work tables as described in [Bulk Copy Example Setup](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md).</span></span> <span data-ttu-id="5ccb4-119">Ce code est fourni pour illustrer la syntaxe pour l’utilisation de **SqlBulkCopy** uniquement.</span><span class="sxs-lookup"><span data-stu-id="5ccb4-119">This code is provided to demonstrate the syntax for using **SqlBulkCopy** only.</span></span> <span data-ttu-id="5ccb4-120">Si les tables source et de destination se trouvent dans la même instance de SQL Server, il est plus facile et plus rapide d’utiliser Transact-SQL`INSERT … SELECT` instruction pour copier les données.</span><span class="sxs-lookup"><span data-stu-id="5ccb4-120">If the source and destination tables are located in the same SQL Server instance, it is easier and faster to use a Transact-SQL`INSERT … SELECT` statement to copy the data.</span></span>  
  
 [!code-csharp[DataWorks SqlBulkCopy.DefaultTransaction#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.DefaultTransaction/CS/source.cs#1)]
 [!code-vb[DataWorks SqlBulkCopy.DefaultTransaction#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.DefaultTransaction/VB/source.vb#1)]  
  
## <a name="performing-a-dedicated-bulk-copy-operation-in-a-transaction"></a><span data-ttu-id="5ccb4-121">Exécution d’une opération de copie en bloc dédiée dans une transaction</span><span class="sxs-lookup"><span data-stu-id="5ccb4-121">Performing a Dedicated Bulk Copy Operation in a Transaction</span></span>  
 <span data-ttu-id="5ccb4-122">Par défaut, une opération de copie en bloc est sa propre transaction.</span><span class="sxs-lookup"><span data-stu-id="5ccb4-122">By default, a bulk copy operation is its own transaction.</span></span> <span data-ttu-id="5ccb4-123">Si vous voulez effectuer une opération de copie en bloc dédiée, créez une nouvelle instance de <xref:System.Data.SqlClient.SqlBulkCopy> avec une chaîne de connexion ou utilisez un objet <xref:System.Data.SqlClient.SqlConnection> existant sans transaction active.</span><span class="sxs-lookup"><span data-stu-id="5ccb4-123">When you want to perform a dedicated bulk copy operation, create a new instance of <xref:System.Data.SqlClient.SqlBulkCopy> with a connection string, or use an existing <xref:System.Data.SqlClient.SqlConnection> object without an active transaction.</span></span> <span data-ttu-id="5ccb4-124">Dans chaque scénario, l'opération de copie en bloc crée puis valide ou annule la transaction.</span><span class="sxs-lookup"><span data-stu-id="5ccb4-124">In each scenario, the bulk copy operation creates, and then commits or rolls back the transaction.</span></span>  
  
 <span data-ttu-id="5ccb4-125">Vous pouvez spécifier explicitement l’option <xref:System.Data.SqlClient.SqlBulkCopyOptions.UseInternalTransaction> dans le constructeur de classe <xref:System.Data.SqlClient.SqlBulkCopy> pour exécuter explicitement une opération de copie en bloc dans sa propre transaction. Chaque lot de l’opération de copie en bloc s’exécute alors dans une transaction distincte.</span><span class="sxs-lookup"><span data-stu-id="5ccb4-125">You can explicitly specify the <xref:System.Data.SqlClient.SqlBulkCopyOptions.UseInternalTransaction> option in the <xref:System.Data.SqlClient.SqlBulkCopy> class constructor to explicitly cause a bulk copy operation to execute in its own transaction, causing each batch of the bulk copy operation to execute within a separate transaction.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="5ccb4-126">Puisque des lots différents sont exécutés dans différentes transactions, si une erreur se produit durant l'opération de copie en bloc, toutes les lignes du lot en cours seront annulées mais les lignes des lots précédents resteront dans la base de données.</span><span class="sxs-lookup"><span data-stu-id="5ccb4-126">Since different batches are executed in different transactions, if an error occurs during the bulk copy operation, all the rows in the current batch will be rolled back, but rows from previous batches will remain in the database.</span></span>  
  
 <span data-ttu-id="5ccb4-127">L'application console suivante est similaire à l'exemple précédent, à une exception près : Dans cet exemple, l'opération de copie en bloc gère ses propres transactions.</span><span class="sxs-lookup"><span data-stu-id="5ccb4-127">The following console application is similar to the previous example, with one exception: In this example, the bulk copy operation manages its own transactions.</span></span> <span data-ttu-id="5ccb4-128">Tous les lots copiés jusqu’au moment de l’erreur sont validés ; le lot contenant la clé dupliquée est annulé et l’opération de copie en bloc est suspendue avant la reprise du traitement des autres lots.</span><span class="sxs-lookup"><span data-stu-id="5ccb4-128">All batches copied up to the point of the error are committed; the batch containing the duplicate key is rolled back, and the bulk copy operation is halted before processing any other batches.</span></span>  
  
> [!IMPORTANT]
>  <span data-ttu-id="5ccb4-129">Cet exemple ne s’exécutera pas, sauf si vous avez créé les tables de travail comme décrit dans [exemple de configuration de copie en bloc](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md).</span><span class="sxs-lookup"><span data-stu-id="5ccb4-129">This sample will not run unless you have created the work tables as described in [Bulk Copy Example Setup](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md).</span></span> <span data-ttu-id="5ccb4-130">Ce code est fourni pour illustrer la syntaxe pour l’utilisation de **SqlBulkCopy** uniquement.</span><span class="sxs-lookup"><span data-stu-id="5ccb4-130">This code is provided to demonstrate the syntax for using **SqlBulkCopy** only.</span></span> <span data-ttu-id="5ccb4-131">Si les tables source et de destination se trouvent dans la même instance de SQL Server, il est plus facile et plus rapide d’utiliser Transact-SQL`INSERT … SELECT` instruction pour copier les données.</span><span class="sxs-lookup"><span data-stu-id="5ccb4-131">If the source and destination tables are located in the same SQL Server instance, it is easier and faster to use a Transact-SQL`INSERT … SELECT` statement to copy the data.</span></span>  
  
 [!code-csharp[DataWorks SqlBulkCopy.InternalTransaction#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.InternalTransaction/CS/source.cs#1)]
 [!code-vb[DataWorks SqlBulkCopy.InternalTransaction#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.InternalTransaction/VB/source.vb#1)]  
  
## <a name="using-existing-transactions"></a><span data-ttu-id="5ccb4-132">Utilisation de transactions existantes</span><span class="sxs-lookup"><span data-stu-id="5ccb4-132">Using Existing Transactions</span></span>  
 <span data-ttu-id="5ccb4-133">Vous pouvez spécifier un objet <xref:System.Data.SqlClient.SqlTransaction> existant comme paramètre dans un constructeur <xref:System.Data.SqlClient.SqlBulkCopy>.</span><span class="sxs-lookup"><span data-stu-id="5ccb4-133">You can specify an existing <xref:System.Data.SqlClient.SqlTransaction> object as a parameter in a <xref:System.Data.SqlClient.SqlBulkCopy> constructor.</span></span> <span data-ttu-id="5ccb4-134">Dans cette situation, l’opération de copie en bloc est effectuée dans une transaction existante et l’état de la transaction ne subit aucune modification (c’est-à-dire qu’elle n’est ni validée ni abandonnée).</span><span class="sxs-lookup"><span data-stu-id="5ccb4-134">In this situation, the bulk copy operation is performed in an existing transaction, and no change is made to the transaction state (that is, it is neither committed nor aborted).</span></span> <span data-ttu-id="5ccb4-135">Cela permet à une application d'inclure l'opération de copie en bloc dans une transaction avec d'autres opérations de base de données.</span><span class="sxs-lookup"><span data-stu-id="5ccb4-135">This allows an application to include the bulk copy operation in a transaction with other database operations.</span></span> <span data-ttu-id="5ccb4-136">Cependant, si vous ne spécifiez pas un objet <xref:System.Data.SqlClient.SqlTransaction> et passez une référence null, et que la connexion a une transaction active, une exception est levée.</span><span class="sxs-lookup"><span data-stu-id="5ccb4-136">However, if you do not specify a <xref:System.Data.SqlClient.SqlTransaction> object and pass a null reference, and the connection has an active transaction, an exception is thrown.</span></span>  
  
 <span data-ttu-id="5ccb4-137">Si vous devez restaurer toute l'opération de copie en bloc en raison d'une d'erreur ou si la copie en bloc doit s'exécuter dans le cadre d'un plus grand processus pouvant être restauré, vous pouvez fournir un objet <xref:System.Data.SqlClient.SqlTransaction> au constructeur <xref:System.Data.SqlClient.SqlBulkCopy>.</span><span class="sxs-lookup"><span data-stu-id="5ccb4-137">If you need to roll back the entire bulk copy operation because an error occurs, or if the bulk copy should execute as part of a larger process that can be rolled back, you can provide a <xref:System.Data.SqlClient.SqlTransaction> object to the <xref:System.Data.SqlClient.SqlBulkCopy> constructor.</span></span>  
  
 <span data-ttu-id="5ccb4-138">L’application console suivante est semblable au premier exemple (non accompli), avec une exception : dans cet exemple, l’opération de copie en bloc est incluse dans une transaction externe plus large.</span><span class="sxs-lookup"><span data-stu-id="5ccb4-138">The following console application is similar to the first (non-transacted) example, with one exception: in this example, the bulk copy operation is included in a larger, external transaction.</span></span> <span data-ttu-id="5ccb4-139">Si l'erreur de violation de clé primaire se produit, toute la transaction est annulée et aucune ligne n'est ajoutée à la table de destination.</span><span class="sxs-lookup"><span data-stu-id="5ccb4-139">When the primary key violation error occurs, the entire transaction is rolled back and no rows are added to the destination table.</span></span>  
  
> [!IMPORTANT]
>  <span data-ttu-id="5ccb4-140">Cet exemple ne s’exécutera pas, sauf si vous avez créé les tables de travail comme décrit dans [exemple de configuration de copie en bloc](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md).</span><span class="sxs-lookup"><span data-stu-id="5ccb4-140">This sample will not run unless you have created the work tables as described in [Bulk Copy Example Setup](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md).</span></span> <span data-ttu-id="5ccb4-141">Ce code est fourni pour illustrer la syntaxe pour l’utilisation de **SqlBulkCopy** uniquement.</span><span class="sxs-lookup"><span data-stu-id="5ccb4-141">This code is provided to demonstrate the syntax for using **SqlBulkCopy** only.</span></span> <span data-ttu-id="5ccb4-142">Si les tables source et de destination se trouvent dans la même instance de SQL Server, il est plus facile et plus rapide d’utiliser Transact-SQL`INSERT … SELECT` instruction pour copier les données.</span><span class="sxs-lookup"><span data-stu-id="5ccb4-142">If the source and destination tables are located in the same SQL Server instance, it is easier and faster to use a Transact-SQL`INSERT … SELECT` statement to copy the data.</span></span>  
  
 [!code-csharp[DataWorks SqlBulkCopy.SqlTransaction#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.SqlTransaction/CS/source.cs#1)]
 [!code-vb[DataWorks SqlBulkCopy.SqlTransaction#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.SqlTransaction/VB/source.vb#1)]  
  
## <a name="see-also"></a><span data-ttu-id="5ccb4-143">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="5ccb4-143">See also</span></span>

- [<span data-ttu-id="5ccb4-144">Opérations de copie en bloc dans SQL Server</span><span class="sxs-lookup"><span data-stu-id="5ccb4-144">Bulk Copy Operations in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/bulk-copy-operations-in-sql-server.md)
- [<span data-ttu-id="5ccb4-145">Fournisseurs managés ADO.NET et centre de développement DataSet</span><span class="sxs-lookup"><span data-stu-id="5ccb4-145">ADO.NET Managed Providers and DataSet Developer Center</span></span>](https://go.microsoft.com/fwlink/?LinkId=217917)
