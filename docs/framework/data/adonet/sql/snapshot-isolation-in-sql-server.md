---
title: Isolation d'instantanés dans SQL Server
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: 43ae5dd3-50f5-43a8-8d01-e37a61664176
ms.openlocfilehash: 8313ffc8eef70c1e5efc24b09a160edb7cec1595
ms.sourcegitcommit: 7588136e355e10cbc2582f389c90c127363c02a5
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 03/12/2020
ms.locfileid: "79174262"
---
# <a name="snapshot-isolation-in-sql-server"></a><span data-ttu-id="e61be-102">Isolation d'instantanés dans SQL Server</span><span class="sxs-lookup"><span data-stu-id="e61be-102">Snapshot Isolation in SQL Server</span></span>
<span data-ttu-id="e61be-103">L’isolation d’instantané améliore l’accès concurrentiel pour les applications OLTP.</span><span class="sxs-lookup"><span data-stu-id="e61be-103">Snapshot isolation enhances concurrency for OLTP applications.</span></span>  
  
## <a name="understanding-snapshot-isolation-and-row-versioning"></a><span data-ttu-id="e61be-104">Présentation de l'isolation d'instantané et gestion des versions de ligne</span><span class="sxs-lookup"><span data-stu-id="e61be-104">Understanding Snapshot Isolation and Row Versioning</span></span>  
 <span data-ttu-id="e61be-105">Une fois l’isolement instantané activé, les versions de ligne mises à jour pour chaque transaction doivent être maintenues.</span><span class="sxs-lookup"><span data-stu-id="e61be-105">Once snapshot isolation is enabled, updated row versions for each transaction must be maintained.</span></span>  <span data-ttu-id="e61be-106">Avant SQL Server 2019, ces versions étaient stockées dans **tempdb**.</span><span class="sxs-lookup"><span data-stu-id="e61be-106">Prior to SQL Server 2019, these versions were stored in **tempdb**.</span></span> <span data-ttu-id="e61be-107">SQL Server 2019 présente une nouvelle fonctionnalité, Accelerated Database Recovery (ADR) qui nécessite son propre ensemble de versions de ligne.</span><span class="sxs-lookup"><span data-stu-id="e61be-107">SQL Server 2019 introduces a new feature, Accelerated Database Recovery (ADR) which requires its own set of row versions.</span></span>  <span data-ttu-id="e61be-108">Ainsi, à partir de SQL Server 2019, si ADR n’est pas activé, les versions de ligne sont maintenues dans **le tempdb** comme toujours.</span><span class="sxs-lookup"><span data-stu-id="e61be-108">So, as of SQL Server 2019, if ADR is not enabled, row versions are kept in **tempdb** as always.</span></span>  <span data-ttu-id="e61be-109">Si L’ADR est activée, toutes les versions de ligne, toutes deux liées à l’isolement instantané et à l’ADR, sont conservées dans le magasin de versions persistantes (PVS) d’ADR, qui se trouve dans la base de données utilisateur d’un groupe de fichiers que l’utilisateur spécifie.</span><span class="sxs-lookup"><span data-stu-id="e61be-109">If ADR is enabled, then all row versions, both related to snapshot isolation and ADR, are kept in ADR's Persistent Version Store (PVS), which is located in the user database in a filegroup which the user specifies.</span></span> <span data-ttu-id="e61be-110">Un numéro de séquence de transaction unique identifie chaque transaction, et ces numéros uniques sont enregistrés pour chaque version de ligne.</span><span class="sxs-lookup"><span data-stu-id="e61be-110">A unique transaction sequence number identifies each transaction, and these unique numbers are recorded for each row version.</span></span> <span data-ttu-id="e61be-111">La transaction fonctionne avec les versions de ligne les plus récentes ayant un numéro de séquence antérieur au numéro de séquence de la transaction.</span><span class="sxs-lookup"><span data-stu-id="e61be-111">The transaction works with the most recent row versions having a sequence number before the sequence number of the transaction.</span></span> <span data-ttu-id="e61be-112">Les versions de ligne plus récentes créées après le début de la transaction sont ignorées par la transaction.</span><span class="sxs-lookup"><span data-stu-id="e61be-112">Newer row versions created after the transaction has begun are ignored by the transaction.</span></span>  
  
 <span data-ttu-id="e61be-113">Le terme « instantané » reflète le fait que toutes les requêtes de la transaction voient la même version, ou instantané, de la base de données, en fonction de l’état de la base de données au moment où la transaction commence.</span><span class="sxs-lookup"><span data-stu-id="e61be-113">The term "snapshot" reflects the fact that all queries in the transaction see the same version, or snapshot, of the database, based on the state of the database at the moment in time when the transaction begins.</span></span> <span data-ttu-id="e61be-114">Aucun verrou n’est acquis sur les lignes de données ou les pages de données sous-jacentes dans une transaction d’instantané, ce qui permet à d’autres transactions de s’exécuter sans être bloquées par une transaction inachevée antérieure.</span><span class="sxs-lookup"><span data-stu-id="e61be-114">No locks are acquired on the underlying data rows or data pages in a snapshot transaction, which permits other transactions to execute without being blocked by a prior uncompleted transaction.</span></span> <span data-ttu-id="e61be-115">Les transactions qui modifient des données ne bloquent pas les transactions qui lisent des données, et les transactions qui lisent des données ne bloquent pas les transactions qui écrivent des données, comme elles le feraient normalement avec le niveau d’isolation READ COMMITTED par défaut dans SQL Server.</span><span class="sxs-lookup"><span data-stu-id="e61be-115">Transactions that modify data do not block transactions that read data, and transactions that read data do not block transactions that write data, as they normally would under the default READ COMMITTED isolation level in SQL Server.</span></span> <span data-ttu-id="e61be-116">Ce comportement non bloquant réduit également sensiblement la probabilité de blocages pour les transactions complexes.</span><span class="sxs-lookup"><span data-stu-id="e61be-116">This non-blocking behavior also significantly reduces the likelihood of deadlocks for complex transactions.</span></span>  
  
 <span data-ttu-id="e61be-117">L’isolation d’instantané utilise un modèle d’accès concurrentiel optimiste.</span><span class="sxs-lookup"><span data-stu-id="e61be-117">Snapshot isolation uses an optimistic concurrency model.</span></span> <span data-ttu-id="e61be-118">Si une transaction d’instantané tente de valider des modifications apportées à des données qui ont été modifiées après le début de la transaction, la transaction est annulée et une erreur est générée.</span><span class="sxs-lookup"><span data-stu-id="e61be-118">If a snapshot transaction attempts to commit modifications to data that has changed since the transaction began, the transaction will roll back and an error will be raised.</span></span> <span data-ttu-id="e61be-119">Vous pouvez éviter cela en utilisant des indicateurs UPDLOCK pour les instructions SELECT qui accèdent aux données à modifier.</span><span class="sxs-lookup"><span data-stu-id="e61be-119">You can avoid this by using UPDLOCK hints for SELECT statements that access data to be modified.</span></span> <span data-ttu-id="e61be-120">Pour plus d’informations, consultez « Indicateurs de verrouillage » dans la Documentation en ligne de SQL Server.</span><span class="sxs-lookup"><span data-stu-id="e61be-120">See "Locking Hints" in SQL Server Books Online for more information.</span></span>  
  
 <span data-ttu-id="e61be-121">L’isolation d’instantané doit être activée en définissant l’option ALLOW_SNAPSHOT_ISOLATION sur la base de données avant qu’elle soit utilisée dans des transactions.</span><span class="sxs-lookup"><span data-stu-id="e61be-121">Snapshot isolation must be enabled by setting the ALLOW_SNAPSHOT_ISOLATION ON database option before it is used in transactions.</span></span> <span data-ttu-id="e61be-122">Cela active le mécanisme de stockage de versions de ligne dans la base de données temporaire (**tempdb**).</span><span class="sxs-lookup"><span data-stu-id="e61be-122">This activates the mechanism for storing row versions in the temporary database (**tempdb**).</span></span> <span data-ttu-id="e61be-123">Vous devez activer l’isolation d’instantané dans chaque base de données qui l’utilise avec l’instruction Transact-SQL ALTER DATABASE.</span><span class="sxs-lookup"><span data-stu-id="e61be-123">You must enable snapshot isolation in each database that uses it with the Transact-SQL ALTER DATABASE statement.</span></span> <span data-ttu-id="e61be-124">À cet égard, l’isolation d’instantané diffère des niveaux d’isolation traditionnels READ COMMITTED, REPEATABLE READ, SERIALIZABLE et READ UNCOMMITTED, qui ne nécessitent aucune configuration.</span><span class="sxs-lookup"><span data-stu-id="e61be-124">In this respect, snapshot isolation differs from the traditional isolation levels of READ COMMITTED, REPEATABLE READ, SERIALIZABLE, and READ UNCOMMITTED, which require no configuration.</span></span> <span data-ttu-id="e61be-125">Les instructions suivantes activent l’isolation d’instantané et remplacent le comportement READ COMMITTED par défaut par SNAPSHOT :</span><span class="sxs-lookup"><span data-stu-id="e61be-125">The following statements activate snapshot isolation and replace the default READ COMMITTED behavior with SNAPSHOT:</span></span>  
  
```sql  
ALTER DATABASE MyDatabase  
SET ALLOW_SNAPSHOT_ISOLATION ON  
  
ALTER DATABASE MyDatabase  
SET READ_COMMITTED_SNAPSHOT ON  
```  
  
 <span data-ttu-id="e61be-126">La définition de l’option READ_COMMITTED_SNAPSHOT ON permet d’accéder aux lignes avec version sous le niveau d’isolation READ COMMITTED par défaut.</span><span class="sxs-lookup"><span data-stu-id="e61be-126">Setting the READ_COMMITTED_SNAPSHOT ON option allows access to versioned rows under the default READ COMMITTED isolation level.</span></span> <span data-ttu-id="e61be-127">Si l’option READ_COMMITTED_SNAPSHOT est désactivée (OFF), vous devez définir explicitement le niveau d’isolation d’instantané pour chaque session afin d’accéder aux lignes avec version.</span><span class="sxs-lookup"><span data-stu-id="e61be-127">If the READ_COMMITTED_SNAPSHOT option is set to OFF, you must explicitly set the Snapshot isolation level for each session in order to access versioned rows.</span></span>  
  
## <a name="managing-concurrency-with-isolation-levels"></a><span data-ttu-id="e61be-128">Gestion de l'accès simultané avec des niveaux d'isolation</span><span class="sxs-lookup"><span data-stu-id="e61be-128">Managing Concurrency with Isolation Levels</span></span>  
 <span data-ttu-id="e61be-129">Le niveau d’isolation sous lequel une instruction Transact-SQL s’exécute détermine son comportement de verrouillage et de contrôle de version de ligne.</span><span class="sxs-lookup"><span data-stu-id="e61be-129">The isolation level under which a Transact-SQL statement executes determines its locking and row versioning behavior.</span></span> <span data-ttu-id="e61be-130">Un niveau d’isolation a une portée à l’échelle de la connexion et, une fois défini pour une connexion avec l’instruction SET TRANSACTION ISOLATION LEVEL, il reste effectif jusqu’à ce que la connexion soit fermée ou qu’un autre niveau d’isolation soit défini.</span><span class="sxs-lookup"><span data-stu-id="e61be-130">An isolation level has connection-wide scope, and once set for a connection with the SET TRANSACTION ISOLATION LEVEL statement, it remains in effect until the connection is closed or another isolation level is set.</span></span> <span data-ttu-id="e61be-131">Lorsqu’une connexion est fermée et retournée au pool, le niveau d’isolation de la dernière instruction SET TRANSACTION ISOLATION LEVEL est conservé.</span><span class="sxs-lookup"><span data-stu-id="e61be-131">When a connection is closed and returned to the pool, the isolation level from the last SET TRANSACTION ISOLATION LEVEL statement is retained.</span></span> <span data-ttu-id="e61be-132">Les connexions suivantes réutilisant une connexion regroupée utilisent le niveau d’isolation en vigueur au moment où la connexion est regroupée.</span><span class="sxs-lookup"><span data-stu-id="e61be-132">Subsequent connections reusing a pooled connection use the isolation level that was in effect at the time the connection is pooled.</span></span>  
  
 <span data-ttu-id="e61be-133">Les requêtes individuelles émises au sein d’une connexion peuvent contenir des indicateurs de verrou qui modifient l’isolation pour une seule instruction ou transaction, mais n’affectent pas le niveau d’isolation de la connexion.</span><span class="sxs-lookup"><span data-stu-id="e61be-133">Individual queries issued within a connection can contain lock hints that modify the isolation for a single statement or transaction but do not affect the isolation level of the connection.</span></span> <span data-ttu-id="e61be-134">Les niveaux d’isolation ou les indicateurs de verrou définis dans les procédures stockées ou les fonctions ne modifient pas le niveau d’isolation de la connexion qui les appelle et ne sont effectifs que pendant la durée de la procédure stockée ou de l’appel de fonction.</span><span class="sxs-lookup"><span data-stu-id="e61be-134">Isolation levels or lock hints set in stored procedures or functions do not change the isolation level of the connection that calls them and are in effect only for the duration of the stored procedure or function call.</span></span>  
  
 <span data-ttu-id="e61be-135">Quatre niveaux d’isolation définis dans la norme SQL-92 étaient pris en charge dans les premières versions de SQL Server :</span><span class="sxs-lookup"><span data-stu-id="e61be-135">Four isolation levels defined in the SQL-92 standard were supported in early versions of SQL Server:</span></span>  
  
- <span data-ttu-id="e61be-136">READ UNCOMMITTED est le niveau d’isolation le moins restrictif, car il ignore les verrous placés par d’autres transactions.</span><span class="sxs-lookup"><span data-stu-id="e61be-136">READ UNCOMMITTED is the least restrictive isolation level because it ignores locks placed by other transactions.</span></span> <span data-ttu-id="e61be-137">Les transactions qui s’exécutent sous READ UNCOMMITTED peuvent lire des valeurs de données modifiées qui n’ont pas encore été validées par d’autres transactions ; celles-ci sont appelées lectures « erronées ».</span><span class="sxs-lookup"><span data-stu-id="e61be-137">Transactions executing under READ UNCOMMITTED can read modified data values that have not yet been committed by other transactions; these are called "dirty" reads.</span></span>  
  
- <span data-ttu-id="e61be-138">READ COMMITTED est le niveau d’isolation par défaut pour SQL Server.</span><span class="sxs-lookup"><span data-stu-id="e61be-138">READ COMMITTED is the default isolation level for SQL Server.</span></span> <span data-ttu-id="e61be-139">Il empêche les lectures erronées en spécifiant que les instructions ne peuvent pas lire des valeurs de données modifiées et non encore validées par d'autres transactions.</span><span class="sxs-lookup"><span data-stu-id="e61be-139">It prevents dirty reads by specifying that statements cannot read data values that have been modified but not yet committed by other transactions.</span></span> <span data-ttu-id="e61be-140">D’autres transactions peuvent toujours modifier, insérer ou supprimer des données entre les exécutions d’instructions individuelles dans la transaction en cours, ce qui aboutit à des lectures non renouvelables ou des données « fantômes ».</span><span class="sxs-lookup"><span data-stu-id="e61be-140">Other transactions can still modify, insert, or delete data between executions of individual statements within the current transaction, resulting in non-repeatable reads, or "phantom" data.</span></span>  
  
- <span data-ttu-id="e61be-141">La lecture renouvelable est un niveau d’isolation plus restrictif que READ COMMITTED.</span><span class="sxs-lookup"><span data-stu-id="e61be-141">REPEATABLE READ is a more restrictive isolation level than READ COMMITTED.</span></span> <span data-ttu-id="e61be-142">Il englobe READ COMMITTED et spécifie qu’aucune autre transaction ne peut modifier ou supprimer des données qui ont été lues par la transaction actuelle jusqu’à ce que la transaction en cours soit validée.</span><span class="sxs-lookup"><span data-stu-id="e61be-142">It encompasses READ COMMITTED and additionally specifies that no other transactions can modify or delete data that has been read by the current transaction until the current transaction commits.</span></span> <span data-ttu-id="e61be-143">La concurrence est inférieure à celle de READ COMMITTED, car les verrous partagés sur les données lues sont conservés pendant la durée de la transaction au lieu d’être libérés à la fin de chaque instruction.</span><span class="sxs-lookup"><span data-stu-id="e61be-143">Concurrency is lower than for READ COMMITTED because shared locks on read data are held for the duration of the transaction instead of being released at the end of each statement.</span></span>  
  
- <span data-ttu-id="e61be-144">SERIALIZABLE est le niveau d’isolation le plus restrictif, car il verrouille des groupes de clés entiers et laisse les verrous en place jusqu’à la fin de la transaction.</span><span class="sxs-lookup"><span data-stu-id="e61be-144">SERIALIZABLE is the most restrictive isolation level, because it locks entire ranges of keys and holds the locks until the transaction is complete.</span></span> <span data-ttu-id="e61be-145">Il englobe la lecture renouvelable et ajoute la restriction selon laquelle les autres transactions ne peuvent pas insérer de nouvelles lignes dans les plages qui ont été lues par la transaction jusqu’à ce que la transaction soit terminée.</span><span class="sxs-lookup"><span data-stu-id="e61be-145">It encompasses REPEATABLE READ and adds the restriction that other transactions cannot insert new rows into ranges that have been read by the transaction until the transaction is complete.</span></span>  
  
 <span data-ttu-id="e61be-146">Pour plus d’informations, consultez le [Guide du verrouillage des transactions et de la gestion de versions de ligne](/sql/relational-databases/sql-server-transaction-locking-and-row-versioning-guide).</span><span class="sxs-lookup"><span data-stu-id="e61be-146">For more information, refer to the [Transaction Locking and Row Versioning Guide](/sql/relational-databases/sql-server-transaction-locking-and-row-versioning-guide).</span></span>  
  
### <a name="snapshot-isolation-level-extensions"></a><span data-ttu-id="e61be-147">Extensions de niveau d'isolation d'instantané</span><span class="sxs-lookup"><span data-stu-id="e61be-147">Snapshot Isolation Level Extensions</span></span>  
 <span data-ttu-id="e61be-148">SQL Server a introduit des extensions des niveaux d’isolation de SQL-92 avec le niveau d’isolation SNAPSHOT et l’implémentation supplémentaire de READ COMMITTED.</span><span class="sxs-lookup"><span data-stu-id="e61be-148">SQL Server introduced extensions to the SQL-92 isolation levels with the introduction of the SNAPSHOT isolation level and an additional implementation of READ COMMITTED.</span></span> <span data-ttu-id="e61be-149">Le niveau d’isolation READ_COMMITTED_SNAPSHOT peut remplacer de façon transparente READ COMMITTED pour toutes les transactions.</span><span class="sxs-lookup"><span data-stu-id="e61be-149">The READ_COMMITTED_SNAPSHOT isolation level can transparently replace READ COMMITTED for all transactions.</span></span>  
  
- <span data-ttu-id="e61be-150">L’isolation d’instantané spécifie que les données lues dans une transaction ne refléteront jamais les modifications apportées par d’autres transactions simultanées.</span><span class="sxs-lookup"><span data-stu-id="e61be-150">SNAPSHOT isolation specifies that data read within a transaction will never reflect changes made by other simultaneous transactions.</span></span> <span data-ttu-id="e61be-151">La transaction utilise les versions de ligne de données qui existent au début de la transaction.</span><span class="sxs-lookup"><span data-stu-id="e61be-151">The transaction uses the data row versions that exist when the transaction begins.</span></span> <span data-ttu-id="e61be-152">Aucun verrou n’est placé sur les données lors de leur lecture, de sorte que les transactions d’instantané n’empêchent pas d’autres transactions d’écrire des données.</span><span class="sxs-lookup"><span data-stu-id="e61be-152">No locks are placed on the data when it is read, so SNAPSHOT transactions do not block other transactions from writing data.</span></span> <span data-ttu-id="e61be-153">De même, les transactions qui écrivent des données n’empêchent pas des transactions d’instantanés de lire des données.</span><span class="sxs-lookup"><span data-stu-id="e61be-153">Transactions that write data do not block snapshot transactions from reading data.</span></span> <span data-ttu-id="e61be-154">Vous devez activer l’isolation d’instantané en définissant l’option ALLOW_SNAPSHOT_ISOLATION sur la base de données afin de l’utiliser.</span><span class="sxs-lookup"><span data-stu-id="e61be-154">You need to enable snapshot isolation by setting the ALLOW_SNAPSHOT_ISOLATION database option in order to use it.</span></span>  
  
- <span data-ttu-id="e61be-155">L’option de base de données READ_COMMITTED_SNAPSHOT détermine le comportement du niveau d’isolation READ COMMITTED par défaut lorsque l’isolation d’instantané est activée dans une base de données.</span><span class="sxs-lookup"><span data-stu-id="e61be-155">The READ_COMMITTED_SNAPSHOT database option determines the behavior of the default READ COMMITTED isolation level when snapshot isolation is enabled in a database.</span></span> <span data-ttu-id="e61be-156">Si vous ne spécifiez pas explicitement READ_COMMITTED_SNAPSHOT ON, READ COMMITTED est appliqué à toutes les transactions implicites.</span><span class="sxs-lookup"><span data-stu-id="e61be-156">If you do not explicitly specify READ_COMMITTED_SNAPSHOT ON, READ COMMITTED is applied to all implicit transactions.</span></span> <span data-ttu-id="e61be-157">Cela produit le même comportement que le paramètre READ_COMMITTED_SNAPSHOT OFF (valeur par défaut).</span><span class="sxs-lookup"><span data-stu-id="e61be-157">This produces the same behavior as setting READ_COMMITTED_SNAPSHOT OFF (the default).</span></span> <span data-ttu-id="e61be-158">Lorsque READ_COMMITTED_SNAPSHOT OFF s’applique, le moteur de base de données utilise des verrous partagés pour appliquer le niveau d’isolation par défaut.</span><span class="sxs-lookup"><span data-stu-id="e61be-158">When READ_COMMITTED_SNAPSHOT OFF is in effect, the Database Engine uses shared locks to enforce the default isolation level.</span></span> <span data-ttu-id="e61be-159">Si vous affectez la valeur ON à l’option de base de données READ_COMMITTED_SNAPSHOT, le moteur de base de données utilise le contrôle de version de ligne et l’isolation d’instantané comme valeur par défaut, au lieu d’utiliser des verrous pour protéger les données.</span><span class="sxs-lookup"><span data-stu-id="e61be-159">If you set the READ_COMMITTED_SNAPSHOT database option to ON, the database engine uses row versioning and snapshot isolation as the default, instead of using locks to protect the data.</span></span>  
  
## <a name="how-snapshot-isolation-and-row-versioning-work"></a><span data-ttu-id="e61be-160">Fonctionnement de l'isolation d'instantané et de la gestion des versions de ligne</span><span class="sxs-lookup"><span data-stu-id="e61be-160">How Snapshot Isolation and Row Versioning Work</span></span>  
 <span data-ttu-id="e61be-161">Quand le niveau d’isolation SNAPSHOT est activé, chaque fois qu’une ligne est mise à jour, le moteur de base de données SQL Server stocke une copie de la ligne originale dans **tempdb** et ajoute un numéro de séquence de transaction à la ligne.</span><span class="sxs-lookup"><span data-stu-id="e61be-161">When the SNAPSHOT isolation level is enabled, each time a row is updated, the SQL Server Database Engine stores a copy of the original row in **tempdb**, and adds a transaction sequence number to the row.</span></span> <span data-ttu-id="e61be-162">Voici la séquence des événements :</span><span class="sxs-lookup"><span data-stu-id="e61be-162">The following is the sequence of events that occurs:</span></span>  
  
- <span data-ttu-id="e61be-163">Une nouvelle transaction est lancée et un numéro de séquence de transaction lui est affecté.</span><span class="sxs-lookup"><span data-stu-id="e61be-163">A new transaction is initiated, and it is assigned a transaction sequence number.</span></span>  
  
- <span data-ttu-id="e61be-164">Le moteur de base de données lit une ligne de la transaction et extrait la version de ligne de **tempdb** dont le numéro de séquence est le plus proche et inférieur au numéro de séquence de la transaction.</span><span class="sxs-lookup"><span data-stu-id="e61be-164">The Database Engine reads a row within the transaction and retrieves the row version from **tempdb** whose sequence number is closest to, and lower than, the transaction sequence number.</span></span>  
  
- <span data-ttu-id="e61be-165">Le moteur de base de données vérifie si le numéro de séquence de la transaction ne figure pas dans la liste des numéros de séquence de transaction des transactions non validées actives au démarrage de la transaction d’instantané.</span><span class="sxs-lookup"><span data-stu-id="e61be-165">The Database Engine checks to see if the transaction sequence number is not in the list of transaction sequence numbers of the uncommitted transactions active when the snapshot transaction started.</span></span>  
  
- <span data-ttu-id="e61be-166">La transaction lit dans **tempdb** la version de la ligne telle qu’elle était au début de la transaction.</span><span class="sxs-lookup"><span data-stu-id="e61be-166">The transaction reads the version of the row from **tempdb** that was current as of the start of the transaction.</span></span> <span data-ttu-id="e61be-167">Les nouvelles lignes insérées après le début de la transaction ne sont pas visibles, car leurs valeurs de numéro de séquence sont supérieures au numéro de la transaction.</span><span class="sxs-lookup"><span data-stu-id="e61be-167">It will not see new rows inserted after the transaction was started because those sequence number values will be higher than the value of the transaction sequence number.</span></span>  
  
- <span data-ttu-id="e61be-168">La transaction en cours voit les lignes qui ont été supprimées après le début de la transaction car il y aura une version de ligne dans **tempdb** dont la valeur de numéro de séquence est inférieure.</span><span class="sxs-lookup"><span data-stu-id="e61be-168">The current transaction will see rows that were deleted after the transaction began, because there will be a row version in **tempdb** with a lower sequence number value.</span></span>  
  
 <span data-ttu-id="e61be-169">L’effet net de l’isolation d’instantané est que la transaction voit toutes les données telles qu’elles existaient au début de la transaction, sans respecter ni placer de verrous sur les tables sous-jacentes.</span><span class="sxs-lookup"><span data-stu-id="e61be-169">The net effect of snapshot isolation is that the transaction sees all of the data as it existed at the start of the transaction, without honoring or placing any locks on the underlying tables.</span></span> <span data-ttu-id="e61be-170">Cela peut entraîner des améliorations des performances dans les situations où il existe une contention.</span><span class="sxs-lookup"><span data-stu-id="e61be-170">This can result in performance improvements in situations where there is contention.</span></span>  
  
 <span data-ttu-id="e61be-171">Une transaction d’instantané utilise toujours le contrôle d’accès concurrentiel optimiste, en retenant tous les verrous qui empêchent les autres transactions de mettre à jour des lignes.</span><span class="sxs-lookup"><span data-stu-id="e61be-171">A snapshot transaction always uses optimistic concurrency control, withholding any locks that would prevent other transactions from updating rows.</span></span> <span data-ttu-id="e61be-172">Si une transaction d’instantané tente de valider une mise à jour sur une ligne qui a été modifiée après le début de la transaction, la transaction est restaurée et une erreur est générée.</span><span class="sxs-lookup"><span data-stu-id="e61be-172">If a snapshot transaction attempts to commit an update to a row that was changed after the transaction began, the transaction is rolled back, and an error is raised.</span></span>  
  
## <a name="working-with-snapshot-isolation-in-adonet"></a><span data-ttu-id="e61be-173">Utilisation de l'isolation d'instantané dans ADO.NET</span><span class="sxs-lookup"><span data-stu-id="e61be-173">Working with Snapshot Isolation in ADO.NET</span></span>  
 <span data-ttu-id="e61be-174">L’isolation d’instantané est prise en charge dans ADO.NET avec la classe <xref:System.Data.SqlClient.SqlTransaction>.</span><span class="sxs-lookup"><span data-stu-id="e61be-174">Snapshot isolation is supported in ADO.NET by the <xref:System.Data.SqlClient.SqlTransaction> class.</span></span> <span data-ttu-id="e61be-175">Si une base de données a été activée pour l’isolation d’instantané mais n’est pas configurée pour READ_COMMITTED_SNAPSHOT ON, vous devez lancer un <xref:System.Data.SqlClient.SqlTransaction> en utilisant la valeur d’énumération **IsolationLevel.Snapshot** lors de l’appel de la méthode <xref:System.Data.SqlClient.SqlConnection.BeginTransaction%2A>.</span><span class="sxs-lookup"><span data-stu-id="e61be-175">If a database has been enabled for snapshot isolation but is not configured for READ_COMMITTED_SNAPSHOT ON, you must initiate a <xref:System.Data.SqlClient.SqlTransaction> using the **IsolationLevel.Snapshot** enumeration value when calling the <xref:System.Data.SqlClient.SqlConnection.BeginTransaction%2A> method.</span></span> <span data-ttu-id="e61be-176">Ce fragment de code suppose que la connexion est un objet <xref:System.Data.SqlClient.SqlConnection> ouvert.</span><span class="sxs-lookup"><span data-stu-id="e61be-176">This code fragment assumes that connection is an open <xref:System.Data.SqlClient.SqlConnection> object.</span></span>  
  
```vb  
Dim sqlTran As SqlTransaction = _  
  connection.BeginTransaction(IsolationLevel.Snapshot)  
```  
  
```csharp  
SqlTransaction sqlTran =
  connection.BeginTransaction(IsolationLevel.Snapshot);  
```  
  
### <a name="example"></a><span data-ttu-id="e61be-177"> Exemple</span><span class="sxs-lookup"><span data-stu-id="e61be-177">Example</span></span>  
 <span data-ttu-id="e61be-178">L’exemple suivant montre comment les différents niveaux d’isolation se comportent en tentant d’accéder aux données verrouillées et n’est pas destiné à être utilisé dans du code de production.</span><span class="sxs-lookup"><span data-stu-id="e61be-178">The following example demonstrates how the different isolation levels behave by attempting to access locked data, and it is not intended to be used in production code.</span></span>  
  
 <span data-ttu-id="e61be-179">Le code se connecte à l’exemple de base de données **AdventureWorks** dans SQL Server, crée une table nommée **TestSnapshot** et insère une ligne de données.</span><span class="sxs-lookup"><span data-stu-id="e61be-179">The code connects to the **AdventureWorks** sample database in SQL Server and creates a table named **TestSnapshot** and inserts one row of data.</span></span> <span data-ttu-id="e61be-180">Le code utilise l’instruction Transact-SQL ALTER DATABASE pour activer l’isolation d’instantané pour la base de données, mais il ne définit pas l’option READ_COMMITTED_SNAPSHOT, ce qui laisse le comportement de niveau d’isolation READ COMMITTED par défaut en vigueur.</span><span class="sxs-lookup"><span data-stu-id="e61be-180">The code uses the ALTER DATABASE Transact-SQL statement to turn on snapshot isolation for the database, but it does not set the READ_COMMITTED_SNAPSHOT option, leaving the default READ COMMITTED isolation-level behavior in effect.</span></span> <span data-ttu-id="e61be-181">Le code effectue ensuite les actions suivantes :</span><span class="sxs-lookup"><span data-stu-id="e61be-181">The code then performs the following actions:</span></span>  
  
- <span data-ttu-id="e61be-182">Il commence, mais ne termine pas, sqlTransaction1, qui utilise le niveau d’isolation SERIALIZABLE pour démarrer une transaction de mise à jour.</span><span class="sxs-lookup"><span data-stu-id="e61be-182">It begins, but does not complete, sqlTransaction1, which uses the SERIALIZABLE isolation level to start an update transaction.</span></span> <span data-ttu-id="e61be-183">Cela a pour effet de verrouiller la table.</span><span class="sxs-lookup"><span data-stu-id="e61be-183">This has the effect of locking the table.</span></span>  
  
- <span data-ttu-id="e61be-184">Il ouvre une seconde connexion et lance une seconde transaction en utilisant le niveau d’isolation SNAPSHOT pour lire les données dans la table **TestSnapshot**.</span><span class="sxs-lookup"><span data-stu-id="e61be-184">It opens a second connection and initiates a second transaction using the SNAPSHOT isolation level to read the data in the **TestSnapshot** table.</span></span> <span data-ttu-id="e61be-185">Étant donné que l’isolation d’instantané est activée, cette transaction peut lire les données qui existaient avant le démarrage de sqlTransaction1.</span><span class="sxs-lookup"><span data-stu-id="e61be-185">Because snapshot isolation is enabled, this transaction can read the data that existed before sqlTransaction1 started.</span></span>  
  
- <span data-ttu-id="e61be-186">Il ouvre une troisième connexion et initie une transaction en utilisant le niveau d’isolation READ COMMITTED pour tenter de lire les données de la table.</span><span class="sxs-lookup"><span data-stu-id="e61be-186">It opens a third connection and initiates a transaction using the READ COMMITTED isolation level to attempt to read the data in the table.</span></span> <span data-ttu-id="e61be-187">Dans ce cas, le code ne peut pas lire les données parce qu’il ne peut pas lire au-delà des verrous placés sur la table dans la première transaction et les temps. Le même résultat se produirait si les niveaux d’isolement REPEATABLE READ et SERIALIZABLE étaient utilisés parce que ces niveaux d’isolement ne peuvent pas non plus lire au-delà des verrous placés dans la première transaction.</span><span class="sxs-lookup"><span data-stu-id="e61be-187">In this case, the code cannot read the data because it cannot read past the locks placed on the table in the first transaction and times out. The same result would occur if the REPEATABLE READ and SERIALIZABLE isolation levels were used because these isolation levels also cannot read past the locks placed in the first transaction.</span></span>  
  
- <span data-ttu-id="e61be-188">Il ouvre une quatrième connexion et initie une transaction en utilisant le niveau d’isolation READ UNCOMMITTED, qui effectue une lecture erronée de la valeur non validée dans sqlTransaction1.</span><span class="sxs-lookup"><span data-stu-id="e61be-188">It opens a fourth connection and initiates a transaction using the READ UNCOMMITTED isolation level, which performs a dirty read of the uncommitted value in sqlTransaction1.</span></span> <span data-ttu-id="e61be-189">Cette valeur peut ne jamais exister dans la base de données si la première transaction n’est pas validée.</span><span class="sxs-lookup"><span data-stu-id="e61be-189">This value may never actually exist in the database if the first transaction is not committed.</span></span>  
  
- <span data-ttu-id="e61be-190">Elle annule la première transaction et nettoie en supprimant la table **TestSnapshot** et en désactivant l’isolation d’instantané pour la base de données **AdventureWorks**.</span><span class="sxs-lookup"><span data-stu-id="e61be-190">It rolls back the first transaction and cleans up by deleting the **TestSnapshot** table and turning off snapshot isolation for the **AdventureWorks** database.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="e61be-191">Les exemples suivants utilisent la même chaîne de connexion avec le regroupement de connexions désactivé.</span><span class="sxs-lookup"><span data-stu-id="e61be-191">The following examples use the same connection string with connection pooling turned off.</span></span> <span data-ttu-id="e61be-192">Si une connexion est regroupée, la réinitialisation de son niveau d’isolation ne rétablit pas le niveau d’isolation sur le serveur.</span><span class="sxs-lookup"><span data-stu-id="e61be-192">If a connection is pooled, resetting its isolation level does not reset the isolation level at the server.</span></span> <span data-ttu-id="e61be-193">Par conséquent, les connexions suivantes qui utilisent la même connexion interne regroupée démarrent avec leurs niveaux d’isolation définis sur ceux de la connexion regroupée.</span><span class="sxs-lookup"><span data-stu-id="e61be-193">As a result, subsequent connections that use the same pooled inner connection start with their isolation levels set to that of the pooled connection.</span></span> <span data-ttu-id="e61be-194">Une alternative à la désactivation du regroupement de connexions consiste à définir le niveau d’isolation de manière explicite pour chaque connexion.</span><span class="sxs-lookup"><span data-stu-id="e61be-194">An alternative to turning off connection pooling is to set the isolation level explicitly for each connection.</span></span>  
  
 [!code-csharp[DataWorks SnapshotIsolation.Demo#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SnapshotIsolation.Demo/CS/source.cs#1)]
 [!code-vb[DataWorks SnapshotIsolation.Demo#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SnapshotIsolation.Demo/VB/source.vb#1)]  
  
### <a name="example"></a><span data-ttu-id="e61be-195"> Exemple</span><span class="sxs-lookup"><span data-stu-id="e61be-195">Example</span></span>  
 <span data-ttu-id="e61be-196">L’exemple suivant illustre le comportement de l’isolation d’instantané quand des données sont modifiées.</span><span class="sxs-lookup"><span data-stu-id="e61be-196">The following example demonstrates the behavior of snapshot isolation when data is being modified.</span></span> <span data-ttu-id="e61be-197">Le code effectue les actions suivantes :</span><span class="sxs-lookup"><span data-stu-id="e61be-197">The code performs the following actions:</span></span>  
  
- <span data-ttu-id="e61be-198">Il établit une connexion avec l’exemple de base de données **AdventureWorks** et active l’isolation SNAPSHOT.</span><span class="sxs-lookup"><span data-stu-id="e61be-198">Connects to the **AdventureWorks** sample database and enables SNAPSHOT isolation.</span></span>  
  
- <span data-ttu-id="e61be-199">Il crée une table nommée **TestSnapshotUpdate** et insère trois lignes d’exemples de données.</span><span class="sxs-lookup"><span data-stu-id="e61be-199">Creates a table named **TestSnapshotUpdate** and inserts three rows of sample data.</span></span>  
  
- <span data-ttu-id="e61be-200">Commence, mais ne se termine pas, car sqlTransaction1 utilise l’isolation d’instantané.</span><span class="sxs-lookup"><span data-stu-id="e61be-200">Begins, but does not complete, sqlTransaction1 using SNAPSHOT isolation.</span></span> <span data-ttu-id="e61be-201">Trois lignes de données sont sélectionnées dans la transaction.</span><span class="sxs-lookup"><span data-stu-id="e61be-201">Three rows of data are selected in the transaction.</span></span>  
  
- <span data-ttu-id="e61be-202">Il crée une seconde **SqlConnection** à **AdventureWorks** et une seconde transaction utilisant le niveau d’isolation READ COMMITTED, qui met à jour une valeur dans l’une des lignes sélectionnées dans sqlTransaction1.</span><span class="sxs-lookup"><span data-stu-id="e61be-202">Creates a second **SqlConnection** to **AdventureWorks** and creates a second transaction using the READ COMMITTED isolation level that updates a value in one of the rows selected in sqlTransaction1.</span></span>  
  
- <span data-ttu-id="e61be-203">Valide sqlTransaction2.</span><span class="sxs-lookup"><span data-stu-id="e61be-203">Commits sqlTransaction2.</span></span>  
  
- <span data-ttu-id="e61be-204">Retourne à sqlTransaction1 et tente de mettre à jour la même ligne que celle que sqlTransaction1 a déjà validée.</span><span class="sxs-lookup"><span data-stu-id="e61be-204">Returns to sqlTransaction1 and attempts to update the same row that sqlTransaction1 already committed.</span></span> <span data-ttu-id="e61be-205">L’erreur 3960 est déclenchée et sqlTransaction1 est restaurée automatiquement.</span><span class="sxs-lookup"><span data-stu-id="e61be-205">Error 3960 is raised, and sqlTransaction1 is rolled back automatically.</span></span> <span data-ttu-id="e61be-206">**SqlException.Number** et **SqlException.Message** s’affichent dans la fenêtre de console.</span><span class="sxs-lookup"><span data-stu-id="e61be-206">The **SqlException.Number** and **SqlException.Message** are displayed in the Console window.</span></span>  
  
- <span data-ttu-id="e61be-207">Il exécute un code de nettoyage pour désactiver l’isolation d’instantané dans **AdventureWorks** et supprimer la table **TestSnapshotUpdate**.</span><span class="sxs-lookup"><span data-stu-id="e61be-207">Executes clean-up code to turn off snapshot isolation in **AdventureWorks** and delete the **TestSnapshotUpdate** table.</span></span>  
  
 [!code-csharp[DataWorks SnapshotIsolation.DemoUpdate#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SnapshotIsolation.DemoUpdate/CS/source.cs#1)]
 [!code-vb[DataWorks SnapshotIsolation.DemoUpdate#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SnapshotIsolation.DemoUpdate/VB/source.vb#1)]  
  
### <a name="using-lock-hints-with-snapshot-isolation"></a><span data-ttu-id="e61be-208">Utilisation d'indicateurs de verrou avec une isolation d'instantané</span><span class="sxs-lookup"><span data-stu-id="e61be-208">Using Lock Hints with Snapshot Isolation</span></span>  
 <span data-ttu-id="e61be-209">Dans l’exemple précédent, la première transaction sélectionne des données et une deuxième transaction met à jour les données avant que la première transaction puisse se terminer, provoquant un conflit de mise à jour lorsque la première transaction tente de mettre à jour la même ligne.</span><span class="sxs-lookup"><span data-stu-id="e61be-209">In the previous example, the first transaction selects data, and a second transaction updates the data before the first transaction is able to complete, causing an update conflict when the first transaction tries to update the same row.</span></span> <span data-ttu-id="e61be-210">Vous pouvez réduire le risque de conflits de mise à jour dans les transactions d’instantanés de longue durée en fournissant des indicateurs de verrou au début de la transaction.</span><span class="sxs-lookup"><span data-stu-id="e61be-210">You can reduce the chance of update conflicts in long-running snapshot transactions by supplying lock hints at the beginning of the transaction.</span></span> <span data-ttu-id="e61be-211">L’instruction SELECT suivante utilise l’indicateur UPDLOCK pour verrouiller les lignes sélectionnées :</span><span class="sxs-lookup"><span data-stu-id="e61be-211">The following SELECT statement uses the UPDLOCK hint to lock the selected rows:</span></span>  
  
```sql  
SELECT * FROM TestSnapshotUpdate WITH (UPDLOCK)
  WHERE PriKey BETWEEN 1 AND 3  
```  
  
 <span data-ttu-id="e61be-212">L’utilisation de l’indicateur de verrou UPDLOCK bloque toutes les lignes tentant de mettre à jour les lignes avant la fin de la première transaction.</span><span class="sxs-lookup"><span data-stu-id="e61be-212">Using the UPDLOCK lock hint blocks any rows attempting to update the rows before the first transaction completes.</span></span> <span data-ttu-id="e61be-213">Cela garantit que les lignes sélectionnées n’ont aucun conflit lorsqu’elles sont mises à jour ultérieurement dans la transaction.</span><span class="sxs-lookup"><span data-stu-id="e61be-213">This guarantees that the selected rows have no conflicts when they are updated later in the transaction.</span></span> <span data-ttu-id="e61be-214">Consultez « Indicateurs de verrouillage » dans la Documentation en ligne de SQL Server.</span><span class="sxs-lookup"><span data-stu-id="e61be-214">See "Locking Hints" in SQL Server Books Online.</span></span>  
  
 <span data-ttu-id="e61be-215">Si votre application présente de nombreux conflits, l’isolation d’instantané n’est peut-être pas le meilleur choix.</span><span class="sxs-lookup"><span data-stu-id="e61be-215">If your application has many conflicts, snapshot isolation may not be the best choice.</span></span> <span data-ttu-id="e61be-216">Les indicateurs doivent être utilisés uniquement lorsque cela est vraiment nécessaire.</span><span class="sxs-lookup"><span data-stu-id="e61be-216">Hints should only be used when really needed.</span></span> <span data-ttu-id="e61be-217">Votre application ne doit pas être conçue de manière à ce qu’elle s’appuie constamment sur des indicateurs de verrou pour son fonctionnement.</span><span class="sxs-lookup"><span data-stu-id="e61be-217">Your application should not be designed so that it constantly relies on lock hints for its operation.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="e61be-218">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="e61be-218">See also</span></span>

- [<span data-ttu-id="e61be-219">SQL Server et ADO.NET</span><span class="sxs-lookup"><span data-stu-id="e61be-219">SQL Server and ADO.NET</span></span>](index.md)
- [<span data-ttu-id="e61be-220">Vue d'ensemble d’ADO.NET</span><span class="sxs-lookup"><span data-stu-id="e61be-220">ADO.NET Overview</span></span>](../ado-net-overview.md)
- [<span data-ttu-id="e61be-221">Guide du verrouillage des transactions et du contrôle de version de ligne</span><span class="sxs-lookup"><span data-stu-id="e61be-221">Transaction Locking and Row Versioning Guide</span></span>](/sql/relational-databases/sql-server-transaction-locking-and-row-versioning-guide)
