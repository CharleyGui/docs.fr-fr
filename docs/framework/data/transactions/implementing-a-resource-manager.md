---
title: Implémentation d'un gestionnaire des ressources
description: Implémentez un gestionnaire de ressources dans .NET. Un gestionnaire de ressources gère les ressources utilisées dans les transactions. Un gestionnaire de transactions coordonne les actions du gestionnaire de ressources.
ms.date: 03/30/2017
ms.assetid: d5c153f6-4419-49e3-a5f1-a50ae4c81bf3
ms.openlocfilehash: e6370f6b544255ebdc402f06b7977d4a3a587c32
ms.sourcegitcommit: 5b475c1855b32cf78d2d1bbb4295e4c236f39464
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 09/24/2020
ms.locfileid: "91182894"
---
# <a name="implementing-a-resource-manager"></a><span data-ttu-id="320f5-105">Implémentation d'un gestionnaire des ressources</span><span class="sxs-lookup"><span data-stu-id="320f5-105">Implementing a Resource Manager</span></span>

<span data-ttu-id="320f5-106">Les ressources utilisées dans une transaction sont managées par un gestionnaire de ressources, dont les actions sont coordonnées par un gestionnaire de transactions.</span><span class="sxs-lookup"><span data-stu-id="320f5-106">Each resource used in a transaction is managed by a resource manager, whose actions are coordinated by a transaction manager.</span></span> <span data-ttu-id="320f5-107">Les gestionnaires de ressources travaillent en coopération avec le gestionnaire de transactions pour fournir à l'application la garantie de l'atomicité et de l'isolation.</span><span class="sxs-lookup"><span data-stu-id="320f5-107">Resource managers work in cooperation with the transaction manager to provide the application with a guarantee of atomicity and isolation.</span></span> <span data-ttu-id="320f5-108">Microsoft SQL Server, les files d'attente de messages durables et les tables de hachage en mémoire sont des gestionnaires de ressources.</span><span class="sxs-lookup"><span data-stu-id="320f5-108">Microsoft SQL Server, durable message queues, in-memory hash tables are all examples of resource managers.</span></span>  
  
 <span data-ttu-id="320f5-109">Les gestionnaires de ressources gèrent des données durables ou volatiles.</span><span class="sxs-lookup"><span data-stu-id="320f5-109">A resource manager manages either durable or volatile data.</span></span> <span data-ttu-id="320f5-110">La durabilité (ou à l'inverse la volatilité) d'un gestionnaire de ressources indique s'il prend en charge la récupération après défaillance.</span><span class="sxs-lookup"><span data-stu-id="320f5-110">The durability (or conversely the volatility) of a resource manager refers to whether the resource manager supports failure recovery.</span></span> <span data-ttu-id="320f5-111">Si un gestionnaire de ressources prend en charge la récupération après défaillance, il conserve les données par stockage durable lors de la Phase1 (préparation). Ainsi, s'il connaît une défaillance, il peut à nouveau s'inscrire à la transaction après récupération et procéder aux actions indiquées par les notifications envoyées par le gestionnaire de transactions.</span><span class="sxs-lookup"><span data-stu-id="320f5-111">If a resource manager supports failure recovery, it persists data to durable storage during Phase1 (prepare) such that if the resource manager goes down, it can re-enlist in the transaction upon recovery and perform the proper actions based on the notifications received from the transaction manager.</span></span> <span data-ttu-id="320f5-112">En général, les gestionnaires de ressources volatiles gèrent les ressources volatiles, comme une structure de données en mémoire (par exemple, une table de hachage traitée en mémoire), et les gestionnaires de ressources durables gèrent les ressources qui disposent d'un magasin de stockage plus persistant (par exemple, une base de données ayant un disque comme magasin de stockage).</span><span class="sxs-lookup"><span data-stu-id="320f5-112">In general, volatile resource managers manage volatile resources such as an in-memory data structure (for example, an in-memory transacted-hashtable), and durable resource managers manage resources that have a more persistent backing store (for example, a database whose backing store is disk).</span></span>  
  
 <span data-ttu-id="320f5-113">Pour qu'une ressource participe à une transaction, elle doit être inscrite à cette transaction.</span><span class="sxs-lookup"><span data-stu-id="320f5-113">In order for a resource to participate in a transaction, it must enlist in the transaction.</span></span> <span data-ttu-id="320f5-114">La <xref:System.Transactions.Transaction> classe définit un ensemble de méthodes dont les noms commencent par **Enlist** qui fournissent cette fonctionnalité.</span><span class="sxs-lookup"><span data-stu-id="320f5-114">The <xref:System.Transactions.Transaction> class defines a set of methods whose names begin with **Enlist** that provide this functionality.</span></span> <span data-ttu-id="320f5-115">Les différentes méthodes d' **enrôle** correspondent aux différents types d’inscription qu’un gestionnaire de ressources peut avoir.</span><span class="sxs-lookup"><span data-stu-id="320f5-115">The different **Enlist** methods correspond to the different types of enlistment that a resource manager may have.</span></span> <span data-ttu-id="320f5-116">En particulier, utilisez les méthodes <xref:System.Transactions.Transaction.EnlistVolatile%2A> pour les ressources volatiles et la méthode <xref:System.Transactions.Transaction.EnlistDurable%2A> pour les ressources durables.</span><span class="sxs-lookup"><span data-stu-id="320f5-116">Specifically, you use the <xref:System.Transactions.Transaction.EnlistVolatile%2A> methods for volatile resources, and the <xref:System.Transactions.Transaction.EnlistDurable%2A> method for durable resources.</span></span> <span data-ttu-id="320f5-117">Pour une question de simplicité, après avoir décidé d'utiliser la méthode <xref:System.Transactions.Transaction.EnlistDurable%2A> ou la méthode <xref:System.Transactions.Transaction.EnlistVolatile%2A>, selon la prise en charge de la durabilité de la ressource, inscrivez votre ressource pour participer à la validation en deux phases (2PC) en implémentant l'interface <xref:System.Transactions.IEnlistmentNotification> de votre gestionnaire de ressources.</span><span class="sxs-lookup"><span data-stu-id="320f5-117">For simplicity, after deciding whether to use the <xref:System.Transactions.Transaction.EnlistDurable%2A> or <xref:System.Transactions.Transaction.EnlistVolatile%2A> method based on your resource's durability support, you should enlist your resource to participate in Two Phase Commit (2PC) by implementing the <xref:System.Transactions.IEnlistmentNotification> interface for your resource manager.</span></span> <span data-ttu-id="320f5-118">Pour plus d’informations sur 2PC, consultez [validation d’une transaction en une phase unique et en plusieurs phases](committing-a-transaction-in-single-phase-and-multi-phase.md).</span><span class="sxs-lookup"><span data-stu-id="320f5-118">For more information on 2PC, see [Committing a Transaction in Single-Phase and Multi-Phase](committing-a-transaction-in-single-phase-and-multi-phase.md).</span></span>  
  
 <span data-ttu-id="320f5-119">En s'inscrivant, le gestionnaire de ressources s'assure de la réception des rappels du gestionnaire de transactions lors de la validation ou de l'abandon de la transaction.</span><span class="sxs-lookup"><span data-stu-id="320f5-119">By enlisting, the resource manager ensures that it gets callbacks from the transaction manager when the transaction commits or aborts.</span></span> <span data-ttu-id="320f5-120">On compte une instance de <xref:System.Transactions.IEnlistmentNotification> par inscription.</span><span class="sxs-lookup"><span data-stu-id="320f5-120">There is one instance of <xref:System.Transactions.IEnlistmentNotification> per enlistment.</span></span> <span data-ttu-id="320f5-121">En général, on trouve une inscription par transaction, mais un gestionnaire de ressources peut choisir de s'inscrire plusieurs fois à la même transaction.</span><span class="sxs-lookup"><span data-stu-id="320f5-121">Typically, there is one enlistment per transaction, but a resource manager can choose to enlist multiple times in the same transaction.</span></span>  
  
 <span data-ttu-id="320f5-122">Après inscription, le gestionnaire de ressources répond aux requêtes de la transaction.</span><span class="sxs-lookup"><span data-stu-id="320f5-122">After enlistment, the resource manager responds to the transaction's requests.</span></span> <span data-ttu-id="320f5-123">Un gestionnaire de ressources durables enregistre suffisamment d'informations pour pouvoir annuler ou répéter le travail de la transaction sur les ressources qu'il manage.</span><span class="sxs-lookup"><span data-stu-id="320f5-123">A durable resource manager stores enough information to allow it to either undo or redo the transaction's work on resources it manages.</span></span> <span data-ttu-id="320f5-124">Il existe de nombreuses façon d'effectuer cela ; conserver des versions des données ou conserver un journal des modifications sont deux techniques communes.</span><span class="sxs-lookup"><span data-stu-id="320f5-124">There are many ways to do this; keeping versions of data or keeping a log of the changes are two common techniques.</span></span>  
  
 <span data-ttu-id="320f5-125">Lorsque l'application valide la transaction, le gestionnaire de transactions lance le protocole de validation en deux phases.</span><span class="sxs-lookup"><span data-stu-id="320f5-125">When the application commits the transaction, the transaction manager initiates the two-phase commit protocol.</span></span> <span data-ttu-id="320f5-126">Le gestionnaire de transactions interroge d'abord chaque gestionnaire de ressources inscrit pour savoir s'il est prêt pour la validation de la transaction.</span><span class="sxs-lookup"><span data-stu-id="320f5-126">The transaction manager first asks each enlisted resource manager if it is prepared to commit the transaction.</span></span> <span data-ttu-id="320f5-127">Le gestionnaire de ressources doit se préparer pour la validation : il se prépare à valider ou abandonner la transaction.</span><span class="sxs-lookup"><span data-stu-id="320f5-127">The resource manager must prepare to commit—it readies itself to either commit or abort the transaction.</span></span>  
  
 <span data-ttu-id="320f5-128">Lors de la phase de préparation, le gestionnaire de ressources durables enregistre les nouvelles et anciennes données dans un espace de stockage stable de façon à ce que le gestionnaire de ressources puisse les récupérer, même en cas de défaillance système.</span><span class="sxs-lookup"><span data-stu-id="320f5-128">During the prepare phase, the durable resource manager records the old and new data in stable storage so that the resource manager can recover it even if the system fails.</span></span> <span data-ttu-id="320f5-129">Si le gestionnaire de ressources peut effectuer la préparation, il communique au gestionnaire de transactions son vote de validation ou d'abandon de la transaction.</span><span class="sxs-lookup"><span data-stu-id="320f5-129">If the resource manager can prepare, it informs the transaction manager its vote on whether to commit or abort the transaction.</span></span> <span data-ttu-id="320f5-130">Si le gestionnaire de ressources signale un échec de préparation, le gestionnaire de transactions envoie une commande de restauration à chaque gestionnaire de ressources et indique l'échec de validation à l'application.</span><span class="sxs-lookup"><span data-stu-id="320f5-130">If any resource manager reports a failure to prepare, the transaction manager sends a rollback command to each resource manager and indicates the failure of the commit to the application.</span></span>  
  
 <span data-ttu-id="320f5-131">Une fois préparé, un gestionnaire de ressources doit patienter jusqu'à la réception d'un rappel à validation ou d'abandon du gestionnaire de transactions en phase 2.</span><span class="sxs-lookup"><span data-stu-id="320f5-131">Once prepared, a resource manager must wait until it gets a commit or abort callback from the transaction manager in phase 2.</span></span> <span data-ttu-id="320f5-132">Généralement, l'intégralité du protocole de préparation et de validation ne prend qu'une fraction de seconde.</span><span class="sxs-lookup"><span data-stu-id="320f5-132">Typically, the entire prepare and commit protocol completes in a fraction of a second.</span></span> <span data-ttu-id="320f5-133">En cas de défaillance système ou de communication, la notification de validation ou d'abandon peut ne pas arriver avant des minutes, voire des heures.</span><span class="sxs-lookup"><span data-stu-id="320f5-133">If there are system or communication failures, the commit or abort notification may not arrive for minutes or hours.</span></span> <span data-ttu-id="320f5-134">Pendant ce temps, le gestionnaire de ressources ne connaît pas le résultat de la transaction.</span><span class="sxs-lookup"><span data-stu-id="320f5-134">During this period, the resource manager is in doubt about the outcome of the transaction.</span></span> <span data-ttu-id="320f5-135">Il ne sait pas si elle est validée ou abandonnée.</span><span class="sxs-lookup"><span data-stu-id="320f5-135">It does not know whether the transaction committed or aborted.</span></span> <span data-ttu-id="320f5-136">Tant que le gestionnaire de ressources ne connaît pas le résultat d'une transaction, il conserve les données modifiées en laissant la transaction verrouillée, isolant ces modifications des autres transactions.</span><span class="sxs-lookup"><span data-stu-id="320f5-136">While the resource manager is in doubt about a transaction, it keeps the data modified by keeping the transaction locked, thereby isolating these changes from any other transactions.</span></span>  
  
 <span data-ttu-id="320f5-137">Lors d'une défaillance du gestionnaire de ressources, l'ensemble des transactions inscrites sont abandonnées, à l'exception de celles préparées ou validées avant la défaillance.</span><span class="sxs-lookup"><span data-stu-id="320f5-137">When a resource manager fails, all of its enlisted transactions are aborted except for those that are prepared or committed prior to the failure.</span></span> <span data-ttu-id="320f5-138">Lors de son redémarrage, un gestionnaire de ressources durables reconstruit l'état validé des ressources qu'il manage en récupérant les informations de préparation écrites en phase de préparation, puis valide ou abandonne ces transactions.</span><span class="sxs-lookup"><span data-stu-id="320f5-138">When a durable resource manager restarts, it reconstructs the committed state of the resources it manages by retrieving the prepare information written in the prepare phase, and commits or aborts these transactions accordingly.</span></span>  
  
 <span data-ttu-id="320f5-139">En résumé, le protocole de validation en deux phases et les gestionnaires de ressources s'associent pour assurer l'atomicité et la durabilité des transactions.</span><span class="sxs-lookup"><span data-stu-id="320f5-139">In summary, the two-phase commit protocol and the resource managers combine to make transactions atomic and durable.</span></span>  
  
 <span data-ttu-id="320f5-140">La classe <xref:System.Transactions.Transaction> fournit également la méthode <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> permettant de s'inscrire à une PSPE (Promotable Single Phase Enlistment).</span><span class="sxs-lookup"><span data-stu-id="320f5-140">The <xref:System.Transactions.Transaction> class also provides the <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> method to enlist a Promotable Single Phase Enlistment (PSPE).</span></span> <span data-ttu-id="320f5-141">Cela permet à un gestionnaire de ressources durables d'héberger et de « posséder » une transaction qui peut, si nécessaire, être ensuite remontée pour être managée par le MSDTC.</span><span class="sxs-lookup"><span data-stu-id="320f5-141">This allows a durable resource manager (RM) to host and "own" a transaction that can later be escalated to be managed by the MSDTC if necessary.</span></span> <span data-ttu-id="320f5-142">Pour plus d’informations, consultez [optimisation à l’aide de la validation à phase unique et de la notification à phase unique pouvant être promue](optimization-spc-and-promotable-spn.md).</span><span class="sxs-lookup"><span data-stu-id="320f5-142">For more information on this, see [Optimization using Single Phase Commit and Promotable Single Phase Notification](optimization-spc-and-promotable-spn.md).</span></span>  
  
## <a name="in-this-section"></a><span data-ttu-id="320f5-143">Dans cette section</span><span class="sxs-lookup"><span data-stu-id="320f5-143">In This Section</span></span>  

 <span data-ttu-id="320f5-144">Les étapes généralement suivies par un gestionnaire de ressources sont détaillées dans les rubriques suivantes.</span><span class="sxs-lookup"><span data-stu-id="320f5-144">The steps generally followed by a resource manager are outlined in the following topics.</span></span>  
  
 [<span data-ttu-id="320f5-145">Inscription de ressources comme participants à une transaction</span><span class="sxs-lookup"><span data-stu-id="320f5-145">Enlisting Resources as Participants in a Transaction</span></span>](enlisting-resources-as-participants-in-a-transaction.md)  
  
 <span data-ttu-id="320f5-146">Décrit comment inscrire une ressource durable ou volatile à une transaction.</span><span class="sxs-lookup"><span data-stu-id="320f5-146">Describes how a durable or volatile resource can enlist in a transaction.</span></span>  
  
 [<span data-ttu-id="320f5-147">Validation d'une transaction en une phase unique et en plusieurs phases</span><span class="sxs-lookup"><span data-stu-id="320f5-147">Committing a Transaction in Single-Phase and Multi-Phase</span></span>](committing-a-transaction-in-single-phase-and-multi-phase.md)  
  
 <span data-ttu-id="320f5-148">Décrit la façon dont un gestionnaire de ressources répond à la notification de validation et prépare la validation.</span><span class="sxs-lookup"><span data-stu-id="320f5-148">Describes how a resource manager responds to commit notification and prepare the commit.</span></span>  
  
 [<span data-ttu-id="320f5-149">Exécution de la récupération</span><span class="sxs-lookup"><span data-stu-id="320f5-149">Performing Recovery</span></span>](performing-recovery.md)  
  
 <span data-ttu-id="320f5-150">Décrit comment un gestionnaire de ressources durables récupère après la défaillance.</span><span class="sxs-lookup"><span data-stu-id="320f5-150">Describes how a durable resource manager recovers from failure.</span></span>  
  
 [<span data-ttu-id="320f5-151">Niveaux de confiance de sécurité dans l'accès aux ressources</span><span class="sxs-lookup"><span data-stu-id="320f5-151">Security Trust Levels in Accessing Resources</span></span>](security-trust-levels-in-accessing-resources.md)  
  
 <span data-ttu-id="320f5-152">Décrit comment les trois niveaux de confiance de System.Transactions permettent de restreindre l'accès aux types de ressources que <xref:System.Transactions> expose.</span><span class="sxs-lookup"><span data-stu-id="320f5-152">Describes how the three levels of trust for System.Transactions restrict access on the types of resources that <xref:System.Transactions> exposes.</span></span>  
  
 [<span data-ttu-id="320f5-153">Optimisation à l'aide de la validation à phase unique et de la notification de phase unique pouvant être promue</span><span class="sxs-lookup"><span data-stu-id="320f5-153">Optimization using Single Phase Commit and Promotable Single Phase Notification</span></span>](optimization-spc-and-promotable-spn.md)  
  
 <span data-ttu-id="320f5-154">Décrit les pratiques d'optimisation disponibles pour l'implémentations des gestionnaires de ressources.</span><span class="sxs-lookup"><span data-stu-id="320f5-154">Describes optimization practices available to implementations of resource managers.</span></span>
