---
title: Inscription de ressources comme participants à une transaction
description: Inscrire des ressources en tant que participants dans une transaction .NET. Chaque ressource d’une transaction est gérée par un gestionnaire de ressources, coordonné par un gestionnaire de transactions.
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: 786a12c2-d530-49f4-9c59-5c973e15a11d
ms.openlocfilehash: c3c777593750b3a4f05ae97ed6e26e19f58e4d72
ms.sourcegitcommit: 6219b1e1feccb16d88656444210fed3297f5611e
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 06/22/2020
ms.locfileid: "85141873"
---
# <a name="enlisting-resources-as-participants-in-a-transaction"></a><span data-ttu-id="1557f-104">Inscription de ressources comme participants à une transaction</span><span class="sxs-lookup"><span data-stu-id="1557f-104">Enlisting Resources as Participants in a Transaction</span></span>

<span data-ttu-id="1557f-105">Les ressources participant à une transaction sont managées par un gestionnaire de ressources, dont les actions sont coordonnées par un gestionnaire de transactions.</span><span class="sxs-lookup"><span data-stu-id="1557f-105">Each resource participating in a transaction is managed by a resource manager, whose actions are coordinated by a transaction manager.</span></span> <span data-ttu-id="1557f-106">La coordination s'effectue par envoi de notifications aux abonnés qui se sont inscrits à une transaction via le gestionnaire de transactions.</span><span class="sxs-lookup"><span data-stu-id="1557f-106">The coordination is done through notifications given to subscribers who have enlisted in a transaction through the transaction manager.</span></span>

<span data-ttu-id="1557f-107">Cette rubrique explique comment inscrire une ressource (ou plusieurs ressources) à une transaction et traite des différents types d'inscription.</span><span class="sxs-lookup"><span data-stu-id="1557f-107">This topic covers how a resource (or multiple resources) can be enlisted in a transaction, as well as the different types of enlistment.</span></span> <span data-ttu-id="1557f-108">La rubrique [validation d’une transaction en une seule phase et en plusieurs phases](committing-a-transaction-in-single-phase-and-multi-phase.md) couvre la manière dont l’engagement de transaction peut être coordonné parmi les ressources inscrites.</span><span class="sxs-lookup"><span data-stu-id="1557f-108">The [Committing a Transaction in Single-Phase and Multi-Phase](committing-a-transaction-in-single-phase-and-multi-phase.md) topic covers how transaction commitment can be coordinated among enlisted resources.</span></span>

## <a name="enlisting-resources-in-a-transaction"></a><span data-ttu-id="1557f-109">Inscription de ressources à une transaction</span><span class="sxs-lookup"><span data-stu-id="1557f-109">Enlisting Resources in a Transaction</span></span>

<span data-ttu-id="1557f-110">Pour qu'une ressource participe à une transaction, elle doit être inscrite à cette transaction.</span><span class="sxs-lookup"><span data-stu-id="1557f-110">In order for a resource to participate in a transaction, it must enlist in the transaction.</span></span> <span data-ttu-id="1557f-111">La <xref:System.Transactions.Transaction> classe définit un ensemble de méthodes dont les noms commencent par **Enlist** qui fournissent cette fonctionnalité.</span><span class="sxs-lookup"><span data-stu-id="1557f-111">The <xref:System.Transactions.Transaction> class defines a set of methods whose names begin with **Enlist** that provide this functionality.</span></span> <span data-ttu-id="1557f-112">Les différentes méthodes d' **enrôle** correspondent aux différents types d’inscription qu’un gestionnaire de ressources peut avoir.</span><span class="sxs-lookup"><span data-stu-id="1557f-112">The different **Enlist** methods correspond to the different types of enlistment that a resource manager may have.</span></span> <span data-ttu-id="1557f-113">En particulier, utilisez les méthodes <xref:System.Transactions.Transaction.EnlistVolatile%2A> pour les ressources volatiles et la méthode <xref:System.Transactions.Transaction.EnlistDurable%2A> pour les ressources durables.</span><span class="sxs-lookup"><span data-stu-id="1557f-113">Specifically, you use the <xref:System.Transactions.Transaction.EnlistVolatile%2A> methods for volatile resources, and the <xref:System.Transactions.Transaction.EnlistDurable%2A> method for durable resources.</span></span> <span data-ttu-id="1557f-114">La durabilité (ou à l'inverse la volatilité) d'un gestionnaire de ressources indique s'il prend en charge la récupération après défaillance.</span><span class="sxs-lookup"><span data-stu-id="1557f-114">The durability (or conversely the volatility) of a resource manager refers to whether the resource manager supports failure recovery.</span></span> <span data-ttu-id="1557f-115">Si un gestionnaire de ressources prend en charge la récupération après défaillance, il conserve les données par stockage durable lors de la Phase1 (préparation). Ainsi, s'il connaît une défaillance, il peut à nouveau s'inscrire à la transaction après récupération et procéder aux actions indiquées par les notifications envoyées par le gestionnaire de transactions.</span><span class="sxs-lookup"><span data-stu-id="1557f-115">If a resource manager supports failure recovery, it persists data to durable storage during Phase1 (prepare) such that if the resource manager goes down, it can re-enlist in the transaction upon recovery and perform the proper actions based on the notifications received from the TM.</span></span> <span data-ttu-id="1557f-116">En général, les gestionnaires de ressources volatiles gèrent les ressources volatiles, comme une structure de données en mémoire (par exemple, une table de hachage traitée en mémoire), et les gestionnaires de ressources durables gèrent les ressources qui disposent d'un magasin de stockage plus persistant (par exemple, une base de données ayant un disque comme magasin de stockage).</span><span class="sxs-lookup"><span data-stu-id="1557f-116">In general, volatile resource managers manage volatile resources such as an in-memory data structure (for example, an in-memory transacted-hashtable), and durable resource managers manage resources that have a more persistent backing store (for example, a database whose backing store is disk).</span></span>

<span data-ttu-id="1557f-117">Pour une question de simplicité, après avoir décidé d'utiliser la méthode <xref:System.Transactions.Transaction.EnlistDurable%2A> ou la méthode <xref:System.Transactions.Transaction.EnlistVolatile%2A>, selon la prise en charge de la durabilité de la ressource, inscrivez votre ressource pour participer à la validation en deux phases (2PC) en implémentant l'interface <xref:System.Transactions.IEnlistmentNotification> de votre gestionnaire de ressources.</span><span class="sxs-lookup"><span data-stu-id="1557f-117">For simplicity, after deciding whether to use the <xref:System.Transactions.Transaction.EnlistDurable%2A> or <xref:System.Transactions.Transaction.EnlistVolatile%2A> method based on your resource's durability support, you should enlist your resource to participate in Two Phase Commit (2PC) by implementing the <xref:System.Transactions.IEnlistmentNotification> interface for your resource manager.</span></span> <span data-ttu-id="1557f-118">Pour plus d’informations sur 2PC, consultez [validation d’une transaction en une phase unique et en plusieurs phases](committing-a-transaction-in-single-phase-and-multi-phase.md).</span><span class="sxs-lookup"><span data-stu-id="1557f-118">For more information on 2PC, see [Committing a Transaction in Single-Phase and Multi-Phase](committing-a-transaction-in-single-phase-and-multi-phase.md).</span></span>

<span data-ttu-id="1557f-119">Un participant peut s'inscrire à plusieurs de ces protocoles en appelant <xref:System.Transactions.Transaction.EnlistDurable%2A> et <xref:System.Transactions.Transaction.EnlistVolatile%2A> à plusieurs reprises.</span><span class="sxs-lookup"><span data-stu-id="1557f-119">A single participant can enlist for more than one of these protocols by calling <xref:System.Transactions.Transaction.EnlistDurable%2A> and <xref:System.Transactions.Transaction.EnlistVolatile%2A> multiple times.</span></span>

### <a name="durable-enlistment"></a><span data-ttu-id="1557f-120">Inscription durable</span><span class="sxs-lookup"><span data-stu-id="1557f-120">Durable Enlistment</span></span>

<span data-ttu-id="1557f-121">Les méthodes <xref:System.Transactions.Transaction.EnlistDurable%2A> permettent d'inscrire un gestionnaire de ressources à une transaction en tant de ressource durable.</span><span class="sxs-lookup"><span data-stu-id="1557f-121">The <xref:System.Transactions.Transaction.EnlistDurable%2A> methods are used to enlist a resource manager for participation in the transaction as a durable resource.</span></span>  <span data-ttu-id="1557f-122">Si un gestionnaire de ressources durables s'arrête en cours de transaction, il peut procéder à la récupération une fois sa remise en ligne effectuée par réinscription (à l'aide de la méthode <xref:System.Transactions.TransactionManager.Reenlist%2A>) à toutes les transactions auxquelles il participait et dont il n'a pas terminé la phase 2, et appeler <xref:System.Transactions.TransactionManager.RecoveryComplete%2A> une fois le traitement de récupération terminé.</span><span class="sxs-lookup"><span data-stu-id="1557f-122">It is expected that if a durable resource manager is brought down in the middle of a transaction, it can perform recovery once it is brought back online by reenlisting (using the <xref:System.Transactions.TransactionManager.Reenlist%2A> method) in all transactions in which it was a participant and did not complete phase 2, and call <xref:System.Transactions.TransactionManager.RecoveryComplete%2A> once it finishes recovery processing.</span></span> <span data-ttu-id="1557f-123">Pour plus d’informations sur la récupération, voir exécution de la [récupération](performing-recovery.md).</span><span class="sxs-lookup"><span data-stu-id="1557f-123">For more information on recovery, see [Performing Recovery](performing-recovery.md).</span></span>

<span data-ttu-id="1557f-124">Les méthodes <xref:System.Transactions.Transaction.EnlistDurable%2A> ont toutes un objet <xref:System.Guid> pour premier paramètre.</span><span class="sxs-lookup"><span data-stu-id="1557f-124">The <xref:System.Transactions.Transaction.EnlistDurable%2A> methods all take a <xref:System.Guid> object as their first parameter.</span></span> <span data-ttu-id="1557f-125">Le gestionnaire de transactions utilise le <xref:System.Guid> pour associer une inscription durable à un gestionnaire de ressources particulier.</span><span class="sxs-lookup"><span data-stu-id="1557f-125">The <xref:System.Guid> is used by the transaction manager to associate a durable enlistment with a particular resource manager.</span></span> <span data-ttu-id="1557f-126">Il est donc impératif qu'un gestionnaire de ressources utilise toujours le même <xref:System.Guid> pour son identification après redémarrage, même sur plusieurs gestionnaires de ressources, sous peine de faire échouer la récupération.</span><span class="sxs-lookup"><span data-stu-id="1557f-126">As such, it is imperative that a resource manager consistently uses the same <xref:System.Guid> to identify itself even across different resource managers upon restarting, otherwise the recovery can fail.</span></span>

<span data-ttu-id="1557f-127">Le second paramètre des méthodes <xref:System.Transactions.Transaction.EnlistDurable%2A> est une référence à l'objet que le gestionnaire de ressources implémente pour recevoir les notifications de transaction.</span><span class="sxs-lookup"><span data-stu-id="1557f-127">The second parameter of the <xref:System.Transactions.Transaction.EnlistDurable%2A> method is a reference to the object that the resource manager implements to receive transaction notifications.</span></span> <span data-ttu-id="1557f-128">La surcharge que vous utilisez indique au gestionnaire de transactions si votre gestionnaire de ressources prend en charge l'optimisation de validation à phase unique (SPC).</span><span class="sxs-lookup"><span data-stu-id="1557f-128">The overload you use informs the transaction manager whether your resource manager supports the Single Phase Commit (SPC) optimization.</span></span> <span data-ttu-id="1557f-129">Dans la plupart des cas, vous implémenterez l'interface <xref:System.Transactions.IEnlistmentNotification> pour participer à la validation en deux phases (2PC).</span><span class="sxs-lookup"><span data-stu-id="1557f-129">Most of the time you would implement the <xref:System.Transactions.IEnlistmentNotification> interface to take part in Two-Phase Commit (2PC).</span></span> <span data-ttu-id="1557f-130">Cependant, si vous souhaitez optimiser le processus de validation, envisagez d'implémenter l'interface <xref:System.Transactions.ISinglePhaseNotification> pour SPC.</span><span class="sxs-lookup"><span data-stu-id="1557f-130">However, if you want to optimize the commit process, you can consider implementing the <xref:System.Transactions.ISinglePhaseNotification> interface for SPC.</span></span> <span data-ttu-id="1557f-131">Pour plus d’informations sur le SPC, consultez [validation d’une transaction en une phase unique et multiphase](committing-a-transaction-in-single-phase-and-multi-phase.md) et [optimisation à l’aide d’une validation à phase unique et d’une notification de phase unique pouvant être promue](optimization-spc-and-promotable-spn.md).</span><span class="sxs-lookup"><span data-stu-id="1557f-131">For more information on SPC, see [Committing a Transaction in Single-Phase and Multi-Phase](committing-a-transaction-in-single-phase-and-multi-phase.md) and [Optimization using Single Phase Commit and Promotable Single Phase Notification](optimization-spc-and-promotable-spn.md).</span></span>

<span data-ttu-id="1557f-132">Le troisième paramètre est une énumération <xref:System.Transactions.EnlistmentOptions>, dont la valeur peut être <xref:System.Transactions.EnlistmentOptions.None> ou <xref:System.Transactions.EnlistmentOptions.EnlistDuringPrepareRequired>.</span><span class="sxs-lookup"><span data-stu-id="1557f-132">The third parameter is an <xref:System.Transactions.EnlistmentOptions> enumeration, whose value can be either <xref:System.Transactions.EnlistmentOptions.None> or <xref:System.Transactions.EnlistmentOptions.EnlistDuringPrepareRequired>.</span></span> <span data-ttu-id="1557f-133">Si la valeur est <xref:System.Transactions.EnlistmentOptions.EnlistDuringPrepareRequired>, l'inscription peut autoriser des gestionnaires de ressources supplémentaires après réception de la notification de préparation envoyée par le gestionnaire de transactions.</span><span class="sxs-lookup"><span data-stu-id="1557f-133">If the value is set to <xref:System.Transactions.EnlistmentOptions.EnlistDuringPrepareRequired>, the enlistment may enlist additional resource managers upon receiving the Prepare notification from the transaction manager.</span></span> <span data-ttu-id="1557f-134">Toutefois, vous devez savoir que ce type d'inscription n'est pas pris en charge pour l'optimisation de la validation en une phase.</span><span class="sxs-lookup"><span data-stu-id="1557f-134">However, you should be aware that this type of enlistment is not eligible for the Single Phase Commit optimization.</span></span>

### <a name="volatile-enlistment"></a><span data-ttu-id="1557f-135">Inscription volatile</span><span class="sxs-lookup"><span data-stu-id="1557f-135">Volatile Enlistment</span></span>

<span data-ttu-id="1557f-136">Les participants gérant des ressources volatiles telles qu'un cache doivent s'inscrire à l'aide des méthodes <xref:System.Transactions.Transaction.EnlistVolatile%2A>.</span><span class="sxs-lookup"><span data-stu-id="1557f-136">Participants managing volatile resources such as a cache should enlist using the <xref:System.Transactions.Transaction.EnlistVolatile%2A> methods.</span></span> <span data-ttu-id="1557f-137">Il est possible que ces objets ne puissent pas obtenir le résultat d'une transaction ou récupérer l'état d'une transaction à laquelle ils participent après une défaillance système.</span><span class="sxs-lookup"><span data-stu-id="1557f-137">Such objects might not be able to obtain the outcome of a transaction or recover the state of any transaction they participate in after a system failure.</span></span>

<span data-ttu-id="1557f-138">Comme indiqué précédemment, un gestionnaire de ressources procède à une inscription volatile s'il manage une ressource volatile en mémoire.</span><span class="sxs-lookup"><span data-stu-id="1557f-138">As stated previously, a resource manager would make a volatile enlistment if it manages an in-memory, volatile resource.</span></span> <span data-ttu-id="1557f-139">L'un des avantages offert par <xref:System.Transactions.Transaction.EnlistVolatile%2A> est que cela évite une remontée inutile de la transaction.</span><span class="sxs-lookup"><span data-stu-id="1557f-139">One of the benefits of using <xref:System.Transactions.Transaction.EnlistVolatile%2A> is that it does not force an unnecessary escalation of the transaction.</span></span> <span data-ttu-id="1557f-140">Pour plus d’informations sur la remontée des transactions, consultez la rubrique [remontée](transaction-management-escalation.md) de la gestion des transactions.</span><span class="sxs-lookup"><span data-stu-id="1557f-140">For more information on transaction escalation, see [Transaction Management Escalation](transaction-management-escalation.md) topic.</span></span> <span data-ttu-id="1557f-141">L’inscription de la volatilité implique à la fois une différence dans la manière dont l’inscription est gérée par le gestionnaire de transactions, ainsi que ce qui est attendu par le gestionnaire de transactions de Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="1557f-141">Enlisting volatility implies both a difference in how the enlistment is handled by the transaction manager, as well as what is expected of the resource manager by the transaction manager.</span></span> <span data-ttu-id="1557f-142">Cela est dû au fait que les gestionnaires de ressources volatiles ne prennent pas en charge la récupération.</span><span class="sxs-lookup"><span data-stu-id="1557f-142">This is because a volatile resource manager does not perform recovery.</span></span> <span data-ttu-id="1557f-143">Les méthodes <xref:System.Transactions.Transaction.EnlistVolatile%2A> n'ont pas de paramètre <xref:System.Guid> car les gestionnaires de ressources volatiles ne prennent pas en charge la récupération et n'appellent donc jamais la méthode <xref:System.Transactions.TransactionManager.Reenlist%2A>, qui requiert un <xref:System.Guid>.</span><span class="sxs-lookup"><span data-stu-id="1557f-143">The <xref:System.Transactions.Transaction.EnlistVolatile%2A> methods do not take a <xref:System.Guid> parameter, because a volatile resource manager does not perform recovery and would not call the <xref:System.Transactions.TransactionManager.Reenlist%2A> method which needs a <xref:System.Guid>.</span></span>

<span data-ttu-id="1557f-144">Comme pour les inscriptions durables, la méthode de surcharge utilisée pour vous inscrire indique au gestionnaire de transactions si votre gestionnaire de ressources prend en charge l'optimisation de la validation en une phase.</span><span class="sxs-lookup"><span data-stu-id="1557f-144">As with durable enlistments, whichever overload method you use to enlist denotes to the transaction manager whether your resource manager supports the Single Phase Commit optimization.</span></span> <span data-ttu-id="1557f-145">Les gestionnaires de ressources volatiles ne prenant pas en charge la récupération, aucune information de récupération n'est déclarée pour une inscription volatile lors de la phase de préparation.</span><span class="sxs-lookup"><span data-stu-id="1557f-145">Since a volatile resource manager cannot perform recovery, no recovery information is written for a volatile enlistment during the Prepare phase.</span></span> <span data-ttu-id="1557f-146">C'est pourquoi appeler la méthode <xref:System.Transactions.PreparingEnlistment.RecoveryInformation%2A> entraîne une <xref:System.InvalidOperationException>.</span><span class="sxs-lookup"><span data-stu-id="1557f-146">Therefore, calling the <xref:System.Transactions.PreparingEnlistment.RecoveryInformation%2A> method results in an <xref:System.InvalidOperationException>.</span></span>

<span data-ttu-id="1557f-147">L'exemple suivant indique comment inscrire l'un de ces objets à une transaction à l'aide de la méthode <xref:System.Transactions.Transaction.EnlistVolatile%2A>.</span><span class="sxs-lookup"><span data-stu-id="1557f-147">The following example shows how to enlist such an object as a participant in a transaction using the <xref:System.Transactions.Transaction.EnlistVolatile%2A> method.</span></span>

[!code-csharp[Tx_Enlist#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/tx_enlist/cs/enlist.cs#1)]
[!code-vb[Tx_Enlist#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/tx_enlist/vb/enlist.vb#1)]

### <a name="optimizing-performance"></a><span data-ttu-id="1557f-148">Optimisation des performances</span><span class="sxs-lookup"><span data-stu-id="1557f-148">Optimizing Performance</span></span>

<span data-ttu-id="1557f-149">La classe <xref:System.Transactions.Transaction> fournit également la méthode <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> permettant de s'inscrire à une PSPE (Promotable Single Phase Enlistment).</span><span class="sxs-lookup"><span data-stu-id="1557f-149">The <xref:System.Transactions.Transaction> class also provides the <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> method to enlist a Promotable Single Phase Enlistment (PSPE).</span></span> <span data-ttu-id="1557f-150">Cela permet à un gestionnaire de ressources durables d'héberger et de « posséder » une transaction qui peut, si nécessaire, être ensuite remontée pour être managée par le MSDTC.</span><span class="sxs-lookup"><span data-stu-id="1557f-150">This allows a durable resource manager (RM) to host and "own" a transaction that can later be escalated to be managed by the MSDTC if necessary.</span></span> <span data-ttu-id="1557f-151">Pour plus d’informations, consultez [optimisation à l’aide de la validation à phase unique et de la notification à phase unique pouvant être promue](optimization-spc-and-promotable-spn.md).</span><span class="sxs-lookup"><span data-stu-id="1557f-151">For more information on this, see [Optimization using Single Phase Commit and Promotable Single Phase Notification](optimization-spc-and-promotable-spn.md).</span></span>

## <a name="see-also"></a><span data-ttu-id="1557f-152">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="1557f-152">See also</span></span>

- [<span data-ttu-id="1557f-153">Optimisation à l’aide de la validation à phase unique et de la notification de phase unique pouvant être promue</span><span class="sxs-lookup"><span data-stu-id="1557f-153">Optimization using Single Phase Commit and Promotable Single Phase Notification</span></span>](optimization-spc-and-promotable-spn.md)
- [<span data-ttu-id="1557f-154">Validation d’une transaction en une phase unique et en plusieurs phases</span><span class="sxs-lookup"><span data-stu-id="1557f-154">Committing a Transaction in Single-Phase and Multi-Phase</span></span>](committing-a-transaction-in-single-phase-and-multi-phase.md)
