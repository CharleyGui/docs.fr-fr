---
title: Exécution de la récupération
description: Effectuez la récupération dans .NET. Le gestionnaire des ressources permet de résoudre les inscriptions de transactions durables en réinscrivant le participant à la transaction après l’échec de la ressource.
ms.date: 03/30/2017
ms.assetid: 6dd17bf6-ba42-460a-a44b-8046f52b10d0
ms.openlocfilehash: bb00d2f574cc2651b733f3308cf2ffc6b430cc31
ms.sourcegitcommit: 6219b1e1feccb16d88656444210fed3297f5611e
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 06/22/2020
ms.locfileid: "85141963"
---
# <a name="performing-recovery"></a><span data-ttu-id="3f751-104">Exécution de la récupération</span><span class="sxs-lookup"><span data-stu-id="3f751-104">Performing Recovery</span></span>
<span data-ttu-id="3f751-105">Un gestionnaire de ressources facilite la résolution d’inscriptions durables à une transaction en réinscrivant le participant à la transaction après défaillance de la ressource.</span><span class="sxs-lookup"><span data-stu-id="3f751-105">A resource manager facilitates resolution of durable enlistments in a transaction by reenlisting the transaction participant after resource failure.</span></span>  
  
## <a name="the-recovery-process"></a><span data-ttu-id="3f751-106">Processus de récupération</span><span class="sxs-lookup"><span data-stu-id="3f751-106">The Recovery Process</span></span>  
 <span data-ttu-id="3f751-107">Pour procéder à l'inscription durable d'une ressource (décrite par implémentation de l'interface <xref:System.Transactions.IEnlistmentNotification>) pouvant être utilisée pour une éventuelle récupération, appelez la méthode <xref:System.Transactions.Transaction.EnlistDurable%2A>.</span><span class="sxs-lookup"><span data-stu-id="3f751-107">To durably enlist a resource (described by an implementation of the <xref:System.Transactions.IEnlistmentNotification> interface) that can later be eligible for recovery, you should call the <xref:System.Transactions.Transaction.EnlistDurable%2A> method.</span></span> <span data-ttu-id="3f751-108">Vous devez également communiquer à la méthode <xref:System.Transactions.Transaction.EnlistDurable%2A> l'identificateur d'un gestionnaire de ressources (un <xref:System.Guid>) utilisé pour identifier systématiquement le participant à la transaction en cas de défaillance de la ressource.</span><span class="sxs-lookup"><span data-stu-id="3f751-108">In addition, you must provide the <xref:System.Transactions.Transaction.EnlistDurable%2A> method with a resource manager identifier (a <xref:System.Guid>) that is used to consistently label the participant of the transaction in the event of a resource failure.</span></span> <span data-ttu-id="3f751-109">Pour cette raison, le <xref:System.Guid> fourni à l’appel d’inscription initial doit être identique au paramètre *resourceManagerIdentifier* dans l' <xref:System.Transactions.TransactionManager.Reenlist%2A> appel pendant la récupération.</span><span class="sxs-lookup"><span data-stu-id="3f751-109">For this reason, the <xref:System.Guid> that is provided to the initial Enlist call should be identical to the *resourceManagerIdentifier* parameter in the <xref:System.Transactions.TransactionManager.Reenlist%2A> call during recovery.</span></span> <span data-ttu-id="3f751-110">sous peine de lever une exception <xref:System.Transactions.TransactionException>.</span><span class="sxs-lookup"><span data-stu-id="3f751-110">Otherwise, <xref:System.Transactions.TransactionException> is thrown.</span></span> <span data-ttu-id="3f751-111">Pour plus d’informations sur les inscriptions durables, consultez [inscription de ressources en tant que participants dans une transaction](enlisting-resources-as-participants-in-a-transaction.md) .</span><span class="sxs-lookup"><span data-stu-id="3f751-111">For more information on durable enlistments, see [Enlisting Resources as Participants in a Transaction](enlisting-resources-as-participants-in-a-transaction.md) .</span></span>  
  
 <span data-ttu-id="3f751-112">Au cours de la phase de préparation (phase 1) du protocole 2PC, lorsque l'implémentation du gestionnaire de ressources durables reçoit la notification <xref:System.Transactions.IEnlistmentNotification.Prepare%2A>, elle doit consigner son enregistrement de préparation.</span><span class="sxs-lookup"><span data-stu-id="3f751-112">In the prepare phase (phase 1) of the 2PC protocol, when your implementation of a durable resource manager receives the <xref:System.Transactions.IEnlistmentNotification.Prepare%2A> notification, it should log its prepare record during this phase.</span></span> <span data-ttu-id="3f751-113">L'enregistrement doit contenir toutes les informations nécessaires pour terminer la transaction en cours de validation.</span><span class="sxs-lookup"><span data-stu-id="3f751-113">The record should contain all the information that is necessary to complete the transaction on commit.</span></span> <span data-ttu-id="3f751-114">L’enregistrement de préparation est ensuite accessible lors de la récupération en extrayant la <xref:System.Transactions.PreparingEnlistment.RecoveryInformation%2A> propriété du rappel *PreparingEnlistment* .</span><span class="sxs-lookup"><span data-stu-id="3f751-114">The prepare record can later be accessed during recovery by retrieving the <xref:System.Transactions.PreparingEnlistment.RecoveryInformation%2A> property of the *preparingEnlistment* callback.</span></span> <span data-ttu-id="3f751-115">Il n'est pas nécessaire d'effectuer la journalisation de l'enregistrement au sein de la méthode <xref:System.Transactions.IEnlistmentNotification.Prepare%2A> puisque le gestionnaire de ressources peut le faire au niveau d'un thread de travail.</span><span class="sxs-lookup"><span data-stu-id="3f751-115">The record logging does not need to be performed within the <xref:System.Transactions.IEnlistmentNotification.Prepare%2A> method as the RM can do this on a worker thread.</span></span>  
  
 <span data-ttu-id="3f751-116">Le processus de récupération se divise en deux étapes :</span><span class="sxs-lookup"><span data-stu-id="3f751-116">The recovery process consists of the following two steps:</span></span>  
  
### <a name="step-1---reenlist"></a><span data-ttu-id="3f751-117">Étape 1 : Réinscription</span><span class="sxs-lookup"><span data-stu-id="3f751-117">Step 1 - ReEnlist</span></span>  
 <span data-ttu-id="3f751-118">Le gestionnaire de ressources examine l'enregistrement d'informations de préparation de chaque inscription incertaine.</span><span class="sxs-lookup"><span data-stu-id="3f751-118">The resource manager examines the prepare information record for each enlistment that is in-doubt.</span></span> <span data-ttu-id="3f751-119">Cette opération se traduit par l'examen de la propriété <xref:System.Transactions.PreparingEnlistment.RecoveryInformation%2A> du rappel <xref:System.Transactions.PreparingEnlistment>, passée au gestionnaire de ressources dans la notification <xref:System.Transactions.IEnlistmentNotification.Prepare%2A> au cours de la phase 1.</span><span class="sxs-lookup"><span data-stu-id="3f751-119">This is done by examining the <xref:System.Transactions.PreparingEnlistment.RecoveryInformation%2A> property of the <xref:System.Transactions.PreparingEnlistment> callback, which is passed to the resource manager in the <xref:System.Transactions.IEnlistmentNotification.Prepare%2A> notification during phase 1.</span></span>  
  
 <span data-ttu-id="3f751-120">Pour chaque inscription examinée, il appelle <xref:System.Transactions.TransactionManager.Reenlist%2A> sur le gestionnaire de transactions.</span><span class="sxs-lookup"><span data-stu-id="3f751-120">For each such enlistment it examines, it invokes <xref:System.Transactions.TransactionManager.Reenlist%2A> on the transaction manager.</span></span> <span data-ttu-id="3f751-121">Cette méthode passe le <xref:System.Guid> unique qui permet d'identifier le gestionnaire de ressources, ainsi que les informations d'inscription dans un tableau d'octets.</span><span class="sxs-lookup"><span data-stu-id="3f751-121">This method passes on a unique <xref:System.Guid> that identifies the resource manager, as well as the enlistment's information in a byte array.</span></span> <span data-ttu-id="3f751-122">Un nouvel objet <xref:System.Transactions.Enlistment> est retourné.</span><span class="sxs-lookup"><span data-stu-id="3f751-122">A new <xref:System.Transactions.Enlistment> object is returned.</span></span> <span data-ttu-id="3f751-123">Si la réinscription échoue avec une exception, le gestionnaire de ressources doit retenter ultérieurement.</span><span class="sxs-lookup"><span data-stu-id="3f751-123">If the reenlistment fails with an exception, the resource manager will need to retry at a later time.</span></span>  
  
 <span data-ttu-id="3f751-124">N'appelez la méthode <xref:System.Transactions.TransactionManager.Reenlist%2A> que lors du redémarrage d'un gestionnaire de ressources après défaillance.</span><span class="sxs-lookup"><span data-stu-id="3f751-124">You should only call the <xref:System.Transactions.TransactionManager.Reenlist%2A> method when a resource manager restarts from failure.</span></span> <span data-ttu-id="3f751-125">En outre, vous ne devez réinscrire que des transactions non résolues enregistrées par un gestionnaire de ressources au cours de la phase de préparation initiale d'une validation en deux phases.</span><span class="sxs-lookup"><span data-stu-id="3f751-125">In addition, you should only reenlist unresolved transactions logged by a resource manager during the initial Prepare phase of a two-phase commit.</span></span> <span data-ttu-id="3f751-126">Toute tentative pour appeler cette méthode à une période incorrecte peut entraîner des résultats erronés.</span><span class="sxs-lookup"><span data-stu-id="3f751-126">Any attempt to call this method at invalid times can produce erroneous results.</span></span>  
  
 <span data-ttu-id="3f751-127">Lorsqu’un participant est réinscrit à l’aide de cette méthode, les méthodes de phase 2 de <xref:System.Transactions.IEnlistmentNotification> qui correspondent au résultat de la transaction (soit <xref:System.Transactions.IEnlistmentNotification.Commit%2A>, <xref:System.Transactions.IEnlistmentNotification.Rollback%2A> ou <xref:System.Transactions.IEnlistmentNotification.InDoubt%2A>) sont appelées si nécessaire.</span><span class="sxs-lookup"><span data-stu-id="3f751-127">When a participant is reenlisted using this method, the phase 2 methods of <xref:System.Transactions.IEnlistmentNotification> that correspond to the transaction's outcome (that is, <xref:System.Transactions.IEnlistmentNotification.Commit%2A> , <xref:System.Transactions.IEnlistmentNotification.Rollback%2A> or <xref:System.Transactions.IEnlistmentNotification.InDoubt%2A> ) are called as appropriate.</span></span>  
  
### <a name="step-2---completing-the-recovery"></a><span data-ttu-id="3f751-128">Étape 2 : Fin de la récupération</span><span class="sxs-lookup"><span data-stu-id="3f751-128">Step 2 - Completing the recovery</span></span>  
 <span data-ttu-id="3f751-129">Une fois toutes les réinscriptions effectuées, le gestionnaire des ressources appelle la méthode <xref:System.Transactions.TransactionManager.RecoveryComplete%2A>.</span><span class="sxs-lookup"><span data-stu-id="3f751-129">When all the reenlistments are finished, the resource manager calls the <xref:System.Transactions.TransactionManager.RecoveryComplete%2A> method.</span></span> <span data-ttu-id="3f751-130">Cette méthode termine la récupération et informe le gestionnaire de transactions que le gestionnaire de ressources ne présente plus de transactions incertaines.</span><span class="sxs-lookup"><span data-stu-id="3f751-130">This method completes the recovery and informs the transaction manager that the resource manager has no more in-doubt transactions.</span></span> <span data-ttu-id="3f751-131">Cela permet d'éviter que le gestionnaire de ressources ne rappelle la méthode <xref:System.Transactions.TransactionManager.Reenlist%2A>.</span><span class="sxs-lookup"><span data-stu-id="3f751-131">By doing so, the resource manager guarantees that it will not invoke the <xref:System.Transactions.TransactionManager.Reenlist%2A> method again.</span></span>  
  
 <span data-ttu-id="3f751-132">Il n'est pas nécessaire que le gestionnaire de ressources ait résolu toutes les transactions incertaines avant de procéder aux inscriptions à de nouvelles transactions.</span><span class="sxs-lookup"><span data-stu-id="3f751-132">A resource manager is not required to resolve all in-doubt transactions before enlisting in new transactions.</span></span> <span data-ttu-id="3f751-133">La première étape peut être effectuée à tout moment une fois que le gestionnaire de ressources a établi une relation avec le gestionnaire de transactions, mais après que <xref:System.Transactions.TransactionManager.RecoveryComplete%2A> a été appelé (étape 2); l’étape 1 ne peut pas être réexécutée.</span><span class="sxs-lookup"><span data-stu-id="3f751-133">The first step can be performed at any time after the resource manager establishes a relationship with the transaction manager, but after <xref:System.Transactions.TransactionManager.RecoveryComplete%2A> has been invoked (step 2); step 1 cannot be performed again.</span></span> <span data-ttu-id="3f751-134">L'étape 2 peut être répétée plusieurs fois sans affecter le résultat des transactions.</span><span class="sxs-lookup"><span data-stu-id="3f751-134">Step 2 can be repeated multiple times without affecting the outcome of transactions.</span></span>
