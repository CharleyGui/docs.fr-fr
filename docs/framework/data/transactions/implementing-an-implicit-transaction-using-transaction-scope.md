---
title: Implémentation d'une transaction implicite à l'aide de l'étendue de transaction
description: Implémentez une transaction implicite à l’aide de la classe TransactionScope dans .NET. Cette classe permet de marquer un bloc de code comme participant à une transaction.
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: 49d1706a-1e0c-4c85-9704-75c908372eb9
ms.openlocfilehash: 48dd96dbba89a33cfce7d1b4efb776ef4ce4fada
ms.sourcegitcommit: 6219b1e1feccb16d88656444210fed3297f5611e
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 06/22/2020
ms.locfileid: "85141924"
---
# <a name="implementing-an-implicit-transaction-using-transaction-scope"></a><span data-ttu-id="c50b8-104">Implémentation d'une transaction implicite à l'aide de l'étendue de transaction</span><span class="sxs-lookup"><span data-stu-id="c50b8-104">Implementing an Implicit Transaction using Transaction Scope</span></span>
<span data-ttu-id="c50b8-105">La classe <xref:System.Transactions.TransactionScope> offre un moyen simple pour indiquer qu'un bloc de code participe à une transaction, sans avoir à intervenir sur la transaction même.</span><span class="sxs-lookup"><span data-stu-id="c50b8-105">The <xref:System.Transactions.TransactionScope> class provides a simple way to mark a block of code as participating in a transaction, without requiring you to interact with the transaction itself.</span></span> <span data-ttu-id="c50b8-106">Une étendue de transaction peut sélectionner et gérer automatiquement la transaction ambiante.</span><span class="sxs-lookup"><span data-stu-id="c50b8-106">A transaction scope can select and manage the ambient transaction automatically.</span></span> <span data-ttu-id="c50b8-107">En raison de sa facilité d'utilisation et de son efficacité, il est recommandé d'utiliser la classe <xref:System.Transactions.TransactionScope> lors du développement d'une application de transaction.</span><span class="sxs-lookup"><span data-stu-id="c50b8-107">Due to its ease of use and efficiency, it is recommended that you use the <xref:System.Transactions.TransactionScope> class when developing a transaction application.</span></span>  
  
 <span data-ttu-id="c50b8-108">De plus, il n'est pas nécessaire d'inscrire explicitement des ressources avec la transaction.</span><span class="sxs-lookup"><span data-stu-id="c50b8-108">In addition, you do not need to enlist resources explicitly with the transaction.</span></span> <span data-ttu-id="c50b8-109">Tout gestionnaire de ressources <xref:System.Transactions> (tel que SQL Server 2005) peut détecter l'existence d'une transaction ambiante créée par l'étendue et l'inscrire automatiquement.</span><span class="sxs-lookup"><span data-stu-id="c50b8-109">Any <xref:System.Transactions> resource manager (such as SQL Server 2005) can detect the existence of an ambient transaction created by the scope and automatically enlist.</span></span>  
  
## <a name="creating-a-transaction-scope"></a><span data-ttu-id="c50b8-110">Création d'une étendue de transaction</span><span class="sxs-lookup"><span data-stu-id="c50b8-110">Creating a transaction scope</span></span>  
 <span data-ttu-id="c50b8-111">L'exemple suivant illustre une utilisation simple de la classe <xref:System.Transactions.TransactionScope>.</span><span class="sxs-lookup"><span data-stu-id="c50b8-111">The following sample shows a simple usage of the <xref:System.Transactions.TransactionScope> class.</span></span>  
  
 [!code-csharp[TransactionScope#1](../../../../samples/snippets/csharp/VS_Snippets_Remoting/TransactionScope/cs/ScopeWithSQL.cs#1)]
 [!code-vb[TransactionScope#1](../../../../samples/snippets/visualbasic/VS_Snippets_Remoting/TransactionScope/vb/ScopeWithSQL.vb#1)]  
  
 <span data-ttu-id="c50b8-112">L'étendue de transaction démarre après la création d'un nouvel objet <xref:System.Transactions.TransactionScope>.</span><span class="sxs-lookup"><span data-stu-id="c50b8-112">The transaction scope is started once you create a new <xref:System.Transactions.TransactionScope> object.</span></span>  <span data-ttu-id="c50b8-113">Comme illustré dans l’exemple de code, il est recommandé de créer des étendues avec une `using` instruction.</span><span class="sxs-lookup"><span data-stu-id="c50b8-113">As illustrated in the code sample, it is recommended that you create scopes with a `using` statement.</span></span> <span data-ttu-id="c50b8-114">L' `using` instruction est disponible en C# et dans Visual Basic, et fonctionne comme un `try` bloc... `finally` pour s’assurer que la portée est correctement supprimée.</span><span class="sxs-lookup"><span data-stu-id="c50b8-114">The `using` statement is available both in C# and in Visual Basic, and works like a `try`...`finally` block to ensure that the scope is disposed of properly.</span></span>  
  
 <span data-ttu-id="c50b8-115">Lorsque vous instanciez <xref:System.Transactions.TransactionScope>, le gestionnaire de transactions détermine la transaction à laquelle participer.</span><span class="sxs-lookup"><span data-stu-id="c50b8-115">When you instantiate <xref:System.Transactions.TransactionScope>, the transaction manager determines which transaction to participate in.</span></span> <span data-ttu-id="c50b8-116">Une fois déterminée, la portée participe toujours à cette transaction.</span><span class="sxs-lookup"><span data-stu-id="c50b8-116">Once determined, the scope always participates in that transaction.</span></span> <span data-ttu-id="c50b8-117">Cette décision est basée sur deux facteurs : la présence d’une transaction ambiante et la valeur du paramètre `TransactionScopeOption` dans le constructeur.</span><span class="sxs-lookup"><span data-stu-id="c50b8-117">The decision is based on two factors: whether an ambient transaction is present and the value of the `TransactionScopeOption` parameter in the constructor.</span></span> <span data-ttu-id="c50b8-118">La transaction ambiante est la transaction dans laquelle s'exécute votre code.</span><span class="sxs-lookup"><span data-stu-id="c50b8-118">The ambient transaction is the transaction within which your code executes.</span></span> <span data-ttu-id="c50b8-119">Vous pouvez obtenir une référence à la transaction ambiante en appelant la propriété <xref:System.Transactions.Transaction.Current%2A?displayProperty=nameWithType> statique de la classe <xref:System.Transactions.Transaction>.</span><span class="sxs-lookup"><span data-stu-id="c50b8-119">You can obtain a reference to the ambient transaction by calling the static <xref:System.Transactions.Transaction.Current%2A?displayProperty=nameWithType> property of the <xref:System.Transactions.Transaction> class.</span></span> <span data-ttu-id="c50b8-120">Pour plus d’informations sur l’utilisation de ce paramètre, voir la section [gestion du workflow de transaction à l’aide de TransactionScopeOption](#ManageTxFlow) de cette rubrique.</span><span class="sxs-lookup"><span data-stu-id="c50b8-120">For more information on how this parameter is used, see the [Managing transaction flow using TransactionScopeOption](#ManageTxFlow) section of this topic.</span></span>  
  
## <a name="completing-a-transaction-scope"></a><span data-ttu-id="c50b8-121">Fin d'une étendue de transaction</span><span class="sxs-lookup"><span data-stu-id="c50b8-121">Completing a transaction scope</span></span>  
 <span data-ttu-id="c50b8-122">Une fois que votre application a effectué toutes les tâches nécessaires au cours d'une transaction, appelez la méthode <xref:System.Transactions.TransactionScope.Complete%2A?displayProperty=nameWithType> (une seule fois) pour informer le gestionnaire de transactions que la transaction peut être validée.</span><span class="sxs-lookup"><span data-stu-id="c50b8-122">When your application completes all the work it wants to perform in a transaction, you should call the <xref:System.Transactions.TransactionScope.Complete%2A?displayProperty=nameWithType> method only once to inform the transaction manager that it is acceptable to commit the transaction.</span></span> <span data-ttu-id="c50b8-123">Il est recommandé de placer l’appel à <xref:System.Transactions.TransactionScope.Complete%2A> en tant que dernière instruction dans le `using` bloc.</span><span class="sxs-lookup"><span data-stu-id="c50b8-123">It is very good practice to put the call to <xref:System.Transactions.TransactionScope.Complete%2A> as the last statement in the `using` block.</span></span>  
  
 <span data-ttu-id="c50b8-124">L’échec de l’appel de cette méthode annule la transaction, car le gestionnaire de transactions l’interprète comme une défaillance du système, ou équivaut à une exception levée dans l’étendue de la transaction.</span><span class="sxs-lookup"><span data-stu-id="c50b8-124">Failing to call this method aborts the transaction, because the transaction manager interprets this as a system failure, or equivalent to an exception thrown within the scope of the transaction.</span></span> <span data-ttu-id="c50b8-125">Toutefois, l'appel à cette méthode ne garantit pas la validation de la transaction.</span><span class="sxs-lookup"><span data-stu-id="c50b8-125">However, calling this method does not guarantee that the transaction wil be committed.</span></span> <span data-ttu-id="c50b8-126">Il s’agit simplement d’un moyen d’informer le gestionnaire de transactions de votre état.</span><span class="sxs-lookup"><span data-stu-id="c50b8-126">It is merely a way of informing the transaction manager of your status.</span></span> <span data-ttu-id="c50b8-127">Après avoir appelé la méthode <xref:System.Transactions.TransactionScope.Complete%2A>, vous ne pouvez plus accéder à la transaction ambiante via la propriété <xref:System.Transactions.Transaction.Current%2A> sous peine de lever une exception.</span><span class="sxs-lookup"><span data-stu-id="c50b8-127">After calling the <xref:System.Transactions.TransactionScope.Complete%2A> method, you can no longer access the ambient transaction by using the <xref:System.Transactions.Transaction.Current%2A> property, and attempting to do so will result in an exception being thrown.</span></span>  
  
 <span data-ttu-id="c50b8-128">Si l' <xref:System.Transactions.TransactionScope> objet a créé la transaction initialement, le travail réel de validation de la transaction par le gestionnaire de transactions se produit après la dernière ligne de code du `using` bloc.</span><span class="sxs-lookup"><span data-stu-id="c50b8-128">If the <xref:System.Transactions.TransactionScope> object created the transaction initially, the actual work of committing the transaction by the transaction manager occurs after the last line of code in the `using` block.</span></span> <span data-ttu-id="c50b8-129">S'il n'a pas créé la transaction, la validation se produit chaque fois que <xref:System.Transactions.CommittableTransaction.Commit%2A> est appelé par le propriétaire de l'objet <xref:System.Transactions.CommittableTransaction>.</span><span class="sxs-lookup"><span data-stu-id="c50b8-129">If it did not create the transaction, the commit occurs whenever <xref:System.Transactions.CommittableTransaction.Commit%2A> is called by the owner of the <xref:System.Transactions.CommittableTransaction> object.</span></span> <span data-ttu-id="c50b8-130">À ce stade, le gestionnaire de transactions appelle les gestionnaires de ressources et les informe de la validation ou de la restauration, selon que la <xref:System.Transactions.TransactionScope.Complete%2A> méthode a été appelée sur l’objet ou non <xref:System.Transactions.TransactionScope> .</span><span class="sxs-lookup"><span data-stu-id="c50b8-130">At that point the transaction manager calls the resource managers and informs them to either commit or rollback, based on whether the <xref:System.Transactions.TransactionScope.Complete%2A> method was called on the <xref:System.Transactions.TransactionScope> object.</span></span>  
  
 <span data-ttu-id="c50b8-131">L' `using` instruction garantit que la <xref:System.Transactions.TransactionScope.Dispose%2A> méthode de l' <xref:System.Transactions.TransactionScope> objet est appelée même si une exception se produit.</span><span class="sxs-lookup"><span data-stu-id="c50b8-131">The `using` statement ensures that the <xref:System.Transactions.TransactionScope.Dispose%2A> method of the <xref:System.Transactions.TransactionScope> object is called even if an exception occurs.</span></span> <span data-ttu-id="c50b8-132">La méthode <xref:System.Transactions.TransactionScope.Dispose%2A> marque la fin de l'étendue de transaction.</span><span class="sxs-lookup"><span data-stu-id="c50b8-132">The <xref:System.Transactions.TransactionScope.Dispose%2A> method marks the end of the transaction scope.</span></span> <span data-ttu-id="c50b8-133">Il est possible que les exceptions qui se produisent après l’appel à cette méthode n’affectent pas la transaction.</span><span class="sxs-lookup"><span data-stu-id="c50b8-133">Exceptions that occur after calling this method may not affect the transaction.</span></span> <span data-ttu-id="c50b8-134">Cette méthode restaure également la transaction ambiante à son état précédent.</span><span class="sxs-lookup"><span data-stu-id="c50b8-134">This method also restores the ambient transaction to it previous state.</span></span>  
  
 <span data-ttu-id="c50b8-135">Une exception <xref:System.Transactions.TransactionAbortedException> est levée si l'étendue crée la transaction et que cette transaction est abandonnée.</span><span class="sxs-lookup"><span data-stu-id="c50b8-135">A <xref:System.Transactions.TransactionAbortedException> is thrown if the scope creates the transaction, and the transaction is aborted.</span></span> <span data-ttu-id="c50b8-136">Une exception <xref:System.Transactions.TransactionInDoubtException> est levée si le gestionnaire de transactions ne parvient pas à aboutir à une décision de validation.</span><span class="sxs-lookup"><span data-stu-id="c50b8-136">A <xref:System.Transactions.TransactionInDoubtException> is thrown if the transaction manager cannot reach a Commit decision.</span></span> <span data-ttu-id="c50b8-137">Aucune exception n'est levée si la transaction est validée.</span><span class="sxs-lookup"><span data-stu-id="c50b8-137">No exception is thrown if the transaction is committed.</span></span>  
  
## <a name="rolling-back-a-transaction"></a><span data-ttu-id="c50b8-138">Restauration d’une transaction</span><span class="sxs-lookup"><span data-stu-id="c50b8-138">Rolling back a transaction</span></span>  
 <span data-ttu-id="c50b8-139">Pour restaurer une transaction, n'appelez pas la méthode <xref:System.Transactions.TransactionScope.Complete%2A> dans l'étendue de transaction.</span><span class="sxs-lookup"><span data-stu-id="c50b8-139">If you want to rollback a transaction, you should not call the <xref:System.Transactions.TransactionScope.Complete%2A> method within the transaction scope.</span></span> <span data-ttu-id="c50b8-140">Par exemple, vous pouvez lever une exception dans l'étendue.</span><span class="sxs-lookup"><span data-stu-id="c50b8-140">For example, you can throw an exception within the scope.</span></span> <span data-ttu-id="c50b8-141">La transaction à laquelle il participe est restaurée.</span><span class="sxs-lookup"><span data-stu-id="c50b8-141">The transaction in which it participates in will be rolled back.</span></span>  
  
## <a name="managing-transaction-flow-using-transactionscopeoption"></a><a name="ManageTxFlow"></a><span data-ttu-id="c50b8-142">Gestion du workflow de transaction à l’aide de TransactionScopeOption</span><span class="sxs-lookup"><span data-stu-id="c50b8-142">Managing transaction flow using TransactionScopeOption</span></span>  
 <span data-ttu-id="c50b8-143">L'étendue de transaction peut être imbriquée en appelant une méthode qui utilise une <xref:System.Transactions.TransactionScope> à partir d'une méthode utilisant sa propre étendue, comme la méthode `RootMethod` de l'exemple suivant,</span><span class="sxs-lookup"><span data-stu-id="c50b8-143">Transaction scope can be nested by calling a method that uses a <xref:System.Transactions.TransactionScope> from within a method that uses its own scope, as is the case with the `RootMethod` method in the following example,</span></span>  
  
```csharp  
void RootMethod()
{
    using(TransactionScope scope = new TransactionScope())
    {
        /* Perform transactional work here */
        SomeMethod();
        scope.Complete();
    }
}

void SomeMethod()
{
    using(TransactionScope scope = new TransactionScope())
    {
        /* Perform transactional work here */
        scope.Complete();
    }
}
```  
  
 <span data-ttu-id="c50b8-144">L'étendue de transaction supérieure est appelée « étendue racine ».</span><span class="sxs-lookup"><span data-stu-id="c50b8-144">The top-most transaction scope is referred to as the root scope.</span></span>  
  
 <span data-ttu-id="c50b8-145">La classe <xref:System.Transactions.TransactionScope> fournit plusieurs constructeurs surchargés qui acceptent une énumération de type <xref:System.Transactions.TransactionScopeOption>, qui définit le comportement transactionnel de l'étendue.</span><span class="sxs-lookup"><span data-stu-id="c50b8-145">The <xref:System.Transactions.TransactionScope> class provides several overloaded constructors that accept an enumeration of the type <xref:System.Transactions.TransactionScopeOption>, which defines the transactional behavior of the scope.</span></span>  
  
 <span data-ttu-id="c50b8-146">Un objet <xref:System.Transactions.TransactionScope> dispose de trois options :</span><span class="sxs-lookup"><span data-stu-id="c50b8-146">A <xref:System.Transactions.TransactionScope> object has three options:</span></span>  
  
- <span data-ttu-id="c50b8-147">Joindre la transaction ambiante ou en créer une nouvelle s'il n'en existe pas.</span><span class="sxs-lookup"><span data-stu-id="c50b8-147">Join the ambient transaction, or create a new one if one does not exist.</span></span>  
  
- <span data-ttu-id="c50b8-148">Constituer une nouvelle étendue racine, c'est-à-dire démarrer une nouvelle transaction et en faire la nouvelle transaction ambiante de sa propre étendue.</span><span class="sxs-lookup"><span data-stu-id="c50b8-148">Be a new root scope, that is, start a new transaction and have that transaction be the new ambient transaction inside its own scope.</span></span>  
  
- <span data-ttu-id="c50b8-149">Ne participer à aucune transaction.</span><span class="sxs-lookup"><span data-stu-id="c50b8-149">Not take part in a transaction at all.</span></span> <span data-ttu-id="c50b8-150">En conséquence, il n'y a pas de transaction ambiante.</span><span class="sxs-lookup"><span data-stu-id="c50b8-150">There is no ambient transaction as a result.</span></span>  
  
 <span data-ttu-id="c50b8-151">Si l'étendue est instanciée avec <xref:System.Transactions.TransactionScopeOption.Required> et qu'une transaction ambiante existe, l'étendue joint cette transaction.</span><span class="sxs-lookup"><span data-stu-id="c50b8-151">If the scope is instantiated with <xref:System.Transactions.TransactionScopeOption.Required>, and an ambient transaction is present, the scope joins that transaction.</span></span> <span data-ttu-id="c50b8-152">En revanche, s'il n'y a pas de transaction ambiante, l'étendue en crée une nouvelle et devient l'étendue racine.</span><span class="sxs-lookup"><span data-stu-id="c50b8-152">If, on the other hand, there is no ambient transaction, then the scope creates a new transaction, and become the root scope.</span></span> <span data-ttu-id="c50b8-153">Il s’agit de la valeur par défaut.</span><span class="sxs-lookup"><span data-stu-id="c50b8-153">This is the default value.</span></span> <span data-ttu-id="c50b8-154">Si <xref:System.Transactions.TransactionScopeOption.Required> est utilisé, le code de l'étendue n'a pas à se comporter différemment selon qu'il s'agit de la racine ou seulement de la jonction de la transaction ambiante.</span><span class="sxs-lookup"><span data-stu-id="c50b8-154">When <xref:System.Transactions.TransactionScopeOption.Required> is used, the code inside the scope does not need to behave differently whether it is the root or just joining the ambient transaction.</span></span> <span data-ttu-id="c50b8-155">Il fonctionne de la même façon dans les deux cas.</span><span class="sxs-lookup"><span data-stu-id="c50b8-155">It should operate identically in both cases.</span></span>  
  
 <span data-ttu-id="c50b8-156">Si l'étendue est instanciée avec <xref:System.Transactions.TransactionScopeOption.RequiresNew>, il s'agit toujours de l'étendue racine.</span><span class="sxs-lookup"><span data-stu-id="c50b8-156">If the scope is instantiated with <xref:System.Transactions.TransactionScopeOption.RequiresNew>, it is always the root scope.</span></span> <span data-ttu-id="c50b8-157">Une nouvelle transaction démarre et devient la nouvelle transaction ambiante de l'étendue.</span><span class="sxs-lookup"><span data-stu-id="c50b8-157">It starts a new transaction, and its transaction becomes the new ambient transaction inside the scope.</span></span>  
  
 <span data-ttu-id="c50b8-158">Si la portée est instanciée avec <xref:System.Transactions.TransactionScopeOption.Suppress>, elle ne prend jamais part à une transaction, qu'une transaction ambiante existe ou non.</span><span class="sxs-lookup"><span data-stu-id="c50b8-158">If the scope is instantiated with <xref:System.Transactions.TransactionScopeOption.Suppress>, it never takes part in a transaction, regardless of whether an ambient transaction is present.</span></span> <span data-ttu-id="c50b8-159">Une portée instanciée avec cette valeur a toujours `null` comme sa transaction ambiante.</span><span class="sxs-lookup"><span data-stu-id="c50b8-159">A scope instantiated with this value always have `null` as its ambient transaction.</span></span>  
  
 <span data-ttu-id="c50b8-160">Ces options sont répertoriées dans le tableau suivant.</span><span class="sxs-lookup"><span data-stu-id="c50b8-160">The above options are summarized in the following table.</span></span>  
  
|<span data-ttu-id="c50b8-161">TransactionScopeOption</span><span class="sxs-lookup"><span data-stu-id="c50b8-161">TransactionScopeOption</span></span>|<span data-ttu-id="c50b8-162">Transaction ambiante</span><span class="sxs-lookup"><span data-stu-id="c50b8-162">Ambient Transaction</span></span>|<span data-ttu-id="c50b8-163">L'étendue participe à</span><span class="sxs-lookup"><span data-stu-id="c50b8-163">The scope takes part in</span></span>|  
|----------------------------|-------------------------|-----------------------------|  
|<span data-ttu-id="c50b8-164">Obligatoire</span><span class="sxs-lookup"><span data-stu-id="c50b8-164">Required</span></span>|<span data-ttu-id="c50b8-165">No</span><span class="sxs-lookup"><span data-stu-id="c50b8-165">No</span></span>|<span data-ttu-id="c50b8-166">Nouvelle transaction (future racine)</span><span class="sxs-lookup"><span data-stu-id="c50b8-166">New Transaction (will be the root)</span></span>|  
|<span data-ttu-id="c50b8-167">Nouveau requis</span><span class="sxs-lookup"><span data-stu-id="c50b8-167">Requires New</span></span>|<span data-ttu-id="c50b8-168">No</span><span class="sxs-lookup"><span data-stu-id="c50b8-168">No</span></span>|<span data-ttu-id="c50b8-169">Nouvelle transaction (future racine)</span><span class="sxs-lookup"><span data-stu-id="c50b8-169">New Transaction (will be the root)</span></span>|  
|<span data-ttu-id="c50b8-170">Suppress</span><span class="sxs-lookup"><span data-stu-id="c50b8-170">Suppress</span></span>|<span data-ttu-id="c50b8-171">No</span><span class="sxs-lookup"><span data-stu-id="c50b8-171">No</span></span>|<span data-ttu-id="c50b8-172">Aucune transaction</span><span class="sxs-lookup"><span data-stu-id="c50b8-172">No Transaction</span></span>|  
|<span data-ttu-id="c50b8-173">Obligatoire</span><span class="sxs-lookup"><span data-stu-id="c50b8-173">Required</span></span>|<span data-ttu-id="c50b8-174">Oui</span><span class="sxs-lookup"><span data-stu-id="c50b8-174">Yes</span></span>|<span data-ttu-id="c50b8-175">Transaction ambiante</span><span class="sxs-lookup"><span data-stu-id="c50b8-175">Ambient  Transaction</span></span>|  
|<span data-ttu-id="c50b8-176">Nouveau requis</span><span class="sxs-lookup"><span data-stu-id="c50b8-176">Requires New</span></span>|<span data-ttu-id="c50b8-177">Yes</span><span class="sxs-lookup"><span data-stu-id="c50b8-177">Yes</span></span>|<span data-ttu-id="c50b8-178">Nouvelle transaction (future racine)</span><span class="sxs-lookup"><span data-stu-id="c50b8-178">New Transaction (will be the root)</span></span>|  
|<span data-ttu-id="c50b8-179">Suppress</span><span class="sxs-lookup"><span data-stu-id="c50b8-179">Suppress</span></span>|<span data-ttu-id="c50b8-180">Yes</span><span class="sxs-lookup"><span data-stu-id="c50b8-180">Yes</span></span>|<span data-ttu-id="c50b8-181">Aucune transaction</span><span class="sxs-lookup"><span data-stu-id="c50b8-181">No Transaction</span></span>|  
  
 <span data-ttu-id="c50b8-182">Lorsqu'un objet <xref:System.Transactions.TransactionScope> joint une transaction ambiante existante, la suppression de l'objet d'étendue peut ne pas entraîner l'arrêt de la transaction, à moins que l'étendue abandonne la transaction.</span><span class="sxs-lookup"><span data-stu-id="c50b8-182">When a <xref:System.Transactions.TransactionScope> object joins an existing ambient transaction, disposing of the scope object may not end the transaction, unless the scope aborts the transaction.</span></span> <span data-ttu-id="c50b8-183">Si la transaction ambiante a été créée par une étendue racine, seulement lorsque l'étendue racine est supprimée, <xref:System.Transactions.CommittableTransaction.Commit%2A> est appelé sur la transaction.</span><span class="sxs-lookup"><span data-stu-id="c50b8-183">If the ambient transaction was created by a root scope, only when the root scope is disposed of, does <xref:System.Transactions.CommittableTransaction.Commit%2A> get called on the transaction.</span></span> <span data-ttu-id="c50b8-184">Si la transaction a été créée manuellement, elle se termine lors de son abandon ou de sa validation par son créateur.</span><span class="sxs-lookup"><span data-stu-id="c50b8-184">If the transaction was created manually, the transaction ends when it is either aborted, or committed by its creator.</span></span>  
  
 <span data-ttu-id="c50b8-185">L'exemple suivant montre un objet <xref:System.Transactions.TransactionScope> qui crée trois objets d'étendue imbriqués, chacun étant instancié avec une valeur <xref:System.Transactions.TransactionScopeOption> différente.</span><span class="sxs-lookup"><span data-stu-id="c50b8-185">The following example shows a <xref:System.Transactions.TransactionScope> object that creates three nested scope objects, each instantiated with a different <xref:System.Transactions.TransactionScopeOption> value.</span></span>  
  
```csharp  
using(TransactionScope scope1 = new TransactionScope())
//Default is Required
{
    using(TransactionScope scope2 = new TransactionScope(TransactionScopeOption.Required))
    {
        //...
    }

    using(TransactionScope scope3 = new TransactionScope(TransactionScopeOption.RequiresNew))
    {
        //...  
    }
  
    using(TransactionScope scope4 = new TransactionScope(TransactionScopeOption.Suppress))
    {
        //...  
    }
}
```  
  
 <span data-ttu-id="c50b8-186">Cet exemple montre un bloc de code sans transaction ambiante créant une nouvelle étendue (`scope1`) avec <xref:System.Transactions.TransactionScopeOption.Required>.</span><span class="sxs-lookup"><span data-stu-id="c50b8-186">The example shows a code block without any ambient transaction creating a new scope (`scope1`) with <xref:System.Transactions.TransactionScopeOption.Required>.</span></span> <span data-ttu-id="c50b8-187">La portée `scope1` est une portée racine, car elle crée une transaction (Transaction A) pour en faire la transaction ambiante.</span><span class="sxs-lookup"><span data-stu-id="c50b8-187">The scope `scope1` is a root scope as it creates a new transaction (Transaction A) and makes Transaction A the ambient transaction.</span></span> <span data-ttu-id="c50b8-188">`Scope1`crée ensuite trois objets supplémentaires, chacun avec une <xref:System.Transactions.TransactionScopeOption> valeur différente.</span><span class="sxs-lookup"><span data-stu-id="c50b8-188">`Scope1` then creates three more objects, each with a different <xref:System.Transactions.TransactionScopeOption> value.</span></span> <span data-ttu-id="c50b8-189">Par exemple, `scope2` est créée avec <xref:System.Transactions.TransactionScopeOption.Required> et puisqu'il s'agit d'une transaction ambiante, elle joint la première transaction créée par `scope1`.</span><span class="sxs-lookup"><span data-stu-id="c50b8-189">For example, `scope2` is created with <xref:System.Transactions.TransactionScopeOption.Required>, and since there is an ambient transaction, it joins the first transaction created by `scope1`.</span></span> <span data-ttu-id="c50b8-190">Notez que `scope3` est l'étendue racine d'une nouvelle transaction et que `scope4` ne dispose pas de transaction ambiante.</span><span class="sxs-lookup"><span data-stu-id="c50b8-190">Note that `scope3` is the root scope of a new transaction, and that `scope4` has no ambient transaction.</span></span>  
  
 <span data-ttu-id="c50b8-191">Bien que la valeur par défaut, et la plus utilisée, de <xref:System.Transactions.TransactionScopeOption> est <xref:System.Transactions.TransactionScopeOption.Required>, chacune des autres valeurs a une fonction unique.</span><span class="sxs-lookup"><span data-stu-id="c50b8-191">Although the default and most commonly used value of <xref:System.Transactions.TransactionScopeOption> is <xref:System.Transactions.TransactionScopeOption.Required>, each of the other values has its unique purpose.</span></span>  

### <a name="non-transactional-code-inside-a-transaction-scope"></a><span data-ttu-id="c50b8-192">Code non transactionnel à l’intérieur d’une étendue de transaction</span><span class="sxs-lookup"><span data-stu-id="c50b8-192">Non-transactional code inside a transaction scope</span></span>

 <span data-ttu-id="c50b8-193"><xref:System.Transactions.TransactionScopeOption.Suppress>est utile lorsque vous souhaitez conserver les opérations effectuées par la section de code et ne souhaitez pas abandonner la transaction ambiante si les opérations échouent.</span><span class="sxs-lookup"><span data-stu-id="c50b8-193"><xref:System.Transactions.TransactionScopeOption.Suppress> is useful when you want to preserve the operations performed by the code section, and do not want to abort the ambient transaction if the operations fail.</span></span> <span data-ttu-id="c50b8-194">Pour effectuer des opérations d'enregistrement ou d'audit par exemple, ou pour publier des événements aux abonnés, indépendamment de la validation ou de l'abandon de votre transaction ambiante.</span><span class="sxs-lookup"><span data-stu-id="c50b8-194">For example, when you want to perform logging or audit operations, or when you want to publish events to subscribers regardless of whether your ambient transaction commits or aborts.</span></span> <span data-ttu-id="c50b8-195">Cette valeur vous permet d'avoir une section de code non transactionnelle dans une étendue de transaction, comme illustré dans l'exemple suivant.</span><span class="sxs-lookup"><span data-stu-id="c50b8-195">This value allows you to have a non-transactional code section inside a transaction scope, as shown in the following example.</span></span>  
  
```csharp  
using(TransactionScope scope1 = new TransactionScope())
{
    try
    {
        //Start of non-transactional section
        using(TransactionScope scope2 = new
            TransactionScope(TransactionScopeOption.Suppress))  
        {  
            //Do non-transactional work here  
        }  
        //Restores ambient transaction here
   }
   catch {}  
   //Rest of scope1
}
```  
  
### <a name="voting-inside-a-nested-scope"></a><span data-ttu-id="c50b8-196">Vote au sein d'une étendue imbriquée</span><span class="sxs-lookup"><span data-stu-id="c50b8-196">Voting inside a nested scope</span></span>  
 <span data-ttu-id="c50b8-197">Bien qu'une étendue imbriquée puisse joindre la transaction ambiante de l'étendue racine, appeler <xref:System.Transactions.TransactionScope.Complete%2A> dans l'étendue imbriquée n'a pas d'effet sur l'étendue racine.</span><span class="sxs-lookup"><span data-stu-id="c50b8-197">Although a nested scope can join the ambient transaction of the root scope, calling <xref:System.Transactions.TransactionScope.Complete%2A> in the nested scope has no affect on the root scope.</span></span> <span data-ttu-id="c50b8-198">La transaction n'est validée que si toutes les étendues, de l'étendue racine à la dernière étendue imbriquée, votent sa validation.</span><span class="sxs-lookup"><span data-stu-id="c50b8-198">Only if all the scopes from the root scope down to the last nested scope vote to commit the transaction, will the transaction be committed.</span></span> <span data-ttu-id="c50b8-199">Si vous n'appelez pas <xref:System.Transactions.TransactionScope.Complete%2A> dans une étendue imbriquée pour affecter l'étendue racine comme transaction ambiante, l'opération échouera immédiatement.</span><span class="sxs-lookup"><span data-stu-id="c50b8-199">Not calling <xref:System.Transactions.TransactionScope.Complete%2A> in a nested scope will affect the root scope as the ambient transaction will immediately be aborted.</span></span>  
  
## <a name="setting-the-transactionscope-timeout"></a><span data-ttu-id="c50b8-200">Définition du délai d'attente TransactionScope</span><span class="sxs-lookup"><span data-stu-id="c50b8-200">Setting the TransactionScope timeout</span></span>  
 <span data-ttu-id="c50b8-201">Certains des constructeurs surchargés de <xref:System.Transactions.TransactionScope> acceptent une valeur de type <xref:System.TimeSpan>, utilisée pour contrôler le délai d'attente de la transaction.</span><span class="sxs-lookup"><span data-stu-id="c50b8-201">Some of the overloaded constructors of <xref:System.Transactions.TransactionScope> accept a value of type <xref:System.TimeSpan>, which is used to control the timeout of the transaction.</span></span> <span data-ttu-id="c50b8-202">La valeur zéro indique un délai d'attente infini.</span><span class="sxs-lookup"><span data-stu-id="c50b8-202">A timeout set to zero means an infinite timeout.</span></span> <span data-ttu-id="c50b8-203">Le délai d'attente infini est particulièrement utile pour le débogage, lorsque vous voulez isoler un problème au sein de votre logique métier grâce au code, sans que la transaction que vous déboguez expire lors de la localisation du problème.</span><span class="sxs-lookup"><span data-stu-id="c50b8-203">Infinite timeout is useful mostly for debugging, when you want to isolate a problem in your business logic by stepping through your code, and you do not want the transaction you debug to time out while you attempt to locate the problem.</span></span> <span data-ttu-id="c50b8-204">Utilisez la valeur de délai d'attente infini avec précaution dans tous les autres cas, car elle substitue les dispositifs de protection par des blocages de transaction.</span><span class="sxs-lookup"><span data-stu-id="c50b8-204">Be extremely careful using the infinite timeout value in all other cases, because it overrides the safeguards against transaction deadlocks.</span></span>  
  
 <span data-ttu-id="c50b8-205">Le délai d'attente <xref:System.Transactions.TransactionScope> peut prendre des valeurs autres que celle par défaut dans deux cas.</span><span class="sxs-lookup"><span data-stu-id="c50b8-205">You typically set the <xref:System.Transactions.TransactionScope> timeout to values other than default in two cases.</span></span> <span data-ttu-id="c50b8-206">Le premier cas intervient lors du développement, lorsque vous voulez tester la façon dont votre application gère les transactions abandonnées.</span><span class="sxs-lookup"><span data-stu-id="c50b8-206">The first is during development, when you want to test the way your application handles aborted transactions.</span></span> <span data-ttu-id="c50b8-207">En affectant une faible valeur au délai d'attente (tel qu'une milliseconde), vous provoquez l'échec de la transaction et pouvez ainsi obtenir le code de gestion des erreurs.</span><span class="sxs-lookup"><span data-stu-id="c50b8-207">By setting the timeout to a small value (such as one millisecond), you cause your transaction to fail and can thus observe your error handling code.</span></span> <span data-ttu-id="c50b8-208">Le second cas pour lequel il est nécessaire de définir une valeur inférieure au délai d'attente par défaut est lorsque vous pensez que l'étendue est à l'origine de conflits de ressources, causant des blocages.</span><span class="sxs-lookup"><span data-stu-id="c50b8-208">The second case in which you set the value to be less than the default timeout is when you believe that the scope is involved in resource contention, resulting in deadlocks.</span></span> <span data-ttu-id="c50b8-209">Dans ce cas, abandonnez la transaction dès que possible et n'attendez pas l'expiration du délai d'attente par défaut.</span><span class="sxs-lookup"><span data-stu-id="c50b8-209">In that case, you want to abort the transaction as soon as possible and not wait for the default timeout to expire.</span></span>  
  
 <span data-ttu-id="c50b8-210">Lorsqu'une étendue joint une transaction ambiante avec un délai d'attente plus court que celui de la transaction ambiante, le nouveau délai, plus court, est appliqué à l'objet <xref:System.Transactions.TransactionScope> et l'étendue doit se terminer dans le temps imbriqué spécifié, sans quoi la transaction est automatiquement abandonnée.</span><span class="sxs-lookup"><span data-stu-id="c50b8-210">When a scope joins an ambient transaction but specifies a smaller timeout than the one the ambient transaction is set to, the new, shorter timeout is enforced on the <xref:System.Transactions.TransactionScope> object, and the scope must end within the nested time specified, or the transaction is automatically aborted.</span></span> <span data-ttu-id="c50b8-211">Si le délai d'attente de l'étendue imbriquée est supérieur à celui de la transaction ambiante, il n'a aucun effet.</span><span class="sxs-lookup"><span data-stu-id="c50b8-211">If the nested scope's timeout is more than that of the ambient transaction, it has no effect.</span></span>  
  
## <a name="setting-the-transactionscope-isolation-level"></a><span data-ttu-id="c50b8-212">Définition du niveau d'isolation TransactionScope</span><span class="sxs-lookup"><span data-stu-id="c50b8-212">Setting the TransactionScope isolation level</span></span>  
 <span data-ttu-id="c50b8-213">Certains des constructeurs surchargés de <xref:System.Transactions.TransactionScope> acceptent une structure de type <xref:System.Transactions.TransactionOptions> pour spécifier un niveau d'isolation, en plus d'une valeur de délai d'attente.</span><span class="sxs-lookup"><span data-stu-id="c50b8-213">Some of the overloaded constructors of <xref:System.Transactions.TransactionScope> accept a structure of type <xref:System.Transactions.TransactionOptions> to specify an isolation level, in addition to a timeout value.</span></span> <span data-ttu-id="c50b8-214">Par défaut, la transaction s'exécute avec un niveau d'isolation de valeur <xref:System.Transactions.IsolationLevel.Serializable>.</span><span class="sxs-lookup"><span data-stu-id="c50b8-214">By default, the transaction executes with isolation level set to <xref:System.Transactions.IsolationLevel.Serializable>.</span></span> <span data-ttu-id="c50b8-215">On utilise habituellement un niveau d'isolation autre que <xref:System.Transactions.IsolationLevel.Serializable> pour les systèmes de lecture intensive.</span><span class="sxs-lookup"><span data-stu-id="c50b8-215">Selecting an isolation level other than <xref:System.Transactions.IsolationLevel.Serializable> is commonly used for read-intensive systems.</span></span> <span data-ttu-id="c50b8-216">Cela requiert une solide compréhension de la théorie sur le traitement des transactions et de la sémantique de la transaction même, des problèmes d'accès concurrentiel ainsi que des conséquences pour la cohérence du système.</span><span class="sxs-lookup"><span data-stu-id="c50b8-216">This requires a solid understanding of transaction processing theory and the semantics of the transaction itself, the concurrency issues involved, and the consequences for system consistency.</span></span>  
  
 <span data-ttu-id="c50b8-217">De plus, tous les gestionnaires de ressources ne supportent pas l'ensemble des niveaux d'isolation et peuvent choisir de prendre part à la transaction à un niveau supérieur à celui configuré.</span><span class="sxs-lookup"><span data-stu-id="c50b8-217">In addition, not all resource managers support all levels of isolation, and they may elect to take part in the transaction at a higher level than the one configured.</span></span>  
  
 <span data-ttu-id="c50b8-218">Chaque niveau d'isolation, hormis <xref:System.Transactions.IsolationLevel.Serializable>, est susceptible de résulter de façon incohérente d'autres transactions accédant aux mêmes informations.</span><span class="sxs-lookup"><span data-stu-id="c50b8-218">Every isolation level besides <xref:System.Transactions.IsolationLevel.Serializable> is susceptible to inconsistency resulting from other transactions accessing the same information.</span></span> <span data-ttu-id="c50b8-219">La différence entre les niveaux d'isolation réside dans l'utilisation des verrous de lecture et d'écriture.</span><span class="sxs-lookup"><span data-stu-id="c50b8-219">The difference between the different isolation levels is in the way read and write locks are used.</span></span> <span data-ttu-id="c50b8-220">Un verrou ne peut être maintenu que lorsque la transaction accède aux données du gestionnaire de ressources ou jusqu'à ce que la transaction soit validée ou abandonnée.</span><span class="sxs-lookup"><span data-stu-id="c50b8-220">A lock can be held only when the transaction accesses the data in the resource manager, or it can be held until the transaction is committed or aborted.</span></span> <span data-ttu-id="c50b8-221">Le premier est utilisé pour le débit et le deuxième pour la cohérence.</span><span class="sxs-lookup"><span data-stu-id="c50b8-221">The former is better for throughput, the latter for consistency.</span></span> <span data-ttu-id="c50b8-222">Les deux types de verrou et les deux types d'opération (lecture/écriture) donnent quatre niveaux d'isolation de base.</span><span class="sxs-lookup"><span data-stu-id="c50b8-222">The two kinds of locks and the two kinds of operations (read/write) give four basic isolation levels.</span></span> <span data-ttu-id="c50b8-223">Consultez la rubrique <xref:System.Transactions.IsolationLevel> (éventuellement en anglais) pour plus d'informations.</span><span class="sxs-lookup"><span data-stu-id="c50b8-223">See <xref:System.Transactions.IsolationLevel> for more information.</span></span>  
  
 <span data-ttu-id="c50b8-224">En cas d'utilisation d'objets <xref:System.Transactions.TransactionScope> imbriqués, toutes les étendues imbriquées doivent être configurées pour utiliser le même niveau d'isolation pour pouvoir joindre la transaction ambiante.</span><span class="sxs-lookup"><span data-stu-id="c50b8-224">When using nested <xref:System.Transactions.TransactionScope> objects, all nested scopes must be configured to use exactly the same isolation level if they want to join the ambient transaction.</span></span> <span data-ttu-id="c50b8-225">Si un objet <xref:System.Transactions.TransactionScope> imbriqué tente de joindre la transaction ambiante avec un niveau d'isolation différent, une exception <xref:System.ArgumentException> est levée.</span><span class="sxs-lookup"><span data-stu-id="c50b8-225">If a nested <xref:System.Transactions.TransactionScope> object tries to join the ambient transaction yet it specifies a different isolation level, an <xref:System.ArgumentException> is thrown.</span></span>  
  
## <a name="interop-with-com"></a><span data-ttu-id="c50b8-226">Interopérabilité avec COM+</span><span class="sxs-lookup"><span data-stu-id="c50b8-226">Interop with COM+</span></span>  
 <span data-ttu-id="c50b8-227">Lors de la création d'une nouvelle instance <xref:System.Transactions.TransactionScope>, vous pouvez utiliser l'énumération <xref:System.Transactions.EnterpriseServicesInteropOption> dans l'un des constructeurs pour spécifier comment interagir avec COM+.</span><span class="sxs-lookup"><span data-stu-id="c50b8-227">When you create a new <xref:System.Transactions.TransactionScope> instance, you can use the <xref:System.Transactions.EnterpriseServicesInteropOption> enumeration in one of the constructors to specify how to interact with COM+.</span></span> <span data-ttu-id="c50b8-228">Pour plus d’informations à ce propos, consultez [interopérabilité avec Enterprise Services et les transactions com+](interoperability-with-enterprise-services-and-com-transactions.md).</span><span class="sxs-lookup"><span data-stu-id="c50b8-228">For more information on this, see [Interoperability with Enterprise Services and COM+ Transactions](interoperability-with-enterprise-services-and-com-transactions.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="c50b8-229">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="c50b8-229">See also</span></span>

- <xref:System.Transactions.Transaction.Clone%2A>
- <xref:System.Transactions.TransactionScope>
