---
title: Base de données par microservice
description: Stockage de données contrasté dans les applications monolithiques et cloud-natives.
author: robvet
ms.date: 01/22/2020
ms.openlocfilehash: c0c5611fa866d70f155e4bdad2eee1181b13c065
ms.sourcegitcommit: 7588136e355e10cbc2582f389c90c127363c02a5
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 03/12/2020
ms.locfileid: "79141443"
---
# <a name="database-per-microservice"></a><span data-ttu-id="e63b8-103">Base de données par microservice</span><span class="sxs-lookup"><span data-stu-id="e63b8-103">Database-per-microservice</span></span>

[!INCLUDE [book-preview](../../../includes/book-preview.md)]

<span data-ttu-id="e63b8-104">Comme nous l’avons vu tout au long de ce livre, une approche cloud-native change la façon dont vous concevez, déployez et gérez les applications.</span><span class="sxs-lookup"><span data-stu-id="e63b8-104">As we've seen throughout this book, a cloud-native approach changes the way you design, deploy, and manage applications.</span></span> <span data-ttu-id="e63b8-105">Il modifie également la façon dont vous gérez et stockez les données.</span><span class="sxs-lookup"><span data-stu-id="e63b8-105">It also changes the way you manage and store data.</span></span>

<span data-ttu-id="e63b8-106">La figure 5-1 contraste avec les différences.</span><span class="sxs-lookup"><span data-stu-id="e63b8-106">Figure 5-1 contrasts the differences.</span></span>

![Stockage de données dans les applications cloud-native](./media/distributed-data.png)

<span data-ttu-id="e63b8-108">**Figure 5-1**.</span><span class="sxs-lookup"><span data-stu-id="e63b8-108">**Figure 5-1**.</span></span> <span data-ttu-id="e63b8-109">Gestion des données dans les applications cloud-native</span><span class="sxs-lookup"><span data-stu-id="e63b8-109">Data management in cloud-native applications</span></span>

<span data-ttu-id="e63b8-110">Les développeurs expérimentés reconnaîtront facilement l’architecture sur le côté gauche de la figure 5-1.</span><span class="sxs-lookup"><span data-stu-id="e63b8-110">Experienced developers will easily recognize the architecture on the left-side of figure 5-1.</span></span> <span data-ttu-id="e63b8-111">Dans cette *application monolithique,* les composants de services d’affaires se regroupent dans un niveau de services partagés, partageant les données d’une seule base de données relationnelle.</span><span class="sxs-lookup"><span data-stu-id="e63b8-111">In this *monolithic application*, business service components collocate together in a shared services tier, sharing data from a single relational database.</span></span>

<span data-ttu-id="e63b8-112">À bien des égards, une seule base de données permet de simplifier la gestion des données.</span><span class="sxs-lookup"><span data-stu-id="e63b8-112">In many ways, a single database keeps data management simple.</span></span> <span data-ttu-id="e63b8-113">Il est simple de poser des données sur plusieurs tableaux.</span><span class="sxs-lookup"><span data-stu-id="e63b8-113">Querying data across multiple tables is straightforward.</span></span> <span data-ttu-id="e63b8-114">Modifications apportées à la mise à jour des données ensemble ou elles sont toutes en recul.</span><span class="sxs-lookup"><span data-stu-id="e63b8-114">Changes to data update together or they all rollback.</span></span> <span data-ttu-id="e63b8-115">[Les transactions ACID](https://docs.microsoft.com/windows/desktop/cossdk/acid-properties) garantissent une cohérence forte et immédiate.</span><span class="sxs-lookup"><span data-stu-id="e63b8-115">[ACID transactions](https://docs.microsoft.com/windows/desktop/cossdk/acid-properties) guarantee strong and immediate consistency.</span></span>

<span data-ttu-id="e63b8-116">Concevoir pour le cloud-native, nous adoptons une approche différente.</span><span class="sxs-lookup"><span data-stu-id="e63b8-116">Designing for cloud-native, we take a different approach.</span></span> <span data-ttu-id="e63b8-117">Sur le côté droit de la figure 5-1, notez comment la fonctionnalité des entreprises se sépare en petits microservices indépendants.</span><span class="sxs-lookup"><span data-stu-id="e63b8-117">On the right-side of Figure 5-1, note how business functionality segregates into small, independent microservices.</span></span> <span data-ttu-id="e63b8-118">Chaque microservice encapsule une capacité d’entreprise spécifique et ses propres données.</span><span class="sxs-lookup"><span data-stu-id="e63b8-118">Each microservice encapsulates a specific business capability and its own data.</span></span> <span data-ttu-id="e63b8-119">La base de données monolithique se décompose en un modèle de données distribués avec de nombreuses bases de données plus petites, chacune s’alignant sur un microservice.</span><span class="sxs-lookup"><span data-stu-id="e63b8-119">The monolithic database decomposes into a distributed data model with many smaller databases, each aligning with a microservice.</span></span> <span data-ttu-id="e63b8-120">Lorsque la fumée s’éclaircit, nous émergeons avec un design qui expose une *base de données par microservice.*</span><span class="sxs-lookup"><span data-stu-id="e63b8-120">When the smoke clears, we emerge with a design that exposes a *database per microservice*.</span></span>

## <a name="why"></a><span data-ttu-id="e63b8-121">Pourquoi ?</span><span class="sxs-lookup"><span data-stu-id="e63b8-121">Why?</span></span>

<span data-ttu-id="e63b8-122">Cette base de données par microservice offre de nombreux avantages, en particulier pour les systèmes qui doivent évoluer rapidement et soutenir l’échelle massive.</span><span class="sxs-lookup"><span data-stu-id="e63b8-122">This database per microservice provides many benefits, especially for systems that must evolve rapidly and support massive scale.</span></span> <span data-ttu-id="e63b8-123">Avec ce modèle...</span><span class="sxs-lookup"><span data-stu-id="e63b8-123">With this model...</span></span>

- <span data-ttu-id="e63b8-124">Les données de domaine sont encapsulées au sein du service</span><span class="sxs-lookup"><span data-stu-id="e63b8-124">Domain data is encapsulated within the service</span></span>
- <span data-ttu-id="e63b8-125">Le schéma de données peut évoluer sans avoir d’impact direct sur d’autres services</span><span class="sxs-lookup"><span data-stu-id="e63b8-125">Data schema can evolve without directly impacting other services</span></span>
- <span data-ttu-id="e63b8-126">Chaque magasin de données peut évoluer de façon indépendante</span><span class="sxs-lookup"><span data-stu-id="e63b8-126">Each data store can independently scale</span></span>
- <span data-ttu-id="e63b8-127">Une défaillance d’un magasin de données dans un service n’aura pas d’impact direct sur d’autres services</span><span class="sxs-lookup"><span data-stu-id="e63b8-127">A data store failure in one service won't directly impact other services</span></span>

<span data-ttu-id="e63b8-128">La séparation des données permet également à chaque microservice de mettre en œuvre le type de magasin de données qui est le mieux optimisé pour sa charge de travail, ses besoins de stockage et ses modèles de lecture et d’écriture.</span><span class="sxs-lookup"><span data-stu-id="e63b8-128">Segregating data also enables each microservice to implement the data store type that is best optimized for its workload, storage needs, and read/write patterns.</span></span> <span data-ttu-id="e63b8-129">Les choix comprennent des magasins de données relationnels, documentaires, de valeur clé et même graphiques.</span><span class="sxs-lookup"><span data-stu-id="e63b8-129">Choices include relational, document, key-value, and even graph-based data stores.</span></span>

<span data-ttu-id="e63b8-130">La figure 5-2 présente le principe de la persistance polyglotte dans un système nébuleux.</span><span class="sxs-lookup"><span data-stu-id="e63b8-130">Figure 5-2 presents the principle of polyglot persistence in a cloud-native system.</span></span>

![Persistance des données polyglotte](./media/polyglot-data-persistence.png)

<span data-ttu-id="e63b8-132">**Figure 5-2**.</span><span class="sxs-lookup"><span data-stu-id="e63b8-132">**Figure 5-2**.</span></span> <span data-ttu-id="e63b8-133">Persistance des données polyglotte</span><span class="sxs-lookup"><span data-stu-id="e63b8-133">Polyglot data persistence</span></span>

<span data-ttu-id="e63b8-134">Notez dans le chiffre précédent comment chaque microservice prend en charge un type différent de magasin de données.</span><span class="sxs-lookup"><span data-stu-id="e63b8-134">Note in the previous figure how each microservice supports a different type of data store.</span></span>

- <span data-ttu-id="e63b8-135">Le microservice de catalogue de produits consomme une base de données relationnelle pour s’adapter à la riche structure relationnelle de ses données sous-jacentes.</span><span class="sxs-lookup"><span data-stu-id="e63b8-135">The product catalog microservice consumes a relational database to accommodate the rich relational structure of its underlying data.</span></span>
- <span data-ttu-id="e63b8-136">Le microservice de panier consomme un cache distribué qui prend en charge son magasin de données simple et de valeur clé.</span><span class="sxs-lookup"><span data-stu-id="e63b8-136">The shopping cart microservice consumes a distributed cache that supports its simple, key-value data store.</span></span>
- <span data-ttu-id="e63b8-137">Le microservice de commande consomme à la fois une base de données de documents NoSql pour les opérations d’écriture ainsi qu’un magasin de clés/valeur hautement dénormalisé pour accueillir des volumes élevés d’opérations de lecture.</span><span class="sxs-lookup"><span data-stu-id="e63b8-137">The ordering microservice consumes both a NoSql document database for write operations along with a highly denormalized key/value store to accommodate high-volumes of read operations.</span></span>
  
<span data-ttu-id="e63b8-138">Bien que les bases de données relationnelles demeurent pertinentes pour les microservices avec des données complexes, les bases de données NoSQL ont gagné en popularité.</span><span class="sxs-lookup"><span data-stu-id="e63b8-138">While relational databases remain relevant for microservices with complex data, NoSQL databases have gained considerable popularity.</span></span> <span data-ttu-id="e63b8-139">Ils fournissent une grande échelle et une grande disponibilité.</span><span class="sxs-lookup"><span data-stu-id="e63b8-139">They provide massive scale and high availability.</span></span> <span data-ttu-id="e63b8-140">Leur nature sans schéma permet aux développeurs de s’éloigner d’une architecture de classes de données typées et de OUM qui rendent le changement coûteux et long.</span><span class="sxs-lookup"><span data-stu-id="e63b8-140">Their schemaless nature allows developers to move away from an architecture of typed data classes and ORMs that make change expensive and time-consuming.</span></span> <span data-ttu-id="e63b8-141">Nous couvrons les bases de données NoSQL plus tard dans ce chapitre.</span><span class="sxs-lookup"><span data-stu-id="e63b8-141">We cover NoSQL databases later in this chapter.</span></span>

 <span data-ttu-id="e63b8-142">Bien que l’encapsulation des données en microservices distincts puisse accroître l’agilité, les performances et l’évolutivité, elles présentent également de nombreux défis.</span><span class="sxs-lookup"><span data-stu-id="e63b8-142">While encapsulating  data into separate microservices can increase agility, performance, and scalability, it also presents many challenges.</span></span> <span data-ttu-id="e63b8-143">Dans la section suivante, nous discutons de ces défis ainsi que des modèles et des pratiques pour aider à les surmonter.</span><span class="sxs-lookup"><span data-stu-id="e63b8-143">In the next section, we discuss these challenges along with patterns and practices to help overcome them.</span></span>  

## <a name="cross-service-queries"></a><span data-ttu-id="e63b8-144">Requêtes inter-services</span><span class="sxs-lookup"><span data-stu-id="e63b8-144">Cross-service queries</span></span>

<span data-ttu-id="e63b8-145">Bien que les microservices soient indépendants et se concentrent sur des capacités fonctionnelles spécifiques, comme l’inventaire, l’expédition ou la commande, ils nécessitent souvent une intégration avec d’autres microservices.</span><span class="sxs-lookup"><span data-stu-id="e63b8-145">While microservices are independent and focus on specific functional capabilities, like inventory, shipping, or ordering, they frequently require integration with other microservices.</span></span> <span data-ttu-id="e63b8-146">Souvent, l’intégration implique un microservice *interrogeant* un autre pour les données.</span><span class="sxs-lookup"><span data-stu-id="e63b8-146">Often the integration involves one microservice *querying* another for data.</span></span> <span data-ttu-id="e63b8-147">La figure 5-3 montre le scénario.</span><span class="sxs-lookup"><span data-stu-id="e63b8-147">Figure 5-3 shows the scenario.</span></span>

![Interroger les microservices](./media/cross-service-query.png)

<span data-ttu-id="e63b8-149">**Figure 5-3**.</span><span class="sxs-lookup"><span data-stu-id="e63b8-149">**Figure 5-3**.</span></span> <span data-ttu-id="e63b8-150">Interroger les microservices</span><span class="sxs-lookup"><span data-stu-id="e63b8-150">Querying across microservices</span></span>

<span data-ttu-id="e63b8-151">Dans le chiffre précédent, nous voyons un microservice de panier d’achat qui ajoute un article au panier d’un utilisateur.</span><span class="sxs-lookup"><span data-stu-id="e63b8-151">In the preceding figure, we see a shopping basket microservice that adds an item to a user's shopping basket.</span></span> <span data-ttu-id="e63b8-152">Bien que le magasin de données pour ce microservice contienne des données sur les paniers et les éléments de ligne, il ne conserve pas les données sur les produits ou les prix.</span><span class="sxs-lookup"><span data-stu-id="e63b8-152">While the data store for this microservice contains basket and line item data, it doesn't maintain product or pricing data.</span></span> <span data-ttu-id="e63b8-153">Au lieu de cela, ces éléments de données sont la propriété du catalogue et des microservices de prix.</span><span class="sxs-lookup"><span data-stu-id="e63b8-153">Instead, those data items are owned by the catalog and pricing microservices.</span></span> <span data-ttu-id="e63b8-154">Cela pose un problème.</span><span class="sxs-lookup"><span data-stu-id="e63b8-154">This presents a problem.</span></span> <span data-ttu-id="e63b8-155">Comment le microservice du panier d’achat peut-il ajouter un produit au panier d’achat de l’utilisateur lorsqu’il n’a pas de produit ni de données de tarification dans sa base de données ?</span><span class="sxs-lookup"><span data-stu-id="e63b8-155">How can the shopping basket microservice add a product to the user's shopping basket when it doesn't have product nor pricing data in its database?</span></span>

<span data-ttu-id="e63b8-156">Une option discutée dans le chapitre 4 est un [appel HTTP direct](service-to-service-communication.md#queries) du panier d’achat au catalogue et aux microservices de tarification.</span><span class="sxs-lookup"><span data-stu-id="e63b8-156">One option discussed in Chapter 4 is a [direct HTTP call](service-to-service-communication.md#queries) from the shopping basket to the catalog and pricing microservices.</span></span> <span data-ttu-id="e63b8-157">Cependant, dans le chapitre 4, nous avons dit synchrone HTTP appelle les microservices *couples* ensemble, réduisant leur autonomie et diminuant leurs avantages architecturaux.</span><span class="sxs-lookup"><span data-stu-id="e63b8-157">However, in chapter 4, we said synchronous HTTP calls *couple* microservices together, reducing their autonomy and diminishing their architectural benefits.</span></span>

<span data-ttu-id="e63b8-158">Nous pourrions également mettre en œuvre un modèle de demande-réponse avec des files d’attente à l’arrivée et à l’étranger séparées pour chaque service.</span><span class="sxs-lookup"><span data-stu-id="e63b8-158">We could also implement a request-reply pattern with separate inbound and outbound queues for each service.</span></span> <span data-ttu-id="e63b8-159">Cependant, ce modèle est compliqué et exige la plomberie pour corréler les messages de demande et de réponse.</span><span class="sxs-lookup"><span data-stu-id="e63b8-159">However, this pattern is complicated and requires plumbing to correlate request and response messages.</span></span>
<span data-ttu-id="e63b8-160">Bien qu’il ne découpler les appels de microservice backend, le service d’appel doit toujours attendre avec synchronité pour l’appel à remplir.</span><span class="sxs-lookup"><span data-stu-id="e63b8-160">While it does decouple the backend microservice calls, the calling service must still synchronously wait for the call to complete.</span></span> <span data-ttu-id="e63b8-161">La congestion du réseau, les défauts transitoires ou un microservice surchargé peuvent entraîner des opérations de longue durée et même défectueuses.</span><span class="sxs-lookup"><span data-stu-id="e63b8-161">Network congestion, transient faults, or an overloaded microservice and can result in long-running and even failed operations.</span></span>

<span data-ttu-id="e63b8-162">Au lieu de cela, un modèle largement accepté pour supprimer les dépendances inter-services est le [modèle de vue matérialisé](https://docs.microsoft.com/azure/architecture/patterns/materialized-view), indiqué dans la figure 5-4.</span><span class="sxs-lookup"><span data-stu-id="e63b8-162">Instead, a widely accepted pattern for removing cross-service dependencies is the [Materialized View Pattern](https://docs.microsoft.com/azure/architecture/patterns/materialized-view), shown in Figure 5-4.</span></span>

![Modèle de vue matérialisé](./media/materialized-view-pattern.png)

<span data-ttu-id="e63b8-164">**Figure 5-4**.</span><span class="sxs-lookup"><span data-stu-id="e63b8-164">**Figure 5-4**.</span></span> <span data-ttu-id="e63b8-165">Modèle de vue matérialisé</span><span class="sxs-lookup"><span data-stu-id="e63b8-165">Materialized View Pattern</span></span>

<span data-ttu-id="e63b8-166">Avec ce modèle, vous placez une table de données locale (connue sous le nom de *modèle de lecture*) dans le service de panier d’achat.</span><span class="sxs-lookup"><span data-stu-id="e63b8-166">With this pattern, you place a local data table (known as a *read model*) in the shopping basket service.</span></span> <span data-ttu-id="e63b8-167">Ce tableau contient une copie dénormalisée des données nécessaires à partir des microservices du produit et des prix.</span><span class="sxs-lookup"><span data-stu-id="e63b8-167">This table contains a denormalized copy of the data needed from the product and pricing microservices.</span></span> <span data-ttu-id="e63b8-168">Copier les données directement dans le microservice du panier d’achat élimine le besoin d’appels interservices coûteux.</span><span class="sxs-lookup"><span data-stu-id="e63b8-168">Copying the data directly into the shopping basket microservice eliminates the need for expensive cross-service calls.</span></span> <span data-ttu-id="e63b8-169">Avec les données locales au service, vous améliorez le temps de réponse et la fiabilité du service.</span><span class="sxs-lookup"><span data-stu-id="e63b8-169">With the data local to the service, you improve the service's response time and reliability.</span></span> <span data-ttu-id="e63b8-170">En outre, avoir sa propre copie des données rend le service de panier d’achat plus résilient.</span><span class="sxs-lookup"><span data-stu-id="e63b8-170">Additionally, having its own copy of the data makes the shopping basket service more resilient.</span></span> <span data-ttu-id="e63b8-171">Si le service de catalogue devenait indisponible, il n’aurait pas d’impact direct sur le service de paniers d’achat.</span><span class="sxs-lookup"><span data-stu-id="e63b8-171">If the catalog service should become unavailable, it wouldn't directly impact the shopping basket service.</span></span> <span data-ttu-id="e63b8-172">Le panier d’achat peut continuer à fonctionner avec les données de son propre magasin.</span><span class="sxs-lookup"><span data-stu-id="e63b8-172">The shopping basket can continue operating with the data from its own store.</span></span>

<span data-ttu-id="e63b8-173">Le hic avec cette approche est que vous avez maintenant des données en double dans votre système.</span><span class="sxs-lookup"><span data-stu-id="e63b8-173">The catch with this approach is that you now have duplicate data in your system.</span></span> <span data-ttu-id="e63b8-174">Cependant, le dupliquer *stratégiquement* les données dans les systèmes cloud-autochtones est une pratique établie et non considérée comme un anti-modèle, ou une mauvaise pratique.</span><span class="sxs-lookup"><span data-stu-id="e63b8-174">However, *strategically* duplicating data in cloud-native systems is an established practice and not considered an anti-pattern, or bad practice.</span></span> <span data-ttu-id="e63b8-175">Gardez à *l’esprit qu’un seul et unique service* peut posséder un ensemble de données et avoir autorité sur celui-ci.</span><span class="sxs-lookup"><span data-stu-id="e63b8-175">Keep in mind that *one and only one service* can own a data set and have authority over it.</span></span> <span data-ttu-id="e63b8-176">Vous devrez synchroniser les modèles de lecture lorsque le système d’enregistrement est mis à jour.</span><span class="sxs-lookup"><span data-stu-id="e63b8-176">You'll need to synchronize the read models when the system of record is updated.</span></span> <span data-ttu-id="e63b8-177">La synchronisation est généralement implémentée par messagerie asynchrone avec un [modèle de publication/abonné,](service-to-service-communication.md#events)comme le montre la figure 5.4.</span><span class="sxs-lookup"><span data-stu-id="e63b8-177">Synchronization is typically implemented via asynchronous messaging with a [publish/subscribe pattern](service-to-service-communication.md#events), as shown in Figure 5.4.</span></span>

## <a name="distributed-transactions"></a><span data-ttu-id="e63b8-178">Transactions distribuées</span><span class="sxs-lookup"><span data-stu-id="e63b8-178">Distributed transactions</span></span>

<span data-ttu-id="e63b8-179">Bien qu’il soit difficile de interroger des données dans les microservices, la mise en œuvre d’une transaction dans plusieurs microservices est encore plus complexe.</span><span class="sxs-lookup"><span data-stu-id="e63b8-179">While querying data across microservices is difficult, implementing a transaction across several microservices is even more complex.</span></span> <span data-ttu-id="e63b8-180">Le défi inhérent au maintien de la cohérence des données entre les sources de données indépendantes dans différents microservices ne peut être sous-estimé.</span><span class="sxs-lookup"><span data-stu-id="e63b8-180">The inherent challenge of maintaining data consistency across independent data sources in different microservices can't be understated.</span></span> <span data-ttu-id="e63b8-181">L’absence de transactions distribuées dans les applications cloud-native signifie que vous devez gérer les transactions distribuées de manière programmatique.</span><span class="sxs-lookup"><span data-stu-id="e63b8-181">The lack of distributed transactions in cloud-native applications means that you must manage distributed transactions programmatically.</span></span> <span data-ttu-id="e63b8-182">Vous passez d’un monde de *cohérence immédiate* à celui de *la cohérence éventuelle.*</span><span class="sxs-lookup"><span data-stu-id="e63b8-182">You move from a world of *immediate consistency* to that of *eventual consistency*.</span></span>

<span data-ttu-id="e63b8-183">La figure 5-5 montre le problème.</span><span class="sxs-lookup"><span data-stu-id="e63b8-183">Figure 5-5 shows the problem.</span></span>

![Transaction en saga](./media/saga-transaction-operation.png)

<span data-ttu-id="e63b8-185">**Figure 5-5**.</span><span class="sxs-lookup"><span data-stu-id="e63b8-185">**Figure 5-5**.</span></span> <span data-ttu-id="e63b8-186">Mise en œuvre d’une transaction entre microservices</span><span class="sxs-lookup"><span data-stu-id="e63b8-186">Implementing a transaction across microservices</span></span>

<span data-ttu-id="e63b8-187">Dans le chiffre précédent, cinq microservices indépendants participent à une transaction distribuée qui crée une commande.</span><span class="sxs-lookup"><span data-stu-id="e63b8-187">In the preceding figure, five independent microservices participate in a distributed transaction that creates an order.</span></span> <span data-ttu-id="e63b8-188">Chaque microservice tient son propre magasin de données et met en œuvre une transaction locale pour son magasin.</span><span class="sxs-lookup"><span data-stu-id="e63b8-188">Each microservice maintains its own data store and implements a local transaction for its store.</span></span> <span data-ttu-id="e63b8-189">Pour créer l’ordre, la transaction locale pour *chaque* microservice individuel doit réussir, ou *tous* doivent interrompre et annuler l’opération.</span><span class="sxs-lookup"><span data-stu-id="e63b8-189">To create the order, the local transaction for *each* individual microservice must succeed, or *all* must abort and roll back the operation.</span></span> <span data-ttu-id="e63b8-190">Bien que le support transactionnel intégré soit disponible à l’intérieur de chacun des microservices, il n’y a aucun support pour une transaction distribuée qui s’étendrait sur les cinq services pour maintenir les données cohérentes.</span><span class="sxs-lookup"><span data-stu-id="e63b8-190">While built-in transactional support is available inside each of the microservices, there's no support for a distributed transaction that would span across all five services to keep data consistent.</span></span>

<span data-ttu-id="e63b8-191">Au lieu de cela, vous devez construire cette transaction distribuée *programmatiquement*.</span><span class="sxs-lookup"><span data-stu-id="e63b8-191">Instead, you must construct this distributed transaction *programmatically*.</span></span>

<span data-ttu-id="e63b8-192">Un modèle populaire pour ajouter le support transactionnel distribué est le modèle Saga.</span><span class="sxs-lookup"><span data-stu-id="e63b8-192">A popular pattern for adding distributed transactional support is the Saga pattern.</span></span> <span data-ttu-id="e63b8-193">Il est mis en œuvre en groupant les transactions locales ensemble programmatiquement et séquentiellement invoquant chacune d’elles.</span><span class="sxs-lookup"><span data-stu-id="e63b8-193">It's implemented by grouping local transactions together programmatically and sequentially invoking each one.</span></span> <span data-ttu-id="e63b8-194">Si l’une des transactions locales échoue, la Saga annule l’opération et invoque un ensemble de [transactions compensatoires](https://docs.microsoft.com/azure/architecture/patterns/compensating-transaction).</span><span class="sxs-lookup"><span data-stu-id="e63b8-194">If any of the local transactions fail, the Saga aborts the operation and invokes a set of [compensating transactions](https://docs.microsoft.com/azure/architecture/patterns/compensating-transaction).</span></span> <span data-ttu-id="e63b8-195">Les transactions compensatoires annulent les modifications apportées par les transactions locales précédentes et rétablissent l’uniformité des données.</span><span class="sxs-lookup"><span data-stu-id="e63b8-195">The compensating transactions undo the changes made by the preceding local transactions and restore data consistency.</span></span> <span data-ttu-id="e63b8-196">La figure 5-6 montre une transaction ratée avec le modèle Saga.</span><span class="sxs-lookup"><span data-stu-id="e63b8-196">Figure 5-6 shows a failed transaction with the Saga pattern.</span></span>

![Retour en arrière dans le modèle de saga](./media/saga-rollback-operation.png)

<span data-ttu-id="e63b8-198">**Figure 5-6**.</span><span class="sxs-lookup"><span data-stu-id="e63b8-198">**Figure 5-6**.</span></span> <span data-ttu-id="e63b8-199">Restauration d’une transaction</span><span class="sxs-lookup"><span data-stu-id="e63b8-199">Rolling back a transaction</span></span>

<span data-ttu-id="e63b8-200">Dans le chiffre précédent, l’opération *d’inventaire de mise à jour* a échoué dans le microservice d’inventaire.</span><span class="sxs-lookup"><span data-stu-id="e63b8-200">In the previous figure, the *Update Inventory* operation has failed in the Inventory microservice.</span></span> <span data-ttu-id="e63b8-201">La Saga invoque un ensemble de transactions compensatoires (en rouge) pour ajuster le nombre d’inventaires, annuler le paiement et la commande, et renvoyer les données pour chaque microservice à un état cohérent.</span><span class="sxs-lookup"><span data-stu-id="e63b8-201">The Saga invokes a set of compensating transactions (in red) to adjust the inventory counts, cancel the payment and the order, and return the data for each microservice back to a consistent state.</span></span>

<span data-ttu-id="e63b8-202">Les motifs de saga sont généralement chorégraphiés comme une série d’événements connexes, ou orchestrés comme un ensemble de commandes connexes.</span><span class="sxs-lookup"><span data-stu-id="e63b8-202">Saga patterns are typically choreographed as a series of related events, or orchestrated as a set of related commands.</span></span> <span data-ttu-id="e63b8-203">Dans le chapitre 4, nous avons discuté du modèle d’agrégateur de services qui serait à la base d’une mise en œuvre orchestrée de saga.</span><span class="sxs-lookup"><span data-stu-id="e63b8-203">In Chapter 4, we discussed the service aggregator pattern that would be the foundation for an orchestrated saga implementation.</span></span> <span data-ttu-id="e63b8-204">Nous avons également discuté de l’événementiel avec Azure Service Bus et Azure Event Grid sujets qui serait une base pour une mise en œuvre de saga chorégraphiée.</span><span class="sxs-lookup"><span data-stu-id="e63b8-204">We also discussed eventing along with Azure Service Bus and Azure Event Grid topics that would be a foundation for a choreographed saga implementation.</span></span>

## <a name="high-volume-data"></a><span data-ttu-id="e63b8-205">Données à volume élevé</span><span class="sxs-lookup"><span data-stu-id="e63b8-205">High volume data</span></span>

<span data-ttu-id="e63b8-206">Les grandes applications cloud-native prennent souvent en charge les besoins de données à volume élevé.</span><span class="sxs-lookup"><span data-stu-id="e63b8-206">Large cloud-native applications often support high-volume data requirements.</span></span> <span data-ttu-id="e63b8-207">Dans ces scénarios, les techniques traditionnelles de stockage de données peuvent causer des goulots d’étranglement.</span><span class="sxs-lookup"><span data-stu-id="e63b8-207">In these scenarios, traditional data storage techniques can cause bottlenecks.</span></span> <span data-ttu-id="e63b8-208">Pour les systèmes complexes qui se déploient à grande échelle, la ségrégation des responsabilités de commandement et de requête (CQRS) et l’approvisionnement en événements peuvent améliorer le rendement de l’application.</span><span class="sxs-lookup"><span data-stu-id="e63b8-208">For complex systems that deploy on a large scale, both Command and Query Responsibility Segregation (CQRS) and Event Sourcing may improve application performance.</span></span>  

### <a name="cqrs"></a><span data-ttu-id="e63b8-209">CQRS</span><span class="sxs-lookup"><span data-stu-id="e63b8-209">CQRS</span></span>

<span data-ttu-id="e63b8-210">[CQRS](https://docs.microsoft.com/azure/architecture/patterns/cqrs), est un modèle architectural qui peut aider à maximiser les performances, l’évolutivité et la sécurité.</span><span class="sxs-lookup"><span data-stu-id="e63b8-210">[CQRS](https://docs.microsoft.com/azure/architecture/patterns/cqrs), is an architectural pattern that can help maximize performance, scalability, and security.</span></span> <span data-ttu-id="e63b8-211">Le modèle sépare les opérations qui lisent les données des opérations qui rédigent des données.</span><span class="sxs-lookup"><span data-stu-id="e63b8-211">The pattern separates operations that read data from those operations that write data.</span></span>

<span data-ttu-id="e63b8-212">Pour les scénarios normaux, le même modèle d’entité et l’objet de dépôt de données sont utilisés pour *les* opérations de lecture et d’écriture.</span><span class="sxs-lookup"><span data-stu-id="e63b8-212">For normal scenarios, the same entity model and data repository object are used for *both* read and write operations.</span></span>

<span data-ttu-id="e63b8-213">Cependant, un scénario de données à volume élevé peut bénéficier de modèles distincts et de tableaux de données pour les lectures et les écrits.</span><span class="sxs-lookup"><span data-stu-id="e63b8-213">However, a high volume data scenario can benefit from separate models and data tables for reads and writes.</span></span> <span data-ttu-id="e63b8-214">Pour améliorer les performances, l’opération de lecture pourrait s’interroger contre une représentation très dénormalisée des données afin d’éviter les jointures de table répétitives coûteuses et les serrures de table.</span><span class="sxs-lookup"><span data-stu-id="e63b8-214">To improve performance, the read operation could query against a highly denormalized representation of the data to avoid expensive repetitive table joins and table locks.</span></span> <span data-ttu-id="e63b8-215">*L’opération d’écriture,* connue sous le nom de *commande,* serait mise à jour contre une représentation entièrement normalisée des données qui garantirait la cohérence.</span><span class="sxs-lookup"><span data-stu-id="e63b8-215">The *write* operation, known as a *command*, would update against a fully normalized representation of the data that would guarantee consistency.</span></span> <span data-ttu-id="e63b8-216">Vous devez ensuite mettre en œuvre un mécanisme pour synchroniser les deux représentations. Typiquement, chaque fois que le tableau d’écriture est modifié, il publie un événement qui reproduit la modification à la table de lecture.</span><span class="sxs-lookup"><span data-stu-id="e63b8-216">You then need to implement a mechanism to keep both representations in sync. Typically, whenever the write table is modified, it publishes an event that replicates the modification to the read table.</span></span>

<span data-ttu-id="e63b8-217">La figure 5-7 montre une mise en œuvre du modèle CQRS.</span><span class="sxs-lookup"><span data-stu-id="e63b8-217">Figure 5-7 shows an implementation of the CQRS pattern.</span></span>

![Ségrégation de responsabilité de commandement et de requête](./media/cqrs-implementation.png)

<span data-ttu-id="e63b8-219">**Figure 5-7**.</span><span class="sxs-lookup"><span data-stu-id="e63b8-219">**Figure 5-7**.</span></span> <span data-ttu-id="e63b8-220">Mise en œuvre du CQRS</span><span class="sxs-lookup"><span data-stu-id="e63b8-220">CQRS implementation</span></span>

<span data-ttu-id="e63b8-221">Dans la figure précédente, des modèles distincts de commande et de requête sont implémenté.</span><span class="sxs-lookup"><span data-stu-id="e63b8-221">In the previous figure, separate command and query models are implemented.</span></span> <span data-ttu-id="e63b8-222">Chaque opération d’écriture de données est enregistrée dans le magasin d’écriture, puis propagée au magasin de lecture.</span><span class="sxs-lookup"><span data-stu-id="e63b8-222">Each data write operation is saved to the write store and then propagated to the read store.</span></span> <span data-ttu-id="e63b8-223">Portez une attention particulière à la façon dont le processus de propagation des données fonctionne sur le principe de [cohérence éventuelle](http://www.cloudcomputingpatterns.org/eventual_consistency/).</span><span class="sxs-lookup"><span data-stu-id="e63b8-223">Pay close attention to how the data propagation process operates on the principle of [eventual consistency](http://www.cloudcomputingpatterns.org/eventual_consistency/).</span></span> <span data-ttu-id="e63b8-224">Le modèle de lecture finit par se synchroniser avec le modèle d’écriture, mais il peut y avoir un certain décalage dans le processus.</span><span class="sxs-lookup"><span data-stu-id="e63b8-224">The read model eventually synchronizes with the write model, but there may be some lag in the process.</span></span> <span data-ttu-id="e63b8-225">Nous discutons de la cohérence éventuelle dans la section suivante.</span><span class="sxs-lookup"><span data-stu-id="e63b8-225">We discuss eventual consistency in the next section.</span></span>

<span data-ttu-id="e63b8-226">Cette séparation permet de lire et d’écrire à l’échelle indépendamment.</span><span class="sxs-lookup"><span data-stu-id="e63b8-226">This separation enables reads and writes to scale independently.</span></span> <span data-ttu-id="e63b8-227">Lire les opérations utilisent un schéma optimisé pour les requêtes, tandis que les écrits utilisent un schéma optimisé pour les mises à jour.</span><span class="sxs-lookup"><span data-stu-id="e63b8-227">Read operations use a schema optimized for queries, while the writes use a schema optimized for updates.</span></span> <span data-ttu-id="e63b8-228">Lire les requêtes vont à l’encontre des données dénormalisées, tandis que la logique commerciale complexe peut être appliquée au modèle d’écriture.</span><span class="sxs-lookup"><span data-stu-id="e63b8-228">Read queries go against denormalized data, while complex business logic can be applied to the write model.</span></span> <span data-ttu-id="e63b8-229">En outre, vous pourriez imposer une sécurité plus stricte sur les opérations d’écriture que ceux exposant des lectures.</span><span class="sxs-lookup"><span data-stu-id="e63b8-229">As well, you might impose tighter security on write operations than those exposing reads.</span></span>

<span data-ttu-id="e63b8-230">La mise en œuvre de CQRS peut améliorer les performances d’application pour les services cloud-natives.</span><span class="sxs-lookup"><span data-stu-id="e63b8-230">Implementing CQRS can improve application performance for cloud-native services.</span></span> <span data-ttu-id="e63b8-231">Cependant, il en résulte une conception plus complexe.</span><span class="sxs-lookup"><span data-stu-id="e63b8-231">However, it does result in a more complex design.</span></span> <span data-ttu-id="e63b8-232">Appliquez ce principe avec soin et stratégiquement aux sections de votre application cloud-native qui en bénéficieront.</span><span class="sxs-lookup"><span data-stu-id="e63b8-232">Apply this principle carefully and strategically to those sections of your cloud-native application that will benefit from it.</span></span> <span data-ttu-id="e63b8-233">Pour en savoir plus sur CQRS, voir le livre de Microsoft [.NET Microservices: Architecture for Containerized .NET Applications](https://docs.microsoft.com/dotnet/architecture/microservices/microservice-ddd-cqrs-patterns/apply-simplified-microservice-cqrs-ddd-patterns).</span><span class="sxs-lookup"><span data-stu-id="e63b8-233">For more on CQRS, see the Microsoft book [.NET Microservices: Architecture for Containerized .NET Applications](https://docs.microsoft.com/dotnet/architecture/microservices/microservice-ddd-cqrs-patterns/apply-simplified-microservice-cqrs-ddd-patterns).</span></span>

### <a name="event-sourcing"></a><span data-ttu-id="e63b8-234">Sourcing d’événements</span><span class="sxs-lookup"><span data-stu-id="e63b8-234">Event sourcing</span></span>

<span data-ttu-id="e63b8-235">Une autre approche pour optimiser les scénarios de données à volume élevé implique [Event Sourcing](https://docs.microsoft.com/azure/architecture/patterns/event-sourcing).</span><span class="sxs-lookup"><span data-stu-id="e63b8-235">Another approach to optimizing high volume data scenarios involves [Event Sourcing](https://docs.microsoft.com/azure/architecture/patterns/event-sourcing).</span></span>

<span data-ttu-id="e63b8-236">Un système stocke généralement l’état actuel d’une entité de données.</span><span class="sxs-lookup"><span data-stu-id="e63b8-236">A system typically stores the current state of a data entity.</span></span> <span data-ttu-id="e63b8-237">Si un utilisateur modifie son numéro de téléphone, par exemple, l’enregistrement du client est mis à jour avec le nouveau numéro.</span><span class="sxs-lookup"><span data-stu-id="e63b8-237">If a user changes their phone number, for example, the customer record is updated with the new number.</span></span> <span data-ttu-id="e63b8-238">Nous connaissons toujours l’état actuel d’une entité de données, mais chaque mise à jour surcrit l’état précédent.</span><span class="sxs-lookup"><span data-stu-id="e63b8-238">We always know the current state of a data entity, but each update overwrites the previous state.</span></span>

<span data-ttu-id="e63b8-239">Dans la plupart des cas, ce modèle fonctionne très bien.</span><span class="sxs-lookup"><span data-stu-id="e63b8-239">In most cases, this model works fine.</span></span> <span data-ttu-id="e63b8-240">Dans les systèmes à volume élevé, cependant, les frais généraux provenant des opérations de verrouillage transactionnel et de mise à jour fréquentes peuvent avoir une incidence sur les performances, la réactivité et la limite de l’évolutivité dans les bases de données.</span><span class="sxs-lookup"><span data-stu-id="e63b8-240">In high volume systems, however, overhead from transactional locking and frequent update operations can impact database performance, responsiveness, and limit scalability.</span></span>

<span data-ttu-id="e63b8-241">Event Sourcing adopte une approche différente pour la saisie des données.</span><span class="sxs-lookup"><span data-stu-id="e63b8-241">Event Sourcing takes a different approach to capturing data.</span></span> <span data-ttu-id="e63b8-242">Chaque opération qui affecte les données est persistée dans un magasin d’événements.</span><span class="sxs-lookup"><span data-stu-id="e63b8-242">Each operation that affects data is persisted to an event store.</span></span> <span data-ttu-id="e63b8-243">Au lieu de mettre à jour l’état d’un dossier de données, nous appendicons chaque modification à une liste séquentielle d’événements passés - semblable au registre d’un comptable.</span><span class="sxs-lookup"><span data-stu-id="e63b8-243">Instead of updating the state of a data record, we append each change to a sequential list of past events - similar to an accountant's ledger.</span></span> <span data-ttu-id="e63b8-244">Le Magasin d’événements devient le système d’enregistrement des données.</span><span class="sxs-lookup"><span data-stu-id="e63b8-244">The Event Store becomes the system of record for the data.</span></span> <span data-ttu-id="e63b8-245">Il est utilisé pour propager diverses vues matérialisées dans le contexte délimité d’un microservice.</span><span class="sxs-lookup"><span data-stu-id="e63b8-245">It's used to propagate various materialized views within the bounded context of a microservice.</span></span> <span data-ttu-id="e63b8-246">La figure 5.8 montre le modèle.</span><span class="sxs-lookup"><span data-stu-id="e63b8-246">Figure 5.8 shows the pattern.</span></span>

![Approvisionnement en événements](./media/event-sourcing.png)

<span data-ttu-id="e63b8-248">**Figure 5-8**.</span><span class="sxs-lookup"><span data-stu-id="e63b8-248">**Figure 5-8**.</span></span> <span data-ttu-id="e63b8-249">Approvisionnement en événements</span><span class="sxs-lookup"><span data-stu-id="e63b8-249">Event Sourcing</span></span>

<span data-ttu-id="e63b8-250">Dans le chiffre précédent, notez comment chaque entrée (en bleu) pour le panier d’achat d’un utilisateur est annexée à un magasin d’événements sous-jacent.</span><span class="sxs-lookup"><span data-stu-id="e63b8-250">In the previous figure, note how each entry (in blue) for a user's shopping cart is appended to an underlying event store.</span></span> <span data-ttu-id="e63b8-251">Dans la vue matérialisée adjacente, le système projette l’état actuel en rejouant tous les événements associés à chaque panier.</span><span class="sxs-lookup"><span data-stu-id="e63b8-251">In the adjoining materialized view, the system projects the current state by replaying all the events associated with each shopping cart.</span></span> <span data-ttu-id="e63b8-252">Cette vue, ou modèle de lecture, est ensuite exposée à l’interface utilisateur.</span><span class="sxs-lookup"><span data-stu-id="e63b8-252">This view, or read model, is then exposed back to the UI.</span></span> <span data-ttu-id="e63b8-253">Les événements peuvent également être intégrés avec des systèmes et des applications externes ou interrogés pour déterminer l’état actuel d’une entité.</span><span class="sxs-lookup"><span data-stu-id="e63b8-253">Events can also be integrated with external systems and applications or queried to determine the current state of an entity.</span></span> <span data-ttu-id="e63b8-254">Avec cette approche, vous maintenez l’histoire.</span><span class="sxs-lookup"><span data-stu-id="e63b8-254">With this approach, you maintain history.</span></span> <span data-ttu-id="e63b8-255">Vous savez non seulement l’état actuel d’une entité, mais aussi comment vous avez atteint cet état.</span><span class="sxs-lookup"><span data-stu-id="e63b8-255">You know not only the current state of an entity, but also how you reached this state.</span></span>

<span data-ttu-id="e63b8-256">Mécaniquement parlant, l’approvisionnement en événements simplifie le modèle d’écriture.</span><span class="sxs-lookup"><span data-stu-id="e63b8-256">Mechanically speaking, event sourcing simplifies the write model.</span></span> <span data-ttu-id="e63b8-257">Il n’y a pas de mises à jour ou de suppressions.</span><span class="sxs-lookup"><span data-stu-id="e63b8-257">There are no updates or deletes.</span></span> <span data-ttu-id="e63b8-258">L’absorption de chaque saisie de données comme un événement immuable minimise les conflits de contention, de verrouillage et de concurrence associés aux bases de données relationnelles.</span><span class="sxs-lookup"><span data-stu-id="e63b8-258">Appending each data entry as an immutable event minimizes contention, locking, and concurrency conflicts associated with relational databases.</span></span> <span data-ttu-id="e63b8-259">Construire des modèles de lecture avec le modèle de vue matérialisé vous permet de découpler la vue du modèle d’écriture et de choisir le meilleur magasin de données pour optimiser les besoins de votre interface utilisateur d’application.</span><span class="sxs-lookup"><span data-stu-id="e63b8-259">Building read models with the materialized view pattern enables you to decouple the view from the write model and choose the best data store to optimize the needs of your application UI.</span></span>

<span data-ttu-id="e63b8-260">Pour ce modèle, envisagez un magasin de données qui prend directement en charge l’approvisionnement en événements.</span><span class="sxs-lookup"><span data-stu-id="e63b8-260">For this pattern, consider a data store that directly supports event sourcing.</span></span> <span data-ttu-id="e63b8-261">Azure Cosmos DB, MongoDB, Cassandra, CouchDB et RavenDB sont de bons candidats.</span><span class="sxs-lookup"><span data-stu-id="e63b8-261">Azure Cosmos DB, MongoDB, Cassandra, CouchDB, and RavenDB are good candidates.</span></span>

<span data-ttu-id="e63b8-262">Comme pour tous les modèles et toutes les technologies, implémenter stratégiquement et en cas de besoin.</span><span class="sxs-lookup"><span data-stu-id="e63b8-262">As with all patterns and technologies, implement strategically and when needed.</span></span> <span data-ttu-id="e63b8-263">Bien que l’approvisionnement en événements puisse offrir une performance et une évolutivité accrues, il se fait au détriment de la complexité et d’une courbe d’apprentissage.</span><span class="sxs-lookup"><span data-stu-id="e63b8-263">While event sourcing can provide increased performance and scalability, it comes at the expense of complexity and a learning curve.</span></span>

>[!div class="step-by-step"]
><span data-ttu-id="e63b8-264">[Suivant précédent](service-mesh-communication-infrastructure.md)
>[Next](relational-vs-nosql-data.md)</span><span class="sxs-lookup"><span data-stu-id="e63b8-264">[Previous](service-mesh-communication-infrastructure.md)
[Next](relational-vs-nosql-data.md)</span></span>
