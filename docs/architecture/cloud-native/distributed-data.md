---
title: Données distribuées
description: Le contraste du stockage des données dans les applications monolithiques et Cloud natives.
author: robvet
ms.date: 05/13/2020
ms.openlocfilehash: 2eff37dcc57ae39daac0ba10d10322be5eb4e321
ms.sourcegitcommit: 27db07ffb26f76912feefba7b884313547410db5
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 05/19/2020
ms.locfileid: "83614134"
---
# <a name="distributed-data"></a><span data-ttu-id="9749a-103">Données distribuées</span><span class="sxs-lookup"><span data-stu-id="9749a-103">Distributed data</span></span>

<span data-ttu-id="9749a-104">Comme nous l’avons vu dans ce livre, une approche Cloud-Native change la façon dont vous concevez, déployez et gérez les applications.</span><span class="sxs-lookup"><span data-stu-id="9749a-104">As we've seen throughout this book, a cloud-native approach changes the way you design, deploy, and manage applications.</span></span> <span data-ttu-id="9749a-105">Il modifie également la façon dont vous gérez et stockez les données.</span><span class="sxs-lookup"><span data-stu-id="9749a-105">It also changes the way you manage and store data.</span></span>

<span data-ttu-id="9749a-106">La figure 5-1 compare les différences.</span><span class="sxs-lookup"><span data-stu-id="9749a-106">Figure 5-1 contrasts the differences.</span></span>

![Stockage des données dans les applications natives du Cloud](./media/distributed-data.png)

<span data-ttu-id="9749a-108">**Figure 5-1**.</span><span class="sxs-lookup"><span data-stu-id="9749a-108">**Figure 5-1**.</span></span> <span data-ttu-id="9749a-109">Gestion des données dans les applications Cloud natives</span><span class="sxs-lookup"><span data-stu-id="9749a-109">Data management in cloud-native applications</span></span>

<span data-ttu-id="9749a-110">Les développeurs expérimentés reconnaîtront facilement l’architecture sur le côté gauche de la figure 5-1.</span><span class="sxs-lookup"><span data-stu-id="9749a-110">Experienced developers will easily recognize the architecture on the left-side of figure 5-1.</span></span> <span data-ttu-id="9749a-111">Dans cette *application monolithique*, les composants de service métier colocaliser ensemble dans un niveau de services partagés, en partageant des données à partir d’une base de données relationnelle unique.</span><span class="sxs-lookup"><span data-stu-id="9749a-111">In this *monolithic application*, business service components collocate together in a shared services tier, sharing data from a single relational database.</span></span>

<span data-ttu-id="9749a-112">À bien des égards, une seule base de données conserve la gestion des données simple.</span><span class="sxs-lookup"><span data-stu-id="9749a-112">In many ways, a single database keeps data management simple.</span></span> <span data-ttu-id="9749a-113">L’interrogation de données entre plusieurs tables est simple.</span><span class="sxs-lookup"><span data-stu-id="9749a-113">Querying data across multiple tables is straightforward.</span></span> <span data-ttu-id="9749a-114">Modifications apportées à la mise à jour des données ensemble ou restauration.</span><span class="sxs-lookup"><span data-stu-id="9749a-114">Changes to data update together or they all rollback.</span></span> <span data-ttu-id="9749a-115">Les [transactions ACID](https://docs.microsoft.com/windows/desktop/cossdk/acid-properties) garantissent une cohérence forte et immédiate.</span><span class="sxs-lookup"><span data-stu-id="9749a-115">[ACID transactions](https://docs.microsoft.com/windows/desktop/cossdk/acid-properties) guarantee strong and immediate consistency.</span></span>

<span data-ttu-id="9749a-116">En concevant pour le Cloud natif, nous prenons une approche différente.</span><span class="sxs-lookup"><span data-stu-id="9749a-116">Designing for cloud-native, we take a different approach.</span></span> <span data-ttu-id="9749a-117">Dans la partie droite de la figure 5-1, notez la manière dont les fonctionnalités métier sont séparées en microservices indépendants et petits.</span><span class="sxs-lookup"><span data-stu-id="9749a-117">On the right-side of Figure 5-1, note how business functionality segregates into small, independent microservices.</span></span> <span data-ttu-id="9749a-118">Chaque microservice encapsule une fonctionnalité métier spécifique et ses propres données.</span><span class="sxs-lookup"><span data-stu-id="9749a-118">Each microservice encapsulates a specific business capability and its own data.</span></span> <span data-ttu-id="9749a-119">La base de données monolithique est décomposée en un modèle de données distribué avec de nombreuses bases de données plus petites, chacune correspondant à un microservice.</span><span class="sxs-lookup"><span data-stu-id="9749a-119">The monolithic database decomposes into a distributed data model with many smaller databases, each aligning with a microservice.</span></span> <span data-ttu-id="9749a-120">Lorsque la fumée disparaît, nous avons découvert une conception qui expose une *base de données par Microservice*.</span><span class="sxs-lookup"><span data-stu-id="9749a-120">When the smoke clears, we emerge with a design that exposes a *database per microservice*.</span></span>

## <a name="database-per-microservice-why"></a><span data-ttu-id="9749a-121">Base de données par Microservice, pourquoi ?</span><span class="sxs-lookup"><span data-stu-id="9749a-121">Database-per-microservice, why?</span></span>

<span data-ttu-id="9749a-122">Cette base de données par Microservice offre de nombreux avantages, en particulier pour les systèmes qui doivent évoluer rapidement et prendre en charge une grande échelle.</span><span class="sxs-lookup"><span data-stu-id="9749a-122">This database per microservice provides many benefits, especially for systems that must evolve rapidly and support massive scale.</span></span> <span data-ttu-id="9749a-123">Avec ce modèle...</span><span class="sxs-lookup"><span data-stu-id="9749a-123">With this model...</span></span>

- <span data-ttu-id="9749a-124">Les données de domaine sont encapsulées dans le service</span><span class="sxs-lookup"><span data-stu-id="9749a-124">Domain data is encapsulated within the service</span></span>
- <span data-ttu-id="9749a-125">Le schéma de données peut évoluer sans affecter directement les autres services</span><span class="sxs-lookup"><span data-stu-id="9749a-125">Data schema can evolve without directly impacting other services</span></span>
- <span data-ttu-id="9749a-126">Chaque magasin de données peut être mis à l’échelle indépendamment</span><span class="sxs-lookup"><span data-stu-id="9749a-126">Each data store can independently scale</span></span>
- <span data-ttu-id="9749a-127">Une défaillance du magasin de données dans un service n’affecte pas directement les autres services</span><span class="sxs-lookup"><span data-stu-id="9749a-127">A data store failure in one service won't directly impact other services</span></span>

<span data-ttu-id="9749a-128">Le fait de séparer les données permet également à chaque microservice d’implémenter le type de magasin de données optimisé pour la charge de travail, les besoins de stockage et les modèles de lecture/écriture.</span><span class="sxs-lookup"><span data-stu-id="9749a-128">Segregating data also enables each microservice to implement the data store type that is best optimized for its workload, storage needs, and read/write patterns.</span></span> <span data-ttu-id="9749a-129">Les choix sont les suivants : relationnel, document, clé-valeur et même magasins de données basés sur les graphiques.</span><span class="sxs-lookup"><span data-stu-id="9749a-129">Choices include relational, document, key-value, and even graph-based data stores.</span></span>

<span data-ttu-id="9749a-130">La figure 5-2 présente le principe de la persistance polyglotte dans un système Cloud natif.</span><span class="sxs-lookup"><span data-stu-id="9749a-130">Figure 5-2 presents the principle of polyglot persistence in a cloud-native system.</span></span>

![Persistance des données polyglotte](./media/polyglot-data-persistence.png)

<span data-ttu-id="9749a-132">**Figure 5-2**.</span><span class="sxs-lookup"><span data-stu-id="9749a-132">**Figure 5-2**.</span></span> <span data-ttu-id="9749a-133">Persistance des données polyglotte</span><span class="sxs-lookup"><span data-stu-id="9749a-133">Polyglot data persistence</span></span>

<span data-ttu-id="9749a-134">Notez dans la figure précédente comment chaque microservice prend en charge un type de magasin de données différent.</span><span class="sxs-lookup"><span data-stu-id="9749a-134">Note in the previous figure how each microservice supports a different type of data store.</span></span>

- <span data-ttu-id="9749a-135">Le microservice de catalogue de produits consomme une base de données relationnelle pour s’adapter à la structure relationnelle enrichie de ses données sous-jacentes.</span><span class="sxs-lookup"><span data-stu-id="9749a-135">The product catalog microservice consumes a relational database to accommodate the rich relational structure of its underlying data.</span></span>
- <span data-ttu-id="9749a-136">Le microservice panier d’achat consomme un cache distribué qui prend en charge sa propre banque de données de clé-valeur.</span><span class="sxs-lookup"><span data-stu-id="9749a-136">The shopping cart microservice consumes a distributed cache that supports its simple, key-value data store.</span></span>
- <span data-ttu-id="9749a-137">Le microservice de commande consomme à la fois une base de données de documents NoSql pour les opérations d’écriture et un magasin de clés/valeurs très dénormalisé pour prendre en charge des volumes élevés d’opérations de lecture.</span><span class="sxs-lookup"><span data-stu-id="9749a-137">The ordering microservice consumes both a NoSql document database for write operations along with a highly denormalized key/value store to accommodate high-volumes of read operations.</span></span>
  
<span data-ttu-id="9749a-138">Si les bases de données relationnelles restent pertinentes pour les microservices avec des données complexes, les bases de données NoSQL ont gagné en popularité.</span><span class="sxs-lookup"><span data-stu-id="9749a-138">While relational databases remain relevant for microservices with complex data, NoSQL databases have gained considerable popularity.</span></span> <span data-ttu-id="9749a-139">Ils fournissent une mise à l’échelle et une haute disponibilité à grande échelle.</span><span class="sxs-lookup"><span data-stu-id="9749a-139">They provide massive scale and high availability.</span></span> <span data-ttu-id="9749a-140">Leur nature sans schéma permet aux développeurs de quitter une architecture de classes de données typées et de ORM, ce qui rend la modification coûteuse et fastidieuse.</span><span class="sxs-lookup"><span data-stu-id="9749a-140">Their schemaless nature allows developers to move away from an architecture of typed data classes and ORMs that make change expensive and time-consuming.</span></span> <span data-ttu-id="9749a-141">Nous abordons les bases de données NoSQL plus loin dans ce chapitre.</span><span class="sxs-lookup"><span data-stu-id="9749a-141">We cover NoSQL databases later in this chapter.</span></span>

 <span data-ttu-id="9749a-142">L’encapsulation des données dans des microservices distincts peut accroître l’agilité, les performances et l’évolutivité, mais elle présente également de nombreux défis.</span><span class="sxs-lookup"><span data-stu-id="9749a-142">While encapsulating  data into separate microservices can increase agility, performance, and scalability, it also presents many challenges.</span></span> <span data-ttu-id="9749a-143">Dans la section suivante, nous aborderons ces défis, ainsi que les modèles et les pratiques qui vous aideront à les surmonter.</span><span class="sxs-lookup"><span data-stu-id="9749a-143">In the next section, we discuss these challenges along with patterns and practices to help overcome them.</span></span>  

## <a name="cross-service-queries"></a><span data-ttu-id="9749a-144">Requêtes entre services</span><span class="sxs-lookup"><span data-stu-id="9749a-144">Cross-service queries</span></span>

<span data-ttu-id="9749a-145">Alors que les microservices sont indépendants et qu’ils se concentrent sur des fonctionnalités spécifiques, telles que l’inventaire, l’expédition ou l’ordonnancement, ils requièrent souvent une intégration avec d’autres microservices.</span><span class="sxs-lookup"><span data-stu-id="9749a-145">While microservices are independent and focus on specific functional capabilities, like inventory, shipping, or ordering, they frequently require integration with other microservices.</span></span> <span data-ttu-id="9749a-146">L’intégration implique souvent l' *interrogation* d’un microservice pour les données.</span><span class="sxs-lookup"><span data-stu-id="9749a-146">Often the integration involves one microservice *querying* another for data.</span></span> <span data-ttu-id="9749a-147">La figure 5-3 illustre le scénario.</span><span class="sxs-lookup"><span data-stu-id="9749a-147">Figure 5-3 shows the scenario.</span></span>

![Interrogation sur des microservices](./media/cross-service-query.png)

<span data-ttu-id="9749a-149">**Figure 5-3**.</span><span class="sxs-lookup"><span data-stu-id="9749a-149">**Figure 5-3**.</span></span> <span data-ttu-id="9749a-150">Interrogation sur des microservices</span><span class="sxs-lookup"><span data-stu-id="9749a-150">Querying across microservices</span></span>

<span data-ttu-id="9749a-151">Dans la figure précédente, nous voyons un microservice de panier d’achat qui ajoute un élément au panier d’achat d’un utilisateur.</span><span class="sxs-lookup"><span data-stu-id="9749a-151">In the preceding figure, we see a shopping basket microservice that adds an item to a user's shopping basket.</span></span> <span data-ttu-id="9749a-152">Alors que le magasin de données pour ce microservice contient des données de panier et d’élément de ligne, il ne conserve pas les données de produit ou de tarification.</span><span class="sxs-lookup"><span data-stu-id="9749a-152">While the data store for this microservice contains basket and line item data, it doesn't maintain product or pricing data.</span></span> <span data-ttu-id="9749a-153">Au lieu de cela, ces éléments de données sont détenus par le catalogue et les microservices de tarification.</span><span class="sxs-lookup"><span data-stu-id="9749a-153">Instead, those data items are owned by the catalog and pricing microservices.</span></span> <span data-ttu-id="9749a-154">Cela pose un problème.</span><span class="sxs-lookup"><span data-stu-id="9749a-154">This presents a problem.</span></span> <span data-ttu-id="9749a-155">Comment le microservice du panier d’achat peut-il ajouter un produit au panier d’achat de l’utilisateur lorsqu’il n’a pas de données de produit ou de prix dans sa base de données ?</span><span class="sxs-lookup"><span data-stu-id="9749a-155">How can the shopping basket microservice add a product to the user's shopping basket when it doesn't have product nor pricing data in its database?</span></span>

<span data-ttu-id="9749a-156">L’une des options présentées dans le chapitre 4 est un [appel http direct](service-to-service-communication.md#queries) du panier d’achat aux microservices de catalogue et de tarification.</span><span class="sxs-lookup"><span data-stu-id="9749a-156">One option discussed in Chapter 4 is a [direct HTTP call](service-to-service-communication.md#queries) from the shopping basket to the catalog and pricing microservices.</span></span> <span data-ttu-id="9749a-157">Toutefois, dans le chapitre 4, nous avons dit que les appels HTTP synchrones *couplent* les microservices ensemble, ce qui réduit leur autonomie et réduit leurs avantages architecturaux.</span><span class="sxs-lookup"><span data-stu-id="9749a-157">However, in chapter 4, we said synchronous HTTP calls *couple* microservices together, reducing their autonomy and diminishing their architectural benefits.</span></span>

<span data-ttu-id="9749a-158">Nous pourrions également implémenter un modèle de demande-réponse avec des files d’attente entrantes et sortantes distinctes pour chaque service.</span><span class="sxs-lookup"><span data-stu-id="9749a-158">We could also implement a request-reply pattern with separate inbound and outbound queues for each service.</span></span> <span data-ttu-id="9749a-159">Toutefois, ce modèle est complexe et nécessite la mise en corrélation des messages de demande et de réponse.</span><span class="sxs-lookup"><span data-stu-id="9749a-159">However, this pattern is complicated and requires plumbing to correlate request and response messages.</span></span>
<span data-ttu-id="9749a-160">S’il dissocie les appels du microservice principal, le service appelant doit toujours attendre que l’appel se termine.</span><span class="sxs-lookup"><span data-stu-id="9749a-160">While it does decouple the backend microservice calls, the calling service must still synchronously wait for the call to complete.</span></span> <span data-ttu-id="9749a-161">La congestion du réseau, les erreurs temporaires ou un microservice surchargé et peuvent entraîner des opérations de longue durée et même en échec.</span><span class="sxs-lookup"><span data-stu-id="9749a-161">Network congestion, transient faults, or an overloaded microservice and can result in long-running and even failed operations.</span></span>

<span data-ttu-id="9749a-162">Au lieu de cela, un modèle largement accepté pour la suppression des dépendances entre les services est le [modèle de vue matérialisée](https://docs.microsoft.com/azure/architecture/patterns/materialized-view), illustré à la figure 5-4.</span><span class="sxs-lookup"><span data-stu-id="9749a-162">Instead, a widely accepted pattern for removing cross-service dependencies is the [Materialized View Pattern](https://docs.microsoft.com/azure/architecture/patterns/materialized-view), shown in Figure 5-4.</span></span>

![Modèle de vue matérialisée](./media/materialized-view-pattern.png)

<span data-ttu-id="9749a-164">**Figure 5-4**.</span><span class="sxs-lookup"><span data-stu-id="9749a-164">**Figure 5-4**.</span></span> <span data-ttu-id="9749a-165">Modèle de vue matérialisée</span><span class="sxs-lookup"><span data-stu-id="9749a-165">Materialized View Pattern</span></span>

<span data-ttu-id="9749a-166">Avec ce modèle, vous placez une table de données locale (appelée *modèle de lecture*) dans le service panier d’achat.</span><span class="sxs-lookup"><span data-stu-id="9749a-166">With this pattern, you place a local data table (known as a *read model*) in the shopping basket service.</span></span> <span data-ttu-id="9749a-167">Ce tableau contient une copie dénormalisée des données nécessaires à partir des microservices du produit et de la tarification.</span><span class="sxs-lookup"><span data-stu-id="9749a-167">This table contains a denormalized copy of the data needed from the product and pricing microservices.</span></span> <span data-ttu-id="9749a-168">La copie des données directement dans le microservice du panier d’achat élimine le besoin d’appels interservice coûteux.</span><span class="sxs-lookup"><span data-stu-id="9749a-168">Copying the data directly into the shopping basket microservice eliminates the need for expensive cross-service calls.</span></span> <span data-ttu-id="9749a-169">Avec les données locales au service, vous améliorez le temps de réponse et la fiabilité du service.</span><span class="sxs-lookup"><span data-stu-id="9749a-169">With the data local to the service, you improve the service's response time and reliability.</span></span> <span data-ttu-id="9749a-170">En outre, le fait de disposer de sa propre copie des données rend le service du panier d’achat plus résilient.</span><span class="sxs-lookup"><span data-stu-id="9749a-170">Additionally, having its own copy of the data makes the shopping basket service more resilient.</span></span> <span data-ttu-id="9749a-171">Si le service de catalogue doit devenir indisponible, il n’a pas d’impact direct sur le service panier d’achat.</span><span class="sxs-lookup"><span data-stu-id="9749a-171">If the catalog service should become unavailable, it wouldn't directly impact the shopping basket service.</span></span> <span data-ttu-id="9749a-172">Le panier d’achat peut continuer à fonctionner avec les données de son propre magasin.</span><span class="sxs-lookup"><span data-stu-id="9749a-172">The shopping basket can continue operating with the data from its own store.</span></span>

<span data-ttu-id="9749a-173">Le piège avec cette approche est que vous avez maintenant des données en double dans votre système.</span><span class="sxs-lookup"><span data-stu-id="9749a-173">The catch with this approach is that you now have duplicate data in your system.</span></span> <span data-ttu-id="9749a-174">Toutefois, la duplication *stratégique* des données dans les systèmes natifs du Cloud est une pratique établie et n’est pas considérée comme un anti-modèle ou une mauvaise pratique.</span><span class="sxs-lookup"><span data-stu-id="9749a-174">However, *strategically* duplicating data in cloud-native systems is an established practice and not considered an anti-pattern, or bad practice.</span></span> <span data-ttu-id="9749a-175">N’oubliez pas qu' *un et un seul service* peuvent posséder un jeu de données et avoir une autorité sur celui-ci.</span><span class="sxs-lookup"><span data-stu-id="9749a-175">Keep in mind that *one and only one service* can own a data set and have authority over it.</span></span> <span data-ttu-id="9749a-176">Vous devez synchroniser les modèles de lecture lorsque le système d’enregistrement est mis à jour.</span><span class="sxs-lookup"><span data-stu-id="9749a-176">You'll need to synchronize the read models when the system of record is updated.</span></span> <span data-ttu-id="9749a-177">La synchronisation est généralement implémentée via une messagerie asynchrone avec un [modèle de publication/abonnement](service-to-service-communication.md#events), comme illustré dans la figure 5,4.</span><span class="sxs-lookup"><span data-stu-id="9749a-177">Synchronization is typically implemented via asynchronous messaging with a [publish/subscribe pattern](service-to-service-communication.md#events), as shown in Figure 5.4.</span></span>

## <a name="distributed-transactions"></a><span data-ttu-id="9749a-178">Transactions distribuées</span><span class="sxs-lookup"><span data-stu-id="9749a-178">Distributed transactions</span></span>

<span data-ttu-id="9749a-179">Bien que l’interrogation des données entre les microservices soit difficile, l’implémentation d’une transaction sur plusieurs microservices est encore plus complexe.</span><span class="sxs-lookup"><span data-stu-id="9749a-179">While querying data across microservices is difficult, implementing a transaction across several microservices is even more complex.</span></span> <span data-ttu-id="9749a-180">Le défi inhérent à la gestion de la cohérence des données entre des sources de données indépendantes dans des microservices différents ne peut pas être sous-état.</span><span class="sxs-lookup"><span data-stu-id="9749a-180">The inherent challenge of maintaining data consistency across independent data sources in different microservices can't be understated.</span></span> <span data-ttu-id="9749a-181">Le manque de transactions distribuées dans les applications natives du Cloud signifie que vous devez gérer les transactions distribuées par programme.</span><span class="sxs-lookup"><span data-stu-id="9749a-181">The lack of distributed transactions in cloud-native applications means that you must manage distributed transactions programmatically.</span></span> <span data-ttu-id="9749a-182">Vous passez d’un monde de *cohérence immédiate* à celle de *la cohérence éventuelle*.</span><span class="sxs-lookup"><span data-stu-id="9749a-182">You move from a world of *immediate consistency* to that of *eventual consistency*.</span></span>

<span data-ttu-id="9749a-183">La figure 5-5 illustre le problème.</span><span class="sxs-lookup"><span data-stu-id="9749a-183">Figure 5-5 shows the problem.</span></span>

![Transaction dans le modèle saga](./media/saga-transaction-operation.png)

<span data-ttu-id="9749a-185">**Figure 5-5**.</span><span class="sxs-lookup"><span data-stu-id="9749a-185">**Figure 5-5**.</span></span> <span data-ttu-id="9749a-186">Implémentation d’une transaction sur des microservices</span><span class="sxs-lookup"><span data-stu-id="9749a-186">Implementing a transaction across microservices</span></span>

<span data-ttu-id="9749a-187">Dans la figure précédente, cinq microservices indépendants participent à une transaction distribuée qui crée une commande.</span><span class="sxs-lookup"><span data-stu-id="9749a-187">In the preceding figure, five independent microservices participate in a distributed transaction that creates an order.</span></span> <span data-ttu-id="9749a-188">Chaque microservice gère son propre magasin de données et implémente une transaction locale pour son magasin.</span><span class="sxs-lookup"><span data-stu-id="9749a-188">Each microservice maintains its own data store and implements a local transaction for its store.</span></span> <span data-ttu-id="9749a-189">Pour créer la commande, la transaction locale pour *chaque* microservice individuel doit être effectuée, ou *toutes* doivent abandonner et annuler l’opération.</span><span class="sxs-lookup"><span data-stu-id="9749a-189">To create the order, the local transaction for *each* individual microservice must succeed, or *all* must abort and roll back the operation.</span></span> <span data-ttu-id="9749a-190">Alors que la prise en charge des transactions intégrée est disponible dans chacun des microservices, il n’existe pas de prise en charge d’une transaction distribuée qui s’étend sur les cinq services pour assurer la cohérence des données.</span><span class="sxs-lookup"><span data-stu-id="9749a-190">While built-in transactional support is available inside each of the microservices, there's no support for a distributed transaction that would span across all five services to keep data consistent.</span></span>

<span data-ttu-id="9749a-191">Au lieu de cela, vous devez construire cette transaction distribuée *par programme*.</span><span class="sxs-lookup"><span data-stu-id="9749a-191">Instead, you must construct this distributed transaction *programmatically*.</span></span>

<span data-ttu-id="9749a-192">Un modèle répandu pour l’ajout de la prise en charge transactionnelle distribuée est le modèle saga.</span><span class="sxs-lookup"><span data-stu-id="9749a-192">A popular pattern for adding distributed transactional support is the Saga pattern.</span></span> <span data-ttu-id="9749a-193">Elle est implémentée en regroupant les transactions locales ensemble par programmation et en appelant séquentiellement chacune.</span><span class="sxs-lookup"><span data-stu-id="9749a-193">It's implemented by grouping local transactions together programmatically and sequentially invoking each one.</span></span> <span data-ttu-id="9749a-194">Si l’une des transactions locales échoue, le saga abandonne l’opération et appelle un ensemble de [transactions de compensation](https://docs.microsoft.com/azure/architecture/patterns/compensating-transaction).</span><span class="sxs-lookup"><span data-stu-id="9749a-194">If any of the local transactions fail, the Saga aborts the operation and invokes a set of [compensating transactions](https://docs.microsoft.com/azure/architecture/patterns/compensating-transaction).</span></span> <span data-ttu-id="9749a-195">Les transactions de compensation annulent les modifications apportées par les transactions locales précédentes et la cohérence des données de restauration.</span><span class="sxs-lookup"><span data-stu-id="9749a-195">The compensating transactions undo the changes made by the preceding local transactions and restore data consistency.</span></span> <span data-ttu-id="9749a-196">La figure 5-6 montre une transaction ayant échoué avec le modèle saga.</span><span class="sxs-lookup"><span data-stu-id="9749a-196">Figure 5-6 shows a failed transaction with the Saga pattern.</span></span>

![Revenir en arrière dans le modèle saga](./media/saga-rollback-operation.png)

<span data-ttu-id="9749a-198">**Figure 5-6**.</span><span class="sxs-lookup"><span data-stu-id="9749a-198">**Figure 5-6**.</span></span> <span data-ttu-id="9749a-199">Restauration d’une transaction</span><span class="sxs-lookup"><span data-stu-id="9749a-199">Rolling back a transaction</span></span>

<span data-ttu-id="9749a-200">Dans l’illustration précédente, l’opération de *mise à jour* de l’inventaire a échoué dans le microservice d’inventaire.</span><span class="sxs-lookup"><span data-stu-id="9749a-200">In the previous figure, the *Update Inventory* operation has failed in the Inventory microservice.</span></span> <span data-ttu-id="9749a-201">Le saga appelle un ensemble de transactions de compensation (en rouge) pour ajuster le nombre d’inventaires, annuler le paiement et la commande et retourner les données pour chaque microservice dans un état cohérent.</span><span class="sxs-lookup"><span data-stu-id="9749a-201">The Saga invokes a set of compensating transactions (in red) to adjust the inventory counts, cancel the payment and the order, and return the data for each microservice back to a consistent state.</span></span>

<span data-ttu-id="9749a-202">Les modèles Saga sont généralement chorégraphiés sous la forme d’une série d’événements connexes, ou orchestrés sous la forme d’un ensemble de commandes associées.</span><span class="sxs-lookup"><span data-stu-id="9749a-202">Saga patterns are typically choreographed as a series of related events, or orchestrated as a set of related commands.</span></span> <span data-ttu-id="9749a-203">Dans le chapitre 4, nous avons abordé le modèle d’agrégation de services qui serait la base d’une implémentation saga orchestrée.</span><span class="sxs-lookup"><span data-stu-id="9749a-203">In Chapter 4, we discussed the service aggregator pattern that would be the foundation for an orchestrated saga implementation.</span></span> <span data-ttu-id="9749a-204">Nous avons également abordé les événements, ainsi que les rubriques de Azure Service Bus et Azure Event Grid qui seraient la base d’une implémentation chorégraphiés saga.</span><span class="sxs-lookup"><span data-stu-id="9749a-204">We also discussed eventing along with Azure Service Bus and Azure Event Grid topics that would be a foundation for a choreographed saga implementation.</span></span>

## <a name="high-volume-data"></a><span data-ttu-id="9749a-205">Données volumineuses</span><span class="sxs-lookup"><span data-stu-id="9749a-205">High volume data</span></span>

<span data-ttu-id="9749a-206">Les grandes applications Cloud natives prennent souvent en charge des exigences de données importantes.</span><span class="sxs-lookup"><span data-stu-id="9749a-206">Large cloud-native applications often support high-volume data requirements.</span></span> <span data-ttu-id="9749a-207">Dans ces scénarios, les techniques traditionnelles de stockage de données peuvent provoquer des goulots d’étranglement.</span><span class="sxs-lookup"><span data-stu-id="9749a-207">In these scenarios, traditional data storage techniques can cause bottlenecks.</span></span> <span data-ttu-id="9749a-208">Pour les systèmes complexes déployés à grande échelle, les séparation des responsabilités en matière de commande et de requête (CQRS) et l’approvisionnement des événements peuvent améliorer les performances de l’application.</span><span class="sxs-lookup"><span data-stu-id="9749a-208">For complex systems that deploy on a large scale, both Command and Query Responsibility Segregation (CQRS) and Event Sourcing may improve application performance.</span></span>  

### <a name="cqrs"></a><span data-ttu-id="9749a-209">CQRS</span><span class="sxs-lookup"><span data-stu-id="9749a-209">CQRS</span></span>

<span data-ttu-id="9749a-210">[CQRS](https://docs.microsoft.com/azure/architecture/patterns/cqrs)est un modèle architectural qui peut aider à optimiser les performances, l’évolutivité et la sécurité.</span><span class="sxs-lookup"><span data-stu-id="9749a-210">[CQRS](https://docs.microsoft.com/azure/architecture/patterns/cqrs), is an architectural pattern that can help maximize performance, scalability, and security.</span></span> <span data-ttu-id="9749a-211">Le modèle sépare les opérations qui lisent les données des opérations qui écrivent des données.</span><span class="sxs-lookup"><span data-stu-id="9749a-211">The pattern separates operations that read data from those operations that write data.</span></span>

<span data-ttu-id="9749a-212">Pour les scénarios normaux, le même modèle d’entité et l’objet de référentiel de données sont utilisés pour *les* opérations de lecture et d’écriture.</span><span class="sxs-lookup"><span data-stu-id="9749a-212">For normal scenarios, the same entity model and data repository object are used for *both* read and write operations.</span></span>

<span data-ttu-id="9749a-213">Toutefois, un scénario de données volumineuses peut tirer parti de modèles et de tables de données distincts pour les lectures et les écritures.</span><span class="sxs-lookup"><span data-stu-id="9749a-213">However, a high volume data scenario can benefit from separate models and data tables for reads and writes.</span></span> <span data-ttu-id="9749a-214">Pour améliorer les performances, l’opération de lecture peut interroger une représentation fortement dénormalisée des données afin d’éviter des jointures de tables et des verrous de table répétitifs coûteux.</span><span class="sxs-lookup"><span data-stu-id="9749a-214">To improve performance, the read operation could query against a highly denormalized representation of the data to avoid expensive repetitive table joins and table locks.</span></span> <span data-ttu-id="9749a-215">L’opération d' *écriture* , appelée *commande*, est mise à jour par rapport à une représentation entièrement normalisée des données qui garantissent la cohérence.</span><span class="sxs-lookup"><span data-stu-id="9749a-215">The *write* operation, known as a *command*, would update against a fully normalized representation of the data that would guarantee consistency.</span></span> <span data-ttu-id="9749a-216">Vous devez ensuite implémenter un mécanisme pour maintenir la synchronisation des deux représentations. En général, chaque fois que la table d’écriture est modifiée, elle publie un événement qui réplique la modification dans la table de lecture.</span><span class="sxs-lookup"><span data-stu-id="9749a-216">You then need to implement a mechanism to keep both representations in sync. Typically, whenever the write table is modified, it publishes an event that replicates the modification to the read table.</span></span>

<span data-ttu-id="9749a-217">La figure 5-7 illustre une implémentation du modèle CQRS.</span><span class="sxs-lookup"><span data-stu-id="9749a-217">Figure 5-7 shows an implementation of the CQRS pattern.</span></span>

![séparation des responsabilités en matière de commande et de requête](./media/cqrs-implementation.png)

<span data-ttu-id="9749a-219">**Figure 5-7**.</span><span class="sxs-lookup"><span data-stu-id="9749a-219">**Figure 5-7**.</span></span> <span data-ttu-id="9749a-220">Implémentation CQRS</span><span class="sxs-lookup"><span data-stu-id="9749a-220">CQRS implementation</span></span>

<span data-ttu-id="9749a-221">Dans la figure précédente, des modèles de commande et de requête distincts sont implémentés.</span><span class="sxs-lookup"><span data-stu-id="9749a-221">In the previous figure, separate command and query models are implemented.</span></span> <span data-ttu-id="9749a-222">Chaque opération d’écriture de données est enregistrée dans le magasin d’écriture, puis propagée vers le magasin de lecture.</span><span class="sxs-lookup"><span data-stu-id="9749a-222">Each data write operation is saved to the write store and then propagated to the read store.</span></span> <span data-ttu-id="9749a-223">Portez une attention particulière à la façon dont le processus de propagation des données opère sur le principe de la [cohérence éventuelle](http://www.cloudcomputingpatterns.org/eventual_consistency/).</span><span class="sxs-lookup"><span data-stu-id="9749a-223">Pay close attention to how the data propagation process operates on the principle of [eventual consistency](http://www.cloudcomputingpatterns.org/eventual_consistency/).</span></span> <span data-ttu-id="9749a-224">Le modèle de lecture finit par se synchroniser avec le modèle d’écriture, mais il peut y avoir un décalage dans le processus.</span><span class="sxs-lookup"><span data-stu-id="9749a-224">The read model eventually synchronizes with the write model, but there may be some lag in the process.</span></span> <span data-ttu-id="9749a-225">Nous aborderons la cohérence éventuelle dans la section suivante.</span><span class="sxs-lookup"><span data-stu-id="9749a-225">We discuss eventual consistency in the next section.</span></span>

<span data-ttu-id="9749a-226">Cette séparation permet de mettre à l’échelle indépendamment les lectures et les écritures.</span><span class="sxs-lookup"><span data-stu-id="9749a-226">This separation enables reads and writes to scale independently.</span></span> <span data-ttu-id="9749a-227">Les opérations de lecture utilisent un schéma optimisé pour les requêtes, tandis que les écritures utilisent un schéma optimisé pour les mises à jour.</span><span class="sxs-lookup"><span data-stu-id="9749a-227">Read operations use a schema optimized for queries, while the writes use a schema optimized for updates.</span></span> <span data-ttu-id="9749a-228">Les requêtes de lecture dépassent les données dénormalisées, tandis que la logique métier complexe peut être appliquée au modèle d’écriture.</span><span class="sxs-lookup"><span data-stu-id="9749a-228">Read queries go against denormalized data, while complex business logic can be applied to the write model.</span></span> <span data-ttu-id="9749a-229">En outre, vous pouvez imposer une sécurité plus étroite sur les opérations d’écriture que celles qui exposent des lectures.</span><span class="sxs-lookup"><span data-stu-id="9749a-229">As well, you might impose tighter security on write operations than those exposing reads.</span></span>

<span data-ttu-id="9749a-230">L’implémentation de CQRS peut améliorer les performances des applications pour les services Cloud natifs.</span><span class="sxs-lookup"><span data-stu-id="9749a-230">Implementing CQRS can improve application performance for cloud-native services.</span></span> <span data-ttu-id="9749a-231">Toutefois, cela se traduit par une conception plus complexe.</span><span class="sxs-lookup"><span data-stu-id="9749a-231">However, it does result in a more complex design.</span></span> <span data-ttu-id="9749a-232">Appliquez ce principe avec soin et stratégiquement à ces sections de votre application Cloud native qui en tireront parti.</span><span class="sxs-lookup"><span data-stu-id="9749a-232">Apply this principle carefully and strategically to those sections of your cloud-native application that will benefit from it.</span></span> <span data-ttu-id="9749a-233">Pour plus d’informations sur CQRS, consultez les [microservices .NET Microsoft Book : architecture pour les applications .net en conteneur](https://docs.microsoft.com/dotnet/architecture/microservices/microservice-ddd-cqrs-patterns/apply-simplified-microservice-cqrs-ddd-patterns).</span><span class="sxs-lookup"><span data-stu-id="9749a-233">For more on CQRS, see the Microsoft book [.NET Microservices: Architecture for Containerized .NET Applications](https://docs.microsoft.com/dotnet/architecture/microservices/microservice-ddd-cqrs-patterns/apply-simplified-microservice-cqrs-ddd-patterns).</span></span>

### <a name="event-sourcing"></a><span data-ttu-id="9749a-234">Provisionnement en événements</span><span class="sxs-lookup"><span data-stu-id="9749a-234">Event sourcing</span></span>

<span data-ttu-id="9749a-235">Une autre approche de l’optimisation des scénarios de données volumineuses implique l' [approvisionnement des événements](https://docs.microsoft.com/azure/architecture/patterns/event-sourcing).</span><span class="sxs-lookup"><span data-stu-id="9749a-235">Another approach to optimizing high volume data scenarios involves [Event Sourcing](https://docs.microsoft.com/azure/architecture/patterns/event-sourcing).</span></span>

<span data-ttu-id="9749a-236">Un système stocke généralement l’état actuel d’une entité de données.</span><span class="sxs-lookup"><span data-stu-id="9749a-236">A system typically stores the current state of a data entity.</span></span> <span data-ttu-id="9749a-237">Si un utilisateur modifie son numéro de téléphone, par exemple, l’enregistrement du client est mis à jour avec le nouveau numéro.</span><span class="sxs-lookup"><span data-stu-id="9749a-237">If a user changes their phone number, for example, the customer record is updated with the new number.</span></span> <span data-ttu-id="9749a-238">Nous connaissons toujours l’état actuel d’une entité de données, mais chaque mise à jour remplace l’état précédent.</span><span class="sxs-lookup"><span data-stu-id="9749a-238">We always know the current state of a data entity, but each update overwrites the previous state.</span></span>

<span data-ttu-id="9749a-239">Dans la plupart des cas, ce modèle fonctionne correctement.</span><span class="sxs-lookup"><span data-stu-id="9749a-239">In most cases, this model works fine.</span></span> <span data-ttu-id="9749a-240">Toutefois, dans les systèmes à volume élevé, la surcharge du verrouillage transactionnel et des opérations de mise à jour fréquentes peut avoir un impact sur les performances de la base de données, la réactivité et la limitation de l’évolutivité.</span><span class="sxs-lookup"><span data-stu-id="9749a-240">In high volume systems, however, overhead from transactional locking and frequent update operations can impact database performance, responsiveness, and limit scalability.</span></span>

<span data-ttu-id="9749a-241">L’approvisionnement en événements adopte une approche différente pour la capture des données.</span><span class="sxs-lookup"><span data-stu-id="9749a-241">Event Sourcing takes a different approach to capturing data.</span></span> <span data-ttu-id="9749a-242">Chaque opération qui affecte les données est conservée dans un magasin d’événements.</span><span class="sxs-lookup"><span data-stu-id="9749a-242">Each operation that affects data is persisted to an event store.</span></span> <span data-ttu-id="9749a-243">Au lieu de mettre à jour l’état d’un enregistrement de données, nous avons ajouté chaque modification à une liste séquentielle d’événements passés, similaire à la comptabilité d’un comptable.</span><span class="sxs-lookup"><span data-stu-id="9749a-243">Instead of updating the state of a data record, we append each change to a sequential list of past events - similar to an accountant's ledger.</span></span> <span data-ttu-id="9749a-244">Le magasin d’événements devient le système d’enregistrement des données.</span><span class="sxs-lookup"><span data-stu-id="9749a-244">The Event Store becomes the system of record for the data.</span></span> <span data-ttu-id="9749a-245">Elle est utilisée pour propager différentes vues matérialisées dans le contexte limité d’un microservice.</span><span class="sxs-lookup"><span data-stu-id="9749a-245">It's used to propagate various materialized views within the bounded context of a microservice.</span></span> <span data-ttu-id="9749a-246">La figure 5,8 illustre le modèle.</span><span class="sxs-lookup"><span data-stu-id="9749a-246">Figure 5.8 shows the pattern.</span></span>

![Approvisionnement en événements](./media/event-sourcing.png)

<span data-ttu-id="9749a-248">**Figure 5-8**.</span><span class="sxs-lookup"><span data-stu-id="9749a-248">**Figure 5-8**.</span></span> <span data-ttu-id="9749a-249">Approvisionnement en événements</span><span class="sxs-lookup"><span data-stu-id="9749a-249">Event Sourcing</span></span>

<span data-ttu-id="9749a-250">Dans la figure précédente, notez la manière dont chaque entrée (en bleu) du panier d’achat d’un utilisateur est ajoutée à un magasin d’événements sous-jacent.</span><span class="sxs-lookup"><span data-stu-id="9749a-250">In the previous figure, note how each entry (in blue) for a user's shopping cart is appended to an underlying event store.</span></span> <span data-ttu-id="9749a-251">Dans la vue matérialisée adjacente, le système projette l’état actuel en relisant tous les événements associés à chaque panier.</span><span class="sxs-lookup"><span data-stu-id="9749a-251">In the adjoining materialized view, the system projects the current state by replaying all the events associated with each shopping cart.</span></span> <span data-ttu-id="9749a-252">Cette vue, ou lire le modèle, est ensuite exposée à l’interface utilisateur.</span><span class="sxs-lookup"><span data-stu-id="9749a-252">This view, or read model, is then exposed back to the UI.</span></span> <span data-ttu-id="9749a-253">Les événements peuvent également être intégrés à des systèmes externes et à des applications, ou être interrogés pour déterminer l’état actuel d’une entité.</span><span class="sxs-lookup"><span data-stu-id="9749a-253">Events can also be integrated with external systems and applications or queried to determine the current state of an entity.</span></span> <span data-ttu-id="9749a-254">Avec cette approche, vous conservez l’historique.</span><span class="sxs-lookup"><span data-stu-id="9749a-254">With this approach, you maintain history.</span></span> <span data-ttu-id="9749a-255">Vous savez non seulement l’état actuel d’une entité, mais également comment vous avez atteint cet État.</span><span class="sxs-lookup"><span data-stu-id="9749a-255">You know not only the current state of an entity, but also how you reached this state.</span></span>

<span data-ttu-id="9749a-256">En parlant mécanique, l’approvisionnement en événements simplifie le modèle d’écriture.</span><span class="sxs-lookup"><span data-stu-id="9749a-256">Mechanically speaking, event sourcing simplifies the write model.</span></span> <span data-ttu-id="9749a-257">Il n’y a aucune mise à jour ou suppression.</span><span class="sxs-lookup"><span data-stu-id="9749a-257">There are no updates or deletes.</span></span> <span data-ttu-id="9749a-258">L’ajout de chaque entrée de données comme un événement immuable minimise les conflits de contention, de verrouillage et d’accès concurrentiel associés aux bases de données relationnelles.</span><span class="sxs-lookup"><span data-stu-id="9749a-258">Appending each data entry as an immutable event minimizes contention, locking, and concurrency conflicts associated with relational databases.</span></span> <span data-ttu-id="9749a-259">La création de modèles de lecture avec le modèle de vue matérialisée vous permet de découpler la vue du modèle d’écriture et de choisir la meilleure banque de données pour optimiser les besoins de l’interface utilisateur de votre application.</span><span class="sxs-lookup"><span data-stu-id="9749a-259">Building read models with the materialized view pattern enables you to decouple the view from the write model and choose the best data store to optimize the needs of your application UI.</span></span>

<span data-ttu-id="9749a-260">Pour ce modèle, envisagez un magasin de données qui prend directement en charge l’approvisionnement des événements.</span><span class="sxs-lookup"><span data-stu-id="9749a-260">For this pattern, consider a data store that directly supports event sourcing.</span></span> <span data-ttu-id="9749a-261">Azure Cosmos DB, MongoDB, Cassandra, CouchDB et RavenDB sont de bons candidats.</span><span class="sxs-lookup"><span data-stu-id="9749a-261">Azure Cosmos DB, MongoDB, Cassandra, CouchDB, and RavenDB are good candidates.</span></span>

<span data-ttu-id="9749a-262">Comme avec tous les modèles et technologies, implémentez stratégiquement et si nécessaire.</span><span class="sxs-lookup"><span data-stu-id="9749a-262">As with all patterns and technologies, implement strategically and when needed.</span></span> <span data-ttu-id="9749a-263">Bien que l’approvisionnement en événements puisse offrir des performances et une évolutivité accrues, il est au détriment de la complexité et d’une courbe d’apprentissage.</span><span class="sxs-lookup"><span data-stu-id="9749a-263">While event sourcing can provide increased performance and scalability, it comes at the expense of complexity and a learning curve.</span></span>

>[!div class="step-by-step"]
><span data-ttu-id="9749a-264">[Précédent](service-mesh-communication-infrastructure.md) 
> [Suivant](relational-vs-nosql-data.md)</span><span class="sxs-lookup"><span data-stu-id="9749a-264">[Previous](service-mesh-communication-infrastructure.md)
[Next](relational-vs-nosql-data.md)</span></span>
