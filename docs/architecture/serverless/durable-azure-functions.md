---
title: Fonctions Azure durables-applications sans serveur
description: Les fonctions Azure durables étendent le runtime Azure Functions pour activer les flux de travail avec état dans le code.
author: cecilphillip
ms.author: cephilli
ms.date: 06/26/2018
ms.openlocfilehash: 1498b5a19bc92b7db16f7422a35ac3afffb82b60
ms.sourcegitcommit: 5b475c1855b32cf78d2d1bbb4295e4c236f39464
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 09/24/2020
ms.locfileid: "91171791"
---
# <a name="durable-azure-functions"></a><span data-ttu-id="e4a7d-103">Fonctions Azure durables</span><span class="sxs-lookup"><span data-stu-id="e4a7d-103">Durable Azure functions</span></span>

<span data-ttu-id="e4a7d-104">Lorsque vous créez des applications sans serveur avec Azure Functions, vos opérations sont généralement conçues pour s’exécuter sans État.</span><span class="sxs-lookup"><span data-stu-id="e4a7d-104">When creating serverless applications with Azure Functions, your operations will typically be designed to run in a stateless manner.</span></span> <span data-ttu-id="e4a7d-105">La raison de ce choix de conception est que, à mesure que la plateforme évolue, il devient difficile de savoir quels serveurs le code s’exécute.</span><span class="sxs-lookup"><span data-stu-id="e4a7d-105">The reason for this design choice is because as the platform scales, it becomes difficult to know what servers the code is running on.</span></span> <span data-ttu-id="e4a7d-106">Il devient également difficile de savoir combien d’instances sont actives à un point donné.</span><span class="sxs-lookup"><span data-stu-id="e4a7d-106">It also becomes difficult to know how many instances are active at any given point.</span></span> <span data-ttu-id="e4a7d-107">Toutefois, il existe des classes d’applications qui requièrent que l’état actuel d’un processus soit connu.</span><span class="sxs-lookup"><span data-stu-id="e4a7d-107">However, there are classes of applications that require the current state of a process to be known.</span></span> <span data-ttu-id="e4a7d-108">Envisagez le processus d’envoi d’une commande à un magasin en ligne.</span><span class="sxs-lookup"><span data-stu-id="e4a7d-108">Consider the process of submitting an order to an online store.</span></span> <span data-ttu-id="e4a7d-109">L’opération d’extraction peut être un flux de travail composé de plusieurs opérations qui doivent connaître l’état du processus.</span><span class="sxs-lookup"><span data-stu-id="e4a7d-109">The checkout operation might be a workflow that is composed of multiple operations that need to know the state of the process.</span></span> <span data-ttu-id="e4a7d-110">Ces informations peuvent inclure l’inventaire des produits, si le client a un crédit sur son compte, ainsi que les résultats du traitement de la carte de crédit.</span><span class="sxs-lookup"><span data-stu-id="e4a7d-110">Such information may include the product inventory, if the customer has any credits on their account, and also the results of processing the credit card.</span></span> <span data-ttu-id="e4a7d-111">Ces opérations peuvent facilement être leurs propres flux de travail internes, voire des services de systèmes tiers.</span><span class="sxs-lookup"><span data-stu-id="e4a7d-111">These operations could easily be their own internal workflows or even services from third-party systems.</span></span>

<span data-ttu-id="e4a7d-112">Il existe aujourd’hui plusieurs modèles qui facilitent la coordination de l’état des applications entre les systèmes internes et externes.</span><span class="sxs-lookup"><span data-stu-id="e4a7d-112">Various patterns exist today that assist with the coordination of application state between internal and external systems.</span></span> <span data-ttu-id="e4a7d-113">Il est courant de rencontrer des solutions qui s’appuient sur des systèmes de mise en file d’attente centralisés, des magasins de valeurs de clés distribuées ou des bases de données partagées pour gérer cet État.</span><span class="sxs-lookup"><span data-stu-id="e4a7d-113">It's common to come across solutions that rely on centralized queuing systems, distributed key-value stores, or shared databases to manage that state.</span></span> <span data-ttu-id="e4a7d-114">Toutefois, il s’agit de toutes les ressources supplémentaires qui doivent à présent être approvisionnées et gérées.</span><span class="sxs-lookup"><span data-stu-id="e4a7d-114">However, these are all additional resources that now need to be provisioned and managed.</span></span> <span data-ttu-id="e4a7d-115">Dans un environnement sans serveur, votre code pourrait devenir fastidieux à tenter de coordonner manuellement ces ressources.</span><span class="sxs-lookup"><span data-stu-id="e4a7d-115">In a serverless environment, your code could become cumbersome trying to coordinate with these resources manually.</span></span> <span data-ttu-id="e4a7d-116">Azure Functions offre une alternative à la création de fonctions avec état appelées Durable Functions.</span><span class="sxs-lookup"><span data-stu-id="e4a7d-116">Azure Functions offers an alternative for creating stateful functions called Durable Functions.</span></span>

<span data-ttu-id="e4a7d-117">Durable Functions est une extension du runtime Azure Functions qui permet la définition de flux de travail avec état dans le code.</span><span class="sxs-lookup"><span data-stu-id="e4a7d-117">Durable Functions is an extension to the Azure Functions runtime that enables the definition of stateful workflows in code.</span></span> <span data-ttu-id="e4a7d-118">En décomposant les workflows en activités, l’extension de Durable Functions peut gérer l’État, créer des points de contrôle de progression et gérer la distribution des appels de fonction sur les serveurs.</span><span class="sxs-lookup"><span data-stu-id="e4a7d-118">By breaking down workflows into activities, the Durable Functions extension can manage state, create progress checkpoints, and handle the distribution of function calls across servers.</span></span> <span data-ttu-id="e4a7d-119">En arrière-plan, il utilise un compte de stockage Azure pour conserver l’historique d’exécution, planifier les fonctions d’activité et récupérer les réponses.</span><span class="sxs-lookup"><span data-stu-id="e4a7d-119">In the background, it makes use of an Azure Storage account to persist execution history, schedule activity functions and retrieve responses.</span></span> <span data-ttu-id="e4a7d-120">Votre code sans serveur ne doit jamais interagir avec les informations persistantes dans ce compte de stockage, et n’est généralement pas un outil avec lequel les développeurs doivent interagir.</span><span class="sxs-lookup"><span data-stu-id="e4a7d-120">Your serverless code should never interact with persisted information in that storage account, and is typically not something with which developers need to interact.</span></span>

## <a name="triggering-a-stateful-workflow"></a><span data-ttu-id="e4a7d-121">Déclenchement d’un flux de travail avec état</span><span class="sxs-lookup"><span data-stu-id="e4a7d-121">Triggering a stateful workflow</span></span>

<span data-ttu-id="e4a7d-122">Les flux de travail avec état dans Durable Functions peuvent être divisés en deux composants intrinsèques ; déclencheurs d’activité et d’orchestration.</span><span class="sxs-lookup"><span data-stu-id="e4a7d-122">Stateful workflows in Durable Functions can be broken down into two intrinsic components; orchestration and activity triggers.</span></span> <span data-ttu-id="e4a7d-123">Les déclencheurs et les liaisons sont des composants principaux utilisés par Azure Functions pour permettre à vos fonctions sans serveur d’être notifiées quand Démarrer, recevoir une entrée et retourner des résultats.</span><span class="sxs-lookup"><span data-stu-id="e4a7d-123">Triggers and bindings are core components used by Azure Functions to enable your serverless functions to be notified when to start, receive input, and return results.</span></span>

### <a name="working-with-the-orchestration-client"></a><span data-ttu-id="e4a7d-124">Utilisation du client d’orchestration</span><span class="sxs-lookup"><span data-stu-id="e4a7d-124">Working with the Orchestration client</span></span>

<span data-ttu-id="e4a7d-125">Les orchestrations sont uniques par rapport aux autres styles d’opérations déclenchées dans Azure Functions.</span><span class="sxs-lookup"><span data-stu-id="e4a7d-125">Orchestrations are unique when compared to other styles of triggered operations in Azure Functions.</span></span> <span data-ttu-id="e4a7d-126">Durable Functions permet l’exécution de fonctions qui peuvent prendre plusieurs heures, voire plusieurs jours.</span><span class="sxs-lookup"><span data-stu-id="e4a7d-126">Durable Functions enables the execution of functions that may take hours or even days to complete.</span></span> <span data-ttu-id="e4a7d-127">Ce type de comportement est fourni avec la nécessité de vérifier l’état d’une orchestration en cours d’exécution, de terminer de manière préventive ou d’envoyer des notifications d’événements externes.</span><span class="sxs-lookup"><span data-stu-id="e4a7d-127">That type of behavior comes with the need to able to check the status of a running orchestration, preemptively terminate, or send notifications of external events.</span></span>

<span data-ttu-id="e4a7d-128">Dans ce cas, l’extension Durable Functions fournit la `DurableOrchestrationClient` classe qui vous permet d’interagir avec les fonctions orchestrées.</span><span class="sxs-lookup"><span data-stu-id="e4a7d-128">For such cases, the Durable Functions extension provides the `DurableOrchestrationClient` class that allows you to interact with orchestrated functions.</span></span> <span data-ttu-id="e4a7d-129">Vous accédez au client d’orchestration à l’aide de la `OrchestrationClientAttribute` liaison.</span><span class="sxs-lookup"><span data-stu-id="e4a7d-129">You get access to the orchestration client by using the `OrchestrationClientAttribute` binding.</span></span> <span data-ttu-id="e4a7d-130">En règle générale, vous incluez cet attribut avec un autre type de déclencheur, tel que `HttpTrigger` ou `ServiceBusTrigger` .</span><span class="sxs-lookup"><span data-stu-id="e4a7d-130">Generally, you would include this attribute with another trigger type, such as an `HttpTrigger` or `ServiceBusTrigger`.</span></span> <span data-ttu-id="e4a7d-131">Une fois la fonction source déclenchée, le client d’orchestration peut être utilisé pour démarrer une fonction d’orchestrateur.</span><span class="sxs-lookup"><span data-stu-id="e4a7d-131">Once the source function has been triggered, the orchestration client can be used to start an orchestrator function.</span></span>

```csharp
[FunctionName("KickOff")]
public static async Task<HttpResponseMessage> Run(
    [HttpTrigger(AuthorizationLevel.Function, "POST")]HttpRequestMessage req,
    [OrchestrationClient ] DurableOrchestrationClient<orchestrationClient>)
{
    OrderRequestData data = await req.Content.ReadAsAsync<OrderRequestData>();

    string instanceId = await orchestrationClient.StartNewAsync("PlaceOrder", data);

    return orchestrationClient.CreateCheckStatusResponse(req, instanceId);
}
```

### <a name="the-orchestrator-function"></a><span data-ttu-id="e4a7d-132">La fonction d’orchestrateur</span><span class="sxs-lookup"><span data-stu-id="e4a7d-132">The orchestrator function</span></span>

<span data-ttu-id="e4a7d-133">L’annotation d’une fonction avec le OrchestrationTriggerAttribute dans Azure Functions marque cette fonction comme une fonction d’orchestrateur.</span><span class="sxs-lookup"><span data-stu-id="e4a7d-133">Annotating a function with the OrchestrationTriggerAttribute in Azure Functions marks that function as an orchestrator function.</span></span> <span data-ttu-id="e4a7d-134">Il est responsable de la gestion des différentes activités qui composent votre flux de travail avec état.</span><span class="sxs-lookup"><span data-stu-id="e4a7d-134">It's responsible for managing the various activities that make up your stateful workflow.</span></span>

<span data-ttu-id="e4a7d-135">Les fonctions d’orchestrateur ne peuvent pas utiliser des liaisons autres que OrchestrationTriggerAttribute.</span><span class="sxs-lookup"><span data-stu-id="e4a7d-135">Orchestrator functions are unable to make use of bindings other than the OrchestrationTriggerAttribute.</span></span> <span data-ttu-id="e4a7d-136">Cet attribut peut uniquement être utilisé avec un type de paramètre DurableOrchestrationContext.</span><span class="sxs-lookup"><span data-stu-id="e4a7d-136">This attribute can only be used with a parameter type of DurableOrchestrationContext.</span></span> <span data-ttu-id="e4a7d-137">Aucune autre entrée ne peut être utilisée, car la désérialisation des entrées dans la signature de la fonction n’est pas prise en charge.</span><span class="sxs-lookup"><span data-stu-id="e4a7d-137">No other inputs can be used since deserialization of inputs in the function signature isn't supported.</span></span> <span data-ttu-id="e4a7d-138">Pour récupérer les entrées fournies par le client d’orchestration, vous \<T\> devez utiliser la méthode GetInput.</span><span class="sxs-lookup"><span data-stu-id="e4a7d-138">To get inputs provided by the orchestration client, the GetInput\<T\> method must be used.</span></span>

<span data-ttu-id="e4a7d-139">En outre, les types de retour des fonctions d’orchestration doivent être void, Task ou une valeur sérialisable JSON.</span><span class="sxs-lookup"><span data-stu-id="e4a7d-139">Also, the return types of orchestration functions must be either void, Task, or a JSON serializable value.</span></span>

> <span data-ttu-id="e4a7d-140">*Le code de gestion des erreurs a été omis par souci de concision*</span><span class="sxs-lookup"><span data-stu-id="e4a7d-140">*Error handling code has been left out for brevity*</span></span>

```csharp
[FunctionName("PlaceOrder")]
public static async Task<string> PlaceOrder([OrchestrationTrigger] DurableOrchestrationContext context)
{
    OrderRequestData orderData = context.GetInput<OrderRequestData>();

    await context.CallActivityAsync<bool>("CheckAndReserveInventory", orderData);
    await context.CallActivityAsync<string>("ProcessPayment", orderData);

    string trackingNumber = await context.CallActivityAsync<string>("ScheduleShipping", orderData);
    await context.CallActivityAsync<string>("EmailCustomer", trackingNumber);

    return trackingNumber;
}
```

<span data-ttu-id="e4a7d-141">Plusieurs instances d’une orchestration peuvent être démarrées et exécutées en même temps.</span><span class="sxs-lookup"><span data-stu-id="e4a7d-141">Multiple instances of an orchestration can be started and running at the same time.</span></span> <span data-ttu-id="e4a7d-142">L’appel de la `StartNewAsync` méthode sur `DurableOrchestrationClient` lance une nouvelle instance de l’orchestration.</span><span class="sxs-lookup"><span data-stu-id="e4a7d-142">Calling the `StartNewAsync` method on the `DurableOrchestrationClient` launches a new instance of the orchestration.</span></span> <span data-ttu-id="e4a7d-143">La méthode retourne un `Task<string>` qui se termine lorsque l’orchestration a démarré.</span><span class="sxs-lookup"><span data-stu-id="e4a7d-143">The method returns a `Task<string>` that completes when the orchestration has started.</span></span> <span data-ttu-id="e4a7d-144">Une exception de type `TimeoutException` est levée si l’orchestration n’a pas démarré dans les 30 secondes.</span><span class="sxs-lookup"><span data-stu-id="e4a7d-144">An exception of type `TimeoutException` gets thrown if the orchestration hasn't started within 30 seconds.</span></span>

<span data-ttu-id="e4a7d-145">La fin `Task<string>` de `StartNewAsync` doit contenir l’ID unique de l’instance d’orchestration.</span><span class="sxs-lookup"><span data-stu-id="e4a7d-145">The completed `Task<string>` from `StartNewAsync` should contain the unique ID of the orchestration instance.</span></span> <span data-ttu-id="e4a7d-146">Cet ID d’instance peut être utilisé pour appeler des opérations sur cette orchestration spécifique.</span><span class="sxs-lookup"><span data-stu-id="e4a7d-146">This instance ID can be used to invoke operations on that specific orchestration.</span></span> <span data-ttu-id="e4a7d-147">L’orchestration peut être interrogée pour obtenir l’État ou envoyer des notifications d’événements.</span><span class="sxs-lookup"><span data-stu-id="e4a7d-147">The orchestration can be queried for the status or sent event notifications.</span></span>

### <a name="the-activity-functions"></a><span data-ttu-id="e4a7d-148">Fonctions d’activité</span><span class="sxs-lookup"><span data-stu-id="e4a7d-148">The activity functions</span></span>

<span data-ttu-id="e4a7d-149">Les fonctions d’activité sont les opérations discrètes qui sont composées ensemble au sein d’une fonction d’orchestration pour créer le flux de travail.</span><span class="sxs-lookup"><span data-stu-id="e4a7d-149">Activity functions are the discrete operations that get composed together within an orchestration function to create the workflow.</span></span> <span data-ttu-id="e4a7d-150">C’est ici qu’intervient la plupart des tâches réelles.</span><span class="sxs-lookup"><span data-stu-id="e4a7d-150">Here is where most of actual work would take place.</span></span> <span data-ttu-id="e4a7d-151">Elles représentent la logique métier, les processus à long terme et les éléments de puzzle à une plus grande solution.</span><span class="sxs-lookup"><span data-stu-id="e4a7d-151">They represent the business logic, long running processes, and the puzzle pieces to a larger solution.</span></span>

<span data-ttu-id="e4a7d-152">Le `ActivityTriggerAttribute` est utilisé pour annoter un paramètre de fonction de type `DurableActivityContext` .</span><span class="sxs-lookup"><span data-stu-id="e4a7d-152">The `ActivityTriggerAttribute` is used to annotate a function parameter of type `DurableActivityContext`.</span></span> <span data-ttu-id="e4a7d-153">L’utilisation de l’annotation indique au runtime que la fonction est destinée à être utilisée en tant que fonction d’activité.</span><span class="sxs-lookup"><span data-stu-id="e4a7d-153">Using the annotation informs the runtime that the function is intended to be used as an activity function.</span></span> <span data-ttu-id="e4a7d-154">Les valeurs d’entrée des fonctions d’activité sont extraites à l’aide `GetInput<T>` de la méthode du `DurableActivityContext` paramètre.</span><span class="sxs-lookup"><span data-stu-id="e4a7d-154">Input values to activity functions are retrieved using the `GetInput<T>` method of the `DurableActivityContext` parameter.</span></span>

<span data-ttu-id="e4a7d-155">Comme pour les fonctions d’orchestration, les types de retour des fonctions d’activité doivent être void, Task ou une valeur sérialisable JSON.</span><span class="sxs-lookup"><span data-stu-id="e4a7d-155">Similar to orchestration functions, the return types of activity functions must be either void, Task, or a JSON serializable value.</span></span>

<span data-ttu-id="e4a7d-156">Toutes les exceptions non gérées qui sont levées dans les fonctions d’activité sont envoyées à la fonction d’orchestrateur appelant et présentées sous la forme d’un `TaskFailedException` .</span><span class="sxs-lookup"><span data-stu-id="e4a7d-156">Any unhandled exceptions that get thrown within activity functions will get sent up to the calling orchestrator function and presented as a `TaskFailedException`.</span></span> <span data-ttu-id="e4a7d-157">À ce stade, l’erreur peut être interceptée et consignée dans l’orchestrateur, et l’activité peut être retentée.</span><span class="sxs-lookup"><span data-stu-id="e4a7d-157">At this point, the error can be caught and logged in the orchestrator, and the activity can be retried.</span></span>

```csharp
[FunctionName("CheckAndReserveInventory")]
public static bool CheckAndReserveInventory([ActivityTrigger] DurableActivityContext context)
{
    OrderRequestData orderData = context.GetInput<OrderRequestData>();

    // Connect to inventory system and try to reserve items
    return true;
}
```

## <a name="recommended-resources"></a><span data-ttu-id="e4a7d-158">Ressources recommandées</span><span class="sxs-lookup"><span data-stu-id="e4a7d-158">Recommended resources</span></span>

- [<span data-ttu-id="e4a7d-159">Fonctions durables</span><span class="sxs-lookup"><span data-stu-id="e4a7d-159">Durable Functions</span></span>](/azure/azure-functions/durable-functions-overview)
- [<span data-ttu-id="e4a7d-160">Liaisons pour Durable Functions</span><span class="sxs-lookup"><span data-stu-id="e4a7d-160">Bindings for Durable Functions</span></span>](/azure/azure-functions/durable-functions-bindings)
- [<span data-ttu-id="e4a7d-161">Gérer les instances dans Durable Functions</span><span class="sxs-lookup"><span data-stu-id="e4a7d-161">Manage instances in Durable Functions</span></span>](/azure/azure-functions/durable-functions-instance-management)

>[!div class="step-by-step"]
><span data-ttu-id="e4a7d-162">[Précédent](event-grid.md) 
> [Suivant](orchestration-patterns.md)</span><span class="sxs-lookup"><span data-stu-id="e4a7d-162">[Previous](event-grid.md)
[Next](orchestration-patterns.md)</span></span>
