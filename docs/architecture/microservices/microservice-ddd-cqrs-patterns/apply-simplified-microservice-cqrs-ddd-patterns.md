---
title: Application de modèles CQRS et DDD simplifiés dans un microservice
description: Architecture des microservices .NET pour les applications .NET conteneurisées | Comprendre la relation globale entre les modèles CQRS et DDD.
ms.date: 10/08/2018
ms.openlocfilehash: e4e36bafff39f5f30d6371ed7c113322a85c3362
ms.sourcegitcommit: f87ad41b8e62622da126aa928f7640108c4eff98
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 04/07/2020
ms.locfileid: "80805592"
---
# <a name="apply-simplified-cqrs-and-ddd-patterns-in-a-microservice"></a><span data-ttu-id="3541c-103">Appliquer des modèles CQRS et DDD simplifiés dans un microservice</span><span class="sxs-lookup"><span data-stu-id="3541c-103">Apply simplified CQRS and DDD patterns in a microservice</span></span>

<span data-ttu-id="3541c-104">CQRS est un modèle d’architecture qui sépare les modèles pour la lecture et l’écriture de données.</span><span class="sxs-lookup"><span data-stu-id="3541c-104">CQRS is an architectural pattern that separates the models for reading and writing data.</span></span> <span data-ttu-id="3541c-105">Le terme connexe [CQS (séparation des commandes et des requêtes)](https://martinfowler.com/bliki/CommandQuerySeparation.html) a été initialement défini par Bertrand Meyer dans son livre *Object-Oriented Software Construction*.</span><span class="sxs-lookup"><span data-stu-id="3541c-105">The related term [Command Query Separation (CQS)](https://martinfowler.com/bliki/CommandQuerySeparation.html) was originally defined by Bertrand Meyer in his book *Object Oriented Software Construction*.</span></span> <span data-ttu-id="3541c-106">L’idée de base est que vous pouvez diviser les opérations d’un système en deux catégories fortement séparées :</span><span class="sxs-lookup"><span data-stu-id="3541c-106">The basic idea is that you can divide a system's operations into two sharply separated categories:</span></span>

- <span data-ttu-id="3541c-107">Requêtes.</span><span class="sxs-lookup"><span data-stu-id="3541c-107">Queries.</span></span> <span data-ttu-id="3541c-108">Elles retournent un résultat, ne modifient pas l’état du système et ne présentent aucun effet secondaire.</span><span class="sxs-lookup"><span data-stu-id="3541c-108">These return a result and do not change the state of the system, and they are free of side effects.</span></span>

- <span data-ttu-id="3541c-109">Les commandes.</span><span class="sxs-lookup"><span data-stu-id="3541c-109">Commands.</span></span> <span data-ttu-id="3541c-110">Elles modifient l’état d’un système.</span><span class="sxs-lookup"><span data-stu-id="3541c-110">These change the state of a system.</span></span>

<span data-ttu-id="3541c-111">CQS est un concept simple : il s’agit de méthodes au sein d’un même objet étant soit des requêtes ou des commandes.</span><span class="sxs-lookup"><span data-stu-id="3541c-111">CQS is a simple concept: it is about methods within the same object being either queries or commands.</span></span> <span data-ttu-id="3541c-112">Chaque méthode retourne l’état ou transforme l’état, mais pas les deux.</span><span class="sxs-lookup"><span data-stu-id="3541c-112">Each method either returns state or mutates state, but not both.</span></span> <span data-ttu-id="3541c-113">Même un seul objet de modèle de dépôt peut se conformer à CQS.</span><span class="sxs-lookup"><span data-stu-id="3541c-113">Even a single repository pattern object can comply with CQS.</span></span> <span data-ttu-id="3541c-114">L’approche CQS peut être considérée comme un principe fondamental de CQRS.</span><span class="sxs-lookup"><span data-stu-id="3541c-114">CQS can be considered a foundational principle for CQRS.</span></span>

<span data-ttu-id="3541c-115">L’approche [CQRS (séparation des responsabilités dans les commandes et les requêtes)](https://martinfowler.com/bliki/CQRS.html), introduite par Greg Young, a été vivement plébiscitée par Udi Dahan et d’autres.</span><span class="sxs-lookup"><span data-stu-id="3541c-115">[Command and Query Responsibility Segregation (CQRS)](https://martinfowler.com/bliki/CQRS.html) was introduced by Greg Young and strongly promoted by Udi Dahan and others.</span></span> <span data-ttu-id="3541c-116">Elle est basée sur le principe CQS, même si elle est plus détaillée.</span><span class="sxs-lookup"><span data-stu-id="3541c-116">It is based on the CQS principle, although it is more detailed.</span></span> <span data-ttu-id="3541c-117">Elle peut être considérée comme un modèle basé sur les commandes et les événements, et éventuellement sur les messages asynchrones.</span><span class="sxs-lookup"><span data-stu-id="3541c-117">It can be considered a pattern based on commands and events plus optionally on asynchronous messages.</span></span> <span data-ttu-id="3541c-118">Dans de nombreux cas, CQRS est lié à des scénarios plus avancés, comme disposer d’une base de données physique différente pour les lectures (requêtes) et pour les écritures (mises à jour).</span><span class="sxs-lookup"><span data-stu-id="3541c-118">In many cases, CQRS is related to more advanced scenarios, like having a different physical database for reads (queries) than for writes (updates).</span></span> <span data-ttu-id="3541c-119">De plus, un système CQRS plus évolué peut implémenter la fonctionnalité d’[Event Sourcing ](https://martinfowler.com/eaaDev/EventSourcing.html) (approvisionnement d’événements) pour votre base de données de mises à jour, de sorte que vous ne stockez que les événements du modèle de domaine au lieu de stocker les données d’état actuel.</span><span class="sxs-lookup"><span data-stu-id="3541c-119">Moreover, a more evolved CQRS system might implement [Event-Sourcing (ES)](https://martinfowler.com/eaaDev/EventSourcing.html) for your updates database, so you would only store events in the domain model instead of storing the current-state data.</span></span> <span data-ttu-id="3541c-120">Toutefois, cette approche n’est pas utilisée dans ce guide.</span><span class="sxs-lookup"><span data-stu-id="3541c-120">However, this approach is not used in this guide.</span></span> <span data-ttu-id="3541c-121">Ce guide utilise l’approche CQRS la plus simple, qui consiste simplement à séparer les requêtes des commandes.</span><span class="sxs-lookup"><span data-stu-id="3541c-121">This guide uses the simplest CQRS approach, which consists of just separating the queries from the commands.</span></span>

<span data-ttu-id="3541c-122">L’aspect de séparation de CQRS est obtenu en regroupant les opérations de requête dans une couche et les commandes dans une autre couche.</span><span class="sxs-lookup"><span data-stu-id="3541c-122">The separation aspect of CQRS is achieved by grouping query operations in one layer and commands in another layer.</span></span> <span data-ttu-id="3541c-123">Chaque couche a son propre modèle de données (notez que nous disons « modèle », pas nécessairement une base de données différente) et est construite à l’aide de sa propre combinaison de modèles et de technologies.</span><span class="sxs-lookup"><span data-stu-id="3541c-123">Each layer has its own data model (note that we say model, not necessarily a different database) and is built using its own combination of patterns and technologies.</span></span> <span data-ttu-id="3541c-124">Plus important encore, les deux couches peuvent se trouver dans le même niveau ou microservice, comme dans l’exemple (microservice de commandes) utilisé dans ce guide.</span><span class="sxs-lookup"><span data-stu-id="3541c-124">More importantly, the two layers can be within the same tier or microservice, as in the example (ordering microservice) used for this guide.</span></span> <span data-ttu-id="3541c-125">Elles peuvent également être implémentées sur des microservices ou processus différents afin de pouvoir être optimisées et adaptées séparément sans s’affecter mutuellement.</span><span class="sxs-lookup"><span data-stu-id="3541c-125">Or they could be implemented on different microservices or processes so they can be optimized and scaled out separately without affecting one another.</span></span>

<span data-ttu-id="3541c-126">CQRS implique d’avoir deux objets pour une opération de lecture/écriture où, dans d’autres contextes, il y en a un.</span><span class="sxs-lookup"><span data-stu-id="3541c-126">CQRS means having two objects for a read/write operation where in other contexts there is one.</span></span> <span data-ttu-id="3541c-127">Il existe des raisons d’avoir une base de données de lectures dénormalisée, sur laquelle vous pouvez obtenir des informations dans une documentation CQRS plus avancée.</span><span class="sxs-lookup"><span data-stu-id="3541c-127">There are reasons to have a denormalized reads database, which you can learn about in more advanced CQRS literature.</span></span> <span data-ttu-id="3541c-128">Mais nous n’utilisons pas cette approche ici, où l’objectif est d’avoir plus de souplesse dans les requêtes, et non pas de limiter les requêtes avec des contraintes à partir de modèles DDD comme les agrégats.</span><span class="sxs-lookup"><span data-stu-id="3541c-128">But we are not using that approach here, where the goal is to have more flexibility in the queries instead of limiting the queries with constraints from DDD patterns like aggregates.</span></span>

<span data-ttu-id="3541c-129">Il peut s’agir, par exemple, du microservice de commandes de l’application de référence eShopOnContainers.</span><span class="sxs-lookup"><span data-stu-id="3541c-129">An example of this kind of service is the ordering microservice from the eShopOnContainers reference application.</span></span> <span data-ttu-id="3541c-130">Ce service implémente un microservice basé sur une approche CQRS simplifiée.</span><span class="sxs-lookup"><span data-stu-id="3541c-130">This service implements a microservice based on a simplified CQRS approach.</span></span> <span data-ttu-id="3541c-131">Il utilise une seule source de données ou base de données, mais deux modèles logiques plus des modèles DDD pour le domaine transactionnel, comme illustré dans la figure 7-2.</span><span class="sxs-lookup"><span data-stu-id="3541c-131">It uses a single data source or database, but two logical models plus DDD patterns for the transactional domain, as shown in Figure 7-2.</span></span>

![Diagramme affichant un microservice simplifié de CQRS et de DDD de haut niveau.](./media/apply-simplified-microservice-cqrs-ddd-patterns/simplified-cqrs-ddd-microservice.png)

<span data-ttu-id="3541c-133">**Figure 7-2**.</span><span class="sxs-lookup"><span data-stu-id="3541c-133">**Figure 7-2**.</span></span> <span data-ttu-id="3541c-134">Microservice basé sur les modèles CQRS et DDD simplifiés</span><span class="sxs-lookup"><span data-stu-id="3541c-134">Simplified CQRS- and DDD-based microservice</span></span>

<span data-ttu-id="3541c-135">Le microservice logique de « commande » comprend sa base de données de commande, qui peut être, mais n’a pas besoin d’être, le même hôte Docker.</span><span class="sxs-lookup"><span data-stu-id="3541c-135">The Logical "Ordering" Microservice includes its Ordering database, which can be, but doesn't have to be, the same Docker host.</span></span> <span data-ttu-id="3541c-136">Le fait d’avoir la base de données dans le même hôte Docker est parfait pour le développement, mais pas pour la production.</span><span class="sxs-lookup"><span data-stu-id="3541c-136">Having the database in the same Docker host is good for development, but not for production.</span></span>

<span data-ttu-id="3541c-137">La couche Application peut être l’API web elle-même.</span><span class="sxs-lookup"><span data-stu-id="3541c-137">The application layer can be the Web API itself.</span></span> <span data-ttu-id="3541c-138">Ici, l’aspect important de la conception est que le microservice a séparé les requêtes et les ViewModels (modèles de données spécialement créés pour les applications clientes) des commandes, du modèle de domaine et des transactions suivant le modèle CQRS.</span><span class="sxs-lookup"><span data-stu-id="3541c-138">The important design aspect here is that the microservice has split the queries and ViewModels (data models especially created for the client applications) from the commands, domain model, and transactions following the CQRS pattern.</span></span> <span data-ttu-id="3541c-139">Avec cette approche, les requêtes restent indépendantes des restrictions et des contraintes provenant de modèles DDD qui conviennent uniquement pour les transactions et les mises à jour, comme expliqué dans des sections ultérieures.</span><span class="sxs-lookup"><span data-stu-id="3541c-139">This approach keeps the queries independent from restrictions and constraints coming from DDD patterns that only make sense for transactions and updates, as explained in later sections.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="3541c-140">Ressources supplémentaires</span><span class="sxs-lookup"><span data-stu-id="3541c-140">Additional resources</span></span>

- <span data-ttu-id="3541c-141">**Greg Young. Version dans un système source d’événements** (Gratuit pour lire e-book en ligne)</span><span class="sxs-lookup"><span data-stu-id="3541c-141">**Greg Young. Versioning in an Event Sourced System** (Free to read online e-book) \</span></span>
   <https://leanpub.com/esversioning/read>

>[!div class="step-by-step"]
><span data-ttu-id="3541c-142">[Suivant précédent](index.md)
>[Next](eshoponcontainers-cqrs-ddd-microservice.md)</span><span class="sxs-lookup"><span data-stu-id="3541c-142">[Previous](index.md)
[Next](eshoponcontainers-cqrs-ddd-microservice.md)</span></span>
