---
title: Chaînage de tâches à l’aide de tâches de continuation
description: Apprenez à chaîner des tâches à l’aide de tâches de continuation dans .NET. Une tâche de continuation est une tâche asynchrone appelée par une autre tâche.
ms.date: 01/06/2021
dev_langs:
- csharp
- vb
helpviewer_keywords:
- tasks, continuations
ms.assetid: 0b45e9a2-de28-46ce-8212-1817280ed42d
ms.openlocfilehash: c42b6ef7b72cec1846517c700ab6ed34046ed7de
ms.sourcegitcommit: 5d9cee27d9ffe8f5670e5f663434511e81b8ac38
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/08/2021
ms.locfileid: "98025418"
---
# <a name="chaining-tasks-using-continuation-tasks"></a><span data-ttu-id="31f28-104">Chaînage de tâches à l’aide de tâches de continuation</span><span class="sxs-lookup"><span data-stu-id="31f28-104">Chaining tasks using continuation tasks</span></span>

<span data-ttu-id="31f28-105">En programmation asynchrone, il est courant pour une opération asynchrone, à l’achèvement, d’appeler une deuxième opération.</span><span class="sxs-lookup"><span data-stu-id="31f28-105">In asynchronous programming, it's common for one asynchronous operation, on completion, to invoke a second operation.</span></span> <span data-ttu-id="31f28-106">Les continuations autorisent les opérations descendance à consommer les résultats de la première opération.</span><span class="sxs-lookup"><span data-stu-id="31f28-106">Continuations allow decedent operations to consume the results of the first operation.</span></span> <span data-ttu-id="31f28-107">Habituellement, les continuations se faisaient à l’aide de méthodes de rappel.</span><span class="sxs-lookup"><span data-stu-id="31f28-107">Traditionally, continuations have been done by using callback methods.</span></span> <span data-ttu-id="31f28-108">Dans la bibliothèque parallèle de tâches, les mêmes fonctionnalités sont fournies par les _tâches de continuation_.</span><span class="sxs-lookup"><span data-stu-id="31f28-108">In the Task Parallel Library, the same functionality is provided by _continuation tasks_.</span></span> <span data-ttu-id="31f28-109">Une tâche de continuation (également appelée continuation) est une tâche asynchrone appelée par une autre tâche, appelée _antécédent_, lorsque l’antécédent se termine.</span><span class="sxs-lookup"><span data-stu-id="31f28-109">A continuation task (also known just as a continuation) is an asynchronous task that's invoked by another task, known as the _antecedent_, when the antecedent finishes.</span></span>

<span data-ttu-id="31f28-110">Les continuations sont relativement faciles à utiliser, tout en étant puissantes et flexibles.</span><span class="sxs-lookup"><span data-stu-id="31f28-110">Continuations are relatively easy to use, but are nevertheless powerful and flexible.</span></span> <span data-ttu-id="31f28-111">Par exemple, vous pouvez :</span><span class="sxs-lookup"><span data-stu-id="31f28-111">For example, you can:</span></span>

- <span data-ttu-id="31f28-112">passer des données de l'antécédent à la continuation ;</span><span class="sxs-lookup"><span data-stu-id="31f28-112">Pass data from the antecedent to the continuation.</span></span>
- <span data-ttu-id="31f28-113">spécifier les conditions précises sous lesquelles la continuation doit être ou non appelée ;</span><span class="sxs-lookup"><span data-stu-id="31f28-113">Specify the precise conditions under which the continuation will be invoked or not invoked.</span></span>
- <span data-ttu-id="31f28-114">annuler une continuation avant qu'elle ne soit lancée ou pendant son exécution de manière coopérative ;</span><span class="sxs-lookup"><span data-stu-id="31f28-114">Cancel a continuation either before it starts or cooperatively as it is running.</span></span>
- <span data-ttu-id="31f28-115">fournir des conseils sur la manière de planifier la continuation ;</span><span class="sxs-lookup"><span data-stu-id="31f28-115">Provide hints about how the continuation should be scheduled.</span></span>
- <span data-ttu-id="31f28-116">appeler plusieurs continuations depuis le même antécédent ;</span><span class="sxs-lookup"><span data-stu-id="31f28-116">Invoke multiple continuations from the same antecedent.</span></span>
- <span data-ttu-id="31f28-117">appeler une continuation quand certains ou tous les antécédents se terminent ;</span><span class="sxs-lookup"><span data-stu-id="31f28-117">Invoke one continuation when all or any one of multiple antecedents complete.</span></span>
- <span data-ttu-id="31f28-118">chaîner des continuations les unes à la suite des autres à une longueur arbitraire ;</span><span class="sxs-lookup"><span data-stu-id="31f28-118">Chain continuations one after another to any arbitrary length.</span></span>
- <span data-ttu-id="31f28-119">utiliser une continuation pour gérer des exceptions levées par l'antécédent.</span><span class="sxs-lookup"><span data-stu-id="31f28-119">Use a continuation to handle exceptions thrown by the antecedent.</span></span>

## <a name="about-continuations"></a><span data-ttu-id="31f28-120">À propos des continuations</span><span class="sxs-lookup"><span data-stu-id="31f28-120">About continuations</span></span>

<span data-ttu-id="31f28-121">Une continuation est une tâche qui est créée dans l'état <xref:System.Threading.Tasks.TaskStatus.WaitingForActivation> .</span><span class="sxs-lookup"><span data-stu-id="31f28-121">A continuation is a task that is created in the <xref:System.Threading.Tasks.TaskStatus.WaitingForActivation> state.</span></span> <span data-ttu-id="31f28-122">Elle est automatiquement activée à la fin de la tâche ou des tâches de son antécédent.</span><span class="sxs-lookup"><span data-stu-id="31f28-122">It is activated automatically when its antecedent task or tasks complete.</span></span> <span data-ttu-id="31f28-123">Appeler <xref:System.Threading.Tasks.Task.Start%2A?displayProperty=nameWithType> sur une continuation dans le code utilisateur lève une exception <xref:System.InvalidOperationException?displayProperty=nameWithType> .</span><span class="sxs-lookup"><span data-stu-id="31f28-123">Calling <xref:System.Threading.Tasks.Task.Start%2A?displayProperty=nameWithType> on a continuation in user code throws an <xref:System.InvalidOperationException?displayProperty=nameWithType> exception.</span></span>

<span data-ttu-id="31f28-124">Une continuation est un <xref:System.Threading.Tasks.Task> et ne bloque pas le thread sur lequel elle a démarré.</span><span class="sxs-lookup"><span data-stu-id="31f28-124">A continuation is itself a <xref:System.Threading.Tasks.Task> and does not block the thread on which it is started.</span></span> <span data-ttu-id="31f28-125">Appelez la méthode <xref:System.Threading.Tasks.Task.Wait%2A?displayProperty=nameWithType> pour bloquer jusqu'à ce que la tâche de continuation se termine.</span><span class="sxs-lookup"><span data-stu-id="31f28-125">Call the <xref:System.Threading.Tasks.Task.Wait%2A?displayProperty=nameWithType> method to block until the continuation task finishes.</span></span>

## <a name="create-a-continuation-for-a-single-antecedent"></a><span data-ttu-id="31f28-126">Créer une continuation pour un seul antécédent</span><span class="sxs-lookup"><span data-stu-id="31f28-126">Create a continuation for a single antecedent</span></span>

<span data-ttu-id="31f28-127">Vous créez une continuation qui s'exécute quand son antécédent est terminé en appelant la méthode <xref:System.Threading.Tasks.Task.ContinueWith%2A?displayProperty=nameWithType> .</span><span class="sxs-lookup"><span data-stu-id="31f28-127">You create a continuation that executes when its antecedent has completed by calling the <xref:System.Threading.Tasks.Task.ContinueWith%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="31f28-128">L’exemple suivant montre le modèle de base (pour plus de clarté, la gestion des exceptions a été omise).</span><span class="sxs-lookup"><span data-stu-id="31f28-128">The following example shows the basic pattern (for clarity, exception handling is omitted).</span></span> <span data-ttu-id="31f28-129">Il exécute une tâche d'antécédent, `taskA`, qui retourne un objet <xref:System.DayOfWeek> indiquant le jour actuel de la semaine.</span><span class="sxs-lookup"><span data-stu-id="31f28-129">It executes an antecedent task, `taskA`, that returns a <xref:System.DayOfWeek> object that indicates the name of the current day of the week.</span></span> <span data-ttu-id="31f28-130">Quand l’antécédent termine, la tâche de continuation, `continuation`, le récupère et affiche une chaîne qui comprend son résultat.</span><span class="sxs-lookup"><span data-stu-id="31f28-130">When the antecedent completes, the continuation task, `continuation`, is passed the antecedent and displays a string that includes its result.</span></span>

> [!NOTE]
> <span data-ttu-id="31f28-131">Les exemples en C# fournis dans cet article utilisent le modificateur `async` sur la méthode `Main`.</span><span class="sxs-lookup"><span data-stu-id="31f28-131">The C# samples in this article make use of the `async` modifier on the `Main` method.</span></span> <span data-ttu-id="31f28-132">Cette fonctionnalité est disponible dans les versions 7.1 et ultérieures de C#.</span><span class="sxs-lookup"><span data-stu-id="31f28-132">That feature is available in C# 7.1 and later.</span></span> <span data-ttu-id="31f28-133">Les versions précédentes ont été générées [`CS5001`](../../csharp/misc/cs5001.md) lors de la compilation de cet exemple de code.</span><span class="sxs-lookup"><span data-stu-id="31f28-133">Previous versions generate [`CS5001`](../../csharp/misc/cs5001.md) when compiling this sample code.</span></span> <span data-ttu-id="31f28-134">Vous devez définir la version du langage sur C# 7.1 ou une version ultérieure.</span><span class="sxs-lookup"><span data-stu-id="31f28-134">You'll need to set the language version to C# 7.1 or newer.</span></span> <span data-ttu-id="31f28-135">Pour savoir comment configurer la version du langage, consultez l’article sur la [configuration de la version du langage](../../csharp/language-reference/configure-language-version.md).</span><span class="sxs-lookup"><span data-stu-id="31f28-135">You can learn how to configure the language version in the article on [configure language version](../../csharp/language-reference/configure-language-version.md).</span></span>

:::code language="csharp" source="snippets/cs/simple1.cs":::

[!code-vb[TPL_Continuations#1](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_continuations/vb/simple1.vb#1)]

## <a name="create-a-continuation-for-multiple-antecedents"></a><span data-ttu-id="31f28-136">Créer une continuation pour plusieurs antécédents</span><span class="sxs-lookup"><span data-stu-id="31f28-136">Create a continuation for multiple antecedents</span></span>

<span data-ttu-id="31f28-137">Vous pouvez également créer une continuation qui s’exécute quand tout ou partie d’un groupe de tâches est terminé.</span><span class="sxs-lookup"><span data-stu-id="31f28-137">You can also create a continuation that will run when any or all of a group of tasks has completed.</span></span> <span data-ttu-id="31f28-138">Pour exécuter une continuation quand toutes les tâches d'antécédent sont terminées, vous appelez la méthode statique`Shared` ( <xref:System.Threading.Tasks.Task.WhenAll%2A?displayProperty=nameWithType> en Visual Basic) ou la méthode <xref:System.Threading.Tasks.TaskFactory.ContinueWhenAll%2A?displayProperty=nameWithType> d'instance.</span><span class="sxs-lookup"><span data-stu-id="31f28-138">To execute a continuation when all antecedent tasks have completed, you call the static (`Shared` in Visual Basic) <xref:System.Threading.Tasks.Task.WhenAll%2A?displayProperty=nameWithType> method or the instance <xref:System.Threading.Tasks.TaskFactory.ContinueWhenAll%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="31f28-139">Pour exécuter une continuation quand n'importe quelle tâche d'antécédent est terminée, vous appelez la méthode statique`Shared` ( <xref:System.Threading.Tasks.Task.WhenAny%2A?displayProperty=nameWithType> en Visual Basic) ou la méthode <xref:System.Threading.Tasks.TaskFactory.ContinueWhenAny%2A?displayProperty=nameWithType> d'instance.</span><span class="sxs-lookup"><span data-stu-id="31f28-139">To execute a continuation when any of the antecedent tasks has completed, you call the static (`Shared` in Visual Basic) <xref:System.Threading.Tasks.Task.WhenAny%2A?displayProperty=nameWithType> method or the instance <xref:System.Threading.Tasks.TaskFactory.ContinueWhenAny%2A?displayProperty=nameWithType> method.</span></span>

<span data-ttu-id="31f28-140">Les appels aux <xref:System.Threading.Tasks.Task.WhenAll%2A?displayProperty=nameWithType> <xref:System.Threading.Tasks.Task.WhenAny%2A?displayProperty=nameWithType> surcharges et ne bloquent pas le thread appelant.</span><span class="sxs-lookup"><span data-stu-id="31f28-140">Calls to the <xref:System.Threading.Tasks.Task.WhenAll%2A?displayProperty=nameWithType> and <xref:System.Threading.Tasks.Task.WhenAny%2A?displayProperty=nameWithType> overloads do not block the calling thread.</span></span> <span data-ttu-id="31f28-141">Toutefois, vous appelez généralement toutes les <xref:System.Threading.Tasks.Task.WhenAll%28System.Collections.Generic.IEnumerable%7BSystem.Threading.Tasks.Task%7D%29?displayProperty=nameWithType> méthodes sauf et <xref:System.Threading.Tasks.Task.WhenAll%28System.Threading.Tasks.Task%5B%5D%29?displayProperty=nameWithType> pour récupérer la propriété retournée <xref:System.Threading.Tasks.Task%601.Result%2A?displayProperty=nameWithType> , ce qui bloque le thread appelant.</span><span class="sxs-lookup"><span data-stu-id="31f28-141">However, you typically call all but the <xref:System.Threading.Tasks.Task.WhenAll%28System.Collections.Generic.IEnumerable%7BSystem.Threading.Tasks.Task%7D%29?displayProperty=nameWithType> and <xref:System.Threading.Tasks.Task.WhenAll%28System.Threading.Tasks.Task%5B%5D%29?displayProperty=nameWithType> methods to retrieve the returned <xref:System.Threading.Tasks.Task%601.Result%2A?displayProperty=nameWithType> property, which does block the calling thread.</span></span>

<span data-ttu-id="31f28-142">L’exemple suivant appelle la méthode <xref:System.Threading.Tasks.Task.WhenAll%28System.Collections.Generic.IEnumerable%7BSystem.Threading.Tasks.Task%7D%29?displayProperty=nameWithType> pour créer une tâche de continuation qui reflète les résultats de ses dix tâches d’antécédent.</span><span class="sxs-lookup"><span data-stu-id="31f28-142">The following example calls the <xref:System.Threading.Tasks.Task.WhenAll%28System.Collections.Generic.IEnumerable%7BSystem.Threading.Tasks.Task%7D%29?displayProperty=nameWithType> method to create a continuation task that reflects the results of its 10 antecedent tasks.</span></span> <span data-ttu-id="31f28-143">Chaque tâche d’antécédent élève au carré une valeur d’index allant de 1 à 10.</span><span class="sxs-lookup"><span data-stu-id="31f28-143">Each antecedent task squares an index value that ranges from one to 10.</span></span> <span data-ttu-id="31f28-144">Si les antécédents se terminent correctement (leur propriété <xref:System.Threading.Tasks.Task.Status%2A?displayProperty=nameWithType> vaut <xref:System.Threading.Tasks.TaskStatus.RanToCompletion?displayProperty=nameWithType>), la propriété <xref:System.Threading.Tasks.Task%601.Result%2A?displayProperty=nameWithType> de la continuation est un tableau de valeurs <xref:System.Threading.Tasks.Task%601.Result%2A?displayProperty=nameWithType> retournées par chaque antécédent.</span><span class="sxs-lookup"><span data-stu-id="31f28-144">If the antecedents complete successfully (their <xref:System.Threading.Tasks.Task.Status%2A?displayProperty=nameWithType> property is <xref:System.Threading.Tasks.TaskStatus.RanToCompletion?displayProperty=nameWithType>), the <xref:System.Threading.Tasks.Task%601.Result%2A?displayProperty=nameWithType> property of the continuation is an array of the <xref:System.Threading.Tasks.Task%601.Result%2A?displayProperty=nameWithType> values returned by each antecedent.</span></span> <span data-ttu-id="31f28-145">L’exemple les ajoute pour calculer la somme des carrés de tous les nombres compris entre 1 et 10.</span><span class="sxs-lookup"><span data-stu-id="31f28-145">The example adds them to compute the sum of squares for all numbers between one and 10.</span></span>

:::code language="csharp" source="snippets/cs/whenall1.cs":::

[!code-vb[TPL_Continuations#5](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_continuations/vb/whenall1.vb#5)]

## <a name="continuation-options"></a><span data-ttu-id="31f28-146">Options de continuation</span><span class="sxs-lookup"><span data-stu-id="31f28-146">Continuation options</span></span>

<span data-ttu-id="31f28-147">Quand vous créez une continuation de tâche unique, vous pouvez utiliser une surcharge <xref:System.Threading.Tasks.Task.ContinueWith%2A> qui prend une valeur d'énumération <xref:System.Threading.Tasks.TaskContinuationOptions?displayProperty=nameWithType> pour spécifier les conditions sous lesquelles la continuation doit se lancer.</span><span class="sxs-lookup"><span data-stu-id="31f28-147">When you create a single-task continuation, you can use a <xref:System.Threading.Tasks.Task.ContinueWith%2A> overload that takes a <xref:System.Threading.Tasks.TaskContinuationOptions?displayProperty=nameWithType> enumeration value to specify the conditions under which the continuation starts.</span></span> <span data-ttu-id="31f28-148">Par exemple, vous pouvez spécifier que la continuation doit être exécutée uniquement si l‘antécédent se termine correctement ou uniquement s‘il se termine avec un état d‘erreur.</span><span class="sxs-lookup"><span data-stu-id="31f28-148">For example, you can specify that the continuation is to run only if the antecedent completes successfully, or only if it completes in a faulted state.</span></span> <span data-ttu-id="31f28-149">Si cette condition n’est pas remplie quand l’antécédent est prêt à appeler la continuation, la continuation passe directement à l’état <xref:System.Threading.Tasks.TaskStatus.Canceled?displayProperty=nameWithType> et ne peut donc pas être lancée.</span><span class="sxs-lookup"><span data-stu-id="31f28-149">If the condition is not true when the antecedent is ready to invoke the continuation, the continuation transitions directly to the <xref:System.Threading.Tasks.TaskStatus.Canceled?displayProperty=nameWithType> state and subsequently cannot be started.</span></span>

<span data-ttu-id="31f28-150">Plusieurs méthodes de continuation multitâche, telles que les surcharges de la méthode <xref:System.Threading.Tasks.TaskFactory.ContinueWhenAll%2A?displayProperty=nameWithType> , incluent également un paramètre <xref:System.Threading.Tasks.TaskContinuationOptions?displayProperty=nameWithType> .</span><span class="sxs-lookup"><span data-stu-id="31f28-150">A number of multi-task continuation methods, such as overloads of the <xref:System.Threading.Tasks.TaskFactory.ContinueWhenAll%2A?displayProperty=nameWithType> method, also include a <xref:System.Threading.Tasks.TaskContinuationOptions?displayProperty=nameWithType> parameter.</span></span> <span data-ttu-id="31f28-151">Seul un sous-ensemble des membres de l'énumération <xref:System.Threading.Tasks.TaskContinuationOptions?displayProperty=nameWithType> est valide, toutefois.</span><span class="sxs-lookup"><span data-stu-id="31f28-151">Only a subset of all <xref:System.Threading.Tasks.TaskContinuationOptions?displayProperty=nameWithType> enumeration members are valid, however.</span></span> <span data-ttu-id="31f28-152">Vous pouvez spécifier des valeurs <xref:System.Threading.Tasks.TaskContinuationOptions?displayProperty=nameWithType> qui ont des équivalents dans l'énumération <xref:System.Threading.Tasks.TaskCreationOptions?displayProperty=nameWithType> , telles que <xref:System.Threading.Tasks.TaskContinuationOptions.AttachedToParent?displayProperty=nameWithType>, <xref:System.Threading.Tasks.TaskContinuationOptions.LongRunning?displayProperty=nameWithType>et <xref:System.Threading.Tasks.TaskContinuationOptions.PreferFairness?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="31f28-152">You can specify <xref:System.Threading.Tasks.TaskContinuationOptions?displayProperty=nameWithType> values that have counterparts in the <xref:System.Threading.Tasks.TaskCreationOptions?displayProperty=nameWithType> enumeration, such as <xref:System.Threading.Tasks.TaskContinuationOptions.AttachedToParent?displayProperty=nameWithType>, <xref:System.Threading.Tasks.TaskContinuationOptions.LongRunning?displayProperty=nameWithType>, and <xref:System.Threading.Tasks.TaskContinuationOptions.PreferFairness?displayProperty=nameWithType>.</span></span> <span data-ttu-id="31f28-153">Si vous spécifiez n'importe laquelle des options `NotOn` ou `OnlyOn` avec une continuation multitâche, une exception <xref:System.ArgumentOutOfRangeException> est levée au moment de l'exécution.</span><span class="sxs-lookup"><span data-stu-id="31f28-153">If you specify any of the `NotOn` or `OnlyOn` options with a multi-task continuation, an <xref:System.ArgumentOutOfRangeException> exception will be thrown at run time.</span></span>

<span data-ttu-id="31f28-154">Pour plus d'informations sur les options de continuation de tâche, consultez la rubrique <xref:System.Threading.Tasks.TaskContinuationOptions> .</span><span class="sxs-lookup"><span data-stu-id="31f28-154">For more information on task continuation options, see the <xref:System.Threading.Tasks.TaskContinuationOptions> topic.</span></span>

## <a name="pass-data-to-a-continuation"></a><span data-ttu-id="31f28-155">Passer des données à une continuation</span><span class="sxs-lookup"><span data-stu-id="31f28-155">Pass data to a continuation</span></span>

<span data-ttu-id="31f28-156">La méthode <xref:System.Threading.Tasks.Task.ContinueWith%2A?displayProperty=nameWithType> passe une référence à l'antécédent au délégué d'utilisateur de la continuation en tant qu'argument.</span><span class="sxs-lookup"><span data-stu-id="31f28-156">The <xref:System.Threading.Tasks.Task.ContinueWith%2A?displayProperty=nameWithType> method passes a reference to the antecedent to the user delegate of the continuation as an argument.</span></span> <span data-ttu-id="31f28-157">Si l'antécédent est un objet <xref:System.Threading.Tasks.Task%601?displayProperty=nameWithType> et que la tâche s'est exécutée normalement jusqu'à son terme, la continuation peut accéder à la propriété <xref:System.Threading.Tasks.Task%601.Result%2A?displayProperty=nameWithType> de la tâche.</span><span class="sxs-lookup"><span data-stu-id="31f28-157">If the antecedent is a <xref:System.Threading.Tasks.Task%601?displayProperty=nameWithType> object, and the task ran until it was completed, then the continuation can access the <xref:System.Threading.Tasks.Task%601.Result%2A?displayProperty=nameWithType> property of the task.</span></span>

<span data-ttu-id="31f28-158">La propriété <xref:System.Threading.Tasks.Task%601.Result%2A?displayProperty=nameWithType> se bloque jusqu'à ce que la tâche soit terminée.</span><span class="sxs-lookup"><span data-stu-id="31f28-158">The <xref:System.Threading.Tasks.Task%601.Result%2A?displayProperty=nameWithType> property blocks until the task has completed.</span></span> <span data-ttu-id="31f28-159">Toutefois, si la tâche a été annulée ou a rencontré une erreur, toute tentative d'accéder à la propriété <xref:System.Threading.Tasks.Task%601.Result%2A> lève une exception <xref:System.AggregateException> .</span><span class="sxs-lookup"><span data-stu-id="31f28-159">However, if the task was canceled or faulted, attempting to access the <xref:System.Threading.Tasks.Task%601.Result%2A> property throws an <xref:System.AggregateException> exception.</span></span> <span data-ttu-id="31f28-160">Vous pouvez éviter ce problème à l'aide de l'option <xref:System.Threading.Tasks.TaskContinuationOptions.OnlyOnRanToCompletion> , comme indiqué dans l'exemple suivant.</span><span class="sxs-lookup"><span data-stu-id="31f28-160">You can avoid this problem by using the <xref:System.Threading.Tasks.TaskContinuationOptions.OnlyOnRanToCompletion> option, as shown in the following example.</span></span>

:::code language="csharp" source="snippets/cs/result1.cs":::

[!code-vb[TPL_Continuations#2](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_continuations/vb/result1.vb#2)]

<span data-ttu-id="31f28-161">Si vous voulez que la continuation s‘exécute même si l‘exécution de l‘antécédent n‘est pas correctement terminée, vous devez vous attendre à des exceptions.</span><span class="sxs-lookup"><span data-stu-id="31f28-161">If you want the continuation to run even if the antecedent did not run to successful completion, you must guard against the exception.</span></span> <span data-ttu-id="31f28-162">Une approche consiste à tester la propriété <xref:System.Threading.Tasks.Task.Status%2A?displayProperty=nameWithType> de l'antécédent et à n'essayer d'accéder à la propriété <xref:System.Threading.Tasks.Task%601.Result%2A> que si l'état n'est pas <xref:System.Threading.Tasks.TaskStatus.Faulted> ou <xref:System.Threading.Tasks.TaskStatus.Canceled>.</span><span class="sxs-lookup"><span data-stu-id="31f28-162">One approach is to test the <xref:System.Threading.Tasks.Task.Status%2A?displayProperty=nameWithType> property of the antecedent, and only attempt to access the <xref:System.Threading.Tasks.Task%601.Result%2A> property if the status is not <xref:System.Threading.Tasks.TaskStatus.Faulted> or <xref:System.Threading.Tasks.TaskStatus.Canceled>.</span></span> <span data-ttu-id="31f28-163">Vous pouvez également examiner la propriété <xref:System.Threading.Tasks.Task.Exception%2A> de l'antécédent.</span><span class="sxs-lookup"><span data-stu-id="31f28-163">You can also examine the <xref:System.Threading.Tasks.Task.Exception%2A> property of the antecedent.</span></span> <span data-ttu-id="31f28-164">Pour plus d’informations, consultez l’article [Gestion des exceptions](exception-handling-task-parallel-library.md).</span><span class="sxs-lookup"><span data-stu-id="31f28-164">For more information, see [Exception Handling](exception-handling-task-parallel-library.md).</span></span> <span data-ttu-id="31f28-165">L'exemple suivant modifie l'exemple précédent de manière à n'accéder à la propriété <xref:System.Threading.Tasks.Task%601.Result%2A?displayProperty=nameWithType> de l'antécédent que si son état est <xref:System.Threading.Tasks.TaskStatus.RanToCompletion?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="31f28-165">The following example modifies the previous example to access antecedent's <xref:System.Threading.Tasks.Task%601.Result%2A?displayProperty=nameWithType> property only if its status is <xref:System.Threading.Tasks.TaskStatus.RanToCompletion?displayProperty=nameWithType>.</span></span>

:::code language="csharp" source="snippets/cs/result2.cs":::

[!code-vb[TPL_Continuations#7](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_continuations/vb/result2.vb#7)]

## <a name="cancel-a-continuation"></a><span data-ttu-id="31f28-166">Annuler une continuation</span><span class="sxs-lookup"><span data-stu-id="31f28-166">Cancel a continuation</span></span>

<span data-ttu-id="31f28-167">La propriété <xref:System.Threading.Tasks.Task.Status%2A?displayProperty=nameWithType> d'une continuation est définie sur <xref:System.Threading.Tasks.TaskStatus.Canceled?displayProperty=nameWithType> dans les situations suivantes :</span><span class="sxs-lookup"><span data-stu-id="31f28-167">The <xref:System.Threading.Tasks.Task.Status%2A?displayProperty=nameWithType> property of a continuation is set to <xref:System.Threading.Tasks.TaskStatus.Canceled?displayProperty=nameWithType> in the following situations:</span></span>

- <span data-ttu-id="31f28-168">Elle lève une exception <xref:System.OperationCanceledException> en réponse à une demande d'annulation.</span><span class="sxs-lookup"><span data-stu-id="31f28-168">It throws an <xref:System.OperationCanceledException> exception in response to a cancellation request.</span></span> <span data-ttu-id="31f28-169">Comme pour toute tâche, si l’exception contient le même jeton qui a été passé à la continuation, elle est traitée comme un accusé de réception de l’annulation coopérative.</span><span class="sxs-lookup"><span data-stu-id="31f28-169">As with any task, if the exception contains the same token that was passed to the continuation, it is treated as an acknowledgment of cooperative cancellation.</span></span>
- <span data-ttu-id="31f28-170">La continuation récupère un <xref:System.Threading.CancellationToken?displayProperty=nameWithType> dont la propriété <xref:System.Threading.CancellationToken.IsCancellationRequested%2A> a pour valeur `true`.</span><span class="sxs-lookup"><span data-stu-id="31f28-170">The continuation is passed a <xref:System.Threading.CancellationToken?displayProperty=nameWithType> whose <xref:System.Threading.CancellationToken.IsCancellationRequested%2A> property is `true`.</span></span> <span data-ttu-id="31f28-171">Dans ce cas, la continuation ne démarre pas, et elle passe à l'état <xref:System.Threading.Tasks.TaskStatus.Canceled?displayProperty=nameWithType> .</span><span class="sxs-lookup"><span data-stu-id="31f28-171">In this case, the continuation does not start, and it transitions to the <xref:System.Threading.Tasks.TaskStatus.Canceled?displayProperty=nameWithType> state.</span></span>
- <span data-ttu-id="31f28-172">La continuation ne s'exécute jamais, car la condition définie par son argument <xref:System.Threading.Tasks.TaskContinuationOptions> n'a pas été remplie.</span><span class="sxs-lookup"><span data-stu-id="31f28-172">The continuation never runs because the condition set by its <xref:System.Threading.Tasks.TaskContinuationOptions> argument was not met.</span></span> <span data-ttu-id="31f28-173">Par exemple, si un antécédent passe à l'état <xref:System.Threading.Tasks.TaskStatus.Faulted?displayProperty=nameWithType> , sa continuation qui a reçu l'option <xref:System.Threading.Tasks.TaskContinuationOptions.NotOnFaulted?displayProperty=nameWithType> ne s'exécute pas, mais passe à l'état <xref:System.Threading.Tasks.TaskStatus.Canceled> .</span><span class="sxs-lookup"><span data-stu-id="31f28-173">For example, if an antecedent goes into a <xref:System.Threading.Tasks.TaskStatus.Faulted?displayProperty=nameWithType> state, its continuation that was passed the <xref:System.Threading.Tasks.TaskContinuationOptions.NotOnFaulted?displayProperty=nameWithType> option will not run but will transition to the <xref:System.Threading.Tasks.TaskStatus.Canceled> state.</span></span>

<span data-ttu-id="31f28-174">Si une tâche et sa continuation représentent deux parties de la même opération logique, vous pouvez passer le même jeton d’annulation aux deux tâches, comme illustré dans l’exemple suivant.</span><span class="sxs-lookup"><span data-stu-id="31f28-174">If a task and its continuation represent two parts of the same logical operation, you can pass the same cancellation token to both tasks, as shown in the following example.</span></span> <span data-ttu-id="31f28-175">Ce dernier comprend un antécédent qui génère une liste d'entiers divisibles par 33, transmise ensuite à la continuation.</span><span class="sxs-lookup"><span data-stu-id="31f28-175">It consists of an antecedent that generates a list of integers that are divisible by 33, which it passes to the continuation.</span></span> <span data-ttu-id="31f28-176">À son tour, la continuation affiche la liste.</span><span class="sxs-lookup"><span data-stu-id="31f28-176">The continuation in turn displays the list.</span></span> <span data-ttu-id="31f28-177">L‘antécédent et la continuation marquent régulièrement des pauses de durée aléatoire.</span><span class="sxs-lookup"><span data-stu-id="31f28-177">Both the antecedent and the continuation pause regularly for random intervals.</span></span> <span data-ttu-id="31f28-178">En outre, un objet <xref:System.Threading.Timer?displayProperty=nameWithType> est utilisé pour exécuter la méthode `Elapsed` après un délai de cinq secondes.</span><span class="sxs-lookup"><span data-stu-id="31f28-178">In addition, a <xref:System.Threading.Timer?displayProperty=nameWithType> object is used to execute the `Elapsed` method after a five-second timeout interval.</span></span> <span data-ttu-id="31f28-179">Cet exemple appelle la méthode <xref:System.Threading.CancellationTokenSource.Cancel%2A?displayProperty=nameWithType>, ce qui amène la tâche en cours d’exécution à appeler la méthode <xref:System.Threading.CancellationToken.ThrowIfCancellationRequested%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="31f28-179">This example calls the <xref:System.Threading.CancellationTokenSource.Cancel%2A?displayProperty=nameWithType> method, which causes the currently executing task to call the <xref:System.Threading.CancellationToken.ThrowIfCancellationRequested%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="31f28-180">La durée des pauses générées de manière aléatoire détermine si la méthode <xref:System.Threading.CancellationTokenSource.Cancel%2A?displayProperty=nameWithType> est appelée pendant l'exécution de l'antécédent ou de sa continuation.</span><span class="sxs-lookup"><span data-stu-id="31f28-180">Whether the <xref:System.Threading.CancellationTokenSource.Cancel%2A?displayProperty=nameWithType> method is called when the antecedent or its continuation is executing depends on the duration of the randomly generated pauses.</span></span> <span data-ttu-id="31f28-181">Si l‘antécédent est annulé, la continuation ne démarre pas.</span><span class="sxs-lookup"><span data-stu-id="31f28-181">If the antecedent is canceled, the continuation will not start.</span></span> <span data-ttu-id="31f28-182">Si l‘antécédent n‘est pas annulé, le jeton peut toujours être utilisé pour annuler la continuation.</span><span class="sxs-lookup"><span data-stu-id="31f28-182">If the antecedent is not canceled, the token can still be used to cancel the continuation.</span></span>

:::code language="csharp" source="snippets/cs/cancellation1.cs":::

[!code-vb[TPL_Continuations#3](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_continuations/vb/cancellation1.vb#3)]

<span data-ttu-id="31f28-183">Vous pouvez également empêcher une continuation de s'exécuter si son antécédent est annulé en spécifiant l'option <xref:System.Threading.Tasks.TaskContinuationOptions.NotOnCanceled?displayProperty=nameWithType> quand vous créez la continuation, ce qui vous évite de lui fournir un jeton d'annulation.</span><span class="sxs-lookup"><span data-stu-id="31f28-183">You can also prevent a continuation from executing if its antecedent is canceled without supplying the continuation a cancellation token by specifying the <xref:System.Threading.Tasks.TaskContinuationOptions.NotOnCanceled?displayProperty=nameWithType> option when you create the continuation.</span></span> <span data-ttu-id="31f28-184">Voici un exemple simple.</span><span class="sxs-lookup"><span data-stu-id="31f28-184">The following is a simple example.</span></span>

:::code language="csharp" source="snippets/cs/cancellation2.cs":::

[!code-vb[TPL_Continuations#8](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_continuations/vb/cancellation2.vb#8)]

<span data-ttu-id="31f28-185">Une fois la continuation à l'état <xref:System.Threading.Tasks.TaskStatus.Canceled> , elle peut affecter les continuations suivantes, selon les <xref:System.Threading.Tasks.TaskContinuationOptions> spécifiés pour ces continuations.</span><span class="sxs-lookup"><span data-stu-id="31f28-185">After a continuation goes into the <xref:System.Threading.Tasks.TaskStatus.Canceled> state, it may affect continuations that follow, depending on the <xref:System.Threading.Tasks.TaskContinuationOptions> that were specified for those continuations.</span></span>

<span data-ttu-id="31f28-186">Les continuations supprimées ne seront pas lancées.</span><span class="sxs-lookup"><span data-stu-id="31f28-186">Continuations that are disposed will not start.</span></span>

## <a name="continuations-and-child-tasks"></a><span data-ttu-id="31f28-187">Continuations et tâches enfants</span><span class="sxs-lookup"><span data-stu-id="31f28-187">Continuations and child tasks</span></span>

<span data-ttu-id="31f28-188">Une continuation ne s'exécute pas tant que l'antécédent et toutes ses tâches enfants attachées ne sont pas terminés.</span><span class="sxs-lookup"><span data-stu-id="31f28-188">A continuation does not run until the antecedent and all of its attached child tasks have completed.</span></span> <span data-ttu-id="31f28-189">La continuation n'attend pas la fin des tâches enfants détachées.</span><span class="sxs-lookup"><span data-stu-id="31f28-189">The continuation does not wait for detached child tasks to finish.</span></span> <span data-ttu-id="31f28-190">Les deux exemples suivants illustrent des tâches enfants attachées à un antécédent qui crée une continuation, et détachées de celui-ci.</span><span class="sxs-lookup"><span data-stu-id="31f28-190">The following two examples illustrate child tasks that are attached to and detached from an antecedent that creates a continuation.</span></span> <span data-ttu-id="31f28-191">Dans l’exemple suivant, la continuation ne s’exécute qu’une fois toutes les tâches enfants terminées. L’exécution de l’exemple à plusieurs reprise génère systématiquement la même sortie.</span><span class="sxs-lookup"><span data-stu-id="31f28-191">In the following example, the continuation runs only after all child tasks have completed, and running the example multiple times produces identical output each time.</span></span> <span data-ttu-id="31f28-192">L’exemple lance l’antécédent en appelant la méthode <xref:System.Threading.Tasks.TaskFactory.StartNew%2A?displayProperty=nameWithType>, car par défaut la méthode <xref:System.Threading.Tasks.Task.Run%2A?displayProperty=nameWithType> crée une tâche parente dont l’option de création de tâche par défaut est <xref:System.Threading.Tasks.TaskCreationOptions.DenyChildAttach?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="31f28-192">The example launches the antecedent by calling the <xref:System.Threading.Tasks.TaskFactory.StartNew%2A?displayProperty=nameWithType> method, since by default the <xref:System.Threading.Tasks.Task.Run%2A?displayProperty=nameWithType> method creates a parent task whose default task creation option is <xref:System.Threading.Tasks.TaskCreationOptions.DenyChildAttach?displayProperty=nameWithType>.</span></span>

:::code language="csharp" source="snippets/cs/attached1.cs":::

[!code-vb[TPL_Continuations#9](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_continuations/vb/attached1.vb#9)]

<span data-ttu-id="31f28-193">Toutefois, si des tâches enfants sont détachées de l'antécédent, la continuation s'exécute dès que l'antécédent a terminé, indépendamment de l'état des tâches enfants.</span><span class="sxs-lookup"><span data-stu-id="31f28-193">If child tasks are detached from the antecedent, however, the continuation runs as soon as the antecedent has terminated, regardless of the state of the child tasks.</span></span> <span data-ttu-id="31f28-194">Ainsi, différentes exécutions de l'exemple suivant peuvent générer différentes sorties en fonction de la façon dont le Planificateur de tâches a géré chaque tâche enfant.</span><span class="sxs-lookup"><span data-stu-id="31f28-194">As a result, multiple runs of the following example can produce variable output that depends on how the task scheduler handled each child task.</span></span>

:::code language="csharp" source="snippets/cs/detached1.cs":::

[!code-vb[TPL_Continuations#10](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_continuations/vb/detached1.vb#10)]

<span data-ttu-id="31f28-195">L’état final de la tâche d’antécédent dépend de l’état final des tâches enfants attachées.</span><span class="sxs-lookup"><span data-stu-id="31f28-195">The final status of the antecedent task depends on the final status of any attached child tasks.</span></span> <span data-ttu-id="31f28-196">L’état des tâches enfants détachées n’affecte pas le parent.</span><span class="sxs-lookup"><span data-stu-id="31f28-196">The status of detached child tasks does not affect the parent.</span></span> <span data-ttu-id="31f28-197">Pour plus d'informations, consultez [Tâches enfants attachées et détachées](attached-and-detached-child-tasks.md).</span><span class="sxs-lookup"><span data-stu-id="31f28-197">For more information, see [Attached and Detached Child Tasks](attached-and-detached-child-tasks.md).</span></span>

## <a name="associate-state-with-continuations"></a><span data-ttu-id="31f28-198">Associer l’État à des continuations</span><span class="sxs-lookup"><span data-stu-id="31f28-198">Associate state with continuations</span></span>

<span data-ttu-id="31f28-199">Vous pouvez associer un état arbitraire à une continuation de tâche.</span><span class="sxs-lookup"><span data-stu-id="31f28-199">You can associate arbitrary state with a task continuation.</span></span> <span data-ttu-id="31f28-200">La méthode <xref:System.Threading.Tasks.Task.ContinueWith%2A> fournit des versions surchargées prenant chacune une valeur <xref:System.Object> qui représente l'état de la continuation.</span><span class="sxs-lookup"><span data-stu-id="31f28-200">The <xref:System.Threading.Tasks.Task.ContinueWith%2A> method provides overloaded versions that each take an <xref:System.Object> value that represents the state of the continuation.</span></span> <span data-ttu-id="31f28-201">Vous pouvez ensuite accéder à cet objet d'état à l'aide de la propriété <xref:System.Threading.Tasks.Task.AsyncState%2A?displayProperty=nameWithType> .</span><span class="sxs-lookup"><span data-stu-id="31f28-201">You can later access this state object by using the <xref:System.Threading.Tasks.Task.AsyncState%2A?displayProperty=nameWithType> property.</span></span> <span data-ttu-id="31f28-202">Cet objet d'état est `null` si vous ne fournissez pas de valeur.</span><span class="sxs-lookup"><span data-stu-id="31f28-202">This state object is `null` if you do not provide a value.</span></span>

<span data-ttu-id="31f28-203">L'état de continuation est utile quand vous convertissez du code existant qui recourt au [modèle de programmation asynchrone (APM)](../asynchronous-programming-patterns/asynchronous-programming-model-apm.md) pour utiliser la bibliothèque parallèle de tâches.</span><span class="sxs-lookup"><span data-stu-id="31f28-203">Continuation state is useful when you convert existing code that uses the [Asynchronous Programming Model (APM)](../asynchronous-programming-patterns/asynchronous-programming-model-apm.md) to use the TPL.</span></span> <span data-ttu-id="31f28-204">Dans l’APM, vous fournissez généralement l’état de l’objet dans la méthode **Begin**_Method_, puis vous accédez à cet état à l’aide de la propriété <xref:System.IAsyncResult.AsyncState%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="31f28-204">In the APM, you typically provide object state in the **Begin**_Method_ method and later access that state by using the <xref:System.IAsyncResult.AsyncState%2A?displayProperty=nameWithType> property.</span></span> <span data-ttu-id="31f28-205">À l'aide de la méthode <xref:System.Threading.Tasks.Task.ContinueWith%2A> , vous pouvez conserver cet état quand vous convertissez du code qui recourt à l'APM pour utiliser la bibliothèque parallèle de tâches.</span><span class="sxs-lookup"><span data-stu-id="31f28-205">By using the <xref:System.Threading.Tasks.Task.ContinueWith%2A> method, you can preserve this state when you convert code that uses the APM to use the TPL.</span></span>

<span data-ttu-id="31f28-206">L'état de continuation peut également être utile si vous employez des objets <xref:System.Threading.Tasks.Task> dans le débogueur Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="31f28-206">Continuation state can also be useful when you work with <xref:System.Threading.Tasks.Task> objects in the Visual Studio debugger.</span></span> <span data-ttu-id="31f28-207">Par exemple, dans la fenêtre **Tâches parallèles** , la colonne **Tâche** affiche la représentation sous forme de chaîne de l'objet d'état pour chaque tâche.</span><span class="sxs-lookup"><span data-stu-id="31f28-207">For example, in the **Parallel Tasks** window, the **Task** column displays the string representation of the state object for each task.</span></span> <span data-ttu-id="31f28-208">Pour plus d’informations sur la fenêtre **Tâches parallèles**, consultez [Utilisation de la fenêtre Tâches](/visualstudio/debugger/using-the-tasks-window).</span><span class="sxs-lookup"><span data-stu-id="31f28-208">For more information about the **Parallel Tasks** window, see [Using the Tasks Window](/visualstudio/debugger/using-the-tasks-window).</span></span>

<span data-ttu-id="31f28-209">L'exemple suivant montre comment utiliser l'état de continuation.</span><span class="sxs-lookup"><span data-stu-id="31f28-209">The following example shows how to use continuation state.</span></span> <span data-ttu-id="31f28-210">Il crée une chaîne de tâches de continuation.</span><span class="sxs-lookup"><span data-stu-id="31f28-210">It creates a chain of continuation tasks.</span></span> <span data-ttu-id="31f28-211">Chaque tâche fournit l'heure actuelle, sous la forme d'un objet <xref:System.DateTime> , pour le paramètre `state` de la méthode <xref:System.Threading.Tasks.Task.ContinueWith%2A> .</span><span class="sxs-lookup"><span data-stu-id="31f28-211">Each task provides the current time, a <xref:System.DateTime> object, for the `state` parameter of the <xref:System.Threading.Tasks.Task.ContinueWith%2A> method.</span></span> <span data-ttu-id="31f28-212">Chaque objet <xref:System.DateTime> représente l'heure de création de la tâche de continuation.</span><span class="sxs-lookup"><span data-stu-id="31f28-212">Each <xref:System.DateTime> object represents the time at which the continuation task is created.</span></span> <span data-ttu-id="31f28-213">Chaque tâche génère un deuxième objet <xref:System.DateTime> qui représente l'heure à laquelle la tâche se termine.</span><span class="sxs-lookup"><span data-stu-id="31f28-213">Each task produces as its result a second <xref:System.DateTime> object that represents the time at which the task finishes.</span></span> <span data-ttu-id="31f28-214">Une fois toutes les tâches terminées, cet exemple affiche les heures de création et de fin de chaque tâche de continuation.</span><span class="sxs-lookup"><span data-stu-id="31f28-214">After all tasks finish, this example displays the creation time and the time at which each continuation task finishes.</span></span>

:::code language="csharp" source="snippets/cs/continuationstate.cs":::

[!code-vb[TPL_ContinuationState#1](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_continuationstate/vb/continuationstate.vb#1)]

## <a name="continuations-that-return-task-types"></a><span data-ttu-id="31f28-215">Continuations qui retournent des types de tâches</span><span class="sxs-lookup"><span data-stu-id="31f28-215">Continuations that return Task types</span></span>

<span data-ttu-id="31f28-216">Parfois, vous devrez peut-être chaîner une continuation qui retourne un <xref:System.Threading.Tasks.Task> type.</span><span class="sxs-lookup"><span data-stu-id="31f28-216">Sometimes you may need to chain a continuation that returns a <xref:System.Threading.Tasks.Task> type.</span></span> <span data-ttu-id="31f28-217">Ils sont appelés tâches imbriquées et sont courants.</span><span class="sxs-lookup"><span data-stu-id="31f28-217">These are referred to as nested tasks, and they are common.</span></span> <span data-ttu-id="31f28-218">Quand une tâche parente appelle <xref:System.Threading.Tasks.Task%601.ContinueWith%2A?displayProperty=nameWithType> , et fournit un `continuationFunction` qui est une tâche qui retourne vous appelez <xref:System.Threading.Tasks.TaskExtensions.Unwrap%2A> pour créer une tâche proxy qui représente l’opération asynchrone du `<Task<Task<T>>>` ou `Task(Of Task(Of T))` (Visual Basic).</span><span class="sxs-lookup"><span data-stu-id="31f28-218">When a parent task calls <xref:System.Threading.Tasks.Task%601.ContinueWith%2A?displayProperty=nameWithType>, and provides a `continuationFunction` that is task returning you call <xref:System.Threading.Tasks.TaskExtensions.Unwrap%2A> to create a proxy task that represents the asynchronous operation of the `<Task<Task<T>>>` or `Task(Of Task(Of T))` (Visual Basic).</span></span>

<span data-ttu-id="31f28-219">L’exemple suivant montre comment utiliser des continuations qui encapsulent des fonctions de retour de tâche supplémentaires.</span><span class="sxs-lookup"><span data-stu-id="31f28-219">The following example shows how to use continuations that wrap additional task returning functions.</span></span> <span data-ttu-id="31f28-220">Chaque continuation peut être désencapsulée, exposant ainsi la tâche interne encapsulée.</span><span class="sxs-lookup"><span data-stu-id="31f28-220">Each continuation can be unwrapped, exposing the inner task that was wrapped.</span></span>

:::code language="csharp" source="snippets/cs/unwrap.cs":::
:::code language="vb" source="snippets/vb/unwrap.vb":::

<span data-ttu-id="31f28-221">Pour plus d’informations sur l’utilisation de <xref:System.Threading.Tasks.TaskExtensions.Unwrap%2A> , consultez [Comment : désencapsuler une tâche imbriquée](how-to-unwrap-a-nested-task.md).</span><span class="sxs-lookup"><span data-stu-id="31f28-221">For more information on using <xref:System.Threading.Tasks.TaskExtensions.Unwrap%2A>, see [How to: Unwrap a nested Task](how-to-unwrap-a-nested-task.md).</span></span>

## <a name="handle-exceptions-thrown-from-continuations"></a><span data-ttu-id="31f28-222">Gérer les exceptions levées à partir de continuations</span><span class="sxs-lookup"><span data-stu-id="31f28-222">Handle exceptions thrown from continuations</span></span>

<span data-ttu-id="31f28-223">Une relation antécédent-continuation n'est pas une relation parent-enfant.</span><span class="sxs-lookup"><span data-stu-id="31f28-223">An antecedent-continuation relationship is not a parent-child relationship.</span></span> <span data-ttu-id="31f28-224">Les exceptions levées par les continuations ne sont pas propagées à l'antécédent.</span><span class="sxs-lookup"><span data-stu-id="31f28-224">Exceptions thrown by continuations are not propagated to the antecedent.</span></span> <span data-ttu-id="31f28-225">Vous pouvez ainsi gérer les exceptions levées par les continuations de la même manière qu’avec une autre tâche, comme suit :</span><span class="sxs-lookup"><span data-stu-id="31f28-225">Therefore, handle exceptions thrown by continuations as you would handle them in any other task, as follows:</span></span>

- <span data-ttu-id="31f28-226">Vous pouvez utiliser la méthode <xref:System.Threading.Tasks.Task.Wait%2A>, <xref:System.Threading.Tasks.Task.WaitAll%2A>, ou <xref:System.Threading.Tasks.Task.WaitAny%2A> , ou son équivalent générique, pour attendre la continuation.</span><span class="sxs-lookup"><span data-stu-id="31f28-226">You can use the <xref:System.Threading.Tasks.Task.Wait%2A>, <xref:System.Threading.Tasks.Task.WaitAll%2A>, or <xref:System.Threading.Tasks.Task.WaitAny%2A> method, or its generic counterpart, to wait on the continuation.</span></span> <span data-ttu-id="31f28-227">Vous pouvez attendre un antécédent et ses continuations dans la même instruction `try` , comme indiqué dans l'exemple suivant.</span><span class="sxs-lookup"><span data-stu-id="31f28-227">You can wait for an antecedent and its continuations in the same `try` statement, as shown in the following example.</span></span>

:::code language="csharp" source="snippets/cs/exception1.cs":::

[!code-vb[TPL_Continuations#6](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_continuations/vb/exception1.vb#6)]

- <span data-ttu-id="31f28-228">Vous pouvez utiliser une deuxième continuation pour observer la propriété <xref:System.Threading.Tasks.Task.Exception%2A> de la première continuation.</span><span class="sxs-lookup"><span data-stu-id="31f28-228">You can use a second continuation to observe the <xref:System.Threading.Tasks.Task.Exception%2A> property of the first continuation.</span></span> <span data-ttu-id="31f28-229">Dans l’exemple suivant, une tâche tente de lire un fichier inexistant.</span><span class="sxs-lookup"><span data-stu-id="31f28-229">In the following example, a task attempts to read from a non-existent file.</span></span> <span data-ttu-id="31f28-230">La continuation affiche ensuite des informations sur l'exception dans la tâche d'antécédent.</span><span class="sxs-lookup"><span data-stu-id="31f28-230">The continuation then displays information about the exception in the antecedent task.</span></span>

:::code language="csharp" source="snippets/cs/exception2.cs" id="example":::

[!code-vb[TPL_Continuations#4](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_continuations/vb/exception2.vb#4)]

<span data-ttu-id="31f28-231">Ayant été lancée avec l'option <xref:System.Threading.Tasks.TaskContinuationOptions.OnlyOnFaulted?displayProperty=nameWithType> , la continuation ne s'exécute que si une exception se produit dans l'antécédent et peut donc supposer que la propriété <xref:System.Threading.Tasks.Task.Exception%2A> de l'antécédent n'a pas pour valeur `null`.</span><span class="sxs-lookup"><span data-stu-id="31f28-231">Because it was run with the <xref:System.Threading.Tasks.TaskContinuationOptions.OnlyOnFaulted?displayProperty=nameWithType> option, the continuation executes only if an exception occurs in the antecedent, and therefore it can assume that the antecedent's <xref:System.Threading.Tasks.Task.Exception%2A> property is not `null`.</span></span> <span data-ttu-id="31f28-232">Si la continuation s'exécute indépendamment du fait qu'une exception soit levée ou non dans l'antécédent, elle doit vérifier si la propriété <xref:System.Threading.Tasks.Task.Exception%2A> de l'antécédent n'est pas définie sur `null` avant de gérer l'exception, comme le montre le fragment de code suivant.</span><span class="sxs-lookup"><span data-stu-id="31f28-232">If the continuation executes whether or not an exception is thrown in the antecedent, it would have to check whether the antecedent's <xref:System.Threading.Tasks.Task.Exception%2A> property is not `null` before attempting to handle the exception, as the following code fragment shows.</span></span>

:::code language="csharp" source="snippets/cs/exception2.cs" id="exception":::

[!code-vb[TPL_Continuations#11](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_continuations/vb/exception2.vb#11)]

<span data-ttu-id="31f28-233">Pour plus d’informations, consultez l’article [Gestion des exceptions](exception-handling-task-parallel-library.md).</span><span class="sxs-lookup"><span data-stu-id="31f28-233">For more information, see [Exception Handling](exception-handling-task-parallel-library.md).</span></span>

- <span data-ttu-id="31f28-234">Si la continuation est une tâche enfant attachée qui a été créée à l'aide de l'option <xref:System.Threading.Tasks.TaskContinuationOptions.AttachedToParent?displayProperty=nameWithType> , ses exceptions sont de nouveau propagées par le parent au thread appelant, comme dans le cas de tout autre enfant attaché.</span><span class="sxs-lookup"><span data-stu-id="31f28-234">If the continuation is an attached child task that was created by using the <xref:System.Threading.Tasks.TaskContinuationOptions.AttachedToParent?displayProperty=nameWithType> option, its exceptions will be propagated by the parent back to the calling thread, as is the case in any other attached child.</span></span> <span data-ttu-id="31f28-235">Pour plus d'informations, consultez [Tâches enfants attachées et détachées](attached-and-detached-child-tasks.md).</span><span class="sxs-lookup"><span data-stu-id="31f28-235">For more information, see [Attached and Detached Child Tasks](attached-and-detached-child-tasks.md).</span></span>

## <a name="see-also"></a><span data-ttu-id="31f28-236">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="31f28-236">See also</span></span>

- [<span data-ttu-id="31f28-237">Bibliothèque parallèle de tâches</span><span class="sxs-lookup"><span data-stu-id="31f28-237">Task Parallel Library (TPL)</span></span>](task-parallel-library-tpl.md)
