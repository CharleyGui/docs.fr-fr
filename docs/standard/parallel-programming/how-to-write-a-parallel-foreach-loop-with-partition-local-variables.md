---
title: Guide pratique pour écrire une boucle Parallel.ForEach avec des variables locales de partition
description: Consultez un exemple d’écriture d’une boucle Parallel. ForEach qui utilise des variables locales de partition dans .NET.
ms.date: 06/26/2018
ms.technology: dotnet-standard
dev_langs:
- csharp
- vb
helpviewer_keywords:
- parallel foreach loop, how to use local state
ms.assetid: 24b10041-b30b-45cb-aa65-66cf568ca76d
ms.openlocfilehash: f598955fb2d6800f81bce050bdf474fc63bfb554
ms.sourcegitcommit: cdb295dd1db589ce5169ac9ff096f01fd0c2da9d
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 06/09/2020
ms.locfileid: "84599774"
---
# <a name="how-to-write-a-parallelforeach-loop-with-partition-local-variables"></a><span data-ttu-id="00b04-103">Guide pratique pour écrire une boucle Parallel.ForEach avec des variables locales de partition</span><span class="sxs-lookup"><span data-stu-id="00b04-103">How to: Write a Parallel.ForEach loop with partition-local variables</span></span>

<span data-ttu-id="00b04-104">L’exemple suivant montre comment écrire une méthode <xref:System.Threading.Tasks.Parallel.ForEach%2A> qui utilise des variables locales de partition.</span><span class="sxs-lookup"><span data-stu-id="00b04-104">The following example shows how to write a <xref:System.Threading.Tasks.Parallel.ForEach%2A> method that uses partition-local variables.</span></span> <span data-ttu-id="00b04-105">Quand une boucle <xref:System.Threading.Tasks.Parallel.ForEach%2A> s’exécute, elle divise sa collection source en plusieurs partitions.</span><span class="sxs-lookup"><span data-stu-id="00b04-105">When a <xref:System.Threading.Tasks.Parallel.ForEach%2A> loop executes, it divides its source collection into multiple partitions.</span></span> <span data-ttu-id="00b04-106">Chaque partition a sa propre copie de la variable locale de partition.</span><span class="sxs-lookup"><span data-stu-id="00b04-106">Each partition has its own copy of the partition-local variable.</span></span> <span data-ttu-id="00b04-107">Une variable locale de partition est similaire à une [variable locale de thread](xref:System.Threading.ThreadLocal%601), à la différence près que plusieurs partitions peuvent s’exécuter sur un thread unique.</span><span class="sxs-lookup"><span data-stu-id="00b04-107">A partition-local variable is similar to a [thread-local variable](xref:System.Threading.ThreadLocal%601), except that multiple partitions can run on a single thread.</span></span>

<span data-ttu-id="00b04-108">Le code et les paramètres dans cet exemple ressemblent beaucoup à la méthode <xref:System.Threading.Tasks.Parallel.For%2A> correspondante.</span><span class="sxs-lookup"><span data-stu-id="00b04-108">The code and parameters in this example closely resemble the corresponding <xref:System.Threading.Tasks.Parallel.For%2A> method.</span></span> <span data-ttu-id="00b04-109">Pour plus d’informations, voir [Guide pratique : écrire une boucle Parallel.For avec des variables locales de thread](how-to-write-a-parallel-for-loop-with-thread-local-variables.md).</span><span class="sxs-lookup"><span data-stu-id="00b04-109">For more information, see [How to: Write a Parallel.For Loop with Thread-Local Variables](how-to-write-a-parallel-for-loop-with-thread-local-variables.md).</span></span>

<span data-ttu-id="00b04-110">Pour utiliser une variable locale de partition dans une boucle <xref:System.Threading.Tasks.Parallel.ForEach%2A>, vous devez appeler l’une des surcharges de méthode qui accepte deux paramètres de type.</span><span class="sxs-lookup"><span data-stu-id="00b04-110">To use a partition-local variable in a <xref:System.Threading.Tasks.Parallel.ForEach%2A> loop, you must call one of the method overloads that takes two type parameters.</span></span> <span data-ttu-id="00b04-111">Le premier paramètre de type, `TSource`, spécifie le type d’élément source, tandis que le second, `TLocal`, spécifie le type de la variable locale de partition.</span><span class="sxs-lookup"><span data-stu-id="00b04-111">The first type parameter, `TSource`, specifies the type of the source element, and the second type parameter, `TLocal`, specifies the type of the partition-local variable.</span></span>

## <a name="example"></a><span data-ttu-id="00b04-112">Exemple</span><span class="sxs-lookup"><span data-stu-id="00b04-112">Example</span></span>

<span data-ttu-id="00b04-113">L’exemple suivant appelle la surcharge <xref:System.Threading.Tasks.Parallel.ForEach%60%602%28System.Collections.Generic.IEnumerable%7B%60%600%7D%2CSystem.Func%7B%60%601%7D%2CSystem.Func%7B%60%600%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%601%2C%60%601%7D%2CSystem.Action%7B%60%601%7D%29?displayProperty=nameWithType> pour calculer la somme d’un tableau d’un million d’éléments.</span><span class="sxs-lookup"><span data-stu-id="00b04-113">The following example calls the <xref:System.Threading.Tasks.Parallel.ForEach%60%602%28System.Collections.Generic.IEnumerable%7B%60%600%7D%2CSystem.Func%7B%60%601%7D%2CSystem.Func%7B%60%600%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%601%2C%60%601%7D%2CSystem.Action%7B%60%601%7D%29?displayProperty=nameWithType> overload to compute the sum of an array of one million elements.</span></span> <span data-ttu-id="00b04-114">Cette surcharge possède quatre paramètres :</span><span class="sxs-lookup"><span data-stu-id="00b04-114">This overload has four parameters:</span></span>

- <span data-ttu-id="00b04-115">`source`, qui représente la source de données.</span><span class="sxs-lookup"><span data-stu-id="00b04-115">`source`, which is the data source.</span></span> <span data-ttu-id="00b04-116">Il doit implémenter <xref:System.Collections.Generic.IEnumerable%601>.</span><span class="sxs-lookup"><span data-stu-id="00b04-116">It must implement <xref:System.Collections.Generic.IEnumerable%601>.</span></span> <span data-ttu-id="00b04-117">La source de données dans notre exemple est l'objet `IEnumerable<Int32>` d'un million de membres retourné par la méthode <xref:System.Linq.Enumerable.Range%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="00b04-117">The data source in our example is the one million member `IEnumerable<Int32>` object returned by the <xref:System.Linq.Enumerable.Range%2A?displayProperty=nameWithType> method.</span></span>

- <span data-ttu-id="00b04-118">`localInit` ou fonction qui initialise la variable locale de partition.</span><span class="sxs-lookup"><span data-stu-id="00b04-118">`localInit`, or the function that initializes the partition-local variable.</span></span> <span data-ttu-id="00b04-119">Cette fonction est appelée une fois pour chaque partition dans laquelle l'opération <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> s'exécute.</span><span class="sxs-lookup"><span data-stu-id="00b04-119">This function is called once for each partition in which the <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> operation executes.</span></span> <span data-ttu-id="00b04-120">Notre exemple initialise la variable locale de partition à zéro.</span><span class="sxs-lookup"><span data-stu-id="00b04-120">Our example initializes the partition-local variable to zero.</span></span>

- <span data-ttu-id="00b04-121">`body`, <xref:System.Func%604> appelé par la boucle parallèle sur chaque itération de la boucle.</span><span class="sxs-lookup"><span data-stu-id="00b04-121">`body`, a <xref:System.Func%604> that is invoked by the parallel loop on each iteration of the loop.</span></span> <span data-ttu-id="00b04-122">Sa signature est `Func\<TSource, ParallelLoopState, TLocal, TLocal>`.</span><span class="sxs-lookup"><span data-stu-id="00b04-122">Its signature is `Func\<TSource, ParallelLoopState, TLocal, TLocal>`.</span></span> <span data-ttu-id="00b04-123">Vous fournissez le code pour le délégué, puis la boucle transmet les paramètres d'entrée, qui sont :</span><span class="sxs-lookup"><span data-stu-id="00b04-123">You supply the code for the delegate, and the loop passes in the input parameters, which are:</span></span>

  - <span data-ttu-id="00b04-124">l'élément actuel de l'interface <xref:System.Collections.Generic.IEnumerable%601> ;</span><span class="sxs-lookup"><span data-stu-id="00b04-124">The current element of the <xref:System.Collections.Generic.IEnumerable%601>.</span></span>

  - <span data-ttu-id="00b04-125">une variable <xref:System.Threading.Tasks.ParallelLoopState> que vous pouvez utiliser dans le code de votre délégué pour examiner l'état de la boucle ;</span><span class="sxs-lookup"><span data-stu-id="00b04-125">A <xref:System.Threading.Tasks.ParallelLoopState> variable that you can use in your delegate's code to examine the state of the loop.</span></span>

  - <span data-ttu-id="00b04-126">la variable locale de partition.</span><span class="sxs-lookup"><span data-stu-id="00b04-126">The partition-local variable.</span></span>

  <span data-ttu-id="00b04-127">Votre délégué retourne la variable locale de partition, qui est ensuite transmise à la prochaine itération de la boucle qui s’exécute dans la partition concernée.</span><span class="sxs-lookup"><span data-stu-id="00b04-127">Your delegate returns the partition-local variable, which is then passed to the next iteration of the loop that executes in that particular partition.</span></span> <span data-ttu-id="00b04-128">Chaque partition de boucle tient à jour une instance distincte de cette variable.</span><span class="sxs-lookup"><span data-stu-id="00b04-128">Each loop partition maintains a separate instance of this variable.</span></span>

  <span data-ttu-id="00b04-129">Dans l’exemple, le délégué ajoute la valeur de chaque entier à la variable locale de partition, qui tient à jour le total cumulé des valeurs des éléments entiers dans la partition concernée.</span><span class="sxs-lookup"><span data-stu-id="00b04-129">In the example, the delegate adds the value of each integer to the partition-local variable, which maintains a running total of the values of the integer elements in that partition.</span></span>

- <span data-ttu-id="00b04-130">`localFinally`, délégué `Action<TLocal>` que la méthode <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> appelle quand les opérations de bouclage dans chaque partition sont terminées.</span><span class="sxs-lookup"><span data-stu-id="00b04-130">`localFinally`, an `Action<TLocal>` delegate that the <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> invokes when the looping operations in each partition have completed.</span></span> <span data-ttu-id="00b04-131">La méthode <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> passe à votre délégué `Action<TLocal>` la valeur finale de la variable locale de partition pour cette partition de boucle, et vous fournissez le code qui prend en charge la combinaison du résultat de cette partition avec les résultats des autres partitions.</span><span class="sxs-lookup"><span data-stu-id="00b04-131">The <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> method passes your `Action<TLocal>` delegate the final value of the partition-local variable for this loop partition, and you provide the code that performs the required action for combining the result from this partition with the results from the other partitions.</span></span> <span data-ttu-id="00b04-132">Ce délégué peut être appelé simultanément par plusieurs tâches.</span><span class="sxs-lookup"><span data-stu-id="00b04-132">This delegate can be invoked concurrently by multiple tasks.</span></span> <span data-ttu-id="00b04-133">C’est la raison pour laquelle l’exemple utilise la méthode <xref:System.Threading.Interlocked.Add%28System.Int32%40%2CSystem.Int32%29?displayProperty=nameWithType> pour synchroniser l’accès à la variable `total`.</span><span class="sxs-lookup"><span data-stu-id="00b04-133">Because of this, the example uses the <xref:System.Threading.Interlocked.Add%28System.Int32%40%2CSystem.Int32%29?displayProperty=nameWithType> method to synchronize access to the `total` variable.</span></span> <span data-ttu-id="00b04-134">Comme le type de délégué est un délégué <xref:System.Action%601>, aucune valeur n'est retournée.</span><span class="sxs-lookup"><span data-stu-id="00b04-134">Because the delegate type is an <xref:System.Action%601>, there is no return value.</span></span>

[!code-csharp[TPL_Parallel#04](../../../samples/snippets/csharp/VS_Snippets_Misc/tpl_parallel/cs/foreachthreadlocal.cs#04)]
[!code-vb[TPL_Parallel#04](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_parallel/vb/foreachthreadlocal.vb#04)]

## <a name="see-also"></a><span data-ttu-id="00b04-135">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="00b04-135">See also</span></span>

- [<span data-ttu-id="00b04-136">Parallélisme des données</span><span class="sxs-lookup"><span data-stu-id="00b04-136">Data Parallelism</span></span>](data-parallelism-task-parallel-library.md)
- [<span data-ttu-id="00b04-137">Procédure : écrire une boucle Parallel.For avec des variables locales de thread</span><span class="sxs-lookup"><span data-stu-id="00b04-137">How to: Write a Parallel.For Loop with Thread-Local Variables</span></span>](how-to-write-a-parallel-for-loop-with-thread-local-variables.md)
- [<span data-ttu-id="00b04-138">Expressions lambda dans PLINQ et TPL</span><span class="sxs-lookup"><span data-stu-id="00b04-138">Lambda Expressions in PLINQ and TPL</span></span>](lambda-expressions-in-plinq-and-tpl.md)
