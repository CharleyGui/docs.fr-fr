---
title: Annulation dans les threads managés
ms.date: 03/30/2017
ms.technology: dotnet-standard
dev_langs:
- csharp
- vb
helpviewer_keywords:
- cancellation in .NET, overview
ms.assetid: eea11fe5-d8b0-4314-bb5d-8a58166fb1c3
author: rpetrusha
ms.author: ronpet
ms.openlocfilehash: d0776db4d045a8e52521859b9126583558bc5b51
ms.sourcegitcommit: c7a7e1468bf0fa7f7065de951d60dfc8d5ba89f5
ms.translationtype: HT
ms.contentlocale: fr-FR
ms.lasthandoff: 05/14/2019
ms.locfileid: "65586372"
---
# <a name="cancellation-in-managed-threads"></a><span data-ttu-id="4cad1-102">Annulation dans les threads managés</span><span class="sxs-lookup"><span data-stu-id="4cad1-102">Cancellation in Managed Threads</span></span>
<span data-ttu-id="4cad1-103">[!INCLUDE[net_v40_long](../../../includes/net-v40-long-md.md)] et versions ultérieures utilisent un modèle unifié pour l'annulation coopérative des opérations asynchrones ou des opérations synchrones de longue durée.</span><span class="sxs-lookup"><span data-stu-id="4cad1-103">Starting with the [!INCLUDE[net_v40_long](../../../includes/net-v40-long-md.md)], the .NET Framework uses a unified model for cooperative cancellation of asynchronous or long-running synchronous operations.</span></span> <span data-ttu-id="4cad1-104">Ce modèle est basé sur un objet léger appelé jeton d'annulation.</span><span class="sxs-lookup"><span data-stu-id="4cad1-104">This model is based on a lightweight object called a cancellation token.</span></span> <span data-ttu-id="4cad1-105">L'objet qui appelle une ou plusieurs opérations annulables, par exemple en créant de nouveaux threads ou de nouvelles tâches, passe le jeton à chaque opération.</span><span class="sxs-lookup"><span data-stu-id="4cad1-105">The object that invokes one or more cancelable operations, for example by creating new threads or tasks, passes the token to each operation.</span></span> <span data-ttu-id="4cad1-106">Chaque opération peut, à son tour, passer des copies du jeton à d'autres opérations.</span><span class="sxs-lookup"><span data-stu-id="4cad1-106">Individual operations can in turn pass copies of the token to other operations.</span></span> <span data-ttu-id="4cad1-107">Ultérieurement, l'objet qui a créé le jeton peut l'utiliser pour demander que les opérations arrêtent leur action.</span><span class="sxs-lookup"><span data-stu-id="4cad1-107">At some later time, the object that created the token can use it to request that the operations stop what they are doing.</span></span> <span data-ttu-id="4cad1-108">Seul l'objet demandeur peut émettre la demande d'annulation. Chaque écouteur est chargé d'accepter la demande et d'y répondre de manière appropriée et en temps voulu.</span><span class="sxs-lookup"><span data-stu-id="4cad1-108">Only the requesting object can issue the cancellation request, and each listener is responsible for noticing the request and responding to it in an appropriate and timely manner.</span></span>  
  
 <span data-ttu-id="4cad1-109">Le modèle général d’implémentation du modèle d’annulation coopérative est le suivant :</span><span class="sxs-lookup"><span data-stu-id="4cad1-109">The general pattern for implementing the cooperative cancellation model is:</span></span>  
  
- <span data-ttu-id="4cad1-110">Instanciez un objet <xref:System.Threading.CancellationTokenSource> qui gère et envoie une notification d'annulation pour chaque jeton d'annulation.</span><span class="sxs-lookup"><span data-stu-id="4cad1-110">Instantiate a <xref:System.Threading.CancellationTokenSource> object, which manages and sends cancellation notification to the individual cancellation tokens.</span></span>  
  
- <span data-ttu-id="4cad1-111">Passez le jeton retourné par la propriété <xref:System.Threading.CancellationTokenSource.Token%2A?displayProperty=nameWithType> à chaque tâche ou thread qui écoute l'annulation.</span><span class="sxs-lookup"><span data-stu-id="4cad1-111">Pass the token returned by the <xref:System.Threading.CancellationTokenSource.Token%2A?displayProperty=nameWithType> property to each task or thread that listens for cancellation.</span></span>  
  
- <span data-ttu-id="4cad1-112">Fournissez un mécanisme pour chaque tâche ou thread pour répondre à l’annulation.</span><span class="sxs-lookup"><span data-stu-id="4cad1-112">Provide a mechanism for each task or thread to respond to cancellation.</span></span>  
  
- <span data-ttu-id="4cad1-113">Appelez la méthode <xref:System.Threading.CancellationTokenSource.Cancel%2A?displayProperty=nameWithType> pour fournir une notification d'annulation.</span><span class="sxs-lookup"><span data-stu-id="4cad1-113">Call the <xref:System.Threading.CancellationTokenSource.Cancel%2A?displayProperty=nameWithType> method to provide notification of cancellation.</span></span>  
  
> [!IMPORTANT]
>  <span data-ttu-id="4cad1-114">La classe <xref:System.Threading.CancellationTokenSource> implémente l'interface <xref:System.IDisposable>.</span><span class="sxs-lookup"><span data-stu-id="4cad1-114">The <xref:System.Threading.CancellationTokenSource> class implements the <xref:System.IDisposable> interface.</span></span> <span data-ttu-id="4cad1-115">Quand vous aurez terminé d'utiliser la source du jeton d'annulation, vous devrez appeler la méthode <xref:System.Threading.CancellationTokenSource.Dispose%2A?displayProperty=nameWithType> pour libérer les ressources non managées qu'elle contient.</span><span class="sxs-lookup"><span data-stu-id="4cad1-115">You should be sure to call the <xref:System.Threading.CancellationTokenSource.Dispose%2A?displayProperty=nameWithType> method when you have finished using the cancellation token source to free any unmanaged resources it holds.</span></span>  
  
 <span data-ttu-id="4cad1-116">L'illustration suivante montre la relation entre une source de jeton et toutes les copies de ce jeton.</span><span class="sxs-lookup"><span data-stu-id="4cad1-116">The following illustration shows the relationship between a token source and all the copies of its token.</span></span>  
  
 <span data-ttu-id="4cad1-117">![CancellationTokenSource et CancellationTokens](../../../docs/standard/threading/media/vs-cancellationtoken.png "VS_CancellationToken")</span><span class="sxs-lookup"><span data-stu-id="4cad1-117">![CancellationTokenSource and cancellation tokens](../../../docs/standard/threading/media/vs-cancellationtoken.png "VS_CancellationToken")</span></span>  
  
 <span data-ttu-id="4cad1-118">Le nouveau modèle d’annulation facilite la création d’applications et de bibliothèques prenant en charge l’annulation. De plus, il prend en charge les fonctionnalités suivantes :</span><span class="sxs-lookup"><span data-stu-id="4cad1-118">The new cancellation model makes it easier to create cancellation-aware applications and libraries, and it supports the following features:</span></span>  
  
- <span data-ttu-id="4cad1-119">L'annulation est coopérative et n'est pas imposée à l'écouteur.</span><span class="sxs-lookup"><span data-stu-id="4cad1-119">Cancellation is cooperative and is not forced on the listener.</span></span> <span data-ttu-id="4cad1-120">L'écouteur choisit comment s'arrêter correctement en réponse à une demande d'annulation.</span><span class="sxs-lookup"><span data-stu-id="4cad1-120">The listener determines how to gracefully terminate in response to a cancellation request.</span></span>  
  
- <span data-ttu-id="4cad1-121">La demande est différente de l'écoute.</span><span class="sxs-lookup"><span data-stu-id="4cad1-121">Requesting is distinct from listening.</span></span> <span data-ttu-id="4cad1-122">Un objet qui appelle une opération annulable peut contrôler à quel moment l'annulation est demandée (le cas échéant).</span><span class="sxs-lookup"><span data-stu-id="4cad1-122">An object that invokes a cancelable operation can control when (if ever) cancellation is requested.</span></span>  
  
- <span data-ttu-id="4cad1-123">L'objet demandeur émet la demande d'annulation vers toutes les copies du jeton à l'aide d'un seul appel de méthode.</span><span class="sxs-lookup"><span data-stu-id="4cad1-123">The requesting object issues the cancellation request to all copies of the token by using just one method call.</span></span>  
  
- <span data-ttu-id="4cad1-124">Un écouteur peut écouter plusieurs jetons simultanément en les rassemblant sous la forme d'un même *jeton lié*.</span><span class="sxs-lookup"><span data-stu-id="4cad1-124">A listener can listen to multiple tokens simultaneously by joining them into one *linked token*.</span></span>  
  
- <span data-ttu-id="4cad1-125">Le code utilisateur peut remarquer et répondre aux demandes d'annulation à partir du code de bibliothèque, et ce dernier peut remarquer et répondre aux demandes d'annulation à partir du code utilisateur.</span><span class="sxs-lookup"><span data-stu-id="4cad1-125">User code can notice and respond to cancellation requests from library code, and library code can notice and respond to cancellation requests from user code.</span></span>  
  
- <span data-ttu-id="4cad1-126">Les écouteurs peuvent être avertis des demandes d'annulation par le biais d'une interrogation, d'une inscription de rappel ou bien en attendant des handles d'attente.</span><span class="sxs-lookup"><span data-stu-id="4cad1-126">Listeners can be notified of cancellation requests by polling, callback registration, or waiting on wait handles.</span></span>  
  
## <a name="cancellation-types"></a><span data-ttu-id="4cad1-127">Types d'annulation</span><span class="sxs-lookup"><span data-stu-id="4cad1-127">Cancellation Types</span></span>  
 <span data-ttu-id="4cad1-128">L'infrastructure d'annulation est implémentée comme un ensemble de types connexes, qui sont répertoriés dans le tableau suivant.</span><span class="sxs-lookup"><span data-stu-id="4cad1-128">The cancellation framework is implemented as a set of related types, which are listed in the following table.</span></span>  
  
|<span data-ttu-id="4cad1-129">Nom de type</span><span class="sxs-lookup"><span data-stu-id="4cad1-129">Type name</span></span>|<span data-ttu-id="4cad1-130">Description</span><span class="sxs-lookup"><span data-stu-id="4cad1-130">Description</span></span>|  
|---------------|-----------------|  
|<xref:System.Threading.CancellationTokenSource>|<span data-ttu-id="4cad1-131">Objet qui crée un jeton d'annulation et émet également la demande d'annulation pour toutes les copies de ce jeton.</span><span class="sxs-lookup"><span data-stu-id="4cad1-131">Object that creates a cancellation token, and also issues the cancellation request for all copies of that token.</span></span>|  
|<xref:System.Threading.CancellationToken>|<span data-ttu-id="4cad1-132">Type valeur léger passé à un ou plusieurs écouteurs, généralement sous la forme d'un paramètre de méthode.</span><span class="sxs-lookup"><span data-stu-id="4cad1-132">Lightweight value type passed to one or more listeners, typically as a method parameter.</span></span> <span data-ttu-id="4cad1-133">Les écouteurs surveillent la valeur de la propriété `IsCancellationRequested` du jeton par le biais d'interrogations, de rappels ou de handles d'attente.</span><span class="sxs-lookup"><span data-stu-id="4cad1-133">Listeners monitor the value of the `IsCancellationRequested` property of the token by polling, callback, or wait handle.</span></span>|  
|<xref:System.OperationCanceledException>|<span data-ttu-id="4cad1-134">Les surcharges du constructeur de cette exception acceptent <xref:System.Threading.CancellationToken> comme paramètre.</span><span class="sxs-lookup"><span data-stu-id="4cad1-134">Overloads of this exception's constructor accept a <xref:System.Threading.CancellationToken> as a parameter.</span></span> <span data-ttu-id="4cad1-135">Les écouteurs peuvent éventuellement lever cette exception pour vérifier la source de l'annulation et informer les autres qu'elle a répondu à une demande d'annulation.</span><span class="sxs-lookup"><span data-stu-id="4cad1-135">Listeners can optionally throw this exception to verify the source of the cancellation and notify others that it has responded to a cancellation request.</span></span>|  
  
 <span data-ttu-id="4cad1-136">Le nouveau modèle d’annulation est intégré à .NET Framework dans plusieurs types.</span><span class="sxs-lookup"><span data-stu-id="4cad1-136">The new cancellation model is integrated into the .NET Framework in several types.</span></span> <span data-ttu-id="4cad1-137">Les plus importants sont <xref:System.Threading.Tasks.Parallel?displayProperty=nameWithType>, <xref:System.Threading.Tasks.Task?displayProperty=nameWithType>,<xref:System.Threading.Tasks.Task%601?displayProperty=nameWithType> et <xref:System.Linq.ParallelEnumerable?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="4cad1-137">The most important ones are <xref:System.Threading.Tasks.Parallel?displayProperty=nameWithType>, <xref:System.Threading.Tasks.Task?displayProperty=nameWithType>, <xref:System.Threading.Tasks.Task%601?displayProperty=nameWithType> and <xref:System.Linq.ParallelEnumerable?displayProperty=nameWithType>.</span></span> <span data-ttu-id="4cad1-138">Nous vous recommandons d'utiliser ce nouveau modèle d'annulation pour tout nouveau code de bibliothèque et d'application.</span><span class="sxs-lookup"><span data-stu-id="4cad1-138">We recommend that you use this new cancellation model for all new library and application code.</span></span>  
  
## <a name="code-example"></a><span data-ttu-id="4cad1-139">Exemple de code</span><span class="sxs-lookup"><span data-stu-id="4cad1-139">Code Example</span></span>  
 <span data-ttu-id="4cad1-140">Dans l'exemple suivant, l'objet demandeur crée un objet <xref:System.Threading.CancellationTokenSource>, puis passe sa propriété <xref:System.Threading.CancellationTokenSource.Token%2A> à l'opération annulable.</span><span class="sxs-lookup"><span data-stu-id="4cad1-140">In the following example, the requesting object creates a <xref:System.Threading.CancellationTokenSource> object, and then passes its <xref:System.Threading.CancellationTokenSource.Token%2A> property to the cancelable operation.</span></span> <span data-ttu-id="4cad1-141">L'opération qui reçoit la demande surveille la valeur de la propriété <xref:System.Threading.CancellationToken.IsCancellationRequested%2A> du jeton par le biais d'une interrogation.</span><span class="sxs-lookup"><span data-stu-id="4cad1-141">The operation that receives the request monitors the value of the <xref:System.Threading.CancellationToken.IsCancellationRequested%2A> property of the token by polling.</span></span> <span data-ttu-id="4cad1-142">Quand la valeur devient `true`, l'écouteur peut s'arrêter de quelque manière appropriée que ce soit.</span><span class="sxs-lookup"><span data-stu-id="4cad1-142">When the value becomes `true`, the listener can terminate in whatever manner is appropriate.</span></span> <span data-ttu-id="4cad1-143">Dans cet exemple, la méthode s'arrête, ce qui suffit dans de nombreux cas.</span><span class="sxs-lookup"><span data-stu-id="4cad1-143">In this example, the method just exits, which is all that is required in many cases.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="4cad1-144">L'exemple utilise la méthode <xref:System.Threading.ThreadPool.QueueUserWorkItem%2A> pour montrer que la nouvelle infrastructure d'annulation est compatible avec les API héritées.</span><span class="sxs-lookup"><span data-stu-id="4cad1-144">The example uses the <xref:System.Threading.ThreadPool.QueueUserWorkItem%2A> method to demonstrate that the new cancellation framework is compatible with legacy APIs.</span></span> <span data-ttu-id="4cad1-145">Pour obtenir un exemple qui utilise le nouveau type <xref:System.Threading.Tasks.Task?displayProperty=nameWithType> standard, consultez [Comment : annuler une tâche et ses enfants](../../../docs/standard/parallel-programming/how-to-cancel-a-task-and-its-children.md).</span><span class="sxs-lookup"><span data-stu-id="4cad1-145">For an example that uses the new, preferred <xref:System.Threading.Tasks.Task?displayProperty=nameWithType> type, see [How to: Cancel a Task and Its Children](../../../docs/standard/parallel-programming/how-to-cancel-a-task-and-its-children.md).</span></span>  
  
 [!code-csharp[Cancellation#1](../../../samples/snippets/csharp/VS_Snippets_Misc/cancellation/cs/cancellationex1.cs#1)]
 [!code-vb[Cancellation#1](../../../samples/snippets/visualbasic/VS_Snippets_Misc/cancellation/vb/cancellationex1.vb#1)]  
  
## <a name="operation-cancellation-versus-object-cancellation"></a><span data-ttu-id="4cad1-146">Annulation d'opération et annulation d'objet</span><span class="sxs-lookup"><span data-stu-id="4cad1-146">Operation Cancellation Versus Object Cancellation</span></span>  
 <span data-ttu-id="4cad1-147">Dans la nouvelle infrastructure d'annulation, l'annulation fait référence aux opérations, et non aux objets.</span><span class="sxs-lookup"><span data-stu-id="4cad1-147">In the new cancellation framework, cancellation refers to operations, not objects.</span></span> <span data-ttu-id="4cad1-148">La demande d'annulation signifie que l'opération doit s'arrêter dès que possible après l'exécution de tout nettoyage nécessaire.</span><span class="sxs-lookup"><span data-stu-id="4cad1-148">The cancellation request means that the operation should stop as soon as possible after any required cleanup is performed.</span></span> <span data-ttu-id="4cad1-149">Un jeton d'annulation doit faire référence à une opération annulable. Toutefois, cette opération peut être implémentée dans votre programme.</span><span class="sxs-lookup"><span data-stu-id="4cad1-149">One cancellation token should refer to one "cancelable operation," however that operation may be implemented in your program.</span></span> <span data-ttu-id="4cad1-150">Après avoir défini la propriété <xref:System.Threading.CancellationToken.IsCancellationRequested%2A> du jeton sur `true`, celle-ci ne peut pas être réinitialisée à la valeur `false`.</span><span class="sxs-lookup"><span data-stu-id="4cad1-150">After the <xref:System.Threading.CancellationToken.IsCancellationRequested%2A> property of the token has been set to `true`, it cannot be reset to `false`.</span></span> <span data-ttu-id="4cad1-151">Les jetons d'annulation ne peuvent donc pas être réutilisés après avoir été annulés.</span><span class="sxs-lookup"><span data-stu-id="4cad1-151">Therefore, cancellation tokens cannot be reused after they have been canceled.</span></span>  
  
 <span data-ttu-id="4cad1-152">Si vous avez besoin d'un mécanisme d'annulation d'objets, vous pouvez le baser sur le mécanisme d'annulation d'opérations en appelant la méthode <xref:System.Threading.CancellationToken.Register%2A?displayProperty=nameWithType>, comme indiqué dans l'exemple suivant.</span><span class="sxs-lookup"><span data-stu-id="4cad1-152">If you require an object cancellation mechanism, you can base it on the operation cancellation mechanism by calling the <xref:System.Threading.CancellationToken.Register%2A?displayProperty=nameWithType> method, as shown in the following example.</span></span>  
  
 [!code-csharp[Cancellation#2](../../../samples/snippets/csharp/VS_Snippets_Misc/cancellation/cs/objectcancellation1.cs#2)]
 [!code-vb[Cancellation#2](../../../samples/snippets/visualbasic/VS_Snippets_Misc/cancellation/vb/objectcancellation1.vb#2)]  
  
 <span data-ttu-id="4cad1-153">Si un objet prend en charge plusieurs opérations annulables simultanées, passez un jeton en tant qu'entrée à chaque opération annulable.</span><span class="sxs-lookup"><span data-stu-id="4cad1-153">If an object supports more than one concurrent cancelable operation, pass a separate token as input to each distinct cancelable operation.</span></span> <span data-ttu-id="4cad1-154">De cette façon, une opération peut être annulée sans affecter les autres.</span><span class="sxs-lookup"><span data-stu-id="4cad1-154">That way, one operation can be cancelled without affecting the others.</span></span>  
  
## <a name="listening-and-responding-to-cancellation-requests"></a><span data-ttu-id="4cad1-155">Demandes d'annulation : écoute et réponse</span><span class="sxs-lookup"><span data-stu-id="4cad1-155">Listening and Responding to Cancellation Requests</span></span>  
 <span data-ttu-id="4cad1-156">Dans le délégué utilisateur, l'implémenteur d'une opération annulable détermine la façon de terminer l'opération en réponse à une demande d'annulation.</span><span class="sxs-lookup"><span data-stu-id="4cad1-156">In the user delegate, the implementer of a cancelable operation determines how to terminate the operation in response to a cancellation request.</span></span> <span data-ttu-id="4cad1-157">Dans de nombreux cas, le délégué utilisateur peut simplement effectuer le nettoyage nécessaire, puis être immédiatement retourné.</span><span class="sxs-lookup"><span data-stu-id="4cad1-157">In many cases, the user delegate can just perform any required cleanup and then return immediately.</span></span>  
  
 <span data-ttu-id="4cad1-158">Toutefois, dans des cas plus complexes, le délégué utilisateur devra notifier le code de bibliothèque qu'une annulation s'est produite.</span><span class="sxs-lookup"><span data-stu-id="4cad1-158">However, in more complex cases, it might be necessary for the user delegate to notify library code that cancellation has occurred.</span></span> <span data-ttu-id="4cad1-159">Dans ce cas, il convient de terminer l'opération en appelant le délégué de la méthode <xref:System.Threading.CancellationToken.ThrowIfCancellationRequested%2A>, ce qui entraînera la levée de <xref:System.OperationCanceledException>.</span><span class="sxs-lookup"><span data-stu-id="4cad1-159">In such cases, the correct way to terminate the operation is for the delegate to call the <xref:System.Threading.CancellationToken.ThrowIfCancellationRequested%2A>, method, which will cause an <xref:System.OperationCanceledException> to be thrown.</span></span> <span data-ttu-id="4cad1-160">Le code de bibliothèque peut intercepter cette exception sur le thread du délégué utilisateur et examiner le jeton de l'exception pour déterminer si l'exception indique une annulation coopérative ou une autre situation exceptionnelle.</span><span class="sxs-lookup"><span data-stu-id="4cad1-160">Library code can catch this exception on the user delegate thread and examine the exception's token to determine whether the exception indicates cooperative cancellation or some other exceptional situation.</span></span>  
  
 <span data-ttu-id="4cad1-161">La classe <xref:System.Threading.Tasks.Task> gère <xref:System.OperationCanceledException> de cette façon.</span><span class="sxs-lookup"><span data-stu-id="4cad1-161">The <xref:System.Threading.Tasks.Task> class handles <xref:System.OperationCanceledException> in this way.</span></span> <span data-ttu-id="4cad1-162">Pour plus d’informations, voir [Annulation de tâches](../../../docs/standard/parallel-programming/task-cancellation.md).</span><span class="sxs-lookup"><span data-stu-id="4cad1-162">For more information, see [Task Cancellation](../../../docs/standard/parallel-programming/task-cancellation.md).</span></span>  
  
### <a name="listening-by-polling"></a><span data-ttu-id="4cad1-163">Écoute par interrogation</span><span class="sxs-lookup"><span data-stu-id="4cad1-163">Listening by Polling</span></span>  
 <span data-ttu-id="4cad1-164">Pour les calculs de longue durée qui effectuent des boucles récursives ou non, vous pouvez écouter une demande d'annulation en interrogeant régulièrement la valeur de la propriété <xref:System.Threading.CancellationToken.IsCancellationRequested%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="4cad1-164">For long-running computations that loop or recurse, you can listen for a cancellation request by periodically polling the value of the <xref:System.Threading.CancellationToken.IsCancellationRequested%2A?displayProperty=nameWithType> property.</span></span> <span data-ttu-id="4cad1-165">Si sa valeur est de `true`, la méthode doit effectuer un nettoyage et se terminer aussi rapidement que possible.</span><span class="sxs-lookup"><span data-stu-id="4cad1-165">If its value is `true`, the method should clean up and terminate as quickly as possible.</span></span> <span data-ttu-id="4cad1-166">La fréquence d'interrogation optimale varie selon le type d'application.</span><span class="sxs-lookup"><span data-stu-id="4cad1-166">The optimal frequency of polling depends on the type of application.</span></span> <span data-ttu-id="4cad1-167">Il incombe au développeur de déterminer la meilleure fréquence d'interrogation pour un programme donné.</span><span class="sxs-lookup"><span data-stu-id="4cad1-167">It is up to the developer to determine the best polling frequency for any given program.</span></span> <span data-ttu-id="4cad1-168">L'interrogation elle-même n'altère pas beaucoup les performances.</span><span class="sxs-lookup"><span data-stu-id="4cad1-168">Polling itself does not significantly impact performance.</span></span> <span data-ttu-id="4cad1-169">L'exemple suivant montre une méthode d'interrogation.</span><span class="sxs-lookup"><span data-stu-id="4cad1-169">The following example shows one possible way to poll.</span></span>  
  
 [!code-csharp[Cancellation#3](../../../samples/snippets/csharp/VS_Snippets_Misc/cancellation/cs/cancellationex11.cs#3)]
 [!code-vb[Cancellation#3](../../../samples/snippets/visualbasic/VS_Snippets_Misc/cancellation/vb/cancellationex11.vb#3)]  
  
 <span data-ttu-id="4cad1-170">Pour un exemple plus complet, consultez [Comment : écouter les requêtes d’annulation par interrogation](../../../docs/standard/threading/how-to-listen-for-cancellation-requests-by-polling.md).</span><span class="sxs-lookup"><span data-stu-id="4cad1-170">For a more complete example, see [How to: Listen for Cancellation Requests by Polling](../../../docs/standard/threading/how-to-listen-for-cancellation-requests-by-polling.md).</span></span>  
  
### <a name="listening-by-registering-a-callback"></a><span data-ttu-id="4cad1-171">Écoute par inscription de rappel</span><span class="sxs-lookup"><span data-stu-id="4cad1-171">Listening by Registering a Callback</span></span>  
 <span data-ttu-id="4cad1-172">Certaines opérations peuvent être bloquées et ne plus pouvoir vérifier la valeur des jetons d'annulation en temps voulu.</span><span class="sxs-lookup"><span data-stu-id="4cad1-172">Some operations can become blocked in such a way that they cannot check the value of the cancellation token in a timely manner.</span></span> <span data-ttu-id="4cad1-173">Dans ce cas, vous pouvez inscrire une méthode de rappel qui débloque la méthode quand une demande d'annulation est reçue.</span><span class="sxs-lookup"><span data-stu-id="4cad1-173">For these cases, you can register a callback method that unblocks the method when a cancellation request is received.</span></span>  
  
 <span data-ttu-id="4cad1-174">La méthode <xref:System.Threading.CancellationToken.Register%2A> retourne un objet <xref:System.Threading.CancellationTokenRegistration> utilisé spécialement à cet effet.</span><span class="sxs-lookup"><span data-stu-id="4cad1-174">The <xref:System.Threading.CancellationToken.Register%2A> method returns a <xref:System.Threading.CancellationTokenRegistration> object that is used specifically for this purpose.</span></span> <span data-ttu-id="4cad1-175">L'exemple suivant montre comment utiliser la méthode <xref:System.Threading.CancellationToken.Register%2A> pour annuler une requête web asynchrone.</span><span class="sxs-lookup"><span data-stu-id="4cad1-175">The following example shows how to use the <xref:System.Threading.CancellationToken.Register%2A> method to cancel an asynchronous Web request.</span></span>  
  
 [!code-csharp[Cancellation#4](../../../samples/snippets/csharp/VS_Snippets_Misc/cancellation/cs/cancellationex4.cs#4)]
 [!code-vb[Cancellation#4](../../../samples/snippets/visualbasic/VS_Snippets_Misc/cancellation/vb/cancellationex4.vb#4)]  
  
 <span data-ttu-id="4cad1-176">L’objet <xref:System.Threading.CancellationTokenRegistration> gère la synchronisation des threads et s’assure que le rappel cessera de s’exécuter à un point précis dans le temps.</span><span class="sxs-lookup"><span data-stu-id="4cad1-176">The <xref:System.Threading.CancellationTokenRegistration> object manages thread synchronization and ensures that the callback will stop executing at a precise point in time.</span></span>  
  
 <span data-ttu-id="4cad1-177">Pour garantir la réactivité du système et éviter les interblocages, les instructions suivantes doivent être suivies lors de l'inscription des rappels :</span><span class="sxs-lookup"><span data-stu-id="4cad1-177">In order to ensure system responsiveness and to avoid deadlocks, the following guidelines must be followed when registering callbacks:</span></span>  
  
- <span data-ttu-id="4cad1-178">La méthode de rappel doit être rapide, car elle est appelée de façon synchrone. L’appel à <xref:System.Threading.CancellationTokenSource.Cancel%2A> ne sera donc pas retourné avant le retour du rappel.</span><span class="sxs-lookup"><span data-stu-id="4cad1-178">The callback method should be fast because it is called synchronously and therefore the call to <xref:System.Threading.CancellationTokenSource.Cancel%2A> does not return until the callback returns.</span></span>  
  
- <span data-ttu-id="4cad1-179">Si vous appelez <xref:System.Threading.CancellationTokenRegistration.Dispose%2A> pendant l'exécution du rappel et détenez un verrou que le rappel attend, votre programme peut connaître un interblocage.</span><span class="sxs-lookup"><span data-stu-id="4cad1-179">If you call <xref:System.Threading.CancellationTokenRegistration.Dispose%2A> while the callback is running, and you hold a lock that the callback is waiting on, your program can deadlock.</span></span> <span data-ttu-id="4cad1-180">Après le retour de `Dispose`, vous pourrez libérer toutes les ressources requises par le rappel.</span><span class="sxs-lookup"><span data-stu-id="4cad1-180">After `Dispose` returns, you can free any resources required by the callback.</span></span>  
  
- <span data-ttu-id="4cad1-181">Les rappels ne doivent pas exécuter n'importe quel thread manuel ou n'importe quelle utilisation de <xref:System.Threading.SynchronizationContext> dans un rappel.</span><span class="sxs-lookup"><span data-stu-id="4cad1-181">Callbacks should not perform any manual thread or <xref:System.Threading.SynchronizationContext> usage in a callback.</span></span> <span data-ttu-id="4cad1-182">Si un rappel doit s’exécuter sur un thread particulier, utilisez le constructeur <xref:System.Threading.CancellationTokenRegistration?displayProperty=nameWithType> qui permet de spécifier que la cible syncContext est le <xref:System.Threading.SynchronizationContext.Current%2A?displayProperty=nameWithType> actif.</span><span class="sxs-lookup"><span data-stu-id="4cad1-182">If a callback must run on a particular thread, use the <xref:System.Threading.CancellationTokenRegistration?displayProperty=nameWithType> constructor that enables you to specify that the target syncContext is the active <xref:System.Threading.SynchronizationContext.Current%2A?displayProperty=nameWithType>.</span></span> <span data-ttu-id="4cad1-183">L'exécution de threads manuels dans un rappel peut entraîner un interblocage.</span><span class="sxs-lookup"><span data-stu-id="4cad1-183">Performing manual threading in a callback can cause deadlock.</span></span>  
  
 <span data-ttu-id="4cad1-184">Pour un exemple plus complet, consultez [Comment : enregistrer des rappels pour les requêtes d’annulation](../../../docs/standard/threading/how-to-register-callbacks-for-cancellation-requests.md).</span><span class="sxs-lookup"><span data-stu-id="4cad1-184">For a more complete example, see [How to: Register Callbacks for Cancellation Requests](../../../docs/standard/threading/how-to-register-callbacks-for-cancellation-requests.md).</span></span>  
  
### <a name="listening-by-using-a-wait-handle"></a><span data-ttu-id="4cad1-185">Écoute à l'aide d'un handle d'attente</span><span class="sxs-lookup"><span data-stu-id="4cad1-185">Listening by Using a Wait Handle</span></span>  
 <span data-ttu-id="4cad1-186">Quand une opération annulable risque de se bloquer en attendant une primitive de synchronisation, telle que <xref:System.Threading.ManualResetEvent?displayProperty=nameWithType> ou <xref:System.Threading.Semaphore?displayProperty=nameWithType>, vous pouvez utiliser la propriété <xref:System.Threading.CancellationToken.WaitHandle%2A?displayProperty=nameWithType> pour que l'opération attende à la fois l'événement et la demande d'annulation.</span><span class="sxs-lookup"><span data-stu-id="4cad1-186">When a cancelable operation can block while it waits on a synchronization primitive such as a <xref:System.Threading.ManualResetEvent?displayProperty=nameWithType> or <xref:System.Threading.Semaphore?displayProperty=nameWithType>, you can use the <xref:System.Threading.CancellationToken.WaitHandle%2A?displayProperty=nameWithType> property to enable the operation to wait on both the event and the cancellation request.</span></span> <span data-ttu-id="4cad1-187">Le handle d'attente du jeton d'annulation sera signalé en réponse à une demande d'annulation et la méthode pourra utiliser la valeur de retour de la méthode <xref:System.Threading.WaitHandle.WaitAny%2A> pour déterminer s'il s'agit de l'annulation du jeton à l'origine du signalement.</span><span class="sxs-lookup"><span data-stu-id="4cad1-187">The wait handle of the cancellation token will become signaled in response to a cancellation request, and the method can use the return value of the <xref:System.Threading.WaitHandle.WaitAny%2A> method to determine whether it was the cancellation token that signaled.</span></span> <span data-ttu-id="4cad1-188">L'opération peut alors simplement s'arrêter ou lever une <xref:System.OperationCanceledException>, selon le cas.</span><span class="sxs-lookup"><span data-stu-id="4cad1-188">The operation can then just exit, or throw a <xref:System.OperationCanceledException>, as appropriate.</span></span>  
  
 [!code-csharp[Cancellation#5](../../../samples/snippets/csharp/VS_Snippets_Misc/cancellation/cs/cancellationex9.cs#5)]
 [!code-vb[Cancellation#5](../../../samples/snippets/visualbasic/VS_Snippets_Misc/cancellation/vb/cancellationex9.vb#5)]  
  
 <span data-ttu-id="4cad1-189">Dans le nouveau code qui cible [!INCLUDE[net_v40_long](../../../includes/net-v40-long-md.md)], <xref:System.Threading.ManualResetEventSlim?displayProperty=nameWithType> et <xref:System.Threading.SemaphoreSlim?displayProperty=nameWithType> prennent en charge la nouvelle infrastructure d'annulation dans leurs méthodes `Wait`.</span><span class="sxs-lookup"><span data-stu-id="4cad1-189">In new code that targets the [!INCLUDE[net_v40_long](../../../includes/net-v40-long-md.md)], <xref:System.Threading.ManualResetEventSlim?displayProperty=nameWithType> and <xref:System.Threading.SemaphoreSlim?displayProperty=nameWithType> both support the new cancellation framework in their `Wait` methods.</span></span> <span data-ttu-id="4cad1-190">Vous pouvez passer <xref:System.Threading.CancellationToken> à la méthode. Quand l'annulation sera demandée, l'événement se réveillera et lèvera une <xref:System.OperationCanceledException>.</span><span class="sxs-lookup"><span data-stu-id="4cad1-190">You can pass the <xref:System.Threading.CancellationToken> to the method, and when the cancellation is requested, the event wakes up and throws an <xref:System.OperationCanceledException>.</span></span>  
  
 [!code-csharp[Cancellation#6](../../../samples/snippets/csharp/VS_Snippets_Misc/cancellation/cs/cancellationex10.cs#6)]
 [!code-vb[Cancellation#6](../../../samples/snippets/visualbasic/VS_Snippets_Misc/cancellation/vb/cancellationex10.vb#6)]  
  
 <span data-ttu-id="4cad1-191">Pour un exemple plus complet, consultez [Comment : écouter les requêtes d’annulation qui ont des handles d’attente](../../../docs/standard/threading/how-to-listen-for-cancellation-requests-that-have-wait-handles.md).</span><span class="sxs-lookup"><span data-stu-id="4cad1-191">For a more complete example, see [How to: Listen for Cancellation Requests That Have Wait Handles](../../../docs/standard/threading/how-to-listen-for-cancellation-requests-that-have-wait-handles.md).</span></span>  
  
### <a name="listening-to-multiple-tokens-simultaneously"></a><span data-ttu-id="4cad1-192">Écoute simultanée de plusieurs jetons</span><span class="sxs-lookup"><span data-stu-id="4cad1-192">Listening to Multiple Tokens Simultaneously</span></span>  
 <span data-ttu-id="4cad1-193">Dans certains cas, un écouteur peut avoir à écouter simultanément plusieurs jetons d'annulation.</span><span class="sxs-lookup"><span data-stu-id="4cad1-193">In some cases, a listener may have to listen to multiple cancellation tokens simultaneously.</span></span> <span data-ttu-id="4cad1-194">Par exemple, une opération annulable peut avoir à surveiller un jeton d’annulation interne en plus d’un jeton passé de manière externe comme argument à un paramètre de méthode.</span><span class="sxs-lookup"><span data-stu-id="4cad1-194">For example, a cancelable operation may have to monitor an internal cancellation token in addition to a token passed in externally as an argument to a method parameter.</span></span> <span data-ttu-id="4cad1-195">Pour ce faire, créez une source de jeton lié rassemblant plusieurs jetons au sein d'un même jeton, comme illustré dans l'exemple suivant.</span><span class="sxs-lookup"><span data-stu-id="4cad1-195">To accomplish this, create a linked token source that can join two or more tokens into one token, as shown in the following example.</span></span>  
  
 [!code-csharp[Cancellation#7](../../../samples/snippets/csharp/VS_Snippets_Misc/cancellation/cs/cancellationex13.cs#7)]
 [!code-vb[Cancellation#7](../../../samples/snippets/visualbasic/VS_Snippets_Misc/cancellation/vb/cancellationex13.vb#7)]  
  
 <span data-ttu-id="4cad1-196">Notez que vous devez appeler `Dispose` sur la source de jeton lié quand vous en avez terminé avec lui.</span><span class="sxs-lookup"><span data-stu-id="4cad1-196">Notice that you must call `Dispose` on the linked token source when you are done with it.</span></span> <span data-ttu-id="4cad1-197">Pour un exemple plus complet, consultez [Comment : écouter plusieurs requêtes d’annulation](../../../docs/standard/threading/how-to-listen-for-multiple-cancellation-requests.md).</span><span class="sxs-lookup"><span data-stu-id="4cad1-197">For a more complete example, see [How to: Listen for Multiple Cancellation Requests](../../../docs/standard/threading/how-to-listen-for-multiple-cancellation-requests.md).</span></span>  
  
## <a name="cooperation-between-library-code-and-user-code"></a><span data-ttu-id="4cad1-198">Coopération entre du code de bibliothèque et du code utilisateur</span><span class="sxs-lookup"><span data-stu-id="4cad1-198">Cooperation Between Library Code and User Code</span></span>  
 <span data-ttu-id="4cad1-199">L'infrastructure d'annulation unifiée permet au code de bibliothèque d'annuler du code utilisateur, et au code utilisateur d'annuler du code de bibliothèque de façon coopérative.</span><span class="sxs-lookup"><span data-stu-id="4cad1-199">The unified cancellation framework makes it possible for library code to cancel user code, and for user code to cancel library code in a cooperative manner.</span></span> <span data-ttu-id="4cad1-200">Pour une coopération harmonieuse, chaque côté doit respecter les recommandations suivantes :</span><span class="sxs-lookup"><span data-stu-id="4cad1-200">Smooth cooperation depends on each side following these guidelines:</span></span>  
  
- <span data-ttu-id="4cad1-201">Si le code de bibliothèque fournit des opérations annulables, il doit également fournir des méthodes publiques qui acceptent un jeton d'annulation externe pour que le code utilisateur puisse demander une annulation.</span><span class="sxs-lookup"><span data-stu-id="4cad1-201">If library code provides cancelable operations, it should also provide public methods that accept an external cancellation token so that user code can request cancellation.</span></span>  
  
- <span data-ttu-id="4cad1-202">Si le code de bibliothèque émet un appel dans le code utilisateur, le code de bibliothèque doit interpréter un OperationCanceledException(externalToken) comme une *annulation coopérative*, et pas nécessairement comme une exception d'échec.</span><span class="sxs-lookup"><span data-stu-id="4cad1-202">If library code calls into user code, the library code should interpret an OperationCanceledException(externalToken) as *cooperative cancellation*, and not necessarily as a failure exception.</span></span>  
  
- <span data-ttu-id="4cad1-203">Les délégués utilisateurs doivent tenter de répondre aux demandes d'annulation du code de bibliothèque en temps voulu.</span><span class="sxs-lookup"><span data-stu-id="4cad1-203">User-delegates should attempt to respond to cancellation requests from library code in a timely manner.</span></span>  
  
 <span data-ttu-id="4cad1-204"><xref:System.Threading.Tasks.Task?displayProperty=nameWithType> et <xref:System.Linq.ParallelEnumerable?displayProperty=nameWithType> sont des exemples de classes qui suivent ces recommandations.</span><span class="sxs-lookup"><span data-stu-id="4cad1-204"><xref:System.Threading.Tasks.Task?displayProperty=nameWithType> and <xref:System.Linq.ParallelEnumerable?displayProperty=nameWithType> are examples of classes that follow these guidelines.</span></span> <span data-ttu-id="4cad1-205">Pour plus d’informations, consultez [Annulation de tâches](../../../docs/standard/parallel-programming/task-cancellation.md) et [Comment : annuler une requête PLINQ](../../../docs/standard/parallel-programming/how-to-cancel-a-plinq-query.md).</span><span class="sxs-lookup"><span data-stu-id="4cad1-205">For more information, see [Task Cancellation](../../../docs/standard/parallel-programming/task-cancellation.md) and [How to: Cancel a PLINQ Query](../../../docs/standard/parallel-programming/how-to-cancel-a-plinq-query.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="4cad1-206">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="4cad1-206">See also</span></span>

- [<span data-ttu-id="4cad1-207">Éléments fondamentaux du threading managé</span><span class="sxs-lookup"><span data-stu-id="4cad1-207">Managed Threading Basics</span></span>](../../../docs/standard/threading/managed-threading-basics.md)
