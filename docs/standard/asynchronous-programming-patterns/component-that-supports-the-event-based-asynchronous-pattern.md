---
title: 'Comment : implémenter un composant qui prend en charge le modèle asynchrone basé sur des événements'
ms.date: 03/30/2017
ms.technology: dotnet-standard
dev_langs:
- csharp
- vb
helpviewer_keywords:
- Event-based Asynchronous Pattern
- ProgressChangedEventArgs class
- BackgroundWorker component
- events [.NET Framework], asynchronous
- Asynchronous Pattern
- AsyncOperationManager class
- threading [.NET Framework], asynchronous features
- components [.NET Framework], asynchronous
- AsyncOperation class
- threading [Windows Forms], asynchronous features
- AsyncCompletedEventArgs class
ms.assetid: 61f676b5-936f-40f6-83ce-f22805ec9c2f
ms.openlocfilehash: 44a1019ac8169138aa95b03e2027d9539cbf8391
ms.sourcegitcommit: 7588136e355e10cbc2582f389c90c127363c02a5
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 03/15/2020
ms.locfileid: "71957371"
---
# <a name="how-to-implement-a-component-that-supports-the-event-based-asynchronous-pattern"></a><span data-ttu-id="21d4b-102">Comment : implémenter un composant qui prend en charge le modèle asynchrone basé sur des événements</span><span class="sxs-lookup"><span data-stu-id="21d4b-102">How to: Implement a Component That Supports the Event-based Asynchronous Pattern</span></span>
<span data-ttu-id="21d4b-103">Si vous écrivez une classe qui comporte certaines opérations pouvant entraîner d’importants ralentissements, pensez à lui affecter des fonctionnalités asynchrones en implémentant la [Vue d’ensemble du modèle asynchrone basé sur les événements](../../../docs/standard/asynchronous-programming-patterns/event-based-asynchronous-pattern-overview.md).</span><span class="sxs-lookup"><span data-stu-id="21d4b-103">If you are writing a class with some operations that may incur noticeable delays, consider giving it asynchronous functionality by implementing the [Event-based Asynchronous Pattern Overview](../../../docs/standard/asynchronous-programming-patterns/event-based-asynchronous-pattern-overview.md).</span></span>  
  
 <span data-ttu-id="21d4b-104">Cette procédure pas à pas montre comment créer un composant qui applique le modèle asynchrone basé sur les événements.</span><span class="sxs-lookup"><span data-stu-id="21d4b-104">This walkthrough illustrates how to create a component that implements the Event-based Asynchronous Pattern.</span></span> <span data-ttu-id="21d4b-105">Il est implémenté à l’aide de classes d’assistance provenant de l’espace de noms <xref:System.ComponentModel?displayProperty=nameWithType>, ce qui garantit son bon fonctionnement quel que soit le modèle d’application, notamment ASP.NET, les applications console et les applications Windows Forms.</span><span class="sxs-lookup"><span data-stu-id="21d4b-105">It is implemented using helper classes from the <xref:System.ComponentModel?displayProperty=nameWithType> namespace, which ensures that the component works correctly under any application model, including ASP.NET, Console applications and Windows Forms applications.</span></span> <span data-ttu-id="21d4b-106">Vous pouvez également le concevoir avec un contrôle <xref:System.Windows.Forms.PropertyGrid> et vos propres concepteurs personnalisés.</span><span class="sxs-lookup"><span data-stu-id="21d4b-106">This component is also designable with a <xref:System.Windows.Forms.PropertyGrid> control and your own custom designers.</span></span>  
  
 <span data-ttu-id="21d4b-107">À la fin, vous disposerez d’une application qui calcule les nombres premiers de manière asynchrone.</span><span class="sxs-lookup"><span data-stu-id="21d4b-107">When you are through, you will have an application that computes prime numbers asynchronously.</span></span> <span data-ttu-id="21d4b-108">Votre application aura un thread d’interface utilisateur (IU) principal et un thread pour chaque calcul de nombres premiers.</span><span class="sxs-lookup"><span data-stu-id="21d4b-108">Your application will have a main user interface (UI) thread and a thread for each prime number calculation.</span></span> <span data-ttu-id="21d4b-109">Bien qu’il puisse être long de tester si un grand nombre est un nombre premier, le thread d’UI principal ne sera pas interrompu par ce ralentissement, et le formulaire restera réactif tout au long des calculs.</span><span class="sxs-lookup"><span data-stu-id="21d4b-109">Although testing whether a large number is prime can take a noticeable amount of time, the main UI thread will not be interrupted by this delay, and the form will be responsive during the calculations.</span></span> <span data-ttu-id="21d4b-110">Vous pourrez lancer autant de calculs que vous le souhaiterez simultanément, et annuler de manière sélective des calculs en attente.</span><span class="sxs-lookup"><span data-stu-id="21d4b-110">You will be able to run as many calculations as you like concurrently and selectively cancel pending calculations.</span></span>  
  
 <span data-ttu-id="21d4b-111">Cette procédure pas à pas décrit notamment les tâches suivantes :</span><span class="sxs-lookup"><span data-stu-id="21d4b-111">Tasks illustrated in this walkthrough include:</span></span>  
  
- <span data-ttu-id="21d4b-112">Création du composant</span><span class="sxs-lookup"><span data-stu-id="21d4b-112">Creating the Component</span></span>  
  
- <span data-ttu-id="21d4b-113">Définir des délégués et des événements asynchrones publics</span><span class="sxs-lookup"><span data-stu-id="21d4b-113">Defining Public Asynchronous Events and Delegates</span></span>  
  
- <span data-ttu-id="21d4b-114">Définir des délégués privés</span><span class="sxs-lookup"><span data-stu-id="21d4b-114">Defining Private Delegates</span></span>  
  
- <span data-ttu-id="21d4b-115">Implémenter des événements publics</span><span class="sxs-lookup"><span data-stu-id="21d4b-115">Implementing Public Events</span></span>  
  
- <span data-ttu-id="21d4b-116">Implémenter la méthode d’achèvement</span><span class="sxs-lookup"><span data-stu-id="21d4b-116">Implementing the Completion Method</span></span>  
  
- <span data-ttu-id="21d4b-117">Implémenter les méthodes de travail</span><span class="sxs-lookup"><span data-stu-id="21d4b-117">Implementing the Worker Methods</span></span>  
  
- <span data-ttu-id="21d4b-118">Implémenter des méthodes de démarrage et d’annulation</span><span class="sxs-lookup"><span data-stu-id="21d4b-118">Implementing Start and Cancel Methods</span></span>  
  
 <span data-ttu-id="21d4b-119">Pour copier le code dans cette rubrique sous la forme d’une liste unique, consultez [Comment : implémenter un client du modèle asynchrone basé sur les événements](../../../docs/standard/asynchronous-programming-patterns/how-to-implement-a-client-of-the-event-based-asynchronous-pattern.md).</span><span class="sxs-lookup"><span data-stu-id="21d4b-119">To copy the code in this topic as a single listing, see [How to: Implement a Client of the Event-based Asynchronous Pattern](../../../docs/standard/asynchronous-programming-patterns/how-to-implement-a-client-of-the-event-based-asynchronous-pattern.md).</span></span>  
  
## <a name="creating-the-component"></a><span data-ttu-id="21d4b-120">Création du composant</span><span class="sxs-lookup"><span data-stu-id="21d4b-120">Creating the Component</span></span>  
 <span data-ttu-id="21d4b-121">La première étape consiste à créer le composant qui implémentera le modèle asynchrone basé sur les événements.</span><span class="sxs-lookup"><span data-stu-id="21d4b-121">The first step is to create the component that will implement the Event-based Asynchronous Pattern.</span></span>  
  
### <a name="to-create-the-component"></a><span data-ttu-id="21d4b-122">Pour créer le composant :</span><span class="sxs-lookup"><span data-stu-id="21d4b-122">To create the component</span></span>  
  
- <span data-ttu-id="21d4b-123">Créez une classe nommée `PrimeNumberCalculator` qui hérite de <xref:System.ComponentModel.Component>.</span><span class="sxs-lookup"><span data-stu-id="21d4b-123">Create a class called `PrimeNumberCalculator` that inherits from <xref:System.ComponentModel.Component>.</span></span>  
  
## <a name="defining-public-asynchronous-events-and-delegates"></a><span data-ttu-id="21d4b-124">Définir des délégués et des événements asynchrones publics</span><span class="sxs-lookup"><span data-stu-id="21d4b-124">Defining Public Asynchronous Events and Delegates</span></span>  
 <span data-ttu-id="21d4b-125">Votre composant communique avec les clients à l’aide d’événements.</span><span class="sxs-lookup"><span data-stu-id="21d4b-125">Your component communicates to clients using events.</span></span> <span data-ttu-id="21d4b-126">L’événement _MethodName_**Completed** avertit les clients de l’achèvement d’une tâche asynchrone, et l’événement _MethodName_**ProgressChanged** les informe de la progression d’une tâche asynchrone.</span><span class="sxs-lookup"><span data-stu-id="21d4b-126">The _MethodName_**Completed** event alerts clients to the completion of an asynchronous task, and the _MethodName_**ProgressChanged** event informs clients of the progress of an asynchronous task.</span></span>  
  
### <a name="to-define-asynchronous-events-for-clients-of-your-component"></a><span data-ttu-id="21d4b-127">Pour définir des événements asynchrones pour les clients de votre composant :</span><span class="sxs-lookup"><span data-stu-id="21d4b-127">To define asynchronous events for clients of your component:</span></span>  
  
1. <span data-ttu-id="21d4b-128">Importer les espaces de noms <xref:System.Threading?displayProperty=nameWithType> et <xref:System.Collections.Specialized?displayProperty=nameWithType> en haut de votre fichier.</span><span class="sxs-lookup"><span data-stu-id="21d4b-128">Import the <xref:System.Threading?displayProperty=nameWithType> and <xref:System.Collections.Specialized?displayProperty=nameWithType> namespaces at the top of your file.</span></span>  
  
     [!code-csharp[System.ComponentModel.AsyncOperationManager#11](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#11)]
     [!code-vb[System.ComponentModel.AsyncOperationManager#11](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#11)]  
  
2. <span data-ttu-id="21d4b-129">Avant la définition de la classe `PrimeNumberCalculator`, déclarez des délégués pour les événements de progression et d’achèvement.</span><span class="sxs-lookup"><span data-stu-id="21d4b-129">Before the `PrimeNumberCalculator` class definition, declare delegates for progress and completion events.</span></span>  
  
     [!code-csharp[System.ComponentModel.AsyncOperationManager#7](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#7)]
     [!code-vb[System.ComponentModel.AsyncOperationManager#7](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#7)]  
  
3. <span data-ttu-id="21d4b-130">Dans la définition de la classe `PrimeNumberCalculator`, déclarez des événements signalant la progression et l’achèvement aux clients.</span><span class="sxs-lookup"><span data-stu-id="21d4b-130">In the `PrimeNumberCalculator` class definition, declare events for reporting progress and completion to clients.</span></span>  
  
     [!code-csharp[System.ComponentModel.AsyncOperationManager#8](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#8)]
     [!code-vb[System.ComponentModel.AsyncOperationManager#8](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#8)]  
  
4. <span data-ttu-id="21d4b-131">Après la définition de la classe `PrimeNumberCalculator`, dérivez la classe `CalculatePrimeCompletedEventArgs` pour signaler le résultat de chaque calcul au gestionnaire d’événements du client pour l’événement `CalculatePrimeCompleted`.</span><span class="sxs-lookup"><span data-stu-id="21d4b-131">After the `PrimeNumberCalculator` class definition, derive the `CalculatePrimeCompletedEventArgs` class for reporting the outcome of each calculation to the client's event handler for the `CalculatePrimeCompleted`.event.</span></span> <span data-ttu-id="21d4b-132">Outre les propriétés `AsyncCompletedEventArgs`, cette classe permet au client déterminer quel nombre a été testé, s’il est premier et, si ce n’est pas le cas, quel est le premier diviseur.</span><span class="sxs-lookup"><span data-stu-id="21d4b-132">In addition to the `AsyncCompletedEventArgs` properties, this class enables the client to determine what number was tested, whether it is prime, and what the first divisor is if it is not prime.</span></span>  
  
     [!code-csharp[System.ComponentModel.AsyncOperationManager#6](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#6)]
     [!code-vb[System.ComponentModel.AsyncOperationManager#6](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#6)]  
  
## <a name="checkpoint"></a><span data-ttu-id="21d4b-133">Point de contrôle</span><span class="sxs-lookup"><span data-stu-id="21d4b-133">Checkpoint</span></span>  
 <span data-ttu-id="21d4b-134">Vous pouvez maintenant générer le composant.</span><span class="sxs-lookup"><span data-stu-id="21d4b-134">At this point, you can build the component.</span></span>  
  
### <a name="to-test-your-component"></a><span data-ttu-id="21d4b-135">Pour tester le composant :</span><span class="sxs-lookup"><span data-stu-id="21d4b-135">To test your component</span></span>  
  
- <span data-ttu-id="21d4b-136">Compilez le composant.</span><span class="sxs-lookup"><span data-stu-id="21d4b-136">Compile the component.</span></span>  
  
     <span data-ttu-id="21d4b-137">Vous recevrez deux avertissements du compilateur :</span><span class="sxs-lookup"><span data-stu-id="21d4b-137">You will receive two compiler warnings:</span></span>  
  
    ```console  
    warning CS0067: The event 'AsynchronousPatternExample.PrimeNumberCalculator.ProgressChanged' is never used  
    warning CS0067: The event 'AsynchronousPatternExample.PrimeNumberCalculator.CalculatePrimeCompleted' is never used  
    ```  
  
     <span data-ttu-id="21d4b-138">Ces avertissements seront effacés dans la section suivante.</span><span class="sxs-lookup"><span data-stu-id="21d4b-138">These warnings will be cleared in the next section.</span></span>  
  
## <a name="defining-private-delegates"></a><span data-ttu-id="21d4b-139">Définir des délégués privés</span><span class="sxs-lookup"><span data-stu-id="21d4b-139">Defining Private Delegates</span></span>  
 <span data-ttu-id="21d4b-140">Les aspects asynchrones du composant `PrimeNumberCalculator` sont implémentés en interne avec un délégué spécial appelé <xref:System.Threading.SendOrPostCallback>.</span><span class="sxs-lookup"><span data-stu-id="21d4b-140">The asynchronous aspects of the `PrimeNumberCalculator` component are implemented internally with a special delegate known as a <xref:System.Threading.SendOrPostCallback>.</span></span> <span data-ttu-id="21d4b-141"><xref:System.Threading.SendOrPostCallback> représente une méthode de rappel qui s’exécute sur un thread <xref:System.Threading.ThreadPool>.</span><span class="sxs-lookup"><span data-stu-id="21d4b-141">A <xref:System.Threading.SendOrPostCallback> represents a callback method that executes on a <xref:System.Threading.ThreadPool> thread.</span></span> <span data-ttu-id="21d4b-142">Elle doit avoir une signature qui prend un seul paramètre de type <xref:System.Object>, ce qui signifie qu’il vous faudra transmettre l’état entre les délégués dans une classe wrapper.</span><span class="sxs-lookup"><span data-stu-id="21d4b-142">The callback method must have a signature that takes a single parameter of type <xref:System.Object>, which means you will need to pass state among delegates in a wrapper class.</span></span> <span data-ttu-id="21d4b-143">Pour plus d’informations, consultez <xref:System.Threading.SendOrPostCallback>.</span><span class="sxs-lookup"><span data-stu-id="21d4b-143">For more information, see <xref:System.Threading.SendOrPostCallback>.</span></span>  
  
### <a name="to-implement-your-components-internal-asynchronous-behavior"></a><span data-ttu-id="21d4b-144">Pour implémenter le comportement asynchrone interne du composant :</span><span class="sxs-lookup"><span data-stu-id="21d4b-144">To implement your component's internal asynchronous behavior:</span></span>  
  
1. <span data-ttu-id="21d4b-145">Déclarez et créez le délégué <xref:System.Threading.SendOrPostCallback> dans la classe `PrimeNumberCalculator`.</span><span class="sxs-lookup"><span data-stu-id="21d4b-145">Declare and create the <xref:System.Threading.SendOrPostCallback> delegates in the `PrimeNumberCalculator` class.</span></span> <span data-ttu-id="21d4b-146">Créez les objets <xref:System.Threading.SendOrPostCallback> dans une méthode utilitaire nommée `InitializeDelegates`.</span><span class="sxs-lookup"><span data-stu-id="21d4b-146">Create the <xref:System.Threading.SendOrPostCallback> objects in a utility method called `InitializeDelegates`.</span></span>  
  
     <span data-ttu-id="21d4b-147">Vous aurez besoin de deux délégués : un pour signaler la progression au client, l’autre pour lui signaler l’achèvement.</span><span class="sxs-lookup"><span data-stu-id="21d4b-147">You will need two delegates: one for reporting progress to the client, and one for reporting completion to the client.</span></span>  
  
     [!code-csharp[System.ComponentModel.AsyncOperationManager#9](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#9)]
     [!code-vb[System.ComponentModel.AsyncOperationManager#9](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#9)]  
    [!code-csharp[System.ComponentModel.AsyncOperationManager#20](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#20)]
    [!code-vb[System.ComponentModel.AsyncOperationManager#20](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#20)]  
  
2. <span data-ttu-id="21d4b-148">Appelez la méthode `InitializeDelegates` dans le constructeur de votre composant.</span><span class="sxs-lookup"><span data-stu-id="21d4b-148">Call the `InitializeDelegates` method in your component's constructor.</span></span>  
  
     [!code-csharp[System.ComponentModel.AsyncOperationManager#21](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#21)]
     [!code-vb[System.ComponentModel.AsyncOperationManager#21](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#21)]  
  
3. <span data-ttu-id="21d4b-149">Déclarez un délégué dans la classe `PrimeNumberCalculator` qui gère concrètement le travail à faire de façon asynchrone.</span><span class="sxs-lookup"><span data-stu-id="21d4b-149">Declare a delegate in the `PrimeNumberCalculator` class that handles the actual work to be done asynchronously.</span></span> <span data-ttu-id="21d4b-150">Il inclut dans un wrapper la méthode de travail qui teste si un nombre est premier.</span><span class="sxs-lookup"><span data-stu-id="21d4b-150">This delegate wraps the worker method that tests whether a number is prime.</span></span> <span data-ttu-id="21d4b-151">Le délégué prend un paramètre <xref:System.ComponentModel.AsyncOperation>, qui sera utilisé pour effectuer le suivi de la durée de vie de l’opération asynchrone.</span><span class="sxs-lookup"><span data-stu-id="21d4b-151">The delegate takes an <xref:System.ComponentModel.AsyncOperation> parameter, which will be used to track the lifetime of the asynchronous operation.</span></span>  
  
     [!code-csharp[System.ComponentModel.AsyncOperationManager#22](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#22)]
     [!code-vb[System.ComponentModel.AsyncOperationManager#22](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#22)]  
  
4. <span data-ttu-id="21d4b-152">Créez une collection pour gérer la durée de vie des opérations asynchrones en attente.</span><span class="sxs-lookup"><span data-stu-id="21d4b-152">Create a collection for managing lifetimes of pending asynchronous operations.</span></span> <span data-ttu-id="21d4b-153">Le client a besoin d’un moyen d’effectuer le suivi des opérations à l’exécution et à l’achèvement, en transmettant un ID de tâche ou un jeton unique lorsqu’il effectue l’appel à la méthode asynchrone.</span><span class="sxs-lookup"><span data-stu-id="21d4b-153">The client needs a way to track operations as they are executed and completed, and this tracking is done by requiring the client to pass a unique token, or task ID, when the client makes the call to the asynchronous method.</span></span> <span data-ttu-id="21d4b-154">Le composant `PrimeNumberCalculator` doit garder la trace de chaque appel en associant l’ID de tâche à l’appel correspondant.</span><span class="sxs-lookup"><span data-stu-id="21d4b-154">The `PrimeNumberCalculator` component must keep track of each call by associating the task ID with its corresponding invocation.</span></span> <span data-ttu-id="21d4b-155">Si le client transmet un ID de tâche non unique, le composant `PrimeNumberCalculator` doit lever une exception.</span><span class="sxs-lookup"><span data-stu-id="21d4b-155">If the client passes a task ID that is not unique, the `PrimeNumberCalculator` component must raise an exception.</span></span>  
  
     <span data-ttu-id="21d4b-156">Le composant `PrimeNumberCalculator` garde la trace de l’ID de tâche à l’aide d’une classe de collection spéciale appelée <xref:System.Collections.Specialized.HybridDictionary>.</span><span class="sxs-lookup"><span data-stu-id="21d4b-156">The `PrimeNumberCalculator` component keeps track of task ID by using a special collection class called a <xref:System.Collections.Specialized.HybridDictionary>.</span></span> <span data-ttu-id="21d4b-157">Dans la définition de classe, créez un <xref:System.Collections.Specialized.HybridDictionary> nommé `userTokenToLifetime`.</span><span class="sxs-lookup"><span data-stu-id="21d4b-157">In the class definition, create a <xref:System.Collections.Specialized.HybridDictionary> called `userTokenToLifetime`.</span></span>  
  
     [!code-csharp[System.ComponentModel.AsyncOperationManager#23](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#23)]
     [!code-vb[System.ComponentModel.AsyncOperationManager#23](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#23)]  
  
## <a name="implementing-public-events"></a><span data-ttu-id="21d4b-158">Implémenter des événements publics</span><span class="sxs-lookup"><span data-stu-id="21d4b-158">Implementing Public Events</span></span>  
 <span data-ttu-id="21d4b-159">Les composants qui implémentent le modèle asynchrone basé sur les événements communiquent avec les clients à l’aide d’événements.</span><span class="sxs-lookup"><span data-stu-id="21d4b-159">Components that implement the Event-based Asynchronous Pattern communicate to clients using events.</span></span> <span data-ttu-id="21d4b-160">Ces événements sont appelés sur le thread adéquat à l’aide de la classe <xref:System.ComponentModel.AsyncOperation>.</span><span class="sxs-lookup"><span data-stu-id="21d4b-160">These events are invoked on the proper thread with the help of the <xref:System.ComponentModel.AsyncOperation> class.</span></span>  
  
### <a name="to-raise-events-to-your-components-clients"></a><span data-ttu-id="21d4b-161">Pour déclencher des événements sur les clients du composant :</span><span class="sxs-lookup"><span data-stu-id="21d4b-161">To raise events to your component's clients:</span></span>  
  
1. <span data-ttu-id="21d4b-162">Implémentez des événements publics permettant d’informer les clients.</span><span class="sxs-lookup"><span data-stu-id="21d4b-162">Implement public events for reporting to clients.</span></span> <span data-ttu-id="21d4b-163">Vous aurez besoin d’un événement pour signaler la progression et d’un autre pour signaler l’achèvement.</span><span class="sxs-lookup"><span data-stu-id="21d4b-163">You will need an event for reporting progress and one for reporting completion.</span></span>  
  
     [!code-csharp[System.ComponentModel.AsyncOperationManager#24](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#24)]
     [!code-vb[System.ComponentModel.AsyncOperationManager#24](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#24)]  
  
## <a name="implementing-the-completion-method"></a><span data-ttu-id="21d4b-164">Implémenter la méthode d’achèvement</span><span class="sxs-lookup"><span data-stu-id="21d4b-164">Implementing the Completion Method</span></span>  
 <span data-ttu-id="21d4b-165">Le délégué d’achèvement est la méthode qui appelle le comportement asynchrone à threads libres sous-jacent lorsque l’opération asynchrone aboutit correctement, se termine par une erreur ou est annulée.</span><span class="sxs-lookup"><span data-stu-id="21d4b-165">The completion delegate is the method that the underlying, free-threaded asynchronous behavior will invoke when the asynchronous operation ends by successful completion, error, or cancellation.</span></span> <span data-ttu-id="21d4b-166">Cet appel a lieu sur un thread arbitraire.</span><span class="sxs-lookup"><span data-stu-id="21d4b-166">This invocation happens on an arbitrary thread.</span></span>  
  
 <span data-ttu-id="21d4b-167">C’est dans cette méthode que l’ID de tâche du client est supprimé de la collection interne de jetons de clients uniques.</span><span class="sxs-lookup"><span data-stu-id="21d4b-167">This method is where the client's task ID is removed from the internal collection of unique client tokens.</span></span> <span data-ttu-id="21d4b-168">Cette méthode met également fin à la durée de vie d’une opération asynchrone en particulier en appelant la méthode <xref:System.ComponentModel.AsyncOperation.PostOperationCompleted%2A> sur la <xref:System.ComponentModel.AsyncOperation> correspondante.</span><span class="sxs-lookup"><span data-stu-id="21d4b-168">This method also ends the lifetime of a particular asynchronous operation by calling the <xref:System.ComponentModel.AsyncOperation.PostOperationCompleted%2A> method on the corresponding <xref:System.ComponentModel.AsyncOperation>.</span></span> <span data-ttu-id="21d4b-169">Cet appel déclenche l’événement d’achèvement sur le thread adapté au modèle d’application.</span><span class="sxs-lookup"><span data-stu-id="21d4b-169">This call raises the completion event on the thread that is appropriate for the application model.</span></span> <span data-ttu-id="21d4b-170">Une fois que la méthode <xref:System.ComponentModel.AsyncOperation.PostOperationCompleted%2A> a été appelée, cette instance de <xref:System.ComponentModel.AsyncOperation> n’est plus utilisable, et toute tentative ultérieure de l’utiliser lèvera une exception.</span><span class="sxs-lookup"><span data-stu-id="21d4b-170">After the <xref:System.ComponentModel.AsyncOperation.PostOperationCompleted%2A> method is called, this instance of <xref:System.ComponentModel.AsyncOperation> can no longer be used, and any subsequent attempts to use it will throw an exception.</span></span>  
  
 <span data-ttu-id="21d4b-171">La signature `CompletionMethod` doit contenir tout l’état nécessaire pour décrire le résultat de l’opération asynchrone.</span><span class="sxs-lookup"><span data-stu-id="21d4b-171">The `CompletionMethod` signature must hold all state necessary to describe the outcome of the asynchronous operation.</span></span> <span data-ttu-id="21d4b-172">Elle conserve l’état du nombre qui a été testé par cette opération asynchrone en particulier, l’information consistant à savoir si le nombre est premier ou non et la valeur de son premier diviseur si ce n’est pas le cas.</span><span class="sxs-lookup"><span data-stu-id="21d4b-172">It holds state for the number that was tested by this particular asynchronous operation, whether the number is prime, and the value of its first divisor if it is not a prime number.</span></span> <span data-ttu-id="21d4b-173">Elle renferme également l’état décrivant les exceptions qui sont produites, et la <xref:System.ComponentModel.AsyncOperation> correspondant à cette tâche particulière.</span><span class="sxs-lookup"><span data-stu-id="21d4b-173">It also holds state describing any exception that occurred, and the <xref:System.ComponentModel.AsyncOperation> corresponding to this particular task.</span></span>  
  
### <a name="to-complete-an-asynchronous-operation"></a><span data-ttu-id="21d4b-174">Pour achever une opération asynchrone :</span><span class="sxs-lookup"><span data-stu-id="21d4b-174">To complete an asynchronous operation:</span></span>  
  
- <span data-ttu-id="21d4b-175">Implémentez la méthode d’achèvement.</span><span class="sxs-lookup"><span data-stu-id="21d4b-175">Implement the completion method.</span></span> <span data-ttu-id="21d4b-176">Elle prend six paramètres, qu’elle utilise pour remplir un `CalculatePrimeCompletedEventArgs` qui est retourné au client par le biais du `CalculatePrimeCompletedEventHandler` du client.</span><span class="sxs-lookup"><span data-stu-id="21d4b-176">It takes six parameters, which it uses to populate a `CalculatePrimeCompletedEventArgs` that is returned to the client through the client's `CalculatePrimeCompletedEventHandler`.</span></span> <span data-ttu-id="21d4b-177">Elle supprime le jeton d’ID tâche du client de la collection interne et met fin à la durée de vie de l’opération asynchrone par un appel à <xref:System.ComponentModel.AsyncOperation.PostOperationCompleted%2A>.</span><span class="sxs-lookup"><span data-stu-id="21d4b-177">It removes the client's task ID token from the internal collection, and it ends the asynchronous operation's lifetime with a call to <xref:System.ComponentModel.AsyncOperation.PostOperationCompleted%2A>.</span></span> <span data-ttu-id="21d4b-178">La <xref:System.ComponentModel.AsyncOperation> marshale l’appel au thread ou au contexte adapté au modèle d'application.</span><span class="sxs-lookup"><span data-stu-id="21d4b-178">The <xref:System.ComponentModel.AsyncOperation> marshals the call to the thread or context that is appropriate for the application model.</span></span>  
  
     [!code-csharp[System.ComponentModel.AsyncOperationManager#26](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#26)]
     [!code-vb[System.ComponentModel.AsyncOperationManager#26](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#26)]  
  
## <a name="checkpoint"></a><span data-ttu-id="21d4b-179">Point de contrôle</span><span class="sxs-lookup"><span data-stu-id="21d4b-179">Checkpoint</span></span>  
 <span data-ttu-id="21d4b-180">Vous pouvez maintenant générer le composant.</span><span class="sxs-lookup"><span data-stu-id="21d4b-180">At this point, you can build the component.</span></span>  
  
### <a name="to-test-your-component"></a><span data-ttu-id="21d4b-181">Pour tester le composant :</span><span class="sxs-lookup"><span data-stu-id="21d4b-181">To test your component</span></span>  
  
- <span data-ttu-id="21d4b-182">Compilez le composant.</span><span class="sxs-lookup"><span data-stu-id="21d4b-182">Compile the component.</span></span>  
  
     <span data-ttu-id="21d4b-183">Vous recevrez un avertissement du compilateur :</span><span class="sxs-lookup"><span data-stu-id="21d4b-183">You will receive one compiler warning:</span></span>  
  
    ```console  
    warning CS0169: The private field 'AsynchronousPatternExample.PrimeNumberCalculator.workerDelegate' is never used  
    ```  
  
     <span data-ttu-id="21d4b-184">Cet avertissement sera résolu dans la section suivante.</span><span class="sxs-lookup"><span data-stu-id="21d4b-184">This warning will be resolved in the next section.</span></span>  
  
## <a name="implementing-the-worker-methods"></a><span data-ttu-id="21d4b-185">Implémenter les méthodes de travail</span><span class="sxs-lookup"><span data-stu-id="21d4b-185">Implementing the Worker Methods</span></span>  
 <span data-ttu-id="21d4b-186">Pour le moment, vous avez implémenté le code asynchrone d’accompagnement du composant `PrimeNumberCalculator`.</span><span class="sxs-lookup"><span data-stu-id="21d4b-186">So far, you have implemented the supporting asynchronous code for the `PrimeNumberCalculator` component.</span></span> <span data-ttu-id="21d4b-187">Vous pouvez maintenant écrire le code qui effectue concrètement le travail.</span><span class="sxs-lookup"><span data-stu-id="21d4b-187">Now you can implement the code that does the actual work.</span></span> <span data-ttu-id="21d4b-188">Vous allez implémenter trois méthodes : `CalculateWorker`, `BuildPrimeNumberList` et `IsPrime`.</span><span class="sxs-lookup"><span data-stu-id="21d4b-188">You will implement three methods: `CalculateWorker`, `BuildPrimeNumberList`, and `IsPrime`.</span></span> <span data-ttu-id="21d4b-189">Ensemble, `BuildPrimeNumberList` et `IsPrime` composent un algorithme connu, appelé le crible d'Ératosthène, qui détermine si un nombre est premier en recherchant tous les nombres premiers jusqu'à la racine carrée du nombre testé.</span><span class="sxs-lookup"><span data-stu-id="21d4b-189">Together, `BuildPrimeNumberList` and `IsPrime` comprise a well-known algorithm called the Sieve of Eratosthenes, which determines if a number is prime by finding all the prime numbers up to the square root of the test number.</span></span> <span data-ttu-id="21d4b-190">Si aucun diviseur n’est trouvé jusque-là, le numéro testé est un nombre premier.</span><span class="sxs-lookup"><span data-stu-id="21d4b-190">If no divisors are found by that point, the test number is prime.</span></span>  
  
 <span data-ttu-id="21d4b-191">Si ce composant était écrit dans une optique d’efficacité maximale, il mémoriserait tous les nombres premiers découverts par différents appels sur différents nombres testés.</span><span class="sxs-lookup"><span data-stu-id="21d4b-191">If this component were written for maximum efficiency, it would remember all the prime numbers discovered by various invocations for different test numbers.</span></span> <span data-ttu-id="21d4b-192">Il vérifierait également les diviseurs triviaux, comme 2, 3 et 5.</span><span class="sxs-lookup"><span data-stu-id="21d4b-192">It would also check for trivial divisors like 2, 3, and 5.</span></span> <span data-ttu-id="21d4b-193">Cependant, l’objectif de cet exemple est de montrer comment exécuter des opérations longues de façon asynchrone ; nous vous laissons donc le soin d’implémenter ces optimisations pour vous exercer.</span><span class="sxs-lookup"><span data-stu-id="21d4b-193">The intent of this example is to demonstrate how time-consuming operations can be executed asynchronously, however, so these optimizations are left as an exercise for you.</span></span>  
  
 <span data-ttu-id="21d4b-194">La méthode `CalculateWorker` est incluse dans un délégué et invoquée de façon asynchrone avec un appel à `BeginInvoke`.</span><span class="sxs-lookup"><span data-stu-id="21d4b-194">The `CalculateWorker` method is wrapped in a delegate and is invoked asynchronously with a call to `BeginInvoke`.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="21d4b-195">Le signalement de la progression est implémenté dans la méthode `BuildPrimeNumberList`.</span><span class="sxs-lookup"><span data-stu-id="21d4b-195">Progress reporting is implemented in the `BuildPrimeNumberList` method.</span></span> <span data-ttu-id="21d4b-196">Sur les ordinateurs rapides, il est possible de déclencher les événements `ProgressChanged` à courts intervalles.</span><span class="sxs-lookup"><span data-stu-id="21d4b-196">On fast computers, `ProgressChanged` events can be raised in rapid succession.</span></span> <span data-ttu-id="21d4b-197">Le thread du client, sur lequel ces événements sont déclenchés, doit être en mesure de gérer cette situation.</span><span class="sxs-lookup"><span data-stu-id="21d4b-197">The client thread, on which these events are raised, must be able to handle this situation.</span></span> <span data-ttu-id="21d4b-198">Le code de l’interface utilisateur pourrait être submergé par les messages et incapable de suivre le rythme, ce qui provoquerait une absence de réponse.</span><span class="sxs-lookup"><span data-stu-id="21d4b-198">User interface code may be flooded with messages and unable to keep up, resulting in unresponsiveness.</span></span> <span data-ttu-id="21d4b-199">Vous trouverez un exemple de client qui gère cette situation sur la page [Guide pratique : implémenter un client du modèle asynchrone basé sur les événements](../../../docs/standard/asynchronous-programming-patterns/how-to-implement-a-client-of-the-event-based-asynchronous-pattern.md).</span><span class="sxs-lookup"><span data-stu-id="21d4b-199">For an example user interface that handles this situation, see [How to: Implement a Client of the Event-based Asynchronous Pattern](../../../docs/standard/asynchronous-programming-patterns/how-to-implement-a-client-of-the-event-based-asynchronous-pattern.md).</span></span>  
  
### <a name="to-execute-the-prime-number-calculation-asynchronously"></a><span data-ttu-id="21d4b-200">Pour exécuter de façon asynchrone le calcul de nombres premiers :</span><span class="sxs-lookup"><span data-stu-id="21d4b-200">To execute the prime number calculation asynchronously:</span></span>  
  
1. <span data-ttu-id="21d4b-201">Implémentez la méthode utilitaire `TaskCanceled`.</span><span class="sxs-lookup"><span data-stu-id="21d4b-201">Implement the `TaskCanceled` utility method.</span></span> <span data-ttu-id="21d4b-202">Elle recherche la collection de durée de vie de la tâche pour l’ID de tâche donné, et retourne `true` si l’ID de tâche est introuvable.</span><span class="sxs-lookup"><span data-stu-id="21d4b-202">This checks the task lifetime collection for the given task ID, and returns `true` if the task ID is not found.</span></span>  
  
     [!code-csharp[System.ComponentModel.AsyncOperationManager#32](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#32)]
     [!code-vb[System.ComponentModel.AsyncOperationManager#32](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#32)]  
  
2. <span data-ttu-id="21d4b-203">Implémentez la méthode `CalculateWorker`.</span><span class="sxs-lookup"><span data-stu-id="21d4b-203">Implement the `CalculateWorker` method.</span></span> <span data-ttu-id="21d4b-204">Elle prend deux paramètres : un nombre à tester et une <xref:System.ComponentModel.AsyncOperation>.</span><span class="sxs-lookup"><span data-stu-id="21d4b-204">It takes two parameters: a number to test, and an <xref:System.ComponentModel.AsyncOperation>.</span></span>  
  
     [!code-csharp[System.ComponentModel.AsyncOperationManager#27](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#27)]
     [!code-vb[System.ComponentModel.AsyncOperationManager#27](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#27)]  
  
3. <span data-ttu-id="21d4b-205">Implémentez `BuildPrimeNumberList`.</span><span class="sxs-lookup"><span data-stu-id="21d4b-205">Implement `BuildPrimeNumberList`.</span></span> <span data-ttu-id="21d4b-206">Elle prend deux paramètres : le nombre à tester et une <xref:System.ComponentModel.AsyncOperation>.</span><span class="sxs-lookup"><span data-stu-id="21d4b-206">It takes two parameters: the number to test, and an <xref:System.ComponentModel.AsyncOperation>.</span></span> <span data-ttu-id="21d4b-207">Elle utilise la <xref:System.ComponentModel.AsyncOperation> pour signaler la progression et les résultats incrémentiels.</span><span class="sxs-lookup"><span data-stu-id="21d4b-207">It uses the <xref:System.ComponentModel.AsyncOperation> to report progress and incremental results.</span></span> <span data-ttu-id="21d4b-208">Cela garantit que les gestionnaires d’événements du client sont appelés sur le thread ou le contexte adapté au modèle d’application.</span><span class="sxs-lookup"><span data-stu-id="21d4b-208">This assures that the client's event handlers are called on the proper thread or context for the application model.</span></span> <span data-ttu-id="21d4b-209">Lorsque `BuildPrimeNumberList` trouve un nombre premier, elle le signale comme un résultat incrémentiel au gestionnaire d’événements du client pour l’événement `ProgressChanged`.</span><span class="sxs-lookup"><span data-stu-id="21d4b-209">When `BuildPrimeNumberList` finds a prime number, it reports this as an incremental result to the client's event handler for the `ProgressChanged` event.</span></span> <span data-ttu-id="21d4b-210">Cela requiert une classe dérivée de <xref:System.ComponentModel.ProgressChangedEventArgs>, appelée `CalculatePrimeProgressChangedEventArgs`, possédant une propriété supplémentaire nommée `LatestPrimeNumber`.</span><span class="sxs-lookup"><span data-stu-id="21d4b-210">This requires a class derived from <xref:System.ComponentModel.ProgressChangedEventArgs>, called `CalculatePrimeProgressChangedEventArgs`, which has one added property called `LatestPrimeNumber`.</span></span>  
  
     <span data-ttu-id="21d4b-211">Par ailleurs, la méthode `BuildPrimeNumberList` appelle périodiquement la méthode `TaskCanceled` et s’arrête si celle-ci retourne `true`.</span><span class="sxs-lookup"><span data-stu-id="21d4b-211">The `BuildPrimeNumberList` method also periodically calls the `TaskCanceled` method and exits if the method returns `true`.</span></span>  
  
     [!code-csharp[System.ComponentModel.AsyncOperationManager#5](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#5)]
     [!code-vb[System.ComponentModel.AsyncOperationManager#5](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#5)]  
  
4. <span data-ttu-id="21d4b-212">Implémentez `IsPrime`.</span><span class="sxs-lookup"><span data-stu-id="21d4b-212">Implement `IsPrime`.</span></span> <span data-ttu-id="21d4b-213">Elle prend trois paramètres : une liste de nombres premiers connus, le nombre à tester et un paramètre de sortie pour le premier diviseur trouvé.</span><span class="sxs-lookup"><span data-stu-id="21d4b-213">It takes three parameters: a list of known prime numbers, the number to test, and an output parameter for the first divisor found.</span></span> <span data-ttu-id="21d4b-214">Étant donné la liste de nombres premiers, elle détermine si le nombre testé est premier.</span><span class="sxs-lookup"><span data-stu-id="21d4b-214">Given the list of prime numbers, it determines if the test number is prime.</span></span>  
  
     [!code-csharp[System.ComponentModel.AsyncOperationManager#28](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#28)]
     [!code-vb[System.ComponentModel.AsyncOperationManager#28](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#28)]  
  
5. <span data-ttu-id="21d4b-215">Dérivez `CalculatePrimeProgressChangedEventArgs` de <xref:System.ComponentModel.ProgressChangedEventArgs>.</span><span class="sxs-lookup"><span data-stu-id="21d4b-215">Derive `CalculatePrimeProgressChangedEventArgs` from <xref:System.ComponentModel.ProgressChangedEventArgs>.</span></span> <span data-ttu-id="21d4b-216">Cette classe est nécessaire pour signaler des résultats incrémentiels au gestionnaire d’événements du client pour l’événement `ProgressChanged`.</span><span class="sxs-lookup"><span data-stu-id="21d4b-216">This class is necessary for reporting incremental results to the client's event handler for the `ProgressChanged` event.</span></span> <span data-ttu-id="21d4b-217">Elle possède une propriété supplémentaire nommée `LatestPrimeNumber`.</span><span class="sxs-lookup"><span data-stu-id="21d4b-217">It has one added property called `LatestPrimeNumber`.</span></span>  
  
     [!code-csharp[System.ComponentModel.AsyncOperationManager#29](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#29)]
     [!code-vb[System.ComponentModel.AsyncOperationManager#29](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#29)]  
  
## <a name="checkpoint"></a><span data-ttu-id="21d4b-218">Point de contrôle</span><span class="sxs-lookup"><span data-stu-id="21d4b-218">Checkpoint</span></span>  
 <span data-ttu-id="21d4b-219">Vous pouvez maintenant générer le composant.</span><span class="sxs-lookup"><span data-stu-id="21d4b-219">At this point, you can build the component.</span></span>  
  
### <a name="to-test-your-component"></a><span data-ttu-id="21d4b-220">Pour tester le composant :</span><span class="sxs-lookup"><span data-stu-id="21d4b-220">To test your component</span></span>  
  
- <span data-ttu-id="21d4b-221">Compilez le composant.</span><span class="sxs-lookup"><span data-stu-id="21d4b-221">Compile the component.</span></span>  
  
     <span data-ttu-id="21d4b-222">Il ne reste plus qu’à écrire les méthodes permettant de démarrer et d’annuler des opérations asynchrones, `CalculatePrimeAsync` et `CancelAsync`.</span><span class="sxs-lookup"><span data-stu-id="21d4b-222">All that remains to be written are the methods to start and cancel asynchronous operations, `CalculatePrimeAsync` and `CancelAsync`.</span></span>  
  
## <a name="implementing-the-start-and-cancel-methods"></a><span data-ttu-id="21d4b-223">Implémenter les méthodes de démarrage et d’annulation</span><span class="sxs-lookup"><span data-stu-id="21d4b-223">Implementing the Start and Cancel Methods</span></span>  
 <span data-ttu-id="21d4b-224">Pour démarrer la méthode de travail sur son propre thread, appelez `BeginInvoke` sur le délégué qui l’inclut.</span><span class="sxs-lookup"><span data-stu-id="21d4b-224">You start the worker method on its own thread by calling `BeginInvoke` on the delegate that wraps it.</span></span> <span data-ttu-id="21d4b-225">Pour gérer la durée de vie d’une opération asynchrone en particulier, vous appellerez la méthode <xref:System.ComponentModel.AsyncOperationManager.CreateOperation%2A> sur la classe d’assistance <xref:System.ComponentModel.AsyncOperationManager>.</span><span class="sxs-lookup"><span data-stu-id="21d4b-225">To manage the lifetime of a particular asynchronous operation, you call the <xref:System.ComponentModel.AsyncOperationManager.CreateOperation%2A> method on the <xref:System.ComponentModel.AsyncOperationManager> helper class.</span></span> <span data-ttu-id="21d4b-226">Cela retourne un <xref:System.ComponentModel.AsyncOperation>, qui marshale les appels sur les gestionnaires d'événements du client au thread ou au contexte adéquat.</span><span class="sxs-lookup"><span data-stu-id="21d4b-226">This returns an <xref:System.ComponentModel.AsyncOperation>, which marshals calls on the client's event handlers to the proper thread or context.</span></span>  
  
 <span data-ttu-id="21d4b-227">Pour annuler une opération en attente donnée, appelez <xref:System.ComponentModel.AsyncOperation.PostOperationCompleted%2A> sur la <xref:System.ComponentModel.AsyncOperation> correspondante.</span><span class="sxs-lookup"><span data-stu-id="21d4b-227">You cancel a particular pending operation by calling <xref:System.ComponentModel.AsyncOperation.PostOperationCompleted%2A> on its corresponding <xref:System.ComponentModel.AsyncOperation>.</span></span> <span data-ttu-id="21d4b-228">Cela met fin à cette opération, et tous les appels ultérieurs à son <xref:System.ComponentModel.AsyncOperation> lèveront une exception.</span><span class="sxs-lookup"><span data-stu-id="21d4b-228">This ends that operation, and any subsequent calls to its <xref:System.ComponentModel.AsyncOperation> will throw an exception.</span></span>  
  
### <a name="to-implement-start-and-cancel-functionality"></a><span data-ttu-id="21d4b-229">Pour implémenter les fonctionnalités de démarrage et d’annulation :</span><span class="sxs-lookup"><span data-stu-id="21d4b-229">To implement Start and Cancel functionality:</span></span>  
  
1. <span data-ttu-id="21d4b-230">Implémentez la méthode `CalculatePrimeAsync`.</span><span class="sxs-lookup"><span data-stu-id="21d4b-230">Implement the `CalculatePrimeAsync` method.</span></span> <span data-ttu-id="21d4b-231">Vérifiez que le jeton fourni par le client (ID de tâche) est unique parmi tous les jetons représentant des tâches actuellement en attente.</span><span class="sxs-lookup"><span data-stu-id="21d4b-231">Make sure the client-supplied token (task ID) is unique with respect to all the tokens representing currently pending tasks.</span></span> <span data-ttu-id="21d4b-232">Si le client transmet un jeton non unique, `CalculatePrimeAsync` lève une exception.</span><span class="sxs-lookup"><span data-stu-id="21d4b-232">If the client passes in a non-unique token, `CalculatePrimeAsync` raises an exception.</span></span> <span data-ttu-id="21d4b-233">Sinon, le jeton est ajouté à la collection d’ID de tâche.</span><span class="sxs-lookup"><span data-stu-id="21d4b-233">Otherwise, the token is added to the task ID collection.</span></span>  
  
     [!code-csharp[System.ComponentModel.AsyncOperationManager#3](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#3)]
     [!code-vb[System.ComponentModel.AsyncOperationManager#3](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#3)]  
  
2. <span data-ttu-id="21d4b-234">Implémentez la méthode `CancelAsync`.</span><span class="sxs-lookup"><span data-stu-id="21d4b-234">Implement the `CancelAsync` method.</span></span> <span data-ttu-id="21d4b-235">Si le paramètre `taskId` existe dans la collection de jetons, il est supprimé.</span><span class="sxs-lookup"><span data-stu-id="21d4b-235">If the `taskId` parameter exists in the token collection, it is removed.</span></span> <span data-ttu-id="21d4b-236">Cela empêche l’exécution des tâches annulées qui n’ont pas démarré.</span><span class="sxs-lookup"><span data-stu-id="21d4b-236">This prevents canceled tasks that have not started from running.</span></span> <span data-ttu-id="21d4b-237">Si la tâche est en cours d’exécution, la méthode `BuildPrimeNumberList` se termine lorsqu’elle détecte que l’ID de tâche a été supprimé de la collection de durées de vie.</span><span class="sxs-lookup"><span data-stu-id="21d4b-237">If the task is running, the `BuildPrimeNumberList` method exits when it detects that the task ID has been removed from the lifetime collection.</span></span>  
  
     [!code-csharp[System.ComponentModel.AsyncOperationManager#4](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#4)]
     [!code-vb[System.ComponentModel.AsyncOperationManager#4](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#4)]  
  
## <a name="checkpoint"></a><span data-ttu-id="21d4b-238">Point de contrôle</span><span class="sxs-lookup"><span data-stu-id="21d4b-238">Checkpoint</span></span>  
 <span data-ttu-id="21d4b-239">Vous pouvez maintenant générer le composant.</span><span class="sxs-lookup"><span data-stu-id="21d4b-239">At this point, you can build the component.</span></span>  
  
### <a name="to-test-your-component"></a><span data-ttu-id="21d4b-240">Pour tester le composant :</span><span class="sxs-lookup"><span data-stu-id="21d4b-240">To test your component</span></span>  
  
- <span data-ttu-id="21d4b-241">Compilez le composant.</span><span class="sxs-lookup"><span data-stu-id="21d4b-241">Compile the component.</span></span>  
  
 <span data-ttu-id="21d4b-242">Le composant `PrimeNumberCalculator` est maintenant terminé et prêt à être utilisé.</span><span class="sxs-lookup"><span data-stu-id="21d4b-242">The `PrimeNumberCalculator` component is now complete and ready to use.</span></span>  
  
 <span data-ttu-id="21d4b-243">Vous trouverez un exemple de client qui utilise le composant `PrimeNumberCalculator` sur la page [Guide pratique : implémenter un client du modèle asynchrone basé sur les événements](../../../docs/standard/asynchronous-programming-patterns/how-to-implement-a-client-of-the-event-based-asynchronous-pattern.md).</span><span class="sxs-lookup"><span data-stu-id="21d4b-243">For an example client that uses the `PrimeNumberCalculator` component, see [How to: Implement a Client of the Event-based Asynchronous Pattern](../../../docs/standard/asynchronous-programming-patterns/how-to-implement-a-client-of-the-event-based-asynchronous-pattern.md).</span></span>  
  
## <a name="next-steps"></a><span data-ttu-id="21d4b-244">Étapes suivantes</span><span class="sxs-lookup"><span data-stu-id="21d4b-244">Next Steps</span></span>  
 <span data-ttu-id="21d4b-245">Vous pouvez remplir cet exemple en écrivant `CalculatePrime`, l’équivalent synchrone de la méthode `CalculatePrimeAsync`.</span><span class="sxs-lookup"><span data-stu-id="21d4b-245">You can fill out this example by writing `CalculatePrime`, the synchronous equivalent of `CalculatePrimeAsync` method.</span></span> <span data-ttu-id="21d4b-246">Cela rendra le composant `PrimeNumberCalculator` entièrement compatible avec le modèle asynchrone basé sur les événements.</span><span class="sxs-lookup"><span data-stu-id="21d4b-246">This will make the `PrimeNumberCalculator` component fully compliant with the Event-based Asynchronous Pattern.</span></span>  
  
 <span data-ttu-id="21d4b-247">Vous pouvez améliorer cet exemple en conservant la liste de tous les nombres premiers découverts par différents appels pour différents nombres testés.</span><span class="sxs-lookup"><span data-stu-id="21d4b-247">You can improve this example by retaining the list of all the prime numbers discovered by various invocations for different test numbers.</span></span> <span data-ttu-id="21d4b-248">Grâce à cette approche, chaque tâche bénéficiera du travail effectué par les tâches précédentes.</span><span class="sxs-lookup"><span data-stu-id="21d4b-248">Using this approach, each task will benefit from the work done by previous tasks.</span></span> <span data-ttu-id="21d4b-249">Veillez à protéger cette liste par des régions `lock`, afin de sérialiser l’accès à la liste par différents threads.</span><span class="sxs-lookup"><span data-stu-id="21d4b-249">Be careful to protect this list with `lock` regions, so access to the list by different threads is serialized.</span></span>  
  
 <span data-ttu-id="21d4b-250">Vous pouvez également améliorer cet exemple en testant des diviseurs triviaux comme 2, 3 et 5.</span><span class="sxs-lookup"><span data-stu-id="21d4b-250">You can also improve this example by testing for trivial divisors, like 2, 3, and 5.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="21d4b-251">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="21d4b-251">See also</span></span>

- [<span data-ttu-id="21d4b-252">Guide pratique pour exécuter une opération en arrière-plan</span><span class="sxs-lookup"><span data-stu-id="21d4b-252">How to: Run an Operation in the Background</span></span>](../../../docs/framework/winforms/controls/how-to-run-an-operation-in-the-background.md)
- [<span data-ttu-id="21d4b-253">Vue d’ensemble du modèle asynchrone basé sur des événements</span><span class="sxs-lookup"><span data-stu-id="21d4b-253">Event-based Asynchronous Pattern Overview</span></span>](../../../docs/standard/asynchronous-programming-patterns/event-based-asynchronous-pattern-overview.md)
- [<span data-ttu-id="21d4b-254">Modèle asynchrone basé sur les événements (EAP)</span><span class="sxs-lookup"><span data-stu-id="21d4b-254">Event-based Asynchronous Pattern (EAP)</span></span>](../../../docs/standard/asynchronous-programming-patterns/event-based-asynchronous-pattern-eap.md)
