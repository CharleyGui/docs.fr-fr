---
title: 'Ca2007 : ne pas attendre directement une tâche (analyse du code)'
description: 'En savoir plus sur la règle d’analyse du code ca2007 : ne pas attendre directement une tâche'
ms.date: 03/08/2019
ms.topic: reference
f1_keywords:
- CA2007
- DoNotDirectlyAwaitATaskAnalyzer
helpviewer_keywords:
- CA2007
author: gewarren
ms.author: gewarren
dev_langs:
- CSharp
ms.openlocfilehash: b2cd6b5f1740a27f513df6abcc710b0efa1d8b21
ms.sourcegitcommit: 4df8e005c074ceb1f978f007b222fe253be2baf3
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 02/04/2021
ms.locfileid: "99545813"
---
# <a name="ca2007-do-not-directly-await-a-task"></a><span data-ttu-id="f3fc4-103">CA2007 : N’attendez pas directement une Tâche</span><span class="sxs-lookup"><span data-stu-id="f3fc4-103">CA2007: Do not directly await a Task</span></span>

| | <span data-ttu-id="f3fc4-104">Valeur</span><span class="sxs-lookup"><span data-stu-id="f3fc4-104">Value</span></span> |
|-|-|
| <span data-ttu-id="f3fc4-105">**Identificateur de la règle**</span><span class="sxs-lookup"><span data-stu-id="f3fc4-105">**Rule ID**</span></span> |<span data-ttu-id="f3fc4-106">CA2007</span><span class="sxs-lookup"><span data-stu-id="f3fc4-106">CA2007</span></span>|
| <span data-ttu-id="f3fc4-107">**Catégorie**</span><span class="sxs-lookup"><span data-stu-id="f3fc4-107">**Category**</span></span> |[<span data-ttu-id="f3fc4-108">Microsoft. fiabilité</span><span class="sxs-lookup"><span data-stu-id="f3fc4-108">Microsoft.Reliability</span></span>](reliability-warnings.md)|
| <span data-ttu-id="f3fc4-109">**Correction en rupture ou sans rupture**</span><span class="sxs-lookup"><span data-stu-id="f3fc4-109">**Fix is breaking or non-breaking**</span></span> |<span data-ttu-id="f3fc4-110">Sans rupture</span><span class="sxs-lookup"><span data-stu-id="f3fc4-110">Non-breaking</span></span>|

## <a name="cause"></a><span data-ttu-id="f3fc4-111">Cause</span><span class="sxs-lookup"><span data-stu-id="f3fc4-111">Cause</span></span>

<span data-ttu-id="f3fc4-112">Une méthode asynchrone [attend](../../../csharp/language-reference/operators/await.md) directement un <xref:System.Threading.Tasks.Task> .</span><span class="sxs-lookup"><span data-stu-id="f3fc4-112">An asynchronous method [awaits](../../../csharp/language-reference/operators/await.md) a <xref:System.Threading.Tasks.Task> directly.</span></span>

## <a name="rule-description"></a><span data-ttu-id="f3fc4-113">Description de la règle</span><span class="sxs-lookup"><span data-stu-id="f3fc4-113">Rule description</span></span>

<span data-ttu-id="f3fc4-114">Lorsqu’une méthode asynchrone attend directement une <xref:System.Threading.Tasks.Task> , la continuation se produit généralement dans le thread qui a créé la tâche, en fonction du contexte Async.</span><span class="sxs-lookup"><span data-stu-id="f3fc4-114">When an asynchronous method awaits a <xref:System.Threading.Tasks.Task> directly, continuation usually occurs in the same thread that created the task, depending on the async context.</span></span> <span data-ttu-id="f3fc4-115">Ce comportement peut être coûteux en termes de performances et peut entraîner un blocage sur le thread d’interface utilisateur.</span><span class="sxs-lookup"><span data-stu-id="f3fc4-115">This behavior can be costly in terms of performance and can result in a deadlock on the UI thread.</span></span> <span data-ttu-id="f3fc4-116">Envisagez <xref:System.Threading.Tasks.Task.ConfigureAwait(System.Boolean)?displayProperty=nameWithType> d’appeler pour signaler votre intention de continuation.</span><span class="sxs-lookup"><span data-stu-id="f3fc4-116">Consider calling <xref:System.Threading.Tasks.Task.ConfigureAwait(System.Boolean)?displayProperty=nameWithType> to signal your intention for continuation.</span></span>

## <a name="how-to-fix-violations"></a><span data-ttu-id="f3fc4-117">Comment corriger les violations</span><span class="sxs-lookup"><span data-stu-id="f3fc4-117">How to fix violations</span></span>

<span data-ttu-id="f3fc4-118">Pour corriger les violations, appelez <xref:System.Threading.Tasks.Task.ConfigureAwait%2A> sur le attendu <xref:System.Threading.Tasks.Task> .</span><span class="sxs-lookup"><span data-stu-id="f3fc4-118">To fix violations, call <xref:System.Threading.Tasks.Task.ConfigureAwait%2A> on the awaited <xref:System.Threading.Tasks.Task>.</span></span> <span data-ttu-id="f3fc4-119">Vous pouvez passer soit `true` ou `false` pour le `continueOnCapturedContext` paramètre.</span><span class="sxs-lookup"><span data-stu-id="f3fc4-119">You can pass either `true` or `false` for the `continueOnCapturedContext` parameter.</span></span>

- <span data-ttu-id="f3fc4-120">`ConfigureAwait(true)`L’appel de sur la tâche a le même comportement que l’appel de manière explicite <xref:System.Threading.Tasks.Task.ConfigureAwait%2A> .</span><span class="sxs-lookup"><span data-stu-id="f3fc4-120">Calling `ConfigureAwait(true)` on the task has the same behavior as not explicitly calling <xref:System.Threading.Tasks.Task.ConfigureAwait%2A>.</span></span> <span data-ttu-id="f3fc4-121">En appelant explicitement cette méthode, vous permettez aux lecteurs de savoir que vous souhaitez intentionnellement effectuer la continuation sur le contexte de synchronisation d’origine.</span><span class="sxs-lookup"><span data-stu-id="f3fc4-121">By explicitly calling this method, you're letting readers know you intentionally want to perform the continuation on the original synchronization context.</span></span>

- <span data-ttu-id="f3fc4-122">Appelez `ConfigureAwait(false)` sur la tâche pour planifier les continuations vers le pool de threads, évitant ainsi un blocage sur le thread d’interface utilisateur.</span><span class="sxs-lookup"><span data-stu-id="f3fc4-122">Call `ConfigureAwait(false)` on the task to schedule continuations to the thread pool, thereby avoiding a deadlock on the UI thread.</span></span> <span data-ttu-id="f3fc4-123">`false`Le passage à est une bonne option pour les bibliothèques indépendantes des applications.</span><span class="sxs-lookup"><span data-stu-id="f3fc4-123">Passing `false` is a good option for app-independent libraries.</span></span>

## <a name="example"></a><span data-ttu-id="f3fc4-124">Exemple</span><span class="sxs-lookup"><span data-stu-id="f3fc4-124">Example</span></span>

<span data-ttu-id="f3fc4-125">L’extrait de code suivant génère l’avertissement :</span><span class="sxs-lookup"><span data-stu-id="f3fc4-125">The following code snippet generates the warning:</span></span>

```csharp
public async Task Execute()
{
    Task task = null;
    await task;
}
```

<span data-ttu-id="f3fc4-126">Pour corriger la violation, appelez <xref:System.Threading.Tasks.Task.ConfigureAwait%2A> sur le attendu <xref:System.Threading.Tasks.Task> :</span><span class="sxs-lookup"><span data-stu-id="f3fc4-126">To fix the violation, call <xref:System.Threading.Tasks.Task.ConfigureAwait%2A> on the awaited <xref:System.Threading.Tasks.Task>:</span></span>

```csharp
public async Task Execute()
{
    Task task = null;
    await task.ConfigureAwait(false);
}
```

## <a name="when-to-suppress-warnings"></a><span data-ttu-id="f3fc4-127">Quand supprimer les avertissements</span><span class="sxs-lookup"><span data-stu-id="f3fc4-127">When to suppress warnings</span></span>

<span data-ttu-id="f3fc4-128">Cet avertissement est destiné aux bibliothèques, où le code peut être exécuté dans des environnements arbitraires et où le code ne doit pas faire d’hypothèses sur l’environnement ou comment l’appelant de la méthode peut l’appeler ou l’attendre.</span><span class="sxs-lookup"><span data-stu-id="f3fc4-128">This warning is intended for libraries, where the code may be executed in arbitrary environments and where code shouldn't make assumptions about the environment or how the caller of the method may be invoking or waiting on it.</span></span> <span data-ttu-id="f3fc4-129">Il est généralement préférable de supprimer entièrement l’avertissement pour les projets qui représentent le code de l’application plutôt que le code de bibliothèque. en fait, l’exécution de cet analyseur sur le code de l’application (par exemple, les gestionnaires d’événements de clic de bouton dans un projet WinForms ou WPF) risque d’entraîner des actions incorrectes.</span><span class="sxs-lookup"><span data-stu-id="f3fc4-129">It is generally appropriate to suppress the warning entirely for projects that represent application code rather than library code; in fact, running this analyzer on application code (for example, button click event handlers in a WinForms or WPF project) is likely to lead to the wrong actions being taken.</span></span>

<span data-ttu-id="f3fc4-130">Vous pouvez supprimer cet avertissement dans toutes les situations où la continuation doit être replanifiée dans le contexte d’origine ou lorsqu’il n’existe aucun contexte de ce type.</span><span class="sxs-lookup"><span data-stu-id="f3fc4-130">You can suppress this warning in any situation where either the continuation should be scheduled back to the original context or where there is no such context in place.</span></span> <span data-ttu-id="f3fc4-131">Par exemple, lors de l’écriture de code dans un gestionnaire d’événements de clic sur un bouton dans une application WinForms ou WPF, en général, la continuation d’une instruction await doit s’exécuter sur le thread d’interface utilisateur. par conséquent, le comportement par défaut de la planification de la continuation vers le contexte d’origine est souhaitable.</span><span class="sxs-lookup"><span data-stu-id="f3fc4-131">For example, when writing code in a button click event handler in a WinForms or WPF application, in general the continuation from an await should run on the UI thread, and thus the default behavior of scheduling the continuation back to the originating context is desirable.</span></span> <span data-ttu-id="f3fc4-132">Autre exemple, lors de l’écriture de code dans une application ASP.NET Core, par défaut, il n’y a pas <xref:System.Threading.SynchronizationContext> <xref:System.Threading.Tasks.TaskScheduler> de ou, pour la raison pour laquelle un `ConfigureAwait` ne changerait pas de comportement.</span><span class="sxs-lookup"><span data-stu-id="f3fc4-132">As another example, when writing code in an ASP.NET Core application, by default there is no <xref:System.Threading.SynchronizationContext> or <xref:System.Threading.Tasks.TaskScheduler>, for which reason a `ConfigureAwait` wouldn't actually change any behavior.</span></span>

[!INCLUDE [suppress-warning](../../../../includes/code-analysis/suppress-warning.md)]

## <a name="configure-code-to-analyze"></a><span data-ttu-id="f3fc4-133">Configurer le code pour analyser</span><span class="sxs-lookup"><span data-stu-id="f3fc4-133">Configure code to analyze</span></span>

<span data-ttu-id="f3fc4-134">Utilisez les options suivantes pour configurer les parties de votre code base pour l’exécution de cette règle.</span><span class="sxs-lookup"><span data-stu-id="f3fc4-134">Use the following options to configure which parts of your codebase to run this rule on.</span></span>

- [<span data-ttu-id="f3fc4-135">Exclure les méthodes void Async</span><span class="sxs-lookup"><span data-stu-id="f3fc4-135">Exclude async void methods</span></span>](#exclude-async-void-methods)
- [<span data-ttu-id="f3fc4-136">Type de sortie</span><span class="sxs-lookup"><span data-stu-id="f3fc4-136">Output kind</span></span>](#output-kind)

<span data-ttu-id="f3fc4-137">Vous pouvez configurer toutes ces options uniquement pour cette règle, pour toutes les règles ou pour toutes les règles de cette catégorie ([fiabilité](reliability-warnings.md)).</span><span class="sxs-lookup"><span data-stu-id="f3fc4-137">You can configure all of these options for just this rule, for all rules, or for all rules in this category ([Reliability](reliability-warnings.md)).</span></span> <span data-ttu-id="f3fc4-138">Pour plus d’informations, consultez Options de configuration d’une [règle de qualité du code](../code-quality-rule-options.md).</span><span class="sxs-lookup"><span data-stu-id="f3fc4-138">For more information, see [Code quality rule configuration options](../code-quality-rule-options.md).</span></span>

### <a name="exclude-async-void-methods"></a><span data-ttu-id="f3fc4-139">Exclure les méthodes void Async</span><span class="sxs-lookup"><span data-stu-id="f3fc4-139">Exclude async void methods</span></span>

<span data-ttu-id="f3fc4-140">Vous pouvez configurer si vous souhaitez exclure des méthodes asynchrones qui ne retournent pas de valeur à partir de cette règle.</span><span class="sxs-lookup"><span data-stu-id="f3fc4-140">You can configure whether you want to exclude asynchronous methods that don't return a value from this rule.</span></span> <span data-ttu-id="f3fc4-141">Pour exclure ces genres de méthodes, ajoutez la paire clé-valeur suivante à un fichier *. editorconfig* dans votre projet :</span><span class="sxs-lookup"><span data-stu-id="f3fc4-141">To exclude these kinds of methods, add the following key-value pair to an *.editorconfig* file in your project:</span></span>

```ini
# Package version 2.9.0 and later
dotnet_code_quality.CA2007.exclude_async_void_methods = true

# Package version 2.6.3 and earlier
dotnet_code_quality.CA2007.skip_async_void_methods = true
```

### <a name="output-kind"></a><span data-ttu-id="f3fc4-142">Type de sortie</span><span class="sxs-lookup"><span data-stu-id="f3fc4-142">Output kind</span></span>

<span data-ttu-id="f3fc4-143">Vous pouvez également configurer les types d’assembly de sortie auxquels appliquer cette règle.</span><span class="sxs-lookup"><span data-stu-id="f3fc4-143">You can also configure which output assembly kinds to apply this rule to.</span></span> <span data-ttu-id="f3fc4-144">Par exemple, pour appliquer cette règle uniquement au code qui produit une application console ou une bibliothèque liée de manière dynamique (autrement dit, pas une application d’interface utilisateur), ajoutez la paire clé-valeur suivante à un fichier *. editorconfig* dans votre projet :</span><span class="sxs-lookup"><span data-stu-id="f3fc4-144">For example, to only apply this rule to code that produces a console application or a dynamically linked library (that is, not a UI app), add the following key-value pair to an *.editorconfig* file in your project:</span></span>

```ini
dotnet_code_quality.CA2007.output_kind = ConsoleApplication, DynamicallyLinkedLibrary
```

## <a name="see-also"></a><span data-ttu-id="f3fc4-145">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="f3fc4-145">See also</span></span>

- [<span data-ttu-id="f3fc4-146">FAQ ConfigureAwait</span><span class="sxs-lookup"><span data-stu-id="f3fc4-146">ConfigureAwait FAQ</span></span>](https://devblogs.microsoft.com/dotnet/configureawait-faq/)
- [<span data-ttu-id="f3fc4-147">Dois-je attendre une tâche avec ConfigureAwait (false) ?</span><span class="sxs-lookup"><span data-stu-id="f3fc4-147">Should I await a task with ConfigureAwait(false)?</span></span>](https://github.com/Microsoft/vs-threading/blob/master/doc/cookbook_vs.md#should-i-await-a-task-with-configureawaitfalse)
- [<span data-ttu-id="f3fc4-148">CA2008 : Ne pas créer de tâches sans passer TaskScheduler</span><span class="sxs-lookup"><span data-stu-id="f3fc4-148">CA2008: Do not create tasks without passing a TaskScheduler</span></span>](ca2008.md)
- [<span data-ttu-id="f3fc4-149">Règles de fiabilité</span><span class="sxs-lookup"><span data-stu-id="f3fc4-149">Reliability rules</span></span>](reliability-warnings.md)
